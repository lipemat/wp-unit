diff --git a/data/blocks/fixtures/core__column.server.html b/data/blocks/fixtures/core__column.server.html
index a3624daaf0..d0b6ab4016 100644
--- a/data/blocks/fixtures/core__column.server.html
+++ b/data/blocks/fixtures/core__column.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-column is-layout-flow">
+<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
 	
 	<p>Column One, Paragraph One</p>
 	
diff --git a/data/blocks/fixtures/core__columns.server.html b/data/blocks/fixtures/core__columns.server.html
index 1c144512d1..e35ab2763e 100644
--- a/data/blocks/fixtures/core__columns.server.html
+++ b/data/blocks/fixtures/core__columns.server.html
@@ -1,7 +1,7 @@
 
-<div class="wp-block-columns has-3-columns is-layout-flex wp-container-1">
+<div class="wp-block-columns has-3-columns is-layout-flex wp-container-1 wp-block-columns-is-layout-flex">
 	
-	<div class="wp-block-column is-layout-flow">
+	<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
 		
 		<p>Column One, Paragraph One</p>
 		
@@ -11,7 +11,7 @@
 	</div>
 	
 	
-	<div class="wp-block-column is-layout-flow">
+	<div class="wp-block-column is-layout-flow wp-block-column-is-layout-flow">
 		
 		<p>Column Two, Paragraph One</p>
 		
diff --git a/data/blocks/fixtures/core__columns__deprecated.server.html b/data/blocks/fixtures/core__columns__deprecated.server.html
index 9d213ddcdf..c61aabf682 100644
--- a/data/blocks/fixtures/core__columns__deprecated.server.html
+++ b/data/blocks/fixtures/core__columns__deprecated.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-columns has-3-columns is-layout-flex wp-container-1">
+<div class="wp-block-columns has-3-columns is-layout-flex wp-container-1 wp-block-columns-is-layout-flex">
 	
 	<p class="layout-column-1">Column One, Paragraph One</p>
 	
diff --git a/data/blocks/fixtures/core__cover.html b/data/blocks/fixtures/core__cover.html
index ae26d922c2..34e8b7ad5e 100644
--- a/data/blocks/fixtures/core__cover.html
+++ b/data/blocks/fixtures/core__cover.html
@@ -1,5 +1,5 @@
 <!-- wp:core/cover {"url":"https://cldup.com/uuUqE_dXzy.jpg","dimRatio":40} -->
-<div class="wp-block-cover has-background-dim-40 has-background-dim" style="background-image:url(https://cldup.com/uuUqE_dXzy.jpg)">
+<div class="wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow" style="background-image:url(https://cldup.com/uuUqE_dXzy.jpg)">
     <p class="wp-block-cover-text">Guten Berg!</p>
 </div>
 <!-- /wp:core/cover -->
diff --git a/data/blocks/fixtures/core__cover.json b/data/blocks/fixtures/core__cover.json
index dea09d92c1..6b3ec9c1c9 100644
--- a/data/blocks/fixtures/core__cover.json
+++ b/data/blocks/fixtures/core__cover.json
@@ -12,6 +12,6 @@
             "backgroundType": "image"
         },
         "innerBlocks": [],
-        "originalContent": "<div class=\"wp-block-cover has-background-dim-40 has-background-dim\" style=\"background-image:url(https://cldup.com/uuUqE_dXzy.jpg)\">\n    <p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>"
+        "originalContent": "<div class=\"wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\" style=\"background-image:url(https://cldup.com/uuUqE_dXzy.jpg)\">\n    <p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>"
     }
 ]
diff --git a/data/blocks/fixtures/core__cover.parsed.json b/data/blocks/fixtures/core__cover.parsed.json
index 14f37b6170..e4c901f253 100644
--- a/data/blocks/fixtures/core__cover.parsed.json
+++ b/data/blocks/fixtures/core__cover.parsed.json
@@ -6,9 +6,9 @@
             "dimRatio": 40
         },
         "innerBlocks": [],
-        "innerHTML": "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim\" style=\"background-image:url(https://cldup.com/uuUqE_dXzy.jpg)\">\n    <p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n",
+        "innerHTML": "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\" style=\"background-image:url(https://cldup.com/uuUqE_dXzy.jpg)\">\n    <p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n",
         "innerContent": [
-            "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim\" style=\"background-image:url(https://cldup.com/uuUqE_dXzy.jpg)\">\n    <p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n"
+            "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\" style=\"background-image:url(https://cldup.com/uuUqE_dXzy.jpg)\">\n    <p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n"
         ]
     },
     {
diff --git a/data/blocks/fixtures/core__cover.server.html b/data/blocks/fixtures/core__cover.server.html
index 726c24a585..ba293cb7a9 100644
--- a/data/blocks/fixtures/core__cover.server.html
+++ b/data/blocks/fixtures/core__cover.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-cover has-background-dim-40 has-background-dim" style="background-image:url(https://cldup.com/uuUqE_dXzy.jpg)">
+<div class="wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow" style="background-image:url(https://cldup.com/uuUqE_dXzy.jpg)">
     <p class="wp-block-cover-text">Guten Berg!</p>
 </div>
 
diff --git a/data/blocks/fixtures/core__cover__video-overlay.html b/data/blocks/fixtures/core__cover__video-overlay.html
index 2a3530954f..5d3456e7c9 100644
--- a/data/blocks/fixtures/core__cover__video-overlay.html
+++ b/data/blocks/fixtures/core__cover__video-overlay.html
@@ -1,5 +1,5 @@
 <!-- wp:cover {"url":"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=","dimRatio":10,"customOverlayColor":"#3615d9","backgroundType":"video"} -->
-<div class="wp-block-cover has-background-dim-10 has-background-dim" style="background-color:#3615d9">
+<div class="wp-block-cover has-background-dim-10 has-background-dim is-layout-flow wp-block-cover-is-layout-flow" style="background-color:#3615d9">
 	<video class="wp-block-cover__video-background" autoplay muted loop src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE="></video>
 	<p class="wp-block-cover-text">Guten Berg!</p>
 </div>
diff --git a/data/blocks/fixtures/core__cover__video-overlay.json b/data/blocks/fixtures/core__cover__video-overlay.json
index 08f0de4eb4..ac81685188 100644
--- a/data/blocks/fixtures/core__cover__video-overlay.json
+++ b/data/blocks/fixtures/core__cover__video-overlay.json
@@ -13,6 +13,6 @@
             "backgroundType": "video"
         },
         "innerBlocks": [],
-        "originalContent": "<div class=\"wp-block-cover has-background-dim-10 has-background-dim\" style=\"background-color:#3615d9\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>"
+        "originalContent": "<div class=\"wp-block-cover has-background-dim-10 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\" style=\"background-color:#3615d9\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>"
     }
 ]
diff --git a/data/blocks/fixtures/core__cover__video-overlay.parsed.json b/data/blocks/fixtures/core__cover__video-overlay.parsed.json
index a2a3ccc94a..71700c25a9 100644
--- a/data/blocks/fixtures/core__cover__video-overlay.parsed.json
+++ b/data/blocks/fixtures/core__cover__video-overlay.parsed.json
@@ -8,9 +8,9 @@
             "backgroundType": "video"
         },
         "innerBlocks": [],
-        "innerHTML": "\n<div class=\"wp-block-cover has-background-dim-10 has-background-dim\" style=\"background-color:#3615d9\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n",
+        "innerHTML": "\n<div class=\"wp-block-cover has-background-dim-10 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\" style=\"background-color:#3615d9\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n",
         "innerContent": [
-            "\n<div class=\"wp-block-cover has-background-dim-10 has-background-dim\" style=\"background-color:#3615d9\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n"
+            "\n<div class=\"wp-block-cover has-background-dim-10 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\" style=\"background-color:#3615d9\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n"
         ]
     },
     {
diff --git a/data/blocks/fixtures/core__cover__video-overlay.server.html b/data/blocks/fixtures/core__cover__video-overlay.server.html
index d8e1e40cac..aa2f0267ac 100644
--- a/data/blocks/fixtures/core__cover__video-overlay.server.html
+++ b/data/blocks/fixtures/core__cover__video-overlay.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-cover has-background-dim-10 has-background-dim" style="background-color:#3615d9">
+<div class="wp-block-cover has-background-dim-10 has-background-dim is-layout-flow wp-block-cover-is-layout-flow" style="background-color:#3615d9">
 	<video class="wp-block-cover__video-background" autoplay muted loop src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE="></video>
 	<p class="wp-block-cover-text">Guten Berg!</p>
 </div>
diff --git a/data/blocks/fixtures/core__cover__video.html b/data/blocks/fixtures/core__cover__video.html
index 0ab2fd73cc..5408bbe933 100644
--- a/data/blocks/fixtures/core__cover__video.html
+++ b/data/blocks/fixtures/core__cover__video.html
@@ -1,5 +1,5 @@
 <!-- wp:cover {"url":"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=","dimRatio":40,"backgroundType":"video"} -->
-<div class="wp-block-cover has-background-dim-40 has-background-dim">
+<div class="wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow">
 	<video class="wp-block-cover__video-background" autoplay muted loop src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE="></video>
 	<p class="wp-block-cover-text">Guten Berg!</p>
 </div>
diff --git a/data/blocks/fixtures/core__cover__video.json b/data/blocks/fixtures/core__cover__video.json
index 1fa4d25d66..673cd3b725 100644
--- a/data/blocks/fixtures/core__cover__video.json
+++ b/data/blocks/fixtures/core__cover__video.json
@@ -12,6 +12,6 @@
             "backgroundType": "video"
         },
         "innerBlocks": [],
-        "originalContent": "<div class=\"wp-block-cover has-background-dim-40 has-background-dim\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>"
+        "originalContent": "<div class=\"wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>"
     }
 ]
diff --git a/data/blocks/fixtures/core__cover__video.parsed.json b/data/blocks/fixtures/core__cover__video.parsed.json
index a864b5fea3..ad48e4fde4 100644
--- a/data/blocks/fixtures/core__cover__video.parsed.json
+++ b/data/blocks/fixtures/core__cover__video.parsed.json
@@ -7,9 +7,9 @@
             "backgroundType": "video"
         },
         "innerBlocks": [],
-        "innerHTML": "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n",
+        "innerHTML": "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n",
         "innerContent": [
-            "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n"
+            "\n<div class=\"wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow\">\n\t<video class=\"wp-block-cover__video-background\" autoplay muted loop src=\"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE=\"></video>\n\t<p class=\"wp-block-cover-text\">Guten Berg!</p>\n</div>\n"
         ]
     },
     {
diff --git a/data/blocks/fixtures/core__cover__video.server.html b/data/blocks/fixtures/core__cover__video.server.html
index 50a924c054..20afe15696 100644
--- a/data/blocks/fixtures/core__cover__video.server.html
+++ b/data/blocks/fixtures/core__cover__video.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-cover has-background-dim-40 has-background-dim">
+<div class="wp-block-cover has-background-dim-40 has-background-dim is-layout-flow wp-block-cover-is-layout-flow">
 	<video class="wp-block-cover__video-background" autoplay muted loop src="data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAC721kYXQhEAUgpBv/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA3pwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcCEQBSCkG//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADengAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcAAAAsJtb292AAAAbG12aGQAAAAAAAAAAAAAAAAAAAPoAAAALwABAAABAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAB7HRyYWsAAABcdGtoZAAAAAMAAAAAAAAAAAAAAAIAAAAAAAAALwAAAAAAAAAAAAAAAQEAAAAAAQAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAACRlZHRzAAAAHGVsc3QAAAAAAAAAAQAAAC8AAAAAAAEAAAAAAWRtZGlhAAAAIG1kaGQAAAAAAAAAAAAAAAAAAKxEAAAIAFXEAAAAAAAtaGRscgAAAAAAAAAAc291bgAAAAAAAAAAAAAAAFNvdW5kSGFuZGxlcgAAAAEPbWluZgAAABBzbWhkAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAADTc3RibAAAAGdzdHNkAAAAAAAAAAEAAABXbXA0YQAAAAAAAAABAAAAAAAAAAAAAgAQAAAAAKxEAAAAAAAzZXNkcwAAAAADgICAIgACAASAgIAUQBUAAAAAAfQAAAHz+QWAgIACEhAGgICAAQIAAAAYc3R0cwAAAAAAAAABAAAAAgAABAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAIAAAABAAAAHHN0c3oAAAAAAAAAAAAAAAIAAAFzAAABdAAAABRzdGNvAAAAAAAAAAEAAAAsAAAAYnVkdGEAAABabWV0YQAAAAAAAAAhaGRscgAAAAAAAAAAbWRpcmFwcGwAAAAAAAAAAAAAAAAtaWxzdAAAACWpdG9vAAAAHWRhdGEAAAABAAAAAExhdmY1Ni40MC4xMDE="></video>
 	<p class="wp-block-cover-text">Guten Berg!</p>
 </div>
diff --git a/data/blocks/fixtures/core__gallery-with-caption.server.html b/data/blocks/fixtures/core__gallery-with-caption.server.html
index 18e3f1d8c8..49912d63c4 100644
--- a/data/blocks/fixtures/core__gallery-with-caption.server.html
+++ b/data/blocks/fixtures/core__gallery-with-caption.server.html
@@ -1,6 +1,6 @@
 
 <figure
-	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2 wp-block-gallery-1 is-layout-flex"
+	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2 wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex"
 >
 
 	<figure class="wp-block-image size-large">
diff --git a/data/blocks/fixtures/core__gallery.server.html b/data/blocks/fixtures/core__gallery.server.html
index fdea3c8cee..051cc297b4 100644
--- a/data/blocks/fixtures/core__gallery.server.html
+++ b/data/blocks/fixtures/core__gallery.server.html
@@ -1,6 +1,6 @@
 
 <figure
-	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2 wp-block-gallery-1 is-layout-flex"
+	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2 wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex"
 >
 
 	<figure class="wp-block-image size-large">
diff --git a/data/blocks/fixtures/core__gallery__columns.server.html b/data/blocks/fixtures/core__gallery__columns.server.html
index 33bf96793e..024adf2115 100644
--- a/data/blocks/fixtures/core__gallery__columns.server.html
+++ b/data/blocks/fixtures/core__gallery__columns.server.html
@@ -1,5 +1,5 @@
 
-<figure class="wp-block-gallery has-nested-images columns-1 is-cropped wp-block-gallery-1 is-layout-flex">
+<figure class="wp-block-gallery has-nested-images columns-1 is-cropped wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<figure class="wp-block-image size-large">
 		<img data-id="1421"
 			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
diff --git a/data/blocks/fixtures/core__gallery__deprecated-1.server.html b/data/blocks/fixtures/core__gallery__deprecated-1.server.html
index edf07c2a72..b75b284fc1 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-1.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-1.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+<div class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<figure class="blocks-gallery-image">
 		<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" />
 	</figure>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-2.server.html b/data/blocks/fixtures/core__gallery__deprecated-2.server.html
index 4f47253ffb..399594ce59 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-2.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-2.server.html
@@ -1,5 +1,5 @@
 
-<ul class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+<ul class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<li class="blocks-gallery-item">
 		<figure>
 			<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" data-id="1" alt="title" class="wp-image-1" />
diff --git a/data/blocks/fixtures/core__gallery__deprecated-3.server.html b/data/blocks/fixtures/core__gallery__deprecated-3.server.html
index 9c58c81034..e017c1a0c8 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-3.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-3.server.html
@@ -1,5 +1,5 @@
 
-<ul class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+<ul class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<li class="blocks-gallery-item">
 		<figure>
 			<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" />
diff --git a/data/blocks/fixtures/core__gallery__deprecated-4.server.html b/data/blocks/fixtures/core__gallery__deprecated-4.server.html
index 355dc4bdf4..b835e5f1ab 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-4.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-4.server.html
@@ -1,5 +1,5 @@
 
-<figure class="wp-block-gallery columns-3 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+<figure class="wp-block-gallery columns-3 is-cropped alignwide wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<ul class="blocks-gallery-grid">
 		<li class="blocks-gallery-item">
 			<figure>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-5.server.html b/data/blocks/fixtures/core__gallery__deprecated-5.server.html
index 57c42cc3bd..f69cf83abc 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-5.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-5.server.html
@@ -1,5 +1,5 @@
 
-<figure class="wp-block-gallery columns-3 is-cropped wp-block-gallery-1 is-layout-flex">
+<figure class="wp-block-gallery columns-3 is-cropped wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<ul class="blocks-gallery-grid">
 		<li class="blocks-gallery-item">
 			<figure>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-6.server.html b/data/blocks/fixtures/core__gallery__deprecated-6.server.html
index 9175cfa561..7952cd8c48 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-6.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-6.server.html
@@ -1,5 +1,5 @@
 
-<figure class="wp-block-gallery columns-3 is-cropped wp-block-gallery-1 is-layout-flex">
+<figure class="wp-block-gallery columns-3 is-cropped wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
 	<ul class="blocks-gallery-grid">
 		<li class="blocks-gallery-item">
 			<figure>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-7.server.html b/data/blocks/fixtures/core__gallery__deprecated-7.server.html
index d3fa62fdf5..b522543d92 100644
--- a/data/blocks/fixtures/core__gallery__deprecated-7.server.html
+++ b/data/blocks/fixtures/core__gallery__deprecated-7.server.html
@@ -1,15 +1,15 @@
 
-<figure class="wp-block-gallery has-nested-images columns-default is-cropped wp-block-gallery-1 is-layout-flex">
-		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img data-id="705"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
-		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img data-id="704"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
-		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img data-id="703"  src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img data-id="705" src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img data-id="704" src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img data-id="703" src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
 </figure>
 
 
-<figure class="wp-block-gallery has-nested-images columns-default is-cropped wp-block-gallery-1 is-layout-flex">
-	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img data-id="705"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
-	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img data-id="704"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
-	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img data-id="703"  src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped wp-block-gallery-1 is-layout-flex wp-block-gallery-is-layout-flex">
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img data-id="705" src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img data-id="704" src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img data-id="703" src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
 	<figcaption class="blocks-gallery-caption">This gallery has a caption</figcaption>
 </figure>
 
diff --git a/data/blocks/hooked-block-error/block.json b/data/blocks/hooked-block-error/block.json
new file mode 100644
index 0000000000..346c43b5b3
--- /dev/null
+++ b/data/blocks/hooked-block-error/block.json
@@ -0,0 +1,8 @@
+{
+	"name": "tests/hooked-block-error",
+	"description": "A block that throws an error because it tries to hook a block to itself.",
+	"blockHooks": {
+		"tests/hooked-block-error": "before",
+		"tests/other-block": "after"
+	}
+}
diff --git a/data/blocks/notice/block.json b/data/blocks/notice/block.json
index 9d2fadfb5d..909137252a 100644
--- a/data/blocks/notice/block.json
+++ b/data/blocks/notice/block.json
@@ -27,6 +27,15 @@
 			"type": "string"
 		}
 	},
+	"selectors": {
+		"root": ".wp-block-notice"
+	},
+	"blockHooks": {
+		"tests/before": "before",
+		"tests/after": "after",
+		"tests/first-child": "firstChild",
+		"tests/last-child": "lastChild"
+	},
 	"supports": {
 		"align": true,
 		"lightBlockWrapper": true
diff --git a/data/filesystem/archive.zip b/data/filesystem/archive.zip
new file mode 100644
index 0000000000..60a750939d
Binary files /dev/null and b/data/filesystem/archive.zip differ
diff --git a/data/images/test-alpha.pdf b/data/images/test-alpha.pdf
new file mode 100644
index 0000000000..1cbd4686e7
--- /dev/null
+++ b/data/images/test-alpha.pdf
@@ -0,0 +1,2 @@
+Powered by TCPDF (www.tcpdf.org)
+
diff --git a/data/templates/template-with-nested-template-part.html b/data/templates/template-with-nested-template-part.html
new file mode 100644
index 0000000000..7df8341fe5
--- /dev/null
+++ b/data/templates/template-with-nested-template-part.html
@@ -0,0 +1,3 @@
+<!-- wp:group -->
+<!-- wp:template-part {"slug":"header","align":"full", "tagName":"header","className":"site-header"} /-->
+<!-- /wp:group -->
\ No newline at end of file
diff --git a/data/templates/template-with-template-part-with-existing-theme-attribute.html b/data/templates/template-with-template-part-with-existing-theme-attribute.html
new file mode 100644
index 0000000000..8e4678c8d0
--- /dev/null
+++ b/data/templates/template-with-template-part-with-existing-theme-attribute.html
@@ -0,0 +1 @@
+<!-- wp:template-part {"slug":"header","theme":"fake-theme","align":"full","tagName":"header","className":"site-header"} /-->
\ No newline at end of file
diff --git a/data/templates/template-with-template-part.html b/data/templates/template-with-template-part.html
new file mode 100644
index 0000000000..ccec47b648
--- /dev/null
+++ b/data/templates/template-with-template-part.html
@@ -0,0 +1 @@
+<!-- wp:template-part {"slug":"header","align":"full", "tagName":"header","className":"site-header"} /-->
\ No newline at end of file
diff --git a/data/themedir1/block-theme-child-deprecated-path/block-template-parts/small-header.html b/data/themedir1/block-theme-child-deprecated-path/block-template-parts/small-header.html
new file mode 100644
index 0000000000..5c18e98125
--- /dev/null
+++ b/data/themedir1/block-theme-child-deprecated-path/block-template-parts/small-header.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Small Header Template Part</p>
+<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/block-theme-child-deprecated-path/style.css b/data/themedir1/block-theme-child-deprecated-path/style.css
new file mode 100644
index 0000000000..6a571d0235
--- /dev/null
+++ b/data/themedir1/block-theme-child-deprecated-path/style.css
@@ -0,0 +1,8 @@
+/*
+Theme Name: Block Theme Child Deprecated Path
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Template: block-theme
+Version: 1.0.0
+Text Domain: block-theme-child-deprecated-path
+*/
diff --git a/data/themedir1/block-theme-child-deprecated-path/templates/index.html b/data/themedir1/block-theme-child-deprecated-path/templates/index.html
new file mode 100644
index 0000000000..e76bcaaf3a
--- /dev/null
+++ b/data/themedir1/block-theme-child-deprecated-path/templates/index.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Index Template</p>
+<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/block-theme-child-deprecated-path/theme.json b/data/themedir1/block-theme-child-deprecated-path/theme.json
new file mode 100644
index 0000000000..38fcb1d9dd
--- /dev/null
+++ b/data/themedir1/block-theme-child-deprecated-path/theme.json
@@ -0,0 +1,71 @@
+{
+	"version": 1,
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			],
+			"gradients": [
+				{
+					"name": "Custom gradient",
+					"gradient": "linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%)",
+					"slug": "custom-gradient"
+				}
+			],
+			"custom": false,
+			"customGradient": false
+		},
+		"typography": {
+			"fontSizes": [
+				{
+					"name": "Custom",
+					"slug": "custom",
+					"size": "100px"
+				}
+			],
+			"customFontSize": false,
+			"customLineHeight": true
+		},
+		"spacing": {
+			"units": [
+				"rem"
+			],
+			"customPadding": true
+		},
+		"blocks": {
+			"core/paragraph": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f5f7f9"
+						}
+					]
+				}
+			}
+		}
+	},
+	"customTemplates": [
+		{
+			"name": "page-home",
+			"title": "Homepage template"
+		}
+	],
+	"templateParts": [
+		{
+			"name": "small-header",
+			"title": "Small Header",
+			"area": "header"
+		}
+	]
+}
diff --git a/data/themedir1/block-theme-child-with-fluid-layout/style.css b/data/themedir1/block-theme-child-with-fluid-layout/style.css
new file mode 100644
index 0000000000..193b8f098a
--- /dev/null
+++ b/data/themedir1/block-theme-child-with-fluid-layout/style.css
@@ -0,0 +1,8 @@
+/*
+Theme Name: Block Theme Child Theme With Fluid Layout
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Template: block-theme
+Version: 1.0.0
+Text Domain: block-theme-child-with-fluid-layout
+*/
diff --git a/data/themedir1/block-theme-child-with-fluid-layout/theme.json b/data/themedir1/block-theme-child-with-fluid-layout/theme.json
new file mode 100644
index 0000000000..6985da16c6
--- /dev/null
+++ b/data/themedir1/block-theme-child-with-fluid-layout/theme.json
@@ -0,0 +1,12 @@
+{
+	"version": 2,
+	"settings": {
+		"appearanceTools": true,
+		"layout": {
+			"wideSize": "clamp(1000px, 85vw, 2000px)"
+		},
+		"typography": {
+			"fluid": true
+		}
+	}
+}
diff --git a/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json b/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json
index d0ec32d9ca..65ed480f20 100644
--- a/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json
+++ b/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json
@@ -2,9 +2,14 @@
 	"version": 2,
 	"settings": {
 		"appearanceTools": true,
+		"layout": {
+			"wideSize": "1000px"
+		},
 		"typography": {
 			"fluid": {
-				"minFontSize": "16px"
+				"minFontSize": "16px",
+				"maxViewportWidth": "1200px",
+				"minViewportWidth": "640px"
 			}
 		}
 	}
diff --git a/data/themedir1/block-theme-child/blocks/example-block/block.json b/data/themedir1/block-theme-child/blocks/example-block/block.json
new file mode 100644
index 0000000000..419a332b58
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/block.json
@@ -0,0 +1,8 @@
+{
+	"apiVersion": 2,
+	"title": "Example Theme Block",
+	"name": "block-theme/example-block",
+	"description": "Custom block registered from within a theme",
+	"editorScript": "file:./index.js",
+	"style": "file:./style.css"
+}
diff --git a/data/themedir1/block-theme-child/blocks/example-block/editor-style-rtl.css b/data/themedir1/block-theme-child/blocks/example-block/editor-style-rtl.css
new file mode 100644
index 0000000000..2572f27aaf
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/editor-style-rtl.css
@@ -0,0 +1 @@
+/* Test CSS file - RTL version */
diff --git a/data/themedir1/block-theme-child/blocks/example-block/editor-style.css b/data/themedir1/block-theme-child/blocks/example-block/editor-style.css
new file mode 100644
index 0000000000..5bbe1134f7
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/editor-style.css
@@ -0,0 +1 @@
+/* Test CSS file */
diff --git a/data/themedir1/block-theme-child/blocks/example-block/index.asset.php b/data/themedir1/block-theme-child/blocks/example-block/index.asset.php
new file mode 100644
index 0000000000..0314b6de8d
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/index.asset.php
@@ -0,0 +1,6 @@
+<?php
+
+return array(
+	'dependencies' => array( 'wp-element', 'wp-blocks' ),
+	'version'      => 'test',
+);
diff --git a/data/themedir1/block-theme-child/blocks/example-block/index.js b/data/themedir1/block-theme-child/blocks/example-block/index.js
new file mode 100644
index 0000000000..0bdf0f5ad9
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/index.js
@@ -0,0 +1 @@
+/* Test JavaScript file. */
diff --git a/data/themedir1/block-theme-child/blocks/example-block/style-rtl.css b/data/themedir1/block-theme-child/blocks/example-block/style-rtl.css
new file mode 100644
index 0000000000..2572f27aaf
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/style-rtl.css
@@ -0,0 +1 @@
+/* Test CSS file - RTL version */
diff --git a/data/themedir1/block-theme-child/blocks/example-block/style.css b/data/themedir1/block-theme-child/blocks/example-block/style.css
new file mode 100644
index 0000000000..5bbe1134f7
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/style.css
@@ -0,0 +1 @@
+/* Test CSS file */
diff --git a/data/themedir1/block-theme-child/blocks/example-block/view.asset.php b/data/themedir1/block-theme-child/blocks/example-block/view.asset.php
new file mode 100644
index 0000000000..0314b6de8d
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/view.asset.php
@@ -0,0 +1,6 @@
+<?php
+
+return array(
+	'dependencies' => array( 'wp-element', 'wp-blocks' ),
+	'version'      => 'test',
+);
diff --git a/data/themedir1/block-theme-child/blocks/example-block/view.js b/data/themedir1/block-theme-child/blocks/example-block/view.js
new file mode 100644
index 0000000000..0bdf0f5ad9
--- /dev/null
+++ b/data/themedir1/block-theme-child/blocks/example-block/view.js
@@ -0,0 +1 @@
+/* Test JavaScript file. */
diff --git a/data/themedir1/block-theme-post-content-default/style.css b/data/themedir1/block-theme-post-content-default/style.css
new file mode 100644
index 0000000000..86f835f8dc
--- /dev/null
+++ b/data/themedir1/block-theme-post-content-default/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Block Theme Post Content Default
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Version: 1.0.0
+Text Domain: block-theme-post-content-default
+*/
diff --git a/data/themedir1/block-theme-post-content-default/templates/index.html b/data/themedir1/block-theme-post-content-default/templates/index.html
new file mode 100644
index 0000000000..e76bcaaf3a
--- /dev/null
+++ b/data/themedir1/block-theme-post-content-default/templates/index.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Index Template</p>
+<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/block-theme-post-content-default/templates/single.html b/data/themedir1/block-theme-post-content-default/templates/single.html
new file mode 100644
index 0000000000..45b08fd06d
--- /dev/null
+++ b/data/themedir1/block-theme-post-content-default/templates/single.html
@@ -0,0 +1,2 @@
+<!-- wp:post-title {"level":1,"style":{"spacing":{"margin":{"bottom":"var:preset|spacing|40"}}}} /-->
+<!-- wp:post-content /-->
diff --git a/data/themedir1/block-theme-post-content-default/theme.json b/data/themedir1/block-theme-post-content-default/theme.json
new file mode 100644
index 0000000000..781d5ed669
--- /dev/null
+++ b/data/themedir1/block-theme-post-content-default/theme.json
@@ -0,0 +1,104 @@
+{
+	"version": 1,
+	"title": "Block theme",
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			],
+			"gradients": [
+				{
+					"name": "Custom gradient",
+					"gradient": "linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%)",
+					"slug": "custom-gradient"
+				}
+			],
+			"duotone": [
+				{
+					"colors": [ "#333333", "#aaaaaa" ],
+					"slug": "custom-duotone",
+					"name": "Custom Duotone"
+				}
+			],
+			"custom": false,
+			"customGradient": false
+		},
+		"typography": {
+			"fontSizes": [
+				{
+					"name": "Custom",
+					"slug": "custom",
+					"size": "100px"
+				}
+			],
+			"customFontSize": false,
+			"customLineHeight": true
+		},
+		"spacing": {
+			"units": ["rem"],
+			"customPadding": true,
+			"blockGap": true
+		},
+		"blocks": {
+			"core/paragraph": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f5f7f9"
+						}
+					]
+				}
+			}
+		}
+	},
+	"styles" : {
+		"blocks" :{
+			"core/post-featured-image": {
+				"shadow": "10px 10px 5px 0px rgba(0,0,0,0.66)",
+				"filter": {
+					"duotone": "var(--wp--preset--duotone--custom-duotone)"
+				}
+			}
+		},
+		"elements": {
+			"button": {
+				"shadow": "10px 10px 5px 0px rgba(0,0,0,0.66)"
+			},
+			"link": {
+				"typography": {
+					"textDecoration": "none"
+				},
+				"border": {
+					"bottom": {
+						"width": "2px",
+						"color": "currentColor",
+						"style": "solid"
+					}
+				},
+				":hover": {
+					"typography": {
+						"textDecoration": "none"
+					},
+					"border": {
+						"bottom": {
+							"width": "2px",
+							"color": "#000",
+							"style": "dotted"
+						}
+					}
+				}
+			}
+		}
+	}
+}
diff --git a/data/themedir1/block-theme/templates/single.html b/data/themedir1/block-theme/templates/single.html
new file mode 100644
index 0000000000..4ad4c7caec
--- /dev/null
+++ b/data/themedir1/block-theme/templates/single.html
@@ -0,0 +1,2 @@
+<!-- wp:post-title {"level":1,"style":{"spacing":{"margin":{"bottom":"var:preset|spacing|40"}}}} /-->
+<!-- wp:post-content {"layout":{"type":"constrained"}} /-->
diff --git a/data/themedir1/block-theme/theme.json b/data/themedir1/block-theme/theme.json
index 76d075aab7..982ad8ca39 100644
--- a/data/themedir1/block-theme/theme.json
+++ b/data/themedir1/block-theme/theme.json
@@ -73,6 +73,13 @@
 			"my/third-party-block": {
 				"color": {
 					"background": "hotpink"
+				},
+				"elements": {
+					"cite": {
+						"color": {
+							"text": "white"
+						}
+					}
 				}
 			}
 		},
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Bold-Italic.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Bold-Italic.woff2
new file mode 100644
index 0000000000..e8f4669901
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Bold-Italic.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Bold.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Bold.woff2
new file mode 100644
index 0000000000..9a7696df2a
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Bold.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Medium.ttf b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Medium.ttf
new file mode 100644
index 0000000000..aa3c2a2cab
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Medium.ttf differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-MediumItalic.ttf b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-MediumItalic.ttf
new file mode 100644
index 0000000000..4365309cf2
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-MediumItalic.ttf differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Regular-Italic.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Regular-Italic.woff2
new file mode 100644
index 0000000000..773b7277fb
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Regular-Italic.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Regular.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Regular.woff2
new file mode 100644
index 0000000000..b8f0bd8ae0
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/DMSans-Regular.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/LICENSE.txt b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/LICENSE.txt
new file mode 100644
index 0000000000..02d522fe58
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/assets/fonts/dm-sans/LICENSE.txt
@@ -0,0 +1,94 @@
+Copyright 2014-2017 Indian Type Foundry (info@indiantypefoundry.com). Copyright 2019 Google LLC.
+Copyright 2014-2018 Adobe (http://www.adobe.com/), with Reserved Font Name 'Source'. All Rights Reserved. Source is a trademark of Adobe in the United States and/or other countries. Copyright 2019 Google LLC.
+
+This Font Software is licensed under the SIL Open Font License, Version 1.1.
+This license is copied below, and is also available with a FAQ at:
+http://scripts.sil.org/OFL
+
+
+-----------------------------------------------------------
+SIL OPEN FONT LICENSE Version 1.1 - 26 February 2007
+-----------------------------------------------------------
+
+PREAMBLE
+The goals of the Open Font License (OFL) are to stimulate worldwide
+development of collaborative font projects, to support the font creation
+efforts of academic and linguistic communities, and to provide a free and
+open framework in which fonts may be shared and improved in partnership
+with others.
+
+The OFL allows the licensed fonts to be used, studied, modified and
+redistributed freely as long as they are not sold by themselves. The
+fonts, including any derivative works, can be bundled, embedded, 
+redistributed and/or sold with any software provided that any reserved
+names are not used by derivative works. The fonts and derivatives,
+however, cannot be released under any other type of license. The
+requirement for fonts to remain under this license does not apply
+to any document created using the fonts or their derivatives.
+
+DEFINITIONS
+"Font Software" refers to the set of files released by the Copyright
+Holder(s) under this license and clearly marked as such. This may
+include source files, build scripts and documentation.
+
+"Reserved Font Name" refers to any names specified as such after the
+copyright statement(s).
+
+"Original Version" refers to the collection of Font Software components as
+distributed by the Copyright Holder(s).
+
+"Modified Version" refers to any derivative made by adding to, deleting,
+or substituting -- in part or in whole -- any of the components of the
+Original Version, by changing formats or by porting the Font Software to a
+new environment.
+
+"Author" refers to any designer, engineer, programmer, technical
+writer or other person who contributed to the Font Software.
+
+PERMISSION & CONDITIONS
+Permission is hereby granted, free of charge, to any person obtaining
+a copy of the Font Software, to use, study, copy, merge, embed, modify,
+redistribute, and sell modified and unmodified copies of the Font
+Software, subject to the following conditions:
+
+1) Neither the Font Software nor any of its individual components,
+in Original or Modified Versions, may be sold by itself.
+
+2) Original or Modified Versions of the Font Software may be bundled,
+redistributed and/or sold with any software, provided that each copy
+contains the above copyright notice and this license. These can be
+included either as stand-alone text files, human-readable headers or
+in the appropriate machine-readable metadata fields within text or
+binary files as long as those fields can be easily viewed by the user.
+
+3) No Modified Version of the Font Software may use the Reserved Font
+Name(s) unless explicit written permission is granted by the corresponding
+Copyright Holder. This restriction only applies to the primary font name as
+presented to the users.
+
+4) The name(s) of the Copyright Holder(s) or the Author(s) of the Font
+Software shall not be used to promote, endorse or advertise any
+Modified Version, except to acknowledge the contribution(s) of the
+Copyright Holder(s) and the Author(s) or with their explicit written
+permission.
+
+5) The Font Software, modified or unmodified, in part or in whole,
+must be distributed entirely under this license, and must not be
+distributed under any other license. The requirement for fonts to
+remain under this license does not apply to any document created
+using the Font Software.
+
+TERMINATION
+This license becomes null and void if any of the above conditions are
+not met.
+
+DISCLAIMER
+THE FONT SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTIES OF
+MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
+OF COPYRIGHT, PATENT, TRADEMARK, OR OTHER RIGHT. IN NO EVENT SHALL THE
+COPYRIGHT HOLDER BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
+INCLUDING ANY GENERAL, SPECIAL, INDIRECT, INCIDENTAL, OR CONSEQUENTIAL
+DAMAGES, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+FROM, OUT OF THE USE OR INABILITY TO USE THE FONT SOFTWARE OR FROM
+OTHER DEALINGS IN THE FONT SOFTWARE.
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OFL.txt b/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OFL.txt
new file mode 100644
index 0000000000..57eeaca60a
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OFL.txt
@@ -0,0 +1,93 @@
+Copyright 2020 The Open Sans Project Authors (https://github.com/googlefonts/opensans)
+
+This Font Software is licensed under the SIL Open Font License, Version 1.1.
+This license is copied below, and is also available with a FAQ at:
+http://scripts.sil.org/OFL
+
+
+-----------------------------------------------------------
+SIL OPEN FONT LICENSE Version 1.1 - 26 February 2007
+-----------------------------------------------------------
+
+PREAMBLE
+The goals of the Open Font License (OFL) are to stimulate worldwide
+development of collaborative font projects, to support the font creation
+efforts of academic and linguistic communities, and to provide a free and
+open framework in which fonts may be shared and improved in partnership
+with others.
+
+The OFL allows the licensed fonts to be used, studied, modified and
+redistributed freely as long as they are not sold by themselves. The
+fonts, including any derivative works, can be bundled, embedded, 
+redistributed and/or sold with any software provided that any reserved
+names are not used by derivative works. The fonts and derivatives,
+however, cannot be released under any other type of license. The
+requirement for fonts to remain under this license does not apply
+to any document created using the fonts or their derivatives.
+
+DEFINITIONS
+"Font Software" refers to the set of files released by the Copyright
+Holder(s) under this license and clearly marked as such. This may
+include source files, build scripts and documentation.
+
+"Reserved Font Name" refers to any names specified as such after the
+copyright statement(s).
+
+"Original Version" refers to the collection of Font Software components as
+distributed by the Copyright Holder(s).
+
+"Modified Version" refers to any derivative made by adding to, deleting,
+or substituting -- in part or in whole -- any of the components of the
+Original Version, by changing formats or by porting the Font Software to a
+new environment.
+
+"Author" refers to any designer, engineer, programmer, technical
+writer or other person who contributed to the Font Software.
+
+PERMISSION & CONDITIONS
+Permission is hereby granted, free of charge, to any person obtaining
+a copy of the Font Software, to use, study, copy, merge, embed, modify,
+redistribute, and sell modified and unmodified copies of the Font
+Software, subject to the following conditions:
+
+1) Neither the Font Software nor any of its individual components,
+in Original or Modified Versions, may be sold by itself.
+
+2) Original or Modified Versions of the Font Software may be bundled,
+redistributed and/or sold with any software, provided that each copy
+contains the above copyright notice and this license. These can be
+included either as stand-alone text files, human-readable headers or
+in the appropriate machine-readable metadata fields within text or
+binary files as long as those fields can be easily viewed by the user.
+
+3) No Modified Version of the Font Software may use the Reserved Font
+Name(s) unless explicit written permission is granted by the corresponding
+Copyright Holder. This restriction only applies to the primary font name as
+presented to the users.
+
+4) The name(s) of the Copyright Holder(s) or the Author(s) of the Font
+Software shall not be used to promote, endorse or advertise any
+Modified Version, except to acknowledge the contribution(s) of the
+Copyright Holder(s) and the Author(s) or with their explicit written
+permission.
+
+5) The Font Software, modified or unmodified, in part or in whole,
+must be distributed entirely under this license, and must not be
+distributed under any other license. The requirement for fonts to
+remain under this license does not apply to any document created
+using the Font Software.
+
+TERMINATION
+This license becomes null and void if any of the above conditions are
+not met.
+
+DISCLAIMER
+THE FONT SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTIES OF
+MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
+OF COPYRIGHT, PATENT, TRADEMARK, OR OTHER RIGHT. IN NO EVENT SHALL THE
+COPYRIGHT HOLDER BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
+INCLUDING ANY GENERAL, SPECIAL, INDIRECT, INCIDENTAL, OR CONSEQUENTIAL
+DAMAGES, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+FROM, OUT OF THE USE OR INABILITY TO USE THE FONT SOFTWARE OR FROM
+OTHER DEALINGS IN THE FONT SOFTWARE.
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OpenSans-Italic-VariableFont_wdth,wght.ttf b/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OpenSans-Italic-VariableFont_wdth,wght.ttf
new file mode 100644
index 0000000000..f7328a583f
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OpenSans-Italic-VariableFont_wdth,wght.ttf differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OpenSans-VariableFont_wdth,wght.ttf b/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OpenSans-VariableFont_wdth,wght.ttf
new file mode 100644
index 0000000000..ad86e00ccd
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/open-sans/OpenSans-VariableFont_wdth,wght.ttf differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/LICENSE.md b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/LICENSE.md
new file mode 100644
index 0000000000..7cd3e749de
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/LICENSE.md
@@ -0,0 +1,93 @@
+Copyright 2014 - 2021 Adobe Systems Incorporated (http://www.adobe.com/), with Reserved Font Name 'Source'. All Rights Reserved. Source is a trademark of Adobe Systems Incorporated in the United States and/or other countries.
+
+This Font Software is licensed under the SIL Open Font License, Version 1.1.
+
+This license is copied below, and is also available with a FAQ at: http://scripts.sil.org/OFL
+
+
+-----------------------------------------------------------
+SIL OPEN FONT LICENSE Version 1.1 - 26 February 2007
+-----------------------------------------------------------
+
+PREAMBLE
+The goals of the Open Font License (OFL) are to stimulate worldwide
+development of collaborative font projects, to support the font creation
+efforts of academic and linguistic communities, and to provide a free and
+open framework in which fonts may be shared and improved in partnership
+with others.
+
+The OFL allows the licensed fonts to be used, studied, modified and
+redistributed freely as long as they are not sold by themselves. The
+fonts, including any derivative works, can be bundled, embedded,
+redistributed and/or sold with any software provided that any reserved
+names are not used by derivative works. The fonts and derivatives,
+however, cannot be released under any other type of license. The
+requirement for fonts to remain under this license does not apply
+to any document created using the fonts or their derivatives.
+
+DEFINITIONS
+"Font Software" refers to the set of files released by the Copyright
+Holder(s) under this license and clearly marked as such. This may
+include source files, build scripts and documentation.
+
+"Reserved Font Name" refers to any names specified as such after the
+copyright statement(s).
+
+"Original Version" refers to the collection of Font Software components as
+distributed by the Copyright Holder(s).
+
+"Modified Version" refers to any derivative made by adding to, deleting,
+or substituting -- in part or in whole -- any of the components of the
+Original Version, by changing formats or by porting the Font Software to a
+new environment.
+
+"Author" refers to any designer, engineer, programmer, technical
+writer or other person who contributed to the Font Software.
+
+PERMISSION & CONDITIONS
+Permission is hereby granted, free of charge, to any person obtaining
+a copy of the Font Software, to use, study, copy, merge, embed, modify,
+redistribute, and sell modified and unmodified copies of the Font
+Software, subject to the following conditions:
+
+1) Neither the Font Software nor any of its individual components,
+   in Original or Modified Versions, may be sold by itself.
+
+2) Original or Modified Versions of the Font Software may be bundled,
+   redistributed and/or sold with any software, provided that each copy
+   contains the above copyright notice and this license. These can be
+   included either as stand-alone text files, human-readable headers or
+   in the appropriate machine-readable metadata fields within text or
+   binary files as long as those fields can be easily viewed by the user.
+
+3) No Modified Version of the Font Software may use the Reserved Font
+   Name(s) unless explicit written permission is granted by the corresponding
+   Copyright Holder. This restriction only applies to the primary font name as
+   presented to the users.
+
+4) The name(s) of the Copyright Holder(s) or the Author(s) of the Font
+   Software shall not be used to promote, endorse or advertise any
+   Modified Version, except to acknowledge the contribution(s) of the
+   Copyright Holder(s) and the Author(s) or with their explicit written
+   permission.
+
+5) The Font Software, modified or unmodified, in part or in whole,
+   must be distributed entirely under this license, and must not be
+   distributed under any other license. The requirement for fonts to
+   remain under this license does not apply to any document created
+   using the Font Software.
+
+TERMINATION
+This license becomes null and void if any of the above conditions are
+not met.
+
+DISCLAIMER
+THE FONT SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTIES OF
+MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT
+OF COPYRIGHT, PATENT, TRADEMARK, OR OTHER RIGHT. IN NO EVENT SHALL THE
+COPYRIGHT HOLDER BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
+INCLUDING ANY GENERAL, SPECIAL, INDIRECT, INCIDENTAL, OR CONSEQUENTIAL
+DAMAGES, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+FROM, OUT OF THE USE OR INABILITY TO USE THE FONT SOFTWARE OR FROM
+OTHER DEALINGS IN THE FONT SOFTWARE.
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.otf.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.otf.woff2
new file mode 100644
index 0000000000..2387849154
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.otf.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2
new file mode 100644
index 0000000000..4cbd4c351f
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.otf.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.otf.woff2
new file mode 100644
index 0000000000..28701e6842
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.otf.woff2 differ
diff --git a/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2 b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2
new file mode 100644
index 0000000000..3b74d300ad
Binary files /dev/null and b/data/themedir1/fonts-block-theme/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2 differ
diff --git a/data/themedir1/webfonts-theme/style.css b/data/themedir1/fonts-block-theme/style.css
similarity index 52%
rename from data/themedir1/webfonts-theme/style.css
rename to data/themedir1/fonts-block-theme/style.css
index 677a9db2a0..7b10a7e2eb 100644
--- a/data/themedir1/webfonts-theme/style.css
+++ b/data/themedir1/fonts-block-theme/style.css
@@ -1,7 +1,7 @@
 /*
-Theme Name: Webfonts theme
+Theme Name: Block Theme with defined Typography Fonts
 Theme URI: https://wordpress.org/
 Description: For testing purposes only.
 Version: 1.0.0
-Text Domain: webfonts-theme
+Text Domain: fonts-block-theme
 */
diff --git a/data/themedir1/fonts-block-theme/styles/variation-duplicate-fonts.json b/data/themedir1/fonts-block-theme/styles/variation-duplicate-fonts.json
new file mode 100644
index 0000000000..0406890433
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/styles/variation-duplicate-fonts.json
@@ -0,0 +1,40 @@
+{
+	"version": 2,
+	"title": "Variation: duplicate fonts",
+	"settings": {
+		"typography": {
+			"fontFamilies": [
+				{
+					"fontFamily": "\"DM Sans\", sans-serif",
+					"name": "DM Sans",
+					"slug": "dm-sans",
+					"fontFace": [
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "400",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Regular.woff2"
+							]
+						},
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "700",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Bold.woff2"
+							]
+						}
+					]
+				}
+			]
+		}
+	},
+	"styles": {
+		"typography": {
+			"fontFamily": "var(--wp--preset--font-family--dm-sans)"
+		}
+	}
+}
diff --git a/data/themedir1/fonts-block-theme/styles/variation-new-font-family.json b/data/themedir1/fonts-block-theme/styles/variation-new-font-family.json
new file mode 100644
index 0000000000..01c6027835
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/styles/variation-new-font-family.json
@@ -0,0 +1,40 @@
+{
+	"version": 2,
+	"title": "Variation: new font family",
+	"settings": {
+		"typography": {
+			"fontFamilies": [
+				{
+					"fontFamily": "\"Open Sans\", serif",
+					"name": "Open Sans",
+					"slug": "open-sans",
+					"fontFace": [
+						{
+							"fontFamily": "Open Sans",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "400",
+							"src": [
+								"file:./assets/fonts/open-sans/OpenSans-VariableFont_wdth,wght.tff"
+							]
+						},
+						{
+							"fontFamily": "Open Sans",
+							"fontStretch": "normal",
+							"fontStyle": "italic",
+							"fontWeight": "400",
+							"src": [
+								"file:./assets/fonts/open-sans/OpenSans-Italic-VariableFont_wdth,wght.tff"
+							]
+						}
+					]
+				}
+			]
+		}
+	},
+	"styles": {
+		"typography": {
+			"fontFamily": "var(--wp--preset--font-family--open-sans)"
+		}
+	}
+}
diff --git a/data/themedir1/fonts-block-theme/styles/variation-new-font-variations.json b/data/themedir1/fonts-block-theme/styles/variation-new-font-variations.json
new file mode 100644
index 0000000000..81268817ad
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/styles/variation-new-font-variations.json
@@ -0,0 +1,40 @@
+{
+	"version": 2,
+	"title": "Variation: new font variations",
+	"settings": {
+		"typography": {
+			"fontFamilies": [
+				{
+					"fontFamily": "\"DM Sans\", sans-serif",
+					"name": "DM Sans",
+					"slug": "dm-sans",
+					"fontFace": [
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "500",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Medium.woff2"
+							]
+						},
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "italic",
+							"fontWeight": "500",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Medium-Italic.woff2"
+							]
+						}
+					]
+				}
+			]
+		}
+	},
+	"styles": {
+		"typography": {
+			"fontFamily": "var(--wp--preset--font-family--dm-sans)"
+		}
+	}
+}
diff --git a/data/themedir1/fonts-block-theme/styles/variation-no-fonts.json b/data/themedir1/fonts-block-theme/styles/variation-no-fonts.json
new file mode 100644
index 0000000000..9c98c6893f
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/styles/variation-no-fonts.json
@@ -0,0 +1,9 @@
+{
+	"version": 2,
+	"title": "Variation - no fonts",
+	"styles": {
+		"typography": {
+			"fontFamily": "var(--wp--preset--font-family--dm-sans)"
+		}
+	}
+}
diff --git a/data/themedir1/webfonts-theme/templates/index.html b/data/themedir1/fonts-block-theme/templates/index.html
similarity index 100%
rename from data/themedir1/webfonts-theme/templates/index.html
rename to data/themedir1/fonts-block-theme/templates/index.html
diff --git a/data/themedir1/fonts-block-theme/theme.json b/data/themedir1/fonts-block-theme/theme.json
new file mode 100644
index 0000000000..a8212b79e1
--- /dev/null
+++ b/data/themedir1/fonts-block-theme/theme.json
@@ -0,0 +1,112 @@
+{
+	"version": 2,
+	"settings": {
+		"appearanceTools": true,
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			]
+		},
+		"typography": {
+			"dropCap": false,
+			"fluid": true,
+			"fontFamilies": [
+				{
+					"fontFace": [
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "400",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Regular.woff2"
+							]
+						},
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "italic",
+							"fontWeight": "400",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Regular-Italic.woff2"
+							]
+						},
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "700",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Bold.woff2"
+							]
+						},
+						{
+							"fontFamily": "DM Sans",
+							"fontStretch": "normal",
+							"fontStyle": "italic",
+							"fontWeight": "700",
+							"src": [
+								"file:./assets/fonts/dm-sans/DMSans-Bold-Italic.woff2"
+							]
+						}
+					],
+					"fontFamily": "\"DM Sans\", sans-serif",
+					"name": "DM Sans",
+					"slug": "dm-sans"
+				},
+				{
+					"fontFamily": "-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,Oxygen-Sans,Ubuntu,Cantarell,\"Helvetica Neue\",sans-serif",
+					"name": "System Font",
+					"slug": "system-font"
+				},
+				{
+					"fontFace": [
+						{
+							"fontFamily": "Source Serif Pro",
+							"fontStretch": "normal",
+							"fontStyle": "normal",
+							"fontWeight": "200 900",
+							"src": [
+								"file:./assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2"
+							]
+						},
+						{
+							"fontFamily": "Source Serif Pro",
+							"fontStretch": "normal",
+							"fontStyle": "italic",
+							"fontWeight": "200 900",
+							"src": [
+								"file:./assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2"
+							]
+						}
+					],
+					"fontFamily": "\"Source Serif Pro\", serif",
+					"name": "Source Serif Pro",
+					"slug": "source-serif-pro"
+				}
+			]
+		},
+		"useRootPaddingAwareAlignments": true
+	},
+	"styles": {
+		"typography": {
+			"fontFamily": "var(--wp--preset--font-family--system-font)"
+		}
+	},
+	"templateParts": [
+		{
+			"name": "small-header",
+			"title": "Small Header",
+			"area": "header"
+		}
+	]
+}
diff --git a/data/themedir1/webfonts-theme/functions.php b/data/themedir1/webfonts-theme/functions.php
deleted file mode 100644
index b3d9bbc7f3..0000000000
--- a/data/themedir1/webfonts-theme/functions.php
+++ /dev/null
@@ -1 +0,0 @@
-<?php
diff --git a/data/themedir1/webfonts-theme/index.php b/data/themedir1/webfonts-theme/index.php
deleted file mode 100644
index 589adcefcd..0000000000
--- a/data/themedir1/webfonts-theme/index.php
+++ /dev/null
@@ -1,4 +0,0 @@
-<?php
-/**
- * Block theme.
- */
diff --git a/data/themedir1/webfonts-theme/theme.json b/data/themedir1/webfonts-theme/theme.json
deleted file mode 100644
index 0606b9b780..0000000000
--- a/data/themedir1/webfonts-theme/theme.json
+++ /dev/null
@@ -1,103 +0,0 @@
-{
-  "version": 2,
-  "customTemplates": [
-	{
-	  "name": "blank",
-	  "title": "Blank",
-	  "postTypes": [
-		"page",
-		"post"
-	  ]
-	}
-  ],
-  "settings": {
-	"appearanceTools": true,
-	"color": {
-	  "duotone": [],
-	  "gradients": [],
-	  "palette": []
-	},
-	"custom": {},
-	"spacing": {
-	  "units": [
-		"%",
-		"px",
-		"em",
-		"rem",
-		"vh",
-		"vw"
-	  ]
-	},
-	"typography": {
-	  "dropCap": false,
-	  "fontFamilies": [
-		{
-		  "fontFamily": "\"Source Serif Pro\", serif",
-		  "name": "Source Serif Pro",
-		  "slug": "source-serif-pro",
-		  "fontFace": [
-			{
-			  "fontFamily": "Source Serif Pro",
-			  "fontWeight": "200 900",
-			  "fontStyle": "normal",
-			  "fontStretch": "normal",
-			  "src": [ "file:./assets/fonts/SourceSerif4Variable-Roman.ttf.woff2" ]
-			},
-			{
-			  "fontFamily": "Source Serif Pro",
-			  "fontWeight": "200 900",
-			  "fontStyle": "italic",
-			  "fontStretch": "normal",
-			  "src": [ "file:./assets/fonts/SourceSerif4Variable-Italic.ttf.woff2" ]
-			}
-		  ]
-		}
-	  ],
-	  "fontSizes": [
-		{
-		  "size": "1rem",
-		  "slug": "small"
-		},
-		{
-		  "size": "1.125rem",
-		  "slug": "medium"
-		},
-		{
-		  "size": "1.75rem",
-		  "slug": "large"
-		},
-		{
-		  "size": "clamp(1.75rem, 3vw, 2.25rem)",
-		  "slug": "x-large"
-		}
-	  ]
-	},
-	"layout": {
-	  "contentSize": "650px",
-	  "wideSize": "1000px"
-	}
-  },
-  "styles": {
-	"blocks": {},
-	"color": {
-	  "background": "var(--wp--preset--color--background)",
-	  "text": "var(--wp--preset--color--foreground)"
-	},
-	"elements": {},
-	"spacing": {
-	  "blockGap": "1.5rem"
-	},
-	"typography": {
-	  "fontFamily": "var(--wp--preset--font-family--system-font)",
-	  "lineHeight": "var(--wp--custom--typography--line-height--normal)",
-	  "fontSize": "var(--wp--preset--font-size--medium)"
-	}
-  },
-  "templateParts": [
-	{
-	  "name": "header",
-	  "title": "Header",
-	  "area": "header"
-	}
-  ]
-}
diff --git a/data/uploads/double-mime-type.docx b/data/uploads/double-mime-type.docx
new file mode 100644
index 0000000000..44988f24da
--- /dev/null
+++ b/data/uploads/double-mime-type.docx
@@ -0,0 +1 @@
+hello
diff --git a/includes/abstract-testcase.php b/includes/abstract-testcase.php
index 2c1b4a1d58..3f5519ae41 100644
--- a/includes/abstract-testcase.php
+++ b/includes/abstract-testcase.php
@@ -142,15 +142,18 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 * After a test method runs, resets any state in WordPress the test method might have changed.
 	 */
 	public function tear_down() {
-		global $wpdb, $wp_query, $wp;
+		global $wpdb, $wp_the_query, $wp_query, $wp;
 		$wpdb->query( 'ROLLBACK' );
 		if ( is_multisite() ) {
 			while ( ms_is_switched() ) {
 				restore_current_blog();
 			}
 		}
-		$wp_query = new WP_Query();
-		$wp       = new WP();
+
+		// Reset query, main query, and WP globals similar to wp-settings.php.
+		$wp_the_query = new WP_Query();
+		$wp_query     = $wp_the_query;
+		$wp           = new WP();
 
 		// Reset globals related to the post loop and `setup_postdata()`.
 		$post_globals = array( 'post', 'id', 'authordata', 'currentday', 'currentmonth', 'page', 'pages', 'multipage', 'more', 'numpages' );
@@ -195,9 +198,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 		$this->_restore_hooks();
 		wp_set_current_user( 0 );
 
-		$lazyloader = wp_metadata_lazyloader();
-		$lazyloader->reset_queue( 'term' );
-		$lazyloader->reset_queue( 'comment' );
+		$this->reset_lazyload_queue();
 	}
 
 	/**
@@ -273,7 +274,16 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 		if ( 0 === strpos( $response->get_error_message(), 'stream_socket_client(): unable to connect to tcp://s.w.org:80' ) ) {
 			$this->markTestSkipped( 'HTTP timeout' );
 		}
+	}
 
+	/**
+	 * Reset the lazy load meta queue.
+	 */
+	protected function reset_lazyload_queue() {
+		$lazyloader = wp_metadata_lazyloader();
+		$lazyloader->reset_queue( 'term' );
+		$lazyloader->reset_queue( 'comment' );
+		$lazyloader->reset_queue( 'blog' );
 	}
 
 	/**
@@ -380,12 +390,9 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	public static function flush_cache() {
 		global $wp_object_cache;
 
-		$wp_object_cache->group_ops      = array();
-		$wp_object_cache->stats          = array();
-		$wp_object_cache->memcache_debug = array();
-		$wp_object_cache->cache          = array();
+		wp_cache_flush_runtime();
 
-		if ( method_exists( $wp_object_cache, '__remoteset' ) ) {
+		if ( is_object( $wp_object_cache ) && method_exists( $wp_object_cache, '__remoteset' ) ) {
 			$wp_object_cache->__remoteset();
 		}
 
@@ -407,10 +414,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 				'site-transient',
 				'rss',
 				'users',
+				'user-queries',
+				'user_meta',
 				'useremail',
 				'userlogins',
-				'usermeta',
-				'user_meta',
 				'userslugs',
 			)
 		);
@@ -560,12 +567,14 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 
 		add_action( 'deprecated_function_run', array( $this, 'deprecated_function_run' ), 10, 3 );
 		add_action( 'deprecated_argument_run', array( $this, 'deprecated_function_run' ), 10, 3 );
+		add_action( 'deprecated_class_run', array( $this, 'deprecated_function_run' ), 10, 3 );
 		add_action( 'deprecated_file_included', array( $this, 'deprecated_function_run' ), 10, 4 );
 		add_action( 'deprecated_hook_run', array( $this, 'deprecated_function_run' ), 10, 4 );
 		add_action( 'doing_it_wrong_run', array( $this, 'doing_it_wrong_run' ), 10, 3 );
 
 		add_action( 'deprecated_function_trigger_error', '__return_false' );
 		add_action( 'deprecated_argument_trigger_error', '__return_false' );
+		add_action( 'deprecated_class_trigger_error', '__return_false' );
 		add_action( 'deprecated_file_trigger_error', '__return_false' );
 		add_action( 'deprecated_hook_trigger_error', '__return_false' );
 		add_action( 'doing_it_wrong_trigger_error', '__return_false' );
@@ -738,6 +747,23 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 					}
 					break;
 
+				case 'deprecated_class_run':
+					if ( $replacement ) {
+						$message = sprintf(
+							'Class %1$s is deprecated since version %2$s! Use %3$s instead.',
+							$function_name,
+							$version,
+							$replacement
+						);
+					} else {
+						$message = sprintf(
+							'Class %1$s is deprecated since version %2$s with no alternative available.',
+							$function_name,
+							$version
+						);
+					}
+					break;
+
 				case 'deprecated_file_included':
 					if ( $replacement ) {
 						$message = sprintf(
@@ -861,7 +887,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 		$this->assertNotEmpty( $fields, $message . ' Fields array is empty.' );
 
 		foreach ( $fields as $field_name => $field_value ) {
-			$this->assertObjectHasAttribute( $field_name, $actual, $message . " Property $field_name does not exist on the object." );
+			$this->assertObjectHasProperty( $field_name, $actual, $message . " Property $field_name does not exist on the object." );
 			$this->assertSame( $field_value, $actual->$field_name, $message . " Value of property $field_name is not $field_value." );
 		}
 	}
diff --git a/includes/bootstrap.php b/includes/bootstrap.php
index 1113a87eea..15ec06b081 100644
--- a/includes/bootstrap.php
+++ b/includes/bootstrap.php
@@ -10,7 +10,7 @@ if ( defined( 'WP_TESTS_CONFIG_FILE_PATH' ) ) {
 	if ( ! file_exists( $config_file_path . '/wp-tests-config.php' ) ) {
 		// Support the config file from the root of the develop repository.
 		if ( basename( $config_file_path ) === 'phpunit' && basename( dirname( $config_file_path ) ) === 'tests' ) {
-			$config_file_path = dirname( dirname( $config_file_path ) );
+			$config_file_path = dirname( $config_file_path, 2 );
 		}
 	}
 	$config_file_path .= '/wp-tests-config.php';
@@ -79,7 +79,7 @@ if ( version_compare( $phpunit_version, '5.7.21', '<' ) ) {
  */
 if ( ! class_exists( 'Yoast\PHPUnitPolyfills\Autoload' ) ) {
 	// Default location of the autoloader for WP core test runs.
-	$phpunit_polyfills_autoloader = dirname( dirname( dirname( __DIR__ ) ) ) . '/vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php';
+	$phpunit_polyfills_autoloader = dirname( __DIR__, 3 ) . '/vendor/yoast/phpunit-polyfills/phpunitpolyfills-autoload.php';
 	$phpunit_polyfills_error      = false;
 
 	// Allow for a custom installation location to be provided for plugin/theme integration tests.
@@ -139,7 +139,7 @@ unset( $phpunit_polyfills_autoloader, $phpunit_polyfills_error, $phpunit_polyfil
  * Minimum version of the PHPUnit Polyfills package as declared in `composer.json`.
  * Only needs updating when new polyfill features start being used in the test suite.
  */
-$phpunit_polyfills_minimum_version = '1.0.1';
+$phpunit_polyfills_minimum_version = '1.1.0';
 if ( class_exists( '\Yoast\PHPUnitPolyfills\Autoload' )
 	&& ( defined( '\Yoast\PHPUnitPolyfills\Autoload::VERSION' ) === false
 	|| version_compare( Yoast\PHPUnitPolyfills\Autoload::VERSION, $phpunit_polyfills_minimum_version, '<' ) )
@@ -390,6 +390,5 @@ class WP_PHPUnit_Util_Getopt {
 			echo PHP_EOL;
 		}
 	}
-
 }
 new WP_PHPUnit_Util_Getopt( $_SERVER['argv'] );
diff --git a/includes/factory/class-wp-unittest-factory-for-thing.php b/includes/factory/class-wp-unittest-factory-for-thing.php
index ebdb450163..adc0a4cc75 100644
--- a/includes/factory/class-wp-unittest-factory-for-thing.php
+++ b/includes/factory/class-wp-unittest-factory-for-thing.php
@@ -246,5 +246,4 @@ abstract class WP_UnitTest_Factory_For_Thing {
 
 		return $value;
 	}
-
 }
diff --git a/includes/factory/class-wp-unittest-generator-sequence.php b/includes/factory/class-wp-unittest-generator-sequence.php
index 9391dd8bf7..6412c15db7 100644
--- a/includes/factory/class-wp-unittest-generator-sequence.php
+++ b/includes/factory/class-wp-unittest-generator-sequence.php
@@ -9,7 +9,7 @@ class WP_UnitTest_Generator_Sequence {
 		if ( $start ) {
 			$this->next = $start;
 		} else {
-			self::$incr++;
+			++self::$incr;
 			$this->next = self::$incr;
 		}
 		$this->template_string = $template_string;
@@ -17,7 +17,7 @@ class WP_UnitTest_Generator_Sequence {
 
 	public function next() {
 		$generated = sprintf( $this->template_string, $this->next );
-		$this->next++;
+		++$this->next;
 		return $generated;
 	}
 
diff --git a/includes/functions.php b/includes/functions.php
index 0c9dbd019f..81d4339db1 100644
--- a/includes/functions.php
+++ b/includes/functions.php
@@ -118,7 +118,7 @@ function _delete_all_data() {
 		$wpdb->term_relationships,
 		$wpdb->termmeta,
 	) as $table ) {
-		//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DELETE FROM {$table}" );
 	}
 
@@ -126,7 +126,7 @@ function _delete_all_data() {
 		$wpdb->terms,
 		$wpdb->term_taxonomy,
 	) as $table ) {
-		//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DELETE FROM {$table} WHERE term_id != 1" );
 	}
 
diff --git a/includes/install.php b/includes/install.php
index 3157fd9384..8a595903c7 100644
--- a/includes/install.php
+++ b/includes/install.php
@@ -64,12 +64,12 @@ echo 'Installing...' . PHP_EOL;
 
 $wpdb->query( 'SET foreign_key_checks = 0' );
 foreach ( $wpdb->tables() as $table => $prefixed_table ) {
-	//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+	// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 	$wpdb->query( "DROP TABLE IF EXISTS $prefixed_table" );
 }
 
 foreach ( $wpdb->tables( 'ms_global' ) as $table => $prefixed_table ) {
-	//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+	// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 	$wpdb->query( "DROP TABLE IF EXISTS $prefixed_table" );
 
 	// We need to create references to ms global tables.
diff --git a/includes/mock-fs.php b/includes/mock-fs.php
index 2c56ddbf49..40705dc411 100644
--- a/includes/mock-fs.php
+++ b/includes/mock-fs.php
@@ -73,7 +73,6 @@ class WP_Filesystem_MockFS extends WP_Filesystem_Base {
 				$this->put_contents( $path, 'This is a test file' );
 			}
 		}
-
 	}
 
 	/**
@@ -206,7 +205,6 @@ class WP_Filesystem_MockFS extends WP_Filesystem_Base {
 		}
 		return $ret;
 	}
-
 }
 
 class MockFS_Node {
diff --git a/includes/mock-image-editor.php b/includes/mock-image-editor.php
index bc08fbb290..ab2e7379fd 100644
--- a/includes/mock-image-editor.php
+++ b/includes/mock-image-editor.php
@@ -61,7 +61,6 @@ if ( class_exists( 'WP_Image_Editor' ) ) :
 			return self::$save_return;
 		}
 		public function stream( $mime_type = null ) {
-
 		}
 
 		public function get_size() {
diff --git a/includes/object-cache.php b/includes/object-cache.php
index f9e2c4693e..e1404188f3 100644
--- a/includes/object-cache.php
+++ b/includes/object-cache.php
@@ -312,6 +312,16 @@ function wp_cache_flush( $delay = 0 ) {
 	return $wp_object_cache->flush( $delay );
 }
 
+/**
+ * Removes all cache items from the in-memory runtime cache.
+ *
+ * @return bool True on success, false on failure.
+ */
+function wp_cache_flush_runtime() {
+	global $wp_object_cache;
+	return $wp_object_cache->flush_runtime();
+}
+
 /**
  * Determines whether the object cache implementation supports a particular feature.
  *
@@ -325,6 +335,7 @@ function wp_cache_flush( $delay = 0 ) {
 function wp_cache_supports( $feature ) {
 	switch ( $feature ) {
 		case 'get_multiple':
+		case 'flush_runtime':
 			return true;
 		default:
 			return false;
@@ -902,6 +913,20 @@ class WP_Object_Cache {
 	 */
 	public $blog_prefix = '';
 
+	/**
+	 * Thirty days in seconds.
+	 *
+	 * @var int
+	 */
+	public $thirty_days;
+
+	/**
+	 * Current unix time stamp.
+	 *
+	 * @var int
+	 */
+	public $now;
+
 	/**
 	 * Instantiates the Memcached class.
 	 *
@@ -1412,6 +1437,17 @@ class WP_Object_Cache {
 		return $result;
 	}
 
+	/**
+	 * Clears the in-memory cache of all data leaving the external cache untouched.
+	 *
+	 * @return bool Always returns true.
+	 */
+	public function flush_runtime() {
+		$this->cache = array();
+
+		return true;
+	}
+
 	/**
 	 * Retrieves object from cache.
 	 *
diff --git a/includes/phpunit-adapter-testcase.php b/includes/phpunit-adapter-testcase.php
index 423a9d2213..13ac7bdd06 100644
--- a/includes/phpunit-adapter-testcase.php
+++ b/includes/phpunit-adapter-testcase.php
@@ -6,7 +6,7 @@ use Yoast\PHPUnitPolyfills\TestCases\TestCase as Polyfill_TestCase;
  * PHPUnit adapter layer.
  *
  * This class enhances the PHPUnit native `TestCase` with polyfills
- * for assertions and expectation methods added between PHPUnit 4.8 - 9.5.
+ * for assertions and expectation methods added between PHPUnit 4.8 - 9.6.
  *
  * Additionally, the Polyfill TestCase offers a workaround for the addition
  * of the `void` return type to PHPUnit fixture methods by providing
diff --git a/includes/phpunit6/compat.php b/includes/phpunit6/compat.php
index ec09a0c3fc..103f2957e5 100644
--- a/includes/phpunit6/compat.php
+++ b/includes/phpunit6/compat.php
@@ -36,7 +36,6 @@ if ( class_exists( 'PHPUnit\Runner\Version' ) && version_compare( PHPUnit\Runner
 
 			return array_unique( $tickets );
 		}
-
 	}
 
 }
diff --git a/includes/testcase-rest-api.php b/includes/testcase-rest-api.php
index 45e7c5e145..54644f13fb 100644
--- a/includes/testcase-rest-api.php
+++ b/includes/testcase-rest-api.php
@@ -3,7 +3,7 @@
 abstract class WP_Test_REST_TestCase extends WP_UnitTestCase {
 	protected function assertErrorResponse( $code, $response, $status = null ) {
 
-		if ( is_a( $response, 'WP_REST_Response' ) ) {
+		if ( $response instanceof WP_REST_Response ) {
 			$response = $response->as_error();
 		}
 
diff --git a/includes/testcase-rest-post-type-controller.php b/includes/testcase-rest-post-type-controller.php
index 1ebb28f3a5..cd8ccaefc7 100644
--- a/includes/testcase-rest-post-type-controller.php
+++ b/includes/testcase-rest-post-type-controller.php
@@ -193,10 +193,9 @@ abstract class WP_Test_REST_Post_Type_Controller_Testcase extends WP_Test_REST_C
 			foreach ( $taxonomies as $key => $taxonomy ) {
 				$this->assertSame( $taxonomy->name, $links['https://api.w.org/term'][ $num ]['attributes']['taxonomy'] );
 				$this->assertSame( add_query_arg( 'post', $data['id'], rest_url( 'wp/v2/' . $taxonomy->rest_base ) ), $links['https://api.w.org/term'][ $num ]['href'] );
-				$num++;
+				++$num;
 			}
 		}
-
 	}
 
 	protected function check_get_posts_response( $response, $context = 'view' ) {
@@ -240,7 +239,6 @@ abstract class WP_Test_REST_Post_Type_Controller_Testcase extends WP_Test_REST_C
 		$data = $response->get_data();
 		$post = get_post( $data['id'] );
 		$this->check_post_data( $post, $data, $context, $response->get_links() );
-
 	}
 
 	protected function check_create_post_response( $response ) {
diff --git a/includes/testcase-xml.php b/includes/testcase-xml.php
index 253ac2c7fc..9fc36ec60d 100644
--- a/includes/testcase-xml.php
+++ b/includes/testcase-xml.php
@@ -69,7 +69,7 @@ abstract class WP_Test_XML_TestCase extends WP_UnitTestCase {
 	 * @param string $message   Optional. Message to display when the assertion fails.
 	 */
 	public function assertXMLEquals( $expectedXml, $actualXml, $message = '' ) { // phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
-		$this->assertSame( $this->normalizeXML( $expectedXml ), $this->normalizeXML( $actualXml ), $message ); //phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
+		$this->assertSame( $this->normalizeXML( $expectedXml ), $this->normalizeXML( $actualXml ), $message ); // phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
 	}
 
 	/**
@@ -86,7 +86,7 @@ abstract class WP_Test_XML_TestCase extends WP_UnitTestCase {
 	 * @param string $actualXml
 	 * @param string $message   Optional. Message to display when the assertion fails.
 	 */
-	public function assertXMLNotEquals( $expectedXml, $actualXml, $message = '' ) { //phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
-		$this->assertNotEquals( $this->normalizeXML( $expectedXml ), $this->normalizeXML( $actualXml ), $message ); //phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
+	public function assertXMLNotEquals( $expectedXml, $actualXml, $message = '' ) { // phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
+		$this->assertNotEquals( $this->normalizeXML( $expectedXml ), $this->normalizeXML( $actualXml ), $message ); // phpcs:ignore WordPress.NamingConventions.ValidVariableName.VariableNotSnakeCase
 	}
 }
diff --git a/includes/testcase-xmlrpc.php b/includes/testcase-xmlrpc.php
index 2608ca1f26..b27186d88b 100644
--- a/includes/testcase-xmlrpc.php
+++ b/includes/testcase-xmlrpc.php
@@ -34,5 +34,4 @@ abstract class WP_XMLRPC_UnitTestCase extends WP_UnitTestCase {
 			)
 		);
 	}
-
 }
diff --git a/includes/unregister-blocks-hooks.php b/includes/unregister-blocks-hooks.php
index 5edeba1445..2255c266db 100644
--- a/includes/unregister-blocks-hooks.php
+++ b/includes/unregister-blocks-hooks.php
@@ -20,6 +20,7 @@ remove_action( 'init', 'register_block_core_comments_pagination_previous' );
 remove_action( 'init', 'register_block_core_comments_title' );
 remove_action( 'init', 'register_block_core_cover' );
 remove_action( 'init', 'register_block_core_file' );
+remove_action( 'init', 'register_block_core_footnotes' );
 remove_action( 'init', 'register_block_core_gallery' );
 remove_action( 'init', 'register_block_core_heading' );
 remove_action( 'init', 'register_block_core_home_link' );
@@ -31,6 +32,7 @@ remove_action( 'init', 'register_block_core_navigation' );
 remove_action( 'init', 'register_block_core_navigation_link' );
 remove_action( 'init', 'register_block_core_navigation_submenu' );
 remove_action( 'init', 'register_block_core_page_list' );
+remove_action( 'init', 'register_block_core_page_list_item' );
 remove_action( 'init', 'register_block_core_pattern' );
 remove_action( 'init', 'register_block_core_post_author' );
 remove_action( 'init', 'register_block_core_post_author_biography' );
@@ -61,4 +63,3 @@ remove_action( 'init', 'register_block_core_site_title' );
 remove_action( 'init', 'register_block_core_social_link' );
 remove_action( 'init', 'register_block_core_tag_cloud' );
 remove_action( 'init', 'register_block_core_template_part' );
-remove_action( 'init', 'register_block_core_term_description' );
diff --git a/includes/utils.php b/includes/utils.php
index 30af6aa348..272e9a75b0 100644
--- a/includes/utils.php
+++ b/includes/utils.php
@@ -556,7 +556,6 @@ class WpdbExposedMethodsForTesting extends wpdb {
 	public function __construct() {
 		global $wpdb;
 		$this->dbh         = $wpdb->dbh;
-		$this->use_mysqli  = $wpdb->use_mysqli;
 		$this->is_mysql    = $wpdb->is_mysql;
 		$this->ready       = true;
 		$this->field_types = $wpdb->field_types;
diff --git a/includes/wp-profiler.php b/includes/wp-profiler.php
index ce78ba4c8e..5c4ea902d0 100644
--- a/includes/wp-profiler.php
+++ b/includes/wp-profiler.php
@@ -56,7 +56,6 @@ class WPProfiler {
 			'filters'             => array(),
 			'queries'             => array(),
 		);
-
 	}
 
 	public function stop() {
@@ -73,7 +72,7 @@ class WPProfiler {
 
 		if ( isset( $this->profile[ $name ] ) ) {
 			$this->profile[ $name ]['time'] += $time;
-			$this->profile[ $name ]['calls']++;
+			++$this->profile[ $name ]['calls'];
 			$this->profile[ $name ]['cache_cold_hits']    += ( $wp_object_cache->cold_cache_hits - $item['cache_cold_hits'] );
 			$this->profile[ $name ]['cache_warm_hits']    += ( $wp_object_cache->warm_cache_hits - $item['cache_warm_hits'] );
 			$this->profile[ $name ]['cache_misses']       += ( $wp_object_cache->cache_misses - $item['cache_misses'] );
@@ -114,9 +113,9 @@ class WPProfiler {
 		if ( $this->stack ) {
 			global $wp_actions;
 			if ( end( $wp_actions ) === $tag ) {
-				$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ]++;
+				++$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ];
 			} else {
-				$this->stack[ count( $this->stack ) - 1 ]['filters'][ $tag ]++;
+				++$this->stack[ count( $this->stack ) - 1 ]['filters'][ $tag ];
 			}
 		}
 		return $arg;
@@ -124,7 +123,7 @@ class WPProfiler {
 
 	public function log_action( $tag ) {
 		if ( $this->stack ) {
-			$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ]++;
+			++$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ];
 		}
 	}
 
@@ -143,7 +142,7 @@ class WPProfiler {
 			$sql = preg_replace( '/(WHERE \w+ =) \d+/', '$1 x', $sql );
 			$sql = preg_replace( '/(WHERE \w+ =) \'\[-\w]+\'/', '$1 \'xxx\'', $sql );
 
-			$out[ $sql ]++;
+			++$out[ $sql ];
 		}
 		asort( $out );
 		return;
@@ -154,9 +153,9 @@ class WPProfiler {
 		$out = array();
 		foreach ( $queries as $q ) {
 			if ( empty( $q[2] ) ) {
-				$out['unknown']++;
+				++$out['unknown'];
 			} else {
-				$out[ $q[2] ]++;
+				++$out[ $q[2] ];
 			}
 		}
 		return $out;
@@ -220,5 +219,3 @@ function wppf_results() {
 function wppf_print_summary() {
 	$GLOBALS['wppf']->print_summary();
 }
-
-
diff --git a/multisite.xml b/multisite.xml
index 5bb20a759d..14a9fe1764 100644
--- a/multisite.xml
+++ b/multisite.xml
@@ -42,7 +42,6 @@
 				<!-- Third party library exclusions. -->
 				<directory suffix=".php">../../src/wp-includes/ID3</directory>
 				<directory suffix=".php">../../src/wp-includes/IXR</directory>
-				<directory suffix=".php">../../src/wp-includes/random_compat</directory>
 				<directory suffix=".php">../../src/wp-includes/PHPMailer</directory>
 				<directory suffix=".php">../../src/wp-includes/Requests</directory>
 				<directory suffix=".php">../../src/wp-includes/SimplePie</directory>
diff --git a/tests/actions.php b/tests/actions.php
index 67222c0819..8b57382b9c 100644
--- a/tests/actions.php
+++ b/tests/actions.php
@@ -75,7 +75,6 @@ class Tests_Actions extends WP_UnitTestCase {
 		do_action( $hook_name );
 		$this->assertSame( 1, $a->get_call_count() );
 		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
-
 	}
 
 	/**
@@ -282,7 +281,6 @@ class Tests_Actions extends WP_UnitTestCase {
 		// $hook_name1's count hasn't changed, $hook_name2 should be correct.
 		$this->assertSame( 1, did_action( $hook_name1 ) );
 		$this->assertSame( $count, did_action( $hook_name2 ) );
-
 	}
 
 	/**
@@ -309,7 +307,6 @@ class Tests_Actions extends WP_UnitTestCase {
 
 		remove_action( 'all', array( &$a, 'action' ) );
 		$this->assertFalse( has_filter( 'all', array( &$a, 'action' ) ) );
-
 	}
 
 	/**
@@ -390,7 +387,7 @@ class Tests_Actions extends WP_UnitTestCase {
 	 */
 	public function test_action_closure() {
 		$hook_name = __FUNCTION__;
-		$closure   = static function( $a, $b ) {
+		$closure   = static function ( $a, $b ) {
 			$GLOBALS[ $a ] = $b;
 		};
 		add_action( $hook_name, $closure, 10, 2 );
@@ -403,7 +400,7 @@ class Tests_Actions extends WP_UnitTestCase {
 		$this->assertSame( $GLOBALS[ $context[0] ], $context[1] );
 
 		$hook_name2 = __FUNCTION__ . '_2';
-		$closure2   = static function() {
+		$closure2   = static function () {
 			$GLOBALS['closure_no_args'] = true;
 		};
 		add_action( $hook_name2, $closure2 );
@@ -535,7 +532,7 @@ class Tests_Actions extends WP_UnitTestCase {
 		foreach ( $hook as $priority => $filter ) {
 			foreach ( $filter as $identifier => $function ) {
 				if ( is_array( $function )
-					&& is_a( $function['function'][0], 'MockAction' )
+					&& $function['function'][0] instanceof MockAction
 					&& 'action' === $function['function'][1]
 				) {
 					remove_filter(
diff --git a/tests/admin/includesFile.php b/tests/admin/includesFile.php
index 375f895c84..4a5295b29a 100644
--- a/tests/admin/includesFile.php
+++ b/tests/admin/includesFile.php
@@ -343,7 +343,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 
 		add_filter(
 			'wp_signature_hosts',
-			static function( $urls ) {
+			static function ( $urls ) {
 				$urls[] = 'example.com';
 				return $urls;
 			}
diff --git a/tests/admin/includesPost.php b/tests/admin/includesPost.php
index 799d927dfa..f4eaa0f513 100644
--- a/tests/admin/includesPost.php
+++ b/tests/admin/includesPost.php
@@ -293,6 +293,72 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 		$this->assertFalse( get_post_format( $post_ids[2] ) );
 	}
 
+	/**
+	 * @ticket 31635
+	 */
+	public function test_bulk_edit_posts_should_publish_scheduled_post() {
+		wp_set_current_user( self::$admin_id );
+
+		$post = self::factory()->post->create(
+			array(
+				'post_author'    => self::$author_ids[0],
+				'comment_status' => 'closed',
+				'ping_status'    => 'closed',
+				'post_status'    => 'future',
+				'post_date'      => gmdate( 'Y-m-d H:i:s', strtotime( '+1 month' ) ),
+			)
+		);
+
+		$request = array(
+			'post_type'      => 'post',
+			'post_author'    => -1,
+			'ping_status'    => -1,
+			'comment_status' => -1,
+			'_status'        => 'publish',
+			'post'           => array( $post ),
+		);
+
+		bulk_edit_posts( $request );
+
+		$this->assertSame( 'publish', get_post_status( $post ) );
+		$this->assertLessThanOrEqual( gmdate( 'Y-m-d H:i:s' ), get_post_time( 'Y-m-d H:i:s', false, $post ) );
+	}
+	/**
+	 * @ticket 31635
+	 */
+	public function test_bulk_edit_posts_should_publish_draft_immediately() {
+		wp_set_current_user( self::$admin_id );
+
+		// Create draft last edited a month ago
+		$post = self::factory()->post->create(
+			array(
+				'post_author'    => self::$author_ids[0],
+				'comment_status' => 'closed',
+				'ping_status'    => 'closed',
+				'post_status'    => 'draft',
+				'post_date'      => gmdate( 'Y-m-d H:i:s', strtotime( '-1 month' ) ),
+			)
+		);
+
+		$request = array(
+			'post_type'      => 'post',
+			'post_author'    => -1,
+			'ping_status'    => -1,
+			'comment_status' => -1,
+			'_status'        => 'publish',
+			'post'           => array( $post ),
+		);
+
+		bulk_edit_posts( $request );
+
+		$this->assertSame( 'publish', get_post_status( $post ) );
+
+		// Expect to be published within the last minute (to consider slow testing environment).
+		$minute_before = gmdate( 'Y-m-d H:i:s', strtotime( '-1 minute' ) );
+		$this->assertGreaterThanOrEqual( $minute_before, get_post_time( 'Y-m-d H:i:s', false, $post ) );
+		$this->assertLessThanOrEqual( gmdate( 'Y-m-d H:i:s' ), get_post_time( 'Y-m-d H:i:s', false, $post ) );
+	}
+
 	/**
 	 * @ticket 41396
 	 */
@@ -318,6 +384,31 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * Tests that `bulk_edit_posts()` fires the 'bulk_edit_posts' action.
+	 *
+	 * @ticket 28112
+	 *
+	 * @covers ::bulk_edit_posts
+	 */
+	public function test_bulk_edit_posts_should_fire_bulk_edit_posts_action() {
+		wp_set_current_user( self::$admin_id );
+
+		$action = new MockAction();
+		add_action( 'bulk_edit_posts', array( $action, 'action' ) );
+
+		bulk_edit_posts(
+			array(
+				'post'      => self::$post_id,
+				'post_type' => 'post',
+				'_status'   => 1,
+
+			)
+		);
+
+		$this->assertSame( 1, $action->get_call_count() );
+	}
+
 	/**
 	 * @ticket 38293
 	 */
@@ -704,7 +795,7 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 
 		add_filter(
 			'get_sample_permalink',
-			function( $permalink, $post_id, $title, $name, $post ) use ( $post_original ) {
+			function ( $permalink, $post_id, $title, $name, $post ) use ( $post_original ) {
 				$this->assertEquals( $post_original, $post, 'Modified post object passed to get_sample_permalink filter.' );
 				return $permalink;
 			},
@@ -826,6 +917,8 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 			'category'        => 'common',
 			'render_callback' => 'foo',
 			'ancestor'        => array( 'core/test-ancestor' ),
+			'selectors'       => array( 'root' => '.wp-block-test' ),
+			'block_hooks'     => array( 'core/post-content' => 'before' ),
 		);
 
 		register_block_type( $name, $settings );
@@ -845,6 +938,8 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 					'lock' => array( 'type' => 'object' ),
 				),
 				'usesContext' => array(),
+				'blockHooks'  => array( 'core/post-content' => 'before' ),
+				'selectors'   => array( 'root' => '.wp-block-test' ),
 				'category'    => 'common',
 				'styles'      => array(),
 				'ancestor'    => array( 'core/test-ancestor' ),
diff --git a/tests/admin/includesSchema.php b/tests/admin/includesSchema.php
index f33dff148b..77b3e06a53 100644
--- a/tests/admin/includesSchema.php
+++ b/tests/admin/includesSchema.php
@@ -192,7 +192,7 @@ class Tests_Admin_IncludesSchema extends WP_UnitTestCase {
 		// Set the "default" value for the timezone to a deprecated timezone.
 		add_filter(
 			'gettext_with_context',
-			static function( $translation, $text, $context ) {
+			static function ( $translation, $text, $context ) {
 				if ( '0' === $text && 'default GMT offset or timezone string' === $context ) {
 					return 'America/Buenos_Aires';
 				}
diff --git a/tests/admin/includesTemplate.php b/tests/admin/includesTemplate.php
index ca769eb8b7..92f1380ff0 100644
--- a/tests/admin/includesTemplate.php
+++ b/tests/admin/includesTemplate.php
@@ -287,5 +287,4 @@ class Tests_Admin_IncludesTemplate extends WP_UnitTestCase {
 		// This doesn't actually get removed due to the invalid priority.
 		remove_meta_box( 'dashboard2', 'dashboard', 'normal' );
 	}
-
 }
diff --git a/tests/admin/wpAutomaticUpdater.php b/tests/admin/wpAutomaticUpdater.php
index 91ceaa1b38..9eed08e850 100644
--- a/tests/admin/wpAutomaticUpdater.php
+++ b/tests/admin/wpAutomaticUpdater.php
@@ -54,7 +54,7 @@ class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
 	public function test_send_plugin_theme_email_should_append_plugin_urls( $urls, $successful, $failed ) {
 		add_filter(
 			'wp_mail',
-			function( $args ) use ( $urls ) {
+			function ( $args ) use ( $urls ) {
 				foreach ( $urls as $url ) {
 					$this->assertStringContainsString(
 						$url,
@@ -322,7 +322,7 @@ class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
 	public function test_send_plugin_theme_email_should_not_append_plugin_urls( $urls, $successful, $failed ) {
 		add_filter(
 			'wp_mail',
-			function( $args ) use ( $urls ) {
+			function ( $args ) use ( $urls ) {
 				foreach ( $urls as $url ) {
 					$this->assertStringNotContainsString(
 						$url,
@@ -610,7 +610,7 @@ class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
 
 		$open_basedir_backup = ini_get( 'open_basedir' );
 		// Allow access to the directory one level above the repository.
-		ini_set( 'open_basedir', wp_normalize_path( $abspath_grandparent ) );
+		ini_set( 'open_basedir', sys_get_temp_dir() . PATH_SEPARATOR . wp_normalize_path( $abspath_grandparent ) );
 
 		// Checking an allowed directory should succeed.
 		$actual = self::$updater->is_allowed_dir( wp_normalize_path( ABSPATH ) );
@@ -645,7 +645,7 @@ class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
 
 		$open_basedir_backup = ini_get( 'open_basedir' );
 		// Allow access to the directory one level above the repository.
-		ini_set( 'open_basedir', wp_normalize_path( $abspath_grandparent ) );
+		ini_set( 'open_basedir', sys_get_temp_dir() . PATH_SEPARATOR . wp_normalize_path( $abspath_grandparent ) );
 
 		// Checking a directory not within the allowed path should trigger an `open_basedir` warning.
 		$actual = self::$updater->is_allowed_dir( '/.git' );
@@ -706,4 +706,28 @@ class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
 			'string with only carriage returns' => array( 'dir' => "\r\r" ),
 		);
 	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::is_vcs_checkout()` returns `false`
+	 * when none of the checked directories are allowed.
+	 *
+	 * @ticket 58563
+	 *
+	 * @covers WP_Automatic_Updater::is_vcs_checkout
+	 */
+	public function test_is_vcs_checkout_should_return_false_when_no_directories_are_allowed() {
+		$updater_mock = $this->getMockBuilder( 'WP_Automatic_Updater' )
+			// Note: setMethods() is deprecated in PHPUnit 9, but still supported.
+			->setMethods( array( 'is_allowed_dir' ) )
+			->getMock();
+
+		/*
+		 * As none of the directories should be allowed, simply mocking `WP_Automatic_Updater`
+		 * and forcing `::is_allowed_dir()` to return `false` removes the need to run the test
+		 * in a separate process due to setting the `open_basedir` PHP directive.
+		 */
+		$updater_mock->expects( $this->any() )->method( 'is_allowed_dir' )->willReturn( false );
+
+		$this->assertFalse( $updater_mock->is_vcs_checkout( get_temp_dir() ) );
+	}
 }
diff --git a/tests/admin/wpCommentsListTable.php b/tests/admin/wpCommentsListTable.php
index a394823d37..8ba12eed0e 100644
--- a/tests/admin/wpCommentsListTable.php
+++ b/tests/admin/wpCommentsListTable.php
@@ -96,7 +96,7 @@ class Tests_Admin_wpCommentsListTable extends WP_UnitTestCase {
 	public function test_bulk_action_menu_supports_options_and_optgroups() {
 		add_filter(
 			'bulk_actions-edit-comments',
-			static function() {
+			static function () {
 				return array(
 					'delete'       => 'Delete',
 					'Change State' => array(
@@ -213,5 +213,4 @@ OPTIONS;
 		);
 		$this->assertSame( $expected, $this->table->get_views() );
 	}
-
 }
diff --git a/tests/admin/wpListTable.php b/tests/admin/wpListTable.php
index c28113d99f..65a9a714c7 100644
--- a/tests/admin/wpListTable.php
+++ b/tests/admin/wpListTable.php
@@ -12,17 +12,34 @@ class Tests_Admin_WpListTable extends WP_UnitTestCase {
 	 *
 	 * @var WP_List_Table $list_table
 	 */
-	protected static $list_table;
+	private $list_table;
 
-	public static function set_up_before_class() {
-		global $hook_suffix;
+	/**
+	 * Original value of $GLOBALS['hook_suffix'].
+	 *
+	 * @var string
+	 */
+	private static $original_hook_suffix;
 
+	public static function set_up_before_class() {
 		parent::set_up_before_class();
 
+		static::$original_hook_suffix = $GLOBALS['hook_suffix'];
+
 		require_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php';
+	}
 
+	public function set_up() {
+		parent::set_up();
+		global $hook_suffix;
 		$hook_suffix      = '_wp_tests';
-		self::$list_table = new WP_List_Table();
+		$this->list_table = new WP_List_Table();
+	}
+
+	public function clean_up_global_scope() {
+		global $hook_suffix;
+		$hook_suffix = static::$original_hook_suffix;
+		parent::clean_up_global_scope();
 	}
 
 	/**
@@ -142,10 +159,10 @@ class Tests_Admin_WpListTable extends WP_UnitTestCase {
 	 * @param array $expected
 	 */
 	public function test_get_views_links( $link_data, $expected ) {
-		$get_views_links = new ReflectionMethod( self::$list_table, 'get_views_links' );
+		$get_views_links = new ReflectionMethod( $this->list_table, 'get_views_links' );
 		$get_views_links->setAccessible( true );
 
-		$actual = $get_views_links->invokeArgs( self::$list_table, array( $link_data ) );
+		$actual = $get_views_links->invokeArgs( $this->list_table, array( $link_data ) );
 
 		$this->assertSameSetsWithIndex( $expected, $actual );
 	}
@@ -257,9 +274,9 @@ class Tests_Admin_WpListTable extends WP_UnitTestCase {
 	 * }
 	 */
 	public function test_get_views_links_doing_it_wrong( $link_data ) {
-		$get_views_links = new ReflectionMethod( self::$list_table, 'get_views_links' );
+		$get_views_links = new ReflectionMethod( $this->list_table, 'get_views_links' );
 		$get_views_links->setAccessible( true );
-		$get_views_links->invokeArgs( self::$list_table, array( $link_data ) );
+		$get_views_links->invokeArgs( $this->list_table, array( $link_data ) );
 	}
 
 	/**
@@ -344,4 +361,164 @@ class Tests_Admin_WpListTable extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__get()
+	 *
+	 * @param string $property_name Property name to get.
+	 * @param mixed $expected       Expected value.
+	 */
+	public function test_should_get_compat_fields( $property_name, $expected ) {
+		$list_table = new WP_List_Table( array( 'plural' => '_wp_tests__get' ) );
+
+		if ( 'screen' === $property_name ) {
+			$this->assertInstanceOf( $expected, $list_table->$property_name );
+		} else {
+			$this->assertSame( $expected, $list_table->$property_name );
+		}
+	}
+
+	/**
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__get()
+	 */
+	public function test_should_throw_deprecation_when_getting_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_List_Table::__get(): ' .
+			'The property `undeclared_property` is not declared. Getting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->assertNull( $this->list_table->undeclared_property, 'Getting a dynamic property should return null from WP_List_Table::__get()' );
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__set()
+	 *
+	 * @param string $property_name Property name to set.
+	 */
+	public function test_should_set_compat_fields_defined_property( $property_name ) {
+		$value                            = uniqid();
+		$this->list_table->$property_name = $value;
+
+		$this->assertSame( $value, $this->list_table->$property_name );
+	}
+
+	/**
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__set()
+	 */
+	public function test_should_throw_deprecation_when_setting_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_List_Table::__set(): ' .
+			'The property `undeclared_property` is not declared. Setting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->list_table->undeclared_property = 'some value';
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__isset()
+	 *
+	 * @param string $property_name Property name to check.
+	 * @param mixed $expected       Expected value.
+	 */
+	public function test_should_isset_compat_fields( $property_name, $expected ) {
+		$actual = isset( $this->list_table->$property_name );
+		if ( is_null( $expected ) ) {
+			$this->assertFalse( $actual );
+		} else {
+			$this->assertTrue( $actual );
+		}
+	}
+
+	/**
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__isset()
+	 */
+	public function test_should_throw_deprecation_when_isset_of_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_List_Table::__isset(): ' .
+			'The property `undeclared_property` is not declared. Checking `isset()` on a dynamic property ' .
+			'is deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->assertFalse( isset( $this->list_table->undeclared_property ), 'Checking a dynamic property should return false from WP_List_Table::__isset()' );
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__unset()
+	 *
+	 * @param string $property_name Property name to unset.
+	 */
+	public function test_should_unset_compat_fields_defined_property( $property_name ) {
+		unset( $this->list_table->$property_name );
+		$this->assertFalse( isset( $this->list_table->$property_name ) );
+	}
+
+	/**
+	 * @ticket 58896
+	 *
+	 * @covers WP_List_Table::__unset()
+	 */
+	public function test_should_throw_deprecation_when_unset_of_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_List_Table::__unset(): ' .
+			'A property `undeclared_property` is not declared. Unsetting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		unset( $this->list_table->undeclared_property );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_compat_fields() {
+		return array(
+			'_args'            => array(
+				'property_name' => '_args',
+				'expected'      => array(
+					'plural'   => '_wp_tests__get',
+					'singular' => '',
+					'ajax'     => false,
+					'screen'   => null,
+				),
+			),
+			'_pagination_args' => array(
+				'property_name' => '_pagination_args',
+				'expected'      => array(),
+			),
+			'screen'           => array(
+				'property_name' => 'screen',
+				'expected'      => WP_Screen::class,
+			),
+			'_actions'         => array(
+				'property_name' => '_actions',
+				'expected'      => null,
+			),
+			'_pagination'      => array(
+				'property_name' => '_pagination',
+				'expected'      => null,
+			),
+		);
+	}
 }
diff --git a/tests/admin/wpMediaListTable.php b/tests/admin/wpMediaListTable.php
index a130a32506..aae2f3862a 100644
--- a/tests/admin/wpMediaListTable.php
+++ b/tests/admin/wpMediaListTable.php
@@ -4,11 +4,109 @@
  * @group admin
  */
 class Tests_Admin_wpMediaListTable extends WP_UnitTestCase {
+	/**
+	 * A list table for testing.
+	 *
+	 * @var WP_Media_List_Table
+	 */
+	protected static $list_table;
+
+	/**
+	 * A reflection of the `$is_trash` property.
+	 *
+	 * @var ReflectionProperty
+	 */
+	protected static $is_trash;
+
+	/**
+	 * The original value of the `$is_trash` property.
+	 *
+	 * @var bool|null
+	 */
+	protected static $is_trash_original;
+
+	/**
+	 * A reflection of the `$detached` property.
+	 *
+	 * @var ReflectionProperty
+	 */
+	protected static $detached;
+
+	/**
+	 * The original value of the `$detached` property.
+	 *
+	 * @var bool|null
+	 */
+	protected static $detached_original;
+
+	/**
+	 * The ID of an 'administrator' user for testing.
+	 *
+	 * @var int
+	 */
+	protected static $admin;
+
+	/**
+	 * The ID of a 'subscriber' user for testing.
+	 *
+	 * @var int
+	 */
+	protected static $subscriber;
+
+	/**
+	 * A post for testing.
+	 *
+	 * @var WP_Post
+	 */
+	protected static $post;
+
+	/**
+	 * An attachment for testing.
+	 *
+	 * @var WP_Post
+	 */
+	protected static $attachment;
 
 	public static function set_up_before_class() {
 		parent::set_up_before_class();
 
 		require_once ABSPATH . 'wp-admin/includes/class-wp-media-list-table.php';
+
+		self::$list_table = new WP_Media_List_Table();
+		self::$is_trash   = new ReflectionProperty( self::$list_table, 'is_trash' );
+		self::$detached   = new ReflectionProperty( self::$list_table, 'detached' );
+
+		self::$is_trash->setAccessible( true );
+		self::$is_trash_original = self::$is_trash->getValue( self::$list_table );
+		self::$is_trash->setAccessible( false );
+
+		self::$detached->setAccessible( true );
+		self::$detached_original = self::$detached->getValue( self::$list_table );
+		self::$detached->setAccessible( false );
+
+		// Create users.
+		self::$admin      = self::factory()->user->create( array( 'role' => 'administrator' ) );
+		self::$subscriber = self::factory()->user->create( array( 'role' => 'subscriber' ) );
+
+		// Create posts.
+		self::$post       = self::factory()->post->create_and_get();
+		self::$attachment = self::factory()->attachment->create_and_get(
+			array(
+				'post_name'      => 'attachment-name',
+				'file'           => 'image.jpg',
+				'post_mime_type' => 'image/jpeg',
+			)
+		);
+	}
+
+	/**
+	 * Restores reflections to their original values.
+	 */
+	public function tear_down() {
+		self::set_is_trash( self::$is_trash_original );
+		self::set_detached( self::$detached_original );
+
+		parent::tear_down();
 	}
 
 	/**
@@ -16,7 +114,7 @@ class Tests_Admin_wpMediaListTable extends WP_UnitTestCase {
 	 * does not result in a PHP warning.
 	 *
 	 * The warning that we should not see:
-	 * PHP 5.6 - 7.4: `Invalid argument supplied for foreach()`.
+	 * PHP <= 7.4: `Invalid argument supplied for foreach()`.
 	 * PHP 8.0 and higher: `Warning: foreach() argument must be of type array|object, bool given`.
 	 *
 	 * Note: This does not test the actual functioning of the WP_Media_List_Table::prepare_items() method.
@@ -49,4 +147,325 @@ class Tests_Admin_wpMediaListTable extends WP_UnitTestCase {
 		// If this test does not error out due to the PHP warning, we're good.
 		$mock->prepare_items();
 	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` only includes an action
+	 * in certain scenarios.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 *
+	 * @dataProvider data_get_row_actions_should_include_action
+	 *
+	 * @param string    $action   The action that should be included.
+	 * @param string    $role     The role of the current user.
+	 * @param bool|null $trash    Whether the attachment filter is currently 'trash',
+	 *                            or `null` to leave as-is.
+	 * @param bool|null $detached Whether the attachment filter is currently 'detached',
+	 *                            or `null` to leave as-is.
+	 */
+	public function test_get_row_actions_should_include_action( $action, $role, $trash, $detached ) {
+		if ( 'admin' === $role ) {
+			wp_set_current_user( self::$admin );
+		} elseif ( 'subscriber' === $role ) {
+			wp_set_current_user( self::$subscriber );
+		}
+
+		if ( null !== $trash ) {
+			self::set_is_trash( $trash );
+		}
+
+		if ( null !== $detached ) {
+			self::set_detached( $detached );
+		}
+
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$post, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayHasKey( $action, $actions, "'$action' was not included in the actions." );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_row_actions_should_include_action() {
+		return array(
+			'"edit" while not on "trash"'  => array(
+				'action'   => 'edit',
+				'role'     => 'admin',
+				'trash'    => false,
+				'detached' => null,
+			),
+			'"untrash" while on "trash"'   => array(
+				'action'   => 'untrash',
+				'role'     => 'admin',
+				'trash'    => true,
+				'detached' => null,
+			),
+			'"delete" while on "trash"'    => array(
+				'action'   => 'delete',
+				'role'     => 'admin',
+				'trash'    => true,
+				'detached' => null,
+			),
+			'"view" while not on "trash"'  => array(
+				'action'   => 'view',
+				'role'     => 'admin',
+				'trash'    => false,
+				'detached' => null,
+			),
+			'"attach" while on "detached"' => array(
+				'action'   => 'attach',
+				'role'     => 'admin',
+				'trash'    => null,
+				'detached' => true,
+			),
+		);
+	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` does not include an action
+	 * in certain scenarios.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 *
+	 * @dataProvider data_get_row_actions_should_not_include_action
+	 *
+	 * @param string    $action   The action that should not be included.
+	 * @param string    $role     The role of the current user.
+	 * @param bool|null $trash    Whether the attachment filter is currently 'trash',
+	 *                            or `null` to leave as-is.
+	 * @param bool|null $detached Whether the attachment filter is currently 'detached',
+	 *                            or `null` to leave as-is.
+	 */
+	public function test_get_row_actions_should_not_include_action( $action, $role, $trash, $detached ) {
+		if ( 'admin' === $role ) {
+			wp_set_current_user( self::$admin );
+		} elseif ( 'subscriber' === $role ) {
+			wp_set_current_user( self::$subscriber );
+		}
+
+		if ( null !== $trash ) {
+			self::set_is_trash( $trash );
+		}
+
+		if ( null !== $detached ) {
+			self::set_detached( $detached );
+		}
+
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$post, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayNotHasKey( $action, $actions, "'$action' was included in the actions." );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_row_actions_should_not_include_action() {
+		return array(
+			'"edit" while on "trash"'               => array(
+				'action'   => 'edit',
+				'role'     => 'admin',
+				'trash'    => true,
+				'detached' => null,
+			),
+			'"edit" with incorrect capabilities'    => array(
+				'action'   => 'edit',
+				'role'     => 'subscriber',
+				'trash'    => false,
+				'detached' => null,
+			),
+			'"untrash" while not on "trash"'        => array(
+				'action'   => 'untrash',
+				'role'     => 'administrator',
+				'trash'    => false,
+				'detached' => null,
+			),
+			'"untrash" with incorrect capabilities' => array(
+				'action'   => 'untrash',
+				'role'     => 'subscriber',
+				'trash'    => true,
+				'detached' => null,
+			),
+			'"trash" while not on "trash"'          => array(
+				'action'   => 'trash',
+				'role'     => 'administrator',
+				'trash'    => false,
+				'detached' => null,
+			),
+			'"trash" with incorrect capabilities'   => array(
+				'action'   => 'trash',
+				'role'     => 'subscriber',
+				'trash'    => true,
+				'detached' => null,
+			),
+			'"view" while on "trash"'               => array(
+				'action'   => 'view',
+				'role'     => 'administrator',
+				'trash'    => true,
+				'detached' => null,
+			),
+			'"attach" with incorrect capabilities'  => array(
+				'action'   => 'attach',
+				'role'     => 'subscriber',
+				'trash'    => null,
+				'detached' => true,
+			),
+			'"attach" when not on "detached"'       => array(
+				'action'   => 'attach',
+				'role'     => 'administrator',
+				'trash'    => null,
+				'detached' => false,
+			),
+			'"copy" when on "trash"'                => array(
+				'action'   => 'copy',
+				'role'     => 'administrator',
+				'trash'    => true,
+				'detached' => null,
+			),
+		);
+	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` does not include the 'view' action
+	 * when a permalink is not available.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 */
+	public function test_get_row_actions_should_not_include_view_without_a_permalink() {
+		self::set_is_trash( false );
+
+		// Ensure the permalink is `false`.
+		add_filter( 'post_link', '__return_false', 10, 0 );
+
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$post, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayNotHasKey( 'view', $actions, '"view" was included in the actions.' );
+	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` includes the 'copy' action.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 */
+	public function test_get_row_actions_should_include_copy() {
+		self::set_is_trash( false );
+
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$attachment, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayHasKey( 'copy', $actions, '"copy" was not included in the actions.' );
+	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` does not include the 'copy' action
+	 * when an attachment URL is not available.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 */
+	public function test_get_row_actions_should_not_include_copy_without_an_attachment_url() {
+		self::set_is_trash( false );
+
+		// Ensure the attachment URL is `false`.
+		add_filter( 'wp_get_attachment_url', '__return_false', 10, 0 );
+
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$attachment, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayNotHasKey( 'copy', $actions, '"copy" was included in the actions.' );
+	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` includes the 'download' action.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 */
+	public function test_get_row_actions_should_include_download() {
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$attachment, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayHasKey( 'download', $actions, '"download" was not included in the actions.' );
+	}
+
+	/**
+	 * Tests that `WP_Media_List_Table::_get_row_actions()` does not include the 'download' action
+	 * when an attachment URL is not available.
+	 *
+	 * @ticket 57893
+	 *
+	 * @covers WP_Media_List_Table::_get_row_actions
+	 */
+	public function test_get_row_actions_should_not_include_download_without_an_attachment_url() {
+		// Ensure the attachment URL is `false`.
+		add_filter( 'wp_get_attachment_url', '__return_false', 10, 0 );
+
+		$_get_row_actions = new ReflectionMethod( self::$list_table, '_get_row_actions' );
+		$_get_row_actions->setAccessible( true );
+		$actions = $_get_row_actions->invoke( self::$list_table, self::$attachment, 'att_title' );
+		$_get_row_actions->setAccessible( false );
+
+		$this->assertIsArray( $actions, 'An array was not returned.' );
+		$this->assertArrayNotHasKey( 'download', $actions, '"download" was included in the actions.' );
+	}
+
+	/**
+	 * Sets the `$is_trash` property.
+	 *
+	 * Helper method.
+	 *
+	 * @param bool $is_trash Whether the attachment filter is currently 'trash'.
+	 */
+	private static function set_is_trash( $is_trash ) {
+		self::$is_trash->setAccessible( true );
+		self::$is_trash->setValue( self::$list_table, $is_trash );
+		self::$is_trash->setAccessible( false );
+	}
+
+	/**
+	 * Sets the `$detached` property.
+	 *
+	 * Helper method.
+	 *
+	 * @param bool $detached Whether the attachment filter is currently 'detached'.
+	 */
+	private static function set_detached( $detached ) {
+		self::$detached->setAccessible( true );
+		self::$detached->setValue( self::$list_table, $detached );
+		self::$detached->setAccessible( false );
+	}
 }
diff --git a/tests/admin/wpPluginsListTable.php b/tests/admin/wpPluginsListTable.php
index f97059d475..af44861324 100644
--- a/tests/admin/wpPluginsListTable.php
+++ b/tests/admin/wpPluginsListTable.php
@@ -11,11 +11,74 @@ class Tests_Admin_wpPluginsListTable extends WP_UnitTestCase {
 	 */
 	public $table = false;
 
+	/**
+	 * An admin user ID.
+	 *
+	 * @var int
+	 */
+	private static $admin_id;
+
+	/**
+	 * The original value of the `$s` global.
+	 *
+	 * @var string|null
+	 */
+	private static $original_s;
+
+	/**
+	 * @var array
+	 */
+	public $fake_plugin = array(
+		'fake-plugin.php' => array(
+			'Name'        => 'Fake Plugin',
+			'PluginURI'   => 'https://wordpress.org/',
+			'Version'     => '1.0.0',
+			'Description' => 'A fake plugin for testing.',
+			'Author'      => 'WordPress',
+			'AuthorURI'   => 'https://wordpress.org/',
+			'TextDomain'  => 'fake-plugin',
+			'DomainPath'  => '/languages',
+			'Network'     => false,
+			'Title'       => 'Fake Plugin',
+			'AuthorName'  => 'WordPress',
+		),
+	);
+
+	/**
+	 * Creates an admin user before any tests run and backs up the `$s` global.
+	 */
+	public static function set_up_before_class() {
+		global $s;
+
+		parent::set_up_before_class();
+
+		self::$admin_id   = self::factory()->user->create(
+			array(
+				'role'       => 'administrator',
+				'user_login' => 'test_wp_plugins_list_table',
+				'user_pass'  => 'password',
+				'user_email' => 'testadmin@test.com',
+			)
+		);
+		self::$original_s = $s;
+	}
+
 	public function set_up() {
 		parent::set_up();
 		$this->table = _get_list_table( 'WP_Plugins_List_Table', array( 'screen' => 'plugins' ) );
 	}
 
+	/**
+	 * Restores the `$s` global after each test.
+	 */
+	public function tear_down() {
+		global $s;
+
+		$s = self::$original_s;
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 42066
 	 *
@@ -56,4 +119,218 @@ class Tests_Admin_wpPluginsListTable extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, $actual );
 	}
+
+	/**
+	 * Tests that WP_Plugins_List_Table::__construct() does not set
+	 * the 'show_autoupdates' property to false for Must-Use and Drop-in
+	 * plugins.
+	 *
+	 * The 'ms-excluded' group is added as $this->show_autoupdates is already set to false for multisite.
+	 *
+	 * @ticket 54309
+	 * @group ms-excluded
+	 *
+	 * @covers WP_Plugins_List_Table::__construct()
+	 *
+	 * @dataProvider data_status_mustuse_and_dropins
+	 *
+	 * @param string $status The value for $_REQUEST['plugin_status'].
+	 */
+	public function test_construct_should_not_set_show_autoupdates_to_false_for_mustuse_and_dropins( $status ) {
+		$original_status           = isset( $_REQUEST['plugin_status'] ) ? $_REQUEST['plugin_status'] : null;
+		$_REQUEST['plugin_status'] = $status;
+
+		// Enable plugin auto-updates.
+		add_filter( 'plugins_auto_update_enabled', '__return_true' );
+
+		// Use a user with the 'manage_plugins' capability.
+		wp_set_current_user( self::$admin_id );
+
+		$list_table       = new WP_Plugins_List_Table();
+		$show_autoupdates = new ReflectionProperty( $list_table, 'show_autoupdates' );
+
+		$show_autoupdates->setAccessible( true );
+		$actual = $show_autoupdates->getValue( $list_table );
+		$show_autoupdates->setAccessible( false );
+
+		$_REQUEST['plugin_status'] = $original_status;
+
+		$this->assertTrue( $actual );
+	}
+
+	/**
+	 * Tests that WP_Plugins_List_Table::get_columns() does not add
+	 * the auto-update column when not viewing Must-Use or Drop-in plugins.
+	 *
+	 * @ticket 54309
+	 *
+	 * @covers WP_Plugins_List_Table::get_columns
+	 *
+	 * @dataProvider data_status_mustuse_and_dropins
+	 *
+	 * @param string $test_status The value for the global $status variable.
+	 */
+	public function test_get_columns_should_not_add_the_autoupdates_column_when_viewing_mustuse_or_dropins( $test_status ) {
+		global $status;
+
+		$original_status = $status;
+
+		// Enable plugin auto-updates.
+		add_filter( 'plugins_auto_update_enabled', '__return_true' );
+
+		// Use a user with the 'manage_plugins' capability.
+		wp_set_current_user( self::$admin_id );
+
+		$status = $test_status;
+		$actual = $this->table->get_columns();
+		$status = $original_status;
+
+		$this->assertArrayNotHasKey( 'auto-updates', $actual );
+	}
+
+	/**
+	 * Tests that WP_Plugins_List_Table::get_columns() does not add
+	 * the auto-update column when the 'plugins_auto_update_enabled'
+	 * filter returns false.
+	 *
+	 * @ticket 54309
+	 *
+	 * @covers WP_Plugins_List_Table::get_columns
+	 */
+	public function test_get_columns_should_not_add_the_autoupdates_column_when_plugin_auto_update_is_disabled() {
+		global $status;
+
+		$original_status = $status;
+
+		// Enable plugin auto-updates.
+		add_filter( 'plugins_auto_update_enabled', '__return_false' );
+
+		// Use a user with the 'manage_plugins' capability.
+		wp_set_current_user( self::$admin_id );
+
+		$status = 'all';
+		$actual = $this->table->get_columns();
+		$status = $original_status;
+
+		$this->assertArrayNotHasKey( 'auto-updates', $actual );
+	}
+
+	/**
+	 * Tests that WP_Plugins_List_Table::single_row() does not output the
+	 * 'Auto-updates' column for Must-Use or Drop-in plugins.
+	 *
+	 * @ticket 54309
+	 *
+	 * @covers WP_Plugins_List_Table::single_row
+	 *
+	 * @dataProvider data_status_mustuse_and_dropins
+	 *
+	 * @param string $test_status The value for the global $status variable.
+	 */
+	public function test_single_row_should_not_add_the_autoupdates_column_for_mustuse_or_dropins( $test_status ) {
+		global $status;
+
+		$original_status = $status;
+
+		// Enable plugin auto-updates.
+		add_filter( 'plugins_auto_update_enabled', '__return_true' );
+
+		// Use a user with the 'manage_plugins' capability.
+		wp_set_current_user( self::$admin_id );
+
+		$column_info = array(
+			array(
+				'name'         => 'Plugin',
+				'description'  => 'Description',
+				'auto-updates' => 'Auto-updates',
+			),
+			array(),
+			array(),
+			'name',
+		);
+
+		// Mock WP_Plugins_List_Table
+		$list_table_mock = $this->getMockBuilder( 'WP_Plugins_List_Table' )
+			// Note: setMethods() is deprecated in PHPUnit 9, but still supported.
+			->setMethods( array( 'get_column_info' ) )
+			->getMock();
+
+		// Force the return value of the get_column_info() method.
+		$list_table_mock->expects( $this->once() )->method( 'get_column_info' )->willReturn( $column_info );
+
+		$single_row_args = array(
+			'advanced-cache.php',
+			array(
+				'Name'        => 'Advanced caching plugin',
+				'slug'        => 'advanced-cache',
+				'Description' => 'An advanced caching plugin.',
+				'Author'      => 'A plugin author',
+				'Version'     => '1.0.0',
+				'Author URI'  => 'http://example.org',
+				'Text Domain' => 'advanced-cache',
+			),
+		);
+
+		$status = $test_status;
+		ob_start();
+		$list_table_mock->single_row( $single_row_args );
+		$actual = ob_get_clean();
+		$status = $original_status;
+
+		$this->assertIsString( $actual, 'Output was not captured.' );
+		$this->assertNotEmpty( $actual, 'The output string was empty.' );
+		$this->assertStringNotContainsString( 'column-auto-updates', $actual, 'The auto-updates column was output.' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_status_mustuse_and_dropins() {
+		return array(
+			'Must-Use' => array( 'mustuse' ),
+			'Drop-ins' => array( 'dropins' ),
+		);
+	}
+
+	/**
+	 * Tests that WP_Plugins_List_Table::prepare_items()
+	 * applies 'plugins_list' filters.
+	 *
+	 * @ticket 57278
+	 *
+	 * @covers WP_Plugins_List_Table::prepare_items
+	 */
+	public function test_plugins_list_filter() {
+		global $status, $s;
+
+		$old_status = $status;
+		$status     = 'mustuse';
+		$s          = '';
+
+		add_filter( 'plugins_list', array( $this, 'plugins_list_filter' ), 10, 1 );
+		$this->table->prepare_items();
+		$plugins = $this->table->items;
+		remove_filter( 'plugins_list', array( $this, 'plugins_list_filter' ), 10 );
+
+		// Restore to default.
+		$status = $old_status;
+		$this->table->prepare_items();
+
+		$this->assertSame( $plugins, $this->fake_plugin );
+	}
+
+	/**
+	 * Adds a fake plugin to an array of plugins.
+	 *
+	 * Used as a callback for the 'plugins_list' hook.
+	 *
+	 * @return array
+	 */
+	public function plugins_list_filter( $plugins_list ) {
+		$plugins_list['mustuse'] = $this->fake_plugin;
+
+		return $plugins_list;
+	}
 }
diff --git a/tests/admin/wpPostCommentsListTable.php b/tests/admin/wpPostCommentsListTable.php
index 126126327f..f69657dd87 100644
--- a/tests/admin/wpPostCommentsListTable.php
+++ b/tests/admin/wpPostCommentsListTable.php
@@ -35,5 +35,4 @@ class Tests_Admin_wpPostCommentsListTable extends WP_UnitTestCase {
 		);
 		$this->assertSame( $expected, $this->table->get_views() );
 	}
-
 }
diff --git a/tests/admin/wpPostsListTable.php b/tests/admin/wpPostsListTable.php
index c2dd5f586a..9d2482a034 100644
--- a/tests/admin/wpPostsListTable.php
+++ b/tests/admin/wpPostsListTable.php
@@ -203,16 +203,6 @@ class Tests_Admin_wpPostsListTable extends WP_UnitTestCase {
 	 * @param array $expected_ids Expected IDs of pages returned.
 	 */
 	protected function _test_list_hierarchical_page( array $args, array $expected_ids ) {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$matches = array();
 
 		$_REQUEST['paged']   = $args['paged'];
@@ -340,5 +330,4 @@ class Tests_Admin_wpPostsListTable extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, $actual );
 	}
-
 }
diff --git a/tests/admin/wpSiteHealth.php b/tests/admin/wpSiteHealth.php
index 62697c576c..f8b2e2e0c8 100644
--- a/tests/admin/wpSiteHealth.php
+++ b/tests/admin/wpSiteHealth.php
@@ -421,7 +421,7 @@ class Tests_Admin_wpSiteHealth extends WP_UnitTestCase {
 		// Set thresholds so high they should never be exceeded.
 		add_filter(
 			'site_status_persistent_object_cache_thresholds',
-			function() {
+			static function () {
 				return array(
 					'alloptions_count' => PHP_INT_MAX,
 					'alloptions_bytes' => PHP_INT_MAX,
@@ -472,7 +472,7 @@ class Tests_Admin_wpSiteHealth extends WP_UnitTestCase {
 	public function test_object_cache_thresholds( $threshold, $count ) {
 		add_filter(
 			'site_status_persistent_object_cache_thresholds',
-			function ( $thresholds ) use ( $threshold, $count ) {
+			static function ( $thresholds ) use ( $threshold, $count ) {
 				return array_merge( $thresholds, array( $threshold => $count ) );
 			}
 		);
diff --git a/tests/admin/wpTermsListTable.php b/tests/admin/wpTermsListTable.php
new file mode 100644
index 0000000000..c16d9188cd
--- /dev/null
+++ b/tests/admin/wpTermsListTable.php
@@ -0,0 +1,88 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_Terms_List_Table
+ */
+class Tests_Admin_WpTermsListTable extends WP_UnitTestCase {
+
+	/**
+	 * List table.
+	 *
+	 * @var WP_Terms_List_Table $terms_list_table
+	 */
+	private $terms_list_table;
+
+	private static $admin_id;
+	private static $author_id;
+	private static $term_object;
+
+	const CATEGORY_TAXONOMY = 'category';
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		self::$admin_id  = self::factory()->user->create( array( 'role' => 'administrator' ) );
+		self::$author_id = self::factory()->user->create( array( 'role' => 'author' ) );
+
+		self::$term_object = self::factory()->term->create_and_get( array( 'taxonomy' => self::CATEGORY_TAXONOMY ) );
+
+		require_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php';
+		require_once ABSPATH . 'wp-admin/includes/class-wp-terms-list-table.php';
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		$this->terms_list_table = new WP_Terms_List_Table();
+	}
+
+	/**
+	 * Call an inaccessible (private or protected) method.
+	 *
+	 * @param object|string $instance    Object instance or class string to call the method of.
+	 * @param string        $method_name Name of the method to call.
+	 * @param array         $args        Optional. Array of arguments to pass to the method.
+	 * @return mixed Return value of the method call.
+	 * @throws ReflectionException If the object could not be reflected upon.
+	 */
+	private function call_inaccessible_method( $instance, $method_name, $args = array() ) {
+		$method = ( new ReflectionClass( $instance ) )->getMethod( $method_name );
+		$method->setAccessible( true );
+		return $method->invokeArgs( $instance, $args );
+	}
+
+	/**
+	 * @covers WP_Terms_List_Table::handle_row_actions()
+	 *
+	 * @ticket 59336
+	 */
+	public function test_handle_row_actions_as_author() {
+		wp_set_current_user( self::$author_id );
+
+		$actions = $this->call_inaccessible_method( $this->terms_list_table, 'handle_row_actions', array( self::$term_object, 'title', 'title' ) );
+
+		$this->assertStringContainsString( '<div class="row-actions">', $actions, 'Row actions should be displayed.' );
+		$this->assertStringContainsString( 'View', $actions, 'View action should be displayed to the author.' );
+		$this->assertStringNotContainsString( 'Edit', $actions, 'Edit action should not be displayed to the author.' );
+		$this->assertStringNotContainsString( 'Delete', $actions, 'Delete action should not be displayed to the author.' );
+	}
+
+	/**
+	 * @covers WP_Terms_List_Table::handle_row_actions()
+	 *
+	 * @ticket 59336
+	 */
+	public function test_handle_row_actions_as_admin() {
+		wp_set_current_user( self::$admin_id );
+
+		$actions = $this->call_inaccessible_method( $this->terms_list_table, 'handle_row_actions', array( self::$term_object, 'title', 'title' ) );
+
+		$this->assertStringContainsString( '<div class="row-actions">', $actions, 'Row actions should be displayed.' );
+		$this->assertStringContainsString( 'View', $actions, 'View action should be displayed to the admin.' );
+		$this->assertStringContainsString( 'Edit', $actions, 'Edit action should be displayed to the admin.' );
+		$this->assertStringContainsString( 'Delete', $actions, 'Delete action should be displayed to the admin.' );
+		$this->assertStringContainsString( admin_url( 'term.php' ), $actions, 'Edit term link should be displayed to the admin.' );
+	}
+}
diff --git a/tests/admin/wpUserSearch.php b/tests/admin/wpUserSearch.php
new file mode 100644
index 0000000000..e24b4d0c6a
--- /dev/null
+++ b/tests/admin/wpUserSearch.php
@@ -0,0 +1,14 @@
+<?php
+/**
+ * @coversDefaultClass WP_User_Search
+ */
+class Tests_Admin_wpUserSearch extends WP_UnitTestCase {
+
+	/**
+	 * @covers ::__construct()
+	 * @expectedDeprecated WP_User_Search
+	 */
+	public function test_class_is_deprecated() {
+		$wp_user_search = new WP_User_Search();
+	}
+}
diff --git a/tests/adminbar.php b/tests/adminbar.php
index aa8043e7ec..4ca3f64d0d 100644
--- a/tests/adminbar.php
+++ b/tests/adminbar.php
@@ -469,7 +469,7 @@ class Tests_AdminBar extends WP_UnitTestCase {
 	 * @group ms-required
 	 */
 	public function test_admin_bar_contains_correct_about_link_for_users_with_no_role_in_multisite() {
-		// User is not a member of a site.
+		// User is not a member of the site.
 		remove_user_from_blog( self::$no_role_id, get_current_blog_id() );
 
 		wp_set_current_user( self::$no_role_id );
@@ -484,6 +484,61 @@ class Tests_AdminBar extends WP_UnitTestCase {
 		$this->assertNotNull( $about_node );
 	}
 
+	/**
+	 * Tests that the 'contribute' node is added for users with a role in single site.
+	 *
+	 * @ticket 23348
+	 *
+	 * @group ms-excluded
+	 *
+	 * @covers ::wp_admin_bar_wp_menu
+	 */
+	public function test_admin_bar_contains_contribute_node_for_users_with_role() {
+		wp_set_current_user( self::$editor_id );
+
+		$wp_admin_bar = $this->get_standard_admin_bar();
+
+		$this->assertNotNull( $wp_admin_bar->get_node( 'contribute' ) );
+	}
+
+	/**
+	 * Tests that the 'contribute' node is not added for users with no role in single site.
+	 *
+	 * @ticket 23348
+	 *
+	 * @group ms-excluded
+	 *
+	 * @covers ::wp_admin_bar_wp_menu
+	 */
+	public function test_admin_bar_does_not_contain_contribute_node_for_users_with_no_role() {
+		wp_set_current_user( self::$no_role_id );
+
+		$wp_admin_bar = $this->get_standard_admin_bar();
+
+		$this->assertNull( $wp_admin_bar->get_node( 'contribute' ) );
+	}
+
+	/**
+	 * Tests that the 'contribute' node is added for users with no role in multisite.
+	 *
+	 * @ticket 23348
+	 *
+	 * @group multisite
+	 * @group ms-required
+	 *
+	 * @covers ::wp_admin_bar_wp_menu
+	 */
+	public function test_admin_bar_contains_contribute_node_for_users_with_no_role_in_multisite() {
+		// User is not a member of the site.
+		remove_user_from_blog( self::$no_role_id, get_current_blog_id() );
+
+		wp_set_current_user( self::$no_role_id );
+
+		$wp_admin_bar = $this->get_standard_admin_bar();
+
+		$this->assertNotNull( $wp_admin_bar->get_node( 'contribute' ) );
+	}
+
 	/**
 	 * @ticket 34113
 	 */
diff --git a/tests/ajax/wpAjaxAddTag.php b/tests/ajax/wpAjaxAddTag.php
index 6060b1db64..fbb65ff6ae 100755
--- a/tests/ajax/wpAjaxAddTag.php
+++ b/tests/ajax/wpAjaxAddTag.php
@@ -74,7 +74,7 @@ class Tests_Ajax_wpAjaxAddTag extends WP_Ajax_UnitTestCase {
 					'tag-name'  => 'techno',
 				),
 				'expected'  => 'A new category added.',
-				'callback'  => static function( array $messages ) {
+				'callback'  => static function ( array $messages ) {
 					$messages['category'][1] = 'A new category added.';
 					return $messages;
 				},
diff --git a/tests/ajax/wpAjaxAjaxTagSearch.php b/tests/ajax/wpAjaxAjaxTagSearch.php
index fa41463c62..dbcc4cbe0f 100644
--- a/tests/ajax/wpAjaxAjaxTagSearch.php
+++ b/tests/ajax/wpAjaxAjaxTagSearch.php
@@ -176,7 +176,7 @@ class Tests_Ajax_wpAjaxAjaxTagSearch extends WP_Ajax_UnitTestCase {
 		// Add the ajax_term_search_results filter.
 		add_filter(
 			'ajax_term_search_results',
-			static function( $results, $tax, $s ) {
+			static function ( $results, $tax, $s ) {
 				return array( 'ajax_term_search_results was applied' );
 			},
 			10,
diff --git a/tests/ajax/wpAjaxImageEditor.php b/tests/ajax/wpAjaxImageEditor.php
index f09721b74f..ac761c3520 100644
--- a/tests/ajax/wpAjaxImageEditor.php
+++ b/tests/ajax/wpAjaxImageEditor.php
@@ -29,13 +29,12 @@ class Tests_Ajax_wpAjaxImageEditor extends WP_Ajax_UnitTestCase {
 	}
 
 	/**
-	 * @ticket 22985
+	 * @ticket 26381
 	 * @requires function imagejpeg
 	 *
-	 * @covers ::wp_insert_attachment
 	 * @covers ::wp_save_image
 	 */
-	public function testCropImageThumbnail() {
+	public function testCropImageIntoLargerOne() {
 		require_once ABSPATH . 'wp-admin/includes/image-edit.php';
 
 		$filename = DIR_TESTDATA . '/images/canola.jpg';
@@ -45,20 +44,15 @@ class Tests_Ajax_wpAjaxImageEditor extends WP_Ajax_UnitTestCase {
 		$id     = $this->_make_attachment( $upload );
 
 		$_REQUEST['action']  = 'image-editor';
-		$_REQUEST['context'] = 'edit-attachment';
 		$_REQUEST['postid']  = $id;
-		$_REQUEST['target']  = 'thumbnail';
-		$_REQUEST['do']      = 'save';
-		$_REQUEST['history'] = '[{"c":{"x":5,"y":8,"w":289,"h":322}}]';
+		$_REQUEST['do']      = 'scale';
+		$_REQUEST['fwidth']  = 700;
+		$_REQUEST['fheight'] = 500;
 
-		$media_meta = wp_get_attachment_metadata( $id );
-		$this->assertArrayHasKey( 'sizes', $media_meta, 'attachment should have size data' );
-		$this->assertArrayHasKey( 'medium', $media_meta['sizes'], 'attachment should have data for medium size' );
 		$ret = wp_save_image( $id );
 
-		$media_meta = wp_get_attachment_metadata( $id );
-		$this->assertArrayHasKey( 'sizes', $media_meta, 'cropped attachment should have size data' );
-		$this->assertArrayHasKey( 'medium', $media_meta['sizes'], 'cropped attachment should have data for medium size' );
+		$this->assertObjectHasProperty( 'error', $ret );
+		$this->assertEquals( 'Images cannot be scaled to a size larger than the original.', $ret->error );
 	}
 
 	/**
diff --git a/tests/ajax/wpAjaxInlineSave.php b/tests/ajax/wpAjaxInlineSave.php
index ad03e8eb00..3537def1dc 100644
--- a/tests/ajax/wpAjaxInlineSave.php
+++ b/tests/ajax/wpAjaxInlineSave.php
@@ -87,4 +87,59 @@ class Tests_Ajax_wpAjaxInlineSave extends WP_Ajax_UnitTestCase {
 		$post_terms_2 = wp_get_object_terms( $post->ID, 'wptests_tax_2' );
 		$this->assertSameSets( array( $t2 ), wp_list_pluck( $post_terms_2, 'term_id' ) );
 	}
+
+	/**
+	 * When updating a draft in quick edit mode, it should not set the publish date of the post when this one will be published.
+	 *
+	 * @ticket 19907
+	 *
+	 * @covers ::edit_post
+	 */
+	public function test_quick_edit_draft_should_not_set_publish_date() {
+		// Become an administrator.
+		$this->_setRole( 'administrator' );
+
+		$user = get_current_user_id();
+
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_status' => 'draft',
+				'post_author' => $user,
+			)
+		);
+
+		$this->assertSame( 'draft', $post->post_status );
+
+		$this->assertEquals( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		// Set up a request.
+		$_POST['_inline_edit'] = wp_create_nonce( 'inlineeditnonce' );
+		$_POST['post_ID']      = $post->ID;
+		$_POST['post_type']    = 'post';
+		$_POST['content']      = 'content test';
+		$_POST['excerpt']      = 'excerpt test';
+		$_POST['_status']      = $post->post_status;
+		$_POST['post_status']  = $post->post_status;
+		$_POST['post_author']  = $user;
+		$_POST['screen']       = 'edit-post';
+		$_POST['post_view']    = 'list';
+		$_POST['edit_date']    = 'false';
+		$_POST['mm']           = '09';
+		$_POST['jj']           = 11;
+		$_POST['aa']           = 2020;
+		$_POST['hh']           = 19;
+		$_POST['mn']           = 20;
+		$_POST['ss']           = 11;
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'inline-save' );
+		} catch ( WPAjaxDieContinueException $e ) {
+			unset( $e );
+		}
+
+		$post = get_post( $post->ID );
+
+		$this->assertEquals( '0000-00-00 00:00:00', $post->post_date_gmt );
+	}
 }
diff --git a/tests/ajax/wpAjaxSendAttachmentToEditor.php b/tests/ajax/wpAjaxSendAttachmentToEditor.php
index 277ce3d299..29066ff287 100644
--- a/tests/ajax/wpAjaxSendAttachmentToEditor.php
+++ b/tests/ajax/wpAjaxSendAttachmentToEditor.php
@@ -101,4 +101,95 @@ class Tests_Ajax_wpAjaxSendAttachmentToEditor extends WP_Ajax_UnitTestCase {
 		$this->assertTrue( $response['success'] );
 		$this->assertSame( $expected, $response['data'] );
 	}
+
+	public function test_wp_ajax_set_attachment_thumbnail_success() {
+		// Become an administrator.
+		$post    = $_POST;
+		$user_id = self::factory()->user->create(
+			array(
+				'role'       => 'administrator',
+				'user_login' => 'user_36578_administrator',
+				'user_email' => 'user_36578_administrator@example.com',
+			)
+		);
+		wp_set_current_user( $user_id );
+		$_POST = array_merge( $_POST, $post );
+
+		// Upload the attachment itself.
+		$filename = DIR_TESTDATA . '/uploads/small-audio.mp3';
+		$contents = file_get_contents( $filename );
+
+		$upload     = wp_upload_bits( wp_basename( $filename ), null, $contents );
+		$attachment = $this->_make_attachment( $upload );
+
+		// Upload the thumbnail.
+		$filename = DIR_TESTDATA . '/images/waffles.jpg';
+		$contents = file_get_contents( $filename );
+
+		$upload    = wp_upload_bits( wp_basename( $filename ), null, $contents );
+		$thumbnail = $this->_make_attachment( $upload );
+
+		// Set up a default request.
+		$_POST['_ajax_nonce']  = wp_create_nonce( 'set-attachment-thumbnail' );
+		$_POST['thumbnail_id'] = $thumbnail;
+		$_POST['urls']         = array( wp_get_attachment_url( $attachment ) );
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'set-attachment-thumbnail' );
+		} catch ( WPAjaxDieContinueException $e ) {
+			unset( $e );
+		}
+
+		// Get the response.
+		$response = json_decode( $this->_last_response, true );
+
+		// Ensure everything is correct.
+		$this->assertTrue( $response['success'] );
+	}
+
+	public function test_wp_ajax_set_attachment_thumbnail_missing_nonce() {
+		// Become an administrator.
+		$post    = $_POST;
+		$user_id = self::factory()->user->create(
+			array(
+				'role'       => 'administrator',
+				'user_login' => 'user_36578_administrator',
+				'user_email' => 'user_36578_administrator@example.com',
+			)
+		);
+		wp_set_current_user( $user_id );
+		$_POST = array_merge( $_POST, $post );
+
+		// Upload the attachment itself.
+		$filename = DIR_TESTDATA . '/uploads/small-audio.mp3';
+		$contents = file_get_contents( $filename );
+
+		$upload     = wp_upload_bits( wp_basename( $filename ), null, $contents );
+		$attachment = $this->_make_attachment( $upload );
+
+		// Upload the thumbnail.
+		$filename = DIR_TESTDATA . '/images/waffles.jpg';
+		$contents = file_get_contents( $filename );
+
+		$upload    = wp_upload_bits( wp_basename( $filename ), null, $contents );
+		$thumbnail = $this->_make_attachment( $upload );
+
+		// Set up a default request.
+		$_POST['thumbnail_id'] = $thumbnail;
+		$_POST['urls']         = array( wp_get_attachment_url( $attachment ) );
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'set-attachment-thumbnail' );
+		} catch ( WPAjaxDieContinueException $e ) {
+			unset( $e );
+		}
+
+		// Get the response.
+		$response = json_decode( $this->_last_response, true );
+
+		// Check that success is false without sending nonce.
+		$this->assertFalse( $response['success'] );
+	}
 }
diff --git a/tests/ajax/wpCustomizeNavMenus.php b/tests/ajax/wpCustomizeNavMenus.php
index db34c1c5d0..40f2dd1f6f 100644
--- a/tests/ajax/wpCustomizeNavMenus.php
+++ b/tests/ajax/wpCustomizeNavMenus.php
@@ -107,7 +107,6 @@ class Tests_Ajax_wpCustomizeNavMenus extends WP_Ajax_UnitTestCase {
 
 			$this->assertSame( $expected_results, $response );
 		}
-
 	}
 
 	/**
@@ -291,7 +290,6 @@ class Tests_Ajax_wpCustomizeNavMenus extends WP_Ajax_UnitTestCase {
 		// Get the results.
 		$response = json_decode( $this->_last_response, true );
 		$this->assertSame( $success_status, $response['success'] );
-
 	}
 
 	/**
diff --git a/tests/attachment/slashes.php b/tests/attachment/slashes.php
index b6c009957c..3fb0e58db6 100644
--- a/tests/attachment/slashes.php
+++ b/tests/attachment/slashes.php
@@ -68,5 +68,4 @@ class Tests_Attachment_Slashes extends WP_UnitTestCase {
 		$this->assertSame( wp_unslash( self::SLASH_4 ), $post->post_content_filtered );
 		$this->assertSame( wp_unslash( self::SLASH_6 ), $post->post_excerpt );
 	}
-
 }
diff --git a/tests/auth.php b/tests/auth.php
index 1a2bd9a92d..facd456dd0 100644
--- a/tests/auth.php
+++ b/tests/auth.php
@@ -5,6 +5,11 @@
  * @group auth
  */
 class Tests_Auth extends WP_UnitTestCase {
+	// Class User values assigned to constants.
+	const USER_EMAIL = 'test@password.com';
+	const USER_LOGIN = 'password-user';
+	const USER_PASS  = 'password';
+
 	protected $user;
 
 	/**
@@ -22,7 +27,9 @@ class Tests_Auth extends WP_UnitTestCase {
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$_user = $factory->user->create_and_get(
 			array(
-				'user_login' => 'password-tests',
+				'user_login' => self::USER_LOGIN,
+				'user_email' => self::USER_EMAIL,
+				'user_pass'  => self::USER_PASS,
 			)
 		);
 
@@ -46,6 +53,10 @@ class Tests_Auth extends WP_UnitTestCase {
 		// Cleanup all the global state.
 		unset( $_SERVER['PHP_AUTH_USER'], $_SERVER['PHP_AUTH_PW'], $GLOBALS['wp_rest_application_password_status'], $GLOBALS['wp_rest_application_password_uuid'] );
 
+		// Cleanup manual auth cookie test.
+		unset( $_COOKIE[ AUTH_COOKIE ] );
+		unset( $_COOKIE[ SECURE_AUTH_COOKIE ] );
+
 		parent::tear_down();
 	}
 
@@ -429,6 +440,129 @@ class Tests_Auth extends WP_UnitTestCase {
 		$this->assertInstanceOf( 'WP_User', wp_authenticate( $user_args['user_login'], $user_args['user_pass'] ) );
 	}
 
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_username_password_with_wp_user_object() {
+		$result = wp_authenticate_username_password( self::$_user, '', '' );
+		$this->assertSame( $result->ID, self::$user_id );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_username_password_with_login_and_password() {
+		$result = wp_authenticate_username_password( null, self::USER_LOGIN, self::USER_PASS );
+		$this->assertSame( self::$user_id, $result->ID );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_username_password_with_null_password() {
+		$result = wp_authenticate_username_password( null, self::USER_LOGIN, null );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_username_password_with_null_login() {
+		$result = wp_authenticate_username_password( null, null, self::USER_PASS );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_username_password_with_invalid_login() {
+		$result = wp_authenticate_username_password( null, 'invalidlogin', self::USER_PASS );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_username_password_with_invalid_password() {
+		$result = wp_authenticate_username_password( null, self::USER_LOGIN, 'invalidpassword' );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_email_password_with_wp_user_object() {
+		$result = wp_authenticate_email_password( self::$_user, '', '' );
+		$this->assertSame( self::$user_id, $result->ID );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_email_password_with_login_and_password() {
+		$result = wp_authenticate_email_password( null, self::USER_EMAIL, self::USER_PASS );
+		$this->assertSame( self::$user_id, $result->ID );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_email_password_with_null_password() {
+		$result = wp_authenticate_email_password( null, self::USER_EMAIL, null );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_email_password_with_null_email() {
+		$result = wp_authenticate_email_password( null, null, self::USER_PASS );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_email_password_with_invalid_email() {
+		$result = wp_authenticate_email_password( null, 'invalid@example.com', self::USER_PASS );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_email_password_with_invalid_password() {
+		$result = wp_authenticate_email_password( null, self::USER_EMAIL, 'invalidpassword' );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_cookie_with_wp_user_object() {
+		$result = wp_authenticate_cookie( $this->user, null, null );
+		$this->assertSame( self::$user_id, $result->ID );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_cookie_with_null_params() {
+		$result = wp_authenticate_cookie( null, null, null );
+		$this->assertNull( $result );
+	}
+
+	/**
+	 * @ticket 36476
+	 */
+	public function test_wp_authenticate_cookie_with_invalid_cookie() {
+		$_COOKIE[ AUTH_COOKIE ]        = 'invalid_cookie';
+		$_COOKIE[ SECURE_AUTH_COOKIE ] = 'secure_invalid_cookie';
+
+		$result = wp_authenticate_cookie( null, null, null );
+		$this->assertInstanceOf( 'WP_Error', $result );
+	}
+
 	/**
 	 * @ticket 38744
 	 */
diff --git a/tests/avatar.php b/tests/avatar.php
index 026809b4a1..32ff9ac648 100644
--- a/tests/avatar.php
+++ b/tests/avatar.php
@@ -279,5 +279,4 @@ class Tests_Avatar extends WP_UnitTestCase {
 		$this->assertFalse( is_avatar_comment_type( $comment_type ) );
 		$this->assertFalse( $actual_data['url'] );
 	}
-
 }
diff --git a/tests/block-supports/border.php b/tests/block-supports/border.php
index aae4d4d2cc..2d437599fc 100644
--- a/tests/block-supports/border.php
+++ b/tests/block-supports/border.php
@@ -18,7 +18,7 @@ class Test_Block_Supports_Border extends WP_UnitTestCase {
 	public function tear_down() {
 		unregister_block_type( $this->test_block_name );
 		$this->test_block_name = null;
-		parent::set_up();
+		parent::tear_down();
 	}
 
 	/**
diff --git a/tests/block-supports/colors.php b/tests/block-supports/colors.php
index f9d302a741..86dd8de38d 100644
--- a/tests/block-supports/colors.php
+++ b/tests/block-supports/colors.php
@@ -18,7 +18,7 @@ class Tests_Block_Supports_Colors extends WP_UnitTestCase {
 	public function tear_down() {
 		unregister_block_type( $this->test_block_name );
 		$this->test_block_name = null;
-		parent::set_up();
+		parent::tear_down();
 	}
 
 	/**
diff --git a/tests/block-supports/duotone.php b/tests/block-supports/duotone.php
new file mode 100644
index 0000000000..2077ef705b
--- /dev/null
+++ b/tests/block-supports/duotone.php
@@ -0,0 +1,127 @@
+<?php
+
+/**
+ * Test the block WP_Duotone class.
+ *
+ * @package WordPress
+ */
+
+class Tests_Block_Supports_DuoTones extends WP_UnitTestCase {
+	/**
+	 * Cleans up CSS added to block-supports from duotone styles. We neeed to do this
+	 * in order to avoid impacting other tests.
+	 */
+	public static function wpTearDownAfterClass() {
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+	}
+
+	/**
+	 * Tests whether the duotone preset class is added to the block.
+	 *
+	 * @ticket 58555
+	 *
+	 * @covers ::render_duotone_support
+	 */
+	public function test_render_duotone_support_preset() {
+		$block         = array(
+			'blockName' => 'core/image',
+			'attrs'     => array( 'style' => array( 'color' => array( 'duotone' => 'var:preset|duotone|blue-orange' ) ) ),
+		);
+		$wp_block      = new WP_Block( $block );
+		$block_content = '<figure class="wp-block-image size-full"><img src="/my-image.jpg" /></figure>';
+		$expected      = '<figure class="wp-block-image size-full wp-duotone-blue-orange"><img src="/my-image.jpg" /></figure>';
+		$this->assertSame( $expected, WP_Duotone::render_duotone_support( $block_content, $block, $wp_block ) );
+	}
+
+	/**
+	 * Tests whether the duotone unset class is added to the block.
+	 *
+	 * @ticket 58555
+	 *
+	 * @covers ::render_duotone_support
+	 */
+	public function test_render_duotone_support_css() {
+		$block         = array(
+			'blockName' => 'core/image',
+			'attrs'     => array( 'style' => array( 'color' => array( 'duotone' => 'unset' ) ) ),
+		);
+		$wp_block      = new WP_Block( $block );
+		$block_content = '<figure class="wp-block-image size-full"><img src="/my-image.jpg" /></figure>';
+		$expected      = '/<figure class="wp-block-image size-full wp-duotone-unset-\d+"><img src="\\/my-image.jpg" \\/><\\/figure>/';
+		$this->assertMatchesRegularExpression( $expected, WP_Duotone::render_duotone_support( $block_content, $block, $wp_block ) );
+	}
+
+	/**
+	 * Tests whether the duotone custom class is added to the block.
+	 *
+	 * @covers ::render_duotone_support
+	 */
+	public function test_render_duotone_support_custom() {
+		$block         = array(
+			'blockName' => 'core/image',
+			'attrs'     => array( 'style' => array( 'color' => array( 'duotone' => array( '#FFFFFF', '#000000' ) ) ) ),
+		);
+		$wp_block      = new WP_Block( $block );
+		$block_content = '<figure class="wp-block-image size-full"><img src="/my-image.jpg" /></figure>';
+		$expected      = '/<figure class="wp-block-image size-full wp-duotone-ffffff-000000-\d+"><img src="\\/my-image.jpg" \\/><\\/figure>/';
+		$this->assertMatchesRegularExpression( $expected, WP_Duotone::render_duotone_support( $block_content, $block, $wp_block ) );
+	}
+
+	/**
+	 * Tests whether the slug is extracted from the attribute.
+	 *
+	 * @dataProvider data_get_slug_from_attribute
+	 * @covers ::get_slug_from_attribute
+	 */
+	public function test_get_slug_from_attribute( $data_attr, $expected ) {
+
+		$reflection = new ReflectionMethod( 'WP_Duotone', 'get_slug_from_attribute' );
+		$reflection->setAccessible( true );
+
+		$this->assertSame( $expected, $reflection->invoke( null, $data_attr ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[].
+	 */
+	public function data_get_slug_from_attribute() {
+		return array(
+			'pipe-slug'                       => array( 'var:preset|duotone|blue-orange', 'blue-orange' ),
+			'css-var'                         => array( 'var(--wp--preset--duotone--blue-orange)', 'blue-orange' ),
+			'css-var-invalid-slug-chars'      => array( 'var(--wp--preset--duotone--.)', '.' ),
+			'css-var-missing-end-parenthesis' => array( 'var(--wp--preset--duotone--blue-orange', '' ),
+			'invalid'                         => array( 'not a valid attribute', '' ),
+			'css-var-no-value'                => array( 'var(--wp--preset--duotone--)', '' ),
+			'pipe-slug-no-value'              => array( 'var:preset|duotone|', '' ),
+			'css-var-spaces'                  => array( 'var(--wp--preset--duotone--    ', '' ),
+			'pipe-slug-spaces'                => array( 'var:preset|duotone|  ', '' ),
+		);
+	}
+
+	/**
+	 * @dataProvider data_is_preset
+	 */
+	public function test_is_preset( $data_attr, $expected ) {
+		$reflection = new ReflectionMethod( 'WP_Duotone', 'is_preset' );
+		$reflection->setAccessible( true );
+
+		$this->assertSame( $expected, $reflection->invoke( null, $data_attr ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[].
+	 */
+	public function data_is_preset() {
+		return array(
+			'pipe-slug'                       => array( 'var:preset|duotone|blue-orange', true ),
+			'css-var'                         => array( 'var(--wp--preset--duotone--blue-orange)', true ),
+			'css-var-invalid-slug-chars'      => array( 'var(--wp--preset--duotone--.)', false ),
+			'css-var-missing-end-parenthesis' => array( 'var(--wp--preset--duotone--blue-orange', false ),
+			'invalid'                         => array( 'not a valid attribute', false ),
+		);
+	}
+}
diff --git a/tests/block-supports/elements.php b/tests/block-supports/elements.php
index 02c29dd6e6..0b1f720b5a 100644
--- a/tests/block-supports/elements.php
+++ b/tests/block-supports/elements.php
@@ -106,4 +106,68 @@ class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 			'<p class="wp-elements-1" id="anchor">Hello <a href="http://www.wordpress.org/">WordPress</a>!</p>'
 		);
 	}
+
+	/**
+	 * Test wp_render_elements_support() with a group block that has a button
+	 * element color set.
+	 *
+	 * @ticket 59309
+	 */
+	public function test_group_with_button_element_style() {
+		$result = self::make_unique_id_one(
+			wp_render_elements_support(
+				'<div class="wp-block-group"><div class="wp-block-buttons is-layout-flex wp-block-buttons-is-layout-flex"><div class="wp-block-button"><a class="wp-block-button__link wp-element-button">Button</a></div></div></div>',
+				array(
+					'blockName' => 'core/group',
+					'attrs'     => array(
+						'style' => array(
+							'elements' => array(
+								'button' => array(
+									'color' => array(
+										'text' => 'var:preset|color|vivid-red',
+									),
+								),
+							),
+						),
+					),
+				)
+			)
+		);
+		$this->assertSame(
+			$result,
+			'<div class="wp-block-group wp-elements-1"><div class="wp-block-buttons is-layout-flex wp-block-buttons-is-layout-flex"><div class="wp-block-button"><a class="wp-block-button__link wp-element-button">Button</a></div></div></div>'
+		);
+	}
+
+	/**
+	 * Test wp_render_elements_support() with a group block that has a heading
+	 * element color set.
+	 *
+	 * @ticket 59309
+	 */
+	public function test_group_with_heading_element_style() {
+		$result = self::make_unique_id_one(
+			wp_render_elements_support(
+				'<div class="wp-block-group"><h2 class="wp-block-heading">Test</h2></div>',
+				array(
+					'blockName' => 'core/group',
+					'attrs'     => array(
+						'style' => array(
+							'elements' => array(
+								'heading' => array(
+									'color' => array(
+										'text' => 'var:preset|color|vivid-red',
+									),
+								),
+							),
+						),
+					),
+				)
+			)
+		);
+		$this->assertSame(
+			$result,
+			'<div class="wp-block-group wp-elements-1"><h2 class="wp-block-heading">Test</h2></div>'
+		);
+	}
 }
diff --git a/tests/block-supports/layout.php b/tests/block-supports/layout.php
index 73acce8bc7..df0abf9b49 100644
--- a/tests/block-supports/layout.php
+++ b/tests/block-supports/layout.php
@@ -170,6 +170,7 @@ class Test_Block_Supports_Layout extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 57584
+	 * @ticket 58548
 	 *
 	 * @dataProvider data_layout_support_flag_renders_classnames_on_wrapper
 	 *
@@ -207,7 +208,7 @@ class Test_Block_Supports_Layout extends WP_UnitTestCase {
 						),
 					),
 				),
-				'expected_output' => '<div class="wp-block-group is-layout-flow"></div>',
+				'expected_output' => '<div class="wp-block-group is-layout-flow wp-block-group-is-layout-flow"></div>',
 			),
 			'single wrapper block layout with constrained type' => array(
 				'args'            => array(
@@ -226,7 +227,7 @@ class Test_Block_Supports_Layout extends WP_UnitTestCase {
 						),
 					),
 				),
-				'expected_output' => '<div class="wp-block-group is-layout-constrained"></div>',
+				'expected_output' => '<div class="wp-block-group is-layout-constrained wp-block-group-is-layout-constrained"></div>',
 			),
 			'multiple wrapper block layout with flow type' => array(
 				'args'            => array(
@@ -247,7 +248,7 @@ class Test_Block_Supports_Layout extends WP_UnitTestCase {
 						),
 					),
 				),
-				'expected_output' => '<div class="wp-block-group"><div class="wp-block-group__inner-wrapper is-layout-flow"></div></div>',
+				'expected_output' => '<div class="wp-block-group"><div class="wp-block-group__inner-wrapper is-layout-flow wp-block-group-is-layout-flow"></div></div>',
 			),
 		);
 	}
diff --git a/tests/block-supports/shadow.php b/tests/block-supports/shadow.php
new file mode 100644
index 0000000000..0ccc5f08e4
--- /dev/null
+++ b/tests/block-supports/shadow.php
@@ -0,0 +1,89 @@
+<?php
+/**
+ * @group block-supports
+ *
+ * @covers ::wp_apply_shadow_support
+ */
+class Test_Block_Supports_Shadow extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
+
+	public function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+	}
+
+	public function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::tear_down();
+	}
+
+	/**
+	 * @ticket 58590
+	 */
+	public function test_shadow_style_is_applied() {
+		$this->test_block_name = 'test/shadow-style-is-applied';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 3,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'shadow' => true,
+				),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'shadow' => '60px -16px teal',
+			),
+		);
+
+		$actual   = wp_apply_shadow_support( $block_type, $block_atts );
+		$expected = array(
+			'style' => 'box-shadow:60px -16px teal;',
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 58590
+	 */
+	public function test_shadow_without_block_supports() {
+		$this->test_block_name = 'test/shadow-with-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'shadow' => '60px -16px teal',
+			),
+		);
+
+		$actual   = wp_apply_spacing_support( $block_type, $block_atts );
+		$expected = array();
+
+		$this->assertSame( $expected, $actual );
+	}
+}
diff --git a/tests/block-supports/spacing.php b/tests/block-supports/spacing.php
index 4b5ada3798..7b1f8e957e 100644
--- a/tests/block-supports/spacing.php
+++ b/tests/block-supports/spacing.php
@@ -18,7 +18,7 @@ class Test_Block_Supports_Spacing extends WP_UnitTestCase {
 	public function tear_down() {
 		unregister_block_type( $this->test_block_name );
 		$this->test_block_name = null;
-		parent::set_up();
+		parent::tear_down();
 	}
 
 	/**
diff --git a/tests/block-supports/typography.php b/tests/block-supports/typography.php
index 6cbd76788d..9c547b4e5c 100644
--- a/tests/block-supports/typography.php
+++ b/tests/block-supports/typography.php
@@ -293,6 +293,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 	 *
 	 * @ticket 56467
 	 * @ticket 57065
+	 * @ticket 58523
 	 *
 	 * @covers ::wp_get_typography_font_size_value
 	 *
@@ -385,7 +386,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					'size' => '1.75rem',
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(1.313rem, 1.313rem + ((1vw - 0.48rem) * 0.84), 1.75rem)',
+				'expected_output'             => 'clamp(1.119rem, 1.119rem + ((1vw - 0.2rem) * 0.789), 1.75rem)',
 			),
 
 			'returns clamp value with em min and max units' => array(
@@ -393,15 +394,15 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					'size' => '1.75em',
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(1.313em, 1.313rem + ((1vw - 0.48em) * 0.84), 1.75em)',
+				'expected_output'             => 'clamp(1.119em, 1.119rem + ((1vw - 0.2em) * 0.789), 1.75em)',
 			),
 
 			'returns clamp value for floats'             => array(
 				'font_size'                   => array(
-					'size' => '100.175px',
+					'size' => '70.175px',
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(75.131px, 4.696rem + ((1vw - 7.68px) * 3.01), 100.175px)',
+				'expected_output'             => 'clamp(37.897px, 2.369rem + ((1vw - 3.2px) * 2.522), 70.175px)',
 			),
 
 			'coerces integer to `px` and returns clamp value' => array(
@@ -409,15 +410,15 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					'size' => 33,
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(24.75px, 1.547rem + ((1vw - 7.68px) * 0.992), 33px)',
+				'expected_output'             => 'clamp(20.515px, 1.282rem + ((1vw - 3.2px) * 0.975), 33px)',
 			),
 
 			'coerces float to `px` and returns clamp value' => array(
 				'font_size_preset'            => array(
-					'size' => 100.23,
+					'size' => 70.175,
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(75.173px, 4.698rem + ((1vw - 7.68px) * 3.012), 100.23px)',
+				'expected_output'             => 'clamp(37.897px, 2.369rem + ((1vw - 3.2px) * 2.522), 70.175px)',
 			),
 
 			'returns clamp value when `fluid` is empty array' => array(
@@ -426,7 +427,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					'fluid' => array(),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(21px, 1.313rem + ((1vw - 7.68px) * 0.841), 28px)',
+				'expected_output'             => 'clamp(17.905px, 1.119rem + ((1vw - 3.2px) * 0.789), 28px)',
 			),
 
 			'returns clamp value when `fluid` is `null`' => array(
@@ -435,7 +436,31 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					'fluid' => null,
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(21px, 1.313rem + ((1vw - 7.68px) * 0.841), 28px)',
+				'expected_output'             => 'clamp(17.905px, 1.119rem + ((1vw - 3.2px) * 0.789), 28px)',
+			),
+
+			'returns clamp value where min and max fluid values defined' => array(
+				'font_size'                   => array(
+					'size'  => '80px',
+					'fluid' => array(
+						'min' => '70px',
+						'max' => '125px',
+					),
+				),
+				'should_use_fluid_typography' => true,
+				'expected_output'             => 'clamp(70px, 4.375rem + ((1vw - 3.2px) * 4.297), 125px)',
+			),
+
+			'returns clamp value where max is equal to size' => array(
+				'font_size'                   => array(
+					'size'  => '7.8125rem',
+					'fluid' => array(
+						'min' => '4.375rem',
+						'max' => '7.8125rem',
+					),
+				),
+				'should_use_fluid_typography' => true,
+				'expected_output'             => 'clamp(4.375rem, 4.375rem + ((1vw - 0.2rem) * 4.298), 7.8125rem)',
 			),
 
 			'returns clamp value if min font size is greater than max' => array(
@@ -447,7 +472,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(5rem, 5rem + ((1vw - 0.48rem) * -5.769), 32px)',
+				'expected_output'             => 'clamp(5rem, 5rem + ((1vw - 0.2rem) * -3.75), 32px)',
 			),
 
 			'returns value with invalid min/max fluid units' => array(
@@ -487,18 +512,18 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(20px, 1.25rem + ((1vw - 7.68px) * 93.75), 50rem)',
+				'expected_output'             => 'clamp(20px, 1.25rem + ((1vw - 3.2px) * 60.938), 50rem)',
 			),
 
 			'returns clamp value where no fluid max size is set' => array(
 				'font_size_preset'            => array(
-					'size'  => '28px',
+					'size'  => '50px',
 					'fluid' => array(
 						'min' => '2.6rem',
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(2.6rem, 2.6rem + ((1vw - 0.48rem) * -1.635), 28px)',
+				'expected_output'             => 'clamp(2.6rem, 2.6rem + ((1vw - 0.2rem) * 0.656), 50px)',
 			),
 
 			'returns clamp value where no fluid min size is set' => array(
@@ -509,7 +534,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(21px, 1.313rem + ((1vw - 7.68px) * 7.091), 80px)',
+				'expected_output'             => 'clamp(17.905px, 1.119rem + ((1vw - 3.2px) * 4.851), 80px)',
 			),
 
 			'should not apply lower bound test when fluid values are set' => array(
@@ -521,7 +546,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(0.5rem, 0.5rem + ((1vw - 0.48rem) * 8.654), 5rem)',
+				'expected_output'             => 'clamp(0.5rem, 0.5rem + ((1vw - 0.2rem) * 5.625), 5rem)',
 			),
 
 			'should not apply lower bound test when only fluid min is set' => array(
@@ -532,7 +557,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(12px, 0.75rem + ((1vw - 7.68px) * 0.962), 20px)',
+				'expected_output'             => 'clamp(12px, 0.75rem + ((1vw - 3.2px) * 0.625), 20px)',
 			),
 
 			'should not apply lower bound test when only fluid max is set' => array(
@@ -543,7 +568,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(0.875rem, 0.875rem + ((1vw - 0.48rem) * 36.779), 20rem)',
+				'expected_output'             => 'clamp(0.875rem, 0.875rem + ((1vw - 0.2rem) * 23.906), 20rem)',
 			),
 
 			'returns clamp value when min and max font sizes are equal' => array(
@@ -555,7 +580,34 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 					),
 				),
 				'should_use_fluid_typography' => true,
-				'expected_output'             => 'clamp(30px, 1.875rem + ((1vw - 7.68px) * 1), 30px)',
+				'expected_output'             => 'clamp(30px, 1.875rem + ((1vw - 3.2px) * 1), 30px)',
+			),
+
+			'should apply scaled min font size for em values when custom min font size is not set' => array(
+				'font_size'                   => array(
+					'size' => '12rem',
+				),
+				'should_use_fluid_typography' => true,
+				'expected_output'             => 'clamp(5.174rem, 5.174rem + ((1vw - 0.2rem) * 8.533), 12rem)',
+			),
+
+			'should apply scaled min font size for px values when custom min font size is not set' => array(
+				'font_size'                   => array(
+					'size' => '200px',
+				),
+				'should_use_fluid_typography' => true,
+				'expected_output'             => 'clamp(85.342px, 5.334rem + ((1vw - 3.2px) * 8.958), 200px)',
+			),
+
+			'should not apply scaled min font size for minimum font size when custom min font size is set' => array(
+				'font_size'                   => array(
+					'size'  => '200px',
+					'fluid' => array(
+						'min' => '100px',
+					),
+				),
+				'should_use_fluid_typography' => true,
+				'expected_output'             => 'clamp(100px, 6.25rem + ((1vw - 3.2px) * 7.813), 200px)',
 			),
 		);
 	}
@@ -568,6 +620,9 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 	 * @ticket 56467
 	 * @ticket 57065
 	 * @ticket 57529
+	 * @ticket 58522
+	 * @ticket 58523
+	 * @ticket 59048
 	 *
 	 * @covers ::wp_register_typography_support
 	 *
@@ -628,7 +683,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			'returns clamp value using default config' => array(
 				'font_size_value' => '15px',
 				'theme_slug'      => 'block-theme-child-with-fluid-typography',
-				'expected_output' => 'font-size:clamp(14px, 0.875rem + ((1vw - 7.68px) * 0.12), 15px);',
+				'expected_output' => 'font-size:clamp(14px, 0.875rem + ((1vw - 3.2px) * 0.078), 15px);',
 			),
 			'returns value when font size <= default min font size bound' => array(
 				'font_size_value' => '13px',
@@ -638,13 +693,18 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			'returns clamp value using custom fluid config' => array(
 				'font_size_value' => '17px',
 				'theme_slug'      => 'block-theme-child-with-fluid-typography-config',
-				'expected_output' => 'font-size:clamp(16px, 1rem + ((1vw - 7.68px) * 0.12), 17px);',
+				'expected_output' => 'font-size:clamp(16px, 1rem + ((1vw - 6.4px) * 0.179), 17px);',
 			),
 			'returns value when font size <= custom min font size bound' => array(
 				'font_size_value' => '15px',
 				'theme_slug'      => 'block-theme-child-with-fluid-typography-config',
 				'expected_output' => 'font-size:15px;',
 			),
+			'returns clamp value using default config if layout is fluid' => array(
+				'font_size_value' => '15px',
+				'theme_slug'      => 'block-theme-child-with-fluid-layout',
+				'expected_output' => 'font-size:clamp(14px, 0.875rem + ((1vw - 3.2px) * 0.078), 15px);',
+			),
 		);
 	}
 
@@ -655,6 +715,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 	 *
 	 * @ticket 56467
 	 * @ticket 57065
+	 * @ticket 58523
 	 *
 	 * @dataProvider data_generate_replace_inline_font_styles_with_fluid_values_fixtures
 	 *
@@ -702,7 +763,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 				'block_content'               => '<h2 class="has-vivid-red-background-color has-background has-link-color" style="margin-top:var(--wp--preset--spacing--60);font-size:4rem;font-style:normal;font-weight:600;letter-spacing:29px;text-decoration:underline;text-transform:capitalize">This is a heading</h2>',
 				'font_size_value'             => '4rem',
 				'should_use_fluid_typography' => true,
-				'expected_output'             => '<h2 class="has-vivid-red-background-color has-background has-link-color" style="margin-top:var(--wp--preset--spacing--60);font-size:clamp(3rem, 3rem + ((1vw - 0.48rem) * 1.923), 4rem);font-style:normal;font-weight:600;letter-spacing:29px;text-decoration:underline;text-transform:capitalize">This is a heading</h2>',
+				'expected_output'             => '<h2 class="has-vivid-red-background-color has-background has-link-color" style="margin-top:var(--wp--preset--spacing--60);font-size:clamp(2.2rem, 2.2rem + ((1vw - 0.2rem) * 2.25), 4rem);font-style:normal;font-weight:600;letter-spacing:29px;text-decoration:underline;text-transform:capitalize">This is a heading</h2>',
 			),
 			'return_content_if_no_inline_font_size_found'  => array(
 				'block_content'               => '<p class="has-medium-font-size" style="font-style:normal;font-weight:600;letter-spacing:29px;">A paragraph inside a group</p>',
@@ -720,13 +781,13 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 				'block_content'               => '<p class="has-medium-font-size" style="    font-size:   20px   ;    ">A paragraph inside a group</p>',
 				'font_size_value'             => '20px',
 				'should_use_fluid_typography' => true,
-				'expected_output'             => '<p class="has-medium-font-size" style="    font-size:clamp(15px, 0.938rem + ((1vw - 7.68px) * 0.601), 20px);    ">A paragraph inside a group</p>',
+				'expected_output'             => '<p class="has-medium-font-size" style="    font-size:clamp(14px, 0.875rem + ((1vw - 3.2px) * 0.469), 20px);    ">A paragraph inside a group</p>',
 			),
 			'return_content_with_first_match_replace_only' => array(
 				'block_content'               => "<div class=\"wp-block-group\" style=\"font-size:1.5em\"> \n \n<p style=\"font-size:1.5em\">A paragraph inside a group</p></div>",
 				'font_size_value'             => '1.5em',
 				'should_use_fluid_typography' => true,
-				'expected_output'             => "<div class=\"wp-block-group\" style=\"font-size:clamp(1.125em, 1.125rem + ((1vw - 0.48em) * 0.721), 1.5em);\"> \n \n<p style=\"font-size:1.5em\">A paragraph inside a group</p></div>",
+				'expected_output'             => "<div class=\"wp-block-group\" style=\"font-size:clamp(0.984em, 0.984rem + ((1vw - 0.2em) * 0.645), 1.5em);\"> \n \n<p style=\"font-size:1.5em\">A paragraph inside a group</p></div>",
 			),
 		);
 	}
@@ -847,4 +908,89 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			'size: array' => array( array( '10' ) ),
 		);
 	}
+
+	/**
+	 * Tests computed font size values.
+	 *
+	 * @ticket 58522
+	 *
+	 * @covers ::wp_get_computed_fluid_typography_value
+	 *
+	 * @dataProvider data_wp_get_computed_fluid_typography_value
+	 *
+	 * @param array  $args {
+	 *      Optional. An associative array of values to calculate a fluid formula for font size. Default is empty array.
+	 *
+	 *     @type string $maximum_viewport_width Maximum size up to which type will have fluidity.
+	 *     @type string $minimum_viewport_width Minimum viewport size from which type will have fluidity.
+	 *     @type string $maximum_font_size      Maximum font size for any clamp() calculation.
+	 *     @type string $minimum_font_size      Minimum font size for any clamp() calculation.
+	 *     @type int    $scale_factor           A scale factor to determine how fast a font scales within boundaries.
+	 * }
+	 * @param string $expected_output             Expected value of style property from wp_apply_typography_support().
+	 */
+	public function test_wp_get_computed_fluid_typography_value( $args, $expected_output ) {
+		$actual = wp_get_computed_fluid_typography_value( $args );
+		$this->assertSame( $expected_output, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_get_computed_fluid_typography_value() {
+		return array(
+			'returns clamped value with valid args' => array(
+				'args'            => array(
+					'minimum_viewport_width' => '320px',
+					'maximum_viewport_width' => '1000px',
+					'minimum_font_size'      => '50px',
+					'maximum_font_size'      => '100px',
+					'scale_factor'           => 1,
+				),
+				'expected_output' => 'clamp(50px, 3.125rem + ((1vw - 3.2px) * 7.353), 100px)',
+			),
+			'returns `null` when `maximum_viewport_width` is an unsupported unit' => array(
+				'args'            => array(
+					'minimum_viewport_width' => '320px',
+					'maximum_viewport_width' => 'calc(100% - 60px)',
+					'minimum_font_size'      => '50px',
+					'maximum_font_size'      => '100px',
+					'scale_factor'           => 1,
+				),
+				'expected_output' => null,
+			),
+			'returns `null` when `minimum_viewport_width` is an unsupported unit' => array(
+				'args'            => array(
+					'minimum_viewport_width' => 'calc(100% - 60px)',
+					'maximum_viewport_width' => '1000px',
+					'minimum_font_size'      => '50px',
+					'maximum_font_size'      => '100px',
+					'scale_factor'           => 1,
+				),
+				'expected_output' => null,
+			),
+			'returns `null` when `minimum_font_size` is an unsupported unit' => array(
+				'args'            => array(
+					'minimum_viewport_width' => '320em',
+					'maximum_viewport_width' => '1000em',
+					'minimum_font_size'      => '10vw',
+					'maximum_font_size'      => '100em',
+					'scale_factor'           => 1,
+				),
+				'expected_output' => null,
+			),
+			'returns `null` when `maximum_font_size` is an unsupported unit' => array(
+				'args'            => array(
+					'minimum_viewport_width' => '320em',
+					'maximum_viewport_width' => '1000em',
+					'minimum_font_size'      => '50px',
+					'maximum_font_size'      => '100%',
+					'scale_factor'           => 1,
+				),
+				'expected_output' => null,
+			),
+		);
+	}
 }
diff --git a/tests/block-supports/wpRenderBackgroundSupport.php b/tests/block-supports/wpRenderBackgroundSupport.php
new file mode 100644
index 0000000000..4f38db87ab
--- /dev/null
+++ b/tests/block-supports/wpRenderBackgroundSupport.php
@@ -0,0 +1,188 @@
+<?php
+/**
+ * @group block-supports
+ *
+ * @covers ::wp_render_background_support
+ */
+class Tests_Block_Supports_WpRenderBackgroundSupport extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
+
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
+	public function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+		$this->theme_root      = realpath( DIR_TESTDATA . '/themedir1' );
+		$this->orig_theme_dir  = $GLOBALS['wp_theme_directories'];
+
+		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+
+		add_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		// Clear caches.
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+	}
+
+	public function tear_down() {
+		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
+
+		// Clear up the filters to modify the theme root.
+		remove_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::tear_down();
+	}
+
+	public function filter_set_theme_root() {
+		return $this->theme_root;
+	}
+
+	/**
+	 * Tests that background image block support works as expected.
+	 *
+	 * @ticket 59357
+	 *
+	 * @covers ::wp_render_background_support
+	 *
+	 * @dataProvider data_background_block_support
+	 *
+	 * @param string $theme_name          The theme to switch to.
+	 * @param string $block_name          The test block name to register.
+	 * @param mixed  $background_settings The background block support settings.
+	 * @param mixed  $background_style    The background styles within the block attributes.
+	 * @param string $expected_wrapper    Expected markup for the block wrapper.
+	 * @param string $wrapper             Existing markup for the block wrapper.
+	 */
+	public function test_background_block_support( $theme_name, $block_name, $background_settings, $background_style, $expected_wrapper, $wrapper ) {
+		switch_theme( $theme_name );
+		$this->test_block_name = $block_name;
+
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'background' => $background_settings,
+				),
+			)
+		);
+
+		$block = array(
+			'blockName' => $block_name,
+			'attrs'     => array(
+				'style' => array(
+					'background' => $background_style,
+				),
+			),
+		);
+
+		$actual = wp_render_background_support( $wrapper, $block );
+
+		$this->assertEquals(
+			$expected_wrapper,
+			$actual,
+			'Background block wrapper markup should be correct'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_background_block_support() {
+		return array(
+			'background image style is applied' => array(
+				'theme_name'          => 'block-theme-child-with-fluid-typography',
+				'block_name'          => 'test/background-rules-are-output',
+				'background_settings' => array(
+					'backgroundImage' => true,
+				),
+				'background_style'    => array(
+					'backgroundImage' => array(
+						'url'    => 'https://example.com/image.jpg',
+						'source' => 'file',
+					),
+				),
+				'expected_wrapper'    => '<div style="background-image:url(&#039;https://example.com/image.jpg&#039;);background-size:cover;">Content</div>',
+				'wrapper'             => '<div>Content</div>',
+			),
+			'background image style is appended if a style attribute already exists' => array(
+				'theme_name'          => 'block-theme-child-with-fluid-typography',
+				'block_name'          => 'test/background-rules-are-output',
+				'background_settings' => array(
+					'backgroundImage' => true,
+				),
+				'background_style'    => array(
+					'backgroundImage' => array(
+						'url'    => 'https://example.com/image.jpg',
+						'source' => 'file',
+					),
+				),
+				'expected_wrapper'    => '<div classname="wp-block-test" style="color: red;background-image:url(&#039;https://example.com/image.jpg&#039;);background-size:cover;">Content</div>',
+				'wrapper'             => '<div classname="wp-block-test" style="color: red">Content</div>',
+			),
+			'background image style is appended if a style attribute containing multiple styles already exists' => array(
+				'theme_name'          => 'block-theme-child-with-fluid-typography',
+				'block_name'          => 'test/background-rules-are-output',
+				'background_settings' => array(
+					'backgroundImage' => true,
+				),
+				'background_style'    => array(
+					'backgroundImage' => array(
+						'url'    => 'https://example.com/image.jpg',
+						'source' => 'file',
+					),
+				),
+				'expected_wrapper'    => '<div classname="wp-block-test" style="color: red;font-size: 15px;background-image:url(&#039;https://example.com/image.jpg&#039;);background-size:cover;">Content</div>',
+				'wrapper'             => '<div classname="wp-block-test" style="color: red;font-size: 15px;">Content</div>',
+			),
+			'background image style is not applied if the block does not support background image' => array(
+				'theme_name'          => 'block-theme-child-with-fluid-typography',
+				'block_name'          => 'test/background-rules-are-not-output',
+				'background_settings' => array(
+					'backgroundImage' => false,
+				),
+				'background_style'    => array(
+					'backgroundImage' => array(
+						'url'    => 'https://example.com/image.jpg',
+						'source' => 'file',
+					),
+				),
+				'expected_wrapper'    => '<div>Content</div>',
+				'wrapper'             => '<div>Content</div>',
+			),
+		);
+	}
+}
diff --git a/tests/block-template-utils.php b/tests/block-template-utils.php
index 5d42207aa7..b06e931529 100644
--- a/tests/block-template-utils.php
+++ b/tests/block-template-utils.php
@@ -101,6 +101,7 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( 'My Template', $template->title );
 		$this->assertSame( 'Description of my template', $template->description );
 		$this->assertSame( 'wp_template', $template->type );
+		$this->assertSame( self::$template_post->post_modified, $template->modified, 'Template result properties match' );
 
 		// Test template parts.
 		$template_part = _build_block_template_result_from_post(
@@ -117,6 +118,7 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( 'Description of my template part', $template_part->description );
 		$this->assertSame( 'wp_template_part', $template_part->type );
 		$this->assertSame( WP_TEMPLATE_PART_AREA_HEADER, $template_part->area );
+		$this->assertSame( self::$template_part_post->post_modified, $template_part->modified, 'Template part result properties match' );
 	}
 
 	public function test_build_block_template_result_from_file() {
@@ -133,9 +135,10 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( 'single', $template->slug );
 		$this->assertSame( 'publish', $template->status );
 		$this->assertSame( 'theme', $template->source );
-		$this->assertSame( 'Single', $template->title );
+		$this->assertSame( 'Single Posts', $template->title );
 		$this->assertSame( 'Displays single posts on your website unless a custom template has been applied to that post or a dedicated template exists.', $template->description );
 		$this->assertSame( 'wp_template', $template->type );
+		$this->assertEmpty( $template->modified );
 
 		// Test template parts.
 		$template_part = _build_block_template_result_from_file(
@@ -155,8 +158,166 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( '', $template_part->description );
 		$this->assertSame( 'wp_template_part', $template_part->type );
 		$this->assertSame( WP_TEMPLATE_PART_AREA_HEADER, $template_part->area );
+		$this->assertEmpty( $template_part->modified );
 	}
 
+	/**
+	 * @ticket 59325
+	 *
+	 * @covers ::_build_block_template_result_from_file
+	 *
+	 * @dataProvider data_build_block_template_result_from_file_injects_theme_attribute
+	 *
+	 * @param string $filename The template's filename.
+	 * @param string $expected The expected block markup.
+	 */
+	public function test_build_block_template_result_from_file_injects_theme_attribute( $filename, $expected ) {
+		$template = _build_block_template_result_from_file(
+			array(
+				'slug' => 'single',
+				'path' => DIR_TESTDATA . "/templates/$filename",
+			),
+			'wp_template'
+		);
+		$this->assertSame( $expected, $template->content );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_build_block_template_result_from_file_injects_theme_attribute() {
+		$theme = 'block-theme';
+		return array(
+			'a template with a template part block'  => array(
+				'filename' => 'template-with-template-part.html',
+				'expected' => sprintf(
+					'<!-- wp:template-part {"slug":"header","align":"full","tagName":"header","className":"site-header","theme":"%s"} /-->',
+					$theme
+				),
+			),
+			'a template with a template part block nested inside another block' => array(
+				'filename' => 'template-with-nested-template-part.html',
+				'expected' => sprintf(
+					'<!-- wp:group -->
+<!-- wp:template-part {"slug":"header","align":"full","tagName":"header","className":"site-header","theme":"%s"} /-->
+<!-- /wp:group -->',
+					$theme
+				),
+			),
+			'a template with a template part block with an existing theme attribute' => array(
+				'filename' => 'template-with-template-part-with-existing-theme-attribute.html',
+				'expected' => '<!-- wp:template-part {"slug":"header","theme":"fake-theme","align":"full","tagName":"header","className":"site-header"} /-->',
+			),
+			'a template with no template part block' => array(
+				'filename' => 'template.html',
+				'expected' => '<!-- wp:paragraph -->
+<p>Just a paragraph</p>
+<!-- /wp:paragraph -->',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 59338
+	 *
+	 * @covers ::_inject_theme_attribute_in_template_part_block
+	 */
+	public function test_inject_theme_attribute_in_template_part_block() {
+		$template_part_block = array(
+			'blockName'    => 'core/template-part',
+			'attrs'        => array(
+				'slug'      => 'header',
+				'align'     => 'full',
+				'tagName'   => 'header',
+				'className' => 'site-header',
+			),
+			'innerHTML'    => '',
+			'innerContent' => array(),
+			'innerBlocks'  => array(),
+		);
+
+		_inject_theme_attribute_in_template_part_block( $template_part_block );
+		$expected = array(
+			'blockName'    => 'core/template-part',
+			'attrs'        => array(
+				'slug'      => 'header',
+				'align'     => 'full',
+				'tagName'   => 'header',
+				'className' => 'site-header',
+				'theme'     => get_stylesheet(),
+			),
+			'innerHTML'    => '',
+			'innerContent' => array(),
+			'innerBlocks'  => array(),
+		);
+		$this->assertSame(
+			$expected,
+			$template_part_block,
+			'`theme` attribute was not correctly injected in template part block.'
+		);
+	}
+
+	/**
+	 * @ticket 59338
+	 *
+	 * @covers ::_inject_theme_attribute_in_template_part_block
+	 */
+	public function test_not_inject_theme_attribute_in_template_part_block_theme_attribute_exists() {
+		$template_part_block = array(
+			'blockName'    => 'core/template-part',
+			'attrs'        => array(
+				'slug'      => 'header',
+				'align'     => 'full',
+				'tagName'   => 'header',
+				'className' => 'site-header',
+				'theme'     => 'fake-theme',
+			),
+			'innerHTML'    => '',
+			'innerContent' => array(),
+			'innerBlocks'  => array(),
+		);
+
+		$expected = $template_part_block;
+		_inject_theme_attribute_in_template_part_block( $template_part_block );
+		$this->assertSame(
+			$expected,
+			$template_part_block,
+			'Existing `theme` attribute in template part block was not respected by attribute injection.'
+		);
+	}
+
+	/**
+	 * @ticket 59338
+	 *
+	 * @covers ::_inject_theme_attribute_in_template_part_block
+	 */
+	public function test_not_inject_theme_attribute_non_template_part_block() {
+		$non_template_part_block = array(
+			'blockName'    => 'core/post-content',
+			'attrs'        => array(),
+			'innerHTML'    => '',
+			'innerContent' => array(),
+			'innerBlocks'  => array(),
+		);
+
+		$expected = $non_template_part_block;
+		_inject_theme_attribute_in_template_part_block( $non_template_part_block );
+		$this->assertSame(
+			$expected,
+			$non_template_part_block,
+			'`theme` attribute injection modified non-template-part block.'
+		);
+	}
+
+	/**
+	 * @ticket 59452
+	 *
+	 * @covers ::_inject_theme_attribute_in_block_template_content
+	 *
+	 * @expectedDeprecated _inject_theme_attribute_in_block_template_content
+	 */
 	public function test_inject_theme_attribute_in_block_template_content() {
 		$theme                           = get_stylesheet();
 		$content_without_theme_attribute = '<!-- wp:template-part {"slug":"header","align":"full", "tagName":"header","className":"site-header"} /-->';
@@ -200,13 +361,39 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 54448
+	 * @ticket 59460
 	 *
 	 * @dataProvider data_remove_theme_attribute_in_block_template_content
+	 *
+	 * @expectedDeprecated _remove_theme_attribute_in_block_template_content
 	 */
 	public function test_remove_theme_attribute_in_block_template_content( $template_content, $expected ) {
 		$this->assertSame( $expected, _remove_theme_attribute_in_block_template_content( $template_content ) );
 	}
 
+	/**
+	 * @ticket 59460
+	 *
+	 * @covers ::_remove_theme_attribute_from_template_part_block
+	 * @covers ::traverse_and_serialize_blocks
+	 *
+	 * @dataProvider data_remove_theme_attribute_in_block_template_content
+	 *
+	 * @param string $template_content The template markup.
+	 * @param string $expected         The expected markup after removing the theme attribute from Template Part blocks.
+	 */
+	public function test_remove_theme_attribute_from_template_part_block( $template_content, $expected ) {
+		$template_content_parsed_blocks = parse_blocks( $template_content );
+
+		$this->assertSame(
+			$expected,
+			traverse_and_serialize_blocks(
+				$template_content_parsed_blocks,
+				'_remove_theme_attribute_from_template_part_block'
+			)
+		);
+	}
+
 	public function data_remove_theme_attribute_in_block_template_content() {
 		return array(
 			array(
diff --git a/tests/block-template.php b/tests/block-template.php
index 16c0978813..7b4cbf3322 100644
--- a/tests/block-template.php
+++ b/tests/block-template.php
@@ -184,4 +184,194 @@ class Tests_Block_Template extends WP_UnitTestCase {
 		$resolved_template_path = locate_block_template( '', 'search', array() );
 		$this->assertSame( '', $resolved_template_path );
 	}
+
+	/**
+	 * Tests that `get_the_block_template_html()` wraps block parsing into the query loop when on a singular template.
+	 *
+	 * This is necessary since block themes do not include the necessary blocks to trigger the main query loop, and
+	 * since there is only a single post in the main query loop in such cases anyway.
+	 *
+	 * @ticket 58154
+	 * @covers ::get_the_block_template_html
+	 */
+	public function test_get_the_block_template_html_enforces_singular_query_loop() {
+		global $_wp_current_template_content, $wp_query, $wp_the_query;
+
+		// Register test block to log `in_the_loop()` results.
+		$in_the_loop_logs = array();
+		$this->register_in_the_loop_logger_block( $in_the_loop_logs );
+
+		// Set main query to single post.
+		$post_id      = self::factory()->post->create( array( 'post_title' => 'A single post' ) );
+		$wp_query     = new WP_Query( array( 'p' => $post_id ) );
+		$wp_the_query = $wp_query;
+
+		// Use block template that just renders post title and the above test block.
+		$_wp_current_template_content = '<!-- wp:post-title /--><!-- wp:test/in-the-loop-logger /-->';
+
+		$expected  = '<div class="wp-site-blocks">';
+		$expected .= '<h2 class="wp-block-post-title">A single post</h2>';
+		$expected .= '</div>';
+
+		$output = get_the_block_template_html();
+		$this->unregister_in_the_loop_logger_block();
+		$this->assertSame( $expected, $output, 'Unexpected block template output' );
+		$this->assertSame( array( true ), $in_the_loop_logs, 'Main query loop was not triggered' );
+	}
+
+	/**
+	 * Tests that `get_the_block_template_html()` does not start the main query loop generally.
+	 *
+	 * @ticket 58154
+	 * @covers ::get_the_block_template_html
+	 */
+	public function test_get_the_block_template_html_does_not_generally_enforce_loop() {
+		global $_wp_current_template_content, $wp_query, $wp_the_query;
+
+		// Register test block to log `in_the_loop()` results.
+		$in_the_loop_logs = array();
+		$this->register_in_the_loop_logger_block( $in_the_loop_logs );
+
+		// Set main query to a general post query (i.e. not for a specific post).
+		$post_id      = self::factory()->post->create(
+			array(
+				'post_title'   => 'A single post',
+				'post_content' => 'The content.',
+			)
+		);
+		$wp_query     = new WP_Query(
+			array(
+				'post_type'   => 'post',
+				'post_status' => 'publish',
+			)
+		);
+		$wp_the_query = $wp_query;
+
+		/*
+		 * Use block template that renders the above test block, followed by a main query loop.
+		 * `get_the_block_template_html()` should not start the loop, but the `core/query` and `core/post-template`
+		 * blocks should.
+		 */
+		$_wp_current_template_content  = '<!-- wp:test/in-the-loop-logger /-->';
+		$_wp_current_template_content .= '<!-- wp:query {"query":{"inherit":true}} -->';
+		$_wp_current_template_content .= '<!-- wp:post-template -->';
+		$_wp_current_template_content .= '<!-- wp:post-title /-->';
+		$_wp_current_template_content .= '<!-- wp:post-content /--><!-- wp:test/in-the-loop-logger /-->';
+		$_wp_current_template_content .= '<!-- /wp:post-template -->';
+		$_wp_current_template_content .= '<!-- /wp:query -->';
+
+		$expected  = '<div class="wp-site-blocks">';
+		$expected .= '<ul class="wp-block-post-template is-layout-flow wp-block-post-template-is-layout-flow wp-block-query-is-layout-flow">';
+		$expected .= '<li class="wp-block-post post-' . $post_id . ' post type-post status-publish format-standard hentry category-uncategorized">';
+		$expected .= '<h2 class="wp-block-post-title">A single post</h2>';
+		$expected .= '<div class="entry-content wp-block-post-content is-layout-flow wp-block-post-content-is-layout-flow">' . wpautop( 'The content.' ) . '</div>';
+		$expected .= '</li>';
+		$expected .= '</ul>';
+		$expected .= '</div>';
+
+		$output = get_the_block_template_html();
+		$this->unregister_in_the_loop_logger_block();
+		$this->assertSame( $expected, $output, 'Unexpected block template output' );
+		$this->assertSame( array( false, true ), $in_the_loop_logs, 'Main query loop was triggered incorrectly' );
+	}
+
+	/**
+	 * @ticket 58319
+	 *
+	 * @covers ::get_block_theme_folders
+	 *
+	 * @dataProvider data_get_block_theme_folders
+	 *
+	 * @param string   $theme    The theme's stylesheet.
+	 * @param string[] $expected The expected associative array of block theme folders.
+	 */
+	public function test_get_block_theme_folders( $theme, $expected ) {
+		$wp_theme = wp_get_theme( $theme );
+		$wp_theme->cache_delete(); // Clear cache.
+
+		$this->assertSame( $expected, get_block_theme_folders( $theme ), 'Incorrect block theme folders were retrieved.' );
+		$reflection = new ReflectionMethod( $wp_theme, 'cache_get' );
+		$reflection->setAccessible( true );
+		$theme_cache  = $reflection->invoke( $wp_theme, 'theme' );
+		$cached_value = $theme_cache['block_template_folders'];
+		$reflection->setAccessible( false );
+
+		$this->assertSame( $expected, $cached_value, 'The cached value is incorrect.' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_block_theme_folders() {
+		return array(
+			'block-theme'                       => array(
+				'block-theme',
+				array(
+					'wp_template'      => 'templates',
+					'wp_template_part' => 'parts',
+				),
+			),
+			'block-theme-deprecated-path'       => array(
+				'block-theme-deprecated-path',
+				array(
+					'wp_template'      => 'block-templates',
+					'wp_template_part' => 'block-template-parts',
+				),
+			),
+			'block-theme-child'                 => array(
+				'block-theme-child',
+				array(
+					'wp_template'      => 'templates',
+					'wp_template_part' => 'parts',
+				),
+			),
+			'block-theme-child-deprecated-path' => array(
+				'block-theme-child-deprecated-path',
+				array(
+					'wp_template'      => 'block-templates',
+					'wp_template_part' => 'block-template-parts',
+				),
+			),
+			'this-is-an-invalid-theme'          => array(
+				'this-is-an-invalid-theme',
+				array(
+					'wp_template'      => 'templates',
+					'wp_template_part' => 'parts',
+				),
+			),
+			'null'                              => array(
+				null,
+				array(
+					'wp_template'      => 'templates',
+					'wp_template_part' => 'parts',
+				),
+			),
+		);
+	}
+
+	/**
+	 * Registers a test block to log `in_the_loop()` results.
+	 *
+	 * @param array $in_the_loop_logs Array to log function results in. Passed by reference.
+	 */
+	private function register_in_the_loop_logger_block( array &$in_the_loop_logs ) {
+		register_block_type(
+			'test/in-the-loop-logger',
+			array(
+				'render_callback' => function () use ( &$in_the_loop_logs ) {
+					$in_the_loop_logs[] = in_the_loop();
+					return '';
+				},
+			)
+		);
+	}
+
+	/**
+	 * Unregisters the test block registered by the `register_in_the_loop_logger_block()` method.
+	 */
+	private function unregister_in_the_loop_logger_block() {
+		unregister_block_type( 'test/in-the-loop-logger' );
+	}
 }
diff --git a/tests/blocks/blockHooks.php b/tests/blocks/blockHooks.php
new file mode 100644
index 0000000000..4f7f419337
--- /dev/null
+++ b/tests/blocks/blockHooks.php
@@ -0,0 +1,122 @@
+<?php
+/**
+ * Tests for block hooks feature functions.
+ *
+ * @package WordPress
+ * @subpackage Blocks
+ *
+ * @since 6.4.0
+ *
+ * @group blocks
+ */
+class Tests_Blocks_BlockHooks extends WP_UnitTestCase {
+
+	/**
+	 * Tear down after each test.
+	 *
+	 * @since 6.4.0
+	 */
+	public function tear_down() {
+		$registry = WP_Block_Type_Registry::get_instance();
+
+		foreach ( array( 'tests/my-block', 'tests/my-container-block' ) as $block_name ) {
+			if ( $registry->is_registered( $block_name ) ) {
+				$registry->unregister( $block_name );
+			}
+		}
+
+		parent::tear_down();
+	}
+
+	/**
+	 * @ticket 59383
+	 *
+	 * @covers ::get_hooked_blocks
+	 */
+	public function test_get_hooked_blocks_no_match_found() {
+		$result = get_hooked_blocks( 'tests/no-hooked-blocks' );
+
+		$this->assertSame( array(), $result );
+	}
+
+	/**
+	 * @ticket 59383
+	 *
+	 * @covers ::get_hooked_blocks
+	 */
+	public function test_get_hooked_blocks_matches_found() {
+		register_block_type(
+			'tests/injected-one',
+			array(
+				'block_hooks' => array(
+					'tests/hooked-at-before'           => 'before',
+					'tests/hooked-at-after'            => 'after',
+					'tests/hooked-at-before-and-after' => 'before',
+				),
+			)
+		);
+		register_block_type(
+			'tests/injected-two',
+			array(
+				'block_hooks' => array(
+					'tests/hooked-at-before'           => 'before',
+					'tests/hooked-at-after'            => 'after',
+					'tests/hooked-at-before-and-after' => 'after',
+					'tests/hooked-at-first-child'      => 'first_child',
+					'tests/hooked-at-last-child'       => 'last_child',
+				),
+			)
+		);
+
+		$this->assertSame(
+			array(
+				'before' => array(
+					'tests/injected-one',
+					'tests/injected-two',
+				),
+			),
+			get_hooked_blocks( 'tests/hooked-at-before' ),
+			'block hooked at the before position'
+		);
+		$this->assertSame(
+			array(
+				'after' => array(
+					'tests/injected-one',
+					'tests/injected-two',
+				),
+			),
+			get_hooked_blocks( 'tests/hooked-at-after' ),
+			'block hooked at the after position'
+		);
+		$this->assertSame(
+			array(
+				'first_child' => array(
+					'tests/injected-two',
+				),
+			),
+			get_hooked_blocks( 'tests/hooked-at-first-child' ),
+			'block hooked at the first child position'
+		);
+		$this->assertSame(
+			array(
+				'last_child' => array(
+					'tests/injected-two',
+				),
+			),
+			get_hooked_blocks( 'tests/hooked-at-last-child' ),
+			'block hooked at the last child position'
+		);
+		$this->assertSame(
+			array(
+				'before' => array(
+					'tests/injected-one',
+				),
+				'after'  => array(
+					'tests/injected-two',
+				),
+			),
+			get_hooked_blocks( 'tests/hooked-at-before-and-after' ),
+			'block hooked before one block and after another'
+		);
+	}
+}
diff --git a/tests/blocks/context.php b/tests/blocks/context.php
index 76603b7b37..3edddcf8ef 100644
--- a/tests/blocks/context.php
+++ b/tests/blocks/context.php
@@ -109,7 +109,7 @@ class Tests_Blocks_Context extends WP_UnitTestCase {
 					'gutenberg/contextWithAssigned',
 					'gutenberg/contextWithoutDefault',
 				),
-				'render_callback' => static function( $attributes, $content, $block ) use ( &$provided_context ) {
+				'render_callback' => static function ( $attributes, $content, $block ) use ( &$provided_context ) {
 					$provided_context[] = $block->context;
 
 					return '';
@@ -149,7 +149,7 @@ class Tests_Blocks_Context extends WP_UnitTestCase {
 			'gutenberg/test-context-consumer',
 			array(
 				'uses_context'    => array( 'postId', 'postType' ),
-				'render_callback' => static function( $attributes, $content, $block ) use ( &$provided_context ) {
+				'render_callback' => static function ( $attributes, $content, $block ) use ( &$provided_context ) {
 					$provided_context[] = $block->context;
 
 					return '';
@@ -182,7 +182,7 @@ class Tests_Blocks_Context extends WP_UnitTestCase {
 			'gutenberg/test-context-consumer',
 			array(
 				'uses_context'    => array( 'example' ),
-				'render_callback' => static function( $attributes, $content, $block ) use ( &$provided_context ) {
+				'render_callback' => static function ( $attributes, $content, $block ) use ( &$provided_context ) {
 					$provided_context[] = $block->context;
 
 					return '';
@@ -190,7 +190,7 @@ class Tests_Blocks_Context extends WP_UnitTestCase {
 			)
 		);
 
-		$filter_block_context = static function( $context ) {
+		$filter_block_context = static function ( $context ) {
 			$context['example'] = 'ok';
 			return $context;
 		};
@@ -205,5 +205,4 @@ class Tests_Blocks_Context extends WP_UnitTestCase {
 
 		$this->assertSame( array( 'example' => 'ok' ), $provided_context[0] );
 	}
-
 }
diff --git a/tests/blocks/editor.php b/tests/blocks/editor.php
index ef8f1cd795..0682839605 100644
--- a/tests/blocks/editor.php
+++ b/tests/blocks/editor.php
@@ -18,6 +18,8 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 
 		parent::set_up();
 
+		remove_action( 'wp_print_styles', 'print_emoji_styles' );
+
 		$args = array(
 			'post_title' => 'Example',
 		);
@@ -27,12 +29,17 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 		global $wp_rest_server;
 		$wp_rest_server = new Spy_REST_Server();
 		do_action( 'rest_api_init', $wp_rest_server );
+
+		global $post_ID;
+		$post_ID = 1;
 	}
 
 	public function tear_down() {
 		/** @var WP_REST_Server $wp_rest_server */
 		global $wp_rest_server;
 		$wp_rest_server = null;
+		global $post_ID;
+		$post_ID = null;
 		parent::tear_down();
 	}
 
@@ -60,7 +67,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 
 	public function filter_set_block_editor_settings_post( $editor_settings, $post ) {
 		if ( empty( $post ) ) {
-			return $allowed_block_types;
+			return $editor_settings;
 		}
 
 		return array(
@@ -234,7 +241,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 				),
 				array(
 					'slug'  => 'reusable',
-					'title' => 'Reusable Blocks',
+					'title' => 'Patterns',
 					'icon'  => null,
 				),
 			),
@@ -302,7 +309,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 		// Force the return value of wp_max_upload_size() to be 500.
 		add_filter(
 			'upload_size_limit',
-			function() {
+			static function () {
 				return 500;
 			}
 		);
@@ -396,6 +403,65 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 		$this->assertSame( 12345, $settings['maxUploadFileSize'] );
 	}
 
+	/**
+	 * @ticket 58534
+	 */
+	public function test_wp_get_first_block() {
+		$block_name               = 'core/paragraph';
+		$blocks                   = array(
+			array(
+				'blockName' => 'core/image',
+			),
+			array(
+				'blockName' => $block_name,
+				'attrs'     => array(
+					'content' => 'Hello World!',
+				),
+			),
+			array(
+				'blockName' => 'core/heading',
+			),
+			array(
+				'blockName' => $block_name,
+			),
+		);
+		$blocks_with_no_paragraph = array(
+			array(
+				'blockName' => 'core/image',
+			),
+			array(
+				'blockName' => 'core/heading',
+			),
+		);
+
+		$this->assertSame( $blocks[1], wp_get_first_block( $blocks, $block_name ) );
+
+		$this->assertSame( array(), wp_get_first_block( $blocks_with_no_paragraph, $block_name ) );
+	}
+
+	/**
+	 * @ticket 58534
+	 */
+	public function test_wp_get_post_content_block_attributes() {
+		$attributes_with_layout = array(
+			'layout' => array(
+				'type' => 'constrained',
+			),
+		);
+		// With no block theme, expect null.
+		$this->assertNull( wp_get_post_content_block_attributes() );
+
+		switch_theme( 'block-theme' );
+
+		$this->assertSame( $attributes_with_layout, wp_get_post_content_block_attributes() );
+	}
+
+	public function test_wp_get_post_content_block_attributes_no_layout() {
+		switch_theme( 'block-theme-post-content-default' );
+
+		$this->assertSame( array(), wp_get_post_content_block_attributes() );
+	}
+
 	/**
 	 * @ticket 53458
 	 */
@@ -456,10 +522,31 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 		$this->assertSameSets( array( 'rem' ), $settings['enableCustomUnits'] );
 		// settings.spacing.customPadding
 		$this->assertTrue( $settings['enableCustomSpacing'] );
+		// settings.postContentAttributes
+		$this->assertSameSets(
+			array(
+				'layout' => array(
+					'type' => 'constrained',
+				),
+			),
+			$settings['postContentAttributes']
+		);
 
 		switch_theme( WP_DEFAULT_THEME );
 	}
 
+	/**
+	 * @ticket 59358
+	 */
+	public function test_get_block_editor_settings_without_post_content_block() {
+
+		$post_editor_context = new WP_Block_Editor_Context( array( 'post' => get_post() ) );
+
+		$settings = get_block_editor_settings( array(), $post_editor_context );
+
+		$this->assertArrayNotHasKey( 'postContentAttributes', $settings );
+	}
+
 	/**
 	 * @ticket 52920
 	 * @expectedDeprecated block_editor_settings
diff --git a/tests/blocks/getBlockAssetUrl.php b/tests/blocks/getBlockAssetUrl.php
new file mode 100644
index 0000000000..ee1c541cf0
--- /dev/null
+++ b/tests/blocks/getBlockAssetUrl.php
@@ -0,0 +1,112 @@
+<?php
+/**
+ * Tests for block asset urls.
+ *
+ * @package WordPress
+ * @subpackage Blocks
+ *
+ * @since 6.4.0
+ *
+ * @group blocks
+ * @covers ::get_block_asset_url
+ */
+class Tests_Get_Block_Asset_Url extends WP_UnitTestCase {
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string[]
+	 */
+	private $orig_theme_dir;
+
+	public function set_up() {
+		global $wp_theme_directories;
+
+		parent::set_up();
+
+		// Sets up the `wp-content/themes/` directory to ensure consistency when running tests.
+		$this->orig_theme_dir = $wp_theme_directories;
+		$wp_theme_directories = array( WP_CONTENT_DIR . '/themes', realpath( DIR_TESTDATA . '/themedir1' ) );
+
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+	}
+
+	public function tear_down() {
+		global $wp_theme_directories;
+
+		$wp_theme_directories = $this->orig_theme_dir;
+
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+
+		parent::tear_down();
+	}
+
+	/**
+	 * @ticket 58525
+	 */
+	public function test_core_block() {
+		$path = ABSPATH . WPINC . '/blocks/file/view.min.js';
+		$url  = get_block_asset_url( $path );
+
+		$this->assertStringNotContainsString( ABSPATH . WPINC, 'The return block asset url should not contain include path.' );
+		$this->assertSame( includes_url( '/blocks/file/view.min.js' ), $url, 'The return block asset url should match includes url.' );
+	}
+
+	/**
+	 * @ticket 58525
+	 */
+	public function test_parent_theme() {
+		switch_theme( 'block-theme' );
+
+		$path = wp_normalize_path( realpath( DIR_TESTDATA . '/themedir1/block-theme/blocks/example-block/view.js' ) );
+		$url  = get_block_asset_url( $path );
+
+		$this->assertSame( get_template_directory_uri() . '/blocks/example-block/view.js', $url );
+	}
+
+	/**
+	 * @ticket 58525
+	 */
+	public function test_child_theme() {
+		switch_theme( 'block-theme-child' );
+
+		$path = wp_normalize_path( realpath( DIR_TESTDATA . '/themedir1/block-theme-child/blocks/example-block/view.js' ) );
+		$url  = get_block_asset_url( $path );
+
+		$this->assertSame( get_stylesheet_directory_uri() . '/blocks/example-block/view.js', $url );
+	}
+
+	/**
+	 * @ticket 58525
+	 */
+	public function test_plugin() {
+		$path = WP_PLUGIN_DIR . '/test-plugin/blocks/example-block/view.js';
+		$url  = get_block_asset_url( $path );
+
+		$this->assertStringNotContainsString( WP_PLUGIN_DIR, $url, 'The return block asset url should not contain plugin path.' );
+		$this->assertSame( plugins_url( 'view.js', $path ), $url, 'The return block asset url should match plugin url.' );
+		$this->assertStringStartsWith( WP_PLUGIN_URL, $url, 'The return block asset url should contain the url that support with the mu plugin url.' );
+	}
+
+	/**
+	 * @ticket 58525
+	 */
+	public function test_muplugin() {
+		$path = WPMU_PLUGIN_DIR . '/test-plugin/example-block/view.js';
+		$url  = get_block_asset_url( $path );
+
+		$this->assertStringNotContainsString( WPMU_PLUGIN_DIR, $url, 'The return block asset url should not contain plugin path.' );
+		$this->assertSame( plugins_url( 'view.js', $path ), $url, 'The return block asset url should match plugin url.' );
+		$this->assertStringStartsWith( WPMU_PLUGIN_URL, $url, 'The return block asset url should contain the url that support with the mu plugin url.' );
+	}
+
+	/**
+	 * @ticket 58525
+	 */
+	public function test_empty() {
+		$url = get_block_asset_url( '' );
+
+		$this->assertFalse( $url );
+	}
+}
diff --git a/tests/blocks/getBlockTemplates.php b/tests/blocks/getBlockTemplates.php
index 50554479d0..9b1729f93b 100644
--- a/tests/blocks/getBlockTemplates.php
+++ b/tests/blocks/getBlockTemplates.php
@@ -101,7 +101,7 @@ class Tests_Blocks_GetBlockTemplates extends WP_UnitTestCase {
 	 */
 	private function get_template_ids( $templates ) {
 		return array_map(
-			static function( $template ) {
+			static function ( $template ) {
 				return $template->id;
 			},
 			$templates
@@ -161,7 +161,7 @@ class Tests_Blocks_GetBlockTemplates extends WP_UnitTestCase {
 		$this->assertNotEmpty( $block_templates, 'get_block_templates() must return a non-empty value.' );
 
 		$block_template_ids = wp_list_pluck( $block_templates, 'id' );
-		$this->assertSame( count( array_unique( $block_template_ids ) ), count( $block_template_ids ), $error_message );
+		$this->assertCount( count( array_unique( $block_template_ids ) ), $block_template_ids, $error_message );
 	}
 
 	/**
diff --git a/tests/blocks/register.php b/tests/blocks/register.php
index e1cd22db45..3e55206037 100644
--- a/tests/blocks/register.php
+++ b/tests/blocks/register.php
@@ -270,6 +270,21 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$result   = register_block_script_handle( $metadata, 'script' );
 
 		$this->assertSame( 'unit-tests-test-block-script', $result );
+
+		// Test the behavior directly within the unit test
+		$this->assertFalse(
+			strpos(
+				wp_normalize_path( realpath( dirname( $metadata['file'] ) . '/' . $metadata['script'] ) ),
+				trailingslashit( wp_normalize_path( get_template_directory() ) )
+			) === 0
+		);
+
+		$this->assertFalse(
+			strpos(
+				wp_normalize_path( realpath( dirname( $metadata['file'] ) . '/' . $metadata['script'] ) ),
+				trailingslashit( wp_normalize_path( get_stylesheet_directory() ) )
+			) === 0
+		);
 	}
 
 	/**
@@ -322,11 +337,82 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$this->assertFalse( $result );
 	}
 
+	/**
+	 * @ticket 58605
+	 *
+	 * @dataProvider data_register_block_style_handle_uses_correct_core_stylesheet
+	 *
+	 * @param string      $block_json_path Path to the `block.json` file, relative to ABSPATH.
+	 * @param string      $style_field     Either 'style' or 'editorStyle'.
+	 * @param string|bool $expected_path   Expected path of registered stylesheet, relative to ABSPATH.
+	 */
+	public function test_register_block_style_handle_uses_correct_core_stylesheet( $block_json_path, $style_field, $expected_path ) {
+		$metadata_file = ABSPATH . $block_json_path;
+		$metadata      = wp_json_file_decode( $metadata_file, array( 'associative' => true ) );
+
+		$block_name = str_replace( 'core/', '', $metadata['name'] );
+
+		// Normalize metadata similar to `register_block_type_from_metadata()`.
+		$metadata['file'] = wp_normalize_path( realpath( $metadata_file ) );
+		if ( ! isset( $metadata['style'] ) ) {
+			$metadata['style'] = "wp-block-$block_name";
+		}
+		if ( ! isset( $metadata['editorStyle'] ) ) {
+			$metadata['editorStyle'] = "wp-block-{$block_name}-editor";
+		}
+
+		// Ensure block assets are separately registered.
+		add_filter( 'should_load_separate_core_block_assets', '__return_true' );
+
+		/*
+		 * Account for minified asset path and ensure the file exists.
+		 * This may not be the case in the testing environment since it requires the build process to place them.
+		 */
+		if ( is_string( $expected_path ) ) {
+			$expected_path = str_replace( '.css', wp_scripts_get_suffix() . '.css', $expected_path );
+			self::touch( ABSPATH . $expected_path );
+		}
+
+		$result = register_block_style_handle( $metadata, $style_field );
+		$this->assertSame( $metadata[ $style_field ], $result, 'Core block registration failed' );
+		if ( $expected_path ) {
+			$this->assertStringEndsWith( $expected_path, wp_styles()->registered[ $result ]->src, 'Core block stylesheet path incorrect' );
+		} else {
+			$this->assertFalse( wp_styles()->registered[ $result ]->src, 'Core block stylesheet src should be false' );
+		}
+	}
+
+	public function data_register_block_style_handle_uses_correct_core_stylesheet() {
+		return array(
+			'block with style'           => array(
+				WPINC . '/blocks/archives/block.json',
+				'style',
+				WPINC . '/blocks/archives/style.css',
+			),
+			'block with editor style'    => array(
+				WPINC . '/blocks/archives/block.json',
+				'editorStyle',
+				WPINC . '/blocks/archives/editor.css',
+			),
+			'block without style'        => array(
+				WPINC . '/blocks/widget-group/block.json',
+				'style',
+				false,
+			),
+			'block without editor style' => array(
+				WPINC . '/blocks/widget-group/block.json',
+				'editorStyle',
+				false,
+			),
+		);
+	}
+
 	/**
 	 * @ticket 50263
 	 */
 	public function test_handle_passed_register_block_style_handle() {
 		$metadata = array(
+			'name'  => 'test-block',
 			'style' => 'test-style-handle',
 		);
 		$result   = register_block_style_handle( $metadata, 'style' );
@@ -336,6 +422,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 
 	public function test_handles_passed_register_block_style_handles() {
 		$metadata = array(
+			'name'  => 'test-block',
 			'style' => array( 'test-style-handle', 'test-style-handle-2' ),
 		);
 
@@ -366,6 +453,21 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 			wp_normalize_path( realpath( DIR_TESTDATA . '/blocks/notice/block.css' ) ),
 			wp_normalize_path( wp_styles()->get_data( 'unit-tests-test-block-style', 'path' ) )
 		);
+
+		// Test the behavior directly within the unit test
+		$this->assertFalse(
+			strpos(
+				wp_normalize_path( realpath( dirname( $metadata['file'] ) . '/' . $metadata['style'] ) ),
+				trailingslashit( wp_normalize_path( get_template_directory() ) )
+			) === 0
+		);
+
+		$this->assertFalse(
+			strpos(
+				wp_normalize_path( realpath( dirname( $metadata['file'] ) . '/' . $metadata['style'] ) ),
+				trailingslashit( wp_normalize_path( get_stylesheet_directory() ) )
+			) === 0
+		);
 	}
 
 	/**
@@ -453,6 +555,26 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$this->assertFalse( wp_styles()->get_data( $expected_style_handle, 'rtl' ) );
 	}
 
+	/**
+	 * @ticket 58528
+	 *
+	 * @covers ::register_block_style_handle
+	 */
+	public function test_success_register_block_style_handle_exists() {
+		$expected_style_handle = 'block-theme-example-block-editor-style';
+		wp_register_style( $expected_style_handle, false );
+		switch_theme( 'block-theme' );
+
+		$metadata = array(
+			'file'        => wp_normalize_path( get_theme_file_path( 'blocks/example-block/block.json' ) ),
+			'name'        => 'block-theme/example-block',
+			'editorStyle' => 'file:./editor-style.css',
+		);
+		$result   = register_block_style_handle( $metadata, 'editorStyle' );
+
+		$this->assertSame( $expected_style_handle, $result );
+	}
+
 	/**
 	 * Tests that the function returns false when the `block.json` is not found
 	 * in the WordPress core.
@@ -483,6 +605,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 *
 	 * @ticket 50263
 	 * @ticket 50328
+	 * @ticket 57585
 	 */
 	public function test_block_registers_with_metadata_fixture() {
 		$result = register_block_type_from_metadata(
@@ -515,6 +638,23 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 			$result->provides_context
 		);
 		$this->assertSameSets( array( 'groupId' ), $result->uses_context );
+		// @ticket 57585
+		$this->assertSame(
+			array( 'root' => '.wp-block-notice' ),
+			$result->selectors,
+			'Block type should contain selectors from metadata.'
+		);
+		// @ticket 59346
+		$this->assertSameSets(
+			array(
+				'tests/before'      => 'before',
+				'tests/after'       => 'after',
+				'tests/first-child' => 'first_child',
+				'tests/last-child'  => 'last_child',
+			),
+			$result->block_hooks,
+			'Block type should contain block hooks from metadata.'
+		);
 		$this->assertSame(
 			array(
 				'align'             => true,
@@ -621,7 +761,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 
 		$registry   = WP_Block_Type_Registry::get_instance();
 		$block_type = $registry->get_registered( 'core/test-static' );
-		$this->assertObjectHasAttribute( 'editor_script_handles', $block_type );
+		$this->assertObjectHasProperty( 'editor_script_handles', $block_type );
 		$actual_script         = $block_type->editor_script;
 		$actual_script_handles = $block_type->editor_script_handles;
 
@@ -687,7 +827,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 
 		$registry   = WP_Block_Type_Registry::get_instance();
 		$block_type = $registry->get_registered( 'core/test-static' );
-		$this->assertObjectHasAttribute( 'editor_script_handles', $block_type );
+		$this->assertObjectHasProperty( 'editor_script_handles', $block_type );
 		$actual_script         = $block_type->editor_script;
 		$actual_script_handles = $block_type->editor_script_handles;
 
@@ -828,7 +968,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 * @ticket 49615
 	 */
 	public function test_filter_block_registration() {
-		$filter_registration = static function( $args, $name ) {
+		$filter_registration = static function ( $args, $name ) {
 			$args['attributes'] = array( $name => array( 'type' => 'boolean' ) );
 			return $args;
 		};
@@ -846,7 +986,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 * @ticket 52138
 	 */
 	public function test_filter_block_registration_metadata() {
-		$filter_metadata_registration = static function( $metadata ) {
+		$filter_metadata_registration = static function ( $metadata ) {
 			$metadata['apiVersion'] = 3;
 			return $metadata;
 		};
@@ -864,7 +1004,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 * @ticket 52138
 	 */
 	public function test_filter_block_registration_metadata_settings() {
-		$filter_metadata_registration = static function( $settings, $metadata ) {
+		$filter_metadata_registration = static function ( $settings, $metadata ) {
 			$settings['api_version'] = $metadata['apiVersion'] + 1;
 			return $settings;
 		};
@@ -934,4 +1074,22 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$actual = register_block_style( 'core/query', $block_styles );
 		$this->assertTrue( $actual );
 	}
+
+	/**
+	 * @ticket 59346
+	 *
+	 * @covers ::register_block_type
+	 *
+	 * @expectedIncorrectUsage register_block_type_from_metadata
+	 */
+	public function test_register_block_hooks_targeting_itself() {
+		$block_type = register_block_type(
+			DIR_TESTDATA . '/blocks/hooked-block-error'
+		);
+
+		$this->assertSame(
+			array( 'tests/other-block' => 'after' ),
+			$block_type->block_hooks
+		);
+	}
 }
diff --git a/tests/blocks/registerCoreBlockStyleHandles.php b/tests/blocks/registerCoreBlockStyleHandles.php
new file mode 100644
index 0000000000..a4ed1dd418
--- /dev/null
+++ b/tests/blocks/registerCoreBlockStyleHandles.php
@@ -0,0 +1,156 @@
+<?php
+
+/**
+ * Tests for block style handles.
+ *
+ * @package WordPress
+ * @subpackage Blocks
+ *
+ * @since 6.3.0
+ *
+ * @group blocks
+ *
+ * @covers ::register_core_block_style_handles
+ */
+class Tests_Blocks_registerCoreBlockStyleHandles extends WP_UnitTestCase {
+
+	/**
+	 * @var WP_Styles
+	 */
+	private $old_wp_styles;
+
+	/**
+	 * @var string
+	 */
+	private $includes_url;
+
+	const STYLE_FIELDS = array(
+		'style'       => 'style',
+		'editorStyle' => 'editor',
+	);
+
+	public function set_up() {
+		parent::set_up();
+
+		$this->old_wp_styles = $GLOBALS['wp_styles'];
+
+		$this->includes_url = includes_url();
+
+		remove_action( 'wp_default_styles', 'wp_default_styles' );
+
+		if ( empty( $GLOBALS['wp_styles'] ) ) {
+			$GLOBALS['wp_styles'] = null;
+		}
+	}
+
+	public function tear_down() {
+		$GLOBALS['wp_styles'] = $this->old_wp_styles;
+
+		add_action( 'wp_default_styles', 'wp_default_styles' );
+
+		parent::tear_down();
+	}
+
+	/**
+	 * @ticket 58528
+	 *
+	 * @dataProvider data_block_data
+	 *
+	 * @param string $name   The block name.
+	 * @param array  $schema The block's schema.
+	 */
+	public function test_wp_should_load_separate_core_block_assets_false( $name, $schema ) {
+		register_core_block_style_handles();
+
+		foreach ( self::STYLE_FIELDS as $style_field => $filename ) {
+			$style_handle = $schema[ $style_field ];
+			if ( is_array( $style_handle ) ) {
+				continue;
+			}
+
+			$this->assertArrayNotHasKey( $style_handle, $GLOBALS['wp_styles']->registered, 'The key should not exist, as this style should not be registered' );
+		}
+	}
+
+
+	/**
+	 * @ticket 58528
+	 *
+	 * @dataProvider data_block_data
+	 *
+	 * @param string $name   The block name.
+	 * @param array  $schema The block's schema.
+	 */
+	public function test_wp_should_load_separate_core_block_assets_true( $name, $schema ) {
+		add_filter( 'should_load_separate_core_block_assets', '__return_true' );
+		register_core_block_style_handles();
+
+		$wp_styles = $GLOBALS['wp_styles'];
+
+		foreach ( self::STYLE_FIELDS as $style_field => $filename ) {
+			$style_handle = $schema[ $style_field ];
+			if ( is_array( $style_handle ) ) {
+				continue;
+			}
+
+			$this->assertArrayHasKey( $style_handle, $wp_styles->registered, 'The key should exist, as this style should be registered' );
+			if ( false === $wp_styles->registered[ $style_handle ]->src ) {
+				$this->assertEmpty( $wp_styles->registered[ $style_handle ]->extra, 'If source is false, not style path should be set' );
+			} else {
+				$this->assertStringContainsString( $this->includes_url, $wp_styles->registered[ $style_handle ]->src, 'Source of style should contain the includes url' );
+				$this->assertNotEmpty( $wp_styles->registered[ $style_handle ]->extra, 'The path of the style should exist' );
+				$this->assertArrayHasKey( 'path', $wp_styles->registered[ $style_handle ]->extra, 'The path key of the style should exist in extra array' );
+				$this->assertNotEmpty( $wp_styles->registered[ $style_handle ]->extra['path'], 'The path key of the style should not be empty' );
+			}
+		}
+	}
+
+	/**
+	 * @ticket 58560
+	 *
+	 * @dataProvider data_block_data
+	 *
+	 * @param string $name The block name.
+	 */
+	public function test_wp_should_load_separate_core_block_assets_current_theme_supports( $name ) {
+		add_filter( 'should_load_separate_core_block_assets', '__return_true' );
+		add_theme_support( 'wp-block-styles' );
+		register_core_block_style_handles();
+
+		$wp_styles = $GLOBALS['wp_styles'];
+
+		$style_handle = "wp-block-{$name}-theme";
+
+		$this->assertArrayHasKey( $style_handle, $wp_styles->registered, 'The key should exist, as this style should be registered' );
+		if ( false === $wp_styles->registered[ $style_handle ]->src ) {
+			$this->assertEmpty( $wp_styles->registered[ $style_handle ]->extra, 'If source is false, not style path should be set' );
+		} else {
+			$this->assertStringContainsString( $this->includes_url, $wp_styles->registered[ $style_handle ]->src, 'Source of style should contain the includes url' );
+			$this->assertNotEmpty( $wp_styles->registered[ $style_handle ]->extra, 'The path of the style should exist' );
+			$this->assertArrayHasKey( 'path', $wp_styles->registered[ $style_handle ]->extra, 'The path key of the style should exist in extra array' );
+			$this->assertNotEmpty( $wp_styles->registered[ $style_handle ]->extra['path'], 'The path key of the style should not be empty' );
+		}
+	}
+
+	public function data_block_data() {
+		$core_blocks_meta = require ABSPATH . WPINC . '/blocks/blocks-json.php';
+
+		// Remove this blocks for now, as they are registered elsewhere.
+		unset( $core_blocks_meta['archives'] );
+		unset( $core_blocks_meta['widget-group'] );
+
+		$data = array();
+		foreach ( $core_blocks_meta as $name => $schema ) {
+			if ( ! isset( $schema['style'] ) ) {
+				$schema['style'] = "wp-block-$name";
+			}
+			if ( ! isset( $schema['editorStyle'] ) ) {
+				$schema['editorStyle'] = "wp-block-{$name}-editor";
+			}
+
+			$data[ $name ] = array( $name, $schema );
+		}
+
+		return $data;
+	}
+}
diff --git a/tests/blocks/render.php b/tests/blocks/render.php
index 56905956df..632298186e 100644
--- a/tests/blocks/render.php
+++ b/tests/blocks/render.php
@@ -521,5 +521,4 @@ class Tests_Blocks_Render extends WP_UnitTestCase {
 
 		return $content;
 	}
-
 }
diff --git a/tests/blocks/renderCommentTemplate.php b/tests/blocks/renderCommentTemplate.php
index 82b2cb91cb..0e29dc2241 100644
--- a/tests/blocks/renderCommentTemplate.php
+++ b/tests/blocks/renderCommentTemplate.php
@@ -436,7 +436,7 @@ END
 			)
 		);
 
-		$commenter_filter = function () {
+		$commenter_filter = static function () {
 			return array(
 				'comment_author_email' => 'unapproved@example.org',
 			);
@@ -512,4 +512,145 @@ END
 			'Should not include any unapproved comments after removing filter'
 		);
 	}
+
+	/**
+	 * Tests that the Comment Template block makes comment ID context available to programmatically inserted child blocks.
+	 *
+	 * @ticket 58839
+	 *
+	 * @covers ::render_block_core_comment_template
+	 * @covers ::block_core_comment_template_render_comments
+	 */
+	public function test_rendering_comment_template_sets_comment_id_context() {
+		$render_block_context_callback = new MockAction();
+		add_filter( 'render_block_context', array( $render_block_context_callback, 'filter' ), 2, 3 );
+
+		$parsed_comment_author_name_block = parse_blocks( '<!-- wp:comment-author-name /-->' )[0];
+		$comment_author_name_block        = new WP_Block(
+			$parsed_comment_author_name_block,
+			array(
+				'commentId' => self::$comment_ids[0],
+			)
+		);
+		$comment_author_name_block_markup = $comment_author_name_block->render();
+
+		add_filter(
+			'render_block',
+			static function ( $block_content, $block ) use ( $parsed_comment_author_name_block ) {
+				/*
+				* Insert a Comment Author Name block (which requires `commentId`
+				* block context to work) after the Comment Content block.
+				*/
+				if ( 'core/comment-content' !== $block['blockName'] ) {
+					return $block_content;
+				}
+
+				$inserted_content = render_block( $parsed_comment_author_name_block );
+				return $inserted_content . $block_content;
+			},
+			10,
+			3
+		);
+
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+		$block         = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+		$markup        = $block->render();
+
+		$this->assertStringContainsString( $comment_author_name_block_markup, $markup );
+
+		$args    = $render_block_context_callback->get_args();
+		$context = $args[0][0];
+		$this->assertArrayHasKey(
+			'commentId',
+			$context,
+			"commentId block context wasn't set for render_block_context filter at priority 2."
+		);
+		$this->assertSame(
+			strval( self::$comment_ids[0] ),
+			$context['commentId'],
+			"commentId block context wasn't set correctly."
+		);
+	}
+
+	/**
+	 * Tests that an inner block added via the render_block_data filter is retained at render_block stage.
+	 *
+	 * @ticket 58839
+	 *
+	 * @covers ::render_block_core_comment_template
+	 * @covers ::block_core_comment_template_render_comments
+	 */
+	public function test_inner_block_inserted_by_render_block_data_is_retained() {
+		$render_block_callback = new MockAction();
+		add_filter( 'render_block', array( $render_block_callback, 'filter' ), 10, 3 );
+
+		$render_block_data_callback = static function ( $parsed_block ) {
+			// Add a Social Links block to a Comment Template block's inner blocks.
+			if ( 'core/comment-template' === $parsed_block['blockName'] ) {
+				$inserted_block_markup = <<<END
+<!-- wp:social-links -->
+<ul class="wp-block-social-links"><!-- wp:social-link {"url":"https://wordpress.org","service":"wordpress"} /--></ul>
+<!-- /wp:social-links -->'
+END;
+
+				$inserted_blocks = parse_blocks( $inserted_block_markup );
+
+				$parsed_block['innerBlocks'][] = $inserted_blocks[0];
+			}
+			return $parsed_block;
+		};
+
+		add_filter( 'render_block_data', $render_block_data_callback, 10, 1 );
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comments --><!-- wp:comment-template --><!-- wp:comment-content /--><!-- /wp:comment-template --><!-- /wp:comments -->'
+		);
+		$block         = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+		$block->render();
+		remove_filter( 'render_block_data', $render_block_data_callback );
+
+		$this->assertSame(
+			5,
+			$render_block_callback->get_call_count(),
+			"render_block filter wasn't called the correct number of 5 times."
+		);
+
+		$args = $render_block_callback->get_args();
+		$this->assertSame(
+			'core/comment-content',
+			$args[0][2]->name,
+			"render_block filter didn't receive Comment Content block instance upon first call."
+		);
+		$this->assertSame(
+			'core/comment-template',
+			$args[1][2]->name,
+			"render_block filter didn't receive Comment Template block instance upon second call."
+		);
+		$this->assertCount(
+			2,
+			$args[1][2]->inner_blocks,
+			"Inner block inserted by render_block_data filter wasn't retained."
+		);
+		$this->assertInstanceOf(
+			'WP_Block',
+			$args[1][2]->inner_blocks[1],
+			"Inner block inserted by render_block_data isn't a WP_Block class instance."
+		);
+		$this->assertSame(
+			'core/social-links',
+			$args[1][2]->inner_blocks[1]->name,
+			"Inner block inserted by render_block_data isn't named as expected."
+		);
+	}
 }
diff --git a/tests/blocks/serialize.php b/tests/blocks/serialize.php
index d8e12f0511..12da03e3cd 100644
--- a/tests/blocks/serialize.php
+++ b/tests/blocks/serialize.php
@@ -13,14 +13,15 @@ class Tests_Blocks_Serialize extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider data_serialize_identity_from_parsed
+	 *
+	 * @param string $original Original block markup.
 	 */
 	public function test_serialize_identity_from_parsed( $original ) {
 		$blocks = parse_blocks( $original );
 
-		$actual   = serialize_blocks( $blocks );
-		$expected = $original;
+		$actual = serialize_blocks( $blocks );
 
-		$this->assertSame( $expected, $actual );
+		$this->assertSame( $original, $actual );
 	}
 
 	public function data_serialize_identity_from_parsed() {
@@ -55,4 +56,219 @@ class Tests_Blocks_Serialize extends WP_UnitTestCase {
 		$this->assertSame( 'plugin/example', strip_core_block_namespace( 'plugin/example' ) );
 	}
 
+	/**
+	 * @ticket 59327
+	 * @ticket 59412
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_pre_callback_modifies_current_block() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, array( __CLASS__, 'add_attribute_to_inner_block' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:inner {\"key\":\"value\",\"myattr\":\"myvalue\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	public static function add_attribute_to_inner_block( &$block ) {
+		if ( 'core/inner' === $block['blockName'] ) {
+			$block['attrs']['myattr'] = 'myvalue';
+		}
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_pre_callback_prepends_to_inner_block() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, array( __CLASS__, 'insert_next_to_inner_block_callback' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:tests/inserted-block /--><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_post_callback_appends_to_inner_block() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, null, array( __CLASS__, 'insert_next_to_inner_block_callback' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner --><!-- wp:tests/inserted-block /-->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	public static function insert_next_to_inner_block_callback( $block ) {
+		if ( 'core/inner' !== $block['blockName'] ) {
+			return '';
+		}
+
+		return get_comment_delimited_block_content( 'tests/inserted-block', array(), '' );
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_pre_callback_prepends_to_child_blocks() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, array( __CLASS__, 'insert_next_to_child_blocks_callback' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:tests/inserted-block {\"parent\":\"core/outer\"} /--><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:tests/inserted-block {\"parent\":\"core/outer\"} /--><!-- wp:void /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_post_callback_appends_to_child_blocks() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, null, array( __CLASS__, 'insert_next_to_child_blocks_callback' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner --><!-- wp:tests/inserted-block {\"parent\":\"core/outer\"} /-->\n\nExample.\n\n<!-- wp:void /--><!-- wp:tests/inserted-block {\"parent\":\"core/outer\"} /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	public static function insert_next_to_child_blocks_callback( $block, $parent_block ) {
+		if ( ! isset( $parent_block ) ) {
+			return '';
+		}
+
+		return get_comment_delimited_block_content(
+			'tests/inserted-block',
+			array(
+				'parent' => $parent_block['blockName'],
+			),
+			''
+		);
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_pre_callback_prepends_if_prev_block() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, array( __CLASS__, 'insert_next_to_if_prev_or_next_block_callback' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:tests/inserted-block {\"prev_or_next\":\"core/inner\"} /--><!-- wp:void /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_post_callback_appends_if_prev_block() {
+		$markup = "<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner -->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->";
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks( $blocks, null, array( __CLASS__, 'insert_next_to_if_prev_or_next_block_callback' ) );
+
+		$this->assertSame(
+			"<!-- wp:outer --><!-- wp:inner {\"key\":\"value\"} -->Example.<!-- /wp:inner --><!-- wp:tests/inserted-block {\"prev_or_next\":\"core/void\"} /-->\n\nExample.\n\n<!-- wp:void /--><!-- /wp:outer -->",
+			$actual
+		);
+	}
+
+	public static function insert_next_to_if_prev_or_next_block_callback( $block, $parent_block, $prev_or_next ) {
+		if ( ! isset( $prev_or_next ) ) {
+			return '';
+		}
+
+		return get_comment_delimited_block_content(
+			'tests/inserted-block',
+			array(
+				'prev_or_next' => $prev_or_next['blockName'],
+			),
+			''
+		);
+	}
+
+	/**
+	 * @ticket 59327
+	 * @ticket 59412
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 *
+	 * @dataProvider data_serialize_identity_from_parsed
+	 *
+	 * @param string $original Original block markup.
+	 */
+	public function test_traverse_and_serialize_identity_from_parsed( $original ) {
+		$blocks = parse_blocks( $original );
+
+		$actual = traverse_and_serialize_blocks( $blocks );
+
+		$this->assertSame( $original, $actual );
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_do_not_insert_in_void_block() {
+		$markup = '<!-- wp:void /-->';
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks(
+			$blocks,
+			array( __CLASS__, 'insert_next_to_child_blocks_callback' ),
+			array( __CLASS__, 'insert_next_to_child_blocks_callback' )
+		);
+
+		$this->assertSame( $markup, $actual );
+	}
+
+	/**
+	 * @ticket 59313
+	 *
+	 * @covers ::traverse_and_serialize_blocks
+	 */
+	public function test_traverse_and_serialize_blocks_do_not_insert_in_empty_parent_block() {
+		$markup = '<!-- wp:outer --><div class="wp-block-outer"></div><!-- /wp:outer -->';
+		$blocks = parse_blocks( $markup );
+
+		$actual = traverse_and_serialize_blocks(
+			$blocks,
+			array( __CLASS__, 'insert_next_to_child_blocks_callback' ),
+			array( __CLASS__, 'insert_next_to_child_blocks_callback' )
+		);
+
+		$this->assertSame( $markup, $actual );
+	}
 }
diff --git a/tests/blocks/supportedStyles.php b/tests/blocks/supportedStyles.php
index d3b1a191de..95c5326b45 100644
--- a/tests/blocks/supportedStyles.php
+++ b/tests/blocks/supportedStyles.php
@@ -695,13 +695,14 @@ class Tests_Blocks_SupportedStyles extends WP_UnitTestCase {
 		);
 		$this->register_block_type( 'core/example', $block_type_settings );
 
-		$block = array(
+		$block    = array(
 			'blockName'    => 'core/example',
 			'attrs'        => array(),
 			'innerBlock'   => array(),
 			'innerContent' => array(),
 			'innerHTML'    => array(),
 		);
+		$wp_block = new WP_Block( $block );
 
 		// Custom error handler's see Warnings even if they are suppressed by the @ symbol.
 		$errors = array();
@@ -714,7 +715,7 @@ class Tests_Blocks_SupportedStyles extends WP_UnitTestCase {
 
 		// HTML5 elements like <time> are not supported by the DOMDocument parser used by the block supports feature.
 		// This specific example is emitted by the "Display post date" setting in the latest-posts block.
-		apply_filters( 'render_block', '<div><time datetime="2020-06-18T04:01:43+10:00" class="wp-block-latest-posts__post-date">June 18, 2020</time></div>', $block );
+		apply_filters( 'render_block', '<div><time datetime="2020-06-18T04:01:43+10:00" class="wp-block-latest-posts__post-date">June 18, 2020</time></div>', $block, $wp_block );
 
 		restore_error_handler();
 
diff --git a/tests/blocks/wpBlock.php b/tests/blocks/wpBlock.php
index ebf2f9aaf6..dcafe53378 100644
--- a/tests/blocks/wpBlock.php
+++ b/tests/blocks/wpBlock.php
@@ -275,7 +275,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->registry->register(
 			'core/dynamic',
 			array(
-				'render_callback' => static function() {
+				'render_callback' => static function () {
 					return 'b';
 				},
 			)
@@ -296,7 +296,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->registry->register(
 			'core/greeting',
 			array(
-				'render_callback' => static function( $attributes, $content, $block ) {
+				'render_callback' => static function ( $attributes, $content, $block ) {
 					return sprintf( 'Hello from %s', $block->name );
 				},
 			)
@@ -366,7 +366,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 						'default' => '!',
 					),
 				),
-				'render_callback' => static function( $block_attributes ) {
+				'render_callback' => static function ( $block_attributes ) {
 					return sprintf(
 						'Hello %s%s',
 						$block_attributes['toWhom'],
@@ -391,7 +391,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->registry->register(
 			'core/outer',
 			array(
-				'render_callback' => static function( $block_attributes, $content ) {
+				'render_callback' => static function ( $block_attributes, $content ) {
 					return $content;
 				},
 			)
@@ -399,7 +399,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->registry->register(
 			'core/inner',
 			array(
-				'render_callback' => static function() {
+				'render_callback' => static function () {
 					return 'b';
 				},
 			)
@@ -601,7 +601,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 
 		add_filter(
 			'query_loop_block_query_vars',
-			static function( $query, $block, $page ) {
+			static function ( $query, $block, $page ) {
 				$query['post_type'] = 'book';
 				return $query;
 			},
@@ -682,6 +682,81 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->assertFalse( $gradient_support );
 	}
 
+	/**
+	 * @ticket 58532
+	 *
+	 * @dataProvider data_block_has_support_string
+	 *
+	 * @param array  $block_data Block data.
+	 * @param string $support    Support string to check.
+	 * @param bool   $expected   Expected result.
+	 */
+	public function test_block_has_support_string( $block_data, $support, $expected, $message ) {
+		$this->registry->register( 'core/example', $block_data );
+		$block_type  = $this->registry->get_registered( 'core/example' );
+		$has_support = block_has_support( $block_type, $support );
+		$this->assertEquals( $expected, $has_support, $message );
+	}
+
+	/**
+	 * Data provider for test_block_has_support_string
+	 */
+	public function data_block_has_support_string() {
+		return array(
+			array(
+				array(),
+				'color',
+				false,
+				'Block with empty support array.',
+			),
+			array(
+				array(
+					'supports' => array(
+						'align'    => array( 'wide', 'full' ),
+						'fontSize' => true,
+						'color'    => array(
+							'link'     => true,
+							'gradient' => false,
+						),
+					),
+				),
+				'align',
+				true,
+				'Feature present in support array.',
+			),
+			array(
+				array(
+					'supports' => array(
+						'align'    => array( 'wide', 'full' ),
+						'fontSize' => true,
+						'color'    => array(
+							'link'     => true,
+							'gradient' => false,
+						),
+					),
+				),
+				'anchor',
+				false,
+				'Feature not present in support array.',
+			),
+			array(
+				array(
+					'supports' => array(
+						'align'    => array( 'wide', 'full' ),
+						'fontSize' => true,
+						'color'    => array(
+							'link'     => true,
+							'gradient' => false,
+						),
+					),
+				),
+				array( 'align' ),
+				true,
+				'Feature present in support array, single element array.',
+			),
+		);
+	}
+
 	/**
 	 * @ticket 51612
 	 */
@@ -693,7 +768,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->registry->register(
 			'core/outer',
 			array(
-				'render_callback' => function( $block_attributes, $content ) {
+				'render_callback' => static function ( $block_attributes, $content ) {
 					return $content;
 				},
 			)
@@ -702,7 +777,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->registry->register(
 			'core/inner',
 			array(
-				'render_callback' => function() {
+				'render_callback' => static function () {
 					return 'b';
 				},
 			)
diff --git a/tests/blocks/wpBlockList.php b/tests/blocks/wpBlockList.php
index 6dd2979e70..48b040e918 100644
--- a/tests/blocks/wpBlockList.php
+++ b/tests/blocks/wpBlockList.php
@@ -71,10 +71,10 @@ class Tests_Blocks_wpBlockList extends WP_UnitTestCase {
 
 		foreach ( $blocks as $block ) {
 			$this->assertSame( 'core/example', $block->name );
-			$assertions++;
+			++$assertions;
 			foreach ( $block->inner_blocks as $inner_block ) {
 				$this->assertSame( 'core/example', $inner_block->name );
-				$assertions++;
+				++$assertions;
 			}
 		}
 
@@ -83,9 +83,9 @@ class Tests_Blocks_wpBlockList extends WP_UnitTestCase {
 			$key   = $blocks->key();
 			$block = $blocks->current();
 			$this->assertSame( 0, $key );
-			$assertions++;
+			++$assertions;
 			$this->assertSame( 'core/example', $block->name );
-			$assertions++;
+			++$assertions;
 			$blocks->next();
 		}
 
@@ -102,5 +102,4 @@ class Tests_Blocks_wpBlockList extends WP_UnitTestCase {
 
 		$this->assertCount( 1, $blocks );
 	}
-
 }
diff --git a/tests/blocks/wpBlockPatternsRegistry.php b/tests/blocks/wpBlockPatternsRegistry.php
new file mode 100644
index 0000000000..8eb4fce78b
--- /dev/null
+++ b/tests/blocks/wpBlockPatternsRegistry.php
@@ -0,0 +1,439 @@
+<?php
+/**
+ * Tests for WP_Block_Patterns_Registry.
+ *
+ * @package WordPress
+ * @subpackage Blocks
+ * @since 6.4.0
+ *
+ * @group blocks
+ *
+ * @coversDefaultClass WP_Block_Patterns_Registry
+ */
+class Tests_Blocks_wpBlockPattersRegistry extends WP_UnitTestCase {
+
+	/**
+	 * Fake block patterns registry.
+	 *
+	 * @since 6.4.0
+	 * @var WP_Block_Patterns_Registry
+	 */
+	private $registry = null;
+
+	/**
+	 * Set up each test method.
+	 *
+	 * @since 6.4.0
+	 */
+	public function set_up() {
+		parent::set_up();
+
+		$this->registry = new WP_Block_Patterns_Registry();
+	}
+
+	/**
+	 * Tear down each test method.
+	 *
+	 * @since 6.4.0
+	 */
+	public function tear_down() {
+		$this->registry = null;
+
+		$registry = WP_Block_Type_Registry::get_instance();
+
+		if ( $registry->is_registered( 'tests/my-block' ) ) {
+			$registry->unregister( 'tests/my-block' );
+		}
+
+		parent::tear_down();
+	}
+
+	/**
+	 * Should reject missing pattern name.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::register
+	 */
+	public function test_missing_name() {
+		$name     = null;
+		$settings = array(
+			'title'   => 'Test Pattern',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should reject non-string name.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::register
+	 */
+	public function test_invalid_non_string_name() {
+		$name     = 123;
+		$settings = array(
+			'title'   => 'Test Pattern',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should missing title.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::register
+	 */
+	public function test_missing_title() {
+		$name     = 'test/pattern';
+		$settings = array(
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should reject non-string title.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::register
+	 */
+	public function test_invalid_non_string_title() {
+		$name     = 'test/pattern';
+		$settings = array(
+			'title'   => 456,
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should reject missing content.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::register
+	 */
+	public function test_missing_content() {
+		$name     = 'Test Pattern';
+		$settings = array(
+			'title' => 'Test Pattern',
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should reject non-string content.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::register
+	 */
+	public function test_invalid_non_string_content() {
+		$name     = 'Test Pattern';
+		$settings = array(
+			'title'   => 'Test Pattern',
+			'content' => 789,
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should accept valid pattern.
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 *
+	 * @ticket 59476
+	 */
+	public function test_register_block_pattern() {
+		$name     = 'test/pattern';
+		$settings = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+
+		$success = $this->registry->register( $name, $settings );
+		$this->assertTrue( $success );
+	}
+
+	/**
+	 * Unregistering should fail if a pattern is not registered.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::unregister
+	 *
+	 * @expectedIncorrectUsage WP_Block_Patterns_Registry::unregister
+	 */
+	public function test_unregister_not_registered_block() {
+		$success = $this->registry->unregister( 'test/unregistered' );
+		$this->assertFalse( $success );
+	}
+
+	/**
+	 * Should unregister existing patterns.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::unregister
+	 */
+	public function test_unregister_block_pattern() {
+		$name     = 'test/pattern';
+		$settings = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+
+		$this->registry->register( $name, $settings );
+		$success = $this->registry->unregister( $name );
+		$this->assertTrue( $success );
+	}
+
+	/**
+	 * Should find all registered patterns.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::get_all_registered
+	 */
+	public function test_get_all_registered() {
+		$pattern_one = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+		$this->registry->register( 'test/one', $pattern_one );
+
+		$pattern_two = array(
+			'title'   => 'Pattern Two',
+			'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/two', $pattern_two );
+
+		$pattern_three = array(
+			'title'   => 'Pattern Three',
+			'content' => '<!-- wp:paragraph --><p>Three</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/three', $pattern_three );
+
+		$pattern_one['name']   = 'test/one';
+		$pattern_two['name']   = 'test/two';
+		$pattern_three['name'] = 'test/three';
+
+		$expected = array(
+			$pattern_one,
+			$pattern_two,
+			$pattern_three,
+		);
+
+		$registered = $this->registry->get_all_registered();
+		$this->assertSame( $expected, $registered );
+	}
+
+	/**
+	 * Should not find pattern that's not registered.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::get_registered
+	 */
+	public function test_get_registered_rejects_unknown_pattern_name() {
+		$pattern_one = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+		$this->registry->register( 'test/one', $pattern_one );
+
+		$pattern_two = array(
+			'title'   => 'Pattern Two',
+			'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/two', $pattern_two );
+
+		$pattern = $this->registry->get_registered( 'test/three' );
+		$this->assertNull( $pattern );
+	}
+
+	/**
+	 * Should find registered pattern by name.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::get_registered
+	 */
+	public function test_get_registered() {
+		$pattern_one = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+		$this->registry->register( 'test/one', $pattern_one );
+
+		$pattern_two = array(
+			'title'   => 'Pattern Two',
+			'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/two', $pattern_two );
+
+		$pattern_three = array(
+			'title'   => 'Pattern Three',
+			'content' => '<!-- wp:paragraph --><p>Three</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/three', $pattern_three );
+
+		$pattern_two['name'] = 'test/two';
+
+		$pattern = $this->registry->get_registered( 'test/two' );
+		$this->assertSame( $pattern_two, $pattern );
+	}
+
+	/**
+	 * Should insert hooked blocks into registered patterns.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::get_all_registered
+	 */
+	public function test_get_all_registered_includes_hooked_blocks() {
+		register_block_type(
+			'tests/my-block',
+			array(
+				'block_hooks' => array(
+					'core/paragraph' => 'after',
+				),
+			)
+		);
+
+		$pattern_one = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+		$this->registry->register( 'test/one', $pattern_one );
+
+		$pattern_two = array(
+			'title'   => 'Pattern Two',
+			'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/two', $pattern_two );
+
+		$pattern_three = array(
+			'title'   => 'Pattern Three',
+			'content' => '<!-- wp:paragraph --><p>Three</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/three', $pattern_three );
+
+		$pattern_one['name']       = 'test/one';
+		$pattern_two['name']       = 'test/two';
+		$pattern_two['content']   .= '<!-- wp:tests/my-block /-->';
+		$pattern_three['name']     = 'test/three';
+		$pattern_three['content'] .= '<!-- wp:tests/my-block /-->';
+
+		$expected = array(
+			$pattern_one,
+			$pattern_two,
+			$pattern_three,
+		);
+
+		$registered = $this->registry->get_all_registered();
+		$this->assertSame( $expected, $registered );
+	}
+
+	/**
+	 * Should insert hooked blocks into registered patterns.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::get_registered
+	 */
+	public function test_get_registered_includes_hooked_blocks() {
+		register_block_type(
+			'tests/my-block',
+			array(
+				'block_hooks' => array(
+					'core/heading' => 'before',
+				),
+			)
+		);
+
+		$pattern_one = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+		$this->registry->register( 'test/one', $pattern_one );
+
+		$pattern_two = array(
+			'title'   => 'Pattern Two',
+			'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+		);
+		$this->registry->register( 'test/two', $pattern_two );
+
+		$pattern_one['name']    = 'test/one';
+		$pattern_one['content'] = '<!-- wp:tests/my-block /-->' . $pattern_one['content'];
+
+		$pattern = $this->registry->get_registered( 'test/one' );
+		$this->assertSame( $pattern_one, $pattern );
+	}
+
+	/**
+	 * Should return false for pattern that's not registered.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::is_registered
+	 */
+	public function test_is_registered_for_unknown_pattern() {
+		$pattern = $this->registry->is_registered( 'test/one' );
+		$this->assertFalse( $pattern );
+	}
+
+	/**
+	 * Should return true if pattern is registered.
+	 *
+	 * @ticket 59476
+	 *
+	 * @covers WP_Block_Patterns_Registry::register
+	 * @covers WP_Block_Patterns_Registry::is_registered
+	 */
+	public function test_is_registered_for_known_pattern() {
+		$pattern_one = array(
+			'title'   => 'Pattern One',
+			'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+		);
+		$this->registry->register( 'test/one', $pattern_one );
+
+		$result = $this->registry->is_registered( 'test/one' );
+		$this->assertTrue( $result );
+	}
+}
diff --git a/tests/bookmark/getBookmarks.php b/tests/bookmark/getBookmarks.php
index 45b5af91d0..494737f643 100644
--- a/tests/bookmark/getBookmarks.php
+++ b/tests/bookmark/getBookmarks.php
@@ -5,8 +5,6 @@
  */
 class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 	public function test_should_hit_cache() {
-		global $wpdb;
-
 		$bookmarks = self::factory()->bookmark->create_many( 2 );
 
 		$found1 = get_bookmarks(
@@ -15,7 +13,7 @@ class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found2 = get_bookmarks(
 			array(
@@ -24,12 +22,10 @@ class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 		);
 
 		$this->assertSameSets( $found1, $found2 );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	public function test_adding_bookmark_should_bust_get_bookmarks_cache() {
-		global $wpdb;
-
 		$bookmarks = self::factory()->bookmark->create_many( 2 );
 
 		// Prime cache.
@@ -39,7 +35,7 @@ class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$bookmarks[] = wp_insert_link(
 			array(
@@ -55,15 +51,13 @@ class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 		);
 
 		$this->assertEqualSets( $bookmarks, wp_list_pluck( $found2, 'link_id' ) );
-		$this->assertGreaterThan( $num_queries, $wpdb->num_queries );
+		$this->assertGreaterThan( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 18356
 	 */
 	public function test_orderby_rand_should_not_be_cached() {
-		global $wpdb;
-
 		$bookmarks = self::factory()->bookmark->create_many( 2 );
 
 		$found1 = get_bookmarks(
@@ -72,7 +66,7 @@ class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found2 = get_bookmarks(
 			array(
@@ -82,7 +76,7 @@ class Tests_Bookmark_GetBookmarks extends WP_UnitTestCase {
 
 		// Equal sets != same order.
 		$this->assertEqualSets( $found1, $found2 );
-		$this->assertGreaterThan( $num_queries, $wpdb->num_queries );
+		$this->assertGreaterThan( $num_queries, get_num_queries() );
 	}
 
 	public function test_exclude_param_gets_properly_parsed_as_list() {
diff --git a/tests/canonical.php b/tests/canonical.php
index 6d16402112..8bad744061 100644
--- a/tests/canonical.php
+++ b/tests/canonical.php
@@ -13,6 +13,8 @@ class Tests_Canonical extends WP_Canonical_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 		wp_set_current_user( self::$author_id );
+
+		add_filter( 'pre_option_wp_attachment_pages_enabled', '__return_true' );
 	}
 
 	/**
@@ -247,7 +249,7 @@ class Tests_Canonical extends WP_Canonical_UnitTestCase {
 		// Test short-circuit filter.
 		add_filter(
 			'pre_redirect_guess_404_permalink',
-			static function() {
+			static function () {
 				return 'wp';
 			}
 		);
@@ -402,4 +404,25 @@ class Tests_Canonical extends WP_Canonical_UnitTestCase {
 
 		$this->assertNull( $url );
 	}
+
+	/**
+	 * @ticket 57913
+	 */
+	public function test_canonical_attachment_page_redirect_with_option_disabled() {
+		add_filter( 'pre_option_wp_attachment_pages_enabled', '__return_false' );
+
+		$filename = DIR_TESTDATA . '/images/test-image.jpg';
+		$contents = file_get_contents( $filename );
+		$upload   = wp_upload_bits( wp_basename( $filename ), null, $contents );
+
+		$attachment_id   = $this->_make_attachment( $upload );
+		$attachment_page = get_permalink( $attachment_id );
+
+		$this->go_to( $attachment_page );
+
+		$url      = redirect_canonical( $attachment_page, false );
+		$expected = wp_get_attachment_url( $attachment_id );
+
+		$this->assertSame( $expected, $url );
+	}
 }
diff --git a/tests/canonical/https.php b/tests/canonical/https.php
index fe6eeaed5e..4b02f08765 100644
--- a/tests/canonical/https.php
+++ b/tests/canonical/https.php
@@ -65,5 +65,4 @@ class Tests_Canonical_HTTPS extends WP_Canonical_UnitTestCase {
 
 		remove_filter( 'home_url', array( $this, 'set_https' ) );
 	}
-
 }
diff --git a/tests/canonical/paged.php b/tests/canonical/paged.php
index 62786b28f9..d2440ef18b 100644
--- a/tests/canonical/paged.php
+++ b/tests/canonical/paged.php
@@ -26,5 +26,4 @@ class Tests_Canonical_Paged extends WP_Canonical_UnitTestCase {
 		// Non-existing page should redirect to the permalink.
 		$this->assertCanonical( $link . '4/', $link );
 	}
-
 }
diff --git a/tests/canonical/postStatus.php b/tests/canonical/postStatus.php
index 3e5ca9343a..9b68e61f36 100644
--- a/tests/canonical/postStatus.php
+++ b/tests/canonical/postStatus.php
@@ -169,6 +169,8 @@ class Tests_Canonical_PostStatus extends WP_Canonical_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 		self::setup_custom_types();
+
+		add_filter( 'pre_option_wp_attachment_pages_enabled', '__return_true' );
 	}
 
 	/**
diff --git a/tests/canonical/robots.php b/tests/canonical/robots.php
index c7851a062e..f8034a8a10 100644
--- a/tests/canonical/robots.php
+++ b/tests/canonical/robots.php
@@ -12,5 +12,4 @@ class Tests_Canonical_Robots extends WP_Canonical_UnitTestCase {
 		$this->assertCanonical( '/robots.txt', '/robots.txt' );
 		$this->assertCanonical( '/robots.txt/', '/robots.txt' );
 	}
-
 }
diff --git a/tests/category/getCatId.php b/tests/category/getCatId.php
index b5118d8233..33709a68d3 100644
--- a/tests/category/getCatId.php
+++ b/tests/category/getCatId.php
@@ -24,6 +24,5 @@ class Tests_Category_GetCatId extends WP_UnitTestCase {
 		$this->assertSame( $testcat->term_id, get_cat_ID( $testcat->name ) );
 		$this->assertSame( 0, get_cat_ID( 'NO CAT' ) );
 		$this->assertSame( 0, get_cat_ID( 12 ) );
-
 	}
 }
diff --git a/tests/category/getCatName.php b/tests/category/getCatName.php
index bc333a2b46..1a0364abbc 100644
--- a/tests/category/getCatName.php
+++ b/tests/category/getCatName.php
@@ -24,6 +24,5 @@ class Tests_Category_GetCatName extends WP_UnitTestCase {
 		$this->assertSame( $testcat->name, get_cat_name( $testcat->term_id ) );
 		$this->assertSame( '', get_cat_name( -1 ) );
 		$this->assertSame( '', get_cat_name( $testcat->term_id + 100 ) );
-
 	}
 }
diff --git a/tests/category/getCategoryBySlug.php b/tests/category/getCategoryBySlug.php
index f7c0a3b886..58ff5bfb27 100644
--- a/tests/category/getCategoryBySlug.php
+++ b/tests/category/getCategoryBySlug.php
@@ -34,6 +34,5 @@ class Tests_Category_GetCategoryBySlug extends WP_UnitTestCase {
 
 		// Validate unknown category returns false.
 		$this->assertFalse( get_category_by_slug( 'testcat3' ) );
-
 	}
 }
diff --git a/tests/category/walkerCategory.php b/tests/category/walkerCategory.php
index 2728b11131..9e1ff4e094 100644
--- a/tests/category/walkerCategory.php
+++ b/tests/category/walkerCategory.php
@@ -40,7 +40,7 @@ class Tests_Category_Walker_Category extends WP_UnitTestCase {
 
 		add_filter(
 			'category_list_link_attributes',
-			static function( $atts ) use ( $value ) {
+			static function ( $atts ) use ( $value ) {
 				$atts['data-test'] = $value;
 				return $atts;
 			}
diff --git a/tests/comment.php b/tests/comment.php
index 7858097f73..d37007d824 100644
--- a/tests/comment.php
+++ b/tests/comment.php
@@ -60,7 +60,11 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( 1, $result );
 
 		$comment = get_comment( $comments[0] );
-		$this->assertEquals( $comments[1], $comment->comment_parent );
+		/*
+		 * ::create_post_comments() returns comment IDs as integers,
+		 * but WP_Comment::$comment_parent is a string.
+		 */
+		$this->assertSame( (string) $comments[1], $comment->comment_parent );
 
 		$result = wp_update_comment(
 			array(
@@ -78,7 +82,8 @@ class Tests_Comment extends WP_UnitTestCase {
 		);
 
 		$comment = get_comment( $comments[0] );
-		$this->assertEquals( $post2->ID, $comment->comment_post_ID );
+		// WP_Post::$ID is an integer, but WP_Comment::$comment_post_ID is a string.
+		$this->assertSame( (string) $post2->ID, $comment->comment_post_ID );
 	}
 
 	public function test_update_comment_from_privileged_user_by_privileged_user() {
@@ -221,7 +226,7 @@ class Tests_Comment extends WP_UnitTestCase {
 		);
 
 		$comment = get_comment( $comment_id );
-		$this->assertEquals( 1, $comment->user_id );
+		$this->assertSame( '1', $comment->user_id );
 	}
 
 	/**
@@ -476,7 +481,7 @@ class Tests_Comment extends WP_UnitTestCase {
 			'The comment is not an instance of WP_Comment.'
 		);
 
-		$this->assertObjectHasAttribute(
+		$this->assertObjectHasProperty(
 			'comment_author',
 			$comment,
 			'The comment object does not have a "comment_author" property.'
@@ -1007,7 +1012,6 @@ class Tests_Comment extends WP_UnitTestCase {
 			),
 			$this->preprocess_comment_data
 		);
-
 	}
 
 	public function filter_preprocess_comment( $commentdata ) {
diff --git a/tests/comment/checkComment.php b/tests/comment/checkComment.php
index c23e1d4dc2..bf73a9e1be 100644
--- a/tests/comment/checkComment.php
+++ b/tests/comment/checkComment.php
@@ -32,7 +32,6 @@ class Tests_Comment_CheckComment extends WP_UnitTestCase {
 		update_option( 'comment_previously_approved', 1 );
 		$results = check_comment( $author, $author_email, $author_url, $comment, $author_ip, $user_agent, $comment_type );
 		$this->assertFalse( $results );
-
 	}
 
 	public function test_should_return_true_when_comment_previously_approved_is_enabled_and_author_has_approved_comment() {
diff --git a/tests/comment/commentTime.php b/tests/comment/commentTime.php
new file mode 100644
index 0000000000..a155ec158c
--- /dev/null
+++ b/tests/comment/commentTime.php
@@ -0,0 +1,129 @@
+<?php
+
+/**
+ * Tests for the comment_time() function.
+ *
+ * @group comment
+ *
+ * @covers ::comment_time
+ */
+class Tests_Comment_CommentTime extends WP_UnitTestCase {
+
+	/**
+	 * A post ID.
+	 *
+	 * @var int
+	 */
+	protected static $post_id;
+
+	/**
+	 * A comment ID.
+	 *
+	 * @var int
+	 */
+	protected static $comment_id;
+
+	/**
+	 * Sets the post ID and comment ID property values before any tests run.
+	 */
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		self::$post_id = self::factory()->post->create(
+			array(
+				'post_title'   => 'Post title for comment_time() tests',
+				'post_content' => 'Post content for comment_time() tests',
+			)
+		);
+
+		self::$comment_id = self::factory()->comment->create(
+			array(
+				'comment_post_ID' => self::$post_id,
+				'user_id'         => 1,
+			)
+		);
+	}
+
+	/**
+	 * Tests that comment_time() displays the same value that get_comment_time() returns.
+	 *
+	 * @ticket 58064
+	 *
+	 * @dataProvider data_should_output_the_same_value_that_get_comment_time_returns
+	 *
+	 * @param string $format PHP date format.
+	 */
+	public function test_should_output_the_same_value_that_get_comment_time_returns( $format ) {
+		$expected = get_comment_time( $format, false, true, self::$comment_id );
+
+		ob_start();
+		comment_time( $format, self::$comment_id );
+		$actual = ob_get_clean();
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_output_the_same_value_that_get_comment_time_returns() {
+		return array(
+			'an empty format'   => array(
+				'format' => '',
+			),
+			'a PHP date format' => array(
+				'format' => 'h:i:s A',
+			),
+		);
+	}
+
+	/**
+	 * Tests that comment_time() defaults to the global comment when comment ID
+	 * is not provided.
+	 *
+	 * @ticket 58064
+	 */
+	public function test_should_default_to_the_global_comment_when_comment_id_is_not_provided() {
+		global $comment;
+
+		// Back up the global comment before setting the value.
+		$comment_backup = $comment;
+		$comment        = self::$comment_id;
+
+		$expected = get_comment_time();
+
+		ob_start();
+		comment_time();
+		$actual = ob_get_clean();
+
+		// Restore the global comment value.
+		$comment = $comment_backup;
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Tests that comment_time() displays an empty string when global comment is not set
+	 * and comment ID is not provided.
+	 *
+	 * @ticket 58064
+	 */
+	public function test_should_output_an_empty_string_when_global_comment_is_not_set_and_comment_id_is_not_provided() {
+		global $comment;
+
+		// Back up the global comment before setting the value.
+		$comment_backup = $comment;
+		$comment        = null;
+
+		ob_start();
+		comment_time();
+		$actual = ob_get_clean();
+
+		// Restore the global comment value.
+		$comment = $comment_backup;
+
+		$this->assertSame( '', $actual );
+	}
+}
diff --git a/tests/comment/commentsTemplate.php b/tests/comment/commentsTemplate.php
index 7c27bf1d43..cb033a55e3 100644
--- a/tests/comment/commentsTemplate.php
+++ b/tests/comment/commentsTemplate.php
@@ -9,6 +9,14 @@
  */
 class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 
+	/**
+	 * Performs setup tasks for every test.
+	 */
+	public function set_up() {
+		parent::set_up();
+		switch_theme( 'default' );
+	}
+
 	/**
 	 * @ticket 8071
 	 */
diff --git a/tests/comment/getCommentAuthorUrlLink.php b/tests/comment/getCommentAuthorUrlLink.php
index c9acc6732d..7e60b9cc1b 100644
--- a/tests/comment/getCommentAuthorUrlLink.php
+++ b/tests/comment/getCommentAuthorUrlLink.php
@@ -20,7 +20,7 @@ class Tests_Comment_GetCommentAuthorUrlLink extends WP_UnitTestCase {
 			$linktext = rtrim( preg_replace( '#http://(www\.)?#', '', $comment->comment_author_url ), '/' );
 		}
 		return sprintf(
-			'<a href=\'%s\' rel=\'external\'>%s</a>',
+			'<a href="%s" rel="external">%s</a>',
 			$comment->comment_author_url,
 			$linktext
 		);
@@ -29,7 +29,7 @@ class Tests_Comment_GetCommentAuthorUrlLink extends WP_UnitTestCase {
 	public function test_no_comment() {
 		$url_link = get_comment_author_url_link();
 
-		$this->assertSame( "<a href='' rel='external'></a>", $url_link );
+		$this->assertSame( '<a href="" rel="external"></a>', $url_link );
 	}
 
 	public function test_global_comment() {
diff --git a/tests/comment/getCommentLink.php b/tests/comment/getCommentLink.php
index 3f2f2ff504..8dc0964e0b 100644
--- a/tests/comment/getCommentLink.php
+++ b/tests/comment/getCommentLink.php
@@ -55,7 +55,6 @@ class Tests_Comment_GetCommentLink extends WP_UnitTestCase {
 				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 600 ),
 			)
 		);
-
 	}
 
 	/**
diff --git a/tests/comment/getCommentReplyLink.php b/tests/comment/getCommentReplyLink.php
index 0377a5c0f5..7bb4e91551 100644
--- a/tests/comment/getCommentReplyLink.php
+++ b/tests/comment/getCommentReplyLink.php
@@ -87,5 +87,4 @@ class Tests_Comment_GetCommentReplyLink extends WP_UnitTestCase {
 
 		$this->assertNull( $actual );
 	}
-
 }
diff --git a/tests/comment/getPageOfComment.php b/tests/comment/getPageOfComment.php
index e1f19ae345..bfb5c92c30 100644
--- a/tests/comment/getPageOfComment.php
+++ b/tests/comment/getPageOfComment.php
@@ -100,27 +100,23 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 	 * @ticket 11334
 	 */
 	public function test_subsequent_calls_should_hit_cache() {
-		global $wpdb;
-
 		$p = self::factory()->post->create();
 		$c = self::factory()->comment->create( array( 'comment_post_ID' => $p ) );
 
 		// Prime cache.
 		$page_1 = get_page_of_comment( $c, array( 'per_page' => 3 ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$page_2      = get_page_of_comment( $c, array( 'per_page' => 3 ) );
 
 		$this->assertSame( $page_1, $page_2 );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 11334
 	 */
 	public function test_cache_hits_should_be_sensitive_to_comment_type() {
-		global $wpdb;
-
 		$p       = self::factory()->post->create();
 		$comment = self::factory()->comment->create(
 			array(
@@ -151,7 +147,7 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		);
 		$this->assertSame( 2, $page_trackbacks );
 
-		$num_queries   = $wpdb->num_queries;
+		$num_queries   = get_num_queries();
 		$page_comments = get_page_of_comment(
 			$comment,
 			array(
@@ -161,7 +157,7 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		);
 		$this->assertSame( 1, $page_comments );
 
-		$this->assertNotEquals( $num_queries, $wpdb->num_queries );
+		$this->assertNotEquals( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/comment/isAvatarCommentType.php b/tests/comment/isAvatarCommentType.php
index f45caae93b..aa91a6d6fe 100644
--- a/tests/comment/isAvatarCommentType.php
+++ b/tests/comment/isAvatarCommentType.php
@@ -72,5 +72,4 @@ class Tests_Comment_IsAvatarCommentType extends WP_UnitTestCase {
 		$types[] = 'review';
 		return $types;
 	}
-
 }
diff --git a/tests/comment/metaCache.php b/tests/comment/metaCache.php
index bd96e8b3e1..828363e580 100644
--- a/tests/comment/metaCache.php
+++ b/tests/comment/metaCache.php
@@ -11,9 +11,40 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 	 *
 	 * @covers ::update_comment_meta
 	 */
-	public function test_update_comment_meta_cache_should_default_to_true() {
-		global $wpdb;
+	public function test_update_comment_meta_cache_should_default_to_lazy_loading() {
+		$p           = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$comment_ids = self::factory()->comment->create_post_comments( $p, 3 );
+
+		foreach ( $comment_ids as $cid ) {
+			update_comment_meta( $cid, 'foo', 'bar' );
+		}
 
+		// Clear comment cache, just in case.
+		clean_comment_cache( $comment_ids );
+
+		$num_queries = get_num_queries();
+		$q           = new WP_Comment_Query(
+			array(
+				'post_ID' => $p,
+			)
+		);
+
+		$this->assertSame( 2, get_num_queries() - $num_queries, 'Querying comments is expected to make two queries' );
+
+		$num_queries = get_num_queries();
+		foreach ( $comment_ids as $cid ) {
+			get_comment_meta( $cid, 'foo', 'bar' );
+		}
+
+		$this->assertSame( 1, get_num_queries() - $num_queries, 'Querying comments is expected to make two queries' );
+	}
+
+	/**
+	 * @ticket 57801
+	 *
+	 * @covers ::wp_lazyload_comment_meta
+	 */
+	public function test_update_comment_meta_cache_should_default_to_lazy_loading_fields_id() {
 		$p           = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$comment_ids = self::factory()->comment->create_post_comments( $p, 3 );
 
@@ -24,18 +55,22 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 		// Clear comment cache, just in case.
 		clean_comment_cache( $comment_ids );
 
-		$q = new WP_Comment_Query(
+		$num_queries = get_num_queries();
+		$q           = new WP_Comment_Query(
 			array(
 				'post_ID' => $p,
+				'fields'  => 'ids',
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$this->assertSame( 1, get_num_queries() - $num_queries, 'Querying comments is expected to make two queries' );
+
+		$num_queries = get_num_queries();
 		foreach ( $comment_ids as $cid ) {
 			get_comment_meta( $cid, 'foo', 'bar' );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( 1, get_num_queries() - $num_queries, 'Comment meta is expected to be lazy loaded' );
 	}
 
 	/**
@@ -44,8 +79,6 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 	 * @covers ::update_comment_meta
 	 */
 	public function test_update_comment_meta_cache_true() {
-		global $wpdb;
-
 		$p           = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$comment_ids = self::factory()->comment->create_post_comments( $p, 3 );
 
@@ -56,19 +89,59 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 		// Clear comment cache, just in case.
 		clean_comment_cache( $comment_ids );
 
-		$q = new WP_Comment_Query(
+		$num_queries = get_num_queries();
+		$q           = new WP_Comment_Query(
 			array(
 				'post_ID'                   => $p,
 				'update_comment_meta_cache' => true,
 			)
 		);
+		$this->assertSame( 2, get_num_queries() - $num_queries, 'Comments should be queries and primed in two database queries' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		foreach ( $comment_ids as $cid ) {
 			get_comment_meta( $cid, 'foo', 'bar' );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( 1, get_num_queries() - $num_queries, 'Comment meta should be loaded in one database query' );
+	}
+
+	/**
+	 * @ticket 57801
+	 *
+	 * @covers ::update_comment_meta
+	 */
+	public function test_update_comment_meta_cache_true_multiple() {
+		$posts           = self::factory()->post->create_many( 3 );
+		$all_comment_ids = array();
+		foreach ( $posts as $p ) {
+			$comment_ids = self::factory()->comment->create_post_comments( $p, 3 );
+
+			foreach ( $comment_ids as $cid ) {
+				update_comment_meta( $cid, 'foo', 'bar' );
+				$all_comment_ids[] = $cid;
+			}
+
+			$num_queries = get_num_queries();
+			$q           = new WP_Comment_Query(
+				array(
+					'post_ID'                   => $p,
+					'update_comment_meta_cache' => true,
+				)
+			);
+			$this->assertSame( 1, get_num_queries() - $num_queries, 'Comment query should only add one query' );
+		}
+
+		$filter = new MockAction();
+		add_filter( 'update_comment_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		$num_queries = get_num_queries();
+		get_comment_meta( $comment_ids[0], 'foo', 'bar' );
+
+		$this->assertSame( 1, get_num_queries() - $num_queries, 'Comment meta should be loaded in one database query' );
+		$args              = $filter->get_args();
+		$first             = reset( $args );
+		$prime_comment_ids = end( $first );
+		$this->assertSameSets( $prime_comment_ids, $all_comment_ids, 'All comment meta should be loaded all at once' );
 	}
 
 	/**
@@ -77,8 +150,6 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 	 * @covers ::update_comment_meta
 	 */
 	public function test_update_comment_meta_cache_false() {
-		global $wpdb;
-
 		$p           = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$comment_ids = self::factory()->comment->create_post_comments( $p, 3 );
 
@@ -93,12 +164,12 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		foreach ( $comment_ids as $cid ) {
 			get_comment_meta( $cid, 'foo', 'bar' );
 		}
 
-		$this->assertSame( $num_queries + 3, $wpdb->num_queries );
+		$this->assertSame( 3, get_num_queries() - $num_queries );
 	}
 
 	/**
@@ -107,8 +178,6 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 	 * @covers ::get_comment_meta
 	 */
 	public function test_comment_meta_should_be_lazy_loaded_for_all_comments_in_comments_template() {
-		global $wpdb;
-
 		$p           = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$comment_ids = self::factory()->comment->create_post_comments( $p, 3 );
 
@@ -126,14 +195,14 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 				$cform = get_echo( 'comments_template' );
 
 				// First request will hit the database.
-				$num_queries = $wpdb->num_queries;
+				$num_queries = get_num_queries();
 				get_comment_meta( $comment_ids[0], 'sauce' );
-				$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+				$this->assertSame( 1, get_num_queries() - $num_queries );
 
 				// Second and third requests should be in cache.
 				get_comment_meta( $comment_ids[1], 'sauce' );
 				get_comment_meta( $comment_ids[2], 'sauce' );
-				$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+				$this->assertSame( 1, get_num_queries() - $num_queries );
 			}
 		}
 	}
@@ -142,10 +211,9 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 	 * @ticket 34047
 	 *
 	 * @covers ::get_comment_meta
+	 * @covers ::wp_lazyload_comment_meta
 	 */
 	public function test_comment_meta_should_be_lazy_loaded_in_comment_feed_queries() {
-		global $wpdb;
-
 		$posts = self::factory()->post->create_many( 2, array( 'post_status' => 'publish' ) );
 
 		$now      = time();
@@ -173,29 +241,28 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 		);
 
 		// First comment will cause the cache to be primed.
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertSame( 'bar', get_comment_meta( $comments[0], 'foo', 'bar' ) );
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Second comment from the results should not cause more queries.
 		$this->assertSame( 'bar', get_comment_meta( $comments[1], 'foo', 'bar' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// A comment from outside the results will not be primed.
 		$this->assertSame( 'bar', get_comment_meta( $comments[4], 'foo', 'bar' ) );
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 34047
 	 *
 	 * @covers ::get_comment_meta
+	 * @covers ::wp_lazyload_comment_meta
 	 */
 	public function test_comment_meta_should_be_lazy_loaded_in_single_post_comment_feed_queries() {
-		global $wpdb;
-
 		$posts = self::factory()->post->create_many( 2, array( 'post_status' => 'publish' ) );
 
 		$now      = time();
@@ -224,19 +291,19 @@ class Tests_Comment_MetaCache extends WP_UnitTestCase {
 		);
 
 		// First comment will cause the cache to be primed.
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertSame( 'bar', get_comment_meta( $comments[0], 'foo', 'bar' ) );
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Second comment from the results should not cause more queries.
 		$this->assertSame( 'bar', get_comment_meta( $comments[1], 'foo', 'bar' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// A comment from outside the results will not be primed.
 		$this->assertSame( 'bar', get_comment_meta( $comments[4], 'foo', 'bar' ) );
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/comment/query.php b/tests/comment/query.php
index 5a7ab9441d..6a367e43b4 100644
--- a/tests/comment/query.php
+++ b/tests/comment/query.php
@@ -245,7 +245,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		);
 
 		$this->assertSameSets( array( $c2, $c3 ), $found );
-
 	}
 
 	/**
@@ -289,7 +288,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		);
 
 		$this->assertSameSets( array( $c2, $c3 ), $found );
-
 	}
 
 	/**
@@ -1748,7 +1746,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertEquals( $users[0], $comments[0]->user_id );
 		$this->assertEquals( $users[0], $comments[1]->user_id );
 		$this->assertEquals( $users[1], $comments[2]->user_id );
-
 	}
 
 	/**
@@ -3094,7 +3091,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$q     = new WP_Comment_Query();
 		$found = $q->query(
 			array(
-				'count' => true,
+				'count'   => true,
+				'orderby' => 'none',
 			)
 		);
 
@@ -3132,6 +3130,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$found = $q->query(
 			array(
 				'count'      => true,
+				'orderby'    => 'none',
 				'meta_query' => array(
 					array(
 						'key'   => 'foo',
@@ -3588,8 +3587,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 	 * @covers WP_Comment_Query::query
 	 */
 	public function test_comment_cache_key_should_ignore_custom_params() {
-		global $wpdb;
-
 		$p = self::factory()->post->create();
 		$c = self::factory()->comment->create( array( 'comment_post_ID' => $p ) );
 
@@ -3601,7 +3598,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q2 = new WP_Comment_Query();
 		$q2->query(
@@ -3612,7 +3609,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -3629,7 +3626,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q2 = new WP_Comment_Query(
 			array(
@@ -3637,7 +3634,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertNotEquals( $num_queries, $wpdb->num_queries );
+		$this->assertNotEquals( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -3654,7 +3651,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q2 = new WP_Comment_Query(
 			array(
@@ -3662,7 +3659,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertNotEquals( $num_queries, $wpdb->num_queries );
+		$this->assertNotEquals( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -3933,7 +3930,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		);
 
 		$this->assertSame( array( $c2, $c3 ), $ids->comments );
-
 	}
 
 	/**
@@ -4427,7 +4423,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		);
 		$q1_ids = wp_list_pluck( $q1->comments, 'comment_ID' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$q2          = new WP_Comment_Query(
 			array(
 				'post_id'      => $p,
@@ -4437,7 +4433,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$q2_ids      = wp_list_pluck( $q2->comments, 'comment_ID' );
 
 		$this->assertSameSets( $q1_ids, $q2_ids );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -4590,9 +4586,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( isset( $q->comments[0]->post_name ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 
 	/**
@@ -4613,9 +4609,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( isset( $q->comments[0]->post_name ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -4629,7 +4625,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$comments = self::factory()->comment->create_many( 3, array( 'comment_post_ID' => self::$post_id ) );
 		clean_comment_cache( $comments );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$q           = new WP_Comment_Query(
 			array(
 				'post_id'                   => self::$post_id,
@@ -4645,7 +4641,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$found = wp_list_pluck( $q->comments, 'comment_ID' );
 		$this->assertEqualSets( $comments, $found );
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -4692,7 +4688,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q2 = new WP_Comment_Query(
 			array(
@@ -4701,7 +4697,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -4724,7 +4720,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4733,7 +4729,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
@@ -4766,7 +4762,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4775,8 +4771,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
@@ -4802,7 +4798,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		wp_delete_comment( $c );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4811,8 +4807,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array(), $q->comments );
 	}
 
@@ -4838,7 +4834,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		wp_trash_comment( $c );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4847,8 +4843,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array(), $q->comments );
 	}
 
@@ -4876,7 +4872,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		wp_untrash_comment( $c );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4885,8 +4881,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
@@ -4912,7 +4908,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		wp_spam_comment( $c );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4921,8 +4917,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array(), $q->comments );
 	}
 
@@ -4950,7 +4946,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		wp_unspam_comment( $c );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q = new WP_Comment_Query(
 			array(
@@ -4959,8 +4955,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
@@ -4982,7 +4978,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$number_of_queries = $wpdb->num_queries;
+		$number_of_queries = get_num_queries();
 
 		$query_2 = $q->query(
 			array(
@@ -4992,7 +4988,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 				'count'  => true,
 			)
 		);
-		$this->assertSame( $number_of_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $number_of_queries + 1, get_num_queries() );
 	}
 
 	/**
@@ -5007,23 +5003,23 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		$query_1           = $q->query(
 			array(
-				'fields' => 'ids',
-				'number' => 3,
-				'order'  => 'ASC',
-				'count'  => true,
+				'fields'  => 'ids',
+				'number'  => 3,
+				'orderby' => 'none',
+				'count'   => true,
 			)
 		);
-		$number_of_queries = $wpdb->num_queries;
+		$number_of_queries = get_num_queries();
 
 		$query_2 = $q->query(
 			array(
-				'fields' => 'ids',
-				'number' => 3,
-				'order'  => 'ASC',
-				'count'  => true,
+				'fields'  => 'ids',
+				'number'  => 3,
+				'orderby' => 'none',
+				'count'   => true,
 			)
 		);
-		$this->assertSame( $number_of_queries, $wpdb->num_queries );
+		$this->assertSame( $number_of_queries, get_num_queries() );
 	}
 
 	/**
@@ -5043,7 +5039,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 				'order'  => 'ASC',
 			)
 		);
-		$number_of_queries = $wpdb->num_queries;
+		$number_of_queries = get_num_queries();
 
 		$query_2 = $q->query(
 			array(
@@ -5053,7 +5049,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertSame( $number_of_queries, $wpdb->num_queries );
+		$this->assertSame( $number_of_queries, get_num_queries() );
 	}
 
 	/**
@@ -5219,7 +5215,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		add_filter( 'comments_pre_query', array( __CLASS__, 'filter_comments_pre_query' ), 10, 2 );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q       = new WP_Comment_Query();
 		$results = $q->query( array() );
@@ -5227,7 +5223,7 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		remove_filter( 'comments_pre_query', array( __CLASS__, 'filter_comments_pre_query' ), 10, 2 );
 
 		// Make sure no queries were executed.
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// We manually inserted a non-existing site and overrode the results with it.
 		$this->assertSame( array( 555 ), $results );
diff --git a/tests/comment/slashes.php b/tests/comment/slashes.php
index e58776d8f8..65c87ad230 100644
--- a/tests/comment/slashes.php
+++ b/tests/comment/slashes.php
@@ -194,5 +194,4 @@ class Tests_Comment_Slashes extends WP_UnitTestCase {
 		$this->assertSame( wp_unslash( self::SLASH_2 ), $comment->comment_author );
 		$this->assertSame( wp_unslash( self::SLASH_4 ), $comment->comment_content );
 	}
-
 }
diff --git a/tests/comment/template.php b/tests/comment/template.php
index 0632a22863..648e803132 100644
--- a/tests/comment/template.php
+++ b/tests/comment/template.php
@@ -69,7 +69,6 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 		$comments_number_text = ob_get_clean();
 
 		$this->assertSame( sprintf( _n( '%s Comment', '%s Comments', 6 ), '6' ), $comments_number_text );
-
 	}
 
 	/**
@@ -93,7 +92,6 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 		$this->go_to( $permalink );
 
 		$this->assertSame( sprintf( _n( '%s Comment', '%s Comments', 2 ), '2' ), get_comments_number_text() );
-
 	}
 
 	/**
@@ -199,5 +197,4 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/comment/wpHandleCommentSubmission.php b/tests/comment/wpHandleCommentSubmission.php
index ff2f3c8b7a..f97712b1b6 100644
--- a/tests/comment/wpHandleCommentSubmission.php
+++ b/tests/comment/wpHandleCommentSubmission.php
@@ -54,7 +54,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 1, did_action( $error ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_post_with_closed_comments_returns_error() {
@@ -77,7 +76,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 1, did_action( $error ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_trashed_post_returns_error() {
@@ -98,7 +96,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 1, did_action( $error ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_draft_post_returns_error() {
@@ -121,7 +118,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
 		$this->assertEmpty( $comment->get_error_message() );
-
 	}
 
 	/**
@@ -175,7 +171,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 1, did_action( $error ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_password_required_post_returns_error() {
@@ -198,7 +193,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 1, did_action( $error ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_password_protected_post_succeeds() {
@@ -225,7 +219,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
-
 	}
 
 	public function test_submitting_valid_comment_as_logged_in_user_succeeds() {
@@ -252,7 +245,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( $user->user_email, $comment->comment_author_email );
 		$this->assertSame( $user->user_url, $comment->comment_author_url );
 		$this->assertSame( $user->ID, (int) $comment->user_id );
-
 	}
 
 	public function test_submitting_valid_comment_anonymously_succeeds() {
@@ -274,7 +266,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 'comment@example.org', $comment->comment_author_email );
 		$this->assertSame( 'http://user.example.org', $comment->comment_author_url );
 		$this->assertSame( '0', $comment->user_id );
-
 	}
 
 	/**
@@ -297,7 +288,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertSame( 'Comment with 1 slash: \\', $comment->comment_content );
 		$this->assertSame( 'Comment Author with 1 slash: \\', $comment->comment_author );
 		$this->assertSame( 'comment@example.org', $comment->comment_author_email );
-
 	}
 
 	public function test_submitting_comment_anonymously_to_private_post_returns_error() {
@@ -318,7 +308,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertFalse( is_user_logged_in() );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_as_logged_in_user_to_inaccessible_private_post_returns_error() {
@@ -348,7 +337,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertFalse( current_user_can( 'read_post', $post->ID ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_private_post_with_closed_comments_returns_correct_error() {
@@ -379,7 +367,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertFalse( current_user_can( 'read_post', $post->ID ) );
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_to_own_private_post_succeeds() {
@@ -402,7 +389,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertTrue( current_user_can( 'read_post', $post->ID ) );
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
-
 	}
 
 	public function test_submitting_comment_to_accessible_private_post_succeeds() {
@@ -425,7 +411,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertTrue( current_user_can( 'read_post', $post->ID ) );
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
-
 	}
 
 	public function test_anonymous_user_cannot_comment_unfiltered_html() {
@@ -440,7 +425,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
 		$this->assertStringNotContainsString( '<script', $comment->comment_content );
-
 	}
 
 	public function test_unprivileged_user_cannot_comment_unfiltered_html() {
@@ -458,7 +442,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
 		$this->assertStringNotContainsString( '<script', $comment->comment_content );
-
 	}
 
 	public function test_unprivileged_user_cannot_comment_unfiltered_html_even_with_valid_nonce() {
@@ -482,7 +465,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
 		$this->assertStringNotContainsString( '<script', $comment->comment_content );
-
 	}
 
 	public function test_privileged_user_can_comment_unfiltered_html_with_valid_nonce() {
@@ -514,7 +496,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
 		$this->assertStringContainsString( '<script', $comment->comment_content );
-
 	}
 
 	public function test_privileged_user_cannot_comment_unfiltered_html_without_valid_nonce() {
@@ -538,7 +519,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertNotWPError( $comment );
 		$this->assertInstanceOf( 'WP_Comment', $comment );
 		$this->assertStringNotContainsString( '<script', $comment->comment_content );
-
 	}
 
 	public function test_submitting_comment_as_anonymous_user_when_registration_required_returns_error() {
@@ -557,7 +537,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_with_no_name_when_name_email_required_returns_error() {
@@ -578,7 +557,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_with_no_email_when_name_email_required_returns_error() {
@@ -599,7 +577,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_with_invalid_email_when_name_email_required_returns_error() {
@@ -621,7 +598,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	public function test_submitting_comment_with_no_comment_content_returns_error() {
@@ -638,7 +614,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 
 		$this->assertWPError( $comment );
 		$this->assertSame( $error, $comment->get_error_code() );
-
 	}
 
 	/**
@@ -788,7 +763,6 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 			),
 			$this->preprocess_comment_data
 		);
-
 	}
 
 	/**
diff --git a/tests/comment/wpListComments.php b/tests/comment/wpListComments.php
index f49ef84561..8997b681f7 100644
--- a/tests/comment/wpListComments.php
+++ b/tests/comment/wpListComments.php
@@ -6,6 +6,15 @@
  * @covers ::wp_list_comments
  */
 class Tests_Comment_WpListComments extends WP_UnitTestCase {
+
+	/**
+	 * Performs setup tasks for every test.
+	 */
+	public function set_up() {
+		parent::set_up();
+		switch_theme( 'default' );
+	}
+
 	/**
 	 * @ticket 35175
 	 */
diff --git a/tests/comment/wpUpdateCommentCountNow.php b/tests/comment/wpUpdateCommentCountNow.php
index 42af1b0b5c..76f890f90f 100644
--- a/tests/comment/wpUpdateCommentCountNow.php
+++ b/tests/comment/wpUpdateCommentCountNow.php
@@ -14,16 +14,14 @@ class Tests_Comment_wpUpdateCommentCountNow extends WP_UnitTestCase {
 	}
 
 	public function test_regular_post_updates_comment_count() {
-		global $wpdb;
-
 		$post_id = self::factory()->post->create();
 
 		self::factory()->comment->create_post_comments( $post_id, 1 );
 		$this->assertSame( '1', get_comments_number( $post_id ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( wp_update_comment_count_now( $post_id ) );
-		$this->assertSame( $num_queries + 2, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 2, get_num_queries() );
 
 		$this->assertSame( '1', get_comments_number( $post_id ) );
 	}
@@ -38,10 +36,10 @@ class Tests_Comment_wpUpdateCommentCountNow extends WP_UnitTestCase {
 		self::factory()->comment->create_post_comments( $post_id, 1 );
 		$this->assertSame( '100', get_comments_number( $post_id ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( wp_update_comment_count_now( $post_id ) );
 		// Only one query is made instead of two.
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
 		$this->assertSame( '100', get_comments_number( $post_id ) );
 
diff --git a/tests/compat/arrayKeyFirst.php b/tests/compat/arrayKeyFirst.php
index 613845aba0..b3b97ad464 100644
--- a/tests/compat/arrayKeyFirst.php
+++ b/tests/compat/arrayKeyFirst.php
@@ -32,7 +32,6 @@ class Tests_Compat_arrayKeyFirst extends WP_UnitTestCase {
 				array_key_first( $arr )
 			);
 		}
-
 	}
 
 	/**
diff --git a/tests/compat/strContains.php b/tests/compat/strContains.php
index c49cb19f23..ee5bb6e1d3 100644
--- a/tests/compat/strContains.php
+++ b/tests/compat/strContains.php
@@ -34,7 +34,6 @@ class Tests_Compat_strContains extends WP_UnitTestCase {
 				str_contains( $haystack, $needle )
 			);
 		}
-
 	}
 
 	/**
diff --git a/tests/compat/strEndsWith.php b/tests/compat/strEndsWith.php
index 75522d6f49..7cf1e2b15d 100644
--- a/tests/compat/strEndsWith.php
+++ b/tests/compat/strEndsWith.php
@@ -34,7 +34,6 @@ class Tests_Compat_StrEndsWith extends WP_UnitTestCase {
 				str_ends_with( $haystack, $needle )
 			);
 		}
-
 	}
 
 	/**
diff --git a/tests/compat/strStartsWith.php b/tests/compat/strStartsWith.php
index 9e12ced33b..6bf72cd621 100644
--- a/tests/compat/strStartsWith.php
+++ b/tests/compat/strStartsWith.php
@@ -34,7 +34,6 @@ class Tests_Compat_StrStartsWith extends WP_UnitTestCase {
 				str_starts_with( $haystack, $needle )
 			);
 		}
-
 	}
 
 	/**
diff --git a/tests/cron.php b/tests/cron.php
index e5ecee093b..ec97b366d0 100644
--- a/tests/cron.php
+++ b/tests/cron.php
@@ -53,7 +53,6 @@ class Tests_Cron extends WP_UnitTestCase {
 
 		// It's a non-recurring event.
 		$this->assertFalse( wp_get_schedule( $hook ) );
-
 	}
 
 	/**
@@ -708,7 +707,6 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertFalse( wp_get_scheduled_event( $hook, $args, strtotime( '+30 minutes' ) ) );
 		// - Invalid timestamp.
 		$this->assertFalse( wp_get_scheduled_event( $hook, $args, 'Words Fail!' ) );
-
 	}
 
 	/**
@@ -767,7 +765,6 @@ class Tests_Cron extends WP_UnitTestCase {
 		$subsequent = wp_schedule_single_event( $ts3, $hook, $args, true );
 		$this->assertWPError( $subsequent );
 		$this->assertSame( 'duplicate_event', $subsequent->get_error_code() );
-
 	}
 
 	/**
@@ -913,7 +910,7 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * @covers ::wp_reschedule_event
 	 */
 	public function test_schedule_short_circuit_with_error_returns_false_when_wp_error_is_set_to_false() {
-		$return_error = function( $pre, $event, $wp_error ) {
+		$return_error = function ( $pre, $event, $wp_error ) {
 			$this->assertFalse( $wp_error );
 
 			return new WP_Error(
@@ -945,7 +942,7 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * @covers ::wp_reschedule_event
 	 */
 	public function test_schedule_short_circuit_with_error_returns_error_when_wp_error_is_set_to_true() {
-		$return_error = function( $pre, $event, $wp_error ) {
+		$return_error = function ( $pre, $event, $wp_error ) {
 			$this->assertTrue( $wp_error );
 
 			return new WP_Error(
@@ -1032,7 +1029,7 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * @covers ::wp_clear_scheduled_hook
 	 */
 	public function test_deprecated_argument_usage_of_wp_clear_scheduled_hook() {
-		$return_pre = function( $pre, $hook, $args, $wp_error ) {
+		$return_pre = function ( $pre, $hook, $args, $wp_error ) {
 			$this->assertSame( array( 1, 2, 3 ), $args );
 			$this->assertFalse( $wp_error );
 
@@ -1075,7 +1072,7 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * @covers ::wp_clear_scheduled_hook
 	 */
 	public function test_clear_scheduled_hook_returns_custom_pre_filter_error_when_wp_error_is_set_to_true() {
-		$return_error = function( $pre, $timestamp, $hook, $args, $wp_error ) {
+		$return_error = function ( $pre, $timestamp, $hook, $args, $wp_error ) {
 			$this->assertTrue( $wp_error );
 
 			return new WP_Error( 'error_code', 'error message' );
@@ -1110,7 +1107,7 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_short_circuit_with_error_returns_false_when_wp_error_is_set_to_false() {
-		$return_error = function( $pre, $hook, $wp_error ) {
+		$return_error = function ( $pre, $hook, $wp_error ) {
 			$this->assertFalse( $wp_error );
 
 			return new WP_Error(
@@ -1135,7 +1132,7 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_short_circuit_with_error_returns_error_when_wp_error_is_set_to_true() {
-		$return_error = function( $pre, $hook, $wp_error ) {
+		$return_error = function ( $pre, $hook, $wp_error ) {
 			$this->assertTrue( $wp_error );
 
 			return new WP_Error(
@@ -1197,7 +1194,7 @@ class Tests_Cron extends WP_UnitTestCase {
 		// Force update_option() to fail by setting the new value to match the existing:
 		add_filter(
 			'pre_update_option_cron',
-			static function() {
+			static function () {
 				return get_option( 'cron' );
 			}
 		);
@@ -1219,7 +1216,7 @@ class Tests_Cron extends WP_UnitTestCase {
 		// Force update_option() to fail by setting the new value to match the existing:
 		add_filter(
 			'pre_update_option_cron',
-			static function() {
+			static function () {
 				return get_option( 'cron' );
 			}
 		);
@@ -1244,7 +1241,7 @@ class Tests_Cron extends WP_UnitTestCase {
 		// Force update_option() to fail by setting the new value to match the existing:
 		add_filter(
 			'pre_update_option_cron',
-			static function() {
+			static function () {
 				return get_option( 'cron' );
 			}
 		);
@@ -1270,7 +1267,7 @@ class Tests_Cron extends WP_UnitTestCase {
 		// Force update_option() to fail by setting the new value to match the existing:
 		add_filter(
 			'pre_update_option_cron',
-			static function() {
+			static function () {
 				return get_option( 'cron' );
 			}
 		);
@@ -1283,5 +1280,4 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertWPError( $unscheduled );
 		$this->assertSame( 'could_not_set', $unscheduled->get_error_code() );
 	}
-
 }
diff --git a/tests/customize/manager.php b/tests/customize/manager.php
index 9498211a1f..9f0ff383ed 100644
--- a/tests/customize/manager.php
+++ b/tests/customize/manager.php
@@ -271,7 +271,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 * @ticket 41039
 	 */
 	public function test_fresh_site_flag_clearing() {
-		global $wp_customize, $wpdb;
+		global $wp_customize;
 
 		// Make sure fresh site flag is cleared when publishing a changeset.
 		update_option( 'fresh_site', '1' );
@@ -283,9 +283,9 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		wp_load_alloptions();
 
 		// Make sure no DB write is done when publishing and a site is already non-fresh.
-		$query_count = $wpdb->num_queries;
+		$query_count = get_num_queries();
 		do_action( 'customize_save_after', $wp_customize );
-		$this->assertSame( $query_count, $wpdb->num_queries );
+		$this->assertSame( $query_count, get_num_queries() );
 	}
 
 	/**
@@ -764,7 +764,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 
 		/*
 		 * Test that adding blogname starter content is ignored now that it is modified,
-		 * but updating a non-modified starter content blog description passes.
+		 * but updating a non-modified starter content site description passes.
 		 */
 		$previous_blogname        = $changeset_data['blogname']['value'];
 		$previous_blogdescription = $changeset_data['blogdescription']['value'];
@@ -1345,7 +1345,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 
 		// User saved as one who can bypass content_save_pre filter.
 		$this->assertStringContainsString( '<script>', get_option( 'custom_html_1' ) );
-		$this->assertStringContainsString( 'Wordpress', get_option( 'custom_html_1' ) ); // phpcs:ignore WordPress.WP.CapitalPDangit.Misspelled
+		$this->assertStringContainsString( 'Wordpress', get_option( 'custom_html_1' ) ); // phpcs:ignore WordPress.WP.CapitalPDangit.MisspelledInText
 
 		// User saved as one who cannot bypass content_save_pre filter.
 		$this->assertStringNotContainsString( '<script>', get_option( 'custom_html_2' ) );
@@ -3135,8 +3135,8 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$manager = new WP_Customize_Manager( array( 'messenger_channel' => 'preview-0' ) );
 		ob_start();
 		$manager->remove_frameless_preview_messenger_channel();
-		$output = ob_get_clean();
-		$this->assertStringContainsString( '<script>', $output );
+		$processor = new WP_HTML_Tag_Processor( ob_get_clean() );
+		$this->assertTrue( $processor->next_tag( 'script' ), 'Failed to find expected SCRIPT element in output.' );
 	}
 
 	/**
@@ -3339,14 +3339,14 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$setting_id = 'dynamic';
 		$setting    = $manager->add_setting( $setting_id );
 		$this->assertSame( 'WP_Customize_Setting', get_class( $setting ) );
-		$this->assertObjectNotHasAttribute( 'custom', $setting );
+		$this->assertObjectNotHasProperty( 'custom', $setting );
 		$manager->remove_setting( $setting_id );
 
 		add_filter( 'customize_dynamic_setting_class', array( $this, 'return_dynamic_customize_setting_class' ), 10, 3 );
 		add_filter( 'customize_dynamic_setting_args', array( $this, 'return_dynamic_customize_setting_args' ), 10, 2 );
 		$setting = $manager->add_setting( $setting_id );
 		$this->assertSame( 'Test_Dynamic_Customize_Setting', get_class( $setting ) );
-		$this->assertObjectHasAttribute( 'custom', $setting );
+		$this->assertObjectHasProperty( 'custom', $setting );
 		$this->assertSame( 'foo', $setting->custom );
 	}
 
@@ -3669,5 +3669,4 @@ class Test_Setting_Without_Applying_Validate_Filter extends WP_Customize_Setting
 		}
 		return true;
 	}
-
 }
diff --git a/tests/customize/nav-menu-item-setting.php b/tests/customize/nav-menu-item-setting.php
index 256e5f577c..22d4bc7de7 100644
--- a/tests/customize/nav-menu-item-setting.php
+++ b/tests/customize/nav-menu-item-setting.php
@@ -926,17 +926,17 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$nav_menu_item = $setting->value_as_wp_post_nav_menu_item();
 		$this->assertSame( 'Custom Label', $nav_menu_item->type_label );
 
-		$this->assertObjectNotHasAttribute( 'nav_menu_term_id', $nav_menu_item );
-		$this->assertObjectNotHasAttribute( 'status', $nav_menu_item );
+		$this->assertObjectNotHasProperty( 'nav_menu_term_id', $nav_menu_item );
+		$this->assertObjectNotHasProperty( 'status', $nav_menu_item );
 		$this->assertSame( 'publish', $nav_menu_item->post_status );
 		$this->assertSame( 'nav_menu_item', $nav_menu_item->post_type );
-		$this->assertObjectNotHasAttribute( 'position', $nav_menu_item );
+		$this->assertObjectNotHasProperty( 'position', $nav_menu_item );
 		$this->assertSame( $post_value['position'], $nav_menu_item->menu_order );
 		$this->assertSame( $post_value['title'], $nav_menu_item->post_title );
 		$this->assertSame( 123, $nav_menu_item->ID );
 		$this->assertSame( 123, $nav_menu_item->db_id );
 		$this->assertSame( wp_get_current_user()->ID, $nav_menu_item->post_author );
-		$this->assertObjectHasAttribute( 'type_label', $nav_menu_item );
+		$this->assertObjectHasProperty( 'type_label', $nav_menu_item );
 		$expected = apply_filters( 'nav_menu_attr_title', wp_unslash( apply_filters( 'excerpt_save_pre', wp_slash( $post_value['attr_title'] ) ) ) );
 		$this->assertSame( $expected, $nav_menu_item->attr_title );
 		$this->assertSame( 'Attempted \o/ o&#8217;o markup', $nav_menu_item->description );
@@ -1070,7 +1070,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$this->assertSame( $original_post_title, $item_value['original_title'] );
 		$this->assertSame( '', $item_value['title'] );
 		$item = $setting->value_as_wp_post_nav_menu_item();
-		$this->assertObjectHasAttribute( 'type_label', $item );
+		$this->assertObjectHasProperty( 'type_label', $item );
 		$this->assertSame( $original_post_title, $item->original_title );
 		$this->assertSame( $original_post_title, $item->title );
 		$this->assertArrayHasKey( 'type_label', $item_value );
@@ -1097,7 +1097,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$this->assertSame( $original_post_title, $item_value['original_title'] );
 		$this->assertSame( '', $item_value['title'] );
 		$item = $setting->value_as_wp_post_nav_menu_item();
-		$this->assertObjectHasAttribute( 'type_label', $item );
+		$this->assertObjectHasProperty( 'type_label', $item );
 		$this->assertSame( $original_post_title, $item->original_title );
 		$this->assertSame( $original_post_title, $item->title );
 		$this->assertArrayHasKey( 'type_label', $item_value );
@@ -1124,7 +1124,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$this->assertSame( $original_term_title, $item_value['original_title'] );
 		$this->assertSame( '', $item_value['title'] );
 		$item = $setting->value_as_wp_post_nav_menu_item();
-		$this->assertObjectHasAttribute( 'type_label', $item );
+		$this->assertObjectHasProperty( 'type_label', $item );
 		$this->assertSame( $original_term_title, $item->original_title );
 		$this->assertSame( $original_term_title, $item->title );
 		$this->assertArrayHasKey( 'type_label', $item_value );
@@ -1151,7 +1151,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$this->assertSame( $original_term_title, $item_value['original_title'] );
 		$this->assertSame( '', $item_value['title'] );
 		$item = $setting->value_as_wp_post_nav_menu_item();
-		$this->assertObjectHasAttribute( 'type_label', $item );
+		$this->assertObjectHasProperty( 'type_label', $item );
 		$this->assertSame( $original_term_title, $item->original_title );
 		$this->assertSame( $original_term_title, $item->title );
 		$this->assertArrayHasKey( 'type_label', $item_value );
@@ -1177,7 +1177,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$this->assertSame( get_post_type_object( 'press_release' )->labels->archives, $item_value['original_title'] );
 		$this->assertSame( '', $item_value['title'] );
 		$item = $setting->value_as_wp_post_nav_menu_item();
-		$this->assertObjectHasAttribute( 'type_label', $item );
+		$this->assertObjectHasProperty( 'type_label', $item );
 		$this->assertSame( get_post_type_object( 'press_release' )->labels->archives, $item->original_title );
 		$this->assertSame( get_post_type_object( 'press_release' )->labels->archives, $item->title );
 		$this->assertArrayHasKey( 'type_label', $item_value );
@@ -1203,7 +1203,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$this->assertSame( get_post_type_object( 'press_release' )->labels->archives, $item_value['original_title'] );
 		$this->assertSame( '', $item_value['title'] );
 		$item = $setting->value_as_wp_post_nav_menu_item();
-		$this->assertObjectHasAttribute( 'type_label', $item );
+		$this->assertObjectHasProperty( 'type_label', $item );
 		$this->assertSame( get_post_type_object( 'press_release' )->labels->archives, $item->original_title );
 		$this->assertSame( get_post_type_object( 'press_release' )->labels->archives, $item->title );
 		$this->assertArrayHasKey( 'type_label', $item_value );
diff --git a/tests/customize/nav-menus.php b/tests/customize/nav-menus.php
index 6cc8f3d08c..e0c80d1a56 100644
--- a/tests/customize/nav-menus.php
+++ b/tests/customize/nav-menus.php
@@ -655,7 +655,6 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 		add_filter( 'customize_nav_menu_available_item_types', array( $this, 'filter_item_types' ) );
 		$this->assertSame( $expected, $menus->available_item_types() );
 		remove_filter( 'customize_nav_menu_available_item_types', array( $this, 'filter_item_types' ) );
-
 	}
 
 	/**
diff --git a/tests/customize/panel.php b/tests/customize/panel.php
index ab7859499e..40f198675a 100644
--- a/tests/customize/panel.php
+++ b/tests/customize/panel.php
@@ -237,5 +237,4 @@ class Custom_Panel_Test extends WP_Customize_Panel {
 		</li>
 		<?php
 	}
-
 }
diff --git a/tests/customize/section.php b/tests/customize/section.php
index da35a54eaa..ea2d55b658 100644
--- a/tests/customize/section.php
+++ b/tests/customize/section.php
@@ -239,5 +239,4 @@ class Custom_Section_Test extends WP_Customize_Section {
 		</li>
 		<?php
 	}
-
 }
diff --git a/tests/customize/setting.php b/tests/customize/setting.php
index ef7ea0d93a..85091b5760 100644
--- a/tests/customize/setting.php
+++ b/tests/customize/setting.php
@@ -765,4 +765,3 @@ class Tests_WP_Customize_Setting extends WP_UnitTestCase {
 		$this->assertSame( $override_value, $setting->value() );
 	}
 }
-
diff --git a/tests/customize/widgets.php b/tests/customize/widgets.php
index 654008a7a9..77b1419440 100644
--- a/tests/customize/widgets.php
+++ b/tests/customize/widgets.php
@@ -236,7 +236,7 @@ class Tests_WP_Customize_Widgets extends WP_UnitTestCase {
 
 		$selective_refreshable_widgets = $this->manager->widgets->get_selective_refreshable_widgets();
 		$this->assertIsArray( $selective_refreshable_widgets );
-		$this->assertSame( count( $wp_widget_factory->widgets ), count( $selective_refreshable_widgets ) );
+		$this->assertCount( count( $wp_widget_factory->widgets ), $selective_refreshable_widgets );
 		$this->assertArrayHasKey( 'text', $selective_refreshable_widgets );
 		$this->assertTrue( $selective_refreshable_widgets['text'] );
 		$this->assertArrayHasKey( 'search', $selective_refreshable_widgets );
diff --git a/tests/date/dateI18n.php b/tests/date/dateI18n.php
index 1fe6f38a95..544ea9ae47 100644
--- a/tests/date/dateI18n.php
+++ b/tests/date/dateI18n.php
@@ -117,10 +117,6 @@ class Tests_Date_DateI18n extends WP_UnitTestCase {
 		update_option( 'timezone_string', 'America/Buenos_Aires' ); // This timezone was deprecated pre-PHP 5.6.
 
 		$expected = '2022-08-01 00:00:00 -03 -03:00 America/Buenos_Aires';
-		if ( PHP_VERSION_ID < 70000 ) {
-			// PHP 5.6.
-			$expected = '2022-08-01 00:00:00 ART -03:00 America/Buenos_Aires';
-		}
 
 		$this->assertSame( $expected, date_i18n( 'Y-m-d H:i:s T P e', strtotime( '2022-08-01 00:00:00' ) ) );
 	}
diff --git a/tests/date/query.php b/tests/date/query.php
index 7fc21f3878..2f12d1fe90 100644
--- a/tests/date/query.php
+++ b/tests/date/query.php
@@ -579,7 +579,6 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$message = "Expected {$expected}, got {$found}";
 		$this->assertEqualsWithDelta( strtotime( $expected ), strtotime( $found ), 10, $message );
-
 	}
 
 	public function data_build_mysql_datetime_with_custom_timezone() {
@@ -1021,7 +1020,6 @@ class Tests_Date_Query extends WP_UnitTestCase {
 		foreach ( $seconds as $second ) {
 			$this->assertFalse( $this->q->validate_date_values( array( 'second' => $second ) ) );
 		}
-
 	}
 
 	/**
@@ -1186,7 +1184,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$parts = mb_split( '\)\s+AND\s+\(', $sql );
 		$this->assertIsArray( $parts, 'SQL query cannot be split into multiple parts using operator AND.' );
-		$this->assertSame( 2, count( $parts ), 'SQL query does not contain correct number of AND operators.' );
+		$this->assertCount( 2, $parts, 'SQL query does not contain correct number of AND operators.' );
 
 		$this->assertStringNotContainsString( 'OR', $sql, 'SQL query contains conditions joined by operator OR.' );
 	}
@@ -1233,7 +1231,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$parts = mb_split( '\)\s+OR\s+\(', $sql );
 		$this->assertIsArray( $parts, 'SQL query cannot be split into multiple parts using operator OR.' );
-		$this->assertSame( 2, count( $parts ), 'SQL query does not contain correct number of OR operators.' );
+		$this->assertCount( 2, $parts, 'SQL query does not contain correct number of OR operators.' );
 
 		// Checking number of occurrences of AND while skipping the one at the beginning.
 		$this->assertSame( 2, substr_count( substr( $sql, 5 ), 'AND' ), 'SQL query does not contain expected number conditions joined by operator AND.' );
@@ -1279,7 +1277,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$parts = mb_split( '\)\s+AND\s+\(', $sql );
 		$this->assertIsArray( $parts, 'SQL query cannot be split into multiple parts using operator AND.' );
-		$this->assertSame( 2, count( $parts ), 'SQL query does not contain correct number of AND operators.' );
+		$this->assertCount( 2, $parts, 'SQL query does not contain correct number of AND operators.' );
 
 		$this->assertStringNotContainsString( 'OR', $sql, 'SQL query contains conditions joined by operator OR.' );
 	}
diff --git a/tests/date/theDate.php b/tests/date/theDate.php
index 2337ab61ec..fffcb47ad5 100644
--- a/tests/date/theDate.php
+++ b/tests/date/theDate.php
@@ -80,7 +80,7 @@ class Tests_Date_TheDate extends WP_UnitTestCase {
 	}
 
 	public function count_hook( $input ) {
-		$this->hooks_called[ current_filter() ]++;
+		++$this->hooks_called[ current_filter() ];
 
 		return $input;
 	}
diff --git a/tests/db.php b/tests/db.php
index 11e35e4554..21c34cbadb 100644
--- a/tests/db.php
+++ b/tests/db.php
@@ -713,9 +713,6 @@ class Tests_DB extends WP_UnitTestCase {
 	 */
 	public function test_mysqli_flush_sync() {
 		global $wpdb;
-		if ( ! $wpdb->use_mysqli ) {
-			$this->markTestSkipped( 'mysqli not being used.' );
-		}
 
 		$suppress = $wpdb->suppress_errors( true );
 
diff --git a/tests/db/dbDelta.php b/tests/db/dbDelta.php
index 03426fa721..b28905749c 100644
--- a/tests/db/dbDelta.php
+++ b/tests/db/dbDelta.php
@@ -68,7 +68,6 @@ class Tests_DB_dbDelta extends WP_UnitTestCase {
 			$wpdb->prepare(
 				"
 				CREATE TABLE {$wpdb->prefix}dbdelta_test (" .
-					// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 					'id bigint(20) NOT NULL AUTO_INCREMENT,
 					column_1 varchar(255) NOT NULL,
 					column_2 text,
@@ -311,7 +310,6 @@ class Tests_DB_dbDelta extends WP_UnitTestCase {
 		);
 
 		$this->assertTableRowHasValue( 'column_1', 'wcphilly2015', $wpdb->prefix . 'dbdelta_test' );
-
 	}
 
 	/**
diff --git a/tests/dependencies.php b/tests/dependencies.php
index e5a7a33a7c..39a2860fc3 100644
--- a/tests/dependencies.php
+++ b/tests/dependencies.php
@@ -27,7 +27,6 @@ class Tests_Dependencies extends WP_UnitTestCase {
 
 		$this->assertFalse( $dep->query( 'one' ) );
 		$this->assertInstanceOf( '_WP_Dependency', $dep->query( 'two' ) );
-
 	}
 
 	public function test_enqueue() {
@@ -134,7 +133,6 @@ class Tests_Dependencies extends WP_UnitTestCase {
 
 		$dep->remove( 'one' );
 		$this->assertFalse( $dep->query( 'one' ) );
-
 	}
 
 	public function test_enqueue_before_register() {
diff --git a/tests/dependencies/scripts.php b/tests/dependencies/scripts.php
index 10e447728a..7f2b956127 100644
--- a/tests/dependencies/scripts.php
+++ b/tests/dependencies/scripts.php
@@ -10,25 +10,45 @@
  * @covers ::wp_set_script_translations
  */
 class Tests_Dependencies_Scripts extends WP_UnitTestCase {
+
+	/**
+	 * @var WP_Scripts
+	 */
 	protected $old_wp_scripts;
 
+	/**
+	 * @var WP_Styles
+	 */
+	protected $old_wp_styles;
+
 	protected $wp_scripts_print_translations_output;
 
+	/**
+	 * Stores a string reference to a default scripts directory name, utilised by certain tests.
+	 *
+	 * @var string
+	 */
+	protected $default_scripts_dir = '/directory/';
+
 	public function set_up() {
 		parent::set_up();
 		$this->old_wp_scripts = isset( $GLOBALS['wp_scripts'] ) ? $GLOBALS['wp_scripts'] : null;
+		$this->old_wp_styles  = isset( $GLOBALS['wp_styles'] ) ? $GLOBALS['wp_styles'] : null;
 		remove_action( 'wp_default_scripts', 'wp_default_scripts' );
 		remove_action( 'wp_default_scripts', 'wp_default_packages' );
 		$GLOBALS['wp_scripts']                  = new WP_Scripts();
 		$GLOBALS['wp_scripts']->default_version = get_bloginfo( 'version' );
+		$GLOBALS['wp_styles']                   = new WP_Styles();
 
 		$this->wp_scripts_print_translations_output  = <<<JS
 <script type='text/javascript' id='__HANDLE__-js-translations'>
+/* <![CDATA[ */
 ( function( domain, translations ) {
 	var localeData = translations.locale_data[ domain ] || translations.locale_data.messages;
 	localeData[""].domain = domain;
 	wp.i18n.setLocaleData( localeData, domain );
 } )( "__DOMAIN__", __JSON_TRANSLATIONS__ );
+/* ]]> */
 </script>
 JS;
 		$this->wp_scripts_print_translations_output .= "\n";
@@ -36,6 +56,7 @@ JS;
 
 	public function tear_down() {
 		$GLOBALS['wp_scripts'] = $this->old_wp_scripts;
+		$GLOBALS['wp_styles']  = $this->old_wp_styles;
 		add_action( 'wp_default_scripts', 'wp_default_scripts' );
 		parent::tear_down();
 	}
@@ -46,77 +67,1411 @@ JS;
 	 * @ticket 11315
 	 */
 	public function test_wp_enqueue_script() {
+		global $wp_version;
+
 		wp_enqueue_script( 'no-deps-no-version', 'example.com', array() );
 		wp_enqueue_script( 'empty-deps-no-version', 'example.com' );
 		wp_enqueue_script( 'empty-deps-version', 'example.com', array(), 1.2 );
 		wp_enqueue_script( 'empty-deps-null-version', 'example.com', array(), null );
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='http://example.com?ver=$ver' id='no-deps-no-version-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='http://example.com?ver=$ver' id='empty-deps-no-version-js'></script>\n";
+		$expected  = "<script type='text/javascript' src='http://example.com?ver={$wp_version}' id='no-deps-no-version-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='http://example.com?ver={$wp_version}' id='empty-deps-no-version-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com?ver=1.2' id='empty-deps-version-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='empty-deps-null-version-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 
 		// No scripts left to print.
 		$this->assertSame( '', get_echo( 'wp_print_scripts' ) );
 	}
 
+	/**
+	 * Gets delayed strategies as a data provider.
+	 *
+	 * @return array[] Delayed strategies.
+	 */
+	public function data_provider_delayed_strategies() {
+		return array(
+			'defer' => array( 'defer' ),
+			'async' => array( 'async' ),
+		);
+	}
+
+	/**
+	 * Tests that inline scripts in the `after` position, attached to delayed main scripts, remain unaffected.
+	 *
+	 * If the main script with delayed loading strategy has an `after` inline script,
+	 * the inline script should not be affected.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_inline_script_tag
+	 * @covers ::wp_add_inline_script
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @dataProvider data_provider_delayed_strategies
+	 *
+	 * @param string $strategy Strategy.
+	 */
+	public function test_after_inline_script_with_delayed_main_script( $strategy ) {
+		wp_enqueue_script( 'ms-isa-1', 'http://example.org/ms-isa-1.js', array(), null, compact( 'strategy' ) );
+		wp_add_inline_script( 'ms-isa-1', 'console.log("after one");', 'after' );
+		$output    = get_echo( 'wp_print_scripts' );
+		$expected  = "<script type='text/javascript' src='http://example.org/ms-isa-1.js' id='ms-isa-1-js' data-wp-strategy='{$strategy}'></script>\n";
+		$expected .= wp_get_inline_script_tag(
+			'console.log("after one");',
+			array(
+				'id' => 'ms-isa-1-js-after',
+			)
+		);
+		$this->assertEqualMarkup( $expected, $output, 'Inline scripts in the "after" position, that are attached to a deferred main script, are failing to print/execute.' );
+	}
+
+	/**
+	 * Tests that inline scripts in the `after` position, attached to a blocking main script, are rendered as javascript.
+	 *
+	 * If a main script with a `blocking` strategy has an `after` inline script,
+	 * the inline script should be rendered as type='text/javascript'.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_inline_script_tag
+	 * @covers ::wp_add_inline_script
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_after_inline_script_with_blocking_main_script() {
+		wp_enqueue_script( 'ms-insa-3', 'http://example.org/ms-insa-3.js', array(), null );
+		wp_add_inline_script( 'ms-insa-3', 'console.log("after one");', 'after' );
+		$output = get_echo( 'wp_print_scripts' );
+
+		$expected  = "<script type='text/javascript' src='http://example.org/ms-insa-3.js' id='ms-insa-3-js'></script>\n";
+		$expected .= wp_get_inline_script_tag(
+			'console.log("after one");',
+			array(
+				'id' => 'ms-insa-3-js-after',
+			)
+		);
+
+		$this->assertEqualMarkup( $expected, $output, 'Inline scripts in the "after" position, that are attached to a blocking main script, are failing to print/execute.' );
+	}
+
+	/**
+	 * Tests that inline scripts in the `before` position, attached to a delayed inline main script, results in all
+	 * dependents being delayed.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_inline_script_tag
+	 * @covers ::wp_add_inline_script
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @dataProvider data_provider_delayed_strategies
+	 *
+	 * @param string $strategy
+	 */
+	public function test_before_inline_scripts_with_delayed_main_script( $strategy ) {
+		wp_enqueue_script( 'ds-i1-1', 'http://example.org/ds-i1-1.js', array(), null, compact( 'strategy' ) );
+		wp_add_inline_script( 'ds-i1-1', 'console.log("before first");', 'before' );
+		wp_enqueue_script( 'ds-i1-2', 'http://example.org/ds-i1-2.js', array(), null, compact( 'strategy' ) );
+		wp_enqueue_script( 'ds-i1-3', 'http://example.org/ds-i1-3.js', array(), null, compact( 'strategy' ) );
+		wp_enqueue_script( 'ms-i1-1', 'http://example.org/ms-i1-1.js', array( 'ds-i1-1', 'ds-i1-2', 'ds-i1-3' ), null, compact( 'strategy' ) );
+		wp_add_inline_script( 'ms-i1-1', 'console.log("before last");', 'before' );
+		$output = get_echo( 'wp_print_scripts' );
+
+		$expected  = wp_get_inline_script_tag(
+			'console.log("before first");',
+			array(
+				'id' => 'ds-i1-1-js-before',
+			)
+		);
+		$expected .= "<script type='text/javascript' src='http://example.org/ds-i1-1.js' id='ds-i1-1-js' $strategy data-wp-strategy='{$strategy}'></script>\n";
+		$expected .= "<script type='text/javascript' src='http://example.org/ds-i1-2.js' id='ds-i1-2-js' $strategy data-wp-strategy='{$strategy}'></script>\n";
+		$expected .= "<script type='text/javascript' src='http://example.org/ds-i1-3.js' id='ds-i1-3-js' $strategy data-wp-strategy='{$strategy}'></script>\n";
+		$expected .= wp_get_inline_script_tag(
+			'console.log("before last");',
+			array(
+				'id'   => 'ms-i1-1-js-before',
+				'type' => 'text/javascript',
+			)
+		);
+		$expected .= "<script type='text/javascript' src='http://example.org/ms-i1-1.js' id='ms-i1-1-js' {$strategy} data-wp-strategy='{$strategy}'></script>\n";
+
+		$this->assertEqualMarkup( $expected, $output, 'Inline scripts in the "before" position, that are attached to a deferred main script, are failing to print/execute.' );
+	}
+
+	/**
+	 * Tests that scripts registered with an async strategy print with the async attribute.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_loading_strategy_with_valid_async_registration() {
+		// No dependents, No dependencies then async.
+		wp_enqueue_script( 'main-script-a1', '/main-script-a1.js', array(), null, array( 'strategy' => 'async' ) );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = "<script type='text/javascript' src='/main-script-a1.js' id='main-script-a1-js' async data-wp-strategy='async'></script>\n";
+		$this->assertEqualMarkup( $expected, $output, 'Scripts enqueued with an async loading strategy are failing to have the async attribute applied to the script handle when being printed.' );
+	}
+
+	/**
+	 * Tests that dependents of a blocking dependency script are free to contain any strategy.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @dataProvider data_provider_delayed_strategies
+	 *
+	 * @param string $strategy Strategy.
+	 */
+	public function test_delayed_dependent_with_blocking_dependency( $strategy ) {
+		wp_enqueue_script( 'dependency-script-a2', '/dependency-script-a2.js', array(), null );
+		wp_enqueue_script( 'main-script-a2', '/main-script-a2.js', array( 'dependency-script-a2' ), null, compact( 'strategy' ) );
+		$output    = get_echo( 'wp_print_scripts' );
+		$expected  = "<script id='dependency-script-a2-js' src='/dependency-script-a2.js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/main-script-a2.js' id='main-script-a2-js' {$strategy} data-wp-strategy='{$strategy}'></script>";
+		$this->assertEqualMarkup( $expected, $output, 'Dependents of a blocking dependency are free to have any strategy.' );
+	}
+
+	/**
+	 * Tests that blocking dependents force delayed dependencies to become blocking.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @dataProvider data_provider_delayed_strategies
+	 * @param string $strategy Strategy.
+	 */
+	public function test_blocking_dependent_with_delayed_dependency( $strategy ) {
+		wp_enqueue_script( 'main-script-a3', '/main-script-a3.js', array(), null, compact( 'strategy' ) );
+		wp_enqueue_script( 'dependent-script-a3', '/dependent-script-a3.js', array( 'main-script-a3' ), null );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = <<<JS
+			<script type='text/javascript' src='/main-script-a3.js' id='main-script-a3-js' data-wp-strategy='{$strategy}'></script>
+			<script id="dependent-script-a3-js" src="/dependent-script-a3.js" type="text/javascript"></script>
+JS;
+		$this->assertEqualMarkup( $expected, $output, 'Blocking dependents must force delayed dependencies to become blocking.' );
+	}
+
+	/**
+	 * Tests that only enqueued dependents effect the eligible loading strategy.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @dataProvider data_provider_delayed_strategies
+	 * @param string $strategy Strategy.
+	 */
+	public function test_delayed_dependent_with_blocking_dependency_not_enqueued( $strategy ) {
+		$this->add_html5_script_theme_support();
+		wp_enqueue_script( 'main-script-a4', '/main-script-a4.js', array(), null, compact( 'strategy' ) );
+		// This dependent is registered but not enqueued, so it should not factor into the eligible loading strategy.
+		wp_register_script( 'dependent-script-a4', '/dependent-script-a4.js', array( 'main-script-a4' ), null );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = str_replace( "'", '"', "<script src='/main-script-a4.js' id='main-script-a4-js' {$strategy} data-wp-strategy='{$strategy}'></script>" );
+		$this->assertStringContainsString( $expected, $output, 'Only enqueued dependents should affect the eligible strategy.' );
+	}
+
+	/**
+	 * Data provider for test_filter_eligible_strategies.
+	 *
+	 * @return array
+	 */
+	public function get_data_to_filter_eligible_strategies() {
+		return array(
+			'no_dependents'                       => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'one_delayed_dependent'               => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null, array( 'strategy' => 'defer' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'one_blocking_dependent'              => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null );
+					return 'foo';
+				},
+				'expected' => array(),
+			),
+			'one_blocking_dependent_not_enqueued' => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					wp_register_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ), // Because bar was not enqueued, only foo was.
+			),
+			'two_delayed_dependents'              => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null, array( 'strategy' => 'defer' ) );
+					wp_enqueue_script( 'baz', 'https://example.com/baz.js', array( 'foo' ), null, array( 'strategy' => 'defer' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'recursion_not_delayed'               => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array( 'foo' ), null );
+					return 'foo';
+				},
+				'expected' => array(),
+			),
+			'recursion_yes_delayed'               => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array( 'foo' ), null, array( 'strategy' => 'defer' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'recursion_triple_level'              => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array( 'baz' ), null, array( 'strategy' => 'defer' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null, array( 'strategy' => 'defer' ) );
+					wp_enqueue_script( 'baz', 'https://example.com/bar.js', array( 'bar' ), null, array( 'strategy' => 'defer' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'async_only_with_async_dependency'    => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'async' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null, array( 'strategy' => 'async' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer', 'async' ),
+			),
+			'async_only_with_defer_dependency'    => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'async' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null, array( 'strategy' => 'defer' ) );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'async_only_with_blocking_dependency' => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'async' ) );
+					wp_enqueue_script( 'bar', 'https://example.com/bar.js', array( 'foo' ), null );
+					return 'foo';
+				},
+				'expected' => array(),
+			),
+			'defer_with_inline_after_script'      => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					wp_add_inline_script( 'foo', 'console.log("foo")', 'after' );
+					return 'foo';
+				},
+				'expected' => array(),
+			),
+			'defer_with_inline_before_script'     => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'defer' ) );
+					wp_add_inline_script( 'foo', 'console.log("foo")', 'before' );
+					return 'foo';
+				},
+				'expected' => array( 'defer' ),
+			),
+			'async_with_inline_after_script'      => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'async' ) );
+					wp_add_inline_script( 'foo', 'console.log("foo")', 'after' );
+					return 'foo';
+				},
+				'expected' => array(),
+			),
+			'async_with_inline_before_script'     => array(
+				'set_up'   => static function () {
+					wp_enqueue_script( 'foo', 'https://example.com/foo.js', array(), null, array( 'strategy' => 'async' ) );
+					wp_add_inline_script( 'foo', 'console.log("foo")', 'before' );
+					return 'foo';
+				},
+				'expected' => array( 'defer', 'async' ),
+			),
+		);
+	}
+
+	/**
+	 * Tests that the filter_eligible_strategies method works as expected and returns the correct value.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 *
+	 * @dataProvider get_data_to_filter_eligible_strategies
+	 *
+	 * @param callable $set_up     Set up.
+	 * @param bool     $async_only Async only.
+	 * @param bool     $expected   Expected return value.
+	 */
+	public function test_filter_eligible_strategies( $set_up, $expected ) {
+		$handle = $set_up();
+
+		$wp_scripts_reflection      = new ReflectionClass( WP_Scripts::class );
+		$filter_eligible_strategies = $wp_scripts_reflection->getMethod( 'filter_eligible_strategies' );
+		$filter_eligible_strategies->setAccessible( true );
+		$this->assertSame( $expected, $filter_eligible_strategies->invokeArgs( wp_scripts(), array( $handle ) ), 'Expected return value of WP_Scripts::filter_eligible_strategies to match.' );
+	}
+
+	/**
+	 * Register test script.
+	 *
+	 * @param string   $handle    Dependency handle to enqueue.
+	 * @param string   $strategy  Strategy to use for dependency.
+	 * @param string[] $deps      Dependencies for the script.
+	 * @param bool     $in_footer Whether to print the script in the footer.
+	 */
+	protected function register_test_script( $handle, $strategy, $deps = array(), $in_footer = false ) {
+		wp_register_script(
+			$handle,
+			add_query_arg(
+				array(
+					'script_event_log' => "$handle: script",
+				),
+				'https://example.com/external.js'
+			),
+			$deps,
+			null
+		);
+		if ( 'blocking' !== $strategy ) {
+			wp_script_add_data( $handle, 'strategy', $strategy );
+		}
+	}
+
+	/**
+	 * Enqueue test script.
+	 *
+	 * @param string   $handle    Dependency handle to enqueue.
+	 * @param string   $strategy  Strategy to use for dependency.
+	 * @param string[] $deps      Dependencies for the script.
+	 * @param bool     $in_footer Whether to print the script in the footer.
+	 */
+	protected function enqueue_test_script( $handle, $strategy, $deps = array(), $in_footer = false ) {
+		$this->register_test_script( $handle, $strategy, $deps, $in_footer );
+		wp_enqueue_script( $handle );
+	}
+
+	/**
+	 * Adds test inline script.
+	 *
+	 * @param string $handle   Dependency handle to enqueue.
+	 * @param string $position Position.
+	 */
+	protected function add_test_inline_script( $handle, $position ) {
+		wp_add_inline_script( $handle, sprintf( 'scriptEventLog.push( %s )', wp_json_encode( "{$handle}: {$position} inline" ) ), $position );
+	}
+
+	/**
+	 * Data provider to test various strategy dependency chains.
+	 *
+	 * @return array[]
+	 */
+	public function data_provider_to_test_various_strategy_dependency_chains() {
+		return array(
+			'async-dependent-with-one-blocking-dependency' => array(
+				'set_up'          => function () {
+					$handle1 = 'blocking-not-async-without-dependency';
+					$handle2 = 'async-with-blocking-dependency';
+					$this->enqueue_test_script( $handle1, 'blocking', array() );
+					$this->enqueue_test_script( $handle2, 'async', array( $handle1 ) );
+					foreach ( array( $handle1, $handle2 ) as $handle ) {
+						$this->add_test_inline_script( $handle, 'before' );
+						$this->add_test_inline_script( $handle, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="blocking-not-async-without-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-not-async-without-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=blocking-not-async-without-dependency:%20script' id='blocking-not-async-without-dependency-js'></script>
+<script id="blocking-not-async-without-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-not-async-without-dependency: after inline" )
+</script>
+<script id="async-with-blocking-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "async-with-blocking-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-with-blocking-dependency:%20script' id='async-with-blocking-dependency-js' data-wp-strategy='async'></script>
+<script id="async-with-blocking-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "async-with-blocking-dependency: after inline" )
+</script>
+HTML
+				,
+				/*
+				 * Note: The above comma must be on its own line in PHP<7.3 and not after the `HTML` identifier
+				 * terminating the heredoc. Otherwise, a syntax error is raised with the line number being wildly wrong:
+				 *
+				 * PHP Parse error:  syntax error, unexpected '' (T_ENCAPSED_AND_WHITESPACE), expecting '-' or identifier (T_STRING) or variable (T_VARIABLE) or number (T_NUM_STRING)
+				 */
+			),
+			'async-with-async-dependencies'                => array(
+				'set_up'          => function () {
+					$handle1 = 'async-no-dependency';
+					$handle2 = 'async-one-async-dependency';
+					$handle3 = 'async-two-async-dependencies';
+					$this->enqueue_test_script( $handle1, 'async', array() );
+					$this->enqueue_test_script( $handle2, 'async', array( $handle1 ) );
+					$this->enqueue_test_script( $handle3, 'async', array( $handle1, $handle2 ) );
+					foreach ( array( $handle1, $handle2, $handle3 ) as $handle ) {
+						$this->add_test_inline_script( $handle, 'before' );
+						$this->add_test_inline_script( $handle, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="async-no-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "async-no-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-no-dependency:%20script' id='async-no-dependency-js' data-wp-strategy='async'></script>
+<script id="async-no-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "async-no-dependency: after inline" )
+</script>
+<script id="async-one-async-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "async-one-async-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-one-async-dependency:%20script' id='async-one-async-dependency-js' data-wp-strategy='async'></script>
+<script id="async-one-async-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "async-one-async-dependency: after inline" )
+</script>
+<script id="async-two-async-dependencies-js-before" type="text/javascript">
+scriptEventLog.push( "async-two-async-dependencies: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-two-async-dependencies:%20script' id='async-two-async-dependencies-js' data-wp-strategy='async'></script>
+<script id="async-two-async-dependencies-js-after" type="text/javascript">
+scriptEventLog.push( "async-two-async-dependencies: after inline" )
+</script>
+HTML
+				,
+			),
+			'async-with-blocking-dependency'               => array(
+				'set_up'          => function () {
+					$handle1 = 'async-with-blocking-dependent';
+					$handle2 = 'blocking-dependent-of-async';
+					$this->enqueue_test_script( $handle1, 'async', array() );
+					$this->enqueue_test_script( $handle2, 'blocking', array( $handle1 ) );
+					foreach ( array( $handle1, $handle2 ) as $handle ) {
+						$this->add_test_inline_script( $handle, 'before' );
+						$this->add_test_inline_script( $handle, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="async-with-blocking-dependent-js-before" type="text/javascript">
+scriptEventLog.push( "async-with-blocking-dependent: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-with-blocking-dependent:%20script' id='async-with-blocking-dependent-js' data-wp-strategy='async'></script>
+<script id="async-with-blocking-dependent-js-after" type="text/javascript">
+scriptEventLog.push( "async-with-blocking-dependent: after inline" )
+</script>
+<script id="blocking-dependent-of-async-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-dependent-of-async: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=blocking-dependent-of-async:%20script' id='blocking-dependent-of-async-js'></script>
+<script id="blocking-dependent-of-async-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-dependent-of-async: after inline" )
+</script>
+HTML
+				,
+			),
+			'defer-with-async-dependency'                  => array(
+				'set_up'          => function () {
+					$handle1 = 'async-with-defer-dependent';
+					$handle2 = 'defer-dependent-of-async';
+					$this->enqueue_test_script( $handle1, 'async', array() );
+					$this->enqueue_test_script( $handle2, 'defer', array( $handle1 ) );
+					foreach ( array( $handle1, $handle2 ) as $handle ) {
+						$this->add_test_inline_script( $handle, 'before' );
+						$this->add_test_inline_script( $handle, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="async-with-defer-dependent-js-before" type="text/javascript">
+scriptEventLog.push( "async-with-defer-dependent: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-with-defer-dependent:%20script' id='async-with-defer-dependent-js' data-wp-strategy='async'></script>
+<script id="async-with-defer-dependent-js-after" type="text/javascript">
+scriptEventLog.push( "async-with-defer-dependent: after inline" )
+</script>
+<script id="defer-dependent-of-async-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-async: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-async:%20script' id='defer-dependent-of-async-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-async-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-async: after inline" )
+</script>
+HTML
+				,
+			),
+			'blocking-bundle-of-none-with-inline-scripts-and-defer-dependent' => array(
+				'set_up'          => function () {
+					$handle1 = 'blocking-bundle-of-none';
+					$handle2 = 'defer-dependent-of-blocking-bundle-of-none';
+
+					wp_register_script( $handle1, false, array(), null );
+					$this->add_test_inline_script( $handle1, 'before' );
+					$this->add_test_inline_script( $handle1, 'after' );
+
+					// Note: the before script for this will be blocking because the dependency is blocking.
+					$this->enqueue_test_script( $handle2, 'defer', array( $handle1 ) );
+					$this->add_test_inline_script( $handle2, 'before' );
+					$this->add_test_inline_script( $handle2, 'after' );
+				},
+				'expected_markup' => <<<HTML
+<script id="blocking-bundle-of-none-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-bundle-of-none: before inline" )
+</script>
+<script id="blocking-bundle-of-none-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-bundle-of-none: after inline" )
+</script>
+<script id="defer-dependent-of-blocking-bundle-of-none-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-blocking-bundle-of-none: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-blocking-bundle-of-none:%20script' id='defer-dependent-of-blocking-bundle-of-none-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-blocking-bundle-of-none-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-blocking-bundle-of-none: after inline" )
+</script>
+HTML
+				,
+			),
+			'blocking-bundle-of-two-with-defer-dependent'  => array(
+				'set_up'          => function () {
+					$handle1 = 'blocking-bundle-of-two';
+					$handle2 = 'blocking-bundle-member-one';
+					$handle3 = 'blocking-bundle-member-two';
+					$handle4 = 'defer-dependent-of-blocking-bundle-of-two';
+
+					wp_register_script( $handle1, false, array( $handle2, $handle3 ), null );
+					$this->enqueue_test_script( $handle2, 'blocking' );
+					$this->enqueue_test_script( $handle3, 'blocking' );
+					$this->enqueue_test_script( $handle4, 'defer', array( $handle1 ) );
+
+					foreach ( array( $handle2, $handle3, $handle4 ) as $handle ) {
+						$this->add_test_inline_script( $handle, 'before' );
+						$this->add_test_inline_script( $handle, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="blocking-bundle-member-one-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-bundle-member-one: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=blocking-bundle-member-one:%20script' id='blocking-bundle-member-one-js'></script>
+<script id="blocking-bundle-member-one-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-bundle-member-one: after inline" )
+</script>
+<script id="blocking-bundle-member-two-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-bundle-member-two: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=blocking-bundle-member-two:%20script' id='blocking-bundle-member-two-js'></script>
+<script id="blocking-bundle-member-two-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-bundle-member-two: after inline" )
+</script>
+<script id="defer-dependent-of-blocking-bundle-of-two-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-blocking-bundle-of-two: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-blocking-bundle-of-two:%20script' id='defer-dependent-of-blocking-bundle-of-two-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-blocking-bundle-of-two-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-blocking-bundle-of-two: after inline" )
+</script>
+HTML
+				,
+			),
+			'defer-bundle-of-none-with-inline-scripts-and-defer-dependents' => array(
+				'set_up'          => function () {
+					$handle1 = 'defer-bundle-of-none';
+					$handle2 = 'defer-dependent-of-defer-bundle-of-none';
+
+					// The eligible loading strategy for this will be forced to be blocking when rendered since $src = false.
+					wp_register_script( $handle1, false, array(), null );
+					wp_scripts()->registered[ $handle1 ]->extra['strategy'] = 'defer'; // Bypass wp_script_add_data() which should no-op with _doing_it_wrong() because of $src=false.
+					$this->add_test_inline_script( $handle1, 'before' );
+					$this->add_test_inline_script( $handle1, 'after' );
+
+					// Note: the before script for this will be blocking because the dependency is blocking.
+					$this->enqueue_test_script( $handle2, 'defer', array( $handle1 ) );
+					$this->add_test_inline_script( $handle2, 'before' );
+					$this->add_test_inline_script( $handle2, 'after' );
+				},
+				'expected_markup' => <<<HTML
+<script id="defer-bundle-of-none-js-before" type="text/javascript">
+scriptEventLog.push( "defer-bundle-of-none: before inline" )
+</script>
+<script id="defer-bundle-of-none-js-after" type="text/javascript">
+scriptEventLog.push( "defer-bundle-of-none: after inline" )
+</script>
+<script id="defer-dependent-of-defer-bundle-of-none-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-defer-bundle-of-none: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-defer-bundle-of-none:%20script' id='defer-dependent-of-defer-bundle-of-none-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-defer-bundle-of-none-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-defer-bundle-of-none: after inline" )
+</script>
+HTML
+				,
+			),
+			'defer-dependent-with-blocking-and-defer-dependencies' => array(
+				'set_up'          => function () {
+					$handle1 = 'blocking-dependency-with-defer-following-dependency';
+					$handle2 = 'defer-dependency-with-blocking-preceding-dependency';
+					$handle3 = 'defer-dependent-of-blocking-and-defer-dependencies';
+					$this->enqueue_test_script( $handle1, 'blocking', array() );
+					$this->enqueue_test_script( $handle2, 'defer', array() );
+					$this->enqueue_test_script( $handle3, 'defer', array( $handle1, $handle2 ) );
+
+					foreach ( array( $handle1, $handle2, $handle3 ) as $dep ) {
+						$this->add_test_inline_script( $dep, 'before' );
+						$this->add_test_inline_script( $dep, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="blocking-dependency-with-defer-following-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-dependency-with-defer-following-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=blocking-dependency-with-defer-following-dependency:%20script' id='blocking-dependency-with-defer-following-dependency-js'></script>
+<script id="blocking-dependency-with-defer-following-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-dependency-with-defer-following-dependency: after inline" )
+</script>
+<script id="defer-dependency-with-blocking-preceding-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependency-with-blocking-preceding-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependency-with-blocking-preceding-dependency:%20script' id='defer-dependency-with-blocking-preceding-dependency-js' data-wp-strategy='defer'></script>
+<script id="defer-dependency-with-blocking-preceding-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependency-with-blocking-preceding-dependency: after inline" )
+</script>
+<script id="defer-dependent-of-blocking-and-defer-dependencies-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-blocking-and-defer-dependencies: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-blocking-and-defer-dependencies:%20script' id='defer-dependent-of-blocking-and-defer-dependencies-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-blocking-and-defer-dependencies-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-blocking-and-defer-dependencies: after inline" )
+</script>
+HTML
+				,
+			),
+			'defer-dependent-with-defer-and-blocking-dependencies' => array(
+				'set_up'          => function () {
+					$handle1 = 'defer-dependency-with-blocking-following-dependency';
+					$handle2 = 'blocking-dependency-with-defer-preceding-dependency';
+					$handle3 = 'defer-dependent-of-defer-and-blocking-dependencies';
+					$this->enqueue_test_script( $handle1, 'defer', array() );
+					$this->enqueue_test_script( $handle2, 'blocking', array() );
+					$this->enqueue_test_script( $handle3, 'defer', array( $handle1, $handle2 ) );
+
+					foreach ( array( $handle1, $handle2, $handle3 ) as $dep ) {
+						$this->add_test_inline_script( $dep, 'before' );
+						$this->add_test_inline_script( $dep, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="defer-dependency-with-blocking-following-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependency-with-blocking-following-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependency-with-blocking-following-dependency:%20script' id='defer-dependency-with-blocking-following-dependency-js' data-wp-strategy='defer'></script>
+<script id="defer-dependency-with-blocking-following-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependency-with-blocking-following-dependency: after inline" )
+</script>
+<script id="blocking-dependency-with-defer-preceding-dependency-js-before" type="text/javascript">
+scriptEventLog.push( "blocking-dependency-with-defer-preceding-dependency: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=blocking-dependency-with-defer-preceding-dependency:%20script' id='blocking-dependency-with-defer-preceding-dependency-js'></script>
+<script id="blocking-dependency-with-defer-preceding-dependency-js-after" type="text/javascript">
+scriptEventLog.push( "blocking-dependency-with-defer-preceding-dependency: after inline" )
+</script>
+<script id="defer-dependent-of-defer-and-blocking-dependencies-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-defer-and-blocking-dependencies: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-defer-and-blocking-dependencies:%20script' id='defer-dependent-of-defer-and-blocking-dependencies-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-defer-and-blocking-dependencies-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-defer-and-blocking-dependencies: after inline" )
+</script>
+HTML
+				,
+			),
+			'async-with-defer-dependency'                  => array(
+				'set_up'          => function () {
+					$handle1 = 'defer-with-async-dependent';
+					$handle2 = 'async-dependent-of-defer';
+					$this->enqueue_test_script( $handle1, 'defer', array() );
+					$this->enqueue_test_script( $handle2, 'async', array( $handle1 ) );
+					foreach ( array( $handle1, $handle2 ) as $handle ) {
+						$this->add_test_inline_script( $handle, 'before' );
+						$this->add_test_inline_script( $handle, 'after' );
+					}
+				},
+				'expected_markup' => <<<HTML
+<script id="defer-with-async-dependent-js-before" type="text/javascript">
+scriptEventLog.push( "defer-with-async-dependent: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-with-async-dependent:%20script' id='defer-with-async-dependent-js' data-wp-strategy='defer'></script>
+<script id="defer-with-async-dependent-js-after" type="text/javascript">
+scriptEventLog.push( "defer-with-async-dependent: after inline" )
+</script>
+<script id="async-dependent-of-defer-js-before" type="text/javascript">
+scriptEventLog.push( "async-dependent-of-defer: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async-dependent-of-defer:%20script' id='async-dependent-of-defer-js' data-wp-strategy='async'></script>
+<script id="async-dependent-of-defer-js-after" type="text/javascript">
+scriptEventLog.push( "async-dependent-of-defer: after inline" )
+</script>
+HTML
+				,
+			),
+			'defer-with-before-inline-script'              => array(
+				'set_up'          => function () {
+					// Note this should NOT result in no delayed-inline-script-loader script being added.
+					$handle = 'defer-with-before-inline';
+					$this->enqueue_test_script( $handle, 'defer', array() );
+					$this->add_test_inline_script( $handle, 'before' );
+				},
+				'expected_markup' => <<<HTML
+<script id="defer-with-before-inline-js-before" type="text/javascript">
+scriptEventLog.push( "defer-with-before-inline: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-with-before-inline:%20script' id='defer-with-before-inline-js' defer data-wp-strategy='defer'></script>
+HTML
+				,
+			),
+			'defer-with-after-inline-script'               => array(
+				'set_up'          => function () {
+					// Note this SHOULD result in delayed-inline-script-loader script being added.
+					$handle = 'defer-with-after-inline';
+					$this->enqueue_test_script( $handle, 'defer', array() );
+					$this->add_test_inline_script( $handle, 'after' );
+				},
+				'expected_markup' => <<<HTML
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-with-after-inline:%20script' id='defer-with-after-inline-js' data-wp-strategy='defer'></script>
+<script id="defer-with-after-inline-js-after" type="text/javascript">
+scriptEventLog.push( "defer-with-after-inline: after inline" )
+</script>
+HTML
+				,
+			),
+			'jquery-deferred'                              => array(
+				'set_up'          => function () {
+					$wp_scripts = wp_scripts();
+					wp_default_scripts( $wp_scripts );
+					foreach ( $wp_scripts->registered['jquery']->deps as $jquery_dep ) {
+						$wp_scripts->registered[ $jquery_dep ]->add_data( 'strategy', 'defer' );
+						$wp_scripts->registered[ $jquery_dep ]->ver = null; // Just to avoid markup changes in the test when jQuery is upgraded.
+					}
+					wp_enqueue_script( 'theme-functions', 'https://example.com/theme-functions.js', array( 'jquery' ), null, array( 'strategy' => 'defer' ) );
+				},
+				'expected_markup' => <<<HTML
+<script type='text/javascript' src='http://example.org/wp-includes/js/jquery/jquery.js' id='jquery-core-js' defer data-wp-strategy='defer'></script>
+<script type='text/javascript' src='http://example.org/wp-includes/js/jquery/jquery-migrate.js' id='jquery-migrate-js' defer data-wp-strategy='defer'></script>
+<script type='text/javascript' src='https://example.com/theme-functions.js' id='theme-functions-js' defer data-wp-strategy='defer'></script>
+HTML
+				,
+			),
+			'nested-aliases'                               => array(
+				'set_up'          => function () {
+					$outer_alias_handle = 'outer-bundle-of-two';
+					$inner_alias_handle = 'inner-bundle-of-two';
+
+					// The outer alias contains a blocking member, as well as a nested alias that contains defer scripts.
+					wp_register_script( $outer_alias_handle, false, array( $inner_alias_handle, 'outer-bundle-leaf-member' ), null );
+					$this->register_test_script( 'outer-bundle-leaf-member', 'blocking', array() );
+
+					// Inner alias only contains delay scripts.
+					wp_register_script( $inner_alias_handle, false, array( 'inner-bundle-member-one', 'inner-bundle-member-two' ), null );
+					$this->register_test_script( 'inner-bundle-member-one', 'defer', array() );
+					$this->register_test_script( 'inner-bundle-member-two', 'defer', array() );
+
+					$this->enqueue_test_script( 'defer-dependent-of-nested-aliases', 'defer', array( $outer_alias_handle ) );
+					$this->add_test_inline_script( 'defer-dependent-of-nested-aliases', 'before' );
+					$this->add_test_inline_script( 'defer-dependent-of-nested-aliases', 'after' );
+				},
+				'expected_markup' => <<<HTML
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=inner-bundle-member-one:%20script' id='inner-bundle-member-one-js' data-wp-strategy='defer'></script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=inner-bundle-member-two:%20script' id='inner-bundle-member-two-js' data-wp-strategy='defer'></script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=outer-bundle-leaf-member:%20script' id='outer-bundle-leaf-member-js'></script>
+<script id="defer-dependent-of-nested-aliases-js-before" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-nested-aliases: before inline" )
+</script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-nested-aliases:%20script' id='defer-dependent-of-nested-aliases-js' data-wp-strategy='defer'></script>
+<script id="defer-dependent-of-nested-aliases-js-after" type="text/javascript">
+scriptEventLog.push( "defer-dependent-of-nested-aliases: after inline" )
+</script>
+HTML
+				,
+			),
+
+			'async-alias-members-with-defer-dependency'    => array(
+				'set_up'          => function () {
+					$alias_handle = 'async-alias';
+					$async_handle1 = 'async1';
+					$async_handle2 = 'async2';
+
+					wp_register_script( $alias_handle, false, array( $async_handle1, $async_handle2 ), null );
+					$this->register_test_script( $async_handle1, 'async', array() );
+					$this->register_test_script( $async_handle2, 'async', array() );
+
+					$this->enqueue_test_script( 'defer-dependent-of-async-aliases', 'defer', array( $alias_handle ) );
+				},
+				'expected_markup' => <<<HTML
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async1:%20script' id='async1-js' defer data-wp-strategy='async'></script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=async2:%20script' id='async2-js' defer data-wp-strategy='async'></script>
+<script type='text/javascript' src='https://example.com/external.js?script_event_log=defer-dependent-of-async-aliases:%20script' id='defer-dependent-of-async-aliases-js' defer data-wp-strategy='defer'></script>
+HTML
+				,
+			),
+		);
+	}
+
+	/**
+	 * Tests that various loading strategy dependency chains function as expected.
+	 *
+	 * @covers ::wp_enqueue_script()
+	 * @covers ::wp_add_inline_script()
+	 * @covers ::wp_print_scripts()
+	 * @covers WP_Scripts::get_inline_script_tag
+	 *
+	 * @dataProvider data_provider_to_test_various_strategy_dependency_chains
+	 *
+	 * @param callable $set_up          Set up.
+	 * @param string   $expected_markup Expected markup.
+	 */
+	public function test_various_strategy_dependency_chains( $set_up, $expected_markup ) {
+		$set_up();
+		$actual_markup = get_echo( 'wp_print_scripts' );
+		$this->assertEqualMarkup( trim( $expected_markup ), trim( $actual_markup ), "Actual markup:\n{$actual_markup}" );
+	}
+
+	/**
+	 * Tests that defer is the final strategy when registering a script using defer, that has no dependents/dependencies.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_loading_strategy_with_defer_having_no_dependents_nor_dependencies() {
+		$this->add_html5_script_theme_support();
+		wp_enqueue_script( 'main-script-d1', 'http://example.com/main-script-d1.js', array(), null, array( 'strategy' => 'defer' ) );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = str_replace( "'", '"', "<script src='http://example.com/main-script-d1.js' id='main-script-d1-js' defer data-wp-strategy='defer'></script>\n" );
+		$this->assertStringContainsString( $expected, $output, 'Expected defer, as there is no dependent or dependency' );
+	}
+
+	/**
+	 * Tests that a script registered with defer remains deferred when all dependencies are either deferred or blocking.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_loading_strategy_with_defer_dependent_and_varied_dependencies() {
+		$this->add_html5_script_theme_support();
+		wp_enqueue_script( 'dependency-script-d2-1', 'http://example.com/dependency-script-d2-1.js', array(), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependency-script-d2-2', 'http://example.com/dependency-script-d2-2.js', array(), null );
+		wp_enqueue_script( 'dependency-script-d2-3', 'http://example.com/dependency-script-d2-3.js', array( 'dependency-script-d2-2' ), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'main-script-d2', 'http://example.com/main-script-d2.js', array( 'dependency-script-d2-1', 'dependency-script-d2-3' ), null, array( 'strategy' => 'defer' ) );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = '<script src="http://example.com/main-script-d2.js" id="main-script-d2-js" defer data-wp-strategy="defer"></script>';
+		$this->assertStringContainsString( $expected, $output, 'Expected defer, as all dependencies are either deferred or blocking' );
+	}
+
+	/**
+	 * Tests that scripts registered with defer remain deferred when all dependents are also deferred.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_loading_strategy_with_all_defer_dependencies() {
+		$this->add_html5_script_theme_support();
+		wp_enqueue_script( 'main-script-d3', 'http://example.com/main-script-d3.js', array(), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d3-1', 'http://example.com/dependent-script-d3-1.js', array( 'main-script-d3' ), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d3-2', 'http://example.com/dependent-script-d3-2.js', array( 'dependent-script-d3-1' ), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d3-3', 'http://example.com/dependent-script-d3-3.js', array( 'dependent-script-d3-2' ), null, array( 'strategy' => 'defer' ) );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = '<script src="http://example.com/main-script-d3.js" id="main-script-d3-js" defer data-wp-strategy="defer"></script>';
+		$this->assertStringContainsString( $expected, $output, 'Expected defer, as all dependents have defer loading strategy' );
+	}
+
+	/**
+	 * Tests that dependents that are async but attached to a deferred main script, print with defer as opposed to async.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_defer_with_async_dependent() {
+		// case with one async dependent.
+		wp_enqueue_script( 'main-script-d4', '/main-script-d4.js', array(), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d4-1', '/dependent-script-d4-1.js', array( 'main-script-d4' ), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d4-2', '/dependent-script-d4-2.js', array( 'dependent-script-d4-1' ), null, array( 'strategy' => 'async' ) );
+		wp_enqueue_script( 'dependent-script-d4-3', '/dependent-script-d4-3.js', array( 'dependent-script-d4-2' ), null, array( 'strategy' => 'defer' ) );
+		$output    = get_echo( 'wp_print_scripts' );
+		$expected  = "<script type='text/javascript' src='/main-script-d4.js' id='main-script-d4-js' defer data-wp-strategy='defer'></script>\n";
+		$expected .= "<script type='text/javascript' src='/dependent-script-d4-1.js' id='dependent-script-d4-1-js' defer data-wp-strategy='defer'></script>\n";
+		$expected .= "<script type='text/javascript' src='/dependent-script-d4-2.js' id='dependent-script-d4-2-js' defer data-wp-strategy='async'></script>\n";
+		$expected .= "<script type='text/javascript' src='/dependent-script-d4-3.js' id='dependent-script-d4-3-js' defer data-wp-strategy='defer'></script>\n";
+
+		$this->assertEqualMarkup( $expected, $output, 'Scripts registered as defer but that have dependents that are async are expected to have said dependents deferred.' );
+	}
+
+	/**
+	 * Tests that scripts registered as defer become blocking when their dependents chain are all blocking.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_loading_strategy_with_invalid_defer_registration() {
+		// Main script is defer and all dependent are not defer. Then main script will have blocking(or no) strategy.
+		wp_enqueue_script( 'main-script-d4', '/main-script-d4.js', array(), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d4-1', '/dependent-script-d4-1.js', array( 'main-script-d4' ), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'dependent-script-d4-2', '/dependent-script-d4-2.js', array( 'dependent-script-d4-1' ), null );
+		wp_enqueue_script( 'dependent-script-d4-3', '/dependent-script-d4-3.js', array( 'dependent-script-d4-2' ), null, array( 'strategy' => 'defer' ) );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = str_replace( "'", '"', "<script type='text/javascript' src='/main-script-d4.js' id='main-script-d4-js' data-wp-strategy='defer'></script>\n" );
+		$this->assertStringContainsString( $expected, $output, 'Scripts registered as defer but that have all dependents with no strategy, should become blocking (no strategy).' );
+	}
+
+	/**
+	 * Tests that scripts registered as default/blocking remain as such when they have no dependencies.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers WP_Scripts::get_eligible_loading_strategy
+	 * @covers WP_Scripts::filter_eligible_strategies
+	 * @covers ::wp_enqueue_script
+	 */
+	public function test_loading_strategy_with_valid_blocking_registration() {
+		wp_enqueue_script( 'main-script-b1', '/main-script-b1.js', array(), null );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = "<script type='text/javascript' src='/main-script-b1.js' id='main-script-b1-js'></script>\n";
+		$expected = str_replace( "'", '"', $expected );
+		$this->assertSame( $expected, $output, 'Scripts registered with a "blocking" strategy, and who have no dependencies, should have no loading strategy attributes printed.' );
+
+		// strategy args not set.
+		wp_enqueue_script( 'main-script-b2', '/main-script-b2.js', array(), null, array() );
+		$output   = get_echo( 'wp_print_scripts' );
+		$expected = "<script type='text/javascript' src='/main-script-b2.js' id='main-script-b2-js'></script>\n";
+		$expected = str_replace( "'", '"', $expected );
+		$this->assertSame( $expected, $output, 'Scripts registered with no strategy assigned, and who have no dependencies, should have no loading strategy attributes printed.' );
+	}
+
+	/**
+	 * Tests that scripts registered for the head do indeed end up there.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers ::wp_enqueue_script
+	 * @covers ::wp_register_script
+	 */
+	public function test_scripts_targeting_head() {
+		wp_register_script( 'header-old', '/header-old.js', array(), null, false );
+		wp_register_script( 'header-new', '/header-new.js', array( 'header-old' ), null, array( 'in_footer' => false ) );
+		wp_enqueue_script( 'enqueue-header-old', '/enqueue-header-old.js', array( 'header-new' ), null, false );
+		wp_enqueue_script( 'enqueue-header-new', '/enqueue-header-new.js', array( 'enqueue-header-old' ), null, array( 'in_footer' => false ) );
+
+		$actual_header = get_echo( 'wp_print_head_scripts' );
+		$actual_footer = get_echo( 'wp_print_scripts' );
+
+		$expected_header  = "<script type='text/javascript' src='/header-old.js' id='header-old-js'></script>\n";
+		$expected_header .= "<script type='text/javascript' src='/header-new.js' id='header-new-js'></script>\n";
+		$expected_header .= "<script type='text/javascript' src='/enqueue-header-old.js' id='enqueue-header-old-js'></script>\n";
+		$expected_header .= "<script type='text/javascript' src='/enqueue-header-new.js' id='enqueue-header-new-js'></script>\n";
+
+		$this->assertEqualMarkup( $expected_header, $actual_header, 'Scripts registered/enqueued using the older $in_footer parameter or the newer $args parameter should have the same outcome.' );
+		$this->assertEmpty( $actual_footer, 'Expected footer to be empty since all scripts were for head.' );
+	}
+
+	/**
+	 * Test that scripts registered for the footer do indeed end up there.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers ::wp_enqueue_script
+	 * @covers ::wp_register_script
+	 */
+	public function test_scripts_targeting_footer() {
+		wp_register_script( 'footer-old', '/footer-old.js', array(), null, true );
+		wp_register_script( 'footer-new', '/footer-new.js', array( 'footer-old' ), null, array( 'in_footer' => true ) );
+		wp_enqueue_script( 'enqueue-footer-old', '/enqueue-footer-old.js', array( 'footer-new' ), null, true );
+		wp_enqueue_script( 'enqueue-footer-new', '/enqueue-footer-new.js', array( 'enqueue-footer-old' ), null, array( 'in_footer' => true ) );
+
+		$actual_header = get_echo( 'wp_print_head_scripts' );
+		$actual_footer = get_echo( 'wp_print_scripts' );
+
+		$expected_footer  = "<script type='text/javascript' src='/footer-old.js' id='footer-old-js'></script>\n";
+		$expected_footer .= "<script type='text/javascript' src='/footer-new.js' id='footer-new-js'></script>\n";
+		$expected_footer .= "<script type='text/javascript' src='/enqueue-footer-old.js' id='enqueue-footer-old-js'></script>\n";
+		$expected_footer .= "<script type='text/javascript' src='/enqueue-footer-new.js' id='enqueue-footer-new-js'></script>\n";
+
+		$this->assertEmpty( $actual_header, 'Expected header to be empty since all scripts targeted footer.' );
+		$this->assertEqualMarkup( $expected_footer, $actual_footer, 'Scripts registered/enqueued using the older $in_footer parameter or the newer $args parameter should have the same outcome.' );
+	}
+
+	/**
+	 * Data provider for test_setting_in_footer_and_strategy.
+	 *
+	 * @return array[]
+	 */
+	public function get_data_for_test_setting_in_footer_and_strategy() {
+		return array(
+			// Passing in_footer and strategy via args array.
+			'async_footer_in_args_array'    => array(
+				'set_up'   => static function ( $handle ) {
+					$args = array(
+						'in_footer' => true,
+						'strategy'  => 'async',
+					);
+					wp_enqueue_script( $handle, '/footer-async.js', array(), null, $args );
+				},
+				'group'    => 1,
+				'strategy' => 'async',
+			),
+
+			// Passing in_footer=true but no strategy.
+			'blocking_footer_in_args_array' => array(
+				'set_up'   => static function ( $handle ) {
+					wp_register_script( $handle, '/defaults.js', array(), null, array( 'in_footer' => true ) );
+				},
+				'group'    => 1,
+				'strategy' => false,
+			),
+
+			// Passing async strategy in script args array.
+			'async_in_args_array'           => array(
+				'set_up'   => static function ( $handle ) {
+					wp_register_script( $handle, '/defaults.js', array(), null, array( 'strategy' => 'async' ) );
+				},
+				'group'    => false,
+				'strategy' => 'async',
+			),
+
+			// Passing empty array as 5th arg.
+			'empty_args_array'              => array(
+				'set_up'   => static function ( $handle ) {
+					wp_register_script( $handle, '/defaults.js', array(), null, array() );
+				},
+				'group'    => false,
+				'strategy' => false,
+			),
+
+			// Passing no value as 5th arg.
+			'undefined_args_param'          => array(
+				'set_up'   => static function ( $handle ) {
+					wp_register_script( $handle, '/defaults.js', array(), null );
+				},
+				'group'    => false,
+				'strategy' => false,
+			),
+
+			// Test backward compatibility, passing $in_footer=true as 5th arg.
+			'passing_bool_as_args_param'    => array(
+				'set_up'   => static function ( $handle ) {
+					wp_enqueue_script( $handle, '/footer-async.js', array(), null, true );
+				},
+				'group'    => 1,
+				'strategy' => false,
+			),
+
+			// Test backward compatibility, passing $in_footer=true as 5th arg and setting strategy via wp_script_add_data().
+			'bool_as_args_and_add_data'     => array(
+				'set_up'   => static function ( $handle ) {
+					wp_register_script( $handle, '/footer-async.js', array(), null, true );
+					wp_script_add_data( $handle, 'strategy', 'defer' );
+				},
+				'group'    => 1,
+				'strategy' => 'defer',
+			),
+		);
+	}
+
+	/**
+	 * Tests that scripts print in the correct group (head/footer) when using in_footer and assigning a strategy.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers ::wp_register_script
+	 * @covers ::wp_enqueue_script
+	 * @covers ::wp_script_add_data
+	 *
+	 * @dataProvider get_data_for_test_setting_in_footer_and_strategy
+	 *
+	 * @param callable     $set_up            Set up.
+	 * @param int|false    $expected_group    Expected group.
+	 * @param string|false $expected_strategy Expected strategy.
+	 */
+	public function test_setting_in_footer_and_strategy( $set_up, $expected_group, $expected_strategy ) {
+		$handle = 'foo';
+		$set_up( $handle );
+		$this->assertSame( $expected_group, wp_scripts()->get_data( $handle, 'group' ) );
+		$this->assertSame( $expected_strategy, wp_scripts()->get_data( $handle, 'strategy' ) );
+	}
+
+	/**
+	 * Tests that scripts print with no strategy when an incorrect strategy is passed during wp_register_script.
+	 *
+	 * For an invalid strategy defined during script registration, default to a blocking strategy.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::add_data
+	 * @covers ::wp_register_script
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @expectedIncorrectUsage WP_Scripts::add_data
+	 */
+	public function test_script_strategy_doing_it_wrong_via_register() {
+		wp_register_script( 'invalid-strategy', '/defaults.js', array(), null, array( 'strategy' => 'random-strategy' ) );
+		wp_enqueue_script( 'invalid-strategy' );
+
+		$this->assertEqualMarkup(
+			"<script type='text/javascript' src='/defaults.js' id='invalid-strategy-js'></script>\n",
+			get_echo( 'wp_print_scripts' )
+		);
+	}
+
+	/**
+	 * Tests that scripts print with no strategy when an incorrect strategy is passed via wp_script_add_data().
+	 *
+	 * For an invalid strategy defined during script registration, default to a blocking strategy.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::add_data
+	 * @covers ::wp_script_add_data
+	 * @covers ::wp_register_script
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @expectedIncorrectUsage WP_Scripts::add_data
+	 */
+	public function test_script_strategy_doing_it_wrong_via_add_data() {
+		wp_register_script( 'invalid-strategy', '/defaults.js', array(), null );
+		wp_script_add_data( 'invalid-strategy', 'strategy', 'random-strategy' );
+		wp_enqueue_script( 'invalid-strategy' );
+
+		$this->assertEqualMarkup(
+			"<script type='text/javascript' src='/defaults.js' id='invalid-strategy-js'></script>\n",
+			get_echo( 'wp_print_scripts' )
+		);
+	}
+
+	/**
+	 * Tests that scripts print with no strategy when an incorrect strategy is passed during wp_enqueue_script.
+	 *
+	 * For an invalid strategy defined during script registration, default to a blocking strategy.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::add_data
+	 * @covers ::wp_enqueue_script
+	 *
+	 * @expectedIncorrectUsage WP_Scripts::add_data
+	 */
+	public function test_script_strategy_doing_it_wrong_via_enqueue() {
+		wp_enqueue_script( 'invalid-strategy', '/defaults.js', array(), null, array( 'strategy' => 'random-strategy' ) );
+
+		$this->assertEqualMarkup(
+			"<script type='text/javascript' src='/defaults.js' id='invalid-strategy-js'></script>\n",
+			get_echo( 'wp_print_scripts' )
+		);
+	}
+
+	/**
+	 * Tests that scripts registered with a deferred strategy are not included in the script concat loading query.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers ::wp_enqueue_script
+	 * @covers ::wp_register_script
+	 */
+	public function test_concatenate_with_defer_strategy() {
+		global $wp_scripts, $concatenate_scripts, $wp_version;
+
+		$old_value           = $concatenate_scripts;
+		$concatenate_scripts = true;
+
+		$wp_scripts->do_concat    = true;
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
+
+		wp_register_script( 'one-concat-dep', $this->default_scripts_dir . 'script.js' );
+		wp_register_script( 'two-concat-dep', $this->default_scripts_dir . 'script.js' );
+		wp_register_script( 'three-concat-dep', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'main-defer-script', '/main-script.js', array( 'one-concat-dep', 'two-concat-dep', 'three-concat-dep' ), null, array( 'strategy' => 'defer' ) );
+
+		wp_print_scripts();
+		$print_scripts = get_echo( '_print_scripts' );
+
+		// Reset global before asserting.
+		$concatenate_scripts = $old_value;
+
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one-concat-dep,two-concat-dep,three-concat-dep&amp;ver={$wp_version}'></script>\n";
+		$expected .= "<script type='text/javascript' src='/main-script.js' id='main-defer-script-js' defer data-wp-strategy='defer'></script>\n";
+
+		$this->assertEqualMarkup( $expected, $print_scripts, 'Scripts are being incorrectly concatenated when a main script is registered with a "defer" loading strategy. Deferred scripts should not be part of the script concat loading query.' );
+	}
+
+	/**
+	 * Test script concatenation with `async` main script.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers ::wp_enqueue_script
+	 * @covers ::wp_register_script
+	 */
+	public function test_concatenate_with_async_strategy() {
+		global $wp_scripts, $concatenate_scripts, $wp_version;
+
+		$old_value           = $concatenate_scripts;
+		$concatenate_scripts = true;
+
+		$wp_scripts->do_concat    = true;
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
+
+		wp_enqueue_script( 'one-concat-dep-1', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'two-concat-dep-1', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'three-concat-dep-1', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'main-async-script-1', '/main-script.js', array(), null, array( 'strategy' => 'async' ) );
+
+		wp_print_scripts();
+		$print_scripts = get_echo( '_print_scripts' );
+
+		// Reset global before asserting.
+		$concatenate_scripts = $old_value;
+
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one-concat-dep-1,two-concat-dep-1,three-concat-dep-1&amp;ver={$wp_version}'></script>\n";
+		$expected .= "<script type='text/javascript' src='/main-script.js' id='main-async-script-1-js' async data-wp-strategy='async'></script>\n";
+
+		$this->assertEqualMarkup( $expected, $print_scripts, 'Scripts are being incorrectly concatenated when a main script is registered with an "async" loading strategy. Async scripts should not be part of the script concat loading query.' );
+	}
+
+	/**
+	 * Tests that script concatenation remains correct when a main script is registered as deferred after other blocking
+	 * scripts are registered.
+	 *
+	 * @ticket 12009
+	 *
+	 * @covers WP_Scripts::do_item
+	 * @covers ::wp_enqueue_script
+	 * @covers ::wp_register_script
+	 */
+	public function test_concatenate_with_blocking_script_before_and_after_script_with_defer_strategy() {
+		global $wp_scripts, $concatenate_scripts, $wp_version;
+
+		$old_value           = $concatenate_scripts;
+		$concatenate_scripts = true;
+
+		$wp_scripts->do_concat    = true;
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
+
+		wp_enqueue_script( 'one-concat-dep-2', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'two-concat-dep-2', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'three-concat-dep-2', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'deferred-script-2', '/main-script.js', array(), null, array( 'strategy' => 'defer' ) );
+		wp_enqueue_script( 'four-concat-dep-2', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'five-concat-dep-2', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'six-concat-dep-2', $this->default_scripts_dir . 'script.js' );
+
+		wp_print_scripts();
+		$print_scripts = get_echo( '_print_scripts' );
+
+		// Reset global before asserting.
+		$concatenate_scripts = $old_value;
+
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one-concat-dep-2,two-concat-dep-2,three-concat-dep-2,four-concat-dep-2,five-concat-dep-2,six-concat-dep-2&amp;ver={$wp_version}'></script>\n";
+		$expected .= "<script type='text/javascript' src='/main-script.js' id='deferred-script-2-js' defer data-wp-strategy='defer'></script>\n";
+
+		$this->assertEqualMarkup( $expected, $print_scripts, 'Scripts are being incorrectly concatenated when a main script is registered as deferred after other blocking scripts are registered. Deferred scripts should not be part of the script concat loader query string. ' );
+	}
+
 	/**
 	 * @ticket 42804
 	 */
 	public function test_wp_enqueue_script_with_html5_support_does_not_contain_type_attribute() {
-		add_theme_support( 'html5', array( 'script' ) );
+		global $wp_version;
 
 		$GLOBALS['wp_scripts']                  = new WP_Scripts();
 		$GLOBALS['wp_scripts']->default_version = get_bloginfo( 'version' );
 
 		wp_enqueue_script( 'empty-deps-no-version', 'example.com' );
 
-		$ver      = get_bloginfo( 'version' );
-		$expected = "<script src='http://example.com?ver=$ver' id='empty-deps-no-version-js'></script>\n";
+		$expected = "<script src='http://example.com?ver={$wp_version}' id='empty-deps-no-version-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
 	 * Test the different protocol references in wp_enqueue_script
 	 *
-	 * @global WP_Scripts $wp_scripts
 	 * @ticket 16560
+	 *
+	 * @global WP_Scripts $wp_scripts
 	 */
 	public function test_protocols() {
 		// Init.
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 		$base_url_backup      = $wp_scripts->base_url;
 		$wp_scripts->base_url = 'http://example.com/wordpress';
 		$expected             = '';
-		$ver                  = get_bloginfo( 'version' );
 
 		// Try with an HTTP reference.
 		wp_enqueue_script( 'jquery-http', 'http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js' );
-		$expected .= "<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver=$ver' id='jquery-http-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver={$wp_version}' id='jquery-http-js'></script>\n";
 
 		// Try with an HTTPS reference.
 		wp_enqueue_script( 'jquery-https', 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js' );
-		$expected .= "<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver=$ver' id='jquery-https-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver={$wp_version}' id='jquery-https-js'></script>\n";
 
 		// Try with an automatic protocol reference (//).
 		wp_enqueue_script( 'jquery-doubleslash', '//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js' );
-		$expected .= "<script type='text/javascript' src='//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver=$ver' id='jquery-doubleslash-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver={$wp_version}' id='jquery-doubleslash-js'></script>\n";
 
 		// Try with a local resource and an automatic protocol reference (//).
 		$url = '//my_plugin/script.js';
 		wp_enqueue_script( 'plugin-script', $url );
-		$expected .= "<script type='text/javascript' src='$url?ver=$ver' id='plugin-script-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='$url?ver={$wp_version}' id='plugin-script-js'></script>\n";
 
 		// Try with a bad protocol.
 		wp_enqueue_script( 'jquery-ftp', 'ftp://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js' );
-		$expected .= "<script type='text/javascript' src='{$wp_scripts->base_url}ftp://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver=$ver' id='jquery-ftp-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$wp_scripts->base_url}ftp://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js?ver={$wp_version}' id='jquery-ftp-js'></script>\n";
 
 		// Go!
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 
 		// No scripts left to print.
 		$this->assertSame( '', get_echo( 'wp_print_scripts' ) );
@@ -129,20 +1484,19 @@ JS;
 	 * Test script concatenation.
 	 */
 	public function test_script_concatenation() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
-		$wp_scripts->default_dirs = array( '/directory/' );
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
 
-		wp_enqueue_script( 'one', '/directory/script.js' );
-		wp_enqueue_script( 'two', '/directory/script.js' );
-		wp_enqueue_script( 'three', '/directory/script.js' );
+		wp_enqueue_script( 'one', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'two', $this->default_scripts_dir . 'script.js' );
+		wp_enqueue_script( 'three', $this->default_scripts_dir . 'script.js' );
 
 		wp_print_scripts();
 		$print_scripts = get_echo( '_print_scripts' );
 
-		$ver      = get_bloginfo( 'version' );
-		$expected = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one,two,three&amp;ver={$ver}'></script>\n";
+		$expected = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one,two,three&amp;ver={$wp_version}'></script>\n";
 
 		$this->assertSame( $expected, $print_scripts );
 	}
@@ -160,7 +1514,7 @@ JS;
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-only-data-js'></script>\n";
 
 		// Go!
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 
 		// No scripts left to print.
 		$this->assertSame( '', get_echo( 'wp_print_scripts' ) );
@@ -178,7 +1532,7 @@ JS;
 		$expected = "<!--[if gt IE 7]>\n<script type='text/javascript' src='http://example.com' id='test-only-conditional-js'></script>\n<![endif]-->\n";
 
 		// Go!
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 
 		// No scripts left to print.
 		$this->assertSame( '', get_echo( 'wp_print_scripts' ) );
@@ -196,16 +1550,17 @@ JS;
 		wp_script_add_data( 'test-conditional-with-data', 'conditional', 'lt IE 9' );
 		$expected  = "<!--[if lt IE 9]>\n<script type='text/javascript' id='test-conditional-with-data-js-extra'>\n/* <![CDATA[ */\ntesting\n/* ]]> */\n</script>\n<![endif]-->\n";
 		$expected .= "<!--[if lt IE 9]>\n<script type='text/javascript' src='http://example.com' id='test-conditional-with-data-js'></script>\n<![endif]-->\n";
+		$expected  = str_replace( "'", '"', $expected );
 
 		// Go!
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 
 		// No scripts left to print.
 		$this->assertSame( '', get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
-	 * Testing `wp_script_add_data` with an anvalid key.
+	 * Testing `wp_script_add_data` with an invalid key.
 	 *
 	 * @ticket 16024
 	 */
@@ -216,10 +1571,10 @@ JS;
 		$expected = "<script type='text/javascript' src='http://example.com' id='test-invalid-js'></script>\n";
 
 		// Go!
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 
 		// No scripts left to print.
-		$this->assertSame( '', get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( '', get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -245,7 +1600,7 @@ JS;
 
 		wp_enqueue_script( 'handle-three' );
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -333,8 +1688,8 @@ JS;
 		$expected_header .= "<script type='text/javascript' src='/child-head.js' id='child-head-js'></script>\n";
 		$expected_footer  = "<script type='text/javascript' src='/parent.js' id='parent-js'></script>\n";
 
-		$this->assertSame( $expected_header, $header );
-		$this->assertSame( $expected_footer, $footer );
+		$this->assertEqualMarkup( $expected_header, $header, 'Expected same header markup.' );
+		$this->assertEqualMarkup( $expected_footer, $footer, 'Expected same footer markup.' );
 	}
 
 	/**
@@ -354,8 +1709,8 @@ JS;
 		$expected_footer  = "<script type='text/javascript' src='/child-footer.js' id='child-footer-js'></script>\n";
 		$expected_footer .= "<script type='text/javascript' src='/parent.js' id='parent-js'></script>\n";
 
-		$this->assertSame( $expected_header, $header );
-		$this->assertSame( $expected_footer, $footer );
+		$this->assertEqualMarkup( $expected_header, $header, 'Expected same header markup.' );
+		$this->assertEqualMarkup( $expected_footer, $footer, 'Expected same footer markup.' );
 	}
 
 	/**
@@ -385,8 +1740,8 @@ JS;
 		$expected_footer .= "<script type='text/javascript' src='/child2-footer.js' id='child2-footer-js'></script>\n";
 		$expected_footer .= "<script type='text/javascript' src='/parent-footer.js' id='parent-footer-js'></script>\n";
 
-		$this->assertSame( $expected_header, $header );
-		$this->assertSame( $expected_footer, $footer );
+		$this->assertEqualMarkup( $expected_header, $header, 'Expected same header markup.' );
+		$this->assertEqualMarkup( $expected_footer, $footer, 'Expected same footer markup.' );
 	}
 
 	/**
@@ -416,7 +1771,7 @@ JS;
 		$expected  = "<script type='text/javascript' id='test-example-js-before'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -429,7 +1784,7 @@ JS;
 		$expected  = "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -444,7 +1799,7 @@ JS;
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -457,7 +1812,7 @@ JS;
 
 		$expected = "<script type='text/javascript' id='test-example-js-before'>\nconsole.log(\"before\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -470,7 +1825,7 @@ JS;
 
 		$expected = "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -485,7 +1840,7 @@ JS;
 		$expected  = "<script type='text/javascript' id='test-example-js-before'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -502,7 +1857,7 @@ JS;
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\nconsole.log(\"after\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -519,85 +1874,82 @@ JS;
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
 	 * @ticket 14853
 	 */
 	public function test_wp_add_inline_script_before_with_concat() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
-		$wp_scripts->default_dirs = array( '/directory/' );
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
 
-		wp_enqueue_script( 'one', '/directory/one.js' );
-		wp_enqueue_script( 'two', '/directory/two.js' );
-		wp_enqueue_script( 'three', '/directory/three.js' );
+		wp_enqueue_script( 'one', $this->default_scripts_dir . 'one.js' );
+		wp_enqueue_script( 'two', $this->default_scripts_dir . 'two.js' );
+		wp_enqueue_script( 'three', $this->default_scripts_dir . 'three.js' );
 
 		wp_add_inline_script( 'one', 'console.log("before one");', 'before' );
 		wp_add_inline_script( 'two', 'console.log("before two");', 'before' );
 
-		$ver       = get_bloginfo( 'version' );
 		$expected  = "<script type='text/javascript' id='one-js-before'>\nconsole.log(\"before one\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/one.js?ver={$ver}' id='one-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}one.js?ver={$wp_version}' id='one-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='two-js-before'>\nconsole.log(\"before two\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/two.js?ver={$ver}' id='two-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/three.js?ver={$ver}' id='three-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}two.js?ver={$wp_version}' id='two-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}three.js?ver={$wp_version}' id='three-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
 	 * @ticket 14853
 	 */
 	public function test_wp_add_inline_script_before_with_concat2() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
-		$wp_scripts->default_dirs = array( '/directory/' );
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
 
-		wp_enqueue_script( 'one', '/directory/one.js' );
-		wp_enqueue_script( 'two', '/directory/two.js' );
-		wp_enqueue_script( 'three', '/directory/three.js' );
+		wp_enqueue_script( 'one', $this->default_scripts_dir . 'one.js' );
+		wp_enqueue_script( 'two', $this->default_scripts_dir . 'two.js' );
+		wp_enqueue_script( 'three', $this->default_scripts_dir . 'three.js' );
 
 		wp_add_inline_script( 'one', 'console.log("before one");', 'before' );
 
-		$ver       = get_bloginfo( 'version' );
 		$expected  = "<script type='text/javascript' id='one-js-before'>\nconsole.log(\"before one\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/one.js?ver={$ver}' id='one-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/two.js?ver={$ver}' id='two-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/three.js?ver={$ver}' id='three-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}one.js?ver={$wp_version}' id='one-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}two.js?ver={$wp_version}' id='two-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}three.js?ver={$wp_version}' id='three-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
 	 * @ticket 14853
 	 */
 	public function test_wp_add_inline_script_after_with_concat() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
-		$wp_scripts->default_dirs = array( '/directory/' );
+		$wp_scripts->default_dirs = array( $this->default_scripts_dir );
 
-		wp_enqueue_script( 'one', '/directory/one.js' );
-		wp_enqueue_script( 'two', '/directory/two.js' );
-		wp_enqueue_script( 'three', '/directory/three.js' );
-		wp_enqueue_script( 'four', '/directory/four.js' );
+		wp_enqueue_script( 'one', $this->default_scripts_dir . 'one.js' );
+		wp_enqueue_script( 'two', $this->default_scripts_dir . 'two.js' );
+		wp_enqueue_script( 'three', $this->default_scripts_dir . 'three.js' );
+		wp_enqueue_script( 'four', $this->default_scripts_dir . 'four.js' );
 
 		wp_add_inline_script( 'two', 'console.log("after two");' );
 		wp_add_inline_script( 'three', 'console.log("after three");' );
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one&amp;ver={$ver}'></script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/two.js?ver={$ver}' id='two-js'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one&amp;ver={$wp_version}'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}two.js?ver={$wp_version}' id='two-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='two-js-after'>\nconsole.log(\"after two\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/three.js?ver={$ver}' id='three-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}three.js?ver={$wp_version}' id='three-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='three-js-after'>\nconsole.log(\"after three\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/directory/four.js?ver={$ver}' id='four-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='{$this->default_scripts_dir}four.js?ver={$wp_version}' id='four-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -612,12 +1964,14 @@ JS;
 		$expected_localized  = "<!--[if gte IE 9]>\n";
 		$expected_localized .= "<script type='text/javascript' id='test-example-js-extra'>\n/* <![CDATA[ */\nvar testExample = {\"foo\":\"bar\"};\n/* ]]> */\n</script>\n";
 		$expected_localized .= "<![endif]-->\n";
+		$expected_localized  = str_replace( "'", '"', $expected_localized );
 
 		$expected  = "<!--[if gte IE 9]>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-before'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 		$expected .= "<![endif]-->\n";
+		$expected  = str_replace( "'", '"', $expected );
 
 		wp_enqueue_script( 'test-example', 'example.com', array(), null );
 		wp_localize_script( 'test-example', 'testExample', array( 'foo' => 'bar' ) );
@@ -626,7 +1980,7 @@ JS;
 		wp_script_add_data( 'test-example', 'conditional', 'gte IE 9' );
 
 		$this->assertSame( $expected_localized, get_echo( 'wp_print_scripts' ) );
-		$this->assertSame( $expected, $wp_scripts->print_html );
+		$this->assertEqualMarkup( $expected, $wp_scripts->print_html );
 		$this->assertTrue( $wp_scripts->do_concat );
 	}
 
@@ -634,15 +1988,14 @@ JS;
 	 * @ticket 36392
 	 */
 	public function test_wp_add_inline_script_after_with_concat_and_core_dependency() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		wp_default_scripts( $wp_scripts );
 
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$wp_version}'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
 
@@ -652,22 +2005,21 @@ JS;
 		wp_print_scripts();
 		$print_scripts = get_echo( '_print_scripts' );
 
-		$this->assertSame( $expected, $print_scripts );
+		$this->assertEqualMarkup( $expected, $print_scripts );
 	}
 
 	/**
 	 * @ticket 36392
 	 */
 	public function test_wp_add_inline_script_after_with_concat_and_conditional_and_core_dependency() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		wp_default_scripts( $wp_scripts );
 
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$wp_version}'></script>\n";
 		$expected .= "<!--[if gte IE 9]>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-after'>\nconsole.log(\"after\");\n</script>\n";
@@ -680,14 +2032,14 @@ JS;
 		wp_print_scripts();
 		$print_scripts = get_echo( '_print_scripts' );
 
-		$this->assertSame( $expected, $print_scripts );
+		$this->assertEqualMarkup( $expected, $print_scripts );
 	}
 
 	/**
 	 * @ticket 36392
 	 */
 	public function test_wp_add_inline_script_before_with_concat_and_core_dependency() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		wp_default_scripts( $wp_scripts );
 		wp_default_packages( $wp_scripts );
@@ -695,8 +2047,7 @@ JS;
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$wp_version}'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-before'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 
@@ -706,14 +2057,14 @@ JS;
 		wp_print_scripts();
 		$print_scripts = get_echo( '_print_scripts' );
 
-		$this->assertSame( $expected, $print_scripts );
+		$this->assertEqualMarkup( $expected, $print_scripts );
 	}
 
 	/**
 	 * @ticket 36392
 	 */
 	public function test_wp_add_inline_script_before_after_concat_with_core_dependency() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		wp_default_scripts( $wp_scripts );
 		wp_default_packages( $wp_scripts );
@@ -721,9 +2072,7 @@ JS;
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
-		$ver       = get_bloginfo( 'version' );
-		$suffix    = wp_scripts_get_suffix();
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate,wp-polyfill-inert,regenerator-runtime,wp-polyfill,wp-dom-ready,wp-hooks&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate,wp-polyfill-inert,regenerator-runtime,wp-polyfill,wp-dom-ready,wp-hooks&amp;ver={$wp_version}'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example-js-before'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/dist/i18n.min.js' id='wp-i18n-js'></script>\n";
@@ -758,7 +2107,7 @@ JS;
 			$print_scripts         // Printed scripts.
 		);
 
-		$this->assertSameIgnoreEOL( $expected, $print_scripts );
+		$this->assertEqualMarkup( $expected, $print_scripts );
 	}
 
 	/**
@@ -789,15 +2138,16 @@ JS;
 		_print_scripts();
 		$print_scripts = $this->getActualOutput();
 
-		$tail = substr( $print_scripts, strrpos( $print_scripts, "<script type='text/javascript' src='/customize-dependency.js' id='customize-dependency-js'>" ) );
-		$this->assertSame( $expected_tail, $tail );
+		$tail = substr( $print_scripts, strrpos( $print_scripts, '<script type="text/javascript" src="/customize-dependency.js" id="customize-dependency-js">' ) );
+
+		$this->assertEqualMarkup( $expected_tail, $tail );
 	}
 
 	/**
 	 * @ticket 36392
 	 */
 	public function test_wp_add_inline_script_after_for_core_scripts_with_concat_is_limited_and_falls_back_to_no_concat() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
 		$wp_scripts->default_dirs = array( '/wp-admin/js/', '/wp-includes/js/' ); // Default dirs as in wp-includes/script-loader.php.
@@ -808,21 +2158,20 @@ JS;
 		wp_enqueue_script( 'three', '/wp-includes/js/script3.js' );
 		wp_enqueue_script( 'four', '/wp-includes/js/script4.js' );
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-includes/js/script.js?ver={$ver}' id='one-js'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-includes/js/script.js?ver={$wp_version}' id='one-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='one-js-after'>\nconsole.log(\"after one\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/wp-includes/js/script2.js?ver={$ver}' id='two-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='/wp-includes/js/script3.js?ver={$ver}' id='three-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='/wp-includes/js/script4.js?ver={$ver}' id='four-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/script2.js?ver={$wp_version}' id='two-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/script3.js?ver={$wp_version}' id='three-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/script4.js?ver={$wp_version}' id='four-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
 	 * @ticket 36392
 	 */
 	public function test_wp_add_inline_script_before_third_core_script_prints_two_concat_scripts() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
 		$wp_scripts->default_dirs = array( '/wp-admin/js/', '/wp-includes/js/' ); // Default dirs as in wp-includes/script-loader.php.
@@ -833,13 +2182,117 @@ JS;
 		wp_add_inline_script( 'three', 'console.log("before three");', 'before' );
 		wp_enqueue_script( 'four', '/wp-includes/js/script4.js' );
 
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one,two&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one,two&amp;ver={$wp_version}'></script>\n";
 		$expected .= "<script type='text/javascript' id='three-js-before'>\nconsole.log(\"before three\");\n</script>\n";
-		$expected .= "<script type='text/javascript' src='/wp-includes/js/script3.js?ver={$ver}' id='three-js'></script>\n";
-		$expected .= "<script type='text/javascript' src='/wp-includes/js/script4.js?ver={$ver}' id='four-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/script3.js?ver={$wp_version}' id='three-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/script4.js?ver={$wp_version}' id='four-js'></script>\n";
+
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
+	}
+
+	/**
+	 * Data provider to test get_inline_script_data and get_inline_script_tag.
+	 *
+	 * @return array[]
+	 */
+	public function data_provider_to_test_get_inline_script() {
+		return array(
+			'before-blocking' => array(
+				'position'       => 'before',
+				'inline_scripts' => array(
+					'/*before foo 1*/',
+				),
+				'delayed'        => false,
+				'expected_data'  => '/*before foo 1*/',
+				'expected_tag'   => "<script id='foo-js-before' type='text/javascript'>\n/*before foo 1*/\n</script>\n",
+			),
+			'after-blocking'  => array(
+				'position'       => 'after',
+				'inline_scripts' => array(
+					'/*after foo 1*/',
+					'/*after foo 2*/',
+				),
+				'delayed'        => false,
+				'expected_data'  => "/*after foo 1*/\n/*after foo 2*/",
+				'expected_tag'   => "<script id='foo-js-after' type='text/javascript'>\n/*after foo 1*/\n/*after foo 2*/\n</script>\n",
+			),
+			'before-delayed'  => array(
+				'position'       => 'before',
+				'inline_scripts' => array(
+					'/*before foo 1*/',
+				),
+				'delayed'        => true,
+				'expected_data'  => '/*before foo 1*/',
+				'expected_tag'   => "<script id='foo-js-before' type='text/javascript'>\n/*before foo 1*/\n</script>\n",
+			),
+			'after-delayed'   => array(
+				'position'       => 'after',
+				'inline_scripts' => array(
+					'/*after foo 1*/',
+					'/*after foo 2*/',
+				),
+				'delayed'        => true,
+				'expected_data'  => "/*after foo 1*/\n/*after foo 2*/",
+				'expected_tag'   => "<script id='foo-js-after' type='text/javascript'>\n/*after foo 1*/\n/*after foo 2*/\n</script>\n",
+			),
+		);
+	}
+
+	/**
+	 * Test getting inline scripts.
+	 *
+	 * @covers WP_Scripts::get_inline_script_data
+	 * @covers WP_Scripts::get_inline_script_tag
+	 * @covers WP_Scripts::print_inline_script
+	 *
+	 * @expectedDeprecated WP_Scripts::print_inline_script
+	 *
+	 * @dataProvider data_provider_to_test_get_inline_script
+	 *
+	 * @param string   $position       Position.
+	 * @param string[] $inline_scripts Inline scripts.
+	 * @param bool     $delayed        Delayed.
+	 * @param string   $expected_data  Expected data.
+	 * @param string   $expected_tag   Expected tag.
+	 */
+	public function test_get_inline_script( $position, $inline_scripts, $delayed, $expected_data, $expected_tag ) {
+		global $wp_scripts;
+
+		$deps = array();
+		if ( $delayed ) {
+			$wp_scripts->add( 'dep', 'https://example.com/dependency.js', array(), false ); // TODO: Cannot pass strategy to $args e.g. array( 'strategy' => 'defer' )
+			$wp_scripts->add_data( 'dep', 'strategy', 'defer' );
+			$deps[] = 'dep';
+		}
+
+		$handle = 'foo';
+		$wp_scripts->add( $handle, 'https://example.com/foo.js', $deps );
+		if ( $delayed ) {
+			$wp_scripts->add_data( $handle, 'strategy', 'defer' );
+		}
+
+		$this->assertSame( '', $wp_scripts->get_inline_script_data( $handle, $position ) );
+		$this->assertSame( '', $wp_scripts->get_inline_script_tag( $handle, $position ) );
+		$this->assertFalse( $wp_scripts->print_inline_script( $handle, $position, false ) );
+		ob_start();
+		$output = $wp_scripts->print_inline_script( $handle, $position, true );
+		$this->assertSame( '', ob_get_clean() );
+		$this->assertFalse( $output );
+
+		foreach ( $inline_scripts as $inline_script ) {
+			$wp_scripts->add_inline_script( $handle, $inline_script, $position );
+		}
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertSame( $expected_data, $wp_scripts->get_inline_script_data( $handle, $position ) );
+		$this->assertSame( $expected_data, $wp_scripts->print_inline_script( $handle, $position, false ) );
+		$this->assertEqualMarkup(
+			$expected_tag,
+			$wp_scripts->get_inline_script_tag( $handle, $position )
+		);
+		ob_start();
+		$output = $wp_scripts->print_inline_script( $handle, $position, true );
+		$this->assertEqualMarkup( $expected_tag, ob_get_clean() );
+		$this->assertEquals( $expected_data, $output );
 	}
 
 	/**
@@ -866,7 +2319,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script.js' id='test-example-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -893,7 +2346,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-content/plugins/my-plugin/js/script.js' id='plugin-example-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -920,7 +2373,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-content/themes/my-theme/js/script.js' id='theme-example-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -947,7 +2400,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-admin/js/script.js' id='script-handle-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -977,7 +2430,7 @@ JS;
 		$expected  = "<script type='text/javascript' src='/wp-includes/js/dist/wp-i18n.js' id='wp-i18n-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-admin/js/script.js' id='test-example-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -1006,7 +2459,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script.js' id='test-example-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -1036,13 +2489,14 @@ JS;
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script.js' id='test-dependency-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script2.js' id='test-example-js'></script>\n";
 
-		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
 	 * Testing `wp_enqueue_code_editor` with file path.
 	 *
 	 * @ticket 41871
+	 *
 	 * @covers ::wp_enqueue_code_editor
 	 */
 	public function test_wp_enqueue_code_editor_when_php_file_will_be_passed() {
@@ -1130,6 +2584,7 @@ JS;
 	 * Testing `wp_enqueue_code_editor` with `compact`.
 	 *
 	 * @ticket 41871
+	 *
 	 * @covers ::wp_enqueue_code_editor
 	 */
 	public function test_wp_enqueue_code_editor_when_generated_array_by_compact_will_be_passed() {
@@ -1213,6 +2668,7 @@ JS;
 	 * Testing `wp_enqueue_code_editor` with `array_merge`.
 	 *
 	 * @ticket 41871
+	 *
 	 * @covers ::wp_enqueue_code_editor
 	 */
 	public function test_wp_enqueue_code_editor_when_generated_array_by_array_merge_will_be_passed() {
@@ -1310,6 +2766,7 @@ JS;
 	 * Testing `wp_enqueue_code_editor` with `array`.
 	 *
 	 * @ticket 41871
+	 *
 	 * @covers ::wp_enqueue_code_editor
 	 */
 	public function test_wp_enqueue_code_editor_when_simple_array_will_be_passed() {
@@ -1402,6 +2859,7 @@ JS;
 
 	/**
 	 * @ticket 52534
+	 *
 	 * @covers ::wp_localize_script
 	 *
 	 * @dataProvider data_wp_localize_script_data_formats
@@ -1420,7 +2878,7 @@ JS;
 		$expected  = "<script type='text/javascript' id='test-example-js-extra'>\n/* <![CDATA[ */\nvar testExample = {$expected};\n/* ]]> */\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com' id='test-example-js'></script>\n";
 
-		$this->assertSame( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualMarkup( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -1456,10 +2914,11 @@ JS;
 
 	/**
 	 * @ticket 55628
+	 *
 	 * @covers ::wp_set_script_translations
 	 */
 	public function test_wp_external_wp_i18n_print_order() {
-		global $wp_scripts;
+		global $wp_scripts, $wp_version;
 
 		$wp_scripts->do_concat    = true;
 		$wp_scripts->default_dirs = array( '/default/' );
@@ -1473,18 +2932,137 @@ JS;
 		wp_set_script_translations( 'common' );
 
 		$print_scripts = get_echo(
-			function() {
+			static function () {
 				wp_print_scripts();
 				_print_scripts();
 			}
 		);
 
 		// The non-default script should end concatenation and maintain order.
-		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core&amp;ver={$wp_version}'></script>\n";
 		$expected .= "<script type='text/javascript' src='/plugins/wp-i18n.js' id='wp-i18n-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='/default/common.js' id='common-js'></script>\n";
 
-		$this->assertSame( $expected, $print_scripts );
+		$this->assertEqualMarkup( $expected, $print_scripts );
+	}
+
+	/**
+	 * Ensure tinymce scripts aren't loading async.
+	 *
+	 * @ticket 58648
+	 */
+	public function test_printing_tinymce_scripts() {
+		global $wp_scripts;
+
+		wp_register_tinymce_scripts( $wp_scripts, true );
+
+		$actual = get_echo( 'wp_print_scripts', array( array( 'wp-tinymce' ) ) );
+
+		$this->assertStringNotContainsString( 'async', $actual, 'TinyMCE should not have an async attribute.' );
+		$this->assertStringNotContainsString( 'defer', $actual, 'TinyMCE should not have a defer attribute.' );
+	}
+
+	/**
+	 * Make sure scripts with a loading strategy that are printed
+	 * without being enqueued are handled properly.
+	 *
+	 * @ticket 58648
+	 *
+	 * @dataProvider data_provider_delayed_strategies
+	 */
+	public function test_printing_non_enqueued_scripts( $strategy ) {
+		wp_register_script( 'test-script', 'test-script.js', array(), false, array( 'strategy' => $strategy ) );
+
+		$actual = get_echo( 'wp_print_scripts', array( array( 'test-script' ) ) );
+
+		$this->assertStringContainsString( $strategy, $actual );
+	}
+
+	/**
+	 * Parse an HTML markup fragment.
+	 *
+	 * @param string $markup Markup.
+	 * @return DOMDocument Document containing the normalized markup fragment.
+	 */
+	protected function parse_markup_fragment( $markup ) {
+		$dom = new DOMDocument();
+		$dom->loadHTML(
+			"<!DOCTYPE html><html><head><meta charset=utf8></head><body>{$markup}</body></html>"
+		);
+
+		/** @var DOMElement $body */
+		$body = $dom->getElementsByTagName( 'body' )->item( 0 );
+
+		// Trim whitespace nodes added before/after which can be added when parsing.
+		foreach ( array( $body->firstChild, $body->lastChild ) as $node ) {
+			if ( $node instanceof DOMText && '' === trim( $node->data ) ) {
+				$body->removeChild( $node );
+			}
+		}
+
+		// Normalize other whitespace nodes.
+		$xpath = new DOMXPath( $dom );
+		foreach ( $xpath->query( '//text()' ) as $node ) {
+			/** @var DOMText $node */
+			if ( preg_match( '/^\s+$/', $node->nodeValue ) ) {
+				$node->nodeValue = ' ';
+			}
+		}
+
+		return $dom;
+	}
+
+	/**
+	 * Assert markup is equal after normalizing script tags.
+	 *
+	 * @param string $expected Expected markup.
+	 * @param string $actual   Actual markup.
+	 * @param string $message  Message.
+	 */
+	protected function assertEqualMarkup( $expected, $actual, $message = '' ) {
+		$expected_dom = $this->parse_markup_fragment( $expected );
+		$actual_dom   = $this->parse_markup_fragment( $actual );
+		foreach ( array( $expected_dom, $actual_dom ) as $dom ) {
+			$xpath = new DOMXPath( $dom );
+			/** @var DOMElement $script */
+
+			// Normalize type attribute. When missing, it defaults to text/javascript.
+			foreach ( $xpath->query( '//script[ not( @type ) ]' ) as $script ) {
+				$script->setAttribute( 'type', 'text/javascript' );
+			}
+
+			// Normalize script contents to remove CDATA wrapper.
+			foreach ( $xpath->query( '//script[ contains( text(), "<![CDATA[" ) ]' ) as $script ) {
+				$script->textContent = str_replace(
+					array(
+						"/* <![CDATA[ */\n",
+						"\n/* ]]> */",
+					),
+					'',
+					$script->textContent
+				);
+			}
+
+			// Normalize XHTML-compatible boolean attributes to HTML5 ones.
+			foreach ( array( 'async', 'defer' ) as $attribute ) {
+				foreach ( iterator_to_array( $xpath->query( "//script[ @{$attribute} = '{$attribute}' ]" ) ) as $script ) {
+					$script->removeAttribute( $attribute );
+					$script->setAttributeNode( $dom->createAttribute( $attribute ) );
+				}
+			}
+		}
+
+		$this->assertEquals(
+			$expected_dom->getElementsByTagName( 'body' )->item( 0 ),
+			$actual_dom->getElementsByTagName( 'body' )->item( 0 ),
+			$message
+		);
+	}
+
+	/**
+	 * Adds html5 script theme support.
+	 */
+	protected function add_html5_script_theme_support() {
+		add_theme_support( 'html5', array( 'script' ) );
 	}
 }
diff --git a/tests/dependencies/styles.php b/tests/dependencies/styles.php
index 0d2f8e664b..da79c2812d 100644
--- a/tests/dependencies/styles.php
+++ b/tests/dependencies/styles.php
@@ -186,7 +186,6 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 
 		wp_print_styles();
 		$this->assertSame( $expected, $wp_styles->print_html );
-
 	}
 
 	/**
@@ -196,6 +195,7 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 	 *
 	 * @ticket 54243
 	 * @ticket 54922
+	 * @ticket 58069
 	 *
 	 * @covers ::_wp_normalize_relative_css_links
 	 *
@@ -240,6 +240,14 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 				'css'      => 'img {mask-image: url(\'data:image/svg+xml;utf8,<svg></svg>\');}',
 				'expected' => 'img {mask-image: url(\'data:image/svg+xml;utf8,<svg></svg>\');}',
 			),
+			'URLs with path beginning with http'           => array(
+				'css'      => 'p {background:url( "http-is-awesome.png" );}',
+				'expected' => 'p {background:url( "/wp-content/themes/test/http-is-awesome.png" );}',
+			),
+			'URLs with path beginning with https'          => array(
+				'css'      => 'p {background:url( "https-is-more-awesome.png" );}',
+				'expected' => 'p {background:url( "/wp-content/themes/test/https-is-more-awesome.png" );}',
+			),
 		);
 	}
 
@@ -270,7 +278,6 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 
 		// No styles left to print.
 		$this->assertSame( $expected, get_echo( 'wp_print_styles' ) );
-
 	}
 
 	/**
@@ -295,7 +302,6 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 		wp_add_inline_style( 'handle', $style );
 
 		$this->assertSame( $expected, get_echo( 'wp_print_styles' ) );
-
 	}
 
 	/**
@@ -310,7 +316,6 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 		wp_enqueue_style( 'handle', 'http://example.com', array(), 1 );
 
 		$this->assertSame( $expected, get_echo( 'wp_print_styles' ) );
-
 	}
 
 	/**
@@ -508,4 +513,119 @@ CSS;
 			$GLOBALS['wp_styles']->registered['wp-block-library']->src
 		);
 	}
+
+	/**
+	 * @ticket 58394
+	 *
+	 * @covers ::wp_maybe_inline_styles
+	 */
+	public function test_wp_maybe_inline_styles() {
+		wp_register_style( 'test-handle', '/' . WPINC . '/css/classic-themes.css' );
+		wp_style_add_data( 'test-handle', 'path', ABSPATH . WPINC . '/css/classic-themes.css' );
+
+		wp_enqueue_style( 'test-handle' );
+
+		wp_maybe_inline_styles();
+
+		$this->assertFalse( $GLOBALS['wp_styles']->registered['test-handle']->src, 'Source of style should be reset to false' );
+
+		$css = file_get_contents( ABSPATH . WPINC . '/css/classic-themes.css' );
+		$this->assertSameSets( $GLOBALS['wp_styles']->registered['test-handle']->extra['after'], array( $css ), 'Source of style should set to after property' );
+	}
+
+	/**
+	 * @ticket 58394
+	 *
+	 * @covers ::wp_maybe_inline_styles
+	 */
+	public function test_wp_maybe_inline_styles_dequeue_styles() {
+		$filter = new MockAction();
+		add_filter( 'pre_wp_filesize', array( $filter, 'filter' ) );
+		wp_register_style( 'test-handle', '/' . WPINC . '/css/classic-themes.css' );
+		wp_style_add_data( 'test-handle', 'path', ABSPATH . WPINC . '/css/classic-themes.css' );
+
+		wp_enqueue_style( 'test-handle' );
+
+		wp_deregister_style( 'test-handle' );
+
+		wp_maybe_inline_styles();
+
+		$this->assertSame( 0, $filter->get_call_count() );
+	}
+
+	/**
+	 * wp_filesize should be only be called once, as on the second run of wp_maybe_inline_styles,
+	 * src will be set to false and filesize will not be requested.
+	 *
+	 * @ticket 58394
+	 *
+	 * @covers ::wp_maybe_inline_styles
+	 */
+	public function test_wp_maybe_inline_styles_multiple_runs() {
+		$filter = new MockAction();
+		add_filter( 'pre_wp_filesize', array( $filter, 'filter' ) );
+		wp_register_style( 'test-handle', '/' . WPINC . '/css/classic-themes.css' );
+		wp_style_add_data( 'test-handle', 'path', ABSPATH . WPINC . '/css/classic-themes.css' );
+
+		wp_enqueue_style( 'test-handle' );
+
+		wp_maybe_inline_styles();
+		wp_maybe_inline_styles();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * @ticket 58394
+	 *
+	 * @covers ::wp_maybe_inline_styles
+	 */
+	public function test_test_wp_maybe_inline_styles_missing_file() {
+		$filter = new MockAction();
+		add_filter( 'pre_wp_filesize', array( $filter, 'filter' ) );
+		$url = '/' . WPINC . '/css/invalid.css';
+		wp_register_style( 'test-handle', $url );
+		wp_style_add_data( 'test-handle', 'path', ABSPATH . WPINC . '/css/invalid.css' );
+
+		wp_enqueue_style( 'test-handle' );
+
+		wp_maybe_inline_styles();
+
+		$this->assertSame( $GLOBALS['wp_styles']->registered['test-handle']->src, $url, 'Source should not change' );
+		$this->assertArrayNotHasKey( 'after', $GLOBALS['wp_styles']->registered['test-handle']->extra, 'Source of style not should set to after property' );
+		$this->assertSame( 1, $filter->get_call_count(), 'wp_filesize should only be called once' );
+	}
+
+	/**
+	 * @ticket 58394
+	 *
+	 * @covers ::wp_maybe_inline_styles
+	 */
+	public function test_wp_maybe_inline_styles_no_src() {
+		wp_register_style( 'test-handle', false );
+		wp_style_add_data( 'test-handle', 'path', ABSPATH . WPINC . '/css/classic-themes.css' );
+
+		wp_enqueue_style( 'test-handle' );
+
+		wp_maybe_inline_styles();
+
+		$this->assertFalse( $GLOBALS['wp_styles']->registered['test-handle']->src, 'Source of style should remain false' );
+		$this->assertArrayNotHasKey( 'after', $GLOBALS['wp_styles']->registered['test-handle']->extra, 'Source of style not should set to after property' );
+	}
+
+	/**
+	 * @ticket 58394
+	 *
+	 * @covers ::wp_maybe_inline_styles
+	 */
+	public function test_wp_maybe_inline_styles_no_path() {
+		$url = '/' . WPINC . '/css/classic-themes.css';
+		wp_register_style( 'test-handle', $url );
+
+		wp_enqueue_style( 'test-handle' );
+
+		wp_maybe_inline_styles();
+
+		$this->assertSame( $GLOBALS['wp_styles']->registered['test-handle']->src, $url );
+	}
 }
diff --git a/tests/dependencies/wpInlineScriptTag.php b/tests/dependencies/wpInlineScriptTag.php
index 1e517b637d..2bbb665d39 100644
--- a/tests/dependencies/wpInlineScriptTag.php
+++ b/tests/dependencies/wpInlineScriptTag.php
@@ -119,4 +119,18 @@ JS;
 			)
 		);
 	}
+
+	/**
+	 * Tests that CDATA wrapper duplication is handled.
+	 *
+	 * @ticket 58664
+	 */
+	public function test_get_inline_script_tag_with_duplicated_cdata_wrappers() {
+		remove_theme_support( 'html5' );
+
+		$this->assertSame(
+			"<script type=\"text/javascript\">\n/* <![CDATA[ */\n/* <![CDATA[ */ console.log( 'Hello World!' ); /* ]]]]><![CDATA[> */\n/* ]]> */\n</script>\n",
+			wp_get_inline_script_tag( "/* <![CDATA[ */ console.log( 'Hello World!' ); /* ]]> */" )
+		);
+	}
 }
diff --git a/tests/dependencies/wpRemoveSurroundingEmptyScriptTags.php b/tests/dependencies/wpRemoveSurroundingEmptyScriptTags.php
new file mode 100644
index 0000000000..39b0480ccb
--- /dev/null
+++ b/tests/dependencies/wpRemoveSurroundingEmptyScriptTags.php
@@ -0,0 +1,78 @@
+<?php
+
+/**
+ * Test wp_remove_surrounding_empty_script_tags().
+ *
+ * @group dependencies
+ * @group scripts
+ * @ticket 58664
+ * @covers ::wp_remove_surrounding_empty_script_tags
+ */
+class Tests_Functions_wpRemoveSurroundingEmptyScriptTags extends WP_UnitTestCase {
+
+	/**
+	 * Data provider for test.
+	 *
+	 * @return array
+	 */
+	public function get_data_to_test_wp_remove_surrounding_empty_script_tags() {
+		$error_js = 'console.error("Function wp_remove_surrounding_empty_script_tags() used incorrectly in PHP. Expected string to start with script tag (without attributes) and end with script tag, with optional whitespace.")';
+		return array(
+			'basic_case'            => array(
+				'<script>alert("hello")</script>',
+				'alert("hello")',
+				false,
+			),
+			'BASIC_CASE'            => array(
+				'<SCRIPT>alert("hello")</SCRIPT>',
+				'alert("hello")',
+				false,
+			),
+			'whitespace_basic_case' => array(
+				'  <script>alert("hello")</script>  ',
+				'alert("hello")',
+				false,
+			),
+			'missing_tags'          => array(
+				'alert("hello")',
+				$error_js,
+				true,
+			),
+			'missing_start_tag'     => array(
+				'alert("hello")</script>',
+				$error_js,
+				true,
+			),
+			'missing_end_tag'       => array(
+				'<script>alert("hello")',
+				$error_js,
+				true,
+			),
+			'erroneous attributes'  => array(
+				'<script type="text/javascript">alert("hello")</script>',
+				$error_js,
+				true,
+			),
+		);
+	}
+
+	/**
+	 * Test scenarios for wp_remove_surrounding_empty_script_tags().
+	 *
+	 * @dataProvider get_data_to_test_wp_remove_surrounding_empty_script_tags
+	 *
+	 * @param string $input                 Input.
+	 * @param string $expected              Expected.
+	 * @param bool   $expect_doing_it_wrong Whether input is _doing_it_wrong().
+	 */
+	public function test_wp_remove_surrounding_empty_script_tags( $input, $expected, $expect_doing_it_wrong ) {
+		if ( $expect_doing_it_wrong ) {
+			$this->setExpectedIncorrectUsage( 'wp_remove_surrounding_empty_script_tags' );
+		}
+
+		$this->assertSame(
+			$expected,
+			wp_remove_surrounding_empty_script_tags( $input )
+		);
+	}
+}
diff --git a/tests/dependencies/wpSanitizeScriptAttributes.php b/tests/dependencies/wpSanitizeScriptAttributes.php
index ef737f239a..3ff79fc5d8 100644
--- a/tests/dependencies/wpSanitizeScriptAttributes.php
+++ b/tests/dependencies/wpSanitizeScriptAttributes.php
@@ -128,5 +128,4 @@ class Tests_Functions_wpSanitizeScriptAttributes extends WP_UnitTestCase {
 
 		remove_theme_support( 'html5' );
 	}
-
 }
diff --git a/tests/diff/wpTextDiffRendererTable.php b/tests/diff/wpTextDiffRendererTable.php
new file mode 100644
index 0000000000..7b85a78582
--- /dev/null
+++ b/tests/diff/wpTextDiffRendererTable.php
@@ -0,0 +1,165 @@
+<?php
+
+/**
+ * Tests for WP_Text_Diff_Renderer_Table.
+ *
+ * @group diff
+ */
+class Tests_Diff_WpTextDiffRendererTable extends WP_UnitTestCase {
+	/**
+	 * @var WP_Text_Diff_Renderer_Table
+	 */
+	private $diff_renderer_table;
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+		require_once ABSPATH . 'wp-includes/Text/Diff/Renderer.php';
+		require_once ABSPATH . 'wp-includes/class-wp-text-diff-renderer-table.php';
+	}
+
+	public function set_up() {
+		parent::set_up();
+		$this->diff_renderer_table = new WP_Text_Diff_Renderer_Table();
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__get()
+	 *
+	 * @param string $property_name Property name to get.
+	 * @param mixed $expected       Expected value.
+	 */
+	public function test_should_get_compat_fields( $property_name, $expected ) {
+		$this->assertSame( $expected, $this->diff_renderer_table->$property_name );
+	}
+
+	/**
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__get()
+	 */
+	public function test_should_throw_deprecation_when_getting_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_Text_Diff_Renderer_Table::__get(): ' .
+			'The property `undeclared_property` is not declared. Getting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->assertNull( $this->diff_renderer_table->undeclared_property, 'Getting a dynamic property should return null from WP_Text_Diff_Renderer_Table::__get()' );
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__set()
+	 *
+	 * @param string $property_name Property name to set.
+	 */
+	public function test_should_set_compat_fields( $property_name ) {
+		$value                                     = uniqid();
+		$this->diff_renderer_table->$property_name = $value;
+
+		$this->assertSame( $value, $this->diff_renderer_table->$property_name );
+	}
+
+	/**
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__set()
+	 */
+	public function test_should_throw_deprecation_when_setting_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_Text_Diff_Renderer_Table::__set(): ' .
+			'The property `undeclared_property` is not declared. Setting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->diff_renderer_table->undeclared_property = 'some value';
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__isset()
+	 *
+	 * @param string $property_name Property name to check.
+	 * @param mixed $expected       Expected value.
+	 */
+	public function test_should_isset_compat_fields( $property_name, $expected ) {
+		$actual = isset( $this->diff_renderer_table->$property_name );
+		if ( is_null( $expected ) ) {
+			$this->assertFalse( $actual );
+		} else {
+			$this->assertTrue( $actual );
+		}
+	}
+
+	/**
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__isset()
+	 */
+	public function test_should_throw_deprecation_when_isset_of_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_Text_Diff_Renderer_Table::__isset(): ' .
+			'The property `undeclared_property` is not declared. Checking `isset()` on a dynamic property ' .
+			'is deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->assertFalse( isset( $this->diff_renderer_table->undeclared_property ), 'Checking a dynamic property should return false from WP_Text_Diff_Renderer_Table::__isset()' );
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__unset()
+	 *
+	 * @param string $property_name Property name to unset.
+	 */
+	public function test_should_unset_compat_fields( $property_name ) {
+		unset( $this->diff_renderer_table->$property_name );
+		$this->assertFalse( isset( $this->diff_renderer_table->$property_name ) );
+	}
+
+	/**
+	 * @ticket 58898
+	 *
+	 * @covers WP_Text_Diff_Renderer_Table::__unset()
+	 */
+	public function test_should_throw_deprecation_when_unset_of_dynamic_property() {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_Text_Diff_Renderer_Table::__unset(): ' .
+			'A property `undeclared_property` is not declared. Unsetting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		unset( $this->diff_renderer_table->undeclared_property );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_compat_fields() {
+		return array(
+			'_show_split_view'     => array(
+				'property_name' => '_show_split_view',
+				'expected'      => true,
+			),
+			'inline_diff_renderer' => array(
+				'property_name' => 'inline_diff_renderer',
+				'expected'      => 'WP_Text_Diff_Renderer_inline',
+			),
+			'_diff_threshold'      => array(
+				'property_name' => '_diff_threshold',
+				'expected'      => 0.6,
+			),
+		);
+	}
+}
diff --git a/tests/editor/classic-to-block-menu-converter.php b/tests/editor/classic-to-block-menu-converter.php
new file mode 100644
index 0000000000..9ec6c04183
--- /dev/null
+++ b/tests/editor/classic-to-block-menu-converter.php
@@ -0,0 +1,219 @@
+<?php
+/**
+ * Tests WP_Classic_To_Block_Menu_Converter_Test
+ *
+ * @package WordPress
+ */
+
+/**
+ * Tests for the WP_Classic_To_Block_Menu_Converter_Test class.
+ */
+class WP_Classic_To_Block_Menu_Converter_Test extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_Classic_To_Block_Menu_Converter::get_fallback
+	 */
+	public function test_class_exists() {
+		$this->assertTrue( class_exists( 'WP_Classic_To_Block_Menu_Converter' ) );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_Classic_To_Block_Menu_Converter::convert
+	 * @dataProvider provider_test_passing_non_menu_object_to_converter_returns_wp_error
+	 */
+	public function test_passing_non_menu_object_to_converter_returns_wp_error( $data ) {
+
+		$result = WP_Classic_To_Block_Menu_Converter::convert( $data );
+
+		$this->assertTrue( is_wp_error( $result ), 'Should be a WP_Error instance' );
+
+		$this->assertEquals( 'invalid_menu', $result->get_error_code(), 'Error code should indicate invalidity of menu argument.' );
+
+		$this->assertEquals( 'The menu provided is not a valid menu.', $result->get_error_message(), 'Error message should communicate invalidity of menu argument.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_Classic_To_Block_Menu_Converter::convert
+	 */
+	public function provider_test_passing_non_menu_object_to_converter_returns_wp_error() {
+		return array(
+			array( 1 ),
+			array( -1 ),
+			array( '1' ),
+			array( 'not a menu object' ),
+			array( true ),
+			array( false ),
+			array( array() ),
+			array( new stdClass() ),
+		);
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_Classic_To_Block_Menu_Converter::convert
+	 */
+	public function test_can_convert_classic_menu_to_blocks() {
+
+		$menu_id = wp_create_nav_menu( 'Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Classic Menu Item 1',
+				'menu-item-url'    => '/classic-menu-item-1',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$second_menu_item_id = wp_update_nav_menu_item(
+			$menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Classic Menu Item 2',
+				'menu-item-url'    => '/classic-menu-item-2',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		wp_update_nav_menu_item(
+			$menu_id,
+			0,
+			array(
+				'menu-item-title'     => 'Nested Menu Item 1',
+				'menu-item-url'       => '/nested-menu-item-1',
+				'menu-item-status'    => 'publish',
+				'menu-item-parent-id' => $second_menu_item_id,
+			)
+		);
+
+		$classic_nav_menu = wp_get_nav_menu_object( $menu_id );
+
+		$blocks = WP_Classic_To_Block_Menu_Converter::convert( $classic_nav_menu );
+
+		$this->assertNotEmpty( $blocks );
+
+		$parsed_blocks = parse_blocks( $blocks );
+
+		$first_block  = $parsed_blocks[0];
+		$second_block = $parsed_blocks[1];
+		$nested_block = $parsed_blocks[1]['innerBlocks'][0];
+
+		$this->assertEquals( 'core/navigation-link', $first_block['blockName'], 'First block name should be "core/navigation-link"' );
+
+		$this->assertEquals( 'Classic Menu Item 1', $first_block['attrs']['label'], 'First block label should match.' );
+
+		$this->assertEquals( '/classic-menu-item-1', $first_block['attrs']['url'], 'First block URL should match.' );
+
+		// Assert parent of nested menu item is a submenu block.
+		$this->assertEquals( 'core/navigation-submenu', $second_block['blockName'], 'Second block name should be "core/navigation-submenu"' );
+
+		$this->assertEquals( 'Classic Menu Item 2', $second_block['attrs']['label'], 'Second block label should match.' );
+
+		$this->assertEquals( '/classic-menu-item-2', $second_block['attrs']['url'], 'Second block URL should match.' );
+
+		$this->assertEquals( 'core/navigation-link', $nested_block['blockName'], 'Nested block name should be "core/navigation-link"' );
+
+		$this->assertEquals( 'Nested Menu Item 1', $nested_block['attrs']['label'], 'Nested block label should match.' );
+
+		$this->assertEquals( '/nested-menu-item-1', $nested_block['attrs']['url'], 'Nested block URL should match.' );
+
+		wp_delete_nav_menu( $menu_id );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_Classic_To_Block_Menu_Converter::convert
+	 */
+	public function test_does_not_convert_menu_items_with_non_publish_status() {
+
+			$menu_id = wp_create_nav_menu( 'Classic Menu' );
+
+			wp_update_nav_menu_item(
+				$menu_id,
+				0,
+				array(
+					'menu-item-title'  => 'Classic Menu Item 1',
+					'menu-item-url'    => '/classic-menu-item-1',
+					'menu-item-status' => 'publish',
+				)
+			);
+
+			wp_update_nav_menu_item(
+				$menu_id,
+				0,
+				array(
+					'menu-item-status' => 'draft',
+					'menu-item-title'  => 'Draft Menu Item',
+					'menu-item-url'    => '/draft-menu-item',
+				)
+			);
+
+			wp_update_nav_menu_item(
+				$menu_id,
+				0,
+				array(
+					'menu-item-status' => 'private',
+					'menu-item-title'  => 'Private Item',
+					'menu-item-url'    => '/private-menu-item',
+				)
+			);
+
+			wp_update_nav_menu_item(
+				$menu_id,
+				0,
+				array(
+					'menu-item-status' => 'pending',
+					'menu-item-title'  => 'Pending Menu Item',
+					'menu-item-url'    => '/pending-menu-item',
+				)
+			);
+
+			wp_update_nav_menu_item(
+				$menu_id,
+				0,
+				array(
+					'menu-item-status' => 'future',
+					'menu-item-title'  => 'Future Menu Item',
+					'menu-item-url'    => '/future-menu-item',
+				)
+			);
+
+			$classic_nav_menu = wp_get_nav_menu_object( $menu_id );
+
+			$blocks = WP_Classic_To_Block_Menu_Converter::convert( $classic_nav_menu );
+
+			$this->assertNotEmpty( $blocks );
+
+			$parsed_blocks = parse_blocks( $blocks );
+
+			$this->assertCount( 1, $parsed_blocks, 'Should only be one block in the array.' );
+
+			$this->assertEquals( 'core/navigation-link', $parsed_blocks[0]['blockName'], 'First block name should be "core/navigation-link"' );
+
+			$this->assertEquals( 'Classic Menu Item 1', $parsed_blocks[0]['attrs']['label'], 'First block label should match.' );
+
+			$this->assertEquals( '/classic-menu-item-1', $parsed_blocks[0]['attrs']['url'], 'First block URL should match.' );
+
+			wp_delete_nav_menu( $menu_id );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_Classic_To_Block_Menu_Converter::convert
+	 */
+	public function test_returns_empty_string_for_menus_with_no_items() {
+		$menu_id = wp_create_nav_menu( 'Empty Menu' );
+
+		$classic_nav_menu = wp_get_nav_menu_object( $menu_id );
+
+		$blocks = WP_Classic_To_Block_Menu_Converter::convert( $classic_nav_menu );
+
+		$this->assertSame( '', $blocks, 'Result should be empty string.' );
+
+		wp_delete_nav_menu( $menu_id );
+	}
+}
diff --git a/tests/editor/navigation-fallback.php b/tests/editor/navigation-fallback.php
new file mode 100644
index 0000000000..6cdf1b35be
--- /dev/null
+++ b/tests/editor/navigation-fallback.php
@@ -0,0 +1,365 @@
+<?php
+/**
+ * Tests WP_Navigation_Fallback
+ *
+ * @package WordPress
+ */
+
+/**
+ * Tests for the WP_Navigation_Fallback class.
+ */
+class WP_Navigation_Fallback_Test extends WP_UnitTestCase {
+
+	protected static $admin_user;
+	protected static $editor_user;
+
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$admin_user = $factory->user->create( array( 'role' => 'administrator' ) );
+
+		self::$editor_user = $factory->user->create( array( 'role' => 'editor' ) );
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		wp_set_current_user( self::$admin_user );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller
+	 */
+	public function test_it_exists() {
+		$this->assertTrue( class_exists( 'WP_Navigation_Fallback' ), 'WP_Navigation_Fallback class should exist.' );
+	}
+
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_return_a_default_fallback_navigation_menu_in_absence_of_other_fallbacks() {
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( 'wp_navigation', $data->post_type, 'Fallback menu type should be `wp_navigation`' );
+
+		$this->assertEquals( 'Navigation', $data->post_title, 'Fallback menu title should be the default fallback title' );
+
+		$this->assertEquals( 'navigation', $data->post_name, 'Fallback menu slug (post_name) should be the default slug' );
+
+		$this->assertEquals( '<!-- wp:page-list /-->', $data->post_content );
+
+		$navs_in_db = $this->get_navigations_in_database();
+
+		$this->assertCount( 1, $navs_in_db, 'The fallback Navigation post should be the only one in the database.' );
+	}
+
+	/**
+	 * @ticket 58750
+	 *
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_not_automatically_create_fallback_if_filter_is_falsey() {
+
+		add_filter( 'wp_navigation_should_create_fallback', '__return_false' );
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertEmpty( $data );
+
+		$navs_in_db = $this->get_navigations_in_database();
+
+		$this->assertCount( 0, $navs_in_db, 'The fallback Navigation post should not have been created.' );
+
+		remove_filter( 'wp_navigation_should_create_fallback', '__return_false' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_return_a_default_fallback_navigation_menu_with_no_blocks_if_page_list_block_is_not_registered() {
+
+		$original_page_list_block = WP_Block_Type_Registry::get_instance()->get_registered( 'core/page-list' );
+
+		unregister_block_type( 'core/page-list' );
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertNotEquals( '<!-- wp:page-list /-->', $data->post_content, 'Navigation Menu should not contain a Page List block.' );
+
+		$this->assertEmpty( $data->post_content, 'Menu should be empty.' );
+
+		register_block_type( 'core/page-list', $original_page_list_block );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_handle_consecutive_invocations() {
+		// Invoke the method multiple times to ensure that it doesn't create a new fallback menu on each invocation.
+		WP_Navigation_Fallback::get_fallback();
+		WP_Navigation_Fallback::get_fallback();
+
+		// Assert on the final invocation.
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( 'Navigation', $data->post_title, 'Fallback menu title should be the default title' );
+
+		$navs_in_db = $this->get_navigations_in_database();
+
+		$this->assertCount( 1, $navs_in_db, 'The fallback Navigation post should be the only one in the database.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_return_the_most_recently_created_navigation_menu() {
+
+		self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'wp_navigation',
+				'post_title'   => 'Existing Navigation Menu 1',
+				'post_content' => '<!-- wp:page-list /-->',
+			)
+		);
+
+		$most_recently_published_nav = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'wp_navigation',
+				'post_title'   => 'Existing Navigation Menu 2',
+				'post_content' => '<!-- wp:navigation-link {"label":"Hello world","type":"post","id":1,"url":"/hello-world","kind":"post-type"} /-->',
+			)
+		);
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( $most_recently_published_nav->post_title, $data->post_title, 'Fallback menu title should be the same as the most recently created menu.' );
+
+		$this->assertEquals( $most_recently_published_nav->post_name, $data->post_name, 'Post name should be the same as the most recently created menu.' );
+
+		$this->assertEquals( $most_recently_published_nav->post_content, $data->post_content, 'Post content should be the same as the most recently created menu.' );
+
+		// Check that no new Navigation menu was created.
+		$navs_in_db = $this->get_navigations_in_database();
+
+		$this->assertCount( 2, $navs_in_db, 'Only the existing Navigation menus should be present in the database.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_return_fallback_navigation_from_existing_classic_menu_if_no_navigation_menus_exist() {
+		$menu_id = wp_create_nav_menu( 'Existing Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Classic Menu Item 1',
+				'menu-item-url'    => '/classic-menu-item-1',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( 'Existing Classic Menu', $data->post_title, 'Fallback menu title should be the same as the classic menu.' );
+
+		// Assert that the fallback contains a navigation-link block.
+		$this->assertStringContainsString( '<!-- wp:navigation-link', $data->post_content, 'The fallback Navigation Menu should contain a `core/navigation-link` block.' );
+
+		// Assert that fallback post_content contains the expected menu item title.
+		$this->assertStringContainsString( '"label":"Classic Menu Item 1"', $data->post_content, 'The fallback Navigation Menu should contain menu item with a label matching the title of the menu item from the Classic Menu.' );
+
+		// Assert that fallback post_content contains the expected menu item url.
+		$this->assertStringContainsString( '"url":"/classic-menu-item-1"', $data->post_content, 'The fallback Navigation Menu should contain menu item with a url matching the slug of the menu item from the Classic Menu.' );
+
+		// Check that only a single Navigation fallback was created.
+		$navs_in_db = $this->get_navigations_in_database();
+		$this->assertCount( 1, $navs_in_db, 'A single Navigation menu should be present in the database.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_prioritise_fallback_to_classic_menu_in_primary_location() {
+		$pl_menu_id = wp_create_nav_menu( 'Classic Menu in Primary Location' );
+
+		wp_update_nav_menu_item(
+			$pl_menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'PL Classic Menu Item',
+				'menu-item-url'    => '/pl-classic-menu-item',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$another_menu_id = wp_create_nav_menu( 'Another Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$another_menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Another Classic Menu Item',
+				'menu-item-url'    => '/another-classic-menu-item',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$locations            = get_nav_menu_locations();
+		$locations['primary'] = $pl_menu_id;
+		$locations['header']  = $another_menu_id;
+		set_theme_mod( 'nav_menu_locations', $locations );
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( 'Classic Menu in Primary Location', $data->post_title, 'Fallback menu title should match the menu in the "primary" location.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_fallback_to_classic_menu_with_primary_slug() {
+
+		// Creates a classic menu with the slug "primary".
+		$primary_menu_id = wp_create_nav_menu( 'Primary' );
+
+		wp_update_nav_menu_item(
+			$primary_menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Classic Menu Item',
+				'menu-item-url'    => '/classic-menu-item',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$another_menu_id = wp_create_nav_menu( 'Another Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$another_menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Another Classic Menu Item',
+				'menu-item-url'    => '/another-classic-menu-item',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( 'Primary', $data->post_title, 'Fallback menu title should match the menu with the slug "primary".' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_fallback_to_most_recently_created_classic_menu() {
+
+		// Creates a classic menu with the slug "primary".
+		$primary_menu_id = wp_create_nav_menu( 'Older Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$primary_menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Classic Menu Item',
+				'menu-item-url'    => '/classic-menu-item',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$most_recent_menu_id = wp_create_nav_menu( 'Most Recent Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$most_recent_menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Another Classic Menu Item',
+				'menu-item-url'    => '/another-classic-menu-item',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( 'Most Recent Classic Menu', $data->post_title, 'Fallback menu title should match the menu that was created most recently.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::get_fallback
+	 */
+	public function test_should_not_create_fallback_from_classic_menu_if_a_navigation_menu_already_exists() {
+		$menu_id = wp_create_nav_menu( 'Existing Classic Menu' );
+
+		wp_update_nav_menu_item(
+			$menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Classic Menu Item 1',
+				'menu-item-url'    => '/classic-menu-item-1',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$existing_navigation_menu = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'wp_navigation',
+				'post_title'   => 'Existing Navigation Menu 1',
+				'post_content' => '<!-- wp:page-list /-->',
+			)
+		);
+
+		$data = WP_Navigation_Fallback::get_fallback();
+
+		$this->assertInstanceOf( 'WP_Post', $data, 'Response should be of the correct type.' );
+
+		$this->assertEquals( $existing_navigation_menu->post_title, $data->post_title, 'Fallback menu title should be the same as the existing Navigation menu.' );
+
+		$this->assertNotEquals( 'Existing Classic Menu', $data->post_title, 'Fallback menu title should not be the same as the Classic Menu.' );
+
+		// Check that only a single Navigation fallback was created.
+		$navs_in_db = $this->get_navigations_in_database();
+
+		$this->assertCount( 1, $navs_in_db, 'Only the existing Navigation menus should be present in the database.' );
+	}
+
+	private function get_navigations_in_database() {
+		$navs_in_db = new WP_Query(
+			array(
+				'post_type'      => 'wp_navigation',
+				'post_status'    => 'publish',
+				'posts_per_page' => -1,
+				'orderby'        => 'date',
+				'order'          => 'DESC',
+			)
+		);
+
+		return $navs_in_db->posts ? $navs_in_db->posts : array();
+	}
+}
diff --git a/tests/feed/atom.php b/tests/feed/atom.php
index c88592ec9a..dae234f51c 100644
--- a/tests/feed/atom.php
+++ b/tests/feed/atom.php
@@ -56,7 +56,6 @@ class Tests_Feed_Atom extends WP_UnitTestCase {
 
 		// Assign a tagline option.
 		update_option( 'blogdescription', 'Just another WordPress site' );
-
 	}
 
 	/**
@@ -288,7 +287,7 @@ class Tests_Feed_Atom extends WP_UnitTestCase {
 					$this->assertSame( $enclosures[ $i ]['expected']['href'], $link['attributes']['href'] );
 					$this->assertEquals( $enclosures[ $i ]['expected']['length'], $link['attributes']['length'] );
 					$this->assertSame( $enclosures[ $i ]['expected']['type'], $link['attributes']['type'] );
-					$i++;
+					++$i;
 				}
 			}
 		}
diff --git a/tests/feed/rss2.php b/tests/feed/rss2.php
index a3f45e0896..4eea99965c 100644
--- a/tests/feed/rss2.php
+++ b/tests/feed/rss2.php
@@ -64,7 +64,6 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 
 		// Assign a tagline option.
 		update_option( 'blogdescription', 'Just another WordPress site' );
-
 	}
 
 	/**
@@ -247,7 +246,7 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 			}
 			$cats = array_filter( $cats );
 			// Should be the same number of categories.
-			$this->assertSame( count( $cats ), count( $categories ) );
+			$this->assertCount( count( $cats ), $categories );
 
 			// ..with the same names.
 			foreach ( $cats as $id => $cat ) {
@@ -506,7 +505,6 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 			array( '/?feed=rss2', 'rss' ),
 			array( '/?feed=commentsrss2', 'rss' ),
 		);
-
 	}
 
 	/**
@@ -535,7 +533,7 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 		// The Last-Modified header should have the post's date when "withcomments" is not passed.
 		add_filter(
 			'wp_headers',
-			function( $headers ) use ( $last_week ) {
+			function ( $headers ) use ( $last_week ) {
 				$this->assertSame(
 					strtotime( $headers['Last-Modified'] ),
 					strtotime( $last_week ),
@@ -574,7 +572,7 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 		// The Last-Modified header should have the comment's date when "withcomments=1" is passed.
 		add_filter(
 			'wp_headers',
-			function( $headers ) use ( $yesterday ) {
+			function ( $headers ) use ( $yesterday ) {
 				$this->assertSame(
 					strtotime( $headers['Last-Modified'] ),
 					strtotime( $yesterday ),
@@ -617,7 +615,7 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 		// The Last-Modified header should have the date from today's post when it is the latest update.
 		add_filter(
 			'wp_headers',
-			function( $headers ) use ( $today ) {
+			function ( $headers ) use ( $today ) {
 				$this->assertSame(
 					strtotime( $headers['Last-Modified'] ),
 					strtotime( $today ),
diff --git a/tests/file.php b/tests/file.php
index 79da981a22..c99f1baffd 100644
--- a/tests/file.php
+++ b/tests/file.php
@@ -205,6 +205,199 @@ class Tests_File extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Tests that `wp_tempnam()` limits the filename's length to 252 characters.
+	 *
+	 * @ticket 35755
+	 *
+	 * @covers ::wp_tempnam
+	 *
+	 * @dataProvider data_wp_tempnam_should_limit_filename_length_to_252_characters
+	 */
+	public function test_wp_tempnam_should_limit_filename_length_to_252_characters( $filename ) {
+		$file = wp_tempnam( $filename );
+
+		if ( file_exists( $file ) ) {
+			self::unlink( $file );
+		}
+
+		$this->assertLessThanOrEqual( 252, strlen( basename( $file ) ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_tempnam_should_limit_filename_length_to_252_characters() {
+		return array(
+			'the limit before adding characters for uniqueness' => array( 'filename' => str_pad( '', 241, 'filename' ) ),
+			'one more than the limit before adding characters for uniqueness' => array( 'filename' => str_pad( '', 242, 'filename' ) ),
+			'251 characters' => array( 'filename' => str_pad( '', 251, 'filename' ) ),
+			'252 characters' => array( 'filename' => str_pad( '', 252, 'filename' ) ),
+			'253 characters' => array( 'filename' => str_pad( '', 253, 'filename' ) ),
+		);
+	}
+
+	/**
+	 * Tests that `wp_tempnam()` limits the filename's length to 252 characters
+	 * when there is a name conflict.
+	 *
+	 * @ticket 35755
+	 *
+	 * @covers ::wp_tempnam
+	 */
+	public function test_wp_tempnam_should_limit_filename_length_to_252_characters_with_name_conflict() {
+		// Create a conflict by removing the randomness of the generated password.
+		add_filter(
+			'random_password',
+			static function () {
+				return '123456';
+			},
+			10,
+			0
+		);
+
+		// A filename at the limit.
+		$filename = str_pad( '', 252, 'filename' );
+
+		// Create the initial file.
+		$existing_file = wp_tempnam( $filename );
+
+		// Try creating a file with the same name.
+		$actual = wp_tempnam( basename( $existing_file ) );
+
+		self::unlink( $existing_file );
+		self::unlink( $actual );
+
+		$this->assertLessThanOrEqual( 252, strlen( basename( $actual ) ) );
+	}
+
+	/**
+	 * Tests that `wp_tempnam()` limits the filename's length to 252 characters
+	 * when a 'random_password' filter returns passwords longer than 6 characters.
+	 *
+	 * @ticket 35755
+	 *
+	 * @covers ::wp_tempnam
+	 */
+	public function test_wp_tempnam_should_limit_filename_length_to_252_characters_when_random_password_is_filtered() {
+		// Force random passwords to 12 characters.
+		add_filter(
+			'random_password',
+			static function () {
+				return '1a2b3c4d5e6f';
+			},
+			10,
+			0
+		);
+
+		// A filename at the limit.
+		$filename = str_pad( '', 252, 'filename' );
+		$actual   = wp_tempnam( $filename );
+
+		self::unlink( $actual );
+
+		$this->assertLessThanOrEqual( 252, strlen( basename( $actual ) ) );
+	}
+
+	/**
+	 * Tests that `wp_tempnam()` limits the filename's length to 252 characters
+	 * when a 'wp_unique_filename' filter returns a filename longer than 252 characters.
+	 *
+	 * @ticket 35755
+	 *
+	 * @covers ::wp_tempnam
+	 */
+	public function test_wp_tempnam_should_limit_filename_length_to_252_characters_when_wp_unique_filename_is_filtered() {
+		// Determine the number of additional characters added by `wp_tempnam()`.
+		$temp_dir                    = get_temp_dir();
+		$additional_chars_filename   = wp_unique_filename( $temp_dir, 'filename' );
+		$additional_chars_generated  = wp_tempnam( $additional_chars_filename, $temp_dir );
+		$additional_chars_difference = strlen( basename( $additional_chars_generated ) ) - strlen( $additional_chars_filename );
+
+		$filenames_over_limit = 0;
+
+		// Make the filter send the filename over the limit.
+		add_filter(
+			'wp_unique_filename',
+			static function ( $filename ) use ( &$filenames_over_limit ) {
+				if ( strlen( $filename ) === 252 ) {
+					$filename .= '1';
+					++$filenames_over_limit;
+				}
+
+				return $filename;
+			},
+			10,
+			1
+		);
+
+		// A filename that will hit the limit when `wp_tempnam()` adds characters.
+		$filename = str_pad( '', 252 - $additional_chars_difference, 'filename' );
+		$actual   = wp_tempnam( $filename );
+
+		self::unlink( $additional_chars_generated );
+		self::unlink( $actual );
+
+		$this->assertLessThanOrEqual( 252, strlen( basename( $actual ) ), 'The final filename was over the limit.' );
+		$this->assertSame( 1, $filenames_over_limit, 'One filename should have been over the limit.' );
+	}
+
+	/**
+	 * Tests that `wp_tempnam()` limits the filename's length to 252 characters
+	 * when both a 'random_password' filter and a 'wp_unique_filename' filter
+	 * cause the filename to be greater than 252 characters.
+	 *
+	 * @ticket 35755
+	 *
+	 * @covers ::wp_tempnam
+	 */
+	public function test_wp_tempnam_should_limit_filename_length_to_252_characters_when_random_password_and_wp_unique_filename_are_filtered() {
+		// Force random passwords to 12 characters.
+		add_filter(
+			'random_password',
+			static function () {
+				return '1a2b3c4d5e6f';
+			},
+			10,
+			0
+		);
+
+		// Determine the number of additional characters added by `wp_tempnam()`.
+		$temp_dir                    = get_temp_dir();
+		$additional_chars_filename   = wp_unique_filename( $temp_dir, 'filename' );
+		$additional_chars_generated  = wp_tempnam( $additional_chars_filename, $temp_dir );
+		$additional_chars_difference = strlen( basename( $additional_chars_generated ) ) - strlen( $additional_chars_filename );
+
+		$filenames_over_limit = 0;
+
+		// Make the filter send the filename over the limit.
+		add_filter(
+			'wp_unique_filename',
+			static function ( $filename ) use ( &$filenames_over_limit ) {
+				if ( strlen( $filename ) === 252 ) {
+					$filename .= '1';
+					++$filenames_over_limit;
+				}
+
+				return $filename;
+			},
+			10,
+			1
+		);
+
+		// A filename that will hit the limit when `wp_tempnam()` adds characters.
+		$filename = str_pad( '', 252 - $additional_chars_difference, 'filename' );
+		$actual   = wp_tempnam( $filename );
+
+		self::unlink( $additional_chars_generated );
+		self::unlink( $actual );
+
+		$this->assertLessThanOrEqual( 252, strlen( basename( $actual ) ), 'The final filename was over the limit.' );
+		$this->assertSame( 1, $filenames_over_limit, 'One filename should have been over the limit.' );
+	}
+
 	/**
 	 * @ticket 47186
 	 */
diff --git a/tests/filesystem/_unzipFilePclzip.php b/tests/filesystem/_unzipFilePclzip.php
new file mode 100644
index 0000000000..c3098c6a86
--- /dev/null
+++ b/tests/filesystem/_unzipFilePclzip.php
@@ -0,0 +1,75 @@
+<?php
+
+/**
+ * Tests _unzip_file_pclzip().
+ *
+ * @group file.php
+ *
+ * @covers ::_unzip_file_pclzip
+ */
+class Tests_Filesystem_UnzipFilePclzip extends WP_UnitTestCase {
+
+	/**
+	 * The test data directory.
+	 *
+	 * @var string $test_data_dir
+	 */
+	private static $test_data_dir;
+
+	/**
+	 * Sets up the filesystem and test data directory property
+	 * before any tests run.
+	 */
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		require_once ABSPATH . 'wp-admin/includes/file.php';
+		WP_Filesystem();
+
+		self::$test_data_dir = DIR_TESTDATA . '/filesystem/';
+	}
+
+	/**
+	 * Tests that _unzip_file_pclzip() applies "pre_unzip_file" filters.
+	 *
+	 * @ticket 37719
+	 */
+	public function test_should_apply_pre_unzip_file_filters() {
+		$filter = new MockAction();
+		add_filter( 'pre_unzip_file', array( $filter, 'filter' ) );
+
+		// Prepare test environment.
+		$unzip_destination = self::$test_data_dir . 'archive/';
+		mkdir( $unzip_destination );
+
+		_unzip_file_pclzip( self::$test_data_dir . 'archive.zip', $unzip_destination );
+
+		// Cleanup test environment.
+		$this->rmdir( $unzip_destination );
+		$this->delete_folders( $unzip_destination );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that _unzip_file_pclzip() applies "unzip_file" filters.
+	 *
+	 * @ticket 37719
+	 */
+	public function test_should_apply_unzip_file_filters() {
+		$filter = new MockAction();
+		add_filter( 'unzip_file', array( $filter, 'filter' ) );
+
+		// Prepare test environment.
+		$unzip_destination = self::$test_data_dir . 'archive/';
+		mkdir( $unzip_destination );
+
+		_unzip_file_pclzip( self::$test_data_dir . 'archive.zip', $unzip_destination );
+
+		// Cleanup test environment.
+		$this->rmdir( $unzip_destination );
+		$this->delete_folders( $unzip_destination );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+}
diff --git a/tests/filesystem/_unzipFileZiparchive.php b/tests/filesystem/_unzipFileZiparchive.php
new file mode 100644
index 0000000000..a9d385d339
--- /dev/null
+++ b/tests/filesystem/_unzipFileZiparchive.php
@@ -0,0 +1,83 @@
+<?php
+
+/**
+ * Tests _unzip_file_ziparchive().
+ *
+ * @group file.php
+ *
+ * @covers ::_unzip_file_ziparchive
+ */
+class Tests_Filesystem_UnzipFileZiparchive extends WP_UnitTestCase {
+
+	/**
+	 * The test data directory.
+	 *
+	 * @var string $test_data_dir
+	 */
+	private static $test_data_dir;
+
+	/**
+	 * Sets up the filesystem and test data directory property
+	 * before any tests run.
+	 */
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		require_once ABSPATH . 'wp-admin/includes/file.php';
+		WP_Filesystem();
+
+		self::$test_data_dir = DIR_TESTDATA . '/filesystem/';
+	}
+
+	/**
+	 * Tests that _unzip_file_ziparchive() applies "pre_unzip_file" filters.
+	 *
+	 * @ticket 37719
+	 */
+	public function test_should_apply_pre_unzip_file_filters() {
+		if ( ! class_exists( 'ZipArchive' ) ) {
+			$this->markTestSkipped( 'This test requires the ZipArchive class.' );
+		}
+
+		$filter = new MockAction();
+		add_filter( 'pre_unzip_file', array( $filter, 'filter' ) );
+
+		// Prepare test environment.
+		$unzip_destination = self::$test_data_dir . 'archive/';
+		mkdir( $unzip_destination );
+
+		_unzip_file_ziparchive( self::$test_data_dir . 'archive.zip', $unzip_destination );
+
+		// Cleanup test environment.
+		$this->rmdir( $unzip_destination );
+		$this->delete_folders( $unzip_destination );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that _unzip_file_ziparchive() applies "unzip_file" filters.
+	 *
+	 * @ticket 37719
+	 */
+	public function test_should_apply_unzip_file_filters() {
+		if ( ! class_exists( 'ZipArchive' ) ) {
+			$this->markTestSkipped( 'This test requires the ZipArchive class.' );
+		}
+
+		$filter = new MockAction();
+		add_filter( 'unzip_file', array( $filter, 'filter' ) );
+
+		// Prepare test environment.
+		$unzip_destination = self::$test_data_dir . 'archive/';
+		mkdir( $unzip_destination );
+
+		_unzip_file_ziparchive( self::$test_data_dir . 'archive.zip', $unzip_destination );
+
+		// Cleanup test environment.
+		$this->rmdir( $unzip_destination );
+		$this->delete_folders( $unzip_destination );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+}
diff --git a/tests/filesystem/base.php b/tests/filesystem/base.php
index 52ab59e3cd..ceefeafa3e 100644
--- a/tests/filesystem/base.php
+++ b/tests/filesystem/base.php
@@ -24,7 +24,7 @@ abstract class WP_Filesystem_UnitTestCase extends WP_UnitTestCase {
 		return 'MockFS';
 	}
 	public function filter_abstraction_file( $file ) {
-		return dirname( dirname( __DIR__ ) ) . '/includes/mock-fs.php';
+		return dirname( __DIR__, 2 ) . '/includes/mock-fs.php';
 	}
 
 	public function test_is_MockFS_sane() {
diff --git a/tests/filesystem/copyDir.php b/tests/filesystem/copyDir.php
new file mode 100644
index 0000000000..914e2b867c
--- /dev/null
+++ b/tests/filesystem/copyDir.php
@@ -0,0 +1,82 @@
+<?php
+
+/**
+ * Tests copy_dir().
+ *
+ * @group file.php
+ *
+ * @covers ::copy_dir
+ */
+class Tests_Filesystem_CopyDir extends WP_UnitTestCase {
+
+	/**
+	 * The test directory.
+	 *
+	 * @var string $test_dir
+	 */
+	private static $test_dir;
+
+	/**
+	 * Sets up the filesystem and test directory before any tests run.
+	 */
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		require_once ABSPATH . 'wp-admin/includes/file.php';
+		WP_Filesystem();
+
+		self::$test_dir = get_temp_dir() . 'copy_dir/';
+	}
+
+	/**
+	 * Sets up the test directory before each test.
+	 */
+	public function set_up() {
+		global $wp_filesystem;
+
+		parent::set_up();
+
+		// Create the root directory.
+		$wp_filesystem->mkdir( self::$test_dir );
+	}
+
+	/**
+	 * Removes the test directory after each test.
+	 */
+	public function tear_down() {
+		global $wp_filesystem;
+
+		// Delete the root directory and its contents.
+		$wp_filesystem->delete( self::$test_dir, true );
+
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests that the destination is created if it does not already exist.
+	 *
+	 * @ticket 41855
+	 */
+	public function test_should_create_destination_it_if_does_not_exist() {
+		global $wp_filesystem;
+
+		$from = self::$test_dir . 'folder1/folder2/';
+		$to   = self::$test_dir . 'folder3/folder2/';
+
+		// Create the file structure for the test.
+		$wp_filesystem->mkdir( self::$test_dir . 'folder1' );
+		$wp_filesystem->mkdir( self::$test_dir . 'folder3' );
+		$wp_filesystem->mkdir( $from );
+		$wp_filesystem->touch( $from . 'file1.txt' );
+		$wp_filesystem->mkdir( $from . 'subfolder1' );
+		$wp_filesystem->touch( $from . 'subfolder1/file2.txt' );
+
+		$this->assertTrue( copy_dir( $from, $to ), 'copy_dir() failed.' );
+
+		$this->assertDirectoryExists( $to, 'The destination was not created.' );
+		$this->assertFileExists( $to . 'file1.txt', 'The destination file was not created.' );
+
+		$this->assertDirectoryExists( $to . 'subfolder1/', 'The destination subfolder was not created.' );
+		$this->assertFileExists( $to . 'subfolder1/file2.txt', 'The destination subfolder file was not created.' );
+	}
+}
diff --git a/tests/filesystem/findFolder.php b/tests/filesystem/findFolder.php
index 3db6107585..59e9e8c605 100644
--- a/tests/filesystem/findFolder.php
+++ b/tests/filesystem/findFolder.php
@@ -24,7 +24,6 @@ class WP_Filesystem_Find_Folder_Test extends WP_Filesystem_UnitTestCase {
 
 		$path = $fs->find_folder( '/this/directory/doesnt/exist/' );
 		$this->assertFalse( $path );
-
 	}
 
 	public function test_sibling_wordpress_in_subdir() {
@@ -48,7 +47,6 @@ class WP_Filesystem_Find_Folder_Test extends WP_Filesystem_UnitTestCase {
 
 		$path = $fs->find_folder( '/var/www/wp.example.com/wordpress/wp-content/' );
 		$this->assertSame( '/www/wp.example.com/wordpress/wp-content/', $path );
-
 	}
 
 	/**
@@ -76,7 +74,6 @@ class WP_Filesystem_Find_Folder_Test extends WP_Filesystem_UnitTestCase {
 
 		$path = $fs->abspath( '/var/www/example.com/' );
 		$this->assertSame( '/', $path );
-
 	}
 
 	/**
@@ -113,5 +110,4 @@ class WP_Filesystem_Find_Folder_Test extends WP_Filesystem_UnitTestCase {
 		$path = $fs->find_folder( '/var/www/example.com/sub/wp-content/plugins/' );
 		$this->assertSame( '/example.com/sub/wp-content/plugins/', $path );
 	}
-
 }
diff --git a/tests/filesystem/moveDir.php b/tests/filesystem/moveDir.php
index 4cc013453d..d2661fd48d 100644
--- a/tests/filesystem/moveDir.php
+++ b/tests/filesystem/moveDir.php
@@ -308,5 +308,4 @@ class Tests_Filesystem_MoveDir extends WP_UnitTestCase {
 			'An unexpected error code was returned.'
 		);
 	}
-
 }
diff --git a/tests/filters.php b/tests/filters.php
index fed43735fc..04a5f9e915 100644
--- a/tests/filters.php
+++ b/tests/filters.php
@@ -42,7 +42,6 @@ class Tests_Filters extends WP_UnitTestCase {
 		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 		$this->assertSame( 1, $a->get_call_count() );
 		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
-
 	}
 
 	public function test_has_filter() {
@@ -174,7 +173,6 @@ class Tests_Filters extends WP_UnitTestCase {
 		// $hook_name1's count hasn't changed, $hook_name2 should be correct.
 		$this->assertSame( 1, did_filter( $hook_name1 ) );
 		$this->assertSame( $count, did_filter( $hook_name2 ) );
-
 	}
 
 	public function test_all_filter() {
@@ -198,7 +196,6 @@ class Tests_Filters extends WP_UnitTestCase {
 
 		remove_filter( 'all', array( $a, 'filterall' ) );
 		$this->assertFalse( has_filter( 'all', array( $a, 'filterall' ) ) );
-
 	}
 
 	public function test_remove_all_filter() {
@@ -332,7 +329,6 @@ class Tests_Filters extends WP_UnitTestCase {
 		// Just in case we don't trust assertSame().
 		$obj->foo = true;
 		$this->assertNotEmpty( $args[0][1]->foo );
-
 	}
 
 	/**
diff --git a/tests/fonts/font-face/base.php b/tests/fonts/font-face/base.php
new file mode 100644
index 0000000000..3b01655772
--- /dev/null
+++ b/tests/fonts/font-face/base.php
@@ -0,0 +1,122 @@
+<?php
+/**
+ * Test case for the Fonts tests.
+ *
+ * @package    WordPress
+ * @subpackage Fonts
+ */
+
+require_once __DIR__ . '/wp-font-face-tests-dataset.php';
+/**
+ * Abstracts the common tasks for the Font Face tests.
+ */
+abstract class WP_Font_Face_UnitTestCase extends WP_UnitTestCase {
+	use WP_Font_Face_Tests_Datasets;
+
+	/**
+	 * Current error reporting level (before a test changes it).
+	 *
+	 * @var null|int
+	 */
+	protected $error_reporting_level = null;
+
+	/**
+	 * Reflection data store for non-public property access.
+	 *
+	 * @var ReflectionProperty[]
+	 */
+	protected $property = array();
+
+	/**
+	 * Indicates the test class uses `switch_theme()` and requires
+	 * set_up and tear_down fixtures to set and reset hooks and memory.
+	 *
+	 * If a test class switches themes, set this property to `true`.
+	 *
+	 * @var bool
+	 */
+	protected static $requires_switch_theme_fixtures = false;
+
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	protected static $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	protected $orig_theme_dir;
+
+	/**
+	 * Administrator ID.
+	 *
+	 * @var int
+	 */
+	protected static $administrator_id = 0;
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		if ( self::$requires_switch_theme_fixtures ) {
+			self::$theme_root = realpath( DIR_TESTDATA . '/themedir1' );
+		}
+	}
+
+	public static function tear_down_after_class() {
+		// Reset static flags.
+		self::$requires_switch_theme_fixtures = false;
+
+		parent::tear_down_after_class();
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		if ( self::$requires_switch_theme_fixtures ) {
+			$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
+
+			// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
+			$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', self::$theme_root );
+
+			// Set up the new root.
+			add_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+			add_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+			add_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+			// Clear caches.
+			wp_clean_themes_cache();
+			unset( $GLOBALS['wp_themes'] );
+		}
+	}
+
+	public function tear_down() {
+		$this->property = array();
+
+		// Reset the error reporting when modified within a test.
+		if ( is_int( $this->error_reporting_level ) ) {
+			error_reporting( $this->error_reporting_level );
+			$this->error_reporting_level = null;
+		}
+
+		// Restore themes.
+		if ( self::$requires_switch_theme_fixtures ) {
+			$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
+			remove_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+			remove_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+			remove_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+			wp_clean_themes_cache();
+			wp_clean_theme_json_cache();
+			unset( $GLOBALS['wp_themes'] );
+		}
+
+		parent::tear_down();
+	}
+
+	public function filter_set_theme_root() {
+		return self::$theme_root;
+	}
+}
diff --git a/tests/fonts/font-face/wp-font-face-tests-dataset.php b/tests/fonts/font-face/wp-font-face-tests-dataset.php
new file mode 100644
index 0000000000..00ae66e865
--- /dev/null
+++ b/tests/fonts/font-face/wp-font-face-tests-dataset.php
@@ -0,0 +1,274 @@
+<?php
+/**
+ * Datasets for unit and integration tests.
+ *
+ * @package    WordPress
+ * @subpackage Fonts
+ */
+
+/**
+ * Trait for reusing datasets within the Fonts tests.
+ */
+trait WP_Font_Face_Tests_Datasets {
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_print_given_fonts() {
+		return array(
+			'single truetype format font'    => array(
+				'fonts'    => array(
+					'Inter' =>
+						array(
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/inter/Inter-VariableFont_slnt,wght.ttf',
+									),
+								'font-family'  => 'Inter',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '200',
+							),
+						),
+				),
+				'expected' => <<<CSS
+@font-face{font-family:Inter;font-style:normal;font-weight:200;font-display:fallback;src:url('https://example.org/assets/fonts/inter/Inter-VariableFont_slnt,wght.ttf') format('truetype');font-stretch:normal;}
+CSS
+			,
+			),
+			'multiple truetype format fonts' => array(
+				'fonts'    => array(
+					'Inter' =>
+						array(
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/inter/Inter-VariableFont_slnt,wght.ttf',
+									),
+								'font-family'  => 'Inter',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '200',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/inter/Inter-VariableFont_slnt-Italic,wght.ttf',
+									),
+								'font-family'  => 'Inter',
+								'font-stretch' => 'normal',
+								'font-style'   => 'italic',
+								'font-weight'  => '900',
+							),
+						),
+				),
+				'expected' => <<<CSS
+@font-face{font-family:Inter;font-style:normal;font-weight:200;font-display:fallback;src:url('https://example.org/assets/fonts/inter/Inter-VariableFont_slnt,wght.ttf') format('truetype');font-stretch:normal;}
+@font-face{font-family:Inter;font-style:italic;font-weight:900;font-display:fallback;src:url('https://example.org/assets/fonts/inter/Inter-VariableFont_slnt-Italic,wght.ttf') format('truetype');font-stretch:normal;}
+CSS
+			,
+			),
+			'single woff2 format font'       => array(
+				'fonts'    => array(
+					'DM Sans' =>
+						array(
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/dm-sans/DMSans-Regular.woff2',
+									),
+								'font-family'  => 'DM Sans',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '400',
+							),
+						),
+				),
+				'expected' => <<<CSS
+@font-face{font-family:"DM Sans";font-style:normal;font-weight:400;font-display:fallback;src:url('https://example.org/assets/fonts/dm-sans/DMSans-Regular.woff2') format('woff2');font-stretch:normal;}
+CSS
+			,
+			),
+			'multiple woff2 format fonts'    => array(
+				'fonts'    => array(
+					'DM Sans'       =>
+						array(
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/dm-sans/DMSans-Regular.woff2',
+									),
+								'font-family'  => 'DM Sans',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '400',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/dm-sans/DMSans-Regular-Italic.woff2',
+									),
+								'font-family'  => 'DM Sans',
+								'font-stretch' => 'normal',
+								'font-style'   => 'italic',
+								'font-weight'  => '400',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/dm-sans/DMSans-Bold.woff2',
+									),
+								'font-family'  => 'DM Sans',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '700',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/dm-sans/DMSans-Bold-Italic.woff2',
+									),
+								'font-family'  => 'DM Sans',
+								'font-stretch' => 'normal',
+								'font-style'   => 'italic',
+								'font-weight'  => '700',
+							),
+						),
+					'IBM Plex Mono' =>
+						array(
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Light.woff2',
+									),
+								'font-family'  => 'IBM Plex Mono',
+								'font-display' => 'block',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '300',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Regular.woff2',
+									),
+								'font-family'  => 'IBM Plex Mono',
+								'font-display' => 'block',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '400',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Italic.woff2',
+									),
+								'font-family'  => 'IBM Plex Mono',
+								'font-display' => 'block',
+								'font-stretch' => 'normal',
+								'font-style'   => 'italic',
+								'font-weight'  => '400',
+							),
+							array(
+								'src'          =>
+									array(
+										'https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Bold.woff2',
+									),
+								'font-family'  => 'IBM Plex Mono',
+								'font-display' => 'block',
+								'font-stretch' => 'normal',
+								'font-style'   => 'normal',
+								'font-weight'  => '700',
+							),
+						),
+				),
+				'expected' => <<<CSS
+@font-face{font-family:"DM Sans";font-style:normal;font-weight:400;font-display:fallback;src:url('https://example.org/assets/fonts/dm-sans/DMSans-Regular.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"DM Sans";font-style:italic;font-weight:400;font-display:fallback;src:url('https://example.org/assets/fonts/dm-sans/DMSans-Regular-Italic.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"DM Sans";font-style:normal;font-weight:700;font-display:fallback;src:url('https://example.org/assets/fonts/dm-sans/DMSans-Bold.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"DM Sans";font-style:italic;font-weight:700;font-display:fallback;src:url('https://example.org/assets/fonts/dm-sans/DMSans-Bold-Italic.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"IBM Plex Mono";font-style:normal;font-weight:300;font-display:block;src:url('https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Light.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"IBM Plex Mono";font-style:normal;font-weight:400;font-display:block;src:url('https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Regular.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"IBM Plex Mono";font-style:italic;font-weight:400;font-display:block;src:url('https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Italic.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"IBM Plex Mono";font-style:normal;font-weight:700;font-display:block;src:url('https://example.org/assets/fonts/ibm-plex-mono/IBMPlexMono-Bold.woff2') format('woff2');font-stretch:normal;}
+CSS
+			,
+			),
+		);
+	}
+
+	public function get_expected_fonts_for_fonts_block_theme( $key = '' ) {
+		static $data = null;
+
+		if ( null === $data ) {
+			$uri  = get_stylesheet_directory_uri() . '/assets/fonts/';
+			$data = array(
+				'fonts'            => array(
+					'DM Sans'          => array(
+						array(
+							'src'          => array( $uri . 'dm-sans/DMSans-Regular.woff2' ),
+							'font-family'  => 'DM Sans',
+							'font-stretch' => 'normal',
+							'font-style'   => 'normal',
+							'font-weight'  => '400',
+						),
+						array(
+							'src'          => array( $uri . 'dm-sans/DMSans-Regular-Italic.woff2' ),
+							'font-family'  => 'DM Sans',
+							'font-stretch' => 'normal',
+							'font-style'   => 'italic',
+							'font-weight'  => '400',
+						),
+						array(
+							'src'          => array( $uri . 'dm-sans/DMSans-Bold.woff2' ),
+							'font-family'  => 'DM Sans',
+							'font-stretch' => 'normal',
+							'font-style'   => 'normal',
+							'font-weight'  => '700',
+						),
+						array(
+							'src'          => array( $uri . 'dm-sans/DMSans-Bold-Italic.woff2' ),
+							'font-family'  => 'DM Sans',
+							'font-stretch' => 'normal',
+							'font-style'   => 'italic',
+							'font-weight'  => '700',
+						),
+					),
+					'Source Serif Pro' => array(
+						array(
+							'src'          => array( $uri . 'source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2' ),
+							'font-family'  => 'Source Serif Pro',
+							'font-stretch' => 'normal',
+							'font-style'   => 'normal',
+							'font-weight'  => '200 900',
+						),
+						array(
+							'src'          => array( $uri . 'source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2' ),
+							'font-family'  => 'Source Serif Pro',
+							'font-stretch' => 'normal',
+							'font-style'   => 'italic',
+							'font-weight'  => '200 900',
+						),
+					),
+				),
+				'font_face_styles' => <<<CSS
+@font-face{font-family:"DM Sans";font-style:normal;font-weight:400;font-display:fallback;src:url('{$uri}dm-sans/DMSans-Regular.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"DM Sans";font-style:italic;font-weight:400;font-display:fallback;src:url('{$uri}dm-sans/DMSans-Regular-Italic.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"DM Sans";font-style:normal;font-weight:700;font-display:fallback;src:url('{$uri}dm-sans/DMSans-Bold.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"DM Sans";font-style:italic;font-weight:700;font-display:fallback;src:url('{$uri}dm-sans/DMSans-Bold-Italic.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"Source Serif Pro";font-style:normal;font-weight:200 900;font-display:fallback;src:url('{$uri}source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"Source Serif Pro";font-style:italic;font-weight:200 900;font-display:fallback;src:url('{$uri}source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2') format('woff2');font-stretch:normal;}
+CSS
+				,
+			);
+		}
+
+		if ( isset( $data[ $key ] ) ) {
+			return $data[ $key ];
+		}
+
+		return $data;
+	}
+}
diff --git a/tests/fonts/font-face/wpFontFace/generateAndPrint.php b/tests/fonts/font-face/wpFontFace/generateAndPrint.php
new file mode 100644
index 0000000000..d079d2808b
--- /dev/null
+++ b/tests/fonts/font-face/wpFontFace/generateAndPrint.php
@@ -0,0 +1,40 @@
+<?php
+/**
+ * Test case for WP_Font_Face::generate_and_print().
+ *
+ * @package    WordPress
+ * @subpackage Fonts
+ *
+ * @since 6.4.0
+ *
+ * @group fonts
+ * @group fontface
+ *
+ * @covers WP_Font_Face::generate_and_print
+ */
+class Tests_Fonts_WPFontFace_GenerateAndPrint extends WP_UnitTestCase {
+	use WP_Font_Face_Tests_Datasets;
+
+	public function test_should_not_generate_and_print_when_no_fonts() {
+		$font_face = new WP_Font_Face();
+		$fonts     = array();
+
+		$this->expectOutputString( '' );
+		$font_face->generate_and_print( $fonts );
+	}
+
+	/**
+	 * @dataProvider data_should_print_given_fonts
+	 *
+	 * @param array  $fonts Prepared fonts.
+	 * @param string $expected Expected CSS.
+	 */
+	public function test_should_generate_and_print_given_fonts( array $fonts, $expected ) {
+		$font_face       = new WP_Font_Face();
+		$style_element   = "<style id='wp-fonts-local' type='text/css'>\n%s\n</style>\n";
+		$expected_output = sprintf( $style_element, $expected );
+
+		$this->expectOutputString( $expected_output );
+		$font_face->generate_and_print( $fonts );
+	}
+}
diff --git a/tests/fonts/font-face/wpFontFaceResolver/getFontsFromThemeJson.php b/tests/fonts/font-face/wpFontFaceResolver/getFontsFromThemeJson.php
new file mode 100644
index 0000000000..654601363f
--- /dev/null
+++ b/tests/fonts/font-face/wpFontFaceResolver/getFontsFromThemeJson.php
@@ -0,0 +1,203 @@
+<?php
+/**
+ * Test case for WP_Font_Face_Resolver::get_fonts_from_theme_json().
+ *
+ * @package    WordPress
+ * @subpackage Fonts
+ *
+ * @since 6.4.0
+ *
+ * @group fonts
+ * @group fontface
+ *
+ * @covers WP_Font_Face_Resolver::get_fonts_from_theme_json
+ */
+class Tests_Fonts_WPFontFaceResolver_GetFontsFromThemeJson extends WP_Font_Face_UnitTestCase {
+	const FONTS_THEME = 'fonts-block-theme';
+
+	public static function set_up_before_class() {
+		self::$requires_switch_theme_fixtures = true;
+
+		parent::set_up_before_class();
+	}
+
+	public function test_should_return_empty_array_when_no_fonts_defined_in_theme() {
+		switch_theme( 'block-theme' );
+
+		$fonts = WP_Font_Face_Resolver::get_fonts_from_theme_json();
+		$this->assertIsArray( $fonts, 'Should return an array data type' );
+		$this->assertEmpty( $fonts, 'Should return an empty array' );
+	}
+
+	public function test_should_return_all_fonts_from_theme() {
+		switch_theme( static::FONTS_THEME );
+
+		$actual   = WP_Font_Face_Resolver::get_fonts_from_theme_json();
+		$expected = $this->get_expected_fonts_for_fonts_block_theme( 'fonts' );
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @dataProvider data_should_replace_src_file_placeholder
+	 *
+	 * @param string $font_name  Font's name.
+	 * @param string $font_index Font's index in the $fonts array.
+	 * @param string $expected   Expected src.
+	 */
+	public function test_should_replace_src_file_placeholder( $font_name, $font_index, $expected ) {
+		switch_theme( static::FONTS_THEME );
+
+		$fonts = WP_Font_Face_Resolver::get_fonts_from_theme_json();
+
+		$actual   = $fonts[ $font_name ][ $font_index ]['src'][0];
+		$expected = get_stylesheet_directory_uri() . $expected;
+
+		$this->assertStringNotContainsString( 'file:./', $actual, 'Font src should not contain the "file:./" placeholder' );
+		$this->assertSame( $expected, $actual, 'Font src should be an URL to its file' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_replace_src_file_placeholder() {
+		return array(
+			// Theme's theme.json.
+			'DM Sans: 400 normal'              => array(
+				'font_name'  => 'DM Sans',
+				'font_index' => 0,
+				'expected'   => '/assets/fonts/dm-sans/DMSans-Regular.woff2',
+			),
+			'DM Sans: 400 italic'              => array(
+				'font_name'  => 'DM Sans',
+				'font_index' => 1,
+				'expected'   => '/assets/fonts/dm-sans/DMSans-Regular-Italic.woff2',
+			),
+			'DM Sans: 700 normal'              => array(
+				'font_name'  => 'DM Sans',
+				'font_index' => 2,
+				'expected'   => '/assets/fonts/dm-sans/DMSans-Bold.woff2',
+			),
+			'DM Sans: 700 italic'              => array(
+				'font_name'  => 'DM Sans',
+				'font_index' => 3,
+				'expected'   => '/assets/fonts/dm-sans/DMSans-Bold-Italic.woff2',
+			),
+			'Source Serif Pro: 200-900 normal' => array(
+				'font_name'  => 'Source Serif Pro',
+				'font_index' => 0,
+				'expected'   => '/assets/fonts/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2',
+			),
+			'Source Serif Pro: 200-900 italic' => array(
+				'font_name'  => 'Source Serif Pro',
+				'font_index' => 1,
+				'expected'   => '/assets/fonts/source-serif-pro/SourceSerif4Variable-Italic.ttf.woff2',
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_should_get_font_family_name
+	 *
+	 * @param array  $fonts         Fonts to test.
+	 * @param string $expected_name Expected font-family name.
+	 */
+	public function test_should_get_font_family_name( $fonts, $expected_name ) {
+		switch_theme( static::FONTS_THEME );
+
+		$replace_fonts = static function ( $theme_json_data ) use ( $fonts ) {
+			$data = $theme_json_data->get_data();
+
+			// Replace typography.fontFamilies.
+			$data['settings']['typography']['fontFamilies']['theme'] = $fonts;
+
+			return new WP_Theme_JSON_Data( $data );
+		};
+		add_filter( 'wp_theme_json_data_theme', $replace_fonts );
+		$fonts = WP_Font_Face_Resolver::get_fonts_from_theme_json();
+		remove_filter( 'wp_theme_json_data_theme', $replace_fonts );
+
+		$this->assertArrayHasKey( $expected_name, $fonts );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_get_font_family_name() {
+		$font_face = array(
+			array(
+				'fontFamily'  => 'DM Sans',
+				'fontStretch' => 'normal',
+				'fontStyle'   => 'normal',
+				'fontWeight'  => '400',
+				'src'         => array(
+					'file:./assets/fonts/dm-sans/DMSans-Regular.woff2',
+				),
+			),
+			array(
+				'fontFamily'  => 'DM Sans',
+				'fontStretch' => 'normal',
+				'fontStyle'   => 'italic',
+				'fontWeight'  => '400',
+				'src'         => array(
+					'file:./assets/fonts/dm-sans/DMSans-Regular-Italic.woff2',
+				),
+			),
+			array(
+				'fontFamily'  => 'DM Sans',
+				'fontStretch' => 'normal',
+				'fontStyle'   => 'italic',
+				'fontWeight'  => '700',
+				'src'         => array(
+					'file:./assets/fonts/dm-sans/DMSans-Bold.woff2',
+				),
+			),
+			array(
+				'fontFamily'  => 'DM Sans',
+				'fontStretch' => 'normal',
+				'fontStyle'   => 'italic',
+				'fontWeight'  => '700',
+				'src'         => array(
+					'file:./assets/fonts/dm-sans/DMSans-Bold-Italic.woff2',
+				),
+			),
+		);
+
+		return array(
+			'name declared'                   => array(
+				'fonts'         => array(
+					array(
+						'fontFamily' => 'DM Sans',
+						'name'       => 'DM Sans Family',
+						'slug'       => 'dm-sans',
+						'fontFace'   => $font_face,
+					),
+				),
+				'expected_name' => 'DM Sans',
+			),
+			'name not declared'               => array(
+				'fonts'         => array(
+					array(
+						'fontFamily' => 'DM Sans',
+						'slug'       => 'dm-sans',
+						'fontFace'   => $font_face,
+					),
+				),
+				'expected_name' => 'DM Sans',
+			),
+			'fontFamily comma-separated list' => array(
+				'fonts'         => array(
+					array(
+						'fontFamily' => '"DM Sans", sans-serif',
+						'slug'       => 'dm-sans',
+						'fontFace'   => $font_face,
+					),
+				),
+				'expected_name' => 'DM Sans',
+			),
+		);
+	}
+}
diff --git a/tests/fonts/font-face/wpPrintFontFaces.php b/tests/fonts/font-face/wpPrintFontFaces.php
new file mode 100644
index 0000000000..9cc67fb39a
--- /dev/null
+++ b/tests/fonts/font-face/wpPrintFontFaces.php
@@ -0,0 +1,82 @@
+<?php
+/**
+ * Test case for wp_print_font_faces().
+ *
+ * @package    WordPress
+ * @subpackage Fonts
+ *
+ * @since 6.4.0
+ *
+ * @group fonts
+ * @group fontface
+ *
+ * @covers wp_print_font_faces
+ */
+class Tests_Fonts_WpPrintFontFaces extends WP_Font_Face_UnitTestCase {
+	const FONTS_THEME = 'fonts-block-theme';
+
+	public static function set_up_before_class() {
+		self::$requires_switch_theme_fixtures = true;
+
+		parent::set_up_before_class();
+	}
+
+	public function test_should_not_print_when_no_fonts() {
+		switch_theme( 'block-theme' );
+
+		$this->expectOutputString( '' );
+		wp_print_font_faces();
+	}
+
+	/**
+	 * @dataProvider data_should_print_given_fonts
+	 *
+	 * @param array  $fonts    Fonts to process.
+	 * @param string $expected Expected CSS.
+	 */
+	public function test_should_print_given_fonts( array $fonts, $expected ) {
+		$expected_output = $this->get_expected_styles_output( $expected );
+
+		$this->expectOutputString( $expected_output );
+		wp_print_font_faces( $fonts );
+	}
+
+	public function test_should_escape_tags() {
+		$fonts = array(
+			'Source Serif Pro' => array(
+				array(
+					'src'          => array( 'http://example.com/assets/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2' ),
+					'font-family'  => 'Source Serif Pro',
+					'font-style'   => 'normal',
+					'font-weight'  => '200 900',
+					'font-stretch' => '</style><script>console.log("Hello")</script><style>',
+				),
+			),
+		);
+
+		$expected_output = <<<CSS
+<style id='wp-fonts-local' type='text/css'>
+@font-face{font-family:"Source Serif Pro";font-style:normal;font-weight:200 900;font-display:fallback;src:url('http://example.com/assets/source-serif-pro/SourceSerif4Variable-Roman.ttf.woff2') format('woff2');font-stretch:;}
+</style>
+
+CSS;
+		$this->expectOutputString( $expected_output );
+
+		wp_print_font_faces( $fonts );
+	}
+
+	public function test_should_print_fonts_in_merged_data() {
+		switch_theme( static::FONTS_THEME );
+
+		$expected        = $this->get_expected_fonts_for_fonts_block_theme( 'font_face_styles' );
+		$expected_output = $this->get_expected_styles_output( $expected );
+
+		$this->expectOutputString( $expected_output );
+		wp_print_font_faces();
+	}
+
+	private function get_expected_styles_output( $styles ) {
+		$style_element = "<style id='wp-fonts-local' type='text/css'>\n%s\n</style>\n";
+		return sprintf( $style_element, $styles );
+	}
+}
diff --git a/tests/formatting/capitalPDangit.php b/tests/formatting/capitalPDangit.php
index 5dc741d372..850dcdaec9 100644
--- a/tests/formatting/capitalPDangit.php
+++ b/tests/formatting/capitalPDangit.php
@@ -1,5 +1,5 @@
 <?php
-// phpcs:disable WordPress.WP.CapitalPDangit.Misspelled -- 
+// phpcs:disable WordPress.WP.CapitalPDangit.MisspelledInText -- 
 
 /**
  * @group formatting
diff --git a/tests/formatting/ent2ncr.php b/tests/formatting/ent2ncr.php
index ea5e2885bf..db60ba97ff 100644
--- a/tests/formatting/ent2ncr.php
+++ b/tests/formatting/ent2ncr.php
@@ -36,4 +36,3 @@ class Tests_Formatting_Ent2ncr extends WP_UnitTestCase {
 		return $data_provided;
 	}
 }
-
diff --git a/tests/formatting/escUrl.php b/tests/formatting/escUrl.php
index dd37c9ec8d..f23b5269e5 100644
--- a/tests/formatting/escUrl.php
+++ b/tests/formatting/escUrl.php
@@ -151,7 +151,6 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 				)
 			)
 		);
-
 	}
 
 	/**
@@ -276,5 +275,4 @@ EOT;
 		$this->assertSame( '//[::FFFF::127.0.0.1]/?foo%5Bbar%5D=baz', esc_url( '//[::FFFF::127.0.0.1]/?foo[bar]=baz' ) );
 		$this->assertSame( 'http://[::FFFF::127.0.0.1]/?foo%5Bbar%5D=baz', esc_url( 'http://[::FFFF::127.0.0.1]/?foo[bar]=baz' ) );
 	}
-
 }
diff --git a/tests/formatting/excerptRemoveFootnotes.php b/tests/formatting/excerptRemoveFootnotes.php
new file mode 100644
index 0000000000..12ea3acb04
--- /dev/null
+++ b/tests/formatting/excerptRemoveFootnotes.php
@@ -0,0 +1,48 @@
+<?php
+/**
+ * @group formatting
+ * @ticket 58805
+ *
+ * @covers ::excerpt_remove_footnotes
+ */
+
+class Tests_Formatting_ExcerptRemoveFootnotes extends WP_UnitTestCase {
+	/**
+	 * @ticket 58805
+	 *
+	 * @dataProvider data_remove_footnotes
+	 *
+	 * @param string $expected Expected output.
+	 * @param string $content  Content to run strip_shortcodes() on.
+	 */
+	public function test_remove_footnotes( $expected, $content ) {
+		$this->assertSame( $expected, excerpt_remove_footnotes( $content ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_remove_footnotes() {
+		return array(
+			'no footnote'                         => array(
+				'expected' => '<p>This is a paragraph<sup class="fn" id="1"><a href="#1" id="1a">1</a></sup>.</p>',
+				'content'  => '<p>This is a paragraph<sup class="fn" id="1"><a href="#1" id="1a">1</a></sup>.</p>',
+			),
+			'one footnote'                        => array(
+				'expected' => '<p>This is a <a href="https://wordpress.org" data-type="URL" data-id="https://wordpress.org">paragraph</a>.</p>',
+				'content'  => '<p>This is a <a href="https://wordpress.org" data-type="URL" data-id="https://wordpress.org">paragraph</a><sup data-fn="d3b825b6-1890-4cb3-b276-002137515e99" class="fn"><a href="#d3b825b6-1890-4cb3-b276-002137515e99" id="d3b825b6-1890-4cb3-b276-002137515e99-link">1</a></sup>.</p>',
+
+			),
+			'multiple footnotes in block content' => array(
+				'expected' => '<!-- wp:list --><ul><!-- wp:list-item --><li><strong>This</strong><em><strong><sup></sup></strong></em><strong> is a list</strong></li><!-- /wp:list-item --></ul><!-- /wp:list -->',
+				'content'  => '<!-- wp:list --><ul><!-- wp:list-item --><li><strong>This</strong><em><strong><sup><sup data-fn="e2fce624-74a5-4068-a20c-6ef793f1644c" class="fn"><a href="#e2fce624-74a5-4068-a20c-6ef793f1644c" id="e2fce624-74a5-4068-a20c-6ef793f1644c-link">2</a></sup></sup></strong></em><strong> is a list</strong><sup data-fn="ea7e892e-7bc2-424b-936b-36ec64f1c2fc" class="fn"><a href="#ea7e892e-7bc2-424b-936b-36ec64f1c2fc" id="ea7e892e-7bc2-424b-936b-36ec64f1c2fc-link">3</a></sup></li><!-- /wp:list-item --></ul><!-- /wp:list -->',
+			),
+			'footnotes around non-latin script'   => array(
+				'expected' => '<h2 class="wp-block-heading has-background" style="background-color:#f93b3b"></h2>',
+				'content'  => '<h2 class="wp-block-heading has-background" style="background-color:#f93b3b"><sup data-fn="382b3e39-4b0d-4b83-8461-c13f82fdbcfb" class="fn"><a href="#382b3e39-4b0d-4b83-8461-c13f82fdbcfb" id="382b3e39-4b0d-4b83-8461-c13f82fdbcfb-link">1</a></sup><sup data-fn="addb0459-a048-453a-9101-dba64f63a630" class="fn"><a href="#addb0459-a048-453a-9101-dba64f63a630" id="addb0459-a048-453a-9101-dba64f63a630-link">2</a></sup></h2>',
+			),
+		);
+	}
+}
diff --git a/tests/formatting/makeClickable.php b/tests/formatting/makeClickable.php
index 0c6236c859..8620f1efcb 100644
--- a/tests/formatting/makeClickable.php
+++ b/tests/formatting/makeClickable.php
@@ -11,369 +11,420 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 		$this->assertSame( $in, make_clickable( $in ) );
 	}
 
-	public function test_valid_mailto() {
-		$valid_emails = array(
-			'foo@example.com',
-			'foo.bar@example.com',
-			'Foo.Bar@a.b.c.d.example.com',
-			'0@example.com',
-			'foo@example-example.com',
-		);
-		foreach ( $valid_emails as $email ) {
-			$this->assertSame( '<a href="mailto:' . $email . '">' . $email . '</a>', make_clickable( $email ) );
-		}
-	}
-
-	public function test_invalid_mailto() {
-		$invalid_emails = array(
-			'foo',
-			'foo@',
-			'foo@@example.com',
-			'@example.com',
-			'foo @example.com',
-			'foo@example',
-		);
-		foreach ( $invalid_emails as $email ) {
-			$this->assertSame( $email, make_clickable( $email ) );
-		}
-	}
-
 	/**
-	 * Tests that make_clickable() will not link trailing periods, commas,
-	 * and (semi-)colons in URLs with protocol (i.e. http://wordpress.org).
+	 * @dataProvider data_valid_mailto
+	 *
+	 * @param string $email Email to test.
 	 */
-	public function test_strip_trailing_with_protocol() {
-		$urls_before   = array(
-			'http://wordpress.org/hello.html',
-			'There was a spoon named http://wordpress.org. Alice!',
-			'There was a spoon named http://wordpress.org, said Alice.',
-			'There was a spoon named http://wordpress.org; said Alice.',
-			'There was a spoon named http://wordpress.org: said Alice.',
-			'There was a spoon named (http://wordpress.org) said Alice.',
-		);
-		$urls_expected = array(
-			'<a href="http://wordpress.org/hello.html" rel="nofollow">http://wordpress.org/hello.html</a>',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>. Alice!',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>, said Alice.',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>; said Alice.',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>: said Alice.',
-			'There was a spoon named (<a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>) said Alice.',
-		);
-
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
+	public function test_valid_mailto( $email ) {
+		$this->assertSame( '<a href="mailto:' . $email . '">' . $email . '</a>', make_clickable( $email ) );
 	}
 
 	/**
-	 * Tests that make_clickable() will not link trailing periods, commas,
-	 * and (semi-)colons in URLs with protocol (i.e. http://wordpress.org).
+	 * Data provider.
+	 *
+	 * @return array
 	 */
-	public function test_strip_trailing_with_protocol_nothing_afterwards() {
-		$urls_before   = array(
-			'http://wordpress.org/hello.html',
-			'There was a spoon named http://wordpress.org.',
-			'There was a spoon named http://wordpress.org,',
-			'There was a spoon named http://wordpress.org;',
-			'There was a spoon named http://wordpress.org:',
-			'There was a spoon named (http://wordpress.org)',
-			'There was a spoon named (http://wordpress.org)x',
-		);
-		$urls_expected = array(
-			'<a href="http://wordpress.org/hello.html" rel="nofollow">http://wordpress.org/hello.html</a>',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>.',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>,',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>;',
-			'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>:',
-			'There was a spoon named (<a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>)',
-			'There was a spoon named (<a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>)x',
+	public function data_valid_mailto() {
+		return array(
+			array( 'foo@example.com' ),
+			array( 'foo.bar@example.com' ),
+			array( 'Foo.Bar@a.b.c.d.example.com' ),
+			array( '0@example.com' ),
+			array( 'foo@example-example.com' ),
 		);
-
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
 	}
 
 	/**
-	 * Tests that make_clickable() will not link trailing periods, commas,
-	 * and (semi-)colons in URLs without protocol (i.e. www.wordpress.org).
+	 * @dataProvider data_invalid_mailto
+	 *
+	 * @param string $email Email to test.
 	 */
-	public function test_strip_trailing_without_protocol() {
-		$urls_before   = array(
-			'www.wordpress.org',
-			'There was a spoon named www.wordpress.org. Alice!',
-			'There was a spoon named www.wordpress.org, said Alice.',
-			'There was a spoon named www.wordpress.org; said Alice.',
-			'There was a spoon named www.wordpress.org: said Alice.',
-			'There was a spoon named www.wordpress.org) said Alice.',
-		);
-		$urls_expected = array(
-			'<a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>. Alice!',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>, said Alice.',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>; said Alice.',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>: said Alice.',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>) said Alice.',
-		);
-
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
+	public function test_invalid_mailto( $email ) {
+		$this->assertSame( $email, make_clickable( $email ) );
 	}
 
 	/**
-	 * Tests that make_clickable() will not link trailing periods, commas,
-	 * and (semi-)colons in URLs without protocol (i.e. www.wordpress.org).
+	 * Data provider.
+	 *
+	 * @return array
 	 */
-	public function test_strip_trailing_without_protocol_nothing_afterwards() {
-		$urls_before   = array(
-			'www.wordpress.org',
-			'There was a spoon named www.wordpress.org.',
-			'There was a spoon named www.wordpress.org,',
-			'There was a spoon named www.wordpress.org;',
-			'There was a spoon named www.wordpress.org:',
-			'There was a spoon named www.wordpress.org)',
-		);
-		$urls_expected = array(
-			'<a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>.',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>,',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>;',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>:',
-			'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>)',
+	public function data_invalid_mailto() {
+		return array(
+			array( 'foo' ),
+			array( 'foo@' ),
+			array( 'foo@@example.com' ),
+			array( '@example.com' ),
+			array( 'foo @example.com' ),
+			array( 'foo@example' ),
 		);
-
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
 	}
 
 	/**
 	 * @ticket 4570
-	 */
-	public function test_iri() {
-		$urls_before   = array(
-			'http://www..com/',
-			'http://bg.wikipedia.org/',
-			'http://example.com/?a=&b=',
-		);
-		$urls_expected = array(
-			'<a href="http://www..com/" rel="nofollow">http://www..com/</a>',
-			'<a href="http://bg.wikipedia.org/" rel="nofollow">http://bg.wikipedia.org/</a>',
-			'<a href="http://example.com/?a=&#038;b=" rel="nofollow">http://example.com/?a=&#038;b=</a>',
-		);
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
-	}
-
-	/**
 	 * @ticket 10990
+	 * @ticket 11211
+	 * @ticket 14993
+	 * @ticket 16892
+	 *
+	 * @dataProvider data_urls
+	 *
+	 * @param string $text     Content to test.
+	 * @param string $expected Expected results.
 	 */
-	public function test_brackets_in_urls() {
-		$urls_before   = array(
-			'http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)',
-			'(http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software))',
-			'blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software) blah',
-			'blah (http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)) blah',
-			'blah blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software) blah blah',
-			'blah blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)) blah blah',
-			'blah blah (http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)) blah blah',
-			'blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software).) blah blah',
-			'blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software).)moreurl blah blah',
-			'In his famous speech You and Your research (here:
-			http://www.cs.virginia.edu/~robins/YouAndYourResearch.html)
-			Richard Hamming wrote about people getting more done with their doors closed, but',
-		);
-		$urls_expected = array(
-			'<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>',
-			'(<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>)',
-			'blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a> blah',
-			'blah (<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>) blah',
-			'blah blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a> blah blah',
-			'blah blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>) blah blah',
-			'blah blah (<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>) blah blah',
-			'blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>.) blah blah',
-			'blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>.)moreurl blah blah',
-			'In his famous speech You and Your research (here:
-			<a href="http://www.cs.virginia.edu/~robins/YouAndYourResearch.html" rel="nofollow">http://www.cs.virginia.edu/~robins/YouAndYourResearch.html</a>)
-			Richard Hamming wrote about people getting more done with their doors closed, but',
-		);
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
+	public function test_urls( $text, $expected ) {
+		$this->assertSame( $expected, make_clickable( $text ) );
 	}
 
 	/**
-	 * Based on real comments which were incorrectly linked.
+	 * Data provider.
 	 *
-	 * @ticket 11211
+	 * @return array
 	 */
-	public function test_real_world_examples() {
-		$urls_before   = array(
-			'Example: WordPress, test (some text), I love example.com (http://example.org), it is brilliant',
-			'Example: WordPress, test (some text), I love example.com (http://example.com), it is brilliant',
-			'Some text followed by a bracketed link with a trailing elipsis (http://example.com)...',
-			'In his famous speech You and Your research (here: http://www.cs.virginia.edu/~robins/YouAndYourResearch.html) Richard Hamming wrote about people getting more done with their doors closed...',
-		);
-		$urls_expected = array(
-			'Example: WordPress, test (some text), I love example.com (<a href="http://example.org">http://example.org</a>), it is brilliant',
-			'Example: WordPress, test (some text), I love example.com (<a href="http://example.com" rel="nofollow">http://example.com</a>), it is brilliant',
-			'Some text followed by a bracketed link with a trailing elipsis (<a href="http://example.com" rel="nofollow">http://example.com</a>)...',
-			'In his famous speech You and Your research (here: <a href="http://www.cs.virginia.edu/~robins/YouAndYourResearch.html" rel="nofollow">http://www.cs.virginia.edu/~robins/YouAndYourResearch.html</a>) Richard Hamming wrote about people getting more done with their doors closed...',
-		);
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
-	}
+	public function data_urls() {
+		return array(
+			// Does not link trailing periods, commas, and (semi-)colons in URLs with protocol (i.e. http://wordpress.org).
+			'URL only'                                   => array(
+				'text'     => 'http://wordpress.org/hello.html',
+				'expected' => '<a href="http://wordpress.org/hello.html" rel="nofollow">http://wordpress.org/hello.html</a>',
+			),
+			'URL. with more content after'               => array(
+				'text'     => 'There was a spoon named http://wordpress.org. Alice!',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>. Alice!',
+			),
+			'URL, with more content after'               => array(
+				'text'     => 'There was a spoon named http://wordpress.org, said Alice.',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>, said Alice.',
+			),
+			'URL; with more content after'               => array(
+				'text'     => 'There was a spoon named http://wordpress.org; said Alice.',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>; said Alice.',
+			),
+			'URL: with more content after'               => array(
+				'text'     => 'There was a spoon named http://wordpress.org: said Alice.',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>: said Alice.',
+			),
+			'URL) with more content after'               => array(
+				'text'     => 'There was a spoon named (http://wordpress.org) said Alice.',
+				'expected' => 'There was a spoon named (<a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>) said Alice.',
+			),
 
-	/**
-	 * @ticket 14993
-	 */
-	public function test_twitter_hash_bang() {
-		$urls_before   = array(
-			'http://twitter.com/#!/wordpress/status/25907440233',
-			'This is a really good tweet http://twitter.com/#!/wordpress/status/25907440233 !',
-			'This is a really good tweet http://twitter.com/#!/wordpress/status/25907440233!',
-		);
-		$urls_expected = array(
-			'<a href="http://twitter.com/#!/wordpress/status/25907440233" rel="nofollow">http://twitter.com/#!/wordpress/status/25907440233</a>',
-			'This is a really good tweet <a href="http://twitter.com/#!/wordpress/status/25907440233" rel="nofollow">http://twitter.com/#!/wordpress/status/25907440233</a> !',
-			'This is a really good tweet <a href="http://twitter.com/#!/wordpress/status/25907440233" rel="nofollow">http://twitter.com/#!/wordpress/status/25907440233</a>!',
-		);
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
-	}
+			// Does not link trailing periods, commas, and (semi-)colons in URLs with protocol (i.e. http://wordpress.org) with nothing afterwards.
+			'URL.'                                       => array(
+				'text'     => 'There was a spoon named http://wordpress.org.',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>.',
+			),
+			'URL,'                                       => array(
+				'text'     => 'There was a spoon named http://wordpress.org,',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>,',
+			),
+			'URL;'                                       => array(
+				'text'     => 'There was a spoon named http://wordpress.org;',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>;',
+			),
+			'URL:'                                       => array(
+				'text'     => 'There was a spoon named http://wordpress.org:',
+				'expected' => 'There was a spoon named <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>:',
+			),
+			'URL)'                                       => array(
+				'text'     => 'There was a spoon named (http://wordpress.org)',
+				'expected' => 'There was a spoon named (<a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>)',
+			),
+			'URL)x'                                      => array(
+				'text'     => 'There was a spoon named (http://wordpress.org)x',
+				'expected' => 'There was a spoon named (<a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>)x',
+			),
 
-	public function test_wrapped_in_angles() {
-		$before   = array(
-			'URL wrapped in angle brackets <http://example.com/>',
-			'URL wrapped in angle brackets with padding < http://example.com/ >',
-			'mailto wrapped in angle brackets <foo@example.com>',
-		);
-		$expected = array(
-			'URL wrapped in angle brackets <<a href="http://example.com/" rel="nofollow">http://example.com/</a>>',
-			'URL wrapped in angle brackets with padding < <a href="http://example.com/" rel="nofollow">http://example.com/</a> >',
-			'mailto wrapped in angle brackets <foo@example.com>',
-		);
-		foreach ( $before as $key => $url ) {
-			$this->assertSame( $expected[ $key ], make_clickable( $url ) );
-		}
-	}
+			// Strip trailing without protocol: will not link trailing periods, commas, and (semi-)colons in URLs without protocol (i.e. www.wordpress.org).
+			'No protocol www.URL. with content after'    => array(
+				'text'     => 'There was a spoon named www.wordpress.org. Alice!',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>. Alice!',
+			),
+			'No protocol www.URL, with content after'    => array(
+				'text'     => 'There was a spoon named www.wordpress.org, said Alice.',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>, said Alice.',
+			),
+			'No protocol www.URL; with content after'    => array(
+				'text'     => 'There was a spoon named www.wordpress.org; said Alice.',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>; said Alice.',
+			),
+			'No protocol www.URL: with content after'    => array(
+				'text'     => 'There was a spoon named www.wordpress.org: said Alice.',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>: said Alice.',
+			),
+			'No protocol www.URL) with content after'    => array(
+				'text'     => 'There was a spoon named www.wordpress.org) said Alice.',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>) said Alice.',
+			),
 
-	public function test_preceded_by_punctuation() {
-		$before   = array(
-			'Comma then URL,http://example.com/',
-			'Period then URL.http://example.com/',
-			'Semi-colon then URL;http://example.com/',
-			'Colon then URL:http://example.com/',
-			'Exclamation mark then URL!http://example.com/',
-			'Question mark then URL?http://example.com/',
-		);
-		$expected = array(
-			'Comma then URL,<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
-			'Period then URL.<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
-			'Semi-colon then URL;<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
-			'Colon then URL:<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
-			'Exclamation mark then URL!<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
-			'Question mark then URL?<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
-		);
-		foreach ( $before as $key => $url ) {
-			$this->assertSame( $expected[ $key ], make_clickable( $url ) );
-		}
-	}
+			// Should not link trailing periods, commas, and (semi-)colons in URLs without protocol (i.e. www.wordpress.org).
+			'No protocol www.URL'                        => array(
+				'text'     => 'www.wordpress.org',
+				'expected' => '<a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>',
+			),
+			'No protocol www.URL.'                       => array(
+				'text'     => 'There was a spoon named www.wordpress.org.',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>.',
+			),
+			'No protocol www.URL,'                       => array(
+				'text'     => 'There was a spoon named www.wordpress.org,',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>,',
+			),
+			'No protocol www.URL;'                       => array(
+				'text'     => 'There was a spoon named www.wordpress.org;',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>;',
+			),
+			'No protocol www.URL:'                       => array(
+				'text'     => 'There was a spoon named www.wordpress.org:',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>:',
+			),
+			'No protocol www.URL)'                       => array(
+				'text'     => 'There was a spoon named www.wordpress.org)',
+				'expected' => 'There was a spoon named <a href="http://www.wordpress.org" rel="nofollow">http://www.wordpress.org</a>)',
+			),
 
-	public function test_dont_break_attributes() {
-		$urls_before   = array(
-			"<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>",
-			"(<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
-			"http://trunk.domain/testing#something (<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
-			"http://trunk.domain/testing#something
-			(<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
-			"<span style='text-align:center; display: block;'><object width='425' height='350'><param name='movie' value='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' /> <param name='allowfullscreen' value='true' /> <param name='wmode' value='opaque' /> <embed src='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' type='application/x-shockwave-flash' allowfullscreen='true' width='425' height='350' wmode='opaque'></embed> </object></span>",
-			'<a href="http://example.com/example.gif" title="Image from http://example.com">Look at this image!</a>',
-		);
-		$urls_expected = array(
-			"<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>",
-			"(<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
-			"<a href=\"http://trunk.domain/testing#something\" rel=\"nofollow\">http://trunk.domain/testing#something</a> (<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
-			"<a href=\"http://trunk.domain/testing#something\" rel=\"nofollow\">http://trunk.domain/testing#something</a>
-			(<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
-			"<span style='text-align:center; display: block;'><object width='425' height='350'><param name='movie' value='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' /> <param name='allowfullscreen' value='true' /> <param name='wmode' value='opaque' /> <embed src='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' type='application/x-shockwave-flash' allowfullscreen='true' width='425' height='350' wmode='opaque'></embed> </object></span>",
-			'<a href="http://example.com/example.gif" title="Image from http://example.com">Look at this image!</a>',
-		);
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
-	}
+			// @ticket 4570
+			// Test IRI.
+			'IRI in domain'                              => array(
+				'text'     => 'http://www..com/',
+				'expected' => '<a href="http://www..com/" rel="nofollow">http://www..com/</a>',
+			),
+			'IRI in path'                                => array(
+				'text'     => 'http://bg.wikipedia.org/',
+				'expected' => '<a href="http://bg.wikipedia.org/" rel="nofollow">http://bg.wikipedia.org/</a>',
+			),
+			'IRI in query string'                        => array(
+				'text'     => 'http://example.com/?a=&b=',
+				'expected' => '<a href="http://example.com/?a=&#038;b=" rel="nofollow">http://example.com/?a=&#038;b=</a>',
+			),
 
-	/**
-	 * @ticket 23756
-	 */
-	public function test_no_links_inside_pre_or_code() {
-		$before = array(
-			'<pre>http://wordpress.org</pre>',
-			'<code>http://wordpress.org</code>',
-			'<pre class="foobar" id="foo">http://wordpress.org</pre>',
-			'<code class="foobar" id="foo">http://wordpress.org</code>',
-			'<precustomtag>http://wordpress.org</precustomtag>',
-			'<codecustomtag>http://wordpress.org</codecustomtag>',
-			'URL before pre http://wordpress.org<pre>http://wordpress.org</pre>',
-			'URL before code http://wordpress.org<code>http://wordpress.org</code>',
-			'URL after pre <PRE>http://wordpress.org</PRE>http://wordpress.org',
-			'URL after code <code>http://wordpress.org</code>http://wordpress.org',
-			'URL before and after pre http://wordpress.org<pre>http://wordpress.org</pre>http://wordpress.org',
-			'URL before and after code http://wordpress.org<code>http://wordpress.org</code>http://wordpress.org',
-			'code inside pre <pre>http://wordpress.org <code>http://wordpress.org</code> http://wordpress.org</pre>',
-		);
+			// @ticket 10990
+			// Test URLS with brackets (within the URL).
+			'URL with brackets in path'                  => array(
+				'text'     => 'http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)',
+				'expected' => '<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>',
+			),
+			'(URL with brackets in path)'                => array(
+				'text'     => '(http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software))',
+				'expected' => '(<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>)',
+			),
+			'URL with brackets in path: word before and after' => array(
+				'text'     => 'blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software) blah',
+				'expected' => 'blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a> blah',
+			),
+			'URL with brackets in path: trailing ) blah' => array(
+				'text'     => 'blah (http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)) blah',
+				'expected' => 'blah (<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>) blah',
+			),
+			'URL with brackets in path: within content'  => array(
+				'text'     => 'blah blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software) blah blah',
+				'expected' => 'blah blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a> blah blah',
+			),
+			'URL with brackets in path: trailing ) within content' => array(
+				'text'     => 'blah blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)) blah blah',
+				'expected' => 'blah blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>) blah blah',
+			),
+			'(URL with brackets in path) within content' => array(
+				'text'     => 'blah blah (http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)) blah blah',
+				'expected' => 'blah blah (<a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>) blah blah',
+			),
+			'URL with brackets in path: trailing .)'     => array(
+				'text'     => 'blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software).) blah blah',
+				'expected' => 'blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>.) blah blah',
+			),
+			'URL with brackets in path: trailing .)moreurl' => array(
+				'text'     => 'blah blah http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software).)moreurl blah blah',
+				'expected' => 'blah blah <a href="http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)" rel="nofollow">http://en.wikipedia.org/wiki/PC_Tools_(Central_Point_Software)</a>.)moreurl blah blah',
+			),
+			'multiline content with URL with brackets in path' => array(
+				'text'     => 'In his famous speech You and Your research (here:
+							   http://www.cs.virginia.edu/~robins/YouAndYourResearch.html)
+							   Richard Hamming wrote about people getting more done with their doors closed, but',
+				'expected' => 'In his famous speech You and Your research (here:
+							   <a href="http://www.cs.virginia.edu/~robins/YouAndYourResearch.html" rel="nofollow">http://www.cs.virginia.edu/~robins/YouAndYourResearch.html</a>)
+							   Richard Hamming wrote about people getting more done with their doors closed, but',
+			),
 
-		$expected = array(
-			'<pre>http://wordpress.org</pre>',
-			'<code>http://wordpress.org</code>',
-			'<pre class="foobar" id="foo">http://wordpress.org</pre>',
-			'<code class="foobar" id="foo">http://wordpress.org</code>',
-			'<precustomtag><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a></precustomtag>',
-			'<codecustomtag><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a></codecustomtag>',
-			'URL before pre <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><pre>http://wordpress.org</pre>',
-			'URL before code <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><code>http://wordpress.org</code>',
-			'URL after pre <PRE>http://wordpress.org</PRE><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
-			'URL after code <code>http://wordpress.org</code><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
-			'URL before and after pre <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><pre>http://wordpress.org</pre><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
-			'URL before and after code <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><code>http://wordpress.org</code><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
-			'code inside pre <pre>http://wordpress.org <code>http://wordpress.org</code> http://wordpress.org</pre>',
-		);
+			// @ticket 11211
+			// Test with real comments which were incorrectly linked.
+			'real world: example.com text (.org URL)'    => array(
+				'text'     => 'Example: WordPress, test (some text), I love example.com (http://example.org), it is brilliant',
+				'expected' => 'Example: WordPress, test (some text), I love example.com (<a href="http://example.org">http://example.org</a>), it is brilliant',
+			),
+			'real world: example.com text (.com URL)'    => array(
+				'text'     => 'Example: WordPress, test (some text), I love example.com (http://example.com), it is brilliant',
+				'expected' => 'Example: WordPress, test (some text), I love example.com (<a href="http://example.com" rel="nofollow">http://example.com</a>), it is brilliant',
+			),
+			'real world: (URL)...'                       => array(
+				'text'     => 'Some text followed by a bracketed link with a trailing elipsis (http://example.com)...',
+				'expected' => 'Some text followed by a bracketed link with a trailing elipsis (<a href="http://example.com" rel="nofollow">http://example.com</a>)...',
+			),
+			'real world: (here: URL)'                    => array(
+				'text'     => 'In his famous speech You and Your research (here: http://www.cs.virginia.edu/~robins/YouAndYourResearch.html) Richard Hamming wrote about people getting more done with their doors closed...',
+				'expected' => 'In his famous speech You and Your research (here: <a href="http://www.cs.virginia.edu/~robins/YouAndYourResearch.html" rel="nofollow">http://www.cs.virginia.edu/~robins/YouAndYourResearch.html</a>) Richard Hamming wrote about people getting more done with their doors closed...',
+			),
 
-		foreach ( $before as $key => $url ) {
-			$this->assertSame( $expected[ $key ], make_clickable( $url ) );
-		}
-	}
+			// @ticket 14993
+			// Test Twitter hash bang URL.
+			'Twitter hash bang URL'                      => array(
+				'text'     => 'http://twitter.com/#!/wordpress/status/25907440233',
+				'expected' => '<a href="http://twitter.com/#!/wordpress/status/25907440233" rel="nofollow">http://twitter.com/#!/wordpress/status/25907440233</a>',
+			),
+			'Twitter hash bang URL in sentence'          => array(
+				'text'     => 'This is a really good tweet http://twitter.com/#!/wordpress/status/25907440233 !',
+				'expected' => 'This is a really good tweet <a href="http://twitter.com/#!/wordpress/status/25907440233" rel="nofollow">http://twitter.com/#!/wordpress/status/25907440233</a> !',
+			),
+			'Twitter hash bang in sentence with trailing !' => array(
+				'text'     => 'This is a really good tweet http://twitter.com/#!/wordpress/status/25907440233!',
+				'expected' => 'This is a really good tweet <a href="http://twitter.com/#!/wordpress/status/25907440233" rel="nofollow">http://twitter.com/#!/wordpress/status/25907440233</a>!',
+			),
 
-	/**
-	 * @ticket 16892
-	 */
-	public function test_click_inside_html() {
-		$urls_before   = array(
-			'<span>http://example.com</span>',
-			'<p>http://example.com/</p>',
-		);
-		$urls_expected = array(
-			'<span><a href="http://example.com" rel="nofollow">http://example.com</a></span>',
-			'<p><a href="http://example.com/" rel="nofollow">http://example.com/</a></p>',
-		);
-		foreach ( $urls_before as $key => $url ) {
-			$this->assertSame( $urls_expected[ $key ], make_clickable( $url ) );
-		}
-	}
+			// Test URLs wrapped in angled brackets, i.e. < >.
+			'<URL>'                                      => array(
+				'text'     => 'URL wrapped in angle brackets <http://example.com/>',
+				'expected' => 'URL wrapped in angle brackets <<a href="http://example.com/" rel="nofollow">http://example.com/</a>>',
+			),
+			'< URL >'                                    => array(
+				'text'     => 'URL wrapped in angle brackets with padding < http://example.com/ >',
+				'expected' => 'URL wrapped in angle brackets with padding < <a href="http://example.com/" rel="nofollow">http://example.com/</a> >',
+			),
+			'<email>'                                    => array(
+				'text'     => 'mailto wrapped in angle brackets <foo@example.com>',
+				'expected' => 'mailto wrapped in angle brackets <foo@example.com>',
+			),
+
+			// Test URLs preceded by punctuation.
+			',URL'                                       => array(
+				'text'     => 'Comma then URL,http://example.com/',
+				'expected' => 'Comma then URL,<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
+			),
+			'.URL'                                       => array(
+				'text'     => 'Period then URL.http://example.com/',
+				'expected' => 'Period then URL.<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
+			),
+			';URL'                                       => array(
+				'text'     => 'Semi-colon then URL;http://example.com/',
+				'expected' => 'Semi-colon then URL;<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
+			),
+			':URL'                                       => array(
+				'text'     => 'Colon then URL:http://example.com/',
+				'expected' => 'Colon then URL:<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
+			),
+			'!URL'                                       => array(
+				'text'     => 'Exclamation mark then URL!http://example.com/',
+				'expected' => 'Exclamation mark then URL!<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
+			),
+			'?URL'                                       => array(
+				'text'     => 'Question mark then URL?http://example.com/',
+				'expected' => 'Question mark then URL?<a href="http://example.com/" rel="nofollow">http://example.com/</a>',
+			),
+
+			// Test it doesn't break tag attributes.
+			'<img src=URL with attributes>'              => array(
+				'text'     => "<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>",
+				'expected' => "<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>",
+			),
+			'(<img src=URL with attributes>)'            => array(
+				'text'     => "(<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
+				'expected' => "(<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
+			),
+			'URL (<img src=URL with attributes>)'        => array(
+				'text'     => "http://trunk.domain/testing#something (<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
+				'expected' => "<a href=\"http://trunk.domain/testing#something\" rel=\"nofollow\">http://trunk.domain/testing#something</a> (<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
+			),
+			'multiline URL (<img src=URL with attributes>)' => array(
+				'text'     => "http://trunk.domain/testing#something
+						  (<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
+				'expected' => "<a href=\"http://trunk.domain/testing#something\" rel=\"nofollow\">http://trunk.domain/testing#something</a>
+						  (<img src='http://trunk.domain/wp-includes/images/smilies/icon_smile.gif' alt=':)' class='wp-smiley'>)",
+			),
+			'<param value=URL><embed src=URL>'           => array(
+				'text'     => "<span style='text-align:center; display: block;'><object width='425' height='350'><param name='movie' value='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' /> <param name='allowfullscreen' value='true' /> <param name='wmode' value='opaque' /> <embed src='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' type='application/x-shockwave-flash' allowfullscreen='true' width='425' height='350' wmode='opaque'></embed> </object></span>",
+				'expected' => "<span style='text-align:center; display: block;'><object width='425' height='350'><param name='movie' value='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' /> <param name='allowfullscreen' value='true' /> <param name='wmode' value='opaque' /> <embed src='https://www.youtube.com/watch?v=72xdCU__XCk&rel=1&fs=1&showsearch=0&showinfo=1&iv_load_policy=1' type='application/x-shockwave-flash' allowfullscreen='true' width='425' height='350' wmode='opaque'></embed> </object></span>",
+			),
+			'<a src=URL title=URL></a>'                  => array(
+				'text'     => '<a href="http://example.com/example.gif" title="Image from http://example.com">Look at this image!</a>',
+				'expected' => '<a href="http://example.com/example.gif" title="Image from http://example.com">Look at this image!</a>',
+			),
+
+			// Test doesn't add links within <pre> or <code> elements.
+			'Does not add link within <pre>'             => array(
+				'text'     => '<pre>http://wordpress.org</pre>',
+				'expected' => '<pre>http://wordpress.org</pre>',
+			),
+			'Does not add link within <code>'            => array(
+				'text'     => '<code>http://wordpress.org</code>',
+				'expected' => '<code>http://wordpress.org</code>',
+			),
+			'Does not add link within <pre with attributes>' => array(
+				'text'     => '<pre class="foobar" id="foo">http://wordpress.org</pre>',
+				'expected' => '<pre class="foobar" id="foo">http://wordpress.org</pre>',
+			),
+			'Does not add link within <code with attributes>' => array(
+				'text'     => '<code class="foobar" id="foo">http://wordpress.org</code>',
+				'expected' => '<code class="foobar" id="foo">http://wordpress.org</code>',
+			),
+			'Adds link within <precustomtag>'            => array(
+				'text'     => '<precustomtag>http://wordpress.org</precustomtag>',
+				'expected' => '<precustomtag><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a></precustomtag>',
+			),
+			'Adds link within <codecustomtag>'           => array(
+				'text'     => '<codecustomtag>http://wordpress.org</codecustomtag>',
+				'expected' => '<codecustomtag><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a></codecustomtag>',
+			),
+			'Adds link to URL before <pre>, but does not add link within <pre>' => array(
+				'text'     => 'URL before pre http://wordpress.org<pre>http://wordpress.org</pre>',
+				'expected' => 'URL before pre <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><pre>http://wordpress.org</pre>',
+			),
+			'Adds link to URL before <code>, but does not add link within <code>' => array(
+				'text'     => 'URL before code http://wordpress.org<code>http://wordpress.org</code>',
+				'expected' => 'URL before code <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><code>http://wordpress.org</code>',
+			),
+			'Does not add link to <PRE>, but does add link to URL after <PRE>' => array(
+				'text'     => 'URL after pre <PRE>http://wordpress.org</PRE>http://wordpress.org',
+				'expected' => 'URL after pre <PRE>http://wordpress.org</PRE><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
+			),
+			'Does not add link within <code>, but does add link to URL after <code>' => array(
+				'text'     => 'URL after code <code>http://wordpress.org</code>http://wordpress.org',
+				'expected' => 'URL after code <code>http://wordpress.org</code><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
+			),
+			'Adds link to before and after URLs, but does not add link within <pre>' => array(
+				'text'     => 'URL before and after pre http://wordpress.org<pre>http://wordpress.org</pre>http://wordpress.org',
+				'expected' => 'URL before and after pre <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><pre>http://wordpress.org</pre><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
+			),
+			'Adds link to before and after URLs, but does not add link within <code>' => array(
+				'text'     => 'URL before and after code http://wordpress.org<code>http://wordpress.org</code>http://wordpress.org',
+				'expected' => 'URL before and after code <a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a><code>http://wordpress.org</code><a href="http://wordpress.org" rel="nofollow">http://wordpress.org</a>',
+			),
+			'Does not add links within nested <pre>URL <code>URL</code> </pre>' => array(
+				'text'     => 'code inside pre <pre>http://wordpress.org <code>http://wordpress.org</code> http://wordpress.org</pre>',
+				'expected' => 'code inside pre <pre>http://wordpress.org <code>http://wordpress.org</code> http://wordpress.org</pre>',
+			),
 
-	public function test_no_links_within_links() {
-		$in = array(
-			'Some text with a link <a href="http://example.com">http://example.com</a>',
-			// '<a href="http://wordpress.org">This is already a link www.wordpress.org</a>', // Fails in 3.3.1 too.
+			// @ticket 16892
+			// Test adds link inside of HTML elements.
+			'<span>URL</span>'                           => array(
+				'text'     => '<span>http://example.com</span>',
+				'expected' => '<span><a href="http://example.com" rel="nofollow">http://example.com</a></span>',
+			),
+			'<p>URL</p>'                                 => array(
+				'text'     => '<p>http://example.com/</p>',
+				'expected' => '<p><a href="http://example.com/" rel="nofollow">http://example.com/</a></p>',
+			),
+
+			// Test does not add links within the <a> element.
+			'<a>URL</a>'                                 => array(
+				'text'     => 'Some text with a link <a href="http://example.com">http://example.com</a>',
+				'expected' => 'Some text with a link <a href="http://example.com">http://example.com</a>',
+			),
+			/*
+			Fails in 3.3.1 too.
+			'<a>text www.URL</a>'                        => array(
+				'text'     => '<a href="http://wordpress.org">This is already a link www.wordpress.org</a>',
+				'expected' => '<a href="http://wordpress.org">This is already a link www.wordpress.org</a>',
+			),
+			*/
 		);
-		foreach ( $in as $text ) {
-			$this->assertSame( $text, make_clickable( $text ) );
-		}
 	}
 
 	/**
@@ -467,5 +518,4 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/formatting/mapDeep.php b/tests/formatting/mapDeep.php
index 0b60ae99bf..0d46ea8523 100644
--- a/tests/formatting/mapDeep.php
+++ b/tests/formatting/mapDeep.php
@@ -171,5 +171,4 @@ class Tests_Formatting_MapDeep extends WP_UnitTestCase {
 	public function append_baba( $value ) {
 		return $value . 'baba';
 	}
-
 }
diff --git a/tests/formatting/sanitizeLocaleName.php b/tests/formatting/sanitizeLocaleName.php
new file mode 100644
index 0000000000..cd22acbf2c
--- /dev/null
+++ b/tests/formatting/sanitizeLocaleName.php
@@ -0,0 +1,49 @@
+<?php
+
+/**
+ * @group formatting
+ *
+ * @covers ::sanitize_locale_name
+ */
+class Tests_Formatting_SanitizeLocaleName extends WP_UnitTestCase {
+	/**
+	 * @dataProvider data_sanitize_locale_name_returns_non_empty_string
+	 */
+	public function test_sanitize_locale_name_returns_non_empty_string( $expected, $input ) {
+		$this->assertSame( $expected, sanitize_locale_name( $input ) );
+	}
+
+	public function data_sanitize_locale_name_returns_non_empty_string() {
+		return array(
+			// array( expected, input )
+			array( 'en_US', 'en_US' ),
+			array( 'en', 'en' ),
+			array( 'fr_FR', 'fr_FR' ),
+			array( 'fr_FR', 'fr_FR' ),
+			array( 'fr_FR-e2791ba830489d23043be8650a22a22b', 'fr_FR-e2791ba830489d23043be8650a22a22b' ),
+			array( '-fr_FRmo', '-fr_FR.mo' ),
+			array( '12324', '$12324' ),
+			array( '4124FRRa', '/4124$$$%%FRRa' ),
+			array( 'FR', '<FR' ),
+			array( 'FR_FR', 'FR_FR' ),
+			array( '--__', '--__' ),
+		);
+	}
+
+	/**
+	 * @dataProvider data_sanitize_locale_name_returns_empty_string
+	 */
+	public function test_sanitize_locale_name_returns_empty_string( $input ) {
+		$this->assertSame( '', sanitize_locale_name( $input ) );
+	}
+
+	public function data_sanitize_locale_name_returns_empty_string() {
+		return array(
+			// array( input )
+			array( '$<>' ),
+			array( '/$$$%%\\)' ),
+			array( '....' ),
+			array( '@///' ),
+		);
+	}
+}
diff --git a/tests/formatting/sanitizeTextField.php b/tests/formatting/sanitizeTextField.php
index 2d184ebb13..d7a58486d1 100644
--- a/tests/formatting/sanitizeTextField.php
+++ b/tests/formatting/sanitizeTextField.php
@@ -22,7 +22,6 @@ class Tests_Formatting_SanitizeTextField extends WP_UnitTestCase {
 		}
 		$this->assertSame( $expected_oneline, sanitize_text_field( $str ) );
 		$this->assertSameIgnoreEOL( $expected_multiline, sanitize_textarea_field( $str ) );
-
 	}
 
 	public function data_sanitize_text_field() {
diff --git a/tests/formatting/seemsUtf8.php b/tests/formatting/seemsUtf8.php
index b6a67950e9..97ec6ff0c9 100644
--- a/tests/formatting/seemsUtf8.php
+++ b/tests/formatting/seemsUtf8.php
@@ -43,4 +43,3 @@ class Tests_Formatting_SeemsUtf8 extends WP_UnitTestCase {
 		return $big5_strings;
 	}
 }
-
diff --git a/tests/formatting/urlencodeDeep.php b/tests/formatting/urlencodeDeep.php
index 632f4083c0..9436ba09af 100644
--- a/tests/formatting/urlencodeDeep.php
+++ b/tests/formatting/urlencodeDeep.php
@@ -44,5 +44,4 @@ class Tests_Formatting_UrlencodeDeep extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, urlencode_deep( $actual ) );
 	}
-
 }
diff --git a/tests/formatting/utf8UriEncode.php b/tests/formatting/utf8UriEncode.php
index e82e973e29..45d370d1da 100644
--- a/tests/formatting/utf8UriEncode.php
+++ b/tests/formatting/utf8UriEncode.php
@@ -35,4 +35,3 @@ class Tests_Formatting_Utf8UriEncode extends WP_UnitTestCase {
 		return $data_provided;
 	}
 }
-
diff --git a/tests/formatting/wpMakeLinkRelative.php b/tests/formatting/wpMakeLinkRelative.php
index 0b293c9c89..4c21381a42 100644
--- a/tests/formatting/wpMakeLinkRelative.php
+++ b/tests/formatting/wpMakeLinkRelative.php
@@ -45,5 +45,4 @@ class Tests_Formatting_wpMakeLinkRelative extends WP_UnitTestCase {
 		$relative_link = wp_make_link_relative( $link );
 		$this->assertSame( '', $relative_link );
 	}
-
 }
diff --git a/tests/formatting/wpReplaceInHtmlTags.php b/tests/formatting/wpReplaceInHtmlTags.php
index b16fd5e7f1..b461e3bfe8 100644
--- a/tests/formatting/wpReplaceInHtmlTags.php
+++ b/tests/formatting/wpReplaceInHtmlTags.php
@@ -36,4 +36,3 @@ class Tests_Formatting_wpReplaceInHtmlTags extends WP_UnitTestCase {
 		);
 	}
 }
-
diff --git a/tests/formatting/wpSlash.php b/tests/formatting/wpSlash.php
index a1ac591c7a..aa0664d791 100644
--- a/tests/formatting/wpSlash.php
+++ b/tests/formatting/wpSlash.php
@@ -101,5 +101,4 @@ class Tests_Formatting_wpSlash extends WP_UnitTestCase {
 		$this->assertSame( array( 'a' => $new ), wp_slash( array( 'a' => $old ) ) ); // Keyed array.
 		$this->assertSame( array( $new ), wp_slash( array( $old ) ) ); // Non-keyed.
 	}
-
 }
diff --git a/tests/formatting/wpStripAllTags.php b/tests/formatting/wpStripAllTags.php
index 3efe479dec..703d334858 100644
--- a/tests/formatting/wpStripAllTags.php
+++ b/tests/formatting/wpStripAllTags.php
@@ -103,4 +103,3 @@ class Tests_Formatting_wpStripAllTags extends WP_UnitTestCase {
 		);
 	}
 }
-
diff --git a/tests/formatting/wpTargetedLinkRel.php b/tests/formatting/wpTargetedLinkRel.php
index 75a247e212..365f42dddb 100644
--- a/tests/formatting/wpTargetedLinkRel.php
+++ b/tests/formatting/wpTargetedLinkRel.php
@@ -136,5 +136,4 @@ class Tests_Formatting_wpTargetedLinkRel extends WP_UnitTestCase {
 		$expected = '<p>Links: <a href="/" target="_blank" rel="ugc noopener">No rel</a></p>';
 		$this->assertSame( $expected, wp_targeted_link_rel( $content ) );
 	}
-
 }
diff --git a/tests/formatting/wpTexturize.php b/tests/formatting/wpTexturize.php
index ee7ce5f779..3202db4ba7 100644
--- a/tests/formatting/wpTexturize.php
+++ b/tests/formatting/wpTexturize.php
@@ -32,7 +32,6 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 		$invalid_nest = '<pre></code>"baba"</pre>';
 		$this->assertSame( $invalid_nest, wptexturize( $invalid_nest ) );
-
 	}
 
 	/**
diff --git a/tests/formatting/wpTrimExcerpt.php b/tests/formatting/wpTrimExcerpt.php
index c3ab336bf9..0f9c6e9cb7 100644
--- a/tests/formatting/wpTrimExcerpt.php
+++ b/tests/formatting/wpTrimExcerpt.php
@@ -92,4 +92,133 @@ class Tests_Formatting_wpTrimExcerpt extends WP_UnitTestCase {
 		$this->assertSame( 'Post content', wp_trim_excerpt( null, $post ) );
 		$this->assertSame( 'Post content', wp_trim_excerpt( false, $post ) );
 	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` unhooks `wp_filter_content_tags()` from 'the_content' filter.
+	 *
+	 * @ticket 56588
+	 */
+	public function test_wp_trim_excerpt_unhooks_wp_filter_content_tags() {
+		$post = self::factory()->post->create();
+
+		/*
+		 * Record that during 'the_content' filter run by wp_trim_excerpt() the
+		 * wp_filter_content_tags() callback is not used.
+		 */
+		$has_filter = true;
+		add_filter(
+			'the_content',
+			static function ( $content ) use ( &$has_filter ) {
+				$has_filter = has_filter( 'the_content', 'wp_filter_content_tags' );
+				return $content;
+			}
+		);
+
+		wp_trim_excerpt( '', $post );
+
+		$this->assertFalse( $has_filter, 'wp_filter_content_tags() was not unhooked in wp_trim_excerpt()' );
+	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` doesn't permanently unhook `wp_filter_content_tags()` from 'the_content' filter.
+	 *
+	 * @ticket 56588
+	 */
+	public function test_wp_trim_excerpt_should_not_permanently_unhook_wp_filter_content_tags() {
+		$post = self::factory()->post->create();
+
+		wp_trim_excerpt( '', $post );
+
+		$this->assertSame( 12, has_filter( 'the_content', 'wp_filter_content_tags' ), 'wp_filter_content_tags() was not restored in wp_trim_excerpt()' );
+	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` doesn't restore `wp_filter_content_tags()` if it was previously unhooked.
+	 *
+	 * @ticket 56588
+	 */
+	public function test_wp_trim_excerpt_does_not_restore_wp_filter_content_tags_if_previously_unhooked() {
+		$post = self::factory()->post->create();
+
+		// Remove wp_filter_content_tags() from 'the_content' filter generally.
+		remove_filter( 'the_content', 'wp_filter_content_tags', 12 );
+
+		wp_trim_excerpt( '', $post );
+
+		// Assert that the filter callback was not restored after running 'the_content'.
+		$this->assertFalse( has_filter( 'the_content', 'wp_filter_content_tags' ) );
+	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` does process valid blocks.
+	 *
+	 * @ticket 58682
+	 */
+	public function test_wp_trim_excerpt_check_if_block_renders() {
+		$post = self::factory()->post->create(
+			array(
+				'post_content' => '<!-- wp:paragraph --> <p>A test paragraph</p> <!-- /wp:paragraph -->',
+			)
+		);
+
+		$output_text = wp_trim_excerpt( '', $post );
+
+		$this->assertSame( 'A test paragraph', $output_text, 'wp_trim_excerpt() did not process paragraph block.' );
+	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` unhooks `do_blocks()` from 'the_content' filter.
+	 *
+	 * @ticket 58682
+	 */
+	public function test_wp_trim_excerpt_unhooks_do_blocks() {
+		$post = self::factory()->post->create();
+
+		/*
+		 * Record that during 'the_content' filter run by wp_trim_excerpt() the
+		 * do_blocks() callback is not used.
+		 */
+		$has_filter = true;
+		add_filter(
+			'the_content',
+			static function ( $content ) use ( &$has_filter ) {
+				$has_filter = has_filter( 'the_content', 'do_blocks' );
+				return $content;
+			}
+		);
+
+		wp_trim_excerpt( '', $post );
+
+		$this->assertFalse( $has_filter, 'do_blocks() was not unhooked in wp_trim_excerpt()' );
+	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` doesn't permanently unhook `do_blocks()` from 'the_content' filter.
+	 *
+	 * @ticket 58682
+	 */
+	public function test_wp_trim_excerpt_should_not_permanently_unhook_do_blocks() {
+		$post = self::factory()->post->create();
+
+		wp_trim_excerpt( '', $post );
+
+		$this->assertSame( 9, has_filter( 'the_content', 'do_blocks' ), 'do_blocks() was not restored in wp_trim_excerpt()' );
+	}
+
+	/**
+	 * Tests that `wp_trim_excerpt()` doesn't restore `do_blocks()` if it was previously unhooked.
+	 *
+	 * @ticket 58682
+	 */
+	public function test_wp_trim_excerpt_does_not_restore_do_blocks_if_previously_unhooked() {
+		$post = self::factory()->post->create();
+
+		// Remove do_blocks() from 'the_content' filter generally.
+		remove_filter( 'the_content', 'do_blocks', 9 );
+
+		wp_trim_excerpt( '', $post );
+
+		// Assert that the filter callback was not restored after running 'the_content'.
+		$this->assertFalse( has_filter( 'the_content', 'do_blocks' ) );
+	}
 }
diff --git a/tests/functions.php b/tests/functions.php
index aa12b106e1..5c8a1aa25f 100644
--- a/tests/functions.php
+++ b/tests/functions.php
@@ -1643,6 +1643,16 @@ class Tests_Functions extends WP_UnitTestCase {
 							'proper_filename' => false,
 						),
 					),
+					// Google Docs file for which finfo_file() returns a duplicate mime type.
+					array(
+						DIR_TESTDATA . '/uploads/double-mime-type.docx',
+						'double-mime-type.docx',
+						array(
+							'ext'             => 'docx',
+							'type'            => 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
+							'proper_filename' => false,
+						),
+					),
 					// Non-image file with wrong sub-type.
 					array(
 						DIR_TESTDATA . '/uploads/pages-to-word.docx',
@@ -1716,7 +1726,7 @@ class Tests_Functions extends WP_UnitTestCase {
 
 		add_filter(
 			'upload_mimes',
-			static function( $mimes ) {
+			static function ( $mimes ) {
 				$mimes['svg'] = 'image/svg+xml';
 				return $mimes;
 			}
@@ -1754,7 +1764,7 @@ class Tests_Functions extends WP_UnitTestCase {
 
 		add_filter(
 			'upload_mimes',
-			static function( $mimes ) use ( $woff_mime_type ) {
+			static function ( $mimes ) use ( $woff_mime_type ) {
 				$mimes['woff'] = $woff_mime_type;
 				return $mimes;
 			}
@@ -1781,7 +1791,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 * Data provider for file validation.
 	 *
 	 * @return array {
-	 *     @type array $0... {
+	 *     @type array ...$0 {
 	 *         @type string $0 File path.
 	 *         @type array  $1 List of allowed files.
 	 *         @type int    $2 Expected result.
@@ -1927,7 +1937,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 * Data provider for stream URL validation.
 	 *
 	 * @return array {
-	 *     @type array $0... {
+	 *     @type array ...$0 {
 	 *         @type string $0 The resource path or URL.
 	 *         @type bool   $1 Expected result.
 	 *     }
@@ -2150,5 +2160,4 @@ class Tests_Functions extends WP_UnitTestCase {
 		);
 		$this->assertSameSetsWithIndex( $theme_json, $expected_theme_json );
 	}
-
 }
diff --git a/tests/functions/addMagicQuotes.php b/tests/functions/addMagicQuotes.php
index f42b601e09..47085efe76 100644
--- a/tests/functions/addMagicQuotes.php
+++ b/tests/functions/addMagicQuotes.php
@@ -61,5 +61,4 @@ class Tests_Functions_AddMagicQuotes extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/functions/anonymization.php b/tests/functions/anonymization.php
index a7849ddf46..7a4ff6a26b 100644
--- a/tests/functions/anonymization.php
+++ b/tests/functions/anonymization.php
@@ -320,5 +320,4 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 		}
 		return $anonymous;
 	}
-
 }
diff --git a/tests/functions/canonicalCharset.php b/tests/functions/canonicalCharset.php
index 973562c6a9..4a11e9c764 100644
--- a/tests/functions/canonicalCharset.php
+++ b/tests/functions/canonicalCharset.php
@@ -88,5 +88,4 @@ class Tests_Functions_CanonicalCharset extends WP_UnitTestCase {
 
 		update_option( 'blog_charset', $orig_blog_charset );
 	}
-
 }
diff --git a/tests/functions/doEnclose.php b/tests/functions/doEnclose.php
index 5611878bd2..d906ed6f61 100644
--- a/tests/functions/doEnclose.php
+++ b/tests/functions/doEnclose.php
@@ -289,5 +289,4 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/functions/getNonCachedIds.php b/tests/functions/getNonCachedIds.php
index d8df0e11a6..07943bbdc8 100644
--- a/tests/functions/getNonCachedIds.php
+++ b/tests/functions/getNonCachedIds.php
@@ -97,7 +97,7 @@ class Tests_Functions_GetNonCachedIds extends WP_UnitTestCase {
 			'empty string' => array( '' ),
 			'array'        => array( array( 1 ) ),
 			'empty array'  => array( array() ),
-			'stdClass'     => array( new stdClass ),
+			'stdClass'     => array( new stdClass() ),
 		);
 	}
 }
diff --git a/tests/functions/isNewDay.php b/tests/functions/isNewDay.php
index f852c8908f..b1993e09e1 100644
--- a/tests/functions/isNewDay.php
+++ b/tests/functions/isNewDay.php
@@ -33,5 +33,4 @@ class Tests_Functions_IsNewDate extends WP_UnitTestCase {
 			array( '21.05.19', false, 1 ),
 		);
 	}
-
 }
diff --git a/tests/functions/listFiles.php b/tests/functions/listFiles.php
index a70a058940..bfdd080f8b 100644
--- a/tests/functions/listFiles.php
+++ b/tests/functions/listFiles.php
@@ -19,4 +19,63 @@ class Tests_Functions_ListFiles extends WP_UnitTestCase {
 		$admin_files = list_files( ABSPATH . 'wp-admin/', 100, array( 'index.php' ) );
 		$this->assertNotContains( ABSPATH . 'wp-admin/index.php', $admin_files );
 	}
+
+	/**
+	 * Tests that list_files() optionally includes hidden files.
+	 *
+	 * @ticket 53659
+	 *
+	 * @dataProvider data_list_files_should_optionally_include_hidden_files
+	 *
+	 * @param string   $filename       The name of the hidden file.
+	 * @param bool     $include_hidden Whether to include hidden ("." prefixed) files.
+	 * @param string[] $exclusions     List of folders and files to skip.
+	 * @param bool     $expected       Whether the file should be included in the results.
+	 */
+	public function test_list_files_should_optionally_include_hidden_files( $filename, $include_hidden, $exclusions, $expected ) {
+		$test_dir    = get_temp_dir() . 'test-list-files/';
+		$hidden_file = $test_dir . $filename;
+
+		mkdir( $test_dir );
+		touch( $hidden_file );
+
+		$actual = list_files( $test_dir, 100, $exclusions, $include_hidden );
+
+		unlink( $hidden_file );
+		rmdir( $test_dir );
+
+		if ( $expected ) {
+			$this->assertContains( $hidden_file, $actual, 'The file was not included.' );
+		} else {
+			$this->assertNotContains( $hidden_file, $actual, 'The file was included.' );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_list_files_should_optionally_include_hidden_files() {
+		return array(
+			'$include_hidden = false and no exclusions' => array(
+				'filename'       => '.hidden_file',
+				'include_hidden' => false,
+				'exclusions'     => array(),
+				'expected'       => false,
+			),
+			'$include_hidden = true and no exclusions'  => array(
+				'filename'       => '.hidden_file',
+				'include_hidden' => true,
+				'exclusions'     => array(),
+				'expected'       => true,
+			),
+			'$include_hidden = true and an excluded filename' => array(
+				'filename'       => '.hidden_file',
+				'include_hidden' => true,
+				'exclusions'     => array( '.hidden_file' ),
+				'expected'       => false,
+			),
+		);
+	}
 }
diff --git a/tests/functions/referer.php b/tests/functions/referer.php
index b1d113afcf..0abe528c48 100644
--- a/tests/functions/referer.php
+++ b/tests/functions/referer.php
@@ -156,4 +156,12 @@ class Tests_Functions_Referer extends WP_UnitTestCase {
 		$_REQUEST['_wp_http_referer'] = addslashes( 'http://foo.bar/baz' );
 		$this->assertSame( 'http://foo.bar/baz', wp_get_raw_referer() );
 	}
+
+	/**
+	 * @ticket 57670
+	 */
+	public function test_raw_referer_is_false_on_invalid_request_parameter() {
+		$_REQUEST['_wp_http_referer'] = array( 'demo' );
+		$this->assertFalse( wp_get_raw_referer() );
+	}
 }
diff --git a/tests/functions/wp.php b/tests/functions/wp.php
index 04df43b348..14356a4ebc 100644
--- a/tests/functions/wp.php
+++ b/tests/functions/wp.php
@@ -16,5 +16,4 @@ class Tests_Functions_WP extends WP_UnitTestCase {
 		$this->assertInstanceOf( 'WP_Query', $wp_query );
 		$this->assertInstanceOf( 'WP_Query', $wp_the_query );
 	}
-
 }
diff --git a/tests/functions/wpAdminNotice.php b/tests/functions/wpAdminNotice.php
new file mode 100644
index 0000000000..2756ab1de9
--- /dev/null
+++ b/tests/functions/wpAdminNotice.php
@@ -0,0 +1,326 @@
+<?php
+
+/**
+ * Tests for `wp_admin_notice()`.
+ *
+ * @group functions.php
+ *
+ * @covers ::wp_admin_notice
+ */
+class Tests_Functions_WpAdminNotice extends WP_UnitTestCase {
+
+	/**
+	 * Tests that `wp_admin_notice()` outputs the expected admin notice markup.
+	 *
+	 * @ticket 57791
+	 *
+	 * @dataProvider data_should_output_admin_notice
+	 *
+	 * @param string $message  The message to output.
+	 * @param array  $args     Arguments for the admin notice.
+	 * @param string $expected The expected admin notice markup.
+	 */
+	public function test_should_output_admin_notice( $message, $args, $expected ) {
+		ob_start();
+		wp_admin_notice( $message, $args );
+		$actual = ob_get_clean();
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_output_admin_notice() {
+		return array(
+			'defaults'                                  => array(
+				'message'  => 'A notice with defaults.',
+				'args'     => array(),
+				'expected' => '<div class="notice"><p>A notice with defaults.</p></div>',
+			),
+			'an empty message (used for templates)'     => array(
+				'message'  => '',
+				'args'     => array(
+					'type'               => 'error',
+					'dismissible'        => true,
+					'id'                 => 'message',
+					'additional_classes' => array( 'inline', 'hidden' ),
+				),
+				'expected' => '<div id="message" class="notice notice-error is-dismissible inline hidden"><p></p></div>',
+			),
+			'an empty message (used for templates) without paragraph wrapping' => array(
+				'message'  => '',
+				'args'     => array(
+					'type'               => 'error',
+					'dismissible'        => true,
+					'id'                 => 'message',
+					'additional_classes' => array( 'inline', 'hidden' ),
+					'paragraph_wrap'     => false,
+				),
+				'expected' => '<div id="message" class="notice notice-error is-dismissible inline hidden"></div>',
+			),
+			'an "error" notice'                         => array(
+				'message'  => 'An "error" notice.',
+				'args'     => array(
+					'type' => 'error',
+				),
+				'expected' => '<div class="notice notice-error"><p>An "error" notice.</p></div>',
+			),
+			'a "success" notice'                        => array(
+				'message'  => 'A "success" notice.',
+				'args'     => array(
+					'type' => 'success',
+				),
+				'expected' => '<div class="notice notice-success"><p>A "success" notice.</p></div>',
+			),
+			'a "warning" notice'                        => array(
+				'message'  => 'A "warning" notice.',
+				'args'     => array(
+					'type' => 'warning',
+				),
+				'expected' => '<div class="notice notice-warning"><p>A "warning" notice.</p></div>',
+			),
+			'an "info" notice'                          => array(
+				'message'  => 'An "info" notice.',
+				'args'     => array(
+					'type' => 'info',
+				),
+				'expected' => '<div class="notice notice-info"><p>An "info" notice.</p></div>',
+			),
+			'a type that already starts with "notice-"' => array(
+				'message'  => 'A type that already starts with "notice-".',
+				'args'     => array(
+					'type' => 'notice-info',
+				),
+				'expected' => '<div class="notice notice-notice-info"><p>A type that already starts with "notice-".</p></div>',
+			),
+			'a dismissible notice'                      => array(
+				'message'  => 'A dismissible notice.',
+				'args'     => array(
+					'dismissible' => true,
+				),
+				'expected' => '<div class="notice is-dismissible"><p>A dismissible notice.</p></div>',
+			),
+			'no type and an ID'                         => array(
+				'message'  => 'A notice with an ID.',
+				'args'     => array(
+					'id' => 'message',
+				),
+				'expected' => '<div id="message" class="notice"><p>A notice with an ID.</p></div>',
+			),
+			'a type and an ID'                          => array(
+				'message'  => 'A warning notice with an ID.',
+				'args'     => array(
+					'type' => 'warning',
+					'id'   => 'message',
+				),
+				'expected' => '<div id="message" class="notice notice-warning"><p>A warning notice with an ID.</p></div>',
+			),
+			'no type and additional classes'            => array(
+				'message'  => 'A notice with additional classes.',
+				'args'     => array(
+					'additional_classes' => array( 'error', 'notice-alt' ),
+				),
+				'expected' => '<div class="notice error notice-alt"><p>A notice with additional classes.</p></div>',
+			),
+			'a type and additional classes'             => array(
+				'message'  => 'A warning notice with additional classes.',
+				'args'     => array(
+					'type'               => 'warning',
+					'additional_classes' => array( 'error', 'notice-alt' ),
+				),
+				'expected' => '<div class="notice notice-warning error notice-alt"><p>A warning notice with additional classes.</p></div>',
+			),
+			'a dismissible notice with a type and additional classes' => array(
+				'message'  => 'A dismissible warning notice with a type and additional classes.',
+				'args'     => array(
+					'type'               => 'warning',
+					'dismissible'        => true,
+					'additional_classes' => array( 'error', 'notice-alt' ),
+				),
+				'expected' => '<div class="notice notice-warning is-dismissible error notice-alt"><p>A dismissible warning notice with a type and additional classes.</p></div>',
+			),
+			'a notice without paragraph wrapping'       => array(
+				'message'  => '<span>A notice without paragraph wrapping.</span>',
+				'args'     => array(
+					'paragraph_wrap' => false,
+				),
+				'expected' => '<div class="notice"><span>A notice without paragraph wrapping.</span></div>',
+			),
+			'an unsafe type'                            => array(
+				'message'  => 'A notice with an unsafe type.',
+				'args'     => array(
+					'type' => '"><script>alert("Howdy,admin!");</script>',
+				),
+				'expected' => '<div class="notice notice-">alert("Howdy,admin!");"&gt;<p>A notice with an unsafe type.</p></div>',
+			),
+			'an unsafe ID'                              => array(
+				'message'  => 'A notice with an unsafe ID.',
+				'args'     => array(
+					'id' => '"><script>alert( "Howdy, admin!" );</script> <div class="notice',
+				),
+				'expected' => '<div id="">alert( "Howdy, admin!" ); <div class="notice"><p>A notice with an unsafe ID.</p></div>',
+			),
+			'unsafe additional classes'                 => array(
+				'message'  => 'A notice with unsafe additional classes.',
+				'args'     => array(
+					'additional_classes' => array( '"><script>alert( "Howdy, admin!" );</script> <div class="notice' ),
+				),
+				'expected' => '<div class="notice ">alert( "Howdy, admin!" ); <div class="notice"><p>A notice with unsafe additional classes.</p></div>',
+			),
+			'a type that is not a string'               => array(
+				'message'  => 'A notice with a type that is not a string.',
+				'args'     => array(
+					'type' => array(),
+				),
+				'expected' => '<div class="notice"><p>A notice with a type that is not a string.</p></div>',
+			),
+			'a type with only empty space'              => array(
+				'message'  => 'A notice with a type with only empty space.',
+				'args'     => array(
+					'type' => " \t\r\n",
+				),
+				'expected' => '<div class="notice"><p>A notice with a type with only empty space.</p></div>',
+			),
+			'an ID that is not a string'                => array(
+				'message'  => 'A notice with an ID that is not a string.',
+				'args'     => array(
+					'id' => array( 'message' ),
+				),
+				'expected' => '<div class="notice"><p>A notice with an ID that is not a string.</p></div>',
+			),
+			'an ID with only empty space'               => array(
+				'message'  => 'A notice with an ID with only empty space.',
+				'args'     => array(
+					'id' => " \t\r\n",
+				),
+				'expected' => '<div class="notice"><p>A notice with an ID with only empty space.</p></div>',
+			),
+			'dismissible as a truthy value rather than (bool) true' => array(
+				'message'  => 'A notice with dismissible as a truthy value rather than (bool) true.',
+				'args'     => array(
+					'dismissible' => 1,
+				),
+				'expected' => '<div class="notice"><p>A notice with dismissible as a truthy value rather than (bool) true.</p></div>',
+			),
+			'additional classes that are not an array'  => array(
+				'message'  => 'A notice with additional classes that are not an array.',
+				'args'     => array(
+					'additional_classes' => 'class-1 class-2 class-3',
+				),
+				'expected' => '<div class="notice"><p>A notice with additional classes that are not an array.</p></div>',
+			),
+			'additional attribute with a value'         => array(
+				'message'  => 'A notice with an additional attribute with a value.',
+				'args'     => array(
+					'attributes' => array( 'aria-live' => 'assertive' ),
+				),
+				'expected' => '<div class="notice" aria-live="assertive"><p>A notice with an additional attribute with a value.</p></div>',
+			),
+			'additional hidden attribute'               => array(
+				'message'  => 'A notice with the hidden attribute.',
+				'args'     => array(
+					'attributes' => array( 'hidden' => true ),
+				),
+				'expected' => '<div class="notice" hidden><p>A notice with the hidden attribute.</p></div>',
+			),
+			'additional attribute no associative keys'  => array(
+				'message'  => 'A notice with a boolean attribute without an associative key.',
+				'args'     => array(
+					'attributes' => array( 'hidden' ),
+				),
+				'expected' => '<div class="notice" hidden><p>A notice with a boolean attribute without an associative key.</p></div>',
+			),
+			'additional attribute with role'            => array(
+				'message'  => 'A notice with an additional attribute role.',
+				'args'     => array(
+					'attributes' => array( 'role' => 'alert' ),
+				),
+				'expected' => '<div class="notice" role="alert"><p>A notice with an additional attribute role.</p></div>',
+			),
+			'multiple additional attributes'            => array(
+				'message'  => 'A notice with multiple additional attributes.',
+				'args'     => array(
+					'attributes' => array(
+						'role'      => 'alert',
+						'data-test' => -1,
+					),
+				),
+				'expected' => '<div class="notice" role="alert" data-test="-1"><p>A notice with multiple additional attributes.</p></div>',
+			),
+			'data attribute with unsafe value'          => array(
+				'message'  => 'A notice with an additional attribute with an unsafe value.',
+				'args'     => array(
+					'attributes' => array( 'data-unsafe' => '<script>alert( "Howdy, admin!" );</script>' ),
+				),
+				'expected' => '<div class="notice" data-unsafe="&lt;script&gt;alert( &quot;Howdy, admin!&quot; );&lt;/script&gt;"><p>A notice with an additional attribute with an unsafe value.</p></div>',
+			),
+			'additional invalid attribute'              => array(
+				'message'  => 'A notice with an additional attribute that is invalid.',
+				'args'     => array(
+					'attributes' => array( 'not-valid' => 'not-valid' ),
+				),
+				'expected' => '<div class="notice"><p>A notice with an additional attribute that is invalid.</p></div>',
+			),
+			'multiple attributes with "role", invalid, data-*, numeric, and boolean' => array(
+				'message'  => 'A notice with multiple attributes with "role", invalid, "data-*", numeric, and boolean.',
+				'args'     => array(
+					'attributes' => array(
+						'role'      => 'alert',
+						'disabled'  => 'disabled',
+						'data-name' => 'my-name',
+						'data-id'   => 1,
+						'hidden',
+					),
+				),
+				'expected' => '<div class="notice" role="alert" data-name="my-name" data-id="1" hidden><p>A notice with multiple attributes with "role", invalid, "data-*", numeric, and boolean.</p></div>',
+			),
+			'paragraph wrapping as a falsy value rather than (bool) false' => array(
+				'message'  => 'A notice with paragraph wrapping as a falsy value rather than (bool) false.',
+				'args'     => array(
+					'paragraph_wrap' => 0,
+				),
+				'expected' => '<div class="notice"><p>A notice with paragraph wrapping as a falsy value rather than (bool) false.</p></div>',
+			),
+		);
+	}
+
+	/**
+	 * Tests that `_doing_it_wrong()` is thrown when a 'type' containing spaces is passed.
+	 *
+	 * @ticket 57791
+	 *
+	 * @expectedIncorrectUsage wp_get_admin_notice
+	 */
+	public function test_should_throw_doing_it_wrong_with_a_type_containing_spaces() {
+		ob_start();
+		wp_admin_notice(
+			'A type containing spaces.',
+			array( 'type' => 'first second third fourth' )
+		);
+		$actual = ob_get_clean();
+
+		$this->assertSame(
+			'<div class="notice notice-first second third fourth"><p>A type containing spaces.</p></div>',
+			$actual
+		);
+	}
+
+	/**
+	 * Tests that `wp_admin_notice()` fires the 'wp_admin_notice' action.
+	 *
+	 * @ticket 57791
+	 */
+	public function test_should_fire_wp_admin_notice_action() {
+		$action = new MockAction();
+		add_action( 'wp_admin_notice', array( $action, 'action' ) );
+
+		ob_start();
+		wp_admin_notice( 'A notice.', array( 'type' => 'success' ) );
+		ob_end_clean();
+
+		$this->assertSame( 1, $action->get_call_count() );
+	}
+}
diff --git a/tests/functions/wpFilesize.php b/tests/functions/wpFilesize.php
index f0e510ddc5..250f7e79c7 100644
--- a/tests/functions/wpFilesize.php
+++ b/tests/functions/wpFilesize.php
@@ -25,7 +25,7 @@ class Tests_Functions_wpFilesize extends WP_UnitTestCase {
 
 		add_filter(
 			'wp_filesize',
-			static function() {
+			static function () {
 				return 999;
 			}
 		);
@@ -34,7 +34,7 @@ class Tests_Functions_wpFilesize extends WP_UnitTestCase {
 
 		add_filter(
 			'pre_wp_filesize',
-			static function() {
+			static function () {
 				return 111;
 			}
 		);
diff --git a/tests/functions/wpFuzzyNumberMatch.php b/tests/functions/wpFuzzyNumberMatch.php
index 85034165ce..77a06e2bb7 100644
--- a/tests/functions/wpFuzzyNumberMatch.php
+++ b/tests/functions/wpFuzzyNumberMatch.php
@@ -108,5 +108,4 @@ class Tests_Functions_wpFuzzyNumberMatch extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/functions/wpGetAdminNotice.php b/tests/functions/wpGetAdminNotice.php
new file mode 100644
index 0000000000..aeeadff96d
--- /dev/null
+++ b/tests/functions/wpGetAdminNotice.php
@@ -0,0 +1,326 @@
+<?php
+
+/**
+ * Tests for `wp_get_admin_notice()`.
+ *
+ * @group functions.php
+ *
+ * @covers ::wp_get_admin_notice
+ */
+class Tests_Functions_WpGetAdminNotice extends WP_UnitTestCase {
+
+	/**
+	 * Tests that `wp_get_admin_notice()` returns the expected admin notice markup.
+	 *
+	 * @ticket 57791
+	 *
+	 * @dataProvider data_should_return_admin_notice
+	 *
+	 * @param string $message  The message.
+	 * @param array  $args     Arguments for the admin notice.
+	 * @param string $expected The expected admin notice markup.
+	 */
+	public function test_should_return_admin_notice( $message, $args, $expected ) {
+		$this->assertSame( $expected, wp_get_admin_notice( $message, $args ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_return_admin_notice() {
+		return array(
+			'defaults'                                  => array(
+				'message'  => 'A notice with defaults.',
+				'args'     => array(),
+				'expected' => '<div class="notice"><p>A notice with defaults.</p></div>',
+			),
+			'an empty message (used for templates)'     => array(
+				'message'  => '',
+				'args'     => array(
+					'type'               => 'error',
+					'dismissible'        => true,
+					'id'                 => 'message',
+					'additional_classes' => array( 'inline', 'hidden' ),
+				),
+				'expected' => '<div id="message" class="notice notice-error is-dismissible inline hidden"><p></p></div>',
+			),
+			'an empty message (used for templates) without paragraph wrapping' => array(
+				'message'  => '',
+				'args'     => array(
+					'type'               => 'error',
+					'dismissible'        => true,
+					'id'                 => 'message',
+					'additional_classes' => array( 'inline', 'hidden' ),
+					'paragraph_wrap'     => false,
+				),
+				'expected' => '<div id="message" class="notice notice-error is-dismissible inline hidden"></div>',
+			),
+			'an "error" notice'                         => array(
+				'message'  => 'An "error" notice.',
+				'args'     => array(
+					'type' => 'error',
+				),
+				'expected' => '<div class="notice notice-error"><p>An "error" notice.</p></div>',
+			),
+			'a "success" notice'                        => array(
+				'message'  => 'A "success" notice.',
+				'args'     => array(
+					'type' => 'success',
+				),
+				'expected' => '<div class="notice notice-success"><p>A "success" notice.</p></div>',
+			),
+			'a "warning" notice'                        => array(
+				'message'  => 'A "warning" notice.',
+				'args'     => array(
+					'type' => 'warning',
+				),
+				'expected' => '<div class="notice notice-warning"><p>A "warning" notice.</p></div>',
+			),
+			'an "info" notice'                          => array(
+				'message'  => 'An "info" notice.',
+				'args'     => array(
+					'type' => 'info',
+				),
+				'expected' => '<div class="notice notice-info"><p>An "info" notice.</p></div>',
+			),
+			'a type that already starts with "notice-"' => array(
+				'message'  => 'A type that already starts with "notice-".',
+				'args'     => array(
+					'type' => 'notice-info',
+				),
+				'expected' => '<div class="notice notice-notice-info"><p>A type that already starts with "notice-".</p></div>',
+			),
+			'a dismissible notice'                      => array(
+				'message'  => 'A dismissible notice.',
+				'args'     => array(
+					'dismissible' => true,
+				),
+				'expected' => '<div class="notice is-dismissible"><p>A dismissible notice.</p></div>',
+			),
+			'no type and an ID'                         => array(
+				'message'  => 'A notice with an ID.',
+				'args'     => array(
+					'id' => 'message',
+				),
+				'expected' => '<div id="message" class="notice"><p>A notice with an ID.</p></div>',
+			),
+			'a type and an ID'                          => array(
+				'message'  => 'A warning notice with an ID.',
+				'args'     => array(
+					'type' => 'warning',
+					'id'   => 'message',
+				),
+				'expected' => '<div id="message" class="notice notice-warning"><p>A warning notice with an ID.</p></div>',
+			),
+			'no type and additional classes'            => array(
+				'message'  => 'A notice with additional classes.',
+				'args'     => array(
+					'additional_classes' => array( 'error', 'notice-alt' ),
+				),
+				'expected' => '<div class="notice error notice-alt"><p>A notice with additional classes.</p></div>',
+			),
+			'a type and additional classes'             => array(
+				'message'  => 'A warning notice with additional classes.',
+				'args'     => array(
+					'type'               => 'warning',
+					'additional_classes' => array( 'error', 'notice-alt' ),
+				),
+				'expected' => '<div class="notice notice-warning error notice-alt"><p>A warning notice with additional classes.</p></div>',
+			),
+			'a dismissible notice with a type and additional classes' => array(
+				'message'  => 'A dismissible warning notice with a type and additional classes.',
+				'args'     => array(
+					'type'               => 'warning',
+					'dismissible'        => true,
+					'additional_classes' => array( 'error', 'notice-alt' ),
+				),
+				'expected' => '<div class="notice notice-warning is-dismissible error notice-alt"><p>A dismissible warning notice with a type and additional classes.</p></div>',
+			),
+			'a notice without paragraph wrapping'       => array(
+				'message'  => '<span>A notice without paragraph wrapping.</span>',
+				'args'     => array(
+					'paragraph_wrap' => false,
+				),
+				'expected' => '<div class="notice"><span>A notice without paragraph wrapping.</span></div>',
+			),
+			'an unsafe type'                            => array(
+				'message'  => 'A notice with an unsafe type.',
+				'args'     => array(
+					'type' => '"><script>alert("Howdy,admin!");</script>',
+				),
+				'expected' => '<div class="notice notice-"><script>alert("Howdy,admin!");</script>"><p>A notice with an unsafe type.</p></div>',
+			),
+			'an unsafe ID'                              => array(
+				'message'  => 'A notice with an unsafe ID.',
+				'args'     => array(
+					'id' => '"><script>alert( "Howdy, admin!" );</script> <div class="notice',
+				),
+				'expected' => '<div id=""><script>alert( "Howdy, admin!" );</script> <div class="notice" class="notice"><p>A notice with an unsafe ID.</p></div>',
+			),
+			'unsafe additional classes'                 => array(
+				'message'  => 'A notice with unsafe additional classes.',
+				'args'     => array(
+					'additional_classes' => array( '"><script>alert( "Howdy, admin!" );</script> <div class="notice' ),
+				),
+				'expected' => '<div class="notice "><script>alert( "Howdy, admin!" );</script> <div class="notice"><p>A notice with unsafe additional classes.</p></div>',
+			),
+			'a type that is not a string'               => array(
+				'message'  => 'A notice with a type that is not a string.',
+				'args'     => array(
+					'type' => array(),
+				),
+				'expected' => '<div class="notice"><p>A notice with a type that is not a string.</p></div>',
+			),
+			'a type with only empty space'              => array(
+				'message'  => 'A notice with a type with only empty space.',
+				'args'     => array(
+					'type' => " \t\r\n",
+				),
+				'expected' => '<div class="notice"><p>A notice with a type with only empty space.</p></div>',
+			),
+			'an ID that is not a string'                => array(
+				'message'  => 'A notice with an ID that is not a string.',
+				'args'     => array(
+					'id' => array( 'message' ),
+				),
+				'expected' => '<div class="notice"><p>A notice with an ID that is not a string.</p></div>',
+			),
+			'an ID with only empty space'               => array(
+				'message'  => 'A notice with an ID with only empty space.',
+				'args'     => array(
+					'id' => " \t\r\n",
+				),
+				'expected' => '<div class="notice"><p>A notice with an ID with only empty space.</p></div>',
+			),
+			'dismissible as a truthy value rather than (bool) true' => array(
+				'message'  => 'A notice with dismissible as a truthy value rather than (bool) true.',
+				'args'     => array(
+					'dismissible' => 1,
+				),
+				'expected' => '<div class="notice"><p>A notice with dismissible as a truthy value rather than (bool) true.</p></div>',
+			),
+			'additional classes that are not an array'  => array(
+				'message'  => 'A notice with additional classes that are not an array.',
+				'args'     => array(
+					'additional_classes' => 'class-1 class-2 class-3',
+				),
+				'expected' => '<div class="notice"><p>A notice with additional classes that are not an array.</p></div>',
+			),
+			'additional attribute with a value'         => array(
+				'message'  => 'A notice with an additional attribute with a value.',
+				'args'     => array(
+					'attributes' => array( 'aria-live' => 'assertive' ),
+				),
+				'expected' => '<div class="notice" aria-live="assertive"><p>A notice with an additional attribute with a value.</p></div>',
+			),
+			'additional hidden attribute'               => array(
+				'message'  => 'A notice with the hidden attribute.',
+				'args'     => array(
+					'attributes' => array( 'hidden' => true ),
+				),
+				'expected' => '<div class="notice" hidden><p>A notice with the hidden attribute.</p></div>',
+			),
+			'additional attribute no associative keys'  => array(
+				'message'  => 'A notice with a boolean attribute without an associative key.',
+				'args'     => array(
+					'attributes' => array( 'hidden' ),
+				),
+				'expected' => '<div class="notice" hidden><p>A notice with a boolean attribute without an associative key.</p></div>',
+			),
+			'additional attribute with role'            => array(
+				'message'  => 'A notice with an additional attribute role.',
+				'args'     => array(
+					'attributes' => array( 'role' => 'alert' ),
+				),
+				'expected' => '<div class="notice" role="alert"><p>A notice with an additional attribute role.</p></div>',
+			),
+			'multiple additional attributes'            => array(
+				'message'  => 'A notice with multiple additional attributes.',
+				'args'     => array(
+					'attributes' => array(
+						'role'      => 'alert',
+						'data-test' => -1,
+					),
+				),
+				'expected' => '<div class="notice" role="alert" data-test="-1"><p>A notice with multiple additional attributes.</p></div>',
+			),
+			'data attribute with unsafe value'          => array(
+				'message'  => 'A notice with an additional attribute with an unsafe value.',
+				'args'     => array(
+					'attributes' => array( 'data-unsafe' => '<script>alert( "Howdy, admin!" );</script>' ),
+				),
+				'expected' => '<div class="notice" data-unsafe="&lt;script&gt;alert( &quot;Howdy, admin!&quot; );&lt;/script&gt;"><p>A notice with an additional attribute with an unsafe value.</p></div>',
+			),
+			'multiple attributes with "role", invalid, data-*, numeric, and boolean' => array(
+				'message'  => 'A notice with multiple attributes with "role", invalid, "data-*", numeric, and boolean.',
+				'args'     => array(
+					'attributes' => array(
+						'role'      => 'alert',
+						'disabled'  => 'disabled',
+						'data-name' => 'my-name',
+						'data-id'   => 1,
+						'hidden',
+					),
+				),
+				'expected' => '<div class="notice" role="alert" disabled="disabled" data-name="my-name" data-id="1" hidden><p>A notice with multiple attributes with "role", invalid, "data-*", numeric, and boolean.</p></div>',
+			),
+			'paragraph wrapping as a falsy value rather than (bool) false' => array(
+				'message'  => 'A notice with paragraph wrapping as a falsy value rather than (bool) false.',
+				'args'     => array(
+					'paragraph_wrap' => 0,
+				),
+				'expected' => '<div class="notice"><p>A notice with paragraph wrapping as a falsy value rather than (bool) false.</p></div>',
+			),
+		);
+	}
+
+	/**
+	 * Tests that `wp_get_admin_notice()` throws a `_doing_it_wrong()` when
+	 * a 'type' containing spaces is passed.
+	 *
+	 * @ticket 57791
+	 *
+	 * @expectedIncorrectUsage wp_get_admin_notice
+	 */
+	public function test_should_throw_doing_it_wrong_with_a_type_containing_spaces() {
+		$this->assertSame(
+			'<div class="notice notice-first second third fourth"><p>A type containing spaces.</p></div>',
+			wp_get_admin_notice(
+				'A type containing spaces.',
+				array( 'type' => 'first second third fourth' )
+			)
+		);
+	}
+
+	/**
+	 * Tests that `wp_get_admin_notice()` applies filters.
+	 *
+	 * @ticket 57791
+	 *
+	 * @dataProvider data_should_apply_filters
+	 *
+	 * @param string $hook_name The name of the filter hook.
+	 */
+	public function test_should_apply_filters( $hook_name ) {
+		$filter = new MockAction();
+		add_filter( $hook_name, array( $filter, 'filter' ) );
+
+		wp_get_admin_notice( 'A notice.', array( 'type' => 'success' ) );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_apply_filters() {
+		return array(
+			'wp_admin_notice_args'   => array( 'hook_name' => 'wp_admin_notice_args' ),
+			'wp_admin_notice_markup' => array( 'hook_name' => 'wp_admin_notice_markup' ),
+		);
+	}
+}
diff --git a/tests/functions/wpListFilter.php b/tests/functions/wpListFilter.php
index bc8acdc63a..042325227e 100644
--- a/tests/functions/wpListFilter.php
+++ b/tests/functions/wpListFilter.php
@@ -210,6 +210,20 @@ class Tests_Functions_wpListFilter extends WP_UnitTestCase {
 					),
 				),
 			),
+			'string to int comparison' => array(
+				array(
+					(object) array(
+						'foo' => '1',
+					),
+				),
+				array( 'foo' => 1 ),
+				'AND',
+				array(
+					0 => (object) array(
+						'foo' => '1',
+					),
+				),
+			),
 		);
 	}
 }
diff --git a/tests/functions/wpListUtil.php b/tests/functions/wpListUtil.php
index f40771681e..dba0a12797 100644
--- a/tests/functions/wpListUtil.php
+++ b/tests/functions/wpListUtil.php
@@ -210,6 +210,7 @@ class Tests_Functions_wpListUtil extends WP_UnitTestCase {
 	 * @dataProvider data_wp_list_util_sort_int_arrays
 	 * @dataProvider data_wp_list_util_sort_arrays_of_arrays
 	 * @dataProvider data_wp_list_util_sort_object_arrays
+	 * @dataProvider data_wp_list_util_sort_non_existent_orderby_fields
 	 *
 	 * @covers WP_List_Util::sort
 	 * @covers ::wp_list_sort
@@ -1002,54 +1003,11 @@ class Tests_Functions_wpListUtil extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Tests non-existent '$orderby' fields.
-	 *
-	 * In PHP < 7.0.0, the sorting behavior is different, which Core does not
-	 * currently handle. Until this is fixed, or the minimum PHP version is
-	 * raised to PHP 7.0.0+, these tests will be skipped on PHP < 7.0.0.
-	 *
-	 * @ticket 55300
-	 *
-	 * @dataProvider data_wp_list_util_sort_php_7_or_greater
-	 *
-	 * @covers WP_List_Util::sort
-	 * @covers ::wp_list_sort
-	 *
-	 * @param array  $expected      The expected array.
-	 * @param array  $target_array  The array to create a list from.
-	 * @param array  $orderby       Optional. Either the field name to order by or an array
-	 *                              of multiple orderby fields as `$orderby => $order`.
-	 *                              Default empty array.
-	 * @param string $order         Optional. Either 'ASC' or 'DESC'. Only used if `$orderby`
-	 *                              is a string. Default 'ASC'.
-	 * @param bool   $preserve_keys Optional. Whether to preserve keys. Default false.
-	 */
-	public function test_wp_list_util_sort_php_7_or_greater( $expected, $target_array, $orderby = array(), $order = 'ASC', $preserve_keys = false ) {
-		if ( version_compare( PHP_VERSION, '7.0.0', '<' ) ) {
-			$this->markTestSkipped( 'This test can only run on PHP 7.0 or greater due to an unstable sort order.' );
-		}
-
-		$util   = new WP_List_Util( $target_array );
-		$actual = $util->sort( $orderby, $order, $preserve_keys );
-
-		$this->assertEqualSetsWithIndex(
-			$expected,
-			$actual,
-			'The sorted value did not match the expected value.'
-		);
-		$this->assertEqualSetsWithIndex(
-			$expected,
-			$util->get_output(),
-			'::get_output() did not return the expected value.'
-		);
-	}
-
-	/**
-	 * Data provider for test_wp_list_util_sort_php_7_or_greater().
+	 * Data provider for test_wp_list_util_sort().
 	 *
 	 * @return array[]
 	 */
-	public function data_wp_list_util_sort_php_7_or_greater() {
+	public function data_wp_list_util_sort_non_existent_orderby_fields() {
 		return array(
 			'int[], int keys, $orderby a non-existent field, $order = ASC and $preserve_keys = false' => array(
 				'expected'      => array( 4, 2, 3, 1 ),
@@ -1203,5 +1161,4 @@ class Tests_Functions_wpListUtil extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/functions/wpTriggerError.php b/tests/functions/wpTriggerError.php
new file mode 100644
index 0000000000..40582bc24a
--- /dev/null
+++ b/tests/functions/wpTriggerError.php
@@ -0,0 +1,101 @@
+<?php
+
+/**
+ * Test cases for the `wp_trigger_error()` function.
+ *
+ * @since 6.4.0
+ *
+ * @group functions.php
+ * @covers ::wp_trigger_error
+ */
+class Tests_Functions_WpTriggerError extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 57686
+	 *
+	 * @dataProvider data_should_trigger_error
+	 *
+	 * @param string $function_name    The function name to test.
+	 * @param string $message          The message to test.
+	 * @param string $expected_message The expected error message.
+	 */
+	public function test_should_trigger_error( $function_name, $message, $expected_message ) {
+		$this->expectError();
+		$this->expectErrorMessage( $expected_message );
+
+		wp_trigger_error( $function_name, $message, E_USER_ERROR );
+	}
+
+	/**
+	 * @ticket 57686
+	 *
+	 * @dataProvider data_should_trigger_error
+	 *
+	 * @param string $function_name    The function name to test.
+	 * @param string $message          The message to test.
+	 * @param string $expected_message The expected error message.
+	 */
+	public function test_should_trigger_warning( $function_name, $message, $expected_message ) {
+		$this->expectWarning();
+		$this->expectWarningMessage( $expected_message );
+
+		wp_trigger_error( $function_name, $message, E_USER_WARNING );
+	}
+
+	/**
+	 * @ticket 57686
+	 *
+	 * @dataProvider data_should_trigger_error
+	 *
+	 * @param string $function_name    The function name to test.
+	 * @param string $message          The message to test.
+	 * @param string $expected_message The expected error message.
+	 */
+	public function test_should_trigger_notice( $function_name, $message, $expected_message ) {
+		$this->expectNotice();
+		$this->expectNoticeMessage( $expected_message );
+
+		wp_trigger_error( $function_name, $message );
+	}
+
+	/**
+	 * @ticket 57686
+	 *
+	 * @dataProvider data_should_trigger_error
+	 *
+	 * @param string $function_name    The function name to test.
+	 * @param string $message          The message to test.
+	 * @param string $expected_message The expected error message.
+	 */
+	public function test_should_trigger_deprecation( $function_name, $message, $expected_message ) {
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage( $expected_message );
+
+		wp_trigger_error( $function_name, $message, E_USER_DEPRECATED );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_trigger_error() {
+		return array(
+			'function name and message are given' => array(
+				'function_name'    => 'some_function',
+				'message'          => 'expected the function name and message',
+				'expected_message' => 'some_function(): expected the function name and message',
+			),
+			'message is given'                    => array(
+				'function_name'    => '',
+				'message'          => 'expect only the message',
+				'expected_message' => 'expect only the message',
+			),
+			'function name is given'              => array(
+				'function_name'    => 'some_function',
+				'message'          => '',
+				'expected_message' => 'some_function(): ',
+			),
+		);
+	}
+}
diff --git a/tests/general/feedLinksExtra.php b/tests/general/feedLinksExtra.php
index d6a688da0d..3bea946e1a 100644
--- a/tests/general/feedLinksExtra.php
+++ b/tests/general/feedLinksExtra.php
@@ -172,7 +172,7 @@ class Tests_General_FeedLinksExtra extends WP_UnitTestCase {
 	 * @param array  $args {
 	 *        Optional arguments. Default empty.
 	 *
-	 *        @type string $separator     The separator between blog name and feed type.
+	 *        @type string $separator     The separator between site name and feed type.
 	 *        @type string $singletitle   The title of the comments feed.
 	 *        @type string $cattitle      The title of the category feed.
 	 *        @type string $tagtitle      The title of the tag feed.
@@ -491,14 +491,14 @@ class Tests_General_FeedLinksExtra extends WP_UnitTestCase {
 	public function test_feed_links_extra_should_respect_feed_type() {
 		add_filter(
 			'default_feed',
-			static function() {
+			static function () {
 				return 'foo';
 			}
 		);
 
 		add_filter(
 			'feed_content_type',
-			static function() {
+			static function () {
 				return 'testing/foo';
 			}
 		);
diff --git a/tests/general/template.php b/tests/general/template.php
index 8a29853526..e5b88d7d4d 100644
--- a/tests/general/template.php
+++ b/tests/general/template.php
@@ -10,6 +10,7 @@
 require_once ABSPATH . 'wp-admin/includes/class-wp-site-icon.php';
 
 class Tests_General_Template extends WP_UnitTestCase {
+
 	protected $wp_site_icon;
 	public $site_icon_id;
 	public $site_icon_url;
@@ -41,6 +42,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
+		switch_theme( 'default' );
 		$this->wp_site_icon = new WP_Site_Icon();
 	}
 
diff --git a/tests/general/wpGetArchives.php b/tests/general/wpGetArchives.php
index 5409795fd7..8d506a6bb2 100644
--- a/tests/general/wpGetArchives.php
+++ b/tests/general/wpGetArchives.php
@@ -16,13 +16,11 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 	 * @ticket 23206
 	 */
 	public function test_get_archives_cache() {
-		global $wpdb;
-
 		self::factory()->post->create_many( 3, array( 'post_type' => 'post' ) );
 		wp_cache_delete( 'last_changed', 'posts' );
 		$this->assertFalse( wp_cache_get( 'last_changed', 'posts' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is not primed, expect 1 query.
 		$result = wp_get_archives(
@@ -34,9 +32,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		$this->assertIsString( $result );
 		$time1 = wp_cache_get( 'last_changed', 'posts' );
 		$this->assertNotEmpty( $time1 );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is primed, expect no queries.
 		$result = wp_get_archives(
@@ -47,7 +45,7 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Change args, resulting in a different query string. Cache is not primed, expect 1 query.
 		$result = wp_get_archives(
@@ -59,9 +57,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is primed, expect no queries.
 		$result = wp_get_archives(
@@ -73,9 +71,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Change type. Cache is not primed, expect 1 query.
 		$result = wp_get_archives(
@@ -86,9 +84,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is primed, expect no queries.
 		$result = wp_get_archives(
@@ -99,7 +97,7 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Change type. Cache is not primed, expect 1 query.
 		$result = wp_get_archives(
@@ -110,9 +108,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is primed, expect no queries.
 		$result = wp_get_archives(
@@ -123,7 +121,7 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Change type. Cache is not primed, expect 1 query.
 		$result = wp_get_archives(
@@ -134,9 +132,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is primed, expect no queries.
 		$result = wp_get_archives(
@@ -147,7 +145,7 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Change type. Cache is not primed, expect 1 query.
 		$result = wp_get_archives(
@@ -158,9 +156,9 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Cache is primed, expect no queries.
 		$result = wp_get_archives(
@@ -171,6 +169,6 @@ class Tests_General_wpGetArchives extends WP_UnitTestCase {
 		);
 		$this->assertIsString( $result );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 }
diff --git a/tests/general/wpPreloadResources.php b/tests/general/wpPreloadResources.php
index 53fd2646a6..8648da8949 100644
--- a/tests/general/wpPreloadResources.php
+++ b/tests/general/wpPreloadResources.php
@@ -14,7 +14,7 @@ class Tests_General_wpPreloadResources extends WP_UnitTestCase {
 	 * @ticket 42438
 	 */
 	public function test_preload_resources( $expected, $preload_resources ) {
-		$callback = function () use ( $preload_resources ) {
+		$callback = static function () use ( $preload_resources ) {
 			return $preload_resources;
 		};
 
@@ -249,5 +249,4 @@ class Tests_General_wpPreloadResources extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/general/wpResourceHints.php b/tests/general/wpResourceHints.php
index 03a4c024e0..d0ece5d9ac 100644
--- a/tests/general/wpResourceHints.php
+++ b/tests/general/wpResourceHints.php
@@ -147,7 +147,6 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 		wp_dequeue_style( 'googlefonts' );
 
 		$this->assertSame( $expected, $actual );
-
 	}
 
 	public function test_dns_prefetch_scripts() {
diff --git a/tests/hooks/addFilter.php b/tests/hooks/addFilter.php
index df4db364c5..b870fdce51 100644
--- a/tests/hooks/addFilter.php
+++ b/tests/hooks/addFilter.php
@@ -35,6 +35,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 
 		$function_index = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		$this->assertSame( $callback, $hook->callbacks[ $priority ][ $function_index ]['function'] );
@@ -50,6 +51,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 
 		$function_index = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		$this->assertSame( $callback, $hook->callbacks[ $priority ][ $function_index ]['function'] );
@@ -64,6 +66,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 
 		$function_index = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		$this->assertSame( $callback, $hook->callbacks[ $priority ][ $function_index ]['function'] );
@@ -79,6 +82,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
 		$hook->add_filter( $hook_name, $callback_two, $priority, $accepted_args );
@@ -94,9 +98,11 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
 		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
+		$this->check_priority_exists( $hook, $priority + 1 );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 		$this->assertCount( 1, $hook->callbacks[ $priority + 1 ] );
 	}
@@ -109,6 +115,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
@@ -123,9 +130,11 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$accepted_args = 2;
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$this->check_priority_exists( $hook, $priority );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
 		$hook->add_filter( $hook_name, $callback, $priority + 1, $accepted_args );
+		$this->check_priority_exists( $hook, $priority + 1 );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 		$this->assertCount( 1, $hook->callbacks[ $priority + 1 ] );
 	}
@@ -141,20 +150,22 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$hook->add_filter( $hook_name, array( $b, 'action' ), 5, 1 );
 		$hook->add_filter( $hook_name, array( $c, 'action' ), 8, 1 );
 
-		$this->assertSame( array( 5, 8, 10 ), array_keys( $hook->callbacks ) );
+		$this->assertSame( array( 5, 8, 10 ), $this->get_priorities( $hook ) );
 	}
 
 	public function test_remove_and_add() {
 		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add', '__return_empty_string', 10, 0 );
-
+		$this->check_priority_exists( $this->hook, 10 );
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_add2' ), 11, 1 );
-
+		$this->check_priority_exists( $this->hook, 11 );
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_add4' ), 12, 1 );
-
+		$this->check_priority_exists( $this->hook, 12 );
 		$value = $this->hook->apply_filters( '', array() );
 
+		$this->assertSameSets( array( 10, 11, 12 ), $this->get_priorities( $this->hook ), 'The priorities should match this array' );
+
 		$this->assertSame( '24', $value );
 	}
 
@@ -162,13 +173,15 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add', '__return_empty_string', 10, 0 );
-
+		$this->check_priority_exists( $this->hook, 10 );
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_add1' ), 11, 1 );
-
+		$this->check_priority_exists( $this->hook, 11 );
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_add2' ), 12, 1 );
-
+		$this->check_priority_exists( $this->hook, 12 );
 		$value = $this->hook->apply_filters( '', array() );
 
+		$this->assertSameSets( array( 10, 11, 12 ), $this->get_priorities( $this->hook ), 'The priorities should match this array' );
+
 		$this->assertSame( '12', $value );
 	}
 
@@ -183,6 +196,8 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_add4' ), 12, 1 );
 
+		$this->assertSameSets( array( 10, 11, 12 ), $this->get_priorities( $this->hook ), 'The priorities should match this array' );
+
 		$value = $this->hook->apply_filters( '', array() );
 
 		$this->assertSame( '1-134-234', $value );
@@ -195,7 +210,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	public function _filter_remove_and_add2( $value ) {
 		$this->hook->remove_filter( 'remove_and_add', array( $this, '_filter_remove_and_add2' ), 11 );
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_add2' ), 11, 1 );
-
+		$this->check_priority_exists( $this->hook, 11 );
 		return $value . '2';
 	}
 
@@ -205,7 +220,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$value .= '-' . $this->hook->apply_filters( '', array() ) . '-';
 
 		$this->hook->add_filter( 'remove_and_add', array( $this, '_filter_remove_and_recurse_and_add2' ), 11, 1 );
-
+		$this->check_priority_exists( $this->hook, 11 );
 		return $value . '2';
 	}
 
@@ -291,4 +306,18 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	public function _action_remove_and_add4() {
 		$this->action_output .= '4';
 	}
+
+	protected function check_priority_exists( $hook, $priority ) {
+		$priorities = $this->get_priorities( $hook );
+
+		$this->assertContains( $priority, $priorities );
+	}
+
+	protected function get_priorities( $hook ) {
+		$reflection          = new ReflectionClass( $hook );
+		$reflection_property = $reflection->getProperty( 'priorities' );
+		$reflection_property->setAccessible( true );
+
+		return $reflection_property->getValue( $hook );
+	}
 }
diff --git a/tests/hooks/applyFilters.php b/tests/hooks/applyFilters.php
index f25bd08582..4c3a594aa9 100644
--- a/tests/hooks/applyFilters.php
+++ b/tests/hooks/applyFilters.php
@@ -42,5 +42,4 @@ class Tests_Hooks_ApplyFilters extends WP_UnitTestCase {
 		$this->assertSame( $returned_two, $arg );
 		$this->assertSame( 2, $a->get_call_count() );
 	}
-
 }
diff --git a/tests/hooks/removeAllFilters.php b/tests/hooks/removeAllFilters.php
index e4b0e78408..99c93ee37a 100644
--- a/tests/hooks/removeAllFilters.php
+++ b/tests/hooks/removeAllFilters.php
@@ -18,6 +18,7 @@ class Tests_Hooks_RemoveAllFilters extends WP_UnitTestCase {
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
 		$hook->remove_all_filters();
+		$this->check_priority_non_existent( $hook, $priority );
 
 		$this->assertFalse( $hook->has_filters() );
 	}
@@ -34,9 +35,30 @@ class Tests_Hooks_RemoveAllFilters extends WP_UnitTestCase {
 		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 
 		$hook->remove_all_filters( $priority );
+		$this->check_priority_non_existent( $hook, $priority );
 
 		$this->assertFalse( $hook->has_filter( $hook_name, $callback_one ) );
 		$this->assertTrue( $hook->has_filters() );
 		$this->assertSame( $priority + 1, $hook->has_filter( $hook_name, $callback_two ) );
+		$this->check_priority_exists( $hook, $priority + 1 );
+	}
+
+	protected function check_priority_non_existent( $hook, $priority ) {
+		$priorities = $this->get_priorities( $hook );
+
+		$this->assertNotContains( $priority, $priorities );
+	}
+
+	protected function check_priority_exists( $hook, $priority ) {
+		$priorities = $this->get_priorities( $hook );
+
+		$this->assertContains( $priority, $priorities );
+	}
+	protected function get_priorities( $hook ) {
+		$reflection          = new ReflectionClass( $hook );
+		$reflection_property = $reflection->getProperty( 'priorities' );
+		$reflection_property->setAccessible( true );
+
+		return $reflection_property->getValue( $hook );
 	}
 }
diff --git a/tests/hooks/removeFilter.php b/tests/hooks/removeFilter.php
index 9a6f290bde..d4b11ee9e3 100644
--- a/tests/hooks/removeFilter.php
+++ b/tests/hooks/removeFilter.php
@@ -17,6 +17,7 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->remove_filter( $hook_name, $callback, $priority );
+		$this->check_priority_non_existent( $hook, $priority );
 
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 	}
@@ -31,6 +32,7 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->remove_filter( $hook_name, $callback, $priority );
+		$this->check_priority_non_existent( $hook, $priority );
 
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 	}
@@ -44,6 +46,7 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 
 		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->remove_filter( $hook_name, $callback, $priority );
+		$this->check_priority_non_existent( $hook, $priority );
 
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 	}
@@ -62,6 +65,7 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 		$hook->remove_filter( $hook_name, $callback_one, $priority );
 
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
+		$this->check_priority_exists( $hook, $priority, 'Has priority of 2' );
 	}
 
 	public function test_remove_filter_with_another_at_different_priority() {
@@ -76,7 +80,29 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 
 		$hook->remove_filter( $hook_name, $callback_one, $priority );
+		$this->check_priority_non_existent( $hook, $priority );
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 		$this->assertCount( 1, $hook->callbacks[ $priority + 1 ] );
+		$this->check_priority_exists( $hook, $priority + 1, 'Should priority of 3' );
+	}
+
+	protected function check_priority_non_existent( $hook, $priority ) {
+		$priorities = $this->get_priorities( $hook );
+
+		$this->assertNotContains( $priority, $priorities );
+	}
+
+	protected function check_priority_exists( $hook, $priority ) {
+		$priorities = $this->get_priorities( $hook );
+
+		$this->assertContains( $priority, $priorities );
+	}
+
+	protected function get_priorities( $hook ) {
+		$reflection          = new ReflectionClass( $hook );
+		$reflection_property = $reflection->getProperty( 'priorities' );
+		$reflection_property->setAccessible( true );
+
+		return $reflection_property->getValue( $hook );
 	}
 }
diff --git a/tests/html-api/wpHtmlProcessor.php b/tests/html-api/wpHtmlProcessor.php
new file mode 100644
index 0000000000..d6b818dd44
--- /dev/null
+++ b/tests/html-api/wpHtmlProcessor.php
@@ -0,0 +1,152 @@
+<?php
+/**
+ * Unit tests covering WP_HTML_Processor functionality.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ *
+ * @since 6.4.0
+ *
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Processor
+ */
+class Tests_HtmlApi_WpHtmlProcessor extends WP_UnitTestCase {
+	/**
+	 * Ensure that the HTML Processor's public constructor function warns a developer to call
+	 * the static creator methods instead of directly instantiating a new class.
+	 *
+	 * The Tag Processor's constructor method is public and PHP doesn't allow changing the
+	 * visibility for a method on a subclass, which means that the HTML Processor must
+	 * maintain the public interface. However, constructors cannot fail to construct, so
+	 * if there are pre-conditions (such as the context node, the encoding form, and the
+	 * parsing mode with the HTML Processor) these must be handled through static factory
+	 * methods on the class.
+	 *
+	 * The HTML Processor requires a sentinel string as an optional parameter that hints
+	 * at using the static methods. In the absence of the optional parameter it instructs
+	 * the callee that it should be using those static methods instead.
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::__construct
+	 */
+	public function test_warns_that_the_static_creator_methods_should_be_called_instead_of_the_public_constructor() {
+		$this->setExpectedIncorrectUsage( 'WP_HTML_Processor::__construct' );
+
+		new WP_HTML_Processor( '<p>Light roast.</p>' );
+
+		$this->assertNotNull(
+			$this->caught_doing_it_wrong['WP_HTML_Processor::__construct'],
+			"Calling the public constructor should warn to call the static creator methods instead, but didn't."
+		);
+	}
+
+	/**
+	 * Once stepping to the end of the document, WP_HTML_Processor::get_tag
+	 * should no longer report a tag. It should report `null` because there
+	 * is no tag matched or open.
+	 *
+	 * @ticket 59167
+	 *
+	 * @covers WP_HTML_Processor::get_tag
+	 */
+	public function test_get_tag_is_null_once_document_is_finished() {
+		$p = WP_HTML_Processor::createFragment( '<div class="test">Test</div>' );
+		$p->next_tag();
+		$this->assertSame( 'DIV', $p->get_tag() );
+
+		$this->assertFalse( $p->next_tag() );
+		$this->assertNull( $p->get_tag() );
+	}
+
+	/**
+	 * Ensures that if the HTML Processor encounters inputs that it can't properly handle,
+	 * that it stops processing the rest of the document. This prevents data corruption.
+	 *
+	 * @ticket 59167
+	 *
+	 * @covers WP_HTML_Processor::next_tag
+	 */
+	public function test_stops_processing_after_unsupported_elements() {
+		$p = WP_HTML_Processor::createFragment( '<p><x-not-supported></p><p></p>' );
+		$p->next_tag( 'P' );
+		$this->assertFalse( $p->next_tag(), 'Stepped into a tag after encountering X-NOT-SUPPORTED element when it should have aborted.' );
+		$this->assertNull( $p->get_tag(), "Should have aborted processing, but still reported tag {$p->get_tag()} after properly failing to step into tag." );
+		$this->assertFalse( $p->next_tag( 'P' ), 'Stepped into normal P element after X-NOT-SUPPORTED element when it should have aborted.' );
+	}
+
+	/**
+	 * Ensures that the HTML Processor maintains its internal state through seek calls.
+	 *
+	 * Because the HTML Processor must track a stack of open elements and active formatting
+	 * elements, when it seeks to another location within its document it must adjust those
+	 * stacks, its internal state, in such a way that they remain valid after the seek.
+	 *
+	 * For instance, if currently matched inside an LI element and the Processor seeks to
+	 * an earlier location before the parent UL, then it should not report that it's still
+	 * inside an open LI element.
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::next_tag
+	 * @covers WP_HTML_Processor::seek
+	 *
+	 * @throws WP_HTML_Unsupported_Exception
+	 */
+	public function test_clear_to_navigate_after_seeking() {
+		$p = WP_HTML_Processor::createFragment( '<div one><strong></strong></div><p><strong two></strong></p>' );
+
+		while ( $p->next_tag() ) {
+			// Create a bookmark before entering a stack of elements and formatting elements.
+			if ( null !== $p->get_attribute( 'one' ) ) {
+				$this->assertTrue( $p->set_bookmark( 'one' ) );
+				continue;
+			}
+
+			// Create a bookmark inside of that stack.
+			if ( null !== $p->get_attribute( 'two' ) ) {
+				$p->set_bookmark( 'two' );
+				break;
+			}
+		}
+
+		// Ensure that it's possible to seek back to the outside location.
+		$this->assertTrue( $p->seek( 'one' ), 'Could not seek to earlier-seen location.' );
+		$this->assertSame( 'DIV', $p->get_tag(), "Should have jumped back to DIV but found {$p->get_tag()} instead." );
+
+		/*
+		 * Ensure that the P element from the inner location isn't still on the stack of open elements.
+		 * If it were, then the first STRONG element, inside the outer DIV would match the next call.
+		 */
+		$this->assertTrue( $p->next_tag( array( 'breadcrumbs' => array( 'P', 'STRONG' ) ) ), 'Failed to find given location after seeking.' );
+
+		// Only if the stack is properly managed will the processor advance to the inner STRONG element.
+		$this->assertTrue( $p->get_attribute( 'two' ), "Found the wrong location given the breadcrumbs, at {$p->get_tag()}." );
+
+		// Ensure that in seeking backwards the processor reports the correct full set of breadcrumbs.
+		$this->assertTrue( $p->seek( 'one' ), 'Failed to jump back to first bookmark.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV' ), $p->get_breadcrumbs(), 'Found wrong set of breadcrumbs navigating to node "one".' );
+
+		// Ensure that in seeking forwards the processor reports the correct full set of breadcrumbs.
+		$this->assertTrue( $p->seek( 'two' ), 'Failed to jump forward to second bookmark.' );
+		$this->assertTrue( $p->get_attribute( 'two' ), "Found the wrong location given the bookmark, at {$p->get_tag()}." );
+
+		$this->assertSame( array( 'HTML', 'BODY', 'P', 'STRONG' ), $p->get_breadcrumbs(), 'Found wrong set of bookmarks navigating to node "two".' );
+	}
+
+	/**
+	 * Ensures that support is added for reconstructing active formatting elements
+	 * before the HTML Processor handles situations with unclosed formats requiring it.
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::reconstruct_active_formatting_elements
+	 */
+	public function test_fails_to_reconstruct_formatting_elements() {
+		$p = WP_HTML_Processor::createFragment( '<p><em>One<p><em>Two<p><em>Three<p><em>Four' );
+
+		$this->assertTrue( $p->next_tag( 'EM' ), 'Could not find first EM.' );
+		$this->assertFalse( $p->next_tag( 'EM' ), 'Should have aborted before finding second EM as it required reconstructing the first EM.' );
+	}
+}
diff --git a/tests/html-api/wpHtmlProcessorBreadcrumbs.php b/tests/html-api/wpHtmlProcessorBreadcrumbs.php
new file mode 100644
index 0000000000..4f86f856e7
--- /dev/null
+++ b/tests/html-api/wpHtmlProcessorBreadcrumbs.php
@@ -0,0 +1,485 @@
+<?php
+/**
+ * Unit tests covering WP_HTML_Processor functionality.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ *
+ * @since 6.4.0
+ *
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Processor
+ */
+class Tests_HtmlApi_WpHtmlProcessorBreadcrumbs extends WP_UnitTestCase {
+	/**
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::step
+	 *
+	 * @dataProvider data_single_tag_of_supported_elements
+	 *
+	 * @param string $html     HTML with at least one tag to scan.
+	 * @param string $tag_name Name of first tag in HTML (because HTML treats IMAGE as IMG this may not match the HTML).
+	 */
+	public function test_navigates_into_normative_html_for_supported_elements( $html, $tag_name ) {
+		$p = WP_HTML_Processor::createFragment( $html );
+
+		$this->assertTrue( $p->step(), "Failed to step into supported {$tag_name} element." );
+		$this->assertSame( $tag_name, $p->get_tag(), "Misread {$tag_name} as a {$p->get_tag()} element." );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_single_tag_of_supported_elements() {
+		$supported_elements = array(
+			'A',
+			'B',
+			'BIG',
+			'BUTTON',
+			'CODE',
+			'DIV',
+			'EM',
+			'FIGCAPTION',
+			'FIGURE',
+			'FONT',
+			'I',
+			'IMG',
+			'P',
+			'SMALL',
+			'SPAN',
+			'STRIKE',
+			'STRONG',
+			'TT',
+			'U',
+		);
+
+		$data = array();
+		foreach ( $supported_elements as $tag_name ) {
+			$data[ $tag_name ] = array( "<{$tag_name}>", $tag_name );
+		}
+
+		$data['IMAGE (treated as an IMG)'] = array( '<image>', 'IMG' );
+
+		return $data;
+	}
+
+	/**
+	 * Ensures that no new HTML elements are accidentally partially-supported.
+	 *
+	 * When introducing support for new HTML elements, there are multiple places
+	 * in the HTML Processor that need to be updated, until the time that the class
+	 * has full HTML5 support. Because of this, these tests lock down the interface
+	 * to ensure that support isn't accidentally updated in one place for a new
+	 * element while overlooked in another.
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::step
+	 *
+	 * @dataProvider data_unsupported_elements
+	 *
+	 * @param string $html HTML string containing unsupported elements.
+	 */
+	public function test_fails_when_encountering_unsupported_tag( $html ) {
+		$p = WP_HTML_Processor::createFragment( $html );
+
+		$this->assertFalse( $p->step(), "Should not have stepped into unsupported {$p->get_tag()} element." );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_unsupported_elements() {
+		$unsupported_elements = array(
+			'ABBR',
+			'ACRONYM', // Neutralized
+			'ADDRESS',
+			'APPLET', // Deprecated
+			'AREA',
+			'ARTICLE',
+			'ASIDE',
+			'AUDIO',
+			'BASE',
+			'BDI',
+			'BDO',
+			'BGSOUND', // Deprecated; self-closing if self-closing flag provided, otherwise normal.
+			'BLINK', // Deprecated
+			'BODY',
+			'BR',
+			'CANVAS',
+			'CAPTION',
+			'CENTER', // Neutralized
+			'CITE',
+			'COL',
+			'COLGROUP',
+			'DATA',
+			'DATALIST',
+			'DD',
+			'DEL',
+			'DETAILS',
+			'DEFN',
+			'DIALOG',
+			'DL',
+			'DT',
+			'EMBED',
+			'FIELDSET',
+			'FOOTER',
+			'FORM',
+			'FRAME',
+			'FRAMESET',
+			'H1',
+			'H2',
+			'H3',
+			'H4',
+			'H5',
+			'H6',
+			'HEAD',
+			'HEADER',
+			'HGROUP',
+			'HR',
+			'HTML',
+			'IFRAME',
+			'INPUT',
+			'INS',
+			'ISINDEX', // Deprecated
+			'KBD',
+			'KEYGEN', // Deprecated; void
+			'LABEL',
+			'LEGEND',
+			'LI',
+			'LINK',
+			'LISTING', // Deprecated, use PRE instead.
+			'MAIN',
+			'MAP',
+			'MARK',
+			'MARQUEE', // Deprecated
+			'MATH',
+			'MENU',
+			'META',
+			'METER',
+			'MULTICOL', // Deprecated
+			'NAV',
+			'NEXTID', // Deprecated
+			'NOBR', // Neutralized
+			'NOEMBED', // Neutralized
+			'NOFRAMES', // Neutralized
+			'NOSCRIPT',
+			'OBJECT',
+			'OL',
+			'OPTGROUP',
+			'OPTION',
+			'OUTPUT',
+			'PICTURE',
+			'PLAINTEXT', // Neutralized
+			'PRE',
+			'PROGRESS',
+			'Q',
+			'RB', // Neutralized
+			'RP',
+			'RT',
+			'RTC', // Neutralized
+			'RUBY',
+			'SAMP',
+			'SCRIPT',
+			'SECTION',
+			'SELECT',
+			'SLOT',
+			'SOURCE',
+			'SPACER', // Deprecated
+			'STYLE',
+			'SUB',
+			'SUMMARY',
+			'SUP',
+			'SVG',
+			'TABLE',
+			'TBODY',
+			'TD',
+			'TEMPLATE',
+			'TEXTAREA',
+			'TFOOT',
+			'TH',
+			'THEAD',
+			'TIME',
+			'TITLE',
+			'TR',
+			'TRACK',
+			'UL',
+			'VAR',
+			'VIDEO',
+			'WBR',
+			'XMP', // Deprecated, use PRE instead.
+
+			// Made up elements, custom elements.
+			'X-NOT-AN-HTML-ELEMENT',
+			'HUMAN-TIME',
+		);
+
+		$data = array();
+		foreach ( $unsupported_elements as $tag_name ) {
+			$data[ $tag_name ] = array( "<{$tag_name}>" );
+		}
+
+		return $data;
+	}
+
+	/**
+	 * @ticket 58517
+	 *
+	 * @dataProvider data_unsupported_markup
+	 *
+	 * @param string $html HTML containing unsupported markup.
+	 */
+	public function test_fails_when_encountering_unsupported_markup( $html, $description ) {
+		$p = WP_HTML_Processor::createFragment( $html );
+
+		while ( $p->step() && null === $p->get_attribute( 'supported' ) ) {
+			continue;
+		}
+
+		$this->assertTrue( $p->get_attribute( 'supported' ), 'Did not find required supported element.' );
+		$this->assertFalse( $p->step(), "Didn't properly reject unsupported markup: {$description}" );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_unsupported_markup() {
+		return array(
+			'A with formatting following unclosed A' => array(
+				'<a><strong>Click <a supported><big unsupported>Here</big></a></strong></a>',
+				'Unclosed formatting requires complicated reconstruction.',
+			),
+
+			'A after unclosed A inside DIV'          => array(
+				'<a><div supported><a unsupported></div></a>',
+				'A is a formatting element, which requires more complicated reconstruction.',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::next_tag
+	 *
+	 * @dataProvider data_html_target_with_breadcrumbs
+	 *
+	 * @param string $html        HTML string with tags in it, one of which contains the "target" attribute.
+	 * @param array  $breadcrumbs Breadcrumbs of element with "target" attribute set.
+	 * @param int    $n           How many breadcrumb matches to scan through in order to find "target" element.
+	 */
+	public function test_finds_correct_tag_given_breadcrumbs( $html, $breadcrumbs, $n ) {
+		$p = WP_HTML_Processor::createFragment( $html );
+
+		$p->next_tag(
+			array(
+				'breadcrumbs'  => $breadcrumbs,
+				'match_offset' => $n,
+			)
+		);
+
+		$this->assertNotNull( $p->get_tag(), 'Failed to find target node.' );
+		$this->assertTrue( $p->get_attribute( 'target' ), "Found {$p->get_tag()} element didn't contain the necessary 'target' attribute." );
+	}
+
+	/**
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::get_breadcrumbs
+	 *
+	 * @dataProvider data_html_target_with_breadcrumbs
+	 *
+	 * @param string $html        HTML string with tags in it, one of which contains the "target" attribute.
+	 * @param array  $breadcrumbs Breadcrumbs of element with "target" attribute set.
+	 * @param int    $ignored_n   Not used in this test but provided in the dataset for other tests.
+	 * @return void
+	 */
+	public function test_reports_correct_breadcrumbs_for_html( $html, $breadcrumbs, $ignored_n ) {
+		$p = WP_HTML_Processor::createFragment( $html );
+
+		while ( $p->next_tag() && null === $p->get_attribute( 'target' ) ) {
+			continue;
+		}
+
+		$this->assertNotNull( $p->get_tag(), 'Failed to find the target node.' );
+		$this->assertSame( $breadcrumbs, $p->get_breadcrumbs(), 'Found the wrong path from the root of the HTML document to the target node.' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_html_target_with_breadcrumbs() {
+		return array(
+			'Simple IMG tag'                        => array( '<img target>', array( 'HTML', 'BODY', 'IMG' ), 1 ),
+			'Two sibling IMG tags'                  => array( '<img><img target>', array( 'HTML', 'BODY', 'IMG' ), 2 ),
+			'Three sibling IMG tags, an IMAGE in last place' => array( '<img><img><image target>', array( 'HTML', 'BODY', 'IMG' ), 3 ),
+			'IMG inside a DIV'                      => array( '<div><img target></div>', array( 'HTML', 'BODY', 'DIV', 'IMG' ), 1 ),
+			'DIV inside a DIV'                      => array( '<div><div target></div>', array( 'HTML', 'BODY', 'DIV', 'DIV' ), 1 ),
+			'IMG inside many DIVS'                  => array( '<div><div><div><div><img target></div></div></div></div>', array( 'HTML', 'BODY', 'DIV', 'DIV', 'DIV', 'DIV', 'IMG' ), 1 ),
+			'DIV inside DIV after IMG'              => array( '<div><img><div target></div></div>', array( 'HTML', 'BODY', 'DIV', 'DIV' ), 1 ),
+			'IMG after DIV'                         => array( '<div></div><img target>', array( 'HTML', 'BODY', 'IMG' ), 1 ),
+			'IMG after two DIVs'                    => array( '<div></div><div></div><img target>', array( 'HTML', 'BODY', 'IMG' ), 1 ),
+			'IMG after two DIVs with nesting'       => array( '<div><div><img></div></div><div></div><img target>', array( 'HTML', 'BODY', 'IMG' ), 1 ),
+			'IMG after invalid DIV closer'          => array( '</div><img target>', array( 'HTML', 'BODY', 'IMG' ), 1 ),
+			'EM inside DIV'                         => array( '<div>The weather is <em target>beautiful</em>.</div>', array( 'HTML', 'BODY', 'DIV', 'EM' ), 1 ),
+			'EM after closed EM'                    => array( '<em></em><em target></em>', array( 'HTML', 'BODY', 'EM' ), 2 ),
+			'EM after closed EMs'                   => array( '<em></em><em><em></em></em><em></em><em></em><em target></em>', array( 'HTML', 'BODY', 'EM' ), 6 ),
+			'EM after unclosed EM'                  => array( '<em><em target></em>', array( 'HTML', 'BODY', 'EM', 'EM' ), 1 ),
+			'EM after unclosed EM after DIV'        => array( '<em><div><em target>', array( 'HTML', 'BODY', 'EM', 'DIV', 'EM' ), 1 ),
+			// This should work for all formatting elements, but if two work, the others probably do too.
+			'CODE after unclosed CODE after DIV'    => array( '<code><div><code target>', array( 'HTML', 'BODY', 'CODE', 'DIV', 'CODE' ), 1 ),
+			'P after unclosed P'                    => array( '<p><p target>', array( 'HTML', 'BODY', 'P' ), 2 ),
+			'Unclosed EM inside P after unclosed P' => array( '<em><p><p><em target>', array( 'HTML', 'BODY', 'EM', 'P', 'EM' ), 1 ),
+			'P after closed P'                      => array( '<p><i>something</i></p><p target>This one</p>', array( 'HTML', 'BODY', 'P' ), 2 ),
+			'A after unclosed A'                    => array( '<a><a target>', array( 'HTML', 'BODY', 'A' ), 2 ),
+			'A after unclosed A, after a P'         => array( '<p><a><a target>', array( 'HTML', 'BODY', 'P', 'A' ), 2 ),
+			// This one adds a test at a deep stack depth to ensure things work for situations beyond short test docs.
+			'Large HTML document with deep P'       => array(
+				'<div><div><div><div><div><div><div><div><p></p><p></p><p><div><strong><em><code></code></em></strong></div></p></div></div></div></div></div></div></div></div><div><div><div><div><div><div><div><div><p></p><p></p><p><div><strong><em><code target></code></em></strong></div></p></div></div></div></div></div></div></div></div>',
+				array( 'HTML', 'BODY', 'DIV', 'DIV', 'DIV', 'DIV', 'DIV', 'DIV', 'DIV', 'DIV', 'DIV', 'STRONG', 'EM', 'CODE' ),
+				2,
+			),
+		);
+	}
+
+	/**
+	 * @ticket 59400
+	 *
+	 * @dataProvider data_html_with_breadcrumbs_of_various_specificity
+	 *
+	 * @param string   $html_with_target_node HTML with a node containing a "target" attribute.
+	 * @param string[] $breadcrumbs           Breadcrumbs to test at the target node.
+	 * @param bool     $should_match          Whether the target node should match the breadcrumbs.
+	 */
+	public function test_reports_if_tag_matches_breadcrumbs_of_various_specificity( $html_with_target_node, $breadcrumbs, $should_match ) {
+		$processor = WP_HTML_Processor::createFragment( $html_with_target_node );
+		while ( $processor->next_tag() && null === $processor->get_attribute( 'target' ) ) {
+			continue;
+		}
+
+		$matches = $processor->matches_breadcrumbs( $breadcrumbs );
+		$path    = implode( ', ', $breadcrumbs );
+		if ( $should_match ) {
+			$this->assertTrue( $matches, "HTML tag {$processor->get_tag()} should have matched breadcrumbs but didn't: {$path}." );
+		} else {
+			$this->assertFalse( $matches, "HTML tag {$processor->get_tag()} should not have matched breadcrumbs but did: {$path}." );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[].
+	 */
+	public function data_html_with_breadcrumbs_of_various_specificity() {
+		return array(
+			// Test with void elements.
+			'Inner IMG'                      => array( '<div><span><figure><img target></figure></span></div>', array( 'span', 'figure', 'img' ), true ),
+			'Inner IMG wildcard'             => array( '<div><span><figure><img target></figure></span></div>', array( 'span', '*', 'img' ), true ),
+			'Inner IMG no wildcard'          => array( '<div><span><figure><img target></figure></span></div>', array( 'span', 'img' ), false ),
+			'Full specification'             => array( '<div><span><figure><img target></figure></span></div>', array( 'html', 'body', 'div', 'span', 'figure', 'img' ), true ),
+			'Invalid Full specification'     => array( '<div><span><figure><img target></figure></span></div>', array( 'html', 'div', 'span', 'figure', 'img' ), false ),
+
+			// Test also with non-void elements that open and close.
+			'Inner P'                        => array( '<div><span><figure><p target></figure></span></div>', array( 'span', 'figure', 'p' ), true ),
+			'Inner P wildcard'               => array( '<div><span><figure><p target></figure></span></div>', array( 'span', '*', 'p' ), true ),
+			'Inner P no wildcard'            => array( '<div><span><figure><p target></figure></span></div>', array( 'span', 'p' ), false ),
+			'Full specification (P)'         => array( '<div><span><figure><p target></figure></span></div>', array( 'html', 'body', 'div', 'span', 'figure', 'p' ), true ),
+			'Invalid Full specification (P)' => array( '<div><span><figure><p target></figure></span></div>', array( 'html', 'div', 'span', 'figure', 'p' ), false ),
+
+			// Ensure that matches aren't on tag closers.
+			'Inner P'                        => array( '<div><span><figure></p target></figure></span></div>', array( 'span', 'figure', 'p' ), false ),
+			'Inner P wildcard'               => array( '<div><span><figure></p target></figure></span></div>', array( 'span', '*', 'p' ), false ),
+			'Inner P no wildcard'            => array( '<div><span><figure></p target></figure></span></div>', array( 'span', 'p' ), false ),
+			'Full specification (P)'         => array( '<div><span><figure></p target></figure></span></div>', array( 'html', 'body', 'div', 'span', 'figure', 'p' ), false ),
+			'Invalid Full specification (P)' => array( '<div><span><figure></p target></figure></span></div>', array( 'html', 'div', 'span', 'figure', 'p' ), false ),
+
+			// Test wildcard behaviors.
+			'Single wildcard element'        => array( '<figure><code><div><p><span><img target></span></p></div></code></figure>', array( '*' ), true ),
+			'Child of wildcard element'      => array( '<figure><code><div><p><span><img target></span></p></div></code></figure>', array( 'SPAN', '*' ), true ),
+		);
+	}
+
+	/**
+	 * Ensures that the ability to set attributes isn't broken by the HTML Processor.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::set_attribute
+	 */
+	public function test_can_modify_attributes_after_finding_tag() {
+		$p = WP_HTML_Processor::createFragment( '<div><figure><img><figcaption>test</figcaption></figure>' );
+
+		$this->assertTrue( $p->next_tag( array( 'breadcrumbs' => array( 'figcaption' ) ) ), 'Unable to find given tag.' );
+
+		$p->set_attribute( 'found-it', true );
+		$this->assertSame( '<div><figure><img><figcaption found-it>test</figcaption></figure>', $p->get_updated_html() );
+	}
+
+	/**
+	 * Ensures that the ability to scan for a given tag name isn't broken by the HTML Processor.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::next_tag
+	 */
+	public function test_can_query_an_element_by_tag_name() {
+		$p = WP_HTML_Processor::createFragment( '<div><DIV><strong><img></strong></DIV>' );
+		$p->next_tag( 'IMG' );
+		$p->set_attribute( 'loading', 'lazy' );
+
+		$this->assertSame( '<div><DIV><strong><img loading="lazy"></strong></DIV>', $p->get_updated_html() );
+	}
+
+	/**
+	 * Ensures that basic seeking behavior isn't broken by the HTML Processor.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Processor::seek
+	 */
+	public function test_can_seek_back_and_forth() {
+		$p = WP_HTML_Processor::createFragment( '<div><p one><div><p><div two><p><div><p><div><p three>' );
+
+		// Find first tag of interest.
+		while ( $p->next_tag() && null === $p->get_attribute( 'one' ) ) {
+			continue;
+		}
+		$p->set_bookmark( 'first' );
+
+		// Find second tag of interest.
+		while ( $p->next_tag() && null === $p->get_attribute( 'two' ) ) {
+			continue;
+		}
+		$p->set_bookmark( 'second' );
+
+		// Find third tag of interest.
+		while ( $p->next_tag() && null === $p->get_attribute( 'three' ) ) {
+			continue;
+		}
+		$p->set_bookmark( 'third' );
+
+		// Seek backwards.
+		$p->seek( 'first' );
+
+		// Seek forwards. If the current token isn't also updated this could appear like a backwards seek.
+		$p->seek( 'second' );
+		$this->assertTrue( $p->get_attribute( 'two' ) );
+	}
+}
diff --git a/tests/html-api/wpHtmlProcessorSemanticRules.php b/tests/html-api/wpHtmlProcessorSemanticRules.php
new file mode 100644
index 0000000000..8fd3661ea0
--- /dev/null
+++ b/tests/html-api/wpHtmlProcessorSemanticRules.php
@@ -0,0 +1,189 @@
+<?php
+/**
+ * Unit tests covering WP_HTML_Processor compliance with HTML5 semantic parsing rules.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ *
+ * @since 6.4.0
+ *
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Processor
+ */
+class Tests_HtmlApi_WpHtmlProcessorSemanticRules extends WP_UnitTestCase {
+	/*******************************************************************
+	 * RULES FOR "IN BODY" MODE
+	 *******************************************************************/
+
+	/**
+	 * Verifies that when encountering an end tag for which there is no corresponding
+	 * element in scope, that it skips the tag entirely.
+	 *
+	 * @ticket 58961
+	 *
+	 * @since 6.4.0
+	 *
+	 * @throws Exception
+	 */
+	public function test_in_body_skips_unexpected_button_closer() {
+		$p = WP_HTML_Processor::createFragment( '<div>Test</button></div>' );
+
+		$p->step();
+		$this->assertEquals( 'DIV', $p->get_tag(), 'Did not stop at initial DIV tag.' );
+		$this->assertFalse( $p->is_tag_closer(), 'Did not find that initial DIV tag is an opener.' );
+
+		/*
+		 * When encountering the BUTTON closing tag, there is no BUTTON in the stack of open elements.
+		 * It should be ignored as there's no BUTTON to close.
+		 */
+		$this->assertTrue( $p->step(), 'Found no further tags when it should have found the closing DIV' );
+		$this->assertEquals( 'DIV', $p->get_tag(), "Did not skip unexpected BUTTON; stopped at {$p->get_tag()}." );
+		$this->assertTrue( $p->is_tag_closer(), 'Did not find that the terminal DIV tag is a closer.' );
+	}
+
+	/**
+	 * Verifies insertion of a BUTTON element when no existing BUTTON is already in scope.
+	 *
+	 * @ticket 58961
+	 *
+	 * @since 6.4.0
+	 *
+	 * @throws WP_HTML_Unsupported_Exception
+	 */
+	public function test_in_body_button_with_no_button_in_scope() {
+		$p = WP_HTML_Processor::createFragment( '<div><p>Click the button <button one>here</button>!</p></div><button two>not here</button>' );
+
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected first button.' );
+		$this->assertTrue( $p->get_attribute( 'one' ), 'Failed to match expected attribute on first button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'P', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for first button.' );
+
+		/*
+		 * There's nothing special about this HTML construction, but it's important to verify that
+		 * the HTML Processor can find a BUTTON under normal and normative scenarios, not just the
+		 * malformed and unexpected ones.
+		 */
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected second button.' );
+		$this->assertTrue( $p->get_attribute( 'two' ), 'Failed to match expected attribute on second button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for second button.' );
+	}
+
+	/**
+	 * Verifies what when inserting a BUTTON element, when a BUTTON is already in scope,
+	 * that the open button is closed with all other elements inside of it.
+	 *
+	 * @ticket 58961
+	 *
+	 * @since 6.4.0
+	 *
+	 * @throws WP_HTML_Unsupported_Exception
+	 */
+	public function test_in_body_button_with_button_in_scope_as_parent() {
+		$p = WP_HTML_Processor::createFragment( '<div><p>Click the button <button one>almost<button two>here</button>!</p></div><button three>not here</button>' );
+
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected first button.' );
+		$this->assertTrue( $p->get_attribute( 'one' ), 'Failed to match expected attribute on first button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'P', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for first button.' );
+
+		/*
+		 * A naive parser might skip the second BUTTON because it's looking for the close of the first one,
+		 * or it may place it as a child of the first one, but it implicitly closes the open BUTTON.
+		 */
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected second button.' );
+		$this->assertTrue( $p->get_attribute( 'two' ), 'Failed to match expected attribute on second button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'P', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for second button.' );
+
+		/*
+		 * This is another form of the test for the second button, but from a different side. The test is
+		 * looking for proper handling of the open and close sequence for the BUTTON tags.
+		 */
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected third button.' );
+		$this->assertTrue( $p->get_attribute( 'three' ), 'Failed to match expected attribute on third button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for third button.' );
+	}
+
+	/**
+	 * Verifies what when inserting a BUTTON element, when a BUTTON is already in scope,
+	 * that the open button is closed with all other elements inside of it, even if the
+	 * BUTTON in scope is not a direct parent of the new BUTTON element.
+	 *
+	 * @ticket 58961
+	 *
+	 * @since 6.4.0
+	 *
+	 * @throws WP_HTML_Unsupported_Exception
+	 */
+	public function test_in_body_button_with_button_in_scope_as_ancestor() {
+		$p = WP_HTML_Processor::createFragment( '<div><button one><p>Click the button <span><button two>here</button>!</span></p></div><button three>not here</button>' );
+
+		// This button finds itself normally nesting inside the DIV.
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected first button.' );
+		$this->assertTrue( $p->get_attribute( 'one' ), 'Failed to match expected attribute on first button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for first button.' );
+
+		/*
+		 * Because the second button appears while a BUTTON is in scope, it generates implied end tags and closes
+		 * the BUTTON, P, and SPAN elements. It looks like the BUTTON is inside the SPAN, but it's another case
+		 * of an unexpected closing SPAN tag because the SPAN was closed by the second BUTTON. This element finds
+		 * itself a child of the most-recent open element above the most-recent BUTTON, or the DIV.
+		 */
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected second button.' );
+		$this->assertTrue( $p->get_attribute( 'two' ), 'Failed to match expected attribute on second button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for second button.' );
+
+		// The third button is back to normal, because everything has been implicitly or explicitly closed by now.
+		$this->assertTrue( $p->next_tag( 'BUTTON' ), 'Could not find expected third button.' );
+		$this->assertTrue( $p->get_attribute( 'three' ), 'Failed to match expected attribute on third button.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'BUTTON' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting for third button.' );
+	}
+
+	/*
+	 * Verifies that when "in body" and encountering "any other end tag"
+	 * that the HTML processor ignores the end tag if there's a special
+	 * element on the stack of open elements before the matching opening.
+	 *
+	 * @ticket 58907
+	 *
+	 * @since 6.4.0
+	 *
+	 * @covers WP_HTML_Processor::step_in_body
+	 */
+	public function test_in_body_any_other_end_tag_with_unclosed_special_element() {
+		$p = WP_HTML_Processor::createFragment( '<div><span><p></span><div>' );
+
+		$p->next_tag( 'P' );
+		$this->assertSame( 'P', $p->get_tag(), "Expected to start test on P element but found {$p->get_tag()} instead." );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'SPAN', 'P' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting.' );
+
+		$this->assertTrue( $p->next_tag(), 'Failed to advance past P tag to expected DIV opener.' );
+		$this->assertSame( 'DIV', $p->get_tag(), "Expected to find DIV element, but found {$p->get_tag()} instead." );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'SPAN', 'DIV' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting: SPAN should still be open and DIV should be its child.' );
+	}
+
+	/*
+	 * Verifies that when "in body" and encountering "any other end tag"
+	 * that the HTML processor closes appropriate elements on the stack of
+	 * open elements up to the matching opening.
+	 *
+	 * @ticket 58907
+	 *
+	 * @since 6.4.0
+	 *
+	 * @covers WP_HTML_Processor::step_in_body
+	 */
+	public function test_in_body_any_other_end_tag_with_unclosed_non_special_element() {
+		$p = WP_HTML_Processor::createFragment( '<div><span><code></span><div>' );
+
+		$p->next_tag( 'CODE' );
+		$this->assertSame( 'CODE', $p->get_tag(), "Expected to start test on CODE element but found {$p->get_tag()} instead." );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'SPAN', 'CODE' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting.' );
+
+		$this->assertTrue( $p->step(), 'Failed to advance past CODE tag to expected SPAN closer.' );
+		$this->assertTrue( $p->is_tag_closer(), 'Expected to find closing SPAN, but found opener instead.' );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV' ), $p->get_breadcrumbs(), 'Failed to advance past CODE tag to expected DIV opener.' );
+
+		$this->assertTrue( $p->next_tag(), 'Failed to advance past SPAN closer to expected DIV opener.' );
+		$this->assertSame( 'DIV', $p->get_tag(), "Expected to find DIV element, but found {$p->get_tag()} instead." );
+		$this->assertSame( array( 'HTML', 'BODY', 'DIV', 'DIV' ), $p->get_breadcrumbs(), 'Failed to produce expected DOM nesting: SPAN should be closed and DIV should be its sibling.' );
+	}
+}
diff --git a/tests/html-api/wpHtmlSupportRequiredHtmlProcessor.php b/tests/html-api/wpHtmlSupportRequiredHtmlProcessor.php
new file mode 100644
index 0000000000..b9dbbc8cb8
--- /dev/null
+++ b/tests/html-api/wpHtmlSupportRequiredHtmlProcessor.php
@@ -0,0 +1,101 @@
+<?php
+/**
+ * Unit tests for the HTML API indicating that changes are needed to the
+ * WP_HTML_Processor class before specific features are added to the API.
+ *
+ * Note! Duplication of test cases and the helper function in this file are intentional.
+ * This test file exists to warn developers of related areas of code that need to update
+ * together when adding support for new elements to the HTML Processor. For example,
+ * when adding support for the LI element it's necessary to update the function which
+ * generates implied end tags. This is because each element might bring with it semantic
+ * rules that impact the way the document should be parsed.
+ *
+ * Without these tests a developer needs to investigate all possible places they
+ * might need to update when adding support for more elements and risks overlooking
+ * important parts that, in the absence of the related support, will lead to errors.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ *
+ * @since 6.4.0
+ *
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Processor
+ */
+class Tests_HtmlApi_WpHtmlSupportRequiredHtmlProcessor extends WP_UnitTestCase {
+	/**
+	 * Fails to assert if the HTML Processor handles the given tag.
+	 *
+	 * This test helper is used throughout this test file for one purpose only: to
+	 * fail a test if the HTML Processor handles the given tag. In other words, it
+	 * ensures that the HTML Processor aborts when encountering the given tag.
+	 *
+	 * This is used to ensure that when support for a new tag is added to the
+	 * HTML Processor it receives full support and not partial support, which
+	 * could lead to a variety of issues.
+	 *
+	 * Do not remove this helper function as it provides semantic meaning to the
+	 * assertions in the tests in this file and its behavior is incredibly specific
+	 * and limited and doesn't warrant adding a new abstraction into WP_UnitTestCase.
+	 *
+	 * @param string $tag_name the HTML Processor should abort when encountering this tag, e.g. "BUTTON".
+	 */
+	private function ensure_support_is_added_everywhere( $tag_name ) {
+		$p = WP_HTML_Processor::createFragment( "<$tag_name>" );
+
+		$this->assertFalse( $p->step(), "Must support terminating elements in specific scope check before adding support for the {$tag_name} element." );
+	}
+
+	/**
+	 * Generating implied end tags walks up the stack of open elements
+	 * as long as any of the following missing elements is the current node.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58907
+	 *
+	 * @covers WP_HTML_Processor::generate_implied_end_tags
+	 */
+	public function test_generate_implied_end_tags_needs_support() {
+		$this->ensure_support_is_added_everywhere( 'DD' );
+		$this->ensure_support_is_added_everywhere( 'DT' );
+		$this->ensure_support_is_added_everywhere( 'LI' );
+		$this->ensure_support_is_added_everywhere( 'OPTGROUP' );
+		$this->ensure_support_is_added_everywhere( 'OPTION' );
+		$this->ensure_support_is_added_everywhere( 'RB' );
+		$this->ensure_support_is_added_everywhere( 'RP' );
+		$this->ensure_support_is_added_everywhere( 'RT' );
+		$this->ensure_support_is_added_everywhere( 'RTC' );
+	}
+
+	/**
+	 * Generating implied end tags thoroughly walks up the stack of open elements
+	 * as long as any of the following missing elements is the current node.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58907
+	 *
+	 * @covers WP_HTML_Processor::generate_implied_end_tags_thoroughly
+	 */
+	public function test_generate_implied_end_tags_thoroughly_needs_support() {
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'COLGROUP' );
+		$this->ensure_support_is_added_everywhere( 'DD' );
+		$this->ensure_support_is_added_everywhere( 'DT' );
+		$this->ensure_support_is_added_everywhere( 'LI' );
+		$this->ensure_support_is_added_everywhere( 'OPTGROUP' );
+		$this->ensure_support_is_added_everywhere( 'OPTION' );
+		$this->ensure_support_is_added_everywhere( 'RB' );
+		$this->ensure_support_is_added_everywhere( 'RP' );
+		$this->ensure_support_is_added_everywhere( 'RT' );
+		$this->ensure_support_is_added_everywhere( 'RTC' );
+		$this->ensure_support_is_added_everywhere( 'TBODY' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TFOOT' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'HEAD' );
+		$this->ensure_support_is_added_everywhere( 'TR' );
+	}
+}
diff --git a/tests/html-api/wpHtmlSupportRequiredOpenElements.php b/tests/html-api/wpHtmlSupportRequiredOpenElements.php
new file mode 100644
index 0000000000..afc619a869
--- /dev/null
+++ b/tests/html-api/wpHtmlSupportRequiredOpenElements.php
@@ -0,0 +1,358 @@
+<?php
+/**
+ * Unit tests for the HTML API indicating that changes are needed to the
+ * WP_HTML_Open_Elements class before specific features are added to the API.
+ *
+ * Note! Duplication of test cases and the helper function in this file are intentional.
+ * This test file exists to warn developers of related areas of code that need to update
+ * together when adding support for new elements to the HTML Processor. For example,
+ * when adding support for the BUTTON element it's necessary to update multiple methods
+ * in the class governing the stack of open elements as well as the HTML Processor class
+ * itself. This is because each element might bring with it semantic rules that impact
+ * the way the document should be parsed. BUTTON creates a kind of boundary in the
+ * DOM tree and implicitly closes existing open BUTTON elements.
+ *
+ * Without these tests a developer needs to investigate all possible places they
+ * might need to update when adding support for more elements and risks overlooking
+ * important parts that, in the absence of the related support, will lead to errors.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ *
+ * @since 6.4.0
+ *
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Processor
+ */
+class Tests_HtmlApi_WpHtmlSupportRequiredOpenElements extends WP_UnitTestCase {
+	/**
+	 * Fails to assert if the HTML Processor handles the given tag.
+	 *
+	 * This test helper is used throughout this test file for one purpose only: to
+	 * fail a test if the HTML Processor handles the given tag. In other words, it
+	 * ensures that the HTML Processor aborts when encountering the given tag.
+	 *
+	 * This is used to ensure that when support for a new tag is added to the
+	 * HTML Processor it receives full support and not partial support, which
+	 * could lead to a variety of issues.
+	 *
+	 * Do not remove this helper function as it provides semantic meaning to the
+	 * assertions in the tests in this file and its behavior is incredibly specific
+	 * and limited and doesn't warrant adding a new abstraction into WP_UnitTestCase.
+	 *
+	 * @param string $tag_name the HTML Processor should abort when encountering this tag, e.g. "BUTTON".
+	 */
+	private function ensure_support_is_added_everywhere( $tag_name ) {
+		$p = WP_HTML_Processor::createFragment( "<$tag_name>" );
+
+		$this->assertFalse( $p->step(), "Must support terminating elements in specific scope check before adding support for the {$tag_name} element." );
+	}
+
+	/**
+	 * The check for whether an element is in a scope depends on
+	 * looking for a number of terminating elements in the stack of open
+	 * elements. Until the listed elements are supported in the HTML
+	 * processor, there are no terminating elements and there's no
+	 * point in taking the time to look for them.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 */
+	public function test_has_element_in_scope_needs_support() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+	}
+
+	/**
+	 * The check for whether an element is in list item scope depends on
+	 * the elements for any scope, plus UL and OL.
+	 *
+	 * The method for asserting list item scope doesn't currently exist
+	 * because the LI element isn't yet supported and the LI element is
+	 * the only element that needs to know about list item scope.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Open_Elements::has_element_in_list_item_scope
+	 */
+	public function test_has_element_in_list_item_scope_needs_support() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+
+		// These elements are specific to list item scope.
+		$this->ensure_support_is_added_everywhere( 'OL' );
+		$this->ensure_support_is_added_everywhere( 'UL' );
+
+		// This element is the only element that depends on list item scope.
+		$this->ensure_support_is_added_everywhere( 'LI' );
+	}
+
+	/**
+	 * The check for whether an element is in BUTTON scope depends on
+	 * the elements for any scope, plus BUTTON.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Open_Elements::has_element_in_button_scope
+	 */
+	public function test_has_element_in_button_scope_needs_support() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+	}
+
+	/**
+	 * The optimization maintaining a flag for "P is in BUTTON scope" requires
+	 * updating that flag every time an element is popped from the stack of
+	 * open elements.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Open_Elements::after_element_pop
+	 */
+	public function test_after_element_pop_must_maintain_p_in_button_scope_flag() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+	}
+
+	/**
+	 * The optimization maintaining a flag for "P is in BUTTON scope" requires
+	 * updating that flag every time an element is pushed onto the stack of
+	 * open elements.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Open_Elements::after_element_push
+	 */
+	public function test_after_element_push_must_maintain_p_in_button_scope_flag() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+	}
+
+	/**
+	 * The check for whether an element is in TABLE scope depends on
+	 * the HTML, TABLE, and TEMPLATE elements.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Open_Elements::has_element_in_table_scope
+	 */
+	public function test_has_element_in_table_scope_needs_support() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+
+		// These elements are specific to TABLE scope.
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// These elements depend on table scope.
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'COL' );
+		$this->ensure_support_is_added_everywhere( 'COLGROUP' );
+		$this->ensure_support_is_added_everywhere( 'TBODY' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TFOOT' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'THEAD' );
+		$this->ensure_support_is_added_everywhere( 'TR' );
+	}
+
+	/**
+	 * The check for whether an element is in SELECT scope depends on
+	 * the OPTGROUP and OPTION elements.
+	 *
+	 * @since 6.4.0
+	 *
+	 * @ticket 58517
+	 *
+	 * @covers WP_HTML_Open_Elements::has_element_in_select_scope
+	 */
+	public function test_has_element_in_select_scope_needs_support() {
+		// These elements impact all scopes.
+		$this->ensure_support_is_added_everywhere( 'APPLET' );
+		$this->ensure_support_is_added_everywhere( 'CAPTION' );
+		$this->ensure_support_is_added_everywhere( 'HTML' );
+		$this->ensure_support_is_added_everywhere( 'TABLE' );
+		$this->ensure_support_is_added_everywhere( 'TD' );
+		$this->ensure_support_is_added_everywhere( 'TH' );
+		$this->ensure_support_is_added_everywhere( 'MARQUEE' );
+		$this->ensure_support_is_added_everywhere( 'OBJECT' );
+		$this->ensure_support_is_added_everywhere( 'TEMPLATE' );
+
+		// MathML Elements
+		$this->ensure_support_is_added_everywhere( 'MI' );
+		$this->ensure_support_is_added_everywhere( 'MO' );
+		$this->ensure_support_is_added_everywhere( 'MN' );
+		$this->ensure_support_is_added_everywhere( 'MS' );
+		$this->ensure_support_is_added_everywhere( 'MTEXT' );
+		$this->ensure_support_is_added_everywhere( 'ANNOTATION-XML' );
+
+		/*
+		 * SVG elements: note that TITLE is both an HTML element and an SVG element
+		 * so care must be taken when adding support for either one.
+		 */
+		$this->ensure_support_is_added_everywhere( 'FOREIGNOBJECT' );
+		$this->ensure_support_is_added_everywhere( 'DESC' );
+		$this->ensure_support_is_added_everywhere( 'TITLE' );
+
+		// These elements are specific to SELECT scope.
+		$this->ensure_support_is_added_everywhere( 'OPTGROUP' );
+		$this->ensure_support_is_added_everywhere( 'OPTION' );
+	}
+}
diff --git a/tests/html-api/wpHtmlTagProcessor-bookmark.php b/tests/html-api/wpHtmlTagProcessor-bookmark.php
index 1bbbe02021..90adfb20be 100644
--- a/tests/html-api/wpHtmlTagProcessor-bookmark.php
+++ b/tests/html-api/wpHtmlTagProcessor-bookmark.php
@@ -11,7 +11,7 @@
  *
  * @coversDefaultClass WP_HTML_Tag_Processor
  */
-class Tests_HtmlApi_wpHtmlTagProcessor_Bookmark extends WP_UnitTestCase {
+class Tests_HtmlApi_WpHtmlTagProcessor_Bookmark extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56299
diff --git a/tests/html-api/wpHtmlTagProcessor.php b/tests/html-api/wpHtmlTagProcessor.php
index 6b0c263c5d..4469f90c4f 100644
--- a/tests/html-api/wpHtmlTagProcessor.php
+++ b/tests/html-api/wpHtmlTagProcessor.php
@@ -11,7 +11,7 @@
  *
  * @coversDefaultClass WP_HTML_Tag_Processor
  */
-class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
+class Tests_HtmlApi_WpHtmlTagProcessor extends WP_UnitTestCase {
 	const HTML_SIMPLE       = '<div id="first"><span id="second">Text</span></div>';
 	const HTML_WITH_CLASSES = '<div class="main with-border" id="first"><span class="not-main bold with-border" id="second">Text</span></div>';
 	const HTML_MALFORMED    = '<div><span class="d-md-none" Notifications</span><span class="d-none d-md-inline">Back to notifications</span></div>';
@@ -456,6 +456,26 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Ensures that when seeking to an earlier spot in the document that
+	 * all previously-enqueued updates are applied as they ought to be.
+	 *
+	 * @ticket 58160
+	 */
+	public function test_get_updated_html_applies_updates_to_content_after_seeking_to_before_parsed_bytes() {
+		$p = new WP_HTML_Tag_Processor( '<div><img hidden></div>' );
+
+		$p->next_tag();
+		$p->set_attribute( 'wonky', true );
+		$p->next_tag();
+		$p->set_bookmark( 'here' );
+
+		$p->next_tag( array( 'tag_closers' => 'visit' ) );
+		$p->seek( 'here' );
+
+		$this->assertSame( '<div wonky><img hidden></div>', $p->get_updated_html() );
+	}
+
 	/**
 	 * @ticket 56299
 	 *
@@ -478,6 +498,17 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 		$this->assertFalse( $p->next_tag( 'p' ), 'Querying a non-existing tag did not return false' );
 	}
 
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 */
+	public function test_next_tag_matches_decoded_class_names() {
+		$p = new WP_HTML_Tag_Processor( '<div class="&lt;egg&gt;">' );
+
+		$this->assertTrue( $p->next_tag( array( 'class_name' => '<egg>' ) ), 'Failed to find tag with HTML-encoded class name.' );
+	}
+
 	/**
 	 * @ticket 56299
 	 * @ticket 57852
@@ -551,6 +582,32 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </title> tag closer when there was no tag opener' );
 	}
 
+	/**
+	 * Verifies that updates to a document before calls to `get_updated_html()` don't
+	 * lead to the Tag Processor jumping to the wrong tag after the updates.
+	 *
+	 * @ticket 58179
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_updated_html
+	 */
+	public function test_internal_pointer_returns_to_original_spot_after_inserting_content_before_cursor() {
+		$tags = new WP_HTML_Tag_Processor( '<div>outside</div><section><div><img>inside</div></section>' );
+
+		$tags->next_tag();
+		$tags->add_class( 'foo' );
+		$tags->next_tag( 'section' );
+
+		// Return to this spot after moving ahead.
+		$tags->set_bookmark( 'here' );
+
+		// Move ahead.
+		$tags->next_tag( 'img' );
+		$tags->seek( 'here' );
+		$this->assertSame( '<div class="foo">outside</div><section><div><img>inside</div></section>', $tags->get_updated_html() );
+		$this->assertSame( 'SECTION', $tags->get_tag() );
+		$this->assertFalse( $tags->is_tag_closer() );
+	}
+
 	/**
 	 * @ticket 56299
 	 *
@@ -962,6 +1019,24 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Ensures that when setting an attribute multiple times that only
+	 * one update flushes out into the updated HTML.
+	 *
+	 * @ticket 58146
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_with_case_variants_updates_only_the_original_first_copy() {
+		$p = new WP_HTML_Tag_Processor( '<div data-enabled="5">' );
+		$p->next_tag();
+		$p->set_attribute( 'DATA-ENABLED', 'canary' );
+		$p->set_attribute( 'Data-Enabled', 'canary' );
+		$p->set_attribute( 'dATa-EnABled', 'canary' );
+
+		$this->assertSame( '<div data-enabled="canary">', strtolower( $p->get_updated_html() ) );
+	}
+
 	/**
 	 * @ticket 56299
 	 *
@@ -985,15 +1060,9 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 	 * Removing an attribute that's listed many times, e.g. `<div id="a" id="b" />` should remove
 	 * all its instances and output just `<div />`.
 	 *
-	 * Today, however, WP_HTML_Tag_Processor only removes the first such attribute. It seems like a corner case
-	 * and introducing additional complexity to correctly handle this scenario doesn't seem to be worth it.
-	 * Let's revisit if and when this becomes a problem.
+	 * @since 6.3.2 Removes all duplicated attributes as expected.
 	 *
-	 * This test is in place to confirm this behavior, which while incorrect, is well-defined.
-	 * A later fix introduced to the Tag Processor should update this test to reflect the
-	 * wanted and correct behavior.
-	 *
-	 * @ticket 56299
+	 * @ticket 58119
 	 *
 	 * @covers WP_HTML_Tag_Processor::remove_attribute
 	 */
@@ -1002,8 +1071,8 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 		$p->next_tag();
 		$p->remove_attribute( 'id' );
 
-		$this->assertSame(
-			'<div  id="ignored-id"><span id="second">Text</span></div>',
+		$this->assertStringNotContainsString(
+			'update-me',
 			$p->get_updated_html(),
 			'First attribute (when duplicates exist) was not removed'
 		);
@@ -1026,6 +1095,61 @@ class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 58119
+	 *
+	 * @since 6.3.2 Removes all duplicated attributes as expected.
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 *
+	 * @dataProvider data_html_with_duplicated_attributes
+	 */
+	public function test_remove_attribute_with_duplicated_attributes_removes_all_of_them( $html_with_duplicate_attributes, $attribute_to_remove ) {
+		$p = new WP_HTML_Tag_Processor( $html_with_duplicate_attributes );
+		$p->next_tag();
+
+		$p->remove_attribute( $attribute_to_remove );
+		$this->assertNull( $p->get_attribute( $attribute_to_remove ), 'Failed to remove all copies of an attribute when duplicated in modified source.' );
+
+		// Recreate a tag processor with the updated HTML after removing the attribute.
+		$p = new WP_HTML_Tag_Processor( $p->get_updated_html() );
+		$p->next_tag();
+		$this->assertNull( $p->get_attribute( $attribute_to_remove ), 'Failed to remove all copies of duplicated attributes when getting updated HTML.' );
+	}
+
+	/**
+	 * @ticket 58119
+	 *
+	 * @since 6.3.2 Removes all duplicated attributes as expected.
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 */
+	public function test_previous_duplicated_attributes_are_not_removed_on_successive_tag_removal() {
+		$p = new WP_HTML_Tag_Processor( '<span id=one id=two id=three><span id=four>' );
+		$p->next_tag();
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$this->assertSame( '<span id=one id=two id=three><span >', $p->get_updated_html() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @ticket 58119
+	 *
+	 * @return array[].
+	 */
+	public function data_html_with_duplicated_attributes() {
+		return array(
+			'Double attributes'               => array( '<div id=one id=two>', 'id' ),
+			'Triple attributes'               => array( '<div id=one id=two id=three>', 'id' ),
+			'Duplicates around another'       => array( '<img src="test.png" alt="kites flying in the wind" src="kites.jpg">', 'src' ),
+			'Case-variants of attribute'      => array( '<button disabled inert DISABLED dISaBled INERT DisABleD>', 'disabled' ),
+			'Case-variants of attribute name' => array( '<button disabled inert DISABLED dISaBled INERT DisABleD>', 'DISABLED' ),
+		);
+	}
+
 	/**
 	 * @ticket 56299
 	 *
@@ -1484,7 +1608,7 @@ HTML;
 HTML;
 
 		$p = new WP_HTML_Tag_Processor( $input );
-		$this->assertTrue( $p->next_tag( 'div' ), 'Querying an existing tag did not return true' );
+		$this->assertTrue( $p->next_tag( 'div' ), 'Did not find first DIV tag in input.' );
 		$p->set_attribute( 'data-details', '{ "key": "value" }' );
 		$p->add_class( 'is-processed' );
 		$this->assertTrue(
@@ -1494,7 +1618,7 @@ HTML;
 					'class_name' => 'BtnGroup',
 				)
 			),
-			'Querying an existing tag did not return true'
+			'Did not find the first BtnGroup DIV tag'
 		);
 		$p->remove_class( 'BtnGroup' );
 		$p->add_class( 'button-group' );
@@ -1506,7 +1630,7 @@ HTML;
 					'class_name' => 'BtnGroup',
 				)
 			),
-			'Querying an existing tag did not return true'
+			'Did not find the second BtnGroup DIV tag'
 		);
 		$p->remove_class( 'BtnGroup' );
 		$p->add_class( 'button-group' );
@@ -1519,10 +1643,10 @@ HTML;
 					'match_offset' => 3,
 				)
 			),
-			'Querying an existing tag did not return true'
+			'Did not find third BUTTON tag with "btn" CSS class'
 		);
 		$p->remove_attribute( 'class' );
-		$this->assertFalse( $p->next_tag( 'non-existent' ), 'Querying a non-existing tag did not return false' );
+		$this->assertFalse( $p->next_tag( 'non-existent' ), "Found a {$p->get_tag()} tag when none should have been found." );
 		$p->set_attribute( 'class', 'test' );
 		$this->assertSame( $expected_output, $p->get_updated_html(), 'Calling get_updated_html after updating the attributes did not return the expected HTML' );
 	}
@@ -1714,6 +1838,47 @@ HTML;
 		);
 	}
 
+	/**
+	 * Invalid tag names are comments on tag closers.
+	 *
+	 * @ticket 58007
+	 *
+	 * @link https://html.spec.whatwg.org/#parse-error-invalid-first-character-of-tag-name
+	 *
+	 * @dataProvider data_next_tag_ignores_invalid_first_character_of_tag_name_comments
+	 *
+	 * @param string $html_with_markers HTML containing an invalid tag closer whose element before and
+	 *                                  element after contain the "start" and "end" CSS classes.
+	 */
+	public function test_next_tag_ignores_invalid_first_character_of_tag_name_comments( $html_with_markers ) {
+		$p = new WP_HTML_Tag_Processor( $html_with_markers );
+		$p->next_tag( array( 'class_name' => 'start' ) );
+		$p->next_tag();
+
+		$this->assertSame( 'end', $p->get_attribute( 'class' ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_next_tag_ignores_invalid_first_character_of_tag_name_comments() {
+		return array(
+			'Invalid tag openers as normal text'           => array(
+				'<ul><li><div class=start>I <3 when outflow > inflow</div><img class=end></li></ul>',
+			),
+
+			'Invalid tag closers as comments'              => array(
+				'<ul><li><div class=start>I </3 when <img> outflow <br class=end> inflow</div></li></ul>',
+			),
+
+			'Unexpected question mark instead of tag name' => array(
+				'<div class=start><?xml-stylesheet type="text/css" href="style.css"?><hr class=end>',
+			),
+		);
+	}
+
 	/**
 	 * @ticket 56299
 	 *
@@ -1766,6 +1931,280 @@ HTML;
 		);
 	}
 
+	/**
+	 * @ticket 59292
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_next_tag_ignores_contents_of_rawtext_tags
+	 *
+	 * @param string $rawtext_element_then_target_node HTML starting with a RAWTEXT-specifying element such as STYLE,
+	 *                                                 then an element afterward containing the "target" attribute.
+	 */
+	public function test_next_tag_ignores_contents_of_rawtext_tags( $rawtext_element_then_target_node ) {
+		$processor = new WP_HTML_Tag_Processor( $rawtext_element_then_target_node );
+		$processor->next_tag();
+
+		$processor->next_tag();
+		$this->assertNotNull(
+			$processor->get_attribute( 'target' ),
+			"Expected to find element with target attribute but found {$processor->get_tag()} instead."
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[].
+	 */
+	public function data_next_tag_ignores_contents_of_rawtext_tags() {
+		return array(
+			'IFRAME'           => array( '<iframe><section>Inside</section></iframe><section target>' ),
+			'NOEMBED'          => array( '<noembed><p></p></noembed><div target>' ),
+			'NOFRAMES'         => array( '<noframes><p>Check the rules here.</p></noframes><div target>' ),
+			'NOSCRIPT'         => array( '<noscript><span>This assumes that scripting mode is enabled.</span></noscript><p target>' ),
+			'STYLE'            => array( '<style>* { margin: 0 }</style><div target>' ),
+			'STYLE hiding DIV' => array( '<style>li::before { content: "<div non-target>" }</style><div target>' ),
+		);
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::class_list
+	 */
+	public function test_class_list_empty_when_missing_class() {
+		$p = new WP_HTML_Tag_Processor( '<div>' );
+		$p->next_tag();
+
+		$found_classes = false;
+		foreach ( $p->class_list() as $class ) {
+			$found_classes = true;
+		}
+
+		$this->assertFalse( $found_classes, 'Found classes when none exist.' );
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::class_list
+	 */
+	public function test_class_list_empty_when_class_is_boolean() {
+		$p = new WP_HTML_Tag_Processor( '<div class>' );
+		$p->next_tag();
+
+		$found_classes = false;
+		foreach ( $p->class_list() as $class ) {
+			$found_classes = true;
+		}
+
+		$this->assertFalse( $found_classes, 'Found classes when none exist.' );
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::class_list
+	 */
+	public function test_class_list_empty_when_class_is_empty() {
+		$p = new WP_HTML_Tag_Processor( '<div class="">' );
+		$p->next_tag();
+
+		$found_classes = false;
+		foreach ( $p->class_list() as $class ) {
+			$found_classes = true;
+		}
+
+		$this->assertFalse( $found_classes, 'Found classes when none exist.' );
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::class_list
+	 */
+	public function test_class_list_visits_each_class_in_order() {
+		$p = new WP_HTML_Tag_Processor( '<div class="one two three">' );
+		$p->next_tag();
+
+		$found_classes = array();
+		foreach ( $p->class_list() as $class ) {
+			$found_classes[] = $class;
+		}
+
+		$this->assertSame( array( 'one', 'two', 'three' ), $found_classes, 'Failed to visit the class names in their original order.' );
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::class_list
+	 */
+	public function test_class_list_decodes_class_names() {
+		$p = new WP_HTML_Tag_Processor( '<div class="&notin;-class &lt;egg&gt; &#xff03;">' );
+		$p->next_tag();
+
+		$found_classes = array();
+		foreach ( $p->class_list() as $class ) {
+			$found_classes[] = $class;
+		}
+
+		$this->assertSame( array( '-class', '<egg>', "\u{ff03}" ), $found_classes, 'Failed to report class names in their decoded form.' );
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::class_list
+	 */
+	public function test_class_list_visits_unique_class_names_only_once() {
+		$p = new WP_HTML_Tag_Processor( '<div class="one one &#x6f;ne">' );
+		$p->next_tag();
+
+		$found_classes = array();
+		foreach ( $p->class_list() as $class ) {
+			$found_classes[] = $class;
+		}
+
+		$this->assertSame( array( 'one' ), $found_classes, 'Visited multiple copies of the same class name when it should have skipped the duplicates.' );
+	}
+
+	/**
+	 * @ticket 59209
+	 *
+	 * @covers WP_HTML_Tag_Processor::has_class
+	 *
+	 * @dataProvider data_html_with_variations_of_class_values_and_sought_class_names
+	 *
+	 * @param string $html         Contains a tag optionally containing a `class` attribute.
+	 * @param string $sought_class Name of class to find in the input tag's `class`.
+	 * @param bool   $has_class    Whether the sought class exists in the given HTML.
+	 */
+	public function test_has_class_handles_expected_class_name_variations( $html, $sought_class, $has_class ) {
+		$p = new WP_HTML_Tag_Processor( $html );
+		$p->next_tag();
+
+		if ( $has_class ) {
+			$this->assertTrue( $p->has_class( $sought_class ), "Failed to find expected class {$sought_class}." );
+		} else {
+			$this->assertFalse( $p->has_class( $sought_class ), "Found class {$sought_class} when it doesn't exist." );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_html_with_variations_of_class_values_and_sought_class_names() {
+		return array(
+			'Tag without any classes'      => array( '<div>', 'foo', false ),
+			'Tag with boolean class'       => array( '<img class>', 'foo', false ),
+			'Tag with empty class'         => array( '<p class="">', 'foo', false ),
+			'Tag with exact match'         => array( '<button class="foo">', 'foo', true ),
+			'Tag with duplicate matches'   => array( '<span class="foo bar foo">', 'foo', true ),
+			'Tag with non-initial match'   => array( '<section class="bar foo">', 'foo', true ),
+			'Tag with encoded match'       => array( '<main class="&hellip;">', '', true ),
+			'Class with tab separator'     => array( "<div class='one\ttwo'>", 'two', true ),
+			'Class with newline separator' => array( "<div class='one\ntwo\n'>", 'two', true ),
+			'False duplicate attribute'    => array( '<img class=dog class=cat>', 'cat', false ),
+		);
+	}
+
+	/**
+	 * Ensures that the invalid comment closing syntax "--!>" properly closes a comment.
+	 *
+	 * @ticket 58007
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 */
+	public function test_allows_incorrectly_closed_comments() {
+		$p = new WP_HTML_Tag_Processor( '<img id=before><!-- <img id=inside> --!><img id=after>--><img id=final>' );
+
+		$p->next_tag();
+		$this->assertSame( 'before', $p->get_attribute( 'id' ), 'Did not find starting tag.' );
+
+		$p->next_tag();
+		$this->assertSame( 'after', $p->get_attribute( 'id' ), 'Did not properly close improperly-closed comment.' );
+
+		$p->next_tag();
+		$this->assertSame( 'final', $p->get_attribute( 'id' ), 'Did not skip over unopened comment-closer.' );
+	}
+
+	/**
+	 * Ensures that unclosed and invalid comments don't trigger warnings or errors.
+	 *
+	 * @ticket 58007
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_html_with_unclosed_comments
+	 *
+	 * @param string $html_ending_before_comment_close HTML with opened comments that aren't closed
+	 */
+	public function test_documents_may_end_with_unclosed_comment( $html_ending_before_comment_close ) {
+		$p = new WP_HTML_Tag_Processor( $html_ending_before_comment_close );
+
+		$this->assertFalse( $p->next_tag() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_html_with_unclosed_comments() {
+		return array(
+			'Shortest open valid comment'      => array( '<!--' ),
+			'Basic truncated comment'          => array( '<!-- this ends --' ),
+			'Comment with closer look-alike'   => array( '<!-- this ends --x' ),
+			'Comment with closer look-alike 2' => array( '<!-- this ends --!x' ),
+			'Invalid tag-closer comment'       => array( '</(when will this madness end?)' ),
+			'Invalid tag-closer comment 2'     => array( '</(when will this madness end?)--' ),
+		);
+	}
+
+	/**
+	 * Ensures that abruptly-closed empty comments are properly closed.
+	 *
+	 * @ticket 58007
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_abruptly_closed_empty_comments
+	 *
+	 * @param string $html_with_after_marker HTML to test with "id=after" on element immediately following an abruptly closed comment.
+	 */
+	public function test_closes_abrupt_closing_of_empty_comment( $html_with_after_marker ) {
+		$p = new WP_HTML_Tag_Processor( $html_with_after_marker );
+		$p->next_tag();
+		$p->next_tag();
+
+		$this->assertSame( 'after', $p->get_attribute( 'id' ), 'Did not find tag after closing abruptly-closed comment' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_abruptly_closed_empty_comments() {
+		return array(
+			'Empty comment with two dashes only' => array( '<hr><!--><hr id=after>' ),
+			'Empty comment with two dashes only, improperly closed' => array( '<hr><!--!><hr id=inside>--><hr id=after>' ),
+			'Comment with two dashes only, improperly closed twice' => array( '<hr><!--!><hr id=inside>--!><hr id=after>' ),
+			'Empty comment with three dashes'    => array( '<hr><!---><hr id=after>' ),
+			'Empty comment with three dashes, improperly closed' => array( '<hr><!---!><hr id=inside>--><hr id=after>' ),
+			'Comment with three dashes, improperly closed twice' => array( '<hr><!---!><hr id=inside>--!><hr id=after>' ),
+			'Empty comment with four dashes'     => array( '<hr><!----><hr id=after>' ),
+			'Empty comment with four dashes, improperly closed' => array( '<hr><!----!><hr id=after>--><hr id=final>' ),
+			'Comment with four dashes, improperly closed twice' => array( '<hr><!----!><hr id=after>--!><hr id=final>' ),
+			'Comment with almost-closer inside'  => array( '<hr><!-- ---!><hr id=after>--!><hr id=final>' ),
+		);
+	}
+
 	/**
 	 * @ticket 56299
 	 *
@@ -1840,6 +2279,47 @@ HTML;
 		);
 	}
 
+	/**
+	 * @ticket 58637
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_incomplete_syntax_elements
+	 *
+	 * @param string $incomplete_html HTML text containing some kind of incomplete syntax.
+	 */
+	public function test_returns_false_for_incomplete_syntax_elements( $incomplete_html ) {
+		$p = new WP_HTML_Tag_Processor( $incomplete_html );
+		$this->assertFalse( $p->next_tag() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_incomplete_syntax_elements() {
+		return array(
+			'No tags'                              => array( 'this is nothing more than a text node' ),
+			'Incomplete tag name'                  => array( '<swit' ),
+			'Incomplete tag (no attributes)'       => array( '<div' ),
+			'Incomplete tag (attributes)'          => array( '<div inert title="test"' ),
+			'Incomplete attribute (unquoted)'      => array( '<button disabled' ),
+			'Incomplete attribute (single quoted)' => array( "<li class='just-another class" ),
+			'Incomplete attribute (double quoted)' => array( '<iframe src="https://www.example.com/embed/abcdef' ),
+			'Incomplete comment (normative)'       => array( '<!-- without end' ),
+			'Incomplete comment (missing --)'      => array( '<!-- without end --' ),
+			'Incomplete comment (--!)'             => array( '<!-- without end --!' ),
+			'Incomplete comment (bogus comment)'   => array( '</3 is not a tag' ),
+			'Incomplete DOCTYPE'                   => array( '<!DOCTYPE html' ),
+			'Partial DOCTYPE'                      => array( '<!DOCTY' ),
+			'Incomplete CDATA'                     => array( '<[CDATA[something inside of here needs to get out' ),
+			'Partial CDATA'                        => array( '<[CDA' ),
+			'Partially closed CDATA]'              => array( '<[CDATA[cannot escape]' ),
+			'Partially closed CDATA]>'             => array( '<[CDATA[cannot escape]>' ),
+		);
+	}
+
 	/**
 	 * @ticket 56299
 	 *
diff --git a/tests/http/base.php b/tests/http/base.php
index ad487e3f19..8a6ce3b3b0 100644
--- a/tests/http/base.php
+++ b/tests/http/base.php
@@ -8,7 +8,7 @@
  * You may also need `-d safe_mode_gid=1` to relax the safe_mode checks to allow
  * inclusion of PEAR.
  *
- * The WP_HTTP tests require a class-http.php file of r17550 or later.
+ * The WP_Http tests require a class-http.php file of r17550 or later.
  */
 abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 	// You can use your own version of data/WPHTTP-testcase-redirection-script.php here.
@@ -314,7 +314,6 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 		$this->skipTestOnTimeout( $res );
 		$this->assertNotWPError( $res );
 		$this->assertSame( $size, $filesize ); // Check that the file is written to disk correctly without any extra characters.
-
 	}
 
 	/**
@@ -408,7 +407,6 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 
 		$this->skipTestOnTimeout( $res );
 		$this->assertSame( 'PASS', wp_remote_retrieve_body( $res ) );
-
 	}
 
 	/**
@@ -487,6 +485,4 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 		$this->skipTestOnTimeout( $res );
 		$this->assertNotWPError( $res );
 	}
-
-
 }
diff --git a/tests/http/http.php b/tests/http/http.php
index de9dd73320..1648cca4ea 100644
--- a/tests/http/http.php
+++ b/tests/http/http.php
@@ -1,6 +1,6 @@
 <?php
 /**
- * Non-transport-specific WP_HTTP Tests
+ * Non-transport-specific WP_Http Tests
  *
  * @group http
  */
@@ -292,7 +292,6 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 		get_status_header_desc( 200 );
 
 		$this->assertSame( array_keys( $wp_header_to_desc ), array_values( $constants ) );
-
 	}
 
 	/**
@@ -581,20 +580,20 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 	/**
 	 * Test HTTP Redirects with multiple Location headers specified.
 	 *
-	 * Ensure the WP_HTTP::handle_redirects() method handles multiple Location headers
+	 * Ensure the WP_Http::handle_redirects() method handles multiple Location headers
 	 * and the HTTP request it makes uses the last Location header.
 	 *
 	 * @ticket 16890
 	 * @ticket 57306
 	 *
-	 * @covers WP_HTTP::handle_redirects
+	 * @covers WP_Http::handle_redirects
 	 */
 	public function test_multiple_location_headers() {
 		$pre_http_request_filter_has_run = false;
-		// Filter the response made by WP_HTTP::handle_redirects().
+		// Filter the response made by WP_Http::handle_redirects().
 		add_filter(
 			'pre_http_request',
-			function( $response, $parsed_args, $url ) use ( &$pre_http_request_filter_has_run ) {
+			function ( $response, $parsed_args, $url ) use ( &$pre_http_request_filter_has_run ) {
 				$pre_http_request_filter_has_run = true;
 
 				// Assert the redirect URL is correct.
@@ -634,7 +633,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 			),
 		);
 
-		// Test the tests: ensure multiple locations are passed to WP_HTTP::handle_redirects().
+		// Test the tests: ensure multiple locations are passed to WP_Http::handle_redirects().
 		$this->assertIsArray( $headers['location'], 'Location header is expected to be an array.' );
 		$this->assertCount( 2, $headers['location'], 'Location header is expected to contain two values.' );
 
@@ -645,7 +644,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 			'method'       => 'GET',
 		);
 
-		$redirect_response = WP_HTTP::handle_redirects(
+		$redirect_response = WP_Http::handle_redirects(
 			'http://example.com/?multiple-location-headers=1',
 			$args,
 			array(
diff --git a/tests/https-detection.php b/tests/https-detection.php
index 820f39fc6e..da2fdc2d8a 100644
--- a/tests/https-detection.php
+++ b/tests/https-detection.php
@@ -54,122 +54,6 @@ class Tests_HTTPS_Detection extends WP_UnitTestCase {
 		$this->assertFalse( wp_is_https_supported() );
 	}
 
-	/**
-	 * @ticket 47577
-	 * @ticket 52484
-	 */
-	public function test_wp_update_https_detection_errors() {
-		// Set HTTP URL, the request below should use its HTTPS version.
-		update_option( 'home', 'http://example.com/' );
-		add_filter( 'pre_http_request', array( $this, 'record_request_url' ), 10, 3 );
-
-		// If initial request succeeds, all good.
-		add_filter( 'pre_http_request', array( $this, 'mock_success_with_sslverify' ), 10, 2 );
-		wp_update_https_detection_errors();
-		$this->assertSame( array(), get_option( 'https_detection_errors' ) );
-
-		// If initial request fails and request without SSL verification succeeds,
-		// return 'ssl_verification_failed' error.
-		add_filter( 'pre_http_request', array( $this, 'mock_error_with_sslverify' ), 10, 2 );
-		add_filter( 'pre_http_request', array( $this, 'mock_success_without_sslverify' ), 10, 2 );
-		wp_update_https_detection_errors();
-		$this->assertSame(
-			array( 'ssl_verification_failed' => array( __( 'SSL verification failed.' ) ) ),
-			get_option( 'https_detection_errors' )
-		);
-
-		// If both initial request and request without SSL verification fail,
-		// return 'https_request_failed' error.
-		add_filter( 'pre_http_request', array( $this, 'mock_error_with_sslverify' ), 10, 2 );
-		add_filter( 'pre_http_request', array( $this, 'mock_error_without_sslverify' ), 10, 2 );
-		wp_update_https_detection_errors();
-		$this->assertSame(
-			array( 'https_request_failed' => array( __( 'HTTPS request failed.' ) ) ),
-			get_option( 'https_detection_errors' )
-		);
-
-		// If request succeeds, but response is not 200, return error with
-		// 'bad_response_code' error code.
-		add_filter( 'pre_http_request', array( $this, 'mock_not_found' ), 10, 2 );
-		wp_update_https_detection_errors();
-		$this->assertSame(
-			array( 'bad_response_code' => array( 'Not Found' ) ),
-			get_option( 'https_detection_errors' )
-		);
-
-		// If request succeeds, but response was not generated by this
-		// WordPress site, return error with 'bad_response_source' error code.
-		add_filter( 'pre_http_request', array( $this, 'mock_bad_source' ), 10, 2 );
-		wp_update_https_detection_errors();
-		$this->assertSame(
-			array( 'bad_response_source' => array( 'It looks like the response did not come from this site.' ) ),
-			get_option( 'https_detection_errors' )
-		);
-
-		// Check that the requests are made to the correct URL.
-		$this->assertSame( 'https://example.com/', $this->last_request_url );
-	}
-
-	/**
-	 * @ticket 47577
-	 */
-	public function test_pre_wp_update_https_detection_errors() {
-		// Override to enforce no errors being detected.
-		add_filter(
-			'pre_wp_update_https_detection_errors',
-			static function() {
-				return new WP_Error();
-			}
-		);
-		wp_update_https_detection_errors();
-		$this->assertSame( array(), get_option( 'https_detection_errors' ) );
-
-		// Override to enforce an error being detected.
-		add_filter(
-			'pre_wp_update_https_detection_errors',
-			static function() {
-				return new WP_Error(
-					'ssl_verification_failed',
-					'Bad SSL certificate.'
-				);
-			}
-		);
-		wp_update_https_detection_errors();
-		$this->assertSame(
-			array( 'ssl_verification_failed' => array( 'Bad SSL certificate.' ) ),
-			get_option( 'https_detection_errors' )
-		);
-	}
-
-	/**
-	 * @ticket 47577
-	 */
-	public function test_wp_schedule_https_detection() {
-		wp_schedule_https_detection();
-		$this->assertSame( 'twicedaily', wp_get_schedule( 'wp_https_detection' ) );
-	}
-
-	/**
-	 * @ticket 47577
-	 */
-	public function test_wp_cron_conditionally_prevent_sslverify() {
-		// If URL is not using HTTPS, don't set 'sslverify' to false.
-		$request = array(
-			'url'  => 'http://example.com/',
-			'args' => array( 'sslverify' => true ),
-		);
-		$this->assertSame( $request, wp_cron_conditionally_prevent_sslverify( $request ) );
-
-		// If URL is using HTTPS, set 'sslverify' to false.
-		$request                       = array(
-			'url'  => 'https://example.com/',
-			'args' => array( 'sslverify' => true ),
-		);
-		$expected                      = $request;
-		$expected['args']['sslverify'] = false;
-		$this->assertSame( $expected, wp_cron_conditionally_prevent_sslverify( $request ) );
-	}
-
 	/**
 	 * @ticket 47577
 	 * @ticket 52542
@@ -316,7 +200,7 @@ class Tests_HTTPS_Detection extends WP_UnitTestCase {
 	 * @return callable Filter callback.
 	 */
 	private function filter_set_url_scheme( $scheme ) {
-		return static function( $url ) use ( $scheme ) {
+		return static function ( $url ) use ( $scheme ) {
 			return set_url_scheme( $url, $scheme );
 		};
 	}
diff --git a/tests/https-migration.php b/tests/https-migration.php
index d06e1f0fba..ae66738603 100644
--- a/tests/https-migration.php
+++ b/tests/https-migration.php
@@ -161,7 +161,7 @@ class Tests_HTTPS_Migration extends WP_UnitTestCase {
 	private function force_wp_is_using_https( $enabled ) {
 		$scheme = $enabled ? 'https' : 'http';
 
-		$replace_scheme = static function( $url ) use ( $scheme ) {
+		$replace_scheme = static function ( $url ) use ( $scheme ) {
 			return str_replace( array( 'http://', 'https://' ), $scheme . '://', $url );
 		};
 
@@ -172,7 +172,7 @@ class Tests_HTTPS_Migration extends WP_UnitTestCase {
 	private function force_option( $option, $value ) {
 		add_filter(
 			"option_$option",
-			static function() use ( $value ) {
+			static function () use ( $value ) {
 				return $value;
 			}
 		);
diff --git a/tests/image/dimensions.php b/tests/image/dimensions.php
index 5820f64ae7..a80c4ece3e 100644
--- a/tests/image/dimensions.php
+++ b/tests/image/dimensions.php
@@ -181,5 +181,4 @@ class Tests_Image_Dimensions extends WP_UnitTestCase {
 		// dst_x, dst_y, src_x, src_y, dst_w, dst_h, src_w, src_h.
 		$this->assertSame( array( 0, 0, 0, 40, 400, 500, 480, 600 ), $out );
 	}
-
 }
diff --git a/tests/image/editor.php b/tests/image/editor.php
index 6e800deb7a..bd54b803e2 100644
--- a/tests/image/editor.php
+++ b/tests/image/editor.php
@@ -363,5 +363,4 @@ class Tests_Image_Editor extends WP_Image_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/image/editorImagick.php b/tests/image/editorImagick.php
index a8db8a3210..30747f69f1 100644
--- a/tests/image/editorImagick.php
+++ b/tests/image/editorImagick.php
@@ -641,4 +641,54 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 
 		$this->assertNotWPError( $saved );
 	}
+
+	/**
+	 * Tests that the alpha channel of PDFs is removed from PDF previews.
+	 *
+	 * Only affects systems with Ghostscript version >= 9.14.
+	 *
+	 * @ticket 39216
+	 *
+	 * @covers WP_Image_Editor_Imagick::remove_pdf_alpha_channel
+	 */
+	public function test_remove_pdf_alpha_channel_should_remove_the_alpha_channel_in_preview() {
+		if ( ! wp_image_editor_supports( array( 'mime_type' => 'application/pdf' ) ) ) {
+			$this->markTestSkipped( 'Rendering PDFs is not supported on this system.' );
+		}
+
+		$test_file     = DIR_TESTDATA . '/images/test-alpha.pdf';
+		$attachment_id = $this->factory->attachment->create_upload_object( $test_file );
+		$this->assertNotEmpty( $attachment_id, 'The attachment was not created before testing.' );
+
+		$attached_file = get_attached_file( $attachment_id );
+		$this->assertNotEmpty( $attached_file, 'The attached file was not returned.' );
+
+		$rgb = array(
+			'r' => true,
+			'g' => true,
+			'b' => true,
+		);
+
+		// White.
+		$expected = array(
+			'r' => 1,
+			'g' => 1,
+			'b' => 1,
+		);
+
+		$check = image_get_intermediate_size( $attachment_id, 'full' );
+		$this->assertIsArray( $check, 'The intermediate size could not be retrieved.' );
+		$this->assertArrayHasKey( 'file', $check, 'The intermediate size file was not found.' );
+
+		$check_file = path_join( dirname( $attached_file ), $check['file'] );
+		$imagick    = new Imagick( $check_file );
+		$output     = array_map(
+			static function ( $value ) {
+				return (int) round( $value );
+			},
+			array_intersect_key( $imagick->getImagePixelColor( 100, 100 )->getColor( true /* normalized */ ), $rgb )
+		);
+		$imagick->destroy();
+		$this->assertSame( $expected, $output, 'The image color of the generated thumb does not match expected opaque background.' ); // Allow for floating point equivalence.
+	}
 }
diff --git a/tests/image/functions.php b/tests/image/functions.php
index 82988c5f6b..f55b164496 100644
--- a/tests/image/functions.php
+++ b/tests/image/functions.php
@@ -350,6 +350,91 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		$this->assertTrue( $ret, 'Image failed to save.' );
 	}
 
+	/**
+	 * Tests that `wp_image_editor()` applies 'image_edit_thumbnails_separately' filters.
+	 *
+	 * @ticket 53161
+	 *
+	 * @covers ::wp_image_editor
+	 */
+	public function test_wp_image_editor_should_apply_image_edit_thumbnails_separately_filters() {
+		require_once ABSPATH . 'wp-admin/includes/image-edit.php';
+
+		$filename = DIR_TESTDATA . '/images/canola.jpg';
+		$contents = file_get_contents( $filename );
+		$upload   = wp_upload_bits( wp_basename( $filename ), null, $contents );
+		$id       = $this->_make_attachment( $upload );
+
+		$filter = new MockAction();
+		add_filter( 'image_edit_thumbnails_separately', array( &$filter, 'filter' ) );
+
+		ob_start();
+		wp_image_editor( $id );
+		ob_end_clean();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that `wp_image_editor()` conditionally outputs markup for editing thumbnails separately
+	 * based on the result of applying 'image_edit_thumbnails_separately' filters.
+	 *
+	 * @ticket 53161
+	 *
+	 * @covers ::wp_image_editor
+	 *
+	 * @dataProvider data_wp_image_editor_should_respect_image_edit_thumbnails_separately_filters
+	 *
+	 * @param string $callback The name of the callback for the 'image_edit_thumbnails_separately' hook.
+	 * @param bool   $expected Whether the markup should be output.
+	 */
+	public function test_wp_image_editor_should_respect_image_edit_thumbnails_separately_filters( $callback, $expected ) {
+		require_once ABSPATH . 'wp-admin/includes/image-edit.php';
+
+		$filename = DIR_TESTDATA . '/images/canola.jpg';
+		$contents = file_get_contents( $filename );
+		$upload   = wp_upload_bits( wp_basename( $filename ), null, $contents );
+		$id       = $this->_make_attachment( $upload );
+
+		add_filter( 'image_edit_thumbnails_separately', $callback );
+
+		ob_start();
+		wp_image_editor( $id );
+		$actual = ob_get_clean();
+
+		if ( $expected ) {
+			$this->assertStringContainsString(
+				'imgedit-applyto',
+				$actual,
+				'The markup should have been output.'
+			);
+		} else {
+			$this->assertStringNotContainsString(
+				'imgedit-applyto',
+				$actual,
+				'The markup should not have been output.'
+			);
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_image_editor_should_respect_image_edit_thumbnails_separately_filters() {
+		return array(
+			'true'  => array(
+				'callback' => '__return_true',
+				'expected' => true,
+			),
+			'false' => array(
+				'callback' => '__return_false',
+				'expected' => false,
+			),
+		);
+	}
+
 	/**
 	 * Tests that a passed mime type overrides the extension in the filename when saving an image.
 	 *
@@ -607,7 +692,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 
 		add_filter(
 			'wp_image_editors',
-			static function( $editors ) {
+			static function ( $editors ) {
 				return array( 'WP_Image_Editor_Mock' );
 			}
 		);
@@ -633,7 +718,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 	public function test_wp_crop_image_should_return_correct_file_extension_if_output_format_was_modified() {
 		add_filter(
 			'image_editor_output_format',
-			static function() {
+			static function () {
 				return array_fill_keys( array( 'image/jpg', 'image/jpeg', 'image/png' ), 'image/webp' );
 			}
 		);
diff --git a/tests/image/header.php b/tests/image/header.php
index 6b480a953c..afb9feb61f 100644
--- a/tests/image/header.php
+++ b/tests/image/header.php
@@ -30,7 +30,6 @@ class Tests_Image_Header extends WP_UnitTestCase {
 		);
 		$this->assertSame( 1200, $dimensions['dst_width'] );
 		$this->assertSame( 230, $dimensions['dst_height'] );
-
 	}
 
 	public function test_header_image_has_correct_dimensions_with_fixed() {
@@ -50,7 +49,6 @@ class Tests_Image_Header extends WP_UnitTestCase {
 		);
 		$this->assertSame( 1200, $dimensions['dst_width'] );
 		$this->assertSame( 230, $dimensions['dst_height'] );
-
 	}
 
 	public function test_header_image_has_correct_dimensions_with_flex_height() {
@@ -70,7 +68,6 @@ class Tests_Image_Header extends WP_UnitTestCase {
 		);
 		$this->assertSame( 1200, $dimensions['dst_width'] );
 		$this->assertSame( 900, $dimensions['dst_height'] );
-
 	}
 
 	public function test_header_image_has_correct_dimensions_with_flex_width() {
@@ -90,7 +87,6 @@ class Tests_Image_Header extends WP_UnitTestCase {
 		);
 		$this->assertSame( 1500, $dimensions['dst_width'] ); // Max width.
 		$this->assertSame( 230, $dimensions['dst_height'] );
-
 	}
 
 	public function test_header_image_has_correct_dimensions_with_flex_width_and_height() {
@@ -110,7 +106,6 @@ class Tests_Image_Header extends WP_UnitTestCase {
 		);
 		$this->assertSame( 1600, $dimensions['dst_width'] );
 		$this->assertSame( 1200, $dimensions['dst_height'] );
-
 	}
 
 	public function test_create_attachment_object() {
diff --git a/tests/image/intermediateSize.php b/tests/image/intermediateSize.php
index 830359427a..e297bf8427 100644
--- a/tests/image/intermediateSize.php
+++ b/tests/image/intermediateSize.php
@@ -69,7 +69,7 @@ class Tests_Image_Intermediate_Size extends WP_UnitTestCase {
 	public function test_image_editor_output_format_filter() {
 		add_filter(
 			'image_editor_output_format',
-			static function() {
+			static function () {
 				return array( 'image/jpeg' => 'image/webp' );
 			}
 		);
diff --git a/tests/image/resizeGd.php b/tests/image/resizeGd.php
index 40a3faebfc..a990c0a126 100644
--- a/tests/image/resizeGd.php
+++ b/tests/image/resizeGd.php
@@ -38,5 +38,4 @@ class Test_Image_Resize_GD extends WP_Tests_Image_Resize_UnitTestCase {
 		$this->assertInstanceOf( 'WP_Error', $image );
 		$this->assertSame( 'invalid_image', $image->get_error_code() );
 	}
-
 }
diff --git a/tests/image/size.php b/tests/image/size.php
index 60819b41b5..c8c6234b23 100644
--- a/tests/image/size.php
+++ b/tests/image/size.php
@@ -208,5 +208,4 @@ class Tests_Image_Size extends WP_UnitTestCase {
 
 		$content_width = $_content_width;
 	}
-
 }
diff --git a/tests/import/base.php b/tests/import/base.php
index db83296c0a..d0fefb1a92 100644
--- a/tests/import/base.php
+++ b/tests/import/base.php
@@ -42,7 +42,7 @@ abstract class WP_Import_UnitTestCase extends WP_UnitTestCase {
 				$new[ $i ] = $map;
 			}
 
-			$i++;
+			++$i;
 		}
 
 		$_POST = array(
diff --git a/tests/import/import.php b/tests/import/import.php
index 2162824e96..a46398392d 100644
--- a/tests/import/import.php
+++ b/tests/import/import.php
@@ -28,7 +28,6 @@ class Tests_Import_Import extends WP_Import_UnitTestCase {
 		global $wpdb;
 		// Crude but effective: make sure there's no residual data in the main tables.
 		foreach ( array( 'posts', 'postmeta', 'comments', 'terms', 'term_taxonomy', 'term_relationships', 'users', 'usermeta' ) as $table ) {
-			// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 			$wpdb->query( "DELETE FROM {$wpdb->$table}" );
 		}
 	}
diff --git a/tests/kses.php b/tests/kses.php
index db5e26ec0b..45f2862d14 100644
--- a/tests/kses.php
+++ b/tests/kses.php
@@ -937,6 +937,7 @@ EOF;
 	 * @ticket 48376
 	 * @ticket 55966
 	 * @ticket 56122
+	 * @ticket 58551
 	 * @dataProvider data_safecss_filter_attr
 	 *
 	 * @param string $css      A string of CSS rules.
@@ -1047,9 +1048,9 @@ EOF;
 				'css'      => 'grid-template-rows: 40px 4em 40px;grid-auto-rows: min-content;grid-row-start: -1;grid-row-end: 3;grid-row-gap: 1em',
 				'expected' => 'grid-template-rows: 40px 4em 40px;grid-auto-rows: min-content;grid-row-start: -1;grid-row-end: 3;grid-row-gap: 1em',
 			),
-			// `grid` does not yet support functions or `\`.
+			// `grid` does not yet support `\`.
 			array(
-				'css'      => 'grid-template-columns: repeat(2, 50px 1fr);grid-template: 1em / 20% 20px 1fr',
+				'css'      => 'grid-template: 1em / 20% 20px 1fr',
 				'expected' => '',
 			),
 			// `flex` and `grid` alignments introduced in 5.3.
@@ -1321,6 +1322,30 @@ EOF;
 				'css'      => 'filter: url( my-file.svg#svg-blur );',
 				'expected' => 'filter: url( my-file.svg#svg-blur )',
 			),
+			// Support for `repeat` function.
+			array(
+				'css'      => 'grid-template-columns: repeat(4, minmax(0, 1fr))',
+				'expected' => 'grid-template-columns: repeat(4, minmax(0, 1fr))',
+			),
+			array(
+				'css'      => 'grid-template-columns: repeat(auto-fill, minmax(min(12rem, 100%), 1fr))',
+				'expected' => 'grid-template-columns: repeat(auto-fill, minmax(min(12rem, 100%), 1fr))',
+			),
+			// Malformed repeat, no closing `)`.
+			array(
+				'css'      => 'grid-template-columns: repeat(4, minmax(0, 1fr)',
+				'expected' => '',
+			),
+			// Malformed repeat, contains unsupported function.
+			array(
+				'css'      => 'grid-template-columns: repeat(4, unsupported(0, 1fr)',
+				'expected' => '',
+			),
+			// `writing-mode` introduced in 6.4.
+			array(
+				'css'      => 'writing-mode: vertical-rl',
+				'expected' => 'writing-mode: vertical-rl',
+			),
 		);
 	}
 
@@ -1923,7 +1948,7 @@ HTML;
 		);
 
 		return array_map(
-			function ( $datum ) {
+			static function ( $datum ) {
 				$datum[] = array(
 					'p' => array(
 						'dir' => array(
diff --git a/tests/l10n/determineLocale.php b/tests/l10n/determineLocale.php
new file mode 100644
index 0000000000..51ab1c28b9
--- /dev/null
+++ b/tests/l10n/determineLocale.php
@@ -0,0 +1,276 @@
+<?php
+
+/**
+ * @group l10n
+ * @group i18n
+ *
+ * @covers ::determine_locale
+ */
+class Tests_L10n_DetermineLocale extends WP_UnitTestCase {
+	protected $locale;
+	protected static $user_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$user_id = $factory->user->create(
+			array(
+				'role'   => 'administrator',
+				'locale' => 'userLocale',
+			)
+		);
+	}
+
+	public function tear_down() {
+		unset( $_SERVER['CONTENT_TYPE'], $_GET['_locale'], $_COOKIE['wp_lang'], $GLOBALS['pagenow'] );
+
+		parent::tear_down();
+	}
+
+	public function test_short_circuit_empty() {
+		add_filter( 'pre_determine_locale', '__return_false' );
+		$this->assertNotFalse( determine_locale() );
+	}
+
+	public function test_short_circuit_no_string() {
+		add_filter(
+			'pre_determine_locale',
+			static function () {
+				return 1234;
+			}
+		);
+		$this->assertNotFalse( determine_locale() );
+	}
+
+	public function test_short_circuit_string() {
+		add_filter(
+			'pre_determine_locale',
+			static function () {
+					return 'myNewLocale';
+			}
+		);
+		$this->assertSame( 'myNewLocale', determine_locale() );
+	}
+
+	public function test_defaults_to_site_locale() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		$this->assertSame( get_locale(), determine_locale() );
+	}
+
+	public function test_is_admin_no_user() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		set_current_screen( 'dashboard' );
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_is_admin_user_locale() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		set_current_screen( 'dashboard' );
+		wp_set_current_user( self::$user_id );
+
+		$this->assertSame( 'userLocale', determine_locale() );
+	}
+
+	public function test_json_request_user_locale() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$_SERVER['CONTENT_TYPE'] = 'application/json';
+		$_GET['_locale']         = 'user';
+
+		$this->assertSame( 'userLocale', determine_locale() );
+	}
+
+	public function test_json_request_user_locale_no_user() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		$_SERVER['CONTENT_TYPE'] = 'application/json';
+		$_GET['_locale']         = 'user';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_json_request_missing_get_param() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$_SERVER['CONTENT_TYPE'] = 'application/json';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_json_request_incorrect_get_param() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$_SERVER['CONTENT_TYPE'] = 'application/json';
+		$_GET['_locale']         = 'foo';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_get_param_but_no_json_request() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$_GET['_locale'] = 'user';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_wp_login_get_param_not_on_login_page() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$_GET['wp_lang'] = 'de_DE';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_wp_login_get_param_on_login_page() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$GLOBALS['pagenow'] = 'wp-login.php';
+		$_GET['wp_lang']    = 'de_DE';
+
+		$this->assertSame( 'de_DE', determine_locale() );
+	}
+
+	public function test_wp_login_get_param_on_login_page_empty_string() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$GLOBALS['pagenow'] = 'wp-login.php';
+		$_GET['wp_lang']    = '';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_wp_login_get_param_on_login_page_incorrect_string() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$GLOBALS['pagenow'] = 'wp-login.php';
+		$_GET['wp_lang']    = '###'; // Something sanitize_locale_name() strips away.
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_wp_login_cookie_not_on_login_page() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$_COOKIE['wp_lang'] = 'de_DE';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+
+	public function test_wp_login_cookie_on_login_page() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$GLOBALS['pagenow'] = 'wp-login.php';
+		$_COOKIE['wp_lang'] = 'de_DE';
+
+		$this->assertSame( 'de_DE', determine_locale() );
+	}
+
+	public function test_wp_login_cookie_on_login_page_empty_string() {
+		add_filter(
+			'locale',
+			static function () {
+				return 'siteLocale';
+			}
+		);
+
+		wp_set_current_user( self::$user_id );
+
+		$GLOBALS['pagenow'] = 'wp-login.php';
+		$_COOKIE['wp_lang'] = '';
+
+		$this->assertSame( 'siteLocale', determine_locale() );
+	}
+}
diff --git a/tests/l10n/getLocale.php b/tests/l10n/getLocale.php
index 5044e6ea87..1f16448318 100644
--- a/tests/l10n/getLocale.php
+++ b/tests/l10n/getLocale.php
@@ -74,7 +74,6 @@ class Tests_L10n_GetLocale extends WP_UnitTestCase {
 		$locale = $old_locale;
 
 		$this->assertSame( 'es_ES', $found );
-
 	}
 
 	public function test_should_fall_back_on_en_US() {
diff --git a/tests/l10n/loadTextdomain.php b/tests/l10n/loadTextdomain.php
index 26e567d663..234e98015a 100644
--- a/tests/l10n/loadTextdomain.php
+++ b/tests/l10n/loadTextdomain.php
@@ -300,4 +300,20 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 		$this->assertSame( get_user_locale(), $this->locale );
 	}
+
+	/**
+	 * @ticket 58035
+	 *
+	 * @covers ::load_theme_textdomain
+	 */
+	public function test_pre_load_textdomain_filter() {
+		$override_load_textdomain_callback = new MockAction();
+		add_filter( 'override_load_textdomain', array( $override_load_textdomain_callback, 'action' ) );
+
+		add_filter( 'pre_load_textdomain', '__return_true' );
+		load_plugin_textdomain( 'wp-tests-domain' );
+		remove_filter( 'pre_load_textdomain', '__return_true' );
+
+		$this->assertSame( 0, $override_load_textdomain_callback->get_call_count(), 'Expected override_load_textdomain not to be called.' );
+	}
 }
diff --git a/tests/l10n/loadTextdomainJustInTime.php b/tests/l10n/loadTextdomainJustInTime.php
index 4f29c0c586..3b93d4a975 100644
--- a/tests/l10n/loadTextdomainJustInTime.php
+++ b/tests/l10n/loadTextdomainJustInTime.php
@@ -121,6 +121,27 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 		$this->assertInstanceOf( 'NOOP_Translations', $translations );
 	}
 
+	/**
+	 * @ticket 58321
+	 *
+	 * @covers ::get_translations_for_domain
+	 */
+	public function test_get_translations_for_domain_get_locale_is_called_only_once() {
+		$filter_locale = new MockAction();
+		add_filter( 'locale', array( $filter_locale, 'filter' ) );
+
+		get_translations_for_domain( 'internationalized-plugin' );
+		get_translations_for_domain( 'internationalized-plugin' );
+		get_translations_for_domain( 'internationalized-plugin' );
+		$translations = get_translations_for_domain( 'internationalized-plugin' );
+
+		remove_filter( 'locale', array( $filter_locale, 'filter' ) );
+
+		$this->assertSame( 1, $filter_locale->get_call_count() );
+		$this->assertInstanceOf( 'NOOP_Translations', $translations );
+		$this->assertFalse( is_textdomain_loaded( 'internationalized-plugin' ) );
+	}
+
 	/**
 	 * @ticket 37113
 	 *
diff --git a/tests/l10n/wpLocaleSwitcher.php b/tests/l10n/wpLocaleSwitcher.php
index 7d61f54d55..1b0b8f796d 100644
--- a/tests/l10n/wpLocaleSwitcher.php
+++ b/tests/l10n/wpLocaleSwitcher.php
@@ -384,7 +384,7 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$locale_switched_user_locale  = switch_to_locale( $user_locale ); // False.
 		$locale_switched_site_locale  = switch_to_locale( $site_locale ); // True.
 		$site_locale_after_switch     = get_locale();
-		$language_header_after_switch = isset( $l10n['default'] ); // en_US
+		$language_header_after_switch = is_textdomain_loaded( 'default' ); // en_US
 
 		restore_current_locale();
 
diff --git a/tests/link/editTermLink.php b/tests/link/editTermLink.php
index 3128ddfe0e..2e0145e596 100644
--- a/tests/link/editTermLink.php
+++ b/tests/link/editTermLink.php
@@ -101,7 +101,7 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 
 		add_filter(
 			'edit_term_link',
-			function( $location, $term ) {
+			function ( $location, $term ) {
 				$this->assertIsInt( $term );
 			},
 			10,
diff --git a/tests/link/getEditPostLink.php b/tests/link/getEditPostLink.php
new file mode 100644
index 0000000000..2a17e69f75
--- /dev/null
+++ b/tests/link/getEditPostLink.php
@@ -0,0 +1,159 @@
+<?php
+/**
+ * Tests the `get_edit_post_link()` function.
+ *
+ * @since 6.3.0
+ *
+ * @group link
+ *
+ * @covers ::get_edit_post_link
+ */
+class Tests_Link_GetEditPostLink extends WP_UnitTestCase {
+	/**
+	 * The name of the theme to use for the test.
+	 *
+	 * @since 6.3.0
+	 * @var string
+	 */
+	const TEST_THEME = 'block-theme';
+
+	/**
+	 * The id of the user to use for the test.
+	 *
+	 * @since 6.3.0
+	 * @var int
+	 */
+	private static $admin_id;
+
+	/**
+	 * Creates admin user before tests run.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		// Create an admin user because get_edit_post_link() requires 'edit_post' capability.
+		self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
+	}
+
+	/**
+	 * Performs setup tasks for every test.
+	 *
+	 * @since 6.3.0
+	 */
+	public function set_up() {
+		parent::set_up();
+		wp_set_current_user( self::$admin_id );
+		switch_theme( self::TEST_THEME );
+	}
+
+	/**
+	 * Tests getting the edit post link for a post.
+	 */
+	public function test_get_edit_post_link() {
+		$post                 = self::factory()->post->create_and_get(
+			array(
+				'post_type'   => 'post',
+				'post_title'  => 'Test Post',
+				'post_name'   => 'test-post',
+				'post_status' => 'publish',
+			)
+		);
+		$post_type_object     = get_post_type_object( $post->post_type );
+		$link_default_context = admin_url( sprintf( $post_type_object->_edit_link . '&amp;action=edit', $post->ID ) );
+		$link_custom_context  = admin_url( sprintf( $post_type_object->_edit_link . '&action=edit', $post->ID ) );
+
+		$this->assertSame( $link_default_context, get_edit_post_link( $post ), 'Second argument `$context` has a default context of `"display"`.' );
+		$this->assertSame( $link_custom_context, get_edit_post_link( $post, 'something-else' ), 'Pass non-default value in second argument.' );
+	}
+
+	/**
+	 * Tests getting the edit post link for a template post type.
+	 *
+	 * @ticket 57709
+	 */
+	public function test_get_edit_post_link_for_wp_template_post_type() {
+		$template_post = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'wp_template',
+				'post_name'    => 'my_template',
+				'post_title'   => 'My Template',
+				'post_content' => 'Content',
+				'post_excerpt' => 'Description of my template',
+				'tax_input'    => array(
+					'wp_theme' => array(
+						self::TEST_THEME,
+					),
+				),
+			)
+		);
+
+		wp_set_post_terms( $template_post->ID, self::TEST_THEME, 'wp_theme' );
+
+		$post_type_object     = get_post_type_object( $template_post->post_type );
+		$link_default_context = admin_url( sprintf( $post_type_object->_edit_link, $template_post->post_type, get_stylesheet() . '%2F%2Fmy_template' ) );
+		$link_custom_context  = admin_url( sprintf( $post_type_object->_edit_link, $template_post->post_type, get_stylesheet() . '%2F%2Fmy_template' ) );
+
+		$this->assertSame( $link_default_context, get_edit_post_link( $template_post ), 'Second argument `$context` has a default context of `"display"`.' );
+		$this->assertSame( $link_custom_context, get_edit_post_link( $template_post, 'something-else' ), 'Pass non-default value in second argument.' );
+	}
+
+	/**
+	 * Tests getting the edit post link for a template part post type.
+	 *
+	 * @ticket 57709
+	 */
+	public function test_get_edit_post_link_for_wp_template_part_post_type() {
+		$template_part_post = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'wp_template_part',
+				'post_name'    => 'my_template_part',
+				'post_title'   => 'My Template Part',
+				'post_content' => 'Content',
+				'post_excerpt' => 'Description of my template part',
+				'tax_input'    => array(
+					'wp_theme'              => array(
+						self::TEST_THEME,
+					),
+					'wp_template_part_area' => array(
+						WP_TEMPLATE_PART_AREA_HEADER,
+					),
+				),
+			)
+		);
+
+		wp_set_post_terms( $template_part_post->ID, WP_TEMPLATE_PART_AREA_HEADER, 'wp_template_part_area' );
+		wp_set_post_terms( $template_part_post->ID, self::TEST_THEME, 'wp_theme' );
+
+		$post_type_object     = get_post_type_object( $template_part_post->post_type );
+		$link_default_context = admin_url( sprintf( $post_type_object->_edit_link, $template_part_post->post_type, get_stylesheet() . '%2F%2Fmy_template_part' ) );
+		$link_custom_context  = admin_url( sprintf( $post_type_object->_edit_link, $template_part_post->post_type, get_stylesheet() . '%2F%2Fmy_template_part' ) );
+
+		$this->assertSame( $link_default_context, get_edit_post_link( $template_part_post ), 'Second argument `$context` has a default context of `"display"`.' );
+		$this->assertSame( $link_custom_context, get_edit_post_link( $template_part_post, 'something-else' ), 'Pass non-default value in second argument.' );
+	}
+
+	/**
+	 * Tests getting the edit post link for a wp_navigation post type.
+	 *
+	 * @ticket 58589
+	 * */
+	public function test_get_edit_post_link_for_wp_navigation_post_type() {
+		$navigation_post = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'wp_navigation',
+				'post_name'    => 'my_navigation',
+				'post_title'   => 'My Navigation',
+				'post_content' => '<!-- wp:navigation-link {"label":"WordPress","type":"custom","url":"http://www.wordpress.org/","kind":"custom"} /-->',
+				'post_excerpt' => 'Description of my Navigation',
+			)
+		);
+
+		$post_type_object = get_post_type_object( $navigation_post->post_type );
+
+		$link_default_context = admin_url( sprintf( $post_type_object->_edit_link, $navigation_post->ID ) );
+		$link_custom_context  = admin_url( sprintf( $post_type_object->_edit_link, $navigation_post->ID ) );
+
+		$this->assertSame( $link_default_context, get_edit_post_link( $navigation_post ), 'Second argument `$context` has a default context of `"display"`.' );
+		$this->assertSame( $link_custom_context, get_edit_post_link( $navigation_post, 'something-else' ), 'Pass non-default value in second argument.' );
+	}
+}
diff --git a/tests/link/getEditTermLink.php b/tests/link/getEditTermLink.php
index 2df1aa7aac..d0303f1b1a 100644
--- a/tests/link/getEditTermLink.php
+++ b/tests/link/getEditTermLink.php
@@ -187,7 +187,7 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 
 		add_filter(
 			'get_edit_term_link',
-			function( $location, $term ) {
+			function ( $location, $term ) {
 				$this->assertIsInt( $term );
 			},
 			10,
diff --git a/tests/link/getNextCommentsLink.php b/tests/link/getNextCommentsLink.php
index 459ad9d176..fc18dc3f4c 100644
--- a/tests/link/getNextCommentsLink.php
+++ b/tests/link/getNextCommentsLink.php
@@ -37,5 +37,4 @@ class Tests_Link_GetNextCommentsLink extends WP_UnitTestCase {
 
 		set_query_var( 'cpage', $cpage );
 	}
-
 }
diff --git a/tests/link/getPostPermalink.php b/tests/link/getPostPermalink.php
index 16d1da0bea..fa36e8bfea 100644
--- a/tests/link/getPostPermalink.php
+++ b/tests/link/getPostPermalink.php
@@ -14,5 +14,4 @@ class Tests_Link_GetPostPermalink extends WP_UnitTestCase {
 	public function test_get_post_permalink_should_return_false_for_non_existing_post() {
 		$this->assertFalse( get_post_permalink( -1 ) );
 	}
-
 }
diff --git a/tests/link/getPreviewPostLink.php b/tests/link/getPreviewPostLink.php
index a689cb31f3..ce4dcf2c4a 100644
--- a/tests/link/getPreviewPostLink.php
+++ b/tests/link/getPreviewPostLink.php
@@ -83,5 +83,4 @@ class Tests_Link_GetPreviewPostLink extends WP_UnitTestCase {
 
 		$this->assertSame( '', get_preview_post_link( $post ) );
 	}
-
 }
diff --git a/tests/link/getPreviousCommentsLink.php b/tests/link/getPreviousCommentsLink.php
index cda521a204..596a6eaca0 100644
--- a/tests/link/getPreviousCommentsLink.php
+++ b/tests/link/getPreviousCommentsLink.php
@@ -35,5 +35,4 @@ class Tests_Link_GetPreviousCommentsLink extends WP_UnitTestCase {
 
 		set_query_var( 'cpage', $cpage );
 	}
-
 }
diff --git a/tests/link/getThePostsNavigation.php b/tests/link/getThePostsNavigation.php
index 83c262d911..d7d3846b9a 100644
--- a/tests/link/getThePostsNavigation.php
+++ b/tests/link/getThePostsNavigation.php
@@ -104,5 +104,4 @@ class Tests_Link_GetThePostsNavigation extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/link/nextPosts.php b/tests/link/nextPosts.php
new file mode 100644
index 0000000000..de43f5fedd
--- /dev/null
+++ b/tests/link/nextPosts.php
@@ -0,0 +1,41 @@
+<?php
+
+/**
+ * Tests the `next_posts()` function.
+ *
+ * @since 6.4.0
+ *
+ * @group link
+ *
+ * @covers ::next_posts
+ */
+class Tests_Link_NextPosts extends WP_UnitTestCase {
+
+	/**
+	 * Creates posts before any tests run.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		global $wp_query, $paged;
+
+		$factory->post->create_many( 3 );
+		$paged    = 2;
+		$wp_query = new WP_Query(
+			array(
+				'post_type'      => 'post',
+				'posts_per_page' => 1,
+				'paged'          => $paged,
+			)
+		);
+	}
+
+	/**
+	 * The absence of a deprecation notice on PHP 8.1+ also shows that the issue is resolved.
+	 *
+	 * @ticket 59154
+	 */
+	public function test_should_return_empty_string_when_no_next_posts_page_link() {
+		$this->assertSame( '', next_posts( 1, false ) );
+	}
+}
diff --git a/tests/link/themeFile.php b/tests/link/themeFile.php
index f988dc1006..5d8fe66442 100644
--- a/tests/link/themeFile.php
+++ b/tests/link/themeFile.php
@@ -129,7 +129,6 @@ class Tests_Link_ThemeFile extends WP_UnitTestCase {
 		} else {
 			$this->assertFileDoesNotExist( WP_CONTENT_DIR . "/themes/theme-file-parent/{$file}" );
 		}
-
 	}
 
 	/**
@@ -182,5 +181,4 @@ class Tests_Link_ThemeFile extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/load/wpGetDevelopmentMode.php b/tests/load/wpGetDevelopmentMode.php
new file mode 100644
index 0000000000..430c6b4948
--- /dev/null
+++ b/tests/load/wpGetDevelopmentMode.php
@@ -0,0 +1,160 @@
+<?php
+/**
+ * Unit tests for `wp_get_development_mode()`.
+ *
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 6.3.0
+ *
+ * @group load.php
+ * @covers ::wp_get_development_mode
+ * @covers ::wp_is_development_mode
+ */
+class Test_WP_Get_Development_Mode extends WP_UnitTestCase {
+
+	/**
+	 * Tests that `wp_get_development_mode()` returns the value of the `WP_DEVELOPMENT_MODE` constant.
+	 *
+	 * @ticket 57487
+	 */
+	public function test_wp_get_development_mode_constant() {
+		$this->assertSame( WP_DEVELOPMENT_MODE, wp_get_development_mode() );
+	}
+
+	/**
+	 * Tests that `wp_get_development_mode()` allows test overrides.
+	 *
+	 * @ticket 57487
+	 */
+	public function test_wp_get_development_mode_test_overrides() {
+		global $_wp_tests_development_mode;
+
+		$_wp_tests_development_mode = 'plugin';
+		$this->assertSame( 'plugin', wp_get_development_mode() );
+	}
+
+	/**
+	 * Tests that `wp_get_development_mode()` ignores invalid filter values.
+	 *
+	 * @ticket 57487
+	 */
+	public function test_wp_get_development_mode_filter_invalid_value() {
+		global $_wp_tests_development_mode;
+
+		$_wp_tests_development_mode = 'invalid';
+		$this->assertSame( '', wp_get_development_mode() );
+	}
+
+	/**
+	 * Tests that `wp_is_development_mode()` returns expected results.
+	 *
+	 * @ticket 57487
+	 * @dataProvider data_wp_is_development_mode
+	 */
+	public function test_wp_is_development_mode( $current, $given, $expected ) {
+		global $_wp_tests_development_mode;
+
+		$_wp_tests_development_mode = $current;
+
+		if ( $expected ) {
+			$this->assertTrue( wp_is_development_mode( $given ), "{$given} is expected to pass in {$current} mode" );
+		} else {
+			$this->assertFalse( wp_is_development_mode( $given ), "{$given} is expected to fail in {$current} mode" );
+		}
+	}
+
+	/**
+	 * Data provider that returns test scenarios for the `test_wp_is_development_mode()` method.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_is_development_mode() {
+		return array(
+			'core mode, testing for core'              => array(
+				'core',
+				'core',
+				true,
+			),
+			'plugin mode, testing for plugin'          => array(
+				'plugin',
+				'plugin',
+				true,
+			),
+			'theme mode, testing for theme'            => array(
+				'theme',
+				'theme',
+				true,
+			),
+			'core mode, testing for plugin'            => array(
+				'core',
+				'plugin',
+				false,
+			),
+			'core mode, testing for theme'             => array(
+				'core',
+				'theme',
+				false,
+			),
+			'plugin mode, testing for core'            => array(
+				'plugin',
+				'core',
+				false,
+			),
+			'plugin mode, testing for theme'           => array(
+				'plugin',
+				'theme',
+				false,
+			),
+			'theme mode, testing for core'             => array(
+				'theme',
+				'core',
+				false,
+			),
+			'theme mode, testing for plugin'           => array(
+				'theme',
+				'plugin',
+				false,
+			),
+			'all mode, testing for core'               => array(
+				'all',
+				'core',
+				true,
+			),
+			'all mode, testing for plugin'             => array(
+				'all',
+				'plugin',
+				true,
+			),
+			'all mode, testing for theme'              => array(
+				'all',
+				'theme',
+				true,
+			),
+			'all mode, testing for all'                => array(
+				'all',
+				'all',
+				true,
+			),
+			'all mode, testing for non-standard value' => array(
+				'all',
+				'random',
+				true,
+			),
+			'invalid mode, testing for core'           => array(
+				'invalid',
+				'core',
+				false,
+			),
+			'invalid mode, testing for plugin'         => array(
+				'invalid',
+				'plugin',
+				false,
+			),
+			'invalid mode, testing for theme'          => array(
+				'invalid',
+				'theme',
+				false,
+			),
+		);
+	}
+}
diff --git a/tests/media.php b/tests/media.php
index 1817af955b..3b8615dd82 100644
--- a/tests/media.php
+++ b/tests/media.php
@@ -75,6 +75,17 @@ CAP;
 		parent::tear_down_after_class();
 	}
 
+	/**
+	 * Ensures that the static content media count, fetchpriority element flag and related filter are reset between tests.
+	 */
+	public function tear_down() {
+		parent::tear_down();
+
+		$this->reset_content_media_count();
+		$this->reset_omit_loading_attr_filter();
+		$this->reset_high_priority_element_flag();
+	}
+
 	public function test_img_caption_shortcode_added() {
 		global $shortcode_tags;
 		$this->assertSame( 'img_caption_shortcode', $shortcode_tags['caption'] );
@@ -191,7 +202,6 @@ CAP;
 			)
 		);
 		$this->assertSame( 1, substr_count( $result, 'wp-caption alignnone some-class another-class' ) );
-
 	}
 
 	public function test_new_img_caption_shortcode_with_html_caption() {
@@ -542,8 +552,8 @@ https://w.org</a>',
 			$ids2_srcs[] = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
 		}
 
-		$ids1_joined = join( ',', array_slice( $ids1, 0, 3 ) );
-		$ids2_joined = join( ',', array_slice( $ids2, 3, 3 ) );
+		$ids1_joined = implode( ',', array_slice( $ids1, 0, 3 ) );
+		$ids2_joined = implode( ',', array_slice( $ids2, 3, 3 ) );
 
 		$blob    = <<<BLOB
 [gallery ids="$ids1_joined"]
@@ -628,8 +638,8 @@ BLOB;
 			$imgs[]     = '<figure><img src="' . $url . '" data-id="' . $i . '" /></figure>';
 		}
 
-		$imgs1_joined = join( "\n", array_slice( $imgs, 0, 3 ) );
-		$imgs2_joined = join( "\n", array_slice( $imgs, 3, 3 ) );
+		$imgs1_joined = implode( "\n", array_slice( $imgs, 0, 3 ) );
+		$imgs2_joined = implode( "\n", array_slice( $imgs, 3, 3 ) );
 
 		$blob    = <<<BLOB
 <!-- wp:gallery -->
@@ -667,8 +677,8 @@ BLOB;
 
 		}
 
-		$ids1_joined = join( ',', array_slice( $ids, 0, 3 ) );
-		$ids2_joined = join( ',', array_slice( $ids, 3, 3 ) );
+		$ids1_joined = implode( ',', array_slice( $ids, 0, 3 ) );
+		$ids2_joined = implode( ',', array_slice( $ids, 3, 3 ) );
 
 		$blob    = <<<BLOB
 <!-- wp:gallery {"ids":[$ids1_joined]} -->
@@ -708,9 +718,9 @@ BLOB;
 			$imgs[]     = '<figure><img src="' . $url . '" data-id="' . $i . '" /></figure>';
 		}
 
-		$ids1_joined  = join( "\n", array_slice( $ids, 0, 3 ) );
-		$ids2_joined  = join( "\n", array_slice( $ids, 3, 3 ) );
-		$imgs2_joined = join( "\n", array_slice( $imgs, 3, 3 ) );
+		$ids1_joined  = implode( "\n", array_slice( $ids, 0, 3 ) );
+		$ids2_joined  = implode( "\n", array_slice( $ids, 3, 3 ) );
+		$imgs2_joined = implode( "\n", array_slice( $imgs, 3, 3 ) );
 
 		$blob    = <<<BLOB
 [gallery ids="$ids1_joined"]
@@ -752,7 +762,7 @@ BLOB;
 
 		}
 
-		$imgs_joined = join( "\n", $imgs );
+		$imgs_joined = implode( "\n", $imgs );
 
 		$blob    = <<<BLOB
 <!-- wp:columns -->
@@ -795,7 +805,7 @@ BLOB;
 
 		}
 
-		$imgs_joined = join( "\n", $imgs );
+		$imgs_joined = implode( "\n", $imgs );
 
 		$blob    = <<<BLOB
 <!-- wp:gallery -->
@@ -1732,7 +1742,6 @@ EOF;
 			$expected_srcset = $this->src_first( $_expected, $image_url, $size_array[0] );
 			$this->assertSame( $expected_srcset, wp_calculate_image_srcset( $size_array, $image_url, $image_meta ) );
 		}
-
 	}
 
 	/**
@@ -2254,16 +2263,17 @@ EOF;
 			$respimg_xhtml,
 			$respimg_html5
 		);
-		$content_filtered = wp_img_tag_add_decoding_attr( $content_filtered, 'the_content' );
 
 		// Do not add width, height, and loading.
 		add_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
 		add_filter( 'wp_img_tag_add_loading_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 
 		$this->assertSame( $content_filtered, wp_filter_content_tags( $content_unfiltered ) );
 
 		remove_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
 		remove_filter( 'wp_img_tag_add_loading_attr', '__return_false' );
+		remove_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 	}
 
 	/**
@@ -2279,8 +2289,7 @@ EOF;
 	 */
 	public function test_wp_filter_content_tags_srcset_sizes_wrong() {
 		$img = get_image_tag( self::$large_id, '', '', '', 'medium' );
-		$img = wp_img_tag_add_loading_attr( $img, 'test' );
-		$img = wp_img_tag_add_decoding_attr( $img, 'the_content' );
+		$img = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
 
 		// Replace the src URL.
 		$image_wrong_src = preg_replace( '|src="[^"]+"|', 'src="http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/foo.jpg"', $img );
@@ -2294,8 +2303,7 @@ EOF;
 	public function test_wp_filter_content_tags_srcset_sizes_with_preexisting_srcset() {
 		// Generate HTML and add a dummy srcset attribute.
 		$img = get_image_tag( self::$large_id, '', '', '', 'medium' );
-		$img = wp_img_tag_add_loading_attr( $img, 'test' );
-		$img = wp_img_tag_add_decoding_attr( $img, 'the_content' );
+		$img = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
 		$img = preg_replace( '|<img ([^>]+) />|', '<img $1 ' . 'srcset="image2x.jpg 2x" />', $img );
 
 		// The content filter should return the image unchanged.
@@ -2348,7 +2356,7 @@ EOF;
 
 		add_filter(
 			'wp_content_img_tag',
-			function( $filtered_image ) {
+			static function ( $filtered_image ) {
 				return "<span>$filtered_image</span>";
 			}
 		);
@@ -2372,7 +2380,7 @@ EOF;
 
 		add_filter(
 			'wp_content_img_tag',
-			function( $filtered_image ) {
+			static function ( $filtered_image ) {
 				return "<span>$filtered_image</span>";
 			}
 		);
@@ -2439,7 +2447,7 @@ EOF;
 
 		// Build HTML for the editor.
 		$img          = get_image_tag( self::$large_id, '', '', '', 'medium' );
-		$img          = wp_img_tag_add_loading_attr( $img, 'test' );
+		$img          = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
 		$img_https    = str_replace( 'http://', 'https://', $img );
 		$img_relative = str_replace( 'http://', '//', $img );
 
@@ -2471,7 +2479,6 @@ EOF;
 			$respimg_https,
 			$respimg_relative
 		);
-		$expected = wp_img_tag_add_decoding_attr( $expected, 'the_content' );
 
 		$actual = wp_filter_content_tags( $unfiltered );
 
@@ -2964,22 +2971,24 @@ EOF;
 			$img_no_width,
 			$img_no_height
 		);
-		$content_filtered = wp_img_tag_add_decoding_attr( $content_filtered, 'the_content' );
 
 		// Do not add loading, srcset, and sizes.
 		add_filter( 'wp_img_tag_add_loading_attr', '__return_false' );
 		add_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 
 		$this->assertSame( $content_filtered, wp_filter_content_tags( $content_unfiltered ) );
 
 		remove_filter( 'wp_img_tag_add_loading_attr', '__return_false' );
 		remove_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		remove_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 	}
 
 	/**
 	 * @ticket 44427
 	 * @ticket 50367
 	 * @ticket 50756
+	 * @ticket 58235
 	 * @requires function imagejpeg
 	 */
 	public function test_wp_filter_content_tags_loading_lazy() {
@@ -2994,13 +3003,15 @@ EOF;
 		$iframe                 = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
 		$iframe_no_width_height = '<iframe src="https://www.example.com"></iframe>';
 
-		$lazy_img       = wp_img_tag_add_loading_attr( $img, 'test' );
-		$lazy_img_xhtml = wp_img_tag_add_loading_attr( $img_xhtml, 'test' );
-		$lazy_img_html5 = wp_img_tag_add_loading_attr( $img_html5, 'test' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
+
+		$lazy_img       = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
+		$lazy_img_xhtml = wp_img_tag_add_loading_optimization_attrs( $img_xhtml, 'test' );
+		$lazy_img_html5 = wp_img_tag_add_loading_optimization_attrs( $img_html5, 'test' );
 		$lazy_iframe    = wp_iframe_tag_add_loading_attr( $iframe, 'test' );
 
 		// The following should not be modified because there already is a 'loading' attribute.
-		$img_eager    = str_replace( ' />', ' loading="eager" />', $img );
+		$img_eager    = str_replace( ' />', ' loading="eager" fetchpriority="high" />', $img );
 		$iframe_eager = str_replace( '">', '" loading="eager">', $iframe );
 
 		$content = '
@@ -3044,7 +3055,6 @@ EOF;
 			$iframe_eager,
 			$iframe_no_width_height
 		);
-		$content_filtered = wp_img_tag_add_decoding_attr( $content_filtered, 'the_content' );
 
 		// Do not add width, height, srcset, and sizes.
 		add_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
@@ -3054,16 +3064,17 @@ EOF;
 
 		remove_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
 		remove_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		remove_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 	}
 
 	/**
 	 * @ticket 44427
 	 * @ticket 50756
+	 * @ticket 58235
 	 */
 	public function test_wp_filter_content_tags_loading_lazy_opted_in() {
 		$img         = get_image_tag( self::$large_id, '', '', '', 'medium' );
-		$lazy_img    = wp_img_tag_add_loading_attr( $img, 'test' );
-		$lazy_img    = wp_img_tag_add_decoding_attr( $lazy_img, 'the_content' );
+		$lazy_img    = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
 		$iframe      = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
 		$lazy_iframe = wp_iframe_tag_add_loading_attr( $iframe, 'test' );
 
@@ -3093,7 +3104,6 @@ EOF;
 	 */
 	public function test_wp_filter_content_tags_loading_lazy_opted_out() {
 		$img    = get_image_tag( self::$large_id, '', '', '', 'medium' );
-		$img    = wp_img_tag_add_decoding_attr( $img, 'the_content' );
 		$iframe = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
 
 		$content = '
@@ -3108,15 +3118,20 @@ EOF;
 
 		// Disable globally for all tags.
 		add_filter( 'wp_lazy_loading_enabled', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 
 		$this->assertSame( $content, wp_filter_content_tags( $content ) );
 		remove_filter( 'wp_lazy_loading_enabled', '__return_false' );
 		remove_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		remove_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 	}
 
 	/**
 	 * @ticket 44427
 	 * @ticket 50367
+	 *
+	 * @expectedDeprecated wp_img_tag_add_loading_attr
+	 * @expectedDeprecated wp_get_loading_attr_default
 	 */
 	public function test_wp_img_tag_add_loading_attr() {
 		$img = '<img src="example.png" alt=" width="300" height="225" />';
@@ -3128,6 +3143,9 @@ EOF;
 	/**
 	 * @ticket 44427
 	 * @ticket 50367
+	 *
+	 * @expectedDeprecated wp_img_tag_add_loading_attr
+	 * @expectedDeprecated wp_get_loading_attr_default
 	 */
 	public function test_wp_img_tag_add_loading_attr_without_src() {
 		$img = '<img alt=" width="300" height="225" />';
@@ -3139,6 +3157,9 @@ EOF;
 	/**
 	 * @ticket 44427
 	 * @ticket 50367
+	 *
+	 * @expectedDeprecated wp_img_tag_add_loading_attr
+	 * @expectedDeprecated wp_get_loading_attr_default
 	 */
 	public function test_wp_img_tag_add_loading_attr_with_single_quotes() {
 		$img = "<img src='example.png' alt=' width='300' height='225' />";
@@ -3166,6 +3187,8 @@ EOF;
 	 * Test that decoding="async" is not applied to img tags with single quotes.
 	 *
 	 * @ticket 56969
+	 *
+	 * @expectedDeprecated wp_img_tag_add_decoding_attr
 	 */
 	public function test_wp_img_tag_add_decoding_attr_with_single_quotes() {
 		$img = "<img src='example.png' alt='' width='300' height='225' />";
@@ -3278,6 +3301,93 @@ EOF;
 		$this->assertStringNotContainsString( ' loading=', $img );
 	}
 
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_attachment_image
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_attachment_image_fetchpriority_not_present_by_default() {
+		$img = wp_get_attachment_image( self::$large_id );
+
+		$this->assertStringNotContainsString( ' fetchpriority="high"', $img );
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_attachment_image
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_attachment_image_fetchpriority_high_when_not_lazy_loaded() {
+		$img = wp_get_attachment_image( self::$large_id, 'large', false, array( 'loading' => false ) );
+
+		$this->assertStringContainsString( ' fetchpriority="high"', $img );
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @dataProvider data_provider_fetchpriority_values
+	 *
+	 * @covers ::wp_get_attachment_image
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_attachment_image_fetchpriority_original_value_respected( $value ) {
+		$img = wp_get_attachment_image(
+			self::$large_id,
+			'large',
+			false,
+			array(
+				'loading'       => false,
+				'fetchpriority' => $value,
+			)
+		);
+
+		$this->assertStringContainsString( ' fetchpriority="' . $value . '"', $img );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_provider_fetchpriority_values() {
+		return self::text_array_to_dataprovider( array( 'high', 'low', 'auto' ) );
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_attachment_image
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_attachment_image_fetchpriority_stripped_when_false() {
+		$img = wp_get_attachment_image(
+			self::$large_id,
+			'large',
+			false,
+			array(
+				'loading'       => false,
+				'fetchpriority' => false,
+			)
+		);
+
+		$this->assertStringNotContainsString( ' fetchpriority=', $img );
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_attachment_image
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_attachment_image_fetchpriority_high_prevents_lazy_loading() {
+		$img = wp_get_attachment_image( self::$large_id, 'large', false, array( 'fetchpriority' => 'high' ) );
+
+		$this->assertStringNotContainsString( ' loading="lazy"', $img );
+	}
+
 	/**
 	 * @ticket 57086
 	 *
@@ -3330,10 +3440,6 @@ EOF;
 				'decoding' => false,
 				'expected' => 'no value',
 			),
-			'null'        => array(
-				'decoding' => null,
-				'expected' => 'no value',
-			),
 			'zero'        => array(
 				'decoding' => 0,
 				'expected' => 'no value',
@@ -3554,13 +3660,13 @@ EOF;
 	 *
 	 * @covers ::wp_get_loading_attr_default
 	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
 	 * @dataProvider data_wp_get_loading_attr_default
 	 *
 	 * @param string $context
 	 */
 	public function test_wp_get_loading_attr_default( $context ) {
-		global $wp_query, $wp_the_query;
-
 		// Return 'lazy' by default.
 		$this->assertSame( 'lazy', wp_get_loading_attr_default( 'test' ) );
 		$this->assertSame( 'lazy', wp_get_loading_attr_default( 'wp_get_attachment_image' ) );
@@ -3568,9 +3674,7 @@ EOF;
 		// Return 'lazy' if not in the loop or the main query.
 		$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
 
-		$wp_query = new WP_Query( array( 'post__in' => array( self::$post_ids['publish'] ) ) );
-		$this->reset_content_media_count();
-		$this->reset_omit_loading_attr_filter();
+		$query = $this->get_new_wp_query_for_published_post();
 
 		while ( have_posts() ) {
 			the_post();
@@ -3579,14 +3683,18 @@ EOF;
 			$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
 
 			// Set as main query.
-			$wp_the_query = $wp_query;
+			$this->set_main_query( $query );
 
-			// For contexts other than for the main content, still return 'lazy' even in the loop
-			// and in the main query, and do not increase the content media count.
+			/*
+			 * For contexts other than for the main content, still return 'lazy' even in the loop
+			 * and in the main query, and do not increase the content media count.
+			 */
 			$this->assertSame( 'lazy', wp_get_loading_attr_default( 'wp_get_attachment_image' ) );
 
-			// Return `false` if in the loop and in the main query and it is the first element.
-			$this->assertFalse( wp_get_loading_attr_default( $context ) );
+			// Return `false` in the main query for first three element.
+			$this->assertFalse( wp_get_loading_attr_default( $context ), 'Expected first image to not be lazy-loaded.' );
+			$this->assertFalse( wp_get_loading_attr_default( $context ), 'Expected second image to not be lazy-loaded.' );
+			$this->assertFalse( wp_get_loading_attr_default( $context ), 'Expected third image to not be lazy-loaded.' );
 
 			// Return 'lazy' if in the loop and in the main query for any subsequent elements.
 			$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
@@ -3609,68 +3717,76 @@ EOF;
 
 	/**
 	 * @ticket 53675
+	 * @ticket 58235
+	 * @ticket 58892
 	 */
 	public function test_wp_omit_loading_attr_threshold_filter() {
-		global $wp_query, $wp_the_query;
+		// Using a smaller image here.
+		$attr = array(
+			'width'  => 100,
+			'height' => 100,
+		);
 
-		$wp_query     = new WP_Query( array( 'post__in' => array( self::$post_ids['publish'] ) ) );
-		$wp_the_query = $wp_query;
-		$this->reset_content_media_count();
-		$this->reset_omit_loading_attr_filter();
+		$query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $query );
 
-		// Use the filter to alter the threshold for not lazy-loading to the first three elements.
-		add_filter(
-			'wp_omit_loading_attr_threshold',
-			function() {
-				return 3;
-			}
-		);
+		// Use the filter to alter the threshold for not lazy-loading to the first five elements.
+		$this->force_omit_loading_attr_threshold( 5 );
 
 		while ( have_posts() ) {
 			the_post();
 
-			// Due to the filter, now the first three elements should not be lazy-loaded, i.e. return `false`.
-			for ( $i = 0; $i < 3; $i++ ) {
-				$this->assertFalse( wp_get_loading_attr_default( 'the_content' ) );
+			// Due to the filter, now the first five elements should not be lazy-loaded, i.e. return `false`.
+			for ( $i = 0; $i < 5; $i++ ) {
+				$this->assertSameSetsWithIndex(
+					array(
+						'decoding' => 'async',
+					),
+					wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+					'Expected second image to not be lazy-loaded.'
+				);
 			}
 
 			// For following elements, lazy-load them again.
-			$this->assertSame( 'lazy', wp_get_loading_attr_default( 'the_content' ) );
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding' => 'async',
+					'loading'  => 'lazy',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' )
+			);
 		}
 	}
 
 	/**
 	 * @ticket 53675
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_img_tag_add_loading_optimization_attrs
+	 * @covers ::wp_get_loading_optimization_attributes
 	 */
-	public function test_wp_filter_content_tags_with_wp_get_loading_attr_default() {
-		global $wp_query, $wp_the_query;
-
+	public function test_wp_filter_content_tags_with_loading_optimization_attrs() {
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 		$img1         = get_image_tag( self::$large_id, '', '', '', 'large' );
 		$iframe1      = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
 		$img2         = get_image_tag( self::$large_id, '', '', '', 'medium' );
 		$img3         = get_image_tag( self::$large_id, '', '', '', 'thumbnail' );
 		$iframe2      = '<iframe src="https://wordpress.org" width="640" height="360"></iframe>';
-		$lazy_img2    = wp_img_tag_add_loading_attr( $img2, 'the_content' );
-		$lazy_img3    = wp_img_tag_add_loading_attr( $img3, 'the_content' );
+		$prio_img1    = str_replace( ' src=', ' fetchpriority="high" src=', $img1 );
+		$lazy_img2    = wp_img_tag_add_loading_optimization_attrs( $img2, 'the_content' );
+		$lazy_img3    = wp_img_tag_add_loading_optimization_attrs( $img3, 'the_content' );
 		$lazy_iframe2 = wp_iframe_tag_add_loading_attr( $iframe2, 'the_content' );
 
 		// Use a threshold of 2.
-		add_filter(
-			'wp_omit_loading_attr_threshold',
-			function() {
-				return 2;
-			}
-		);
+		$this->force_omit_loading_attr_threshold( 2 );
 
 		// Following the threshold of 2, the first two content media elements should not be lazy-loaded.
 		$content_unfiltered = $img1 . $iframe1 . $img2 . $img3 . $iframe2;
-		$content_expected   = $img1 . $iframe1 . $lazy_img2 . $lazy_img3 . $lazy_iframe2;
-		$content_expected   = wp_img_tag_add_decoding_attr( $content_expected, 'the_content' );
+		$content_expected   = $prio_img1 . $iframe1 . $lazy_img2 . $lazy_img3 . $lazy_iframe2;
 
-		$wp_query     = new WP_Query( array( 'post__in' => array( self::$post_ids['publish'] ) ) );
-		$wp_the_query = $wp_query;
-		$this->reset_content_media_count();
-		$this->reset_omit_loading_attr_filter();
+		$query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $query );
 
 		while ( have_posts() ) {
 			the_post();
@@ -3679,6 +3795,7 @@ EOF;
 			$content_filtered = wp_filter_content_tags( $content_unfiltered, 'the_content' );
 			remove_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
 		}
+		remove_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 
 		// After filtering, the first image should not be lazy-loaded while the other ones should be.
 		$this->assertSame( $content_expected, $content_filtered );
@@ -3690,24 +3807,156 @@ EOF;
 	public function test_wp_omit_loading_attr_threshold() {
 		$this->reset_omit_loading_attr_filter();
 
-		// Apply filter, ensure default value of 1.
+		// Apply filter, ensure default value of 3.
 		$omit_threshold = wp_omit_loading_attr_threshold();
-		$this->assertSame( 1, $omit_threshold );
+		$this->assertSame( 3, $omit_threshold );
+
+		// Add a filter that changes the value to 1. However, the filter is not applied a subsequent time in a single
+		// page load by default, so the value is still 3.
+		$this->force_omit_loading_attr_threshold( 1 );
 
-		// Add a filter that changes the value to 3. However, the filter is not applied a subsequent time in a single
-		// page load by default, so the value is still 1.
-		add_filter(
-			'wp_omit_loading_attr_threshold',
-			function() {
-				return 3;
-			}
-		);
 		$omit_threshold = wp_omit_loading_attr_threshold();
-		$this->assertSame( 1, $omit_threshold );
+		$this->assertSame( 3, $omit_threshold );
 
 		// Only by enforcing a fresh check, the filter gets re-applied.
 		$omit_threshold = wp_omit_loading_attr_threshold( true );
-		$this->assertSame( 3, $omit_threshold );
+		$this->assertSame( 1, $omit_threshold );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute value before loop but after get_header if not main query.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_before_loop_if_not_main_query( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+
+		do_action( 'get_header' );
+
+		// Lazy if not main query.
+		$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute value before loop but after get_header in main query but header was not called.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_before_loop_in_main_query_but_header_not_called( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		// Lazy if header not called.
+		$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute value before loop but after get_header for main query.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_before_loop_if_main_query( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		do_action( 'get_header' );
+		$this->assertFalse( wp_get_loading_attr_default( $context ) );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute value after get_header and after loop.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_after_loop( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		do_action( 'get_header' );
+
+		while ( have_posts() ) {
+			the_post();
+		}
+		$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute if no loop.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_no_loop( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		// Ensure header and footer is called.
+		do_action( 'get_header' );
+		do_action( 'get_footer' );
+
+		// Load lazy if the there is no loop and footer was called.
+		$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_loading_attr_default_before_and_no_loop() {
+		return array(
+			array( 'wp_get_attachment_image' ),
+			array( 'the_post_thumbnail' ),
+		);
 	}
 
 	/**
@@ -3715,9 +3964,12 @@ EOF;
 	 * image in the loop when using a block theme.
 	 *
 	 * @ticket 56930
+	 * @ticket 58548
+	 * @ticket 58235
 	 *
 	 * @covers ::wp_filter_content_tags
-	 * @covers ::wp_get_loading_attr_default
+	 * @covers ::wp_img_tag_add_loading_optimization_attrs
+	 * @covers ::wp_get_loading_optimization_attributes
 	 */
 	public function test_wp_filter_content_tags_does_not_lazy_load_first_image_in_block_theme() {
 		global $_wp_current_template_content, $wp_query, $wp_the_query, $post;
@@ -3725,14 +3977,16 @@ EOF;
 		// Do not add srcset, sizes, or decoding attributes as they are irrelevant for this test.
 		add_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
 		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
+		$this->force_omit_loading_attr_threshold( 1 );
 
 		$img1      = get_image_tag( self::$large_id, '', '', '', 'large' );
 		$img2      = get_image_tag( self::$large_id, '', '', '', 'medium' );
-		$lazy_img2 = wp_img_tag_add_loading_attr( $img2, 'the_content' );
+		$prio_img1 = str_replace( ' src=', ' fetchpriority="high" src=', $img1 );
+		$lazy_img2 = wp_img_tag_add_loading_optimization_attrs( $img2, 'the_content' );
 
 		// Only the second image should be lazy-loaded.
 		$post_content     = $img1 . $img2;
-		$expected_content = wpautop( $img1 . $lazy_img2 );
+		$expected_content = wpautop( $prio_img1 . $lazy_img2 );
 
 		// Update the post to test with so that it has the above post content.
 		wp_update_post(
@@ -3746,13 +4000,11 @@ EOF;
 		$wp_query     = new WP_Query( array( 'p' => self::$post_ids['publish'] ) );
 		$wp_the_query = $wp_query;
 		$post         = get_post( self::$post_ids['publish'] );
-		$this->reset_content_media_count();
-		$this->reset_omit_loading_attr_filter();
 
 		$_wp_current_template_content = '<!-- wp:post-content /-->';
 
 		$html = get_the_block_template_html();
-		$this->assertSame( '<div class="wp-site-blocks"><div class="entry-content wp-block-post-content is-layout-flow">' . $expected_content . '</div></div>', $html );
+		$this->assertSame( '<div class="wp-site-blocks"><div class="entry-content wp-block-post-content is-layout-flow wp-block-post-content-is-layout-flow">' . $expected_content . '</div></div>', $html );
 	}
 
 	/**
@@ -3760,9 +4012,12 @@ EOF;
 	 * to the featured image when using a block theme.
 	 *
 	 * @ticket 56930
+	 * @ticket 58548
+	 * @ticket 58235
 	 *
 	 * @covers ::wp_filter_content_tags
-	 * @covers ::wp_get_loading_attr_default
+	 * @covers ::wp_img_tag_add_loading_optimization_attrs
+	 * @covers ::wp_get_loading_optimization_attributes
 	 */
 	public function test_wp_filter_content_tags_does_not_lazy_load_first_featured_image_in_block_theme() {
 		global $_wp_current_template_content, $wp_query, $wp_the_query, $post;
@@ -3772,19 +4027,31 @@ EOF;
 		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
 		add_filter(
 			'wp_get_attachment_image_attributes',
-			function( $attr ) {
+			static function ( $attr ) {
 				unset( $attr['srcset'], $attr['sizes'], $attr['decoding'] );
 				return $attr;
 			}
 		);
+		$this->force_omit_loading_attr_threshold( 1 );
 
 		$content_img      = get_image_tag( self::$large_id, '', '', '', 'large' );
-		$lazy_content_img = wp_img_tag_add_loading_attr( $content_img, 'the_content' );
+		$lazy_content_img = wp_img_tag_add_loading_optimization_attrs( $content_img, 'the_content' );
 
 		// The featured image should not be lazy-loaded as it is the first image.
 		$featured_image_id = self::$large_id;
 		update_post_meta( self::$post_ids['publish'], '_thumbnail_id', $featured_image_id );
-		$expected_featured_image = '<figure class="wp-block-post-featured-image">' . get_the_post_thumbnail( self::$post_ids['publish'], 'post-thumbnail', array( 'loading' => false ) ) . '</figure>';
+		$expected_featured_image = '<figure class="wp-block-post-featured-image">' . get_the_post_thumbnail(
+			self::$post_ids['publish'],
+			'post-thumbnail',
+			array(
+				'loading'       => false,
+				'style'         => 'object-fit:cover;',
+				'fetchpriority' => 'high',
+			)
+		) . '</figure>';
+
+		// Reset high priority flag as the forced `fetchpriority="high"` above already modified it.
+		$this->reset_high_priority_element_flag();
 
 		// The post content image should be lazy-loaded since the featured image appears above.
 		$post_content     = $content_img;
@@ -3798,17 +4065,14 @@ EOF;
 				'post_content_filtered' => $post_content,
 			)
 		);
-
 		$wp_query     = new WP_Query( array( 'p' => self::$post_ids['publish'] ) );
 		$wp_the_query = $wp_query;
 		$post         = get_post( self::$post_ids['publish'] );
-		$this->reset_content_media_count();
-		$this->reset_omit_loading_attr_filter();
 
 		$_wp_current_template_content = '<!-- wp:post-featured-image /--> <!-- wp:post-content /-->';
 
 		$html = get_the_block_template_html();
-		$this->assertSame( '<div class="wp-site-blocks">' . $expected_featured_image . ' <div class="entry-content wp-block-post-content is-layout-flow">' . $expected_content . '</div></div>', $html );
+		$this->assertSame( '<div class="wp-site-blocks">' . $expected_featured_image . ' <div class="entry-content wp-block-post-content is-layout-flow wp-block-post-content-is-layout-flow">' . $expected_content . '</div></div>', $html );
 	}
 
 	/**
@@ -3816,9 +4080,11 @@ EOF;
 	 * in a "Header" template part.
 	 *
 	 * @ticket 56930
+	 * @ticket 58235
 	 *
 	 * @covers ::wp_filter_content_tags
-	 * @covers ::wp_get_loading_attr_default
+	 * @covers ::wp_img_tag_add_loading_optimization_attrs
+	 * @covers ::wp_get_loading_optimization_attributes
 	 */
 	public function test_wp_filter_content_tags_does_not_lazy_load_images_in_header() {
 		global $_wp_current_template_content;
@@ -3829,6 +4095,9 @@ EOF;
 
 		// Use a single image for each header and footer template parts.
 		$header_img = get_image_tag( self::$large_id, '', '', '', 'large' );
+		// Since header_img is qualified candidate for LCP, fetchpriority high is applied to it.
+		$header_img = str_replace( '<img', '<img fetchpriority="high"', $header_img );
+
 		$footer_img = get_image_tag( self::$large_id, '', '', '', 'medium' );
 
 		// Create header and footer template parts.
@@ -3857,119 +4126,1852 @@ EOF;
 
 		// Header image should not be lazy-loaded, footer image should be lazy-loaded.
 		$expected_template_content  = '<header class="wp-block-template-part">' . $header_img . '</header>';
-		$expected_template_content .= '<footer class="wp-block-template-part">' . wp_img_tag_add_loading_attr( $footer_img, 'force-lazy' ) . '</footer>';
+		$expected_template_content .= '<footer class="wp-block-template-part">' . wp_img_tag_add_loading_optimization_attrs( $footer_img, 'force-lazy' ) . '</footer>';
 
 		$html = get_the_block_template_html();
 		$this->assertSame( '<div class="wp-site-blocks">' . $expected_template_content . '</div>', $html );
 	}
 
-	private function reset_content_media_count() {
-		// Get current value without increasing.
-		$content_media_count = wp_increase_content_media_count( 0 );
-
-		// Decrease it by its current value to "reset" it back to 0.
-		wp_increase_content_media_count( - $content_media_count );
-	}
-
-	private function reset_omit_loading_attr_filter() {
-		// Add filter to "reset" omit threshold back to null (unset).
-		add_filter( 'wp_omit_loading_attr_threshold', '__return_null', 100 );
-
-		// Force filter application to re-run.
-		wp_omit_loading_attr_threshold( true );
-
-		// Clean up the above filter.
-		remove_filter( 'wp_omit_loading_attr_threshold', '__return_null', 100 );
-	}
-
 	/**
-	 * Test that generated files with the `image_editor_output_format` applied use the correct
-	 * quality level based on their mime type.
+	 * @ticket 58089
+	 * @ticket 58235
+	 * @ticket 58892
 	 *
-	 * @ticket 56442
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_get_loading_optimization_attributes
 	 */
-	public function test_quality_with_image_conversion_file_sizes() {
-		add_filter( 'image_editor_output_format', array( $this, 'image_editor_output_jpeg' ) );
-		$temp_dir = get_temp_dir();
-		$file     = $temp_dir . '/33772.jpg';
-		copy( DIR_TESTDATA . '/images/33772.jpg', $file );
-
-		// Set JPEG output quality very low and WebP quality very high, this should force all generated WebP images to
-		// be larger than the the matching generated JPEGs.
-		add_filter( 'wp_editor_set_quality', array( $this, 'image_editor_change_quality_low_jpeg' ), 10, 2 );
-
-		$editor = wp_get_image_editor( $file );
-
-		// Verify that the selected editor supports WebP output.
-		if ( ! $editor->supports_mime_type( 'image/webp' ) ) {
-			$this->markTestSkipped( 'WebP is not supported by the selected image editor.' );
-		}
+	public function test_wp_filter_content_tags_does_not_apply_loading_optimization_to_special_images_within_the_content() {
+		global $wp_query, $wp_the_query;
 
-		$attachment_id = self::factory()->attachment->create_object(
+		// Force no lazy-loading or fetchpriority on the image tag expected in the content.
+		$expected_image = wp_get_attachment_image(
+			self::$large_id,
+			'large',
+			false,
 			array(
-				'post_mime_type' => 'image/jpeg',
-				'file'           => $file,
+				'loading'       => false,
+				'fetchpriority' => false,
+				'decoding'      => false,
 			)
 		);
 
-		add_filter( 'big_image_size_threshold', array( $this, 'add_big_image_size_threshold' ) );
+		// Reset high priority flag as the forced `fetchpriority="high"` above already modified it.
+		$this->reset_high_priority_element_flag();
 
-		// Generate all sizes as JPEGs.
-		$jpeg_sizes = wp_generate_attachment_metadata( $attachment_id, $file );
-		remove_filter( 'image_editor_output_format', array( $this, 'image_editor_output_jpeg' ) );
+		$image_within_content = '';
 
-		// Generate all sizes as WebP.
+		// Overwrite post content with an image.
+		add_filter(
+			'the_content',
+			static function () use ( &$image_within_content ) {
+				// Replace content with an image tag, i.e. the 'wp_get_attachment_image' context is used while running 'the_content' filter.
+				$image_within_content = wp_get_attachment_image( self::$large_id, 'large', false );
+				return $image_within_content;
+			},
+			9 // Run before wp_filter_content_tags().
+		);
+
+		/*
+		 * We have to run a main query loop so that the first 'the_content' context image is not
+		 * lazy-loaded.
+		 * Without the fix from 58089, the image would still be lazy-loaded since the check for the
+		 * separately invoked 'wp_get_attachment_image' context would lead to that.
+		 */
+		$wp_query     = new WP_Query( array( 'post__in' => array( self::$post_ids['publish'] ) ) );
+		$wp_the_query = $wp_query;
+
+		$content = '';
+		while ( have_posts() ) {
+			the_post();
+			$content = get_echo( 'the_content' );
+		}
+
+		// Ensure that parsed image within content does not receive any loading optimization attributes.
+		$this->assertSame( $expected_image, $image_within_content, 'Image with wp_get_attachment_image context within post content should not receive loading optimization attributes' );
+
+		// Ensure that parsed content has the image with fetchpriority as it is the first large image.
+		$expected_content = wpautop( str_replace( '<img ', '<img fetchpriority="high" decoding="async" ', $expected_image ) );
+		$this->assertSame( $expected_content, $content, 'Post content with programmatically injected image is missing loading optimization attributes' );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns 'lazy' for special contexts when they're used outside of 'the_content' filter.
+	 *
+	 * @ticket 58089
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_special_contexts_for_the_content_wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_should_return_lazy_for_special_contexts_outside_of_the_content( $context ) {
+		$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns false for special contexts when they're used within 'the_content' filter.
+	 *
+	 * @ticket 58089
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
+	 * @expectedDeprecated wp_get_loading_attr_default
+	 *
+	 * @dataProvider data_special_contexts_for_the_content_wp_get_loading_attr_default
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_attr_default_should_return_false_for_special_contexts_within_the_content( $context ) {
+		remove_all_filters( 'the_content' );
+
+		$result = null;
+		add_filter(
+			'the_content',
+			static function ( $content ) use ( &$result, $context ) {
+				$result = wp_get_loading_attr_default( $context );
+				return $content;
+			}
+		);
+		apply_filters( 'the_content', '' );
+		$this->assertFalse( $result );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_special_contexts_for_the_content() {
+		return array(
+			'widget_media_image'      => array( 'context' => 'widget_media_image' ),
+			'the_post_thumbnail'      => array( 'context' => 'the_post_thumbnail' ),
+			'wp_get_attachment_image' => array( 'context' => 'wp_get_attachment_image' ),
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_special_contexts_for_the_content_wp_get_loading_attr_default() {
+		return array(
+			'the_post_thumbnail'      => array( 'context' => 'the_post_thumbnail' ),
+			'wp_get_attachment_image' => array( 'context' => 'wp_get_attachment_image' ),
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute value.
+	 *
+	 * @ticket 53675
+	 * @ticket 56930
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default
+	 *
+	 * @param string $context
+	 */
+	public function test_wp_get_loading_optimization_attributes( $context ) {
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Return 'lazy' by default.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'test' )
+		);
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'wp_get_attachment_image' )
+		);
+
+		// Return 'lazy' if not in the loop or the main query.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context )
+		);
+
+		$query = $this->get_new_wp_query_for_published_post();
+
+		while ( have_posts() ) {
+			the_post();
+
+			// Return 'lazy' if in the loop but not in the main query.
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding' => 'async',
+					'loading'  => 'lazy',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context )
+			);
+
+			// Set as main query.
+			$this->set_main_query( $query );
+
+			// First three element are not lazy loaded. However, first image is loaded with fetchpriority high.
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding'      => 'async',
+					'fetchpriority' => 'high',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+				"Expected first image to not be lazy-loaded. First large image get's high fetchpriority."
+			);
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding' => 'async',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+				'Expected second image to not be lazy-loaded.'
+			);
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding' => 'async',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+				'Expected third image to not be lazy-loaded.'
+			);
+
+			// Return 'lazy' if in the loop and in the main query for any subsequent elements.
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding' => 'async',
+					'loading'  => 'lazy',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context )
+			);
+
+			// Yes, for all subsequent elements.
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding' => 'async',
+					'loading'  => 'lazy',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context )
+			);
+		}
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns fetchpriority=high and increases the count for arbitrary contexts in the main loop.
+	 *
+	 * @ticket 58894
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_optimization_attributes_arbitrary_contexts
+	 *
+	 * @param string $context Context for the element for which the loading optimization attribute is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_with_arbitrary_contexts_in_main_loop( $context ) {
+		$attr = $this->get_width_height_for_high_priority();
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+			'The "loading" attribute should be "lazy" when not in the loop or the main query.'
+		);
+
+		$query = $this->get_new_wp_query_for_published_post();
+
+		// Set as main query.
+		$this->set_main_query( $query );
+
+		while ( have_posts() ) {
+			the_post();
+
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding'      => 'async',
+					'fetchpriority' => 'high',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+				'The "fetchpriority" attribute should be "high" while in the loop and the main query.'
+			);
+
+			// Images with a certain minimum size in the arbitrary contexts of the page are also counted towards the threshold.
+			$this->assertSame( 1, wp_increase_content_media_count( 0 ), 'The content media count should be 1.' );
+		}
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() does not return lazy loading attributes when arbitrary contexts are used before the main query loop.
+	 *
+	 * @ticket 58894
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_optimization_attributes_arbitrary_contexts
+	 *
+	 * @param string $context Context for the element for which the loading optimization attribute is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_with_arbitrary_contexts_before_main_query_loop( $context ) {
+		$attr = $this->get_width_height_for_high_priority();
+
+		$query = $this->get_new_wp_query_for_published_post();
+
+		// Set as main query.
+		$this->set_main_query( $query );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+			'The "loading" attribute should be "lazy" before the main query loop.'
+		);
+
+		while ( have_posts() ) {
+			the_post();
+
+			$this->assertSameSetsWithIndex(
+				array(
+					'decoding'      => 'async',
+					'fetchpriority' => 'high',
+				),
+				wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+				'The "fetchpriority" attribute should be "high" while in the loop and the main query.'
+			);
+
+			$this->assertArrayNotHasKey(
+				'loading',
+				wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+				'No "loading" attribute should be present on the second image in the main query loop.'
+			);
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_loading_optimization_attributes_arbitrary_contexts() {
+		return array(
+			array( 'wp_get_attachment_image' ),
+			array( 'something_completely_arbitrary' ),
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns empty array for arbitrary context.
+	 *
+	 * @ticket 58894
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_should_return_empty_array_for_any_arbitrary_context() {
+		remove_all_filters( 'the_content' );
+
+		$result = null;
+		add_filter(
+			'the_content',
+			function ( $content ) use ( &$result ) {
+				$attr   = $this->get_width_height_for_high_priority();
+				$result = wp_get_loading_optimization_attributes( 'img', $attr, 'something_completely_arbitrary' );
+				return $content;
+			}
+		);
+		apply_filters( 'the_content', '' );
+
+		$this->assertSame( array(), $result );
+	}
+
+	/**
+	 * @ticket 58894
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_optimization_attributes_header_context
+	 *
+	 * @param string $context The context for the header.
+	 */
+	public function test_wp_get_loading_optimization_attributes_header_contexts( $context ) {
+		$attr = $this->get_width_height_for_high_priority();
+
+		$this->assertArrayNotHasKey(
+			'loading',
+			wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+			'Images in the header context should not be lazy-loaded.'
+		);
+
+		add_filter( 'wp_loading_optimization_force_header_contexts', '__return_empty_array' );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+			'Images in the header context should get lazy-loaded after the wp_loading_optimization_force_header_contexts filter.'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_loading_optimization_attributes_header_context() {
+		return array(
+			array( 'template_part_' . WP_TEMPLATE_PART_AREA_HEADER ),
+			array( 'get_header_image_tag' ),
+		);
+	}
+
+	/**
+	 * @ticket 58894
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_loading_optimization_force_header_contexts_filter() {
+		$attr = $this->get_width_height_for_high_priority();
+
+		add_filter(
+			'wp_loading_optimization_force_header_contexts',
+			function ( $context ) {
+				$contexts['something_completely_arbitrary'] = true;
+				return $contexts;
+			}
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding'      => 'async',
+				'fetchpriority' => 'high',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'something_completely_arbitrary' )
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns the expected loading attribute value before loop but after get_header if not main query.
+	 *
+	 * @ticket 58211
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_before_loop_if_not_main_query( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+
+		do_action( 'get_header' );
+
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Lazy if not main query.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context )
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns the expected loading attribute value before loop but after get_header in main query but header was not called.
+	 *
+	 * @ticket 58211
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_before_loop_in_main_query_but_header_not_called( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Lazy if header not called.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context )
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns the expected loading attribute value before loop but after get_header for main query.
+	 *
+	 * @ticket 58211
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_before_loop_if_main_query( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+		do_action( 'get_header' );
+
+		$attr = $this->get_width_height_for_high_priority();
+
+		// First image is loaded with high fetchpriority.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding'      => 'async',
+				'fetchpriority' => 'high',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context ),
+			'Expected first image to not be lazy-loaded. First large image is loaded with high fetchpriority.'
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns the expected loading attribute value after get_header and after loop.
+	 *
+	 * @ticket 58211
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_after_loop( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		do_action( 'get_header' );
+
+		while ( have_posts() ) {
+			the_post();
+		}
+
+		$attr = $this->get_width_height_for_high_priority();
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context )
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns the expected loading attribute if no loop.
+	 *
+	 * @ticket 58211
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_no_loop( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+
+		// Ensure header and footer is called.
+		do_action( 'get_header' );
+		do_action( 'get_footer' );
+
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Load lazy if the there is no loop and footer was called.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context )
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() returns 'lazy' for special contexts when they're used outside of 'the_content' filter.
+	 *
+	 * @ticket 58089
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_special_contexts_for_the_content
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_should_return_lazy_for_special_contexts_outside_of_the_content( $context ) {
+		$attr = $this->get_width_height_for_high_priority();
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, $context )
+		);
+	}
+
+	/**
+	 * Tests that wp_get_loading_optimization_attributes() does not modify any attributes for special contexts when they're used within 'the_content' filter.
+	 *
+	 * @ticket 58089
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_special_contexts_for_the_content
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_should_not_modify_images_for_special_contexts_within_the_content( $context ) {
+		remove_all_filters( 'the_content' );
+
+		$result = null;
+		add_filter(
+			'the_content',
+			function ( $content ) use ( &$result, $context ) {
+				$attr   = $this->get_width_height_for_high_priority();
+				$result = wp_get_loading_optimization_attributes( 'img', $attr, $context );
+				return $content;
+			}
+		);
+		apply_filters( 'the_content', '' );
+
+		$this->assertSame( array(), $result );
+	}
+
+	/**
+	 * Tests to cover the decoding attribute within wp_get_loading_optimization_attributes().
+	 *
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_decoding_attribute() {
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+			),
+			wp_get_loading_optimization_attributes( 'img', array(), 'the_content' ),
+			'Expected decoding attribute to be async.'
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'auto',
+			),
+			wp_get_loading_optimization_attributes( 'img', array( 'decoding' => 'auto' ), 'the_content' ),
+			'Expected decoding attribute to be auto.'
+		);
+
+		$result = null;
+		add_filter(
+			'the_content',
+			static function ( $content ) use ( &$result ) {
+				$result = wp_get_loading_optimization_attributes( 'img', array(), 'something_completely_arbitrary' );
+				return $content;
+			}
+		);
+		apply_filters( 'the_content', '' );
+
+		$this->assertSameSetsWithIndex(
+			array(),
+			$result,
+			'Expected decoding attribute to be empty for img on arbitrary context, while running the_content.'
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(),
+			wp_get_loading_optimization_attributes( 'iframe', array(), 'the_content' ),
+			'Expected decoding attribute to be empty for iframe.'
+		);
+	}
+
+	/**
+	 * @ticket 44427
+	 * @ticket 50367
+	 * @ticket 58235
+	 */
+	public function test_wp_img_tag_add_loading_optimization_attrs() {
+		$img = '<img src="example.png" alt=" width="300" height="225" />';
+		$img = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
+
+		$this->assertStringContainsString( ' loading="lazy"', $img );
+	}
+
+	/**
+	 * @ticket 44427
+	 * @ticket 50367
+	 * @ticket 58235
+	 */
+	public function test_wp_img_tag_add_loading_optimization_attrs_without_src() {
+		$img = '<img alt="" width="300" height="225" />';
+		$img = wp_img_tag_add_loading_optimization_attrs( $img, 'test' );
+
+		$this->assertStringNotContainsString( ' loading=', $img );
+	}
+
+	/**
+	 * Tests that the content media count is not affected by `the_excerpt()` calls for posts that contain images.
+	 *
+	 * @ticket 56588
+	 *
+	 * @covers ::wp_trim_excerpt
+	 */
+	public function test_the_excerpt_does_not_affect_content_media_count() {
+		global $wp_query, $wp_the_query;
+
+		/*
+		 * Use the filter to alter the threshold for not lazy-loading to the first 2 elements,
+		 * then use a post that contains exactly 2 images.
+		 */
+		$this->force_omit_loading_attr_threshold( 2 );
+		$post_content  = '<img src="example.jpg" width="800" height="600">';
+		$post_content .= '<p>Some text.</p>';
+		$post_content .= '<img src="example2.jpg" width="800" height="600">';
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $post_content,
+				'post_excerpt' => '',
+			)
+		);
+
+		$wp_query     = new WP_Query( array( 'post__in' => array( $post_id ) ) );
+		$wp_the_query = $wp_query;
+
+		while ( have_posts() ) {
+			the_post();
+
+			// Call `the_excerpt()` without generating output.
+			get_echo( 'the_excerpt' );
+		}
+
+		// The only way to access the value is by calling this function without increasing the value.
+		$content_media_count = wp_increase_content_media_count( 0 );
+
+		// Assert that the media count was not increased even though there are 3 images in the post's content.
+		$this->assertSame( 0, $content_media_count );
+	}
+
+	/**
+	 * Tests that the lazy-loading result is not affected by `the_excerpt()` calls for posts that
+	 * contain images.
+	 *
+	 * Printing the excerpt for a post that contains images in its content prior to its featured image should result in
+	 * that featured image not being lazy-loaded, since the images in the post content aren't displayed in the excerpt.
+	 *
+	 * @ticket 56588
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_trim_excerpt
+	 */
+	public function test_the_excerpt_does_not_affect_omit_lazy_loading_logic() {
+		global $wp_query, $wp_the_query;
+
+		/*
+		 * Use the filter to alter the threshold for not lazy-loading to the first 2 elements,
+		 * then use a post that contains exactly 2 images.
+		 */
+		$this->force_omit_loading_attr_threshold( 2 );
+
+		$post_content  = '<img src="example.jpg" width="800" height="600">';
+		$post_content .= '<p>Some text.</p>';
+		$post_content .= '<img src="example2.jpg" width="800" height="600">';
+
+		$post_id           = self::factory()->post->create(
+			array(
+				'post_content' => $post_content,
+				'post_excerpt' => '',
+			)
+		);
+		$featured_image_id = self::$large_id;
+		update_post_meta( $post_id, '_thumbnail_id', $featured_image_id );
+
+		$expected_image_tag = get_the_post_thumbnail(
+			$post_id,
+			'post-thumbnail',
+			array(
+				'loading'       => false,
+				'decoding'      => 'async',
+				'fetchpriority' => 'high',
+			)
+		);
+
+		// Reset high priority flag as the forced `fetchpriority="high"` above already modified it.
+		$this->reset_high_priority_element_flag();
+
+		$wp_query     = new WP_Query( array( 'post__in' => array( $post_id ) ) );
+		$wp_the_query = $wp_query;
+
+		$output = '';
+		while ( have_posts() ) {
+			the_post();
+
+			// Print excerpt first, then the featured image.
+			$output .= get_echo( 'the_excerpt' );
+			$output .= get_echo( 'the_post_thumbnail' );
+		}
+
+		$this->assertStringContainsString( $expected_image_tag, $output );
+	}
+
+	/**
+	 * Tests that wp_filter_content_tags() and more specifically wp_get_loading_optimization_attributes() correctly
+	 * handle shortcodes images together with the content that it is part of.
+	 *
+	 * Images within shortcodes as part of the content should be ignored by wp_get_loading_optimization_attributes() to
+	 * avoid double processing. They should instead only be processed together with any other images as part of the
+	 * content, to correctly count the original sequencing of those images.
+	 *
+	 * @ticket 58853
+	 *
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_filter_content_tags_handles_shortcode_image_together_with_the_content() {
+		global $wp_query, $wp_the_query;
+
+		// Add shortcode that prints a large image, and a block type that wraps it.
+		add_shortcode(
+			'full_image',
+			static function ( $atts ) {
+				$atts = shortcode_atts(
+					array(
+						'id' => 0,
+					),
+					$atts,
+					'full_image'
+				);
+				return wp_get_attachment_image( (int) $atts['id'], 'full' );
+			}
+		);
+
+		/*
+		 * Even though `do_shortcode()` runs before `wp_filter_content_tags()`, the image from the shortcode should not
+		 * receive any loading optimization attributes because it needs to be considered together with the rest of the
+		 * post content, within `wp_filter_content_tags()`.
+		 * Since the hard-coded image appears before the shortcode image, it should receive `fetchpriority="high"`,
+		 * despite the shortcode image being parsed before it.
+		 */
+		$post_content  = '<img src="example.jpg" width="800" height="600">' . "\n";
+		$post_content .= '[full_image id="' . self::$large_id . '"]';
+		$post_content  = wpautop( $post_content );
+
+		/*
+		 * Prepare the expected output:
+		 * 1. On the first image (hard-coded in the content), expect `fetchpriority="high"`.
+		 * 2. Replace the shortcode with its expected output, i.e. the full image. Expect neither
+		 * `fetchpriority="high"` nor `loading="lazy"`.
+		 */
+		$expected_content = $post_content;
+		$expected_content = str_replace(
+			'<img src="example.jpg"',
+			'<img fetchpriority="high" decoding="async" src="example.jpg"',
+			$expected_content
+		);
+		$expected_content = str_replace(
+			'[full_image id="' . self::$large_id . '"]',
+			str_replace(
+				'<img ',
+				'<img decoding="async" ',
+				wp_get_attachment_image(
+					self::$large_id,
+					'full',
+					false,
+					array(
+						'decoding'      => false,
+						'fetchpriority' => false,
+						'loading'       => false,
+					)
+				)
+			),
+			$expected_content
+		);
+
+		// Create post with the content.
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $post_content,
+				'post_excerpt' => '',
+			)
+		);
+
+		// We have to run a main query loop so that the first 'the_content' context images are not lazy-loaded.
+		$wp_query     = new WP_Query( array( 'post__in' => array( $post_id ) ) );
+		$wp_the_query = $wp_query;
+
+		$content = '';
+		while ( have_posts() ) {
+			the_post();
+			$content = get_echo( 'the_content' );
+		}
+
+		// Cleanup.
+		remove_shortcode( 'full_image' );
+
+		$this->assertSame( $expected_content, $content );
+	}
+
+	/**
+	 * Tests that wp_filter_content_tags() and more specifically wp_get_loading_optimization_attributes() correctly
+	 * handle shortcodes images within the content, including within a block.
+	 *
+	 * Images within shortcodes as part of the content should be ignored by wp_get_loading_optimization_attributes() to
+	 * avoid double processing. They should instead only be processed together with any other images as part of the
+	 * content, to correctly count the original sequencing of those images.
+	 *
+	 * @ticket 58853
+	 *
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_filter_content_tags_handles_shortcode_images_also_in_blocks_within_the_content() {
+		global $wp_query, $wp_the_query;
+
+		// Disable addition of `decoding="async"` as it is irrelevant for this test.
+		add_filter(
+			'wp_get_loading_optimization_attributes',
+			static function ( $loading_attrs ) {
+				if ( isset( $loading_attrs['decoding'] ) ) {
+					unset( $loading_attrs['decoding'] );
+				}
+				return $loading_attrs;
+			}
+		);
+
+		// Add shortcode that prints a large image, and a block type that wraps it.
+		add_shortcode(
+			'full_image',
+			static function ( $atts ) {
+				$atts = shortcode_atts(
+					array(
+						'id' => 0,
+					),
+					$atts,
+					'full_image'
+				);
+				return wp_get_attachment_image( (int) $atts['id'], 'full' );
+			}
+		);
+		register_block_type(
+			'core/full-image-shortcode',
+			array(
+				'render_callback' => static function ( $atts ) {
+					if ( empty( $atts['id'] ) ) {
+						return '';
+					}
+					return do_shortcode( '[full_image id="' . $atts['id'] . '"]' );
+				},
+			)
+		);
+
+		/*
+		 * Include the following images:
+		 * 1. Using gallery shortcode. Expected `fetchpriority="high"`.
+		 * 2. Regular hard-coded image.
+		 * 3. Using custom shortcode within block.
+		 * 4. Regular hard-coded image. Expected `loading="lazy"`.
+		 *
+		 * The first image is expected to be prioritized because it is the first (large enough) content image.
+		 * The first three images are expected to not have lazy-loading because that is the default threshold for
+		 * omitting the attribute.
+		 * The fourth image is expected to be lazy-loaded as it is past the default threshold.
+		 *
+		 * The results will only be correct if all images are considered together. For example:
+		 * * If the image within the shortcode would only be parsed after the rest of the content, it would miss the
+		 * `fetchpriority="high"` attribute and instead incorrectly receive `loading="lazy"`. The second image would as
+		 * a result incorrectly receive `fetchpriority="high"`.
+		 * * If the image within the block would be parsed before the rest of the content, it would incorrectly receive
+		 * the `fetchpriority="high"` attribute. Then the first image would no longer receive the attribute.
+		 *
+		 * To ensure that this works:
+		 * * `wp_filter_content_tags()` must run after `do_blocks()` and `do_shortcode()`.
+		 * * `wp_get_loading_optimization_attributes()` must bail early if any images from the content blob are being
+		 * considered under a different context name than 'the_content'.
+		 */
+		$post_content  = '[gallery ids="' . self::$large_id . '" size="large"]' . "\n";
+		$post_content .= '<img src="example.jpg" width="800" height="600">' . "\n";
+		$post_content .= '<p>Some text.</p>' . "\n";
+		$post_content .= '<!-- wp:core/full-image-shortcode {"id":' . self::$large_id . '} --><!-- /wp:core/full-image-shortcode -->' . "\n";
+		$post_content .= '<img src="example2.jpg" width="800" height="600">';
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $post_content,
+				'post_excerpt' => '',
+			)
+		);
+
+		/*
+		 * Prepare the expected output:
+		 * 1. Replace the shortcode with its expected output (ID increased by 1 because of static variable within
+		 * the gallery_shortcode() function). Expect `fetchpriority="high"`, but not `loading="lazy"`.
+		 * 2. Do not modify the second image as it is hard-coded in the content and expected to be unchanged.
+		 * 3. Replace the block with its expected output, i.e. the full image from the shortcode within. Expect neither
+		 * `fetchpriority="high"` nor `loading="lazy"`.
+		 * 4. On the fourth image (hard-coded in the content), expect `loading="lazy"`.
+		 */
+		$expected_content = $post_content;
+		$expected_content = str_replace(
+			'[gallery ids="' . self::$large_id . '" size="large"]',
+			str_replace(
+				array( ' loading="lazy"', '<img ' ),
+				array( '', '<img fetchpriority="high" ' ),
+				preg_replace_callback(
+					'/gallery-(\d+)/',
+					static function ( $matches ) {
+						return 'gallery-' . ( (int) $matches[1] + 1 );
+					},
+					do_shortcode( '[gallery ids="' . self::$large_id . '" size="large" id="' . $post_id . '"]' )
+				)
+			),
+			$expected_content
+		);
+		$expected_content = str_replace(
+			'<!-- wp:core/full-image-shortcode {"id":' . self::$large_id . '} --><!-- /wp:core/full-image-shortcode -->',
+			wp_get_attachment_image(
+				self::$large_id,
+				'full',
+				false,
+				array(
+					'fetchpriority' => false,
+					'loading'       => false,
+				)
+			),
+			$expected_content
+		);
+		$expected_content = str_replace(
+			'<img src="example2.jpg"',
+			'<img loading="lazy" src="example2.jpg"',
+			$expected_content
+		);
+
+		// We have to run a main query loop so that the first 'the_content' context images are not lazy-loaded.
+		$wp_query     = new WP_Query( array( 'post__in' => array( $post_id ) ) );
+		$wp_the_query = $wp_query;
+
+		$content = '';
+		while ( have_posts() ) {
+			the_post();
+			$content = get_echo( 'the_content' );
+		}
+
+		// Cleanup.
+		remove_shortcode( 'full_image' );
+		unregister_block_type( 'core/full-image-shortcode' );
+
+		$this->assertSame( $expected_content, $content );
+	}
+
+	private function reset_content_media_count() {
+		// Get current value without increasing.
+		$content_media_count = wp_increase_content_media_count( 0 );
+
+		// Decrease it by its current value to "reset" it back to 0.
+		wp_increase_content_media_count( - $content_media_count );
+	}
+
+	private function reset_omit_loading_attr_filter() {
+		// Add filter to "reset" omit threshold back to null (unset).
+		add_filter( 'wp_omit_loading_attr_threshold', '__return_null', 100 );
+
+		// Force filter application to re-run.
+		wp_omit_loading_attr_threshold( true );
+
+		// Clean up the above filter.
+		remove_filter( 'wp_omit_loading_attr_threshold', '__return_null', 100 );
+	}
+
+	private function reset_high_priority_element_flag() {
+		wp_high_priority_element_flag( true );
+	}
+
+	/**
+	 * Test that generated files with the `image_editor_output_format` applied use the correct
+	 * quality level based on their mime type.
+	 *
+	 * @ticket 56442
+	 */
+	public function test_quality_with_image_conversion_file_sizes() {
+		add_filter( 'image_editor_output_format', array( $this, 'image_editor_output_jpeg' ) );
+		$temp_dir = get_temp_dir();
+		$file     = $temp_dir . '/33772.jpg';
+		copy( DIR_TESTDATA . '/images/33772.jpg', $file );
+
+		// Set JPEG output quality very low and WebP quality very high, this should force all generated WebP images to
+		// be larger than the the matching generated JPEGs.
+		add_filter( 'wp_editor_set_quality', array( $this, 'image_editor_change_quality_low_jpeg' ), 10, 2 );
+
+		$editor = wp_get_image_editor( $file );
+
+		// Verify that the selected editor supports WebP output.
+		if ( ! $editor->supports_mime_type( 'image/webp' ) ) {
+			$this->markTestSkipped( 'WebP is not supported by the selected image editor.' );
+		}
+
+		$attachment_id = self::factory()->attachment->create_object(
+			array(
+				'post_mime_type' => 'image/jpeg',
+				'file'           => $file,
+			)
+		);
+
+		add_filter( 'big_image_size_threshold', array( $this, 'add_big_image_size_threshold' ) );
+
+		// Generate all sizes as JPEGs.
+		$jpeg_sizes = wp_generate_attachment_metadata( $attachment_id, $file );
+		remove_filter( 'image_editor_output_format', array( $this, 'image_editor_output_jpeg' ) );
+
+		// Generate all sizes as WebP.
 		add_filter( 'image_editor_output_format', array( $this, 'image_editor_output_webp' ) );
 		$webp_sizes = wp_generate_attachment_metadata( $attachment_id, $file );
 		remove_filter( 'image_editor_output_format', array( $this, 'image_editor_output_webp' ) );
 
-		// The main (scaled) image: the JPEG should be smaller than the WebP.
-		$this->assertLessThan( $webp_sizes['filesize'], $jpeg_sizes['filesize'], 'The JPEG should be smaller than the WebP.' );
+		// The main (scaled) image: the JPEG should be smaller than the WebP.
+		$this->assertLessThan( $webp_sizes['filesize'], $jpeg_sizes['filesize'], 'The JPEG should be smaller than the WebP.' );
+
+		// Sub-sizes: for each size, the JPEGs should be smaller than the WebP.
+		$sizes_to_compare = array_intersect_key( $jpeg_sizes['sizes'], $webp_sizes['sizes'] );
+		foreach ( $sizes_to_compare as $size => $size_data ) {
+			$this->assertLessThan( $webp_sizes['sizes'][ $size ]['filesize'], $jpeg_sizes['sizes'][ $size ]['filesize'] );
+		}
+	}
+
+	/**
+	 * Test that an image size isn't generated if it matches the original image size.
+	 *
+	 * @ticket 57370
+	 */
+	public function test_wp_generate_attachment_metadata_doesnt_generate_sizes_for_150_square_image() {
+		$temp_dir = get_temp_dir();
+		$file     = $temp_dir . '/test-square-150.jpg';
+		copy( DIR_TESTDATA . '/images/test-square-150.jpg', $file );
+
+		$attachment_id = self::factory()->attachment->create_object(
+			array(
+				'post_mime_type' => 'image/jpeg',
+				'file'           => $file,
+			)
+		);
+
+		$metadata = wp_generate_attachment_metadata( $attachment_id, $file );
+		$this->assertSame(
+			array(),
+			$metadata['sizes'],
+			'The sizes should be an empty array'
+		);
+		$this->assertSame(
+			'test-square-150.jpg',
+			basename( $metadata['file'] ),
+			'The file basename should match the given filename'
+		);
+		$this->assertSame(
+			150,
+			$metadata['width'],
+			'The width should be 150 (integer)'
+		);
+		$this->assertSame(
+			150,
+			$metadata['height'],
+			'The height should be 150 (integer)'
+		);
+	}
+
+	/**
+	 * Tests that `wp_get_attachment_image()` uses the correct default context.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers ::wp_get_attachment_image
+	 */
+	public function test_wp_get_attachment_image_context_filter_default() {
+		$last_context = '';
+		$this->track_last_attachment_image_context( $last_context );
+
+		wp_get_attachment_image( self::$large_id );
+		$this->assertSame( 'wp_get_attachment_image', $last_context );
+	}
+
+	/**
+	 * Tests that `wp_get_attachment_image()` allows overriding the context via filter.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers ::wp_get_attachment_image
+	 */
+	public function test_wp_get_attachment_image_context_filter_value_is_passed_correctly() {
+		$last_context = '';
+		$this->track_last_attachment_image_context( $last_context );
+
+		// Add a filter that modifies the context.
+		add_filter(
+			'wp_get_attachment_image_context',
+			static function () {
+				return 'my_custom_context';
+			}
+		);
+
+		wp_get_attachment_image( self::$large_id );
+		$this->assertSame( 'my_custom_context', $last_context );
+	}
+
+	/**
+	 * Tests tag restriction for `wp_get_loading_optimization_attributes()`.
+	 *
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_optimization_attributes_min_required_attrs
+	 *
+	 * @param string $tag_name The tag name.
+	 * @param string $attr Element attributes.
+	 * @param array  $expected Expected return value.
+	 * @param string $message Message to display if the test fails.
+	 */
+	public function test_wp_get_loading_optimization_attributes_min_required_attrs( $tag_name, $attr, $expected, $message ) {
+		$context = 'the_post_thumbnail';
+		$this->assertSame( wp_get_loading_optimization_attributes( $tag_name, $attr, $context ), $expected, $message );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_loading_optimization_attributes_min_required_attrs() {
+		return array(
+			'img_with_min_attrs' => array(
+				'img',
+				array(
+					'width'  => 100,
+					'height' => 100,
+				),
+				array(
+					'decoding' => 'async',
+					'loading'  => 'lazy',
+				),
+				'Expected default `decoding="async"` and `loading="lazy"`.',
+			),
+			'img_without_height' => array(
+				'img',
+				array( 'width' => 100 ),
+				array(
+					'decoding' => 'async',
+				),
+				'Only `decoding` is set as height is required for `loading` attribute.',
+			),
+			'img_without_width'  => array(
+				'img',
+				array( 'height' => 100 ),
+				array(
+					'decoding' => 'async',
+				),
+				'Only `decoding` is set as width is required for `loading` attribute.',
+			),
+		);
+	}
+
+	/**
+	 * Tests tag restriction for `wp_get_loading_optimization_attributes()`.
+	 *
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_optimization_attributes_check_allowed_tags
+	 *
+	 * @param string $tag_name The tag name.
+	 * @param array  $expected Expected return value.
+	 * @param string $message Message to display if the test fails.
+	 */
+	public function test_wp_get_loading_optimization_attributes_check_allowed_tags( $tag_name, $expected, $message ) {
+		$attr    = $this->get_width_height_for_high_priority();
+		$context = 'the_post_thumbnail';
+		$this->assertSame( wp_get_loading_optimization_attributes( $tag_name, $attr, $context ), $expected, $message );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_loading_optimization_attributes_check_allowed_tags() {
+		return array(
+			'img'    => array(
+				'img',
+				array(
+					'decoding' => 'async',
+					'loading'  => 'lazy',
+				),
+				'Expected `decoding="async"` and `loading="lazy"` and `decoding="async"` for the img.',
+			),
+			'iframe' => array(
+				'iframe',
+				array(
+					'loading' => 'lazy',
+				),
+				'Expected `loading="lazy"` for the iframe.',
+			),
+			'video'  =>
+			array(
+				'video',
+				array(),
+				'Function should return empty array as video tag is not supported.',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_skip_for_block_template() {
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Skip logic if context is `template`.
+		$this->assertSame(
+			array(),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'template' ),
+			'Skip logic and return blank array for block template.'
+		);
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_header_block_template() {
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Skip logic if context is `template`.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding'      => 'async',
+				'fetchpriority' => 'high',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'template_part_' . WP_TEMPLATE_PART_AREA_HEADER ),
+			'Images in the header block template part should not be lazy-loaded and first large image is set high fetchpriority.'
+		);
+	}
+
+	/**
+	 * @ticket 58235
+	 * @ticket 58892
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 * @expectedIncorrectUsage wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_incorrect_loading_attrs() {
+		$attr                  = $this->get_width_height_for_high_priority();
+		$attr['loading']       = 'lazy';
+		$attr['fetchpriority'] = 'high';
 
-		// Sub-sizes: for each size, the JPEGs should be smaller than the WebP.
-		$sizes_to_compare = array_intersect_key( $jpeg_sizes['sizes'], $webp_sizes['sizes'] );
-		foreach ( $sizes_to_compare as $size => $size_data ) {
-			$this->assertLessThan( $webp_sizes['sizes'][ $size ]['filesize'], $jpeg_sizes['sizes'][ $size ]['filesize'] );
-		}
+		$this->assertEqualSetsWithIndex(
+			array(
+				'decoding'      => 'async',
+				'loading'       => 'lazy',
+				'fetchpriority' => 'high',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'test' ),
+			'This should return both lazy-loading and high fetchpriority, but with doing_it_wrong message.'
+		);
 	}
 
 	/**
-	 * Test that an image size isn't generated if it matches the original image size.
+	 * @ticket 58235
 	 *
-	 * @ticket 57370
+	 * @covers ::wp_get_loading_optimization_attributes
 	 */
-	public function test_wp_generate_attachment_metadata_doesnt_generate_sizes_for_150_square_image() {
-		$temp_dir = get_temp_dir();
-		$file     = $temp_dir . '/test-square-150.jpg';
-		copy( DIR_TESTDATA . '/images/test-square-150.jpg', $file );
+	public function test_wp_get_loading_optimization_attributes_if_loading_attr_present() {
+		$attr            = $this->get_width_height_for_high_priority();
+		$attr['loading'] = 'eager';
 
-		$attachment_id = self::factory()->attachment->create_object(
+		// Check fetchpriority high logic if loading attribute is present.
+		$this->assertSameSetsWithIndex(
 			array(
-				'post_mime_type' => 'image/jpeg',
-				'file'           => $file,
-			)
+				'decoding'      => 'async',
+				'fetchpriority' => 'high',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'test' ),
+			'fetchpriority should be set to high.'
 		);
+	}
 
-		$metadata = wp_generate_attachment_metadata( $attachment_id, $file );
-		$this->assertSame(
-			array(),
-			$metadata['sizes'],
-			'The sizes should be an empty array'
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_low_res_image() {
+		$attr = array(
+			'width'   => 100,
+			'height'  => 100,
+			'loading' => 'eager',
 		);
+
+		// fetchpriority not set as image is of lower resolution.
 		$this->assertSame(
-			'test-square-150.jpg',
-			basename( $metadata['file'] ),
-			'The file basename should match the given filename'
+			array(
+				'decoding' => 'async',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'test' ),
+			'loading optimization attr array should be empty.'
+		);
+	}
+
+	/**
+	 * Tests that the `do_shortcode` context results in a lazy-loaded image by default.
+	 *
+	 * @ticket 58681
+	 * @ticket 58853
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_in_shortcodes() {
+		$attr = $this->get_width_height_for_high_priority();
+
+		// Shortcodes processed outside of content blobs like 'the_content' always get `loading="lazy"`.
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'do_shortcode' ),
+			'Lazy-loading not applied to shortcodes outside the loop.'
+		);
+	}
+
+	/**
+	 * Tests that the `do_shortcode` context does not result in loading optimization changes when used within a content
+	 * blob.
+	 *
+	 * @ticket 58853
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_get_filters_with_do_shortcode_callback
+	 *
+	 * @param string $filter_name The name of the filter to hook.
+	 */
+	public function test_wp_get_loading_optimization_attributes_in_shortcodes_within_content_blob( $filter_name ) {
+		$result = null;
+
+		remove_all_filters( $filter_name );
+		add_filter(
+			$filter_name,
+			function ( $content ) use ( &$result ) {
+				$attr   = $this->get_width_height_for_high_priority();
+				$result = wp_get_loading_optimization_attributes( 'img', $attr, 'do_shortcode' );
+				return $content;
+			}
 		);
+		apply_filters( $filter_name, '' );
+
+		// Shortcodes processed within content blobs like 'the_content' should never get any loading optimization attributes.
 		$this->assertSame(
-			150,
-			$metadata['width'],
-			'The width should be 150 (integer)'
+			array(),
+			$result,
+			'Loading optimization unexpectedly applied to shortcodes within content blob.'
+		);
+	}
+
+	/**
+	 * Gets filters for content blobs that by default have a `do_shortcode()` callback.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_filters_with_do_shortcode_callback() {
+		return self::text_array_to_dataprovider(
+			array(
+				'the_content',
+				'widget_text_content',
+				'widget_block_content',
+			)
+		);
+	}
+
+	/**
+	 * @ticket 58681
+	 */
+	public function test_content_rendering_with_shortcodes() {
+		// The gallery shortcode will dynamically create image markup that should be optimized.
+		$content = "[gallery ids='" . self::$large_id . "' size='large']";
+		$actual  = apply_filters( 'the_content', $content );
+
+		$this->assertStringContainsString(
+			// Since the main query and loop isn't set, this should be lazily loaded.
+			'loading="lazy"',
+			$actual,
+			'Could not confirm shortcodes get optimizations applied.'
+		);
+	}
+
+	/**
+	 * @ticket 58681
+	 */
+	public function test_content_rendering_with_shortcodes_nested() {
+		global $wp_query;
+
+		// Set WP_Query to be in the loop and the main query.
+		$wp_query->in_the_loop = true;
+		$this->set_main_query( $wp_query );
+
+		add_shortcode(
+			'div',
+			function ( $atts, $content = null ) {
+				$parsed_atts = shortcode_atts(
+					array(
+						'class' => '',
+					),
+					$atts
+				);
+
+				$class = ! empty( $parsed_atts['class'] ) ? sprintf( ' class="%s"', $parsed_atts['class'] ) : null;
+
+				return sprintf( '<div %s>%s</div>', $class, do_shortcode( $content ) );
+			}
+		);
+
+		// The gallery shortcode will dynamically create image markup that should be optimized.
+		$content = "[div][gallery ids='" . self::$large_id . "' size='large'][div]";
+		$actual  = apply_filters( 'the_content', $content );
+
+		$this->assertStringContainsString(
+			// Since this is in the loop, it should have a high fetchpriority.
+			'fetchpriority="high"',
+			$actual,
+			'Could not confirm shortcodes get optimizations applied.'
+		);
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_maybe_add_fetchpriority_high_attr
+	 *
+	 * @dataProvider data_wp_maybe_add_fetchpriority_high_attr
+	 */
+	public function test_wp_maybe_add_fetchpriority_high_attr( $loading_attrs, $tag_name, $attr, $expected_fetchpriority ) {
+		$loading_attrs = wp_maybe_add_fetchpriority_high_attr( $loading_attrs, $tag_name, $attr );
+
+		if ( $expected_fetchpriority ) {
+			$this->assertArrayHasKey( 'fetchpriority', $loading_attrs, 'fetchpriority attribute should be present' );
+			$this->assertSame( $expected_fetchpriority, $loading_attrs['fetchpriority'], 'fetchpriority attribute has incorrect value' );
+		} else {
+			$this->assertArrayNotHasKey( 'fetchpriority', $loading_attrs, 'fetchpriority attribute should not be present' );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_maybe_add_fetchpriority_high_attr() {
+		return array(
+			'small image'                   => array(
+				array(),
+				'img',
+				$this->get_insufficient_width_height_for_high_priority(),
+				false,
+			),
+			'large image'                   => array(
+				array(),
+				'img',
+				$this->get_width_height_for_high_priority(),
+				'high',
+			),
+			'image with loading=lazy'       => array(
+				array(
+					'loading'  => 'lazy',
+					'decoding' => 'async',
+				),
+				'img',
+				$this->get_width_height_for_high_priority(),
+				false,
+			),
+			'image with loading=eager'      => array(
+				array( 'loading' => 'eager' ),
+				'img',
+				$this->get_width_height_for_high_priority(),
+				'high',
+			),
+			'image with fetchpriority=high' => array(
+				array(),
+				'img',
+				array_merge(
+					$this->get_insufficient_width_height_for_high_priority(),
+					array( 'fetchpriority' => 'high' )
+				),
+				'high',
+			),
+			'image with fetchpriority=low'  => array(
+				array(),
+				'img',
+				array_merge(
+					$this->get_insufficient_width_height_for_high_priority(),
+					array( 'fetchpriority' => 'low' )
+				),
+				false,
+			),
+			'non-image element'             => array(
+				array(),
+				'video',
+				$this->get_width_height_for_high_priority(),
+				false,
+			),
+		);
+	}
+
+	/**
+	 * @ticket 58235
+	 *
+	 * @covers ::wp_maybe_add_fetchpriority_high_attr
+	 */
+	public function test_wp_maybe_add_fetchpriority_high_attr_min_priority_filter() {
+		$attr = array(
+			'width'  => 50,
+			'height' => 50,
+		);
+
+		add_filter(
+			'wp_min_priority_img_pixels',
+			static function ( $res ) {
+				return 2500; // 50*50=2500
+			}
 		);
+
+		// fetchpriority set to high as resolution is equal to (or greater than) 2500.
 		$this->assertSame(
-			150,
-			$metadata['height'],
-			'The height should be 150 (integer)'
+			array(
+				'fetchpriority' => 'high',
+			),
+			wp_maybe_add_fetchpriority_high_attr( array(), 'img', $attr )
+		);
+	}
+
+	/**
+	 * @ticket 58635
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_header_block_template_increase_media_count() {
+		$attr = $this->get_width_height_for_high_priority();
+		wp_get_loading_optimization_attributes( 'img', $attr, 'template_part_' . WP_TEMPLATE_PART_AREA_HEADER );
+
+		// Images with a certain minimum size in the header of the page are also counted towards the threshold.
+		$this->assertSame( 1, wp_increase_content_media_count( 0 ) );
+	}
+
+	/**
+	 * @ticket 58635
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 */
+	public function test_wp_get_loading_optimization_attributes_header_image_tag_increase_media_count() {
+		$attr = $this->get_width_height_for_high_priority();
+		wp_get_loading_optimization_attributes( 'img', $attr, 'get_header_image_tag' );
+
+		// Images with a certain minimum size in the header of the page are also counted towards the threshold.
+		$this->assertSame( 1, wp_increase_content_media_count( 0 ) );
+	}
+
+	/**
+	 * @ticket 58635
+	 *
+	 * @covers ::wp_get_loading_optimization_attributes
+	 *
+	 * @dataProvider data_wp_get_loading_attr_default_before_and_no_loop
+	 *
+	 * @param string $context Context for the element for which the `loading` attribute value is requested.
+	 */
+	public function test_wp_get_loading_optimization_attributes_image_before_loop_increase_media_count( $context ) {
+		global $wp_query;
+
+		$wp_query = $this->get_new_wp_query_for_published_post();
+		$this->set_main_query( $wp_query );
+		do_action( 'get_header' );
+
+		$attr = $this->get_width_height_for_high_priority();
+		wp_get_loading_optimization_attributes( 'img', $attr, $context );
+
+		// Images with a certain minimum size in the header of the page are also counted towards the threshold.
+		$this->assertSame( 1, wp_increase_content_media_count( 0 ) );
+	}
+
+	/**
+	 * Tests for pre_wp_get_loading_optimization_attributes filter.
+	 *
+	 * @ticket 58893
+	 */
+	public function test_pre_wp_get_loading_optimization_attributes_filter() {
+		add_filter(
+			'pre_wp_get_loading_optimization_attributes',
+			static function ( $loading_attrs ) {
+				if ( false === $loading_attrs ) {
+					// Initialize as an empty array.
+					$loading_attrs = array();
+				}
+				$loading_attrs['fetchpriority'] = 'high';
+
+				return $loading_attrs;
+			},
+			10,
+			1
+		);
+
+		$attr = $this->get_width_height_for_high_priority();
+
+		$this->assertSameSetsWithIndex(
+			array( 'fetchpriority' => 'high' ),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+			'The filter did not return early fetchpriority attribute'
+		);
+
+		// Clean up the filter.
+		add_filter( 'pre_wp_get_loading_optimization_attributes', '__return_false' );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+			'The filter did not return the default attributes.'
+		);
+
+		// Return no loading attributes.
+		add_filter( 'pre_wp_get_loading_optimization_attributes', '__return_empty_array' );
+
+		$this->assertSameSetsWithIndex(
+			array(),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+			'The filter did not clean up all attributes.'
+		);
+
+		// Modify the loading attributes with any custom attributes.
+		add_filter(
+			'pre_wp_get_loading_optimization_attributes',
+			static function ( $loading_attrs ) {
+				if ( false === $loading_attrs ) {
+					// Initialize as an empty array.
+					$loading_attrs = array();
+				}
+				$loading_attrs['custom_attr'] = 'custom_value';
+
+				return $loading_attrs;
+			},
+			10,
+			1
+		);
+
+		$this->assertSameSetsWithIndex(
+			array( 'custom_attr' => 'custom_value' ),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+			'The filter did not return custom attributes.'
+		);
+	}
+
+	/**
+	 * Tests for wp_get_loading_optimization_attributes filter.
+	 *
+	 * @ticket 58893
+	 */
+	public function test_wp_get_loading_optimization_attributes_filter() {
+		$attr = $this->get_width_height_for_high_priority();
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding' => 'async',
+				'loading'  => 'lazy',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+			'Before the filter it will not return the loading attribute.'
+		);
+
+		add_filter(
+			'wp_get_loading_optimization_attributes',
+			static function ( $loading_attrs ) {
+				unset( $loading_attrs['loading'] );
+				$loading_attrs['fetchpriority'] = 'high';
+
+				return $loading_attrs;
+			},
+			10,
+			1
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'decoding'      => 'async',
+				'fetchpriority' => 'high',
+			),
+			wp_get_loading_optimization_attributes( 'img', $attr, 'the_content' ),
+			'After the filter it will not return the fetchpriority attribute.'
+		);
+	}
+
+	/**
+	 * Helper method to keep track of the last context returned by the 'wp_get_attachment_image_context' filter.
+	 *
+	 * The method parameter is passed by reference and therefore will always contain the last context value.
+	 *
+	 * @param mixed $last_context Variable to track last context. Passed by reference.
+	 */
+	private function track_last_attachment_image_context( &$last_context ) {
+		add_filter(
+			'wp_get_attachment_image_context',
+			static function ( $context ) use ( &$last_context ) {
+				$last_context = $context;
+				return $context;
+			},
+			11
 		);
 	}
 
@@ -4012,6 +6014,79 @@ EOF;
 		}
 	}
 
+	/**
+	 * Change the omit loading attribute threshold value.
+	 *
+	 * @param int $threshold Threshold value to change.
+	 */
+	public function force_omit_loading_attr_threshold( $threshold ) {
+		add_filter(
+			'wp_omit_loading_attr_threshold',
+			static function () use ( $threshold ) {
+				return $threshold;
+			}
+		);
+	}
+
+	/**
+	 * Returns a new WP_Query.
+	 *
+	 * @global WP_Query $wp_query WordPress Query object.
+	 *
+	 * @return WP_Query a new query.
+	 */
+	public function get_new_wp_query_for_published_post() {
+		global $wp_query;
+
+		// New query to $wp_query. update global for the loop.
+		$wp_query = new WP_Query( array( 'post__in' => array( self::$post_ids['publish'] ) ) );
+
+		return $wp_query;
+	}
+
+	/**
+	 * Sets a query as main query.
+	 *
+	 * @global WP_Query $wp_the_query WordPress Query object.
+	 *
+	 * @param WP_Query $query query to be set as main query.
+	 */
+	public function set_main_query( $query ) {
+		global $wp_the_query;
+		$wp_the_query = $query;
+	}
+
+	/**
+	 * Returns an array with dimension attribute values eligible for a high priority image.
+	 *
+	 * @return array Associative array with 'width' and 'height' keys.
+	 */
+	private function get_width_height_for_high_priority() {
+		/*
+		 * The product of width * height must be >50000 to qualify for high priority image.
+		 * 300 * 200 = 60000
+		 */
+		return array(
+			'width'  => 300,
+			'height' => 200,
+		);
+	}
+
+	/**
+	 * Returns an array with dimension attribute values ineligible for a high priority image.
+	 *
+	 * @return array Associative array with 'width' and 'height' keys.
+	 */
+	private function get_insufficient_width_height_for_high_priority() {
+		/*
+		 * The product of width * height must be >50000 to qualify for high priority image.
+		 * 200 * 100 = 20000
+		 */
+		return array(
+			'width'  => 200,
+			'height' => 100,
+		);
+	}
 }
 
 /**
diff --git a/tests/media/getPostGalleries.php b/tests/media/getPostGalleries.php
index 363fea8149..1ba21013e1 100644
--- a/tests/media/getPostGalleries.php
+++ b/tests/media/getPostGalleries.php
@@ -575,7 +575,7 @@ BLOB;
 
 		}
 
-		$ids_joined = join( ',', $ids );
+		$ids_joined = implode( ',', $ids );
 
 		$global_post_id = self::factory()->post->create(
 			array(
@@ -844,8 +844,8 @@ BLOB;
 
 		}
 
-		$ids1_joined = join( ',', array_slice( $ids, 0, 3 ) );
-		$ids2_joined = join( ',', array_slice( $ids, 3, 3 ) );
+		$ids1_joined = implode( ',', array_slice( $ids, 0, 3 ) );
+		$ids2_joined = implode( ',', array_slice( $ids, 3, 3 ) );
 
 		$blob = <<<BLOB
 [gallery ids="$ids1_joined"]
@@ -870,7 +870,6 @@ BLOB;
 			),
 			$galleries
 		);
-
 	}
 
 	/**
@@ -908,8 +907,8 @@ BLOB;
 
 		}
 
-		$ids1_joined = join( ',', array_slice( $ids, 0, 3 ) );
-		$ids2_joined = join( ',', array_slice( $ids, 3, 3 ) );
+		$ids1_joined = implode( ',', array_slice( $ids, 0, 3 ) );
+		$ids2_joined = implode( ',', array_slice( $ids, 3, 3 ) );
 		$blob        = <<<BLOB
 [gallery ids="$ids1_joined" type="type" foo="bar"]
 
@@ -937,7 +936,6 @@ BLOB;
 			),
 			$galleries
 		);
-
 	}
 
 	/**
diff --git a/tests/media/wpGenerateAttachmentMetadata.php b/tests/media/wpGenerateAttachmentMetadata.php
index 82fe7dabd6..fee7ebb577 100644
--- a/tests/media/wpGenerateAttachmentMetadata.php
+++ b/tests/media/wpGenerateAttachmentMetadata.php
@@ -73,7 +73,7 @@ class Tests_Media_wpGenerateAttachmentMetadata extends WP_UnitTestCase {
 			// PSD mime type is not allowed by default on multisite.
 			add_filter(
 				'upload_mimes',
-				static function( $mimes ) {
+				static function ( $mimes ) {
 					$mimes['psd'] = 'application/octet-stream';
 					return $mimes;
 				}
diff --git a/tests/media/wpImageTagAddDecodingAttr.php b/tests/media/wpImageTagAddDecodingAttr.php
index 3ffe1bc6b4..15e1859084 100644
--- a/tests/media/wpImageTagAddDecodingAttr.php
+++ b/tests/media/wpImageTagAddDecodingAttr.php
@@ -19,13 +19,15 @@ class Tests_Media_Wp_Img_Tag_Add_Decoding_Attr extends WP_UnitTestCase {
 	 * @param string $context  Additional context to pass to the filters.
 	 * @param string $decoding The value for the 'decoding' attribute. 'no value' for default.
 	 * @param string $expected The expected `img` tag.
+	 *
+	 * @expectedDeprecated wp_img_tag_add_decoding_attr
 	 */
 	public function test_should_add_decoding_attr( $image, $context, $decoding, $expected ) {
 		// Falsey values are allowed in the filter, cannot use `null` or `false` here.
 		if ( 'no value' !== $decoding ) {
 			add_filter(
 				'wp_img_tag_add_decoding_attr',
-				static function( $value ) use ( $decoding ) {
+				static function ( $value ) use ( $decoding ) {
 					return $decoding;
 				}
 			);
@@ -80,13 +82,15 @@ class Tests_Media_Wp_Img_Tag_Add_Decoding_Attr extends WP_UnitTestCase {
 	 * @param string $context  Additional context to pass to the filters.
 	 * @param mixed  $decoding The value for the 'decoding' attribute. 'no value' for default.
 	 * @param string $expected The expected `img` tag.
+	 *
+	 * @expectedDeprecated wp_img_tag_add_decoding_attr
 	 */
 	public function test_should_not_add_decoding_attr( $image, $context, $decoding, $expected ) {
 		// Falsey values are allowed in the filter, cannot use `null` or `false` here.
 		if ( 'no value' !== $decoding ) {
 			add_filter(
 				'wp_img_tag_add_decoding_attr',
-				static function( $value ) use ( $decoding ) {
+				static function ( $value ) use ( $decoding ) {
 					return $decoding;
 				}
 			);
diff --git a/tests/menu/walker-nav-menu.php b/tests/menu/walker-nav-menu.php
index 0c38502f9e..878bf12cc4 100644
--- a/tests/menu/walker-nav-menu.php
+++ b/tests/menu/walker-nav-menu.php
@@ -101,7 +101,7 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 
 		add_filter(
 			'nav_menu_link_attributes',
-			static function( $atts ) use ( $value ) {
+			static function ( $atts ) use ( $value ) {
 				$atts['data-test'] = $value;
 				return $atts;
 			}
@@ -365,4 +365,117 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 
 		$this->assertStringContainsString( 'rel="privacy-policy"', $output );
 	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::start_lvl()` applies 'nav_menu_submenu_attributes' filters.
+	 *
+	 * @ticket 57278
+	 *
+	 * @covers Walker_Nav_Menu::start_lvl
+	 */
+	public function test_start_lvl_should_apply_nav_menu_submenu_attributes_filters() {
+		$output = '';
+		$args   = (object) array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$filter = new MockAction();
+		add_filter( 'nav_menu_submenu_attributes', array( $filter, 'filter' ) );
+
+		$this->walker->start_lvl( $output, 0, $args );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::start_el()` applies 'nav_menu_item_attributes' filters.
+	 *
+	 * @ticket 57278
+	 *
+	 * @covers Walker_Nav_Menu::start_el
+	 */
+	public function test_start_el_should_apply_nav_menu_item_attributes_filters() {
+		$output  = '';
+		$post_id = self::factory()->post->create();
+		$item    = (object) array(
+			'ID'        => $post_id,
+			'object_id' => $post_id,
+			'title'     => get_the_title( $post_id ),
+			'target'    => '',
+			'xfn'       => '',
+			'current'   => false,
+		);
+		$args    = (object) array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$filter = new MockAction();
+		add_filter( 'nav_menu_item_attributes', array( $filter, 'filter' ) );
+
+		$this->walker->start_el( $output, $item, 0, $args );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::build_atts()` builds attributes correctly.
+	 *
+	 * @ticket 57278
+	 *
+	 * @covers Walker_Nav_Menu::build_atts
+	 *
+	 * @dataProvider data_build_atts_should_build_attributes
+	 *
+	 * @param array  $atts     An array of HTML attribute key/value pairs.
+	 * @param string $expected The expected built attributes.
+	 */
+	public function test_build_atts_should_build_attributes( $atts, $expected ) {
+		$build_atts_reflection = new ReflectionMethod( $this->walker, 'build_atts' );
+
+		$build_atts_reflection->setAccessible( true );
+		$actual = $build_atts_reflection->invoke( $this->walker, $atts );
+		$build_atts_reflection->setAccessible( false );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_build_atts_should_build_attributes() {
+		return array(
+			'an empty attributes array'                   => array(
+				'atts'     => array(),
+				'expected' => '',
+			),
+			'attributes containing a (bool) false value'  => array(
+				'atts'     => array( 'disabled' => false ),
+				'expected' => '',
+			),
+			'attributes containing an empty string value' => array(
+				'atts'     => array( 'id' => '' ),
+				'expected' => '',
+			),
+			'attributes containing a non-scalar value'    => array(
+				'atts'     => array( 'data-items' => new stdClass() ),
+				'expected' => '',
+			),
+			'attributes containing a "href" -> should escape the URL' => array(
+				'atts'     => array( 'href' => 'https://example.org/A File With Spaces.pdf' ),
+				'expected' => ' href="https://example.org/A%20File%20With%20Spaces.pdf"',
+			),
+			'attributes containing a non-"href" attribute -> should escape the value' => array(
+				'atts'     => array( 'id' => 'hello&goodbye' ),
+				'expected' => ' id="hello&amp;goodbye"',
+			),
+		);
+	}
 }
diff --git a/tests/menu/wp-nav-menu.php b/tests/menu/wp-nav-menu.php
index 298b222e01..72f5932ad0 100644
--- a/tests/menu/wp-nav-menu.php
+++ b/tests/menu/wp-nav-menu.php
@@ -243,6 +243,5 @@ class Tests_Menu_wpNavMenu extends WP_UnitTestCase {
 			$menu_html,
 			'The level zero menu item should appear in the menu.'
 		);
-
 	}
 }
diff --git a/tests/meta.php b/tests/meta.php
index 83dcefd1ba..ae94c35508 100644
--- a/tests/meta.php
+++ b/tests/meta.php
@@ -151,56 +151,50 @@ class Tests_Meta extends WP_UnitTestCase {
 		$this->assertNotEquals( $this->author->user_login, $u[0]->user_login );
 
 		// Test EXISTS and NOT EXISTS together, no users should be found.
-		$this->assertSame(
+		$this->assertCount(
 			0,
-			count(
-				get_users(
-					array(
-						'meta_query' => array(
-							array(
-								'key'     => 'meta_key',
-								'compare' => 'NOT EXISTS',
-							),
-							array(
-								'key'     => 'delete_meta_key',
-								'compare' => 'EXISTS',
-							),
+			get_users(
+				array(
+					'meta_query' => array(
+						array(
+							'key'     => 'meta_key',
+							'compare' => 'NOT EXISTS',
+						),
+						array(
+							'key'     => 'delete_meta_key',
+							'compare' => 'EXISTS',
 						),
-					)
+					),
 				)
 			)
 		);
 
-		$this->assertSame(
+		$this->assertCount(
 			2,
-			count(
-				get_users(
-					array(
-						'meta_query' => array(
-							array(
-								'key'     => 'non_existing_meta',
-								'compare' => 'NOT EXISTS',
-							),
+			get_users(
+				array(
+					'meta_query' => array(
+						array(
+							'key'     => 'non_existing_meta',
+							'compare' => 'NOT EXISTS',
 						),
-					)
+					),
 				)
 			)
 		);
 
 		delete_metadata( 'user', $this->author->ID, 'meta_key' );
 
-		$this->assertSame(
+		$this->assertCount(
 			2,
-			count(
-				get_users(
-					array(
-						'meta_query' => array(
-							array(
-								'key'     => 'meta_key',
-								'compare' => 'NOT EXISTS',
-							),
+			get_users(
+				array(
+					'meta_query' => array(
+						array(
+							'key'     => 'meta_key',
+							'compare' => 'NOT EXISTS',
 						),
-					)
+					),
 				)
 			)
 		);
@@ -378,7 +372,7 @@ class Tests_Meta extends WP_UnitTestCase {
 
 		$string_mid = "{$meta_id}.0";
 
-		// phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison -- intentional implicit casting check
+		// phpcs:ignore Universal.Operators.StrictComparisons.LooseEqual -- intentional implicit casting check
 		$this->assertTrue( floor( $string_mid ) == $string_mid );
 		$this->assertNotFalse( get_metadata_by_mid( 'user', $string_mid ) );
 		$this->assertNotFalse( update_metadata_by_mid( 'user', $string_mid, 'meta_new_value_2' ) );
diff --git a/tests/meta/isProtectedMeta.php b/tests/meta/isProtectedMeta.php
index ba3eeed9a2..3216d3a745 100644
--- a/tests/meta/isProtectedMeta.php
+++ b/tests/meta/isProtectedMeta.php
@@ -51,5 +51,4 @@ class Tests_Meta_isProtectedMeta extends WP_UnitTestCase {
 
 		return $unprotected_keys;
 	}
-
 }
diff --git a/tests/meta/registerMeta.php b/tests/meta/registerMeta.php
index ae2c1d6e63..329321dd9b 100644
--- a/tests/meta/registerMeta.php
+++ b/tests/meta/registerMeta.php
@@ -97,6 +97,7 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 						'sanitize_callback' => null,
 						'auth_callback'     => '__return_true',
 						'show_in_rest'      => false,
+						'revisions_enabled' => false,
 					),
 				),
 			),
@@ -121,6 +122,7 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 						'sanitize_callback' => null,
 						'auth_callback'     => '__return_true',
 						'show_in_rest'      => false,
+						'revisions_enabled' => false,
 					),
 				),
 			),
@@ -175,6 +177,7 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 						'sanitize_callback' => array( $this, '_new_sanitize_meta_cb' ),
 						'auth_callback'     => '__return_true',
 						'show_in_rest'      => false,
+						'revisions_enabled' => false,
 					),
 				),
 			),
@@ -342,6 +345,7 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 						'sanitize_callback' => null,
 						'auth_callback'     => '__return_true',
 						'show_in_rest'      => false,
+						'revisions_enabled' => false,
 					),
 				),
 			),
@@ -395,6 +399,7 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 						'sanitize_callback' => null,
 						'auth_callback'     => '__return_true',
 						'show_in_rest'      => false,
+						'revisions_enabled' => false,
 					),
 				),
 			),
@@ -546,7 +551,6 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 		update_metadata( $object_type, $object_id, $meta_key, $meta_value );
 		$value = get_metadata( $object_type, $object_id, $meta_key, true );
 		$this->assertSame( $value, $meta_value );
-
 	}
 
 	/**
@@ -1082,4 +1086,35 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 			array( 'user', 'user' ),
 		);
 	}
+
+	/**
+	 * Test that attempting to register meta with revisions_enabled set to true on a
+	 * post type that does not have revisions enabled fails and throws a `doing_it_wrong` notice.
+	 *
+	 * @ticket 20564
+	 */
+	public function test_register_meta_with_revisions_enabled_on_post_type_without_revisions() {
+		$this->setExpectedIncorrectUsage( 'register_meta' );
+
+		// Set up a custom post type with revisions disabled.
+		register_post_type(
+			'test_post_type',
+			array(
+				'supports' => array( 'title', 'editor' ),
+			)
+		);
+
+		$meta_key = 'registered_key1';
+		$args     = array(
+			'revisions_enabled' => true,
+		);
+
+		$register = register_meta(
+			'test_post_type',
+			$meta_key,
+			$args
+		);
+
+		$this->assertFalse( $register );
+	}
 }
diff --git a/tests/meta/updateMetadata.php b/tests/meta/updateMetadata.php
index 7f5aff32cd..355e53f160 100644
--- a/tests/meta/updateMetadata.php
+++ b/tests/meta/updateMetadata.php
@@ -105,5 +105,4 @@ class Tests_Meta_UpdateMetadata extends WP_UnitTestCase {
 		$found = get_metadata( 'post', $post_id, 'key', true );
 		$this->assertSame( 'value2', $found );
 	}
-
 }
diff --git a/tests/multisite/getIdFromBlogname.php b/tests/multisite/getIdFromBlogname.php
index 49b4bf6f85..63f8ab79e7 100644
--- a/tests/multisite/getIdFromBlogname.php
+++ b/tests/multisite/getIdFromBlogname.php
@@ -136,7 +136,6 @@ if ( is_multisite() ) :
 
 			$this->assertNull( $result );
 		}
-
 	}
 
 endif;
diff --git a/tests/multisite/getSite.php b/tests/multisite/getSite.php
index 46a5121247..c87f99649c 100644
--- a/tests/multisite/getSite.php
+++ b/tests/multisite/getSite.php
@@ -47,7 +47,6 @@ if ( is_multisite() ) :
 
 			$this->assertSame( self::$site_ids['wordpress.org/foo/'], $site->id );
 		}
-
 	}
 
 endif;
diff --git a/tests/multisite/network.php b/tests/multisite/network.php
index 630f76ebaf..c7fb78e547 100644
--- a/tests/multisite/network.php
+++ b/tests/multisite/network.php
@@ -267,7 +267,7 @@ if ( is_multisite() ) :
 		}
 
 		public function helper_deactivate_hook() {
-			$this->plugin_hook_count++;
+			++$this->plugin_hook_count;
 		}
 
 		public function test_wp_schedule_update_network_counts() {
@@ -590,14 +590,12 @@ if ( is_multisite() ) :
 		 * @ticket 42251
 		 */
 		public function test_get_network_not_found_cache() {
-			global $wpdb;
-
 			$new_network_id = $this->_get_next_network_id();
 			$this->assertNull( get_network( $new_network_id ) );
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 			$this->assertNull( get_network( $new_network_id ) );
-			$this->assertSame( $num_queries, $wpdb->num_queries );
+			$this->assertSame( $num_queries, get_num_queries() );
 		}
 
 		/**
diff --git a/tests/multisite/site.php b/tests/multisite/site.php
index 0d1667fbae..aa04499105 100644
--- a/tests/multisite/site.php
+++ b/tests/multisite/site.php
@@ -422,7 +422,7 @@ if ( is_multisite() ) :
 		public function test_get_blog_details_when_site_does_not_exist() {
 			// Create an unused site so that we can then assume an invalid site ID.
 			$blog_id = self::factory()->blog->create();
-			$blog_id++;
+			++$blog_id;
 
 			// Prime the cache for an invalid site.
 			get_blog_details( $blog_id );
@@ -1162,7 +1162,6 @@ if ( is_multisite() ) :
 			remove_action( 'clean_site_cache', array( $this, 'action_database_insert_on_clean_site_cache' ) );
 
 			$this->assertIsInt( $site_id );
-
 		}
 
 		public function action_database_insert_on_clean_site_cache() {
@@ -2170,14 +2169,12 @@ if ( is_multisite() ) :
 		 * @ticket 42251
 		 */
 		public function test_get_site_not_found_cache() {
-			global $wpdb;
-
 			$new_site_id = $this->_get_next_site_id();
 			$this->assertNull( get_site( $new_site_id ) );
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 			$this->assertNull( get_site( $new_site_id ) );
-			$this->assertSame( $num_queries, $wpdb->num_queries );
+			$this->assertSame( $num_queries, get_num_queries() );
 		}
 
 		/**
@@ -2196,7 +2193,6 @@ if ( is_multisite() ) :
 			$fetched_site = get_site( $new_site_id );
 			$this->assertInstanceOf( 'WP_Site', $fetched_site );
 			$this->assertEquals( $new_site_id, $fetched_site->blog_id );
-
 		}
 
 		/**
diff --git a/tests/multisite/siteMeta.php b/tests/multisite/siteMeta.php
index 4a1a30fee2..ad59c75e34 100644
--- a/tests/multisite/siteMeta.php
+++ b/tests/multisite/siteMeta.php
@@ -220,8 +220,6 @@ if ( is_multisite() ) :
 		}
 
 		public function test_update_site_meta_cache() {
-			global $wpdb;
-
 			if ( ! is_site_meta_supported() ) {
 				$this->markTestSkipped( 'Test only runs with the blogmeta database table installed.' );
 			}
@@ -229,14 +227,12 @@ if ( is_multisite() ) :
 			update_site_meta( self::$site_id, 'foo', 'bar' );
 			update_sitemeta_cache( array( self::$site_id ) );
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 			get_site_meta( self::$site_id, 'foo', true );
-			$this->assertSame( $num_queries, $wpdb->num_queries );
+			$this->assertSame( $num_queries, get_num_queries() );
 		}
 
 		public function test_query_update_site_meta_cache_true() {
-			global $wpdb;
-
 			if ( ! is_site_meta_supported() ) {
 				$this->markTestSkipped( 'Test only runs with the blogmeta database table installed.' );
 			}
@@ -250,14 +246,84 @@ if ( is_multisite() ) :
 				)
 			);
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 			get_site_meta( self::$site_id, 'foo', true );
-			$this->assertSame( $num_queries, $wpdb->num_queries );
+			$this->assertSame( 1, get_num_queries() - $num_queries );
 		}
 
-		public function test_query_update_site_meta_cache_false() {
-			global $wpdb;
+		/**
+		 * @ticket 58185
+		 */
+		public function test_lazy_load_site_meta() {
+			if ( ! is_site_meta_supported() ) {
+				$this->markTestSkipped( 'Test only runs with the blogmeta database table installed.' );
+			}
+
+			$filter = new MockAction();
+			add_filter( 'update_blog_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+			$q = new WP_Site_Query(
+				array(
+					'ID' => self::$site_id,
+				)
+			);
+
+			$this->assertSameSets( array( (string) self::$site_id ), wp_list_pluck( $q->sites, 'blog_id' ), 'Site query should return the first test site' );
+
+			$q = new WP_Site_Query(
+				array(
+					'ID' => self::$site_id2,
+				)
+			);
+
+			$this->assertSameSets( array( (string) self::$site_id2 ), wp_list_pluck( $q->sites, 'blog_id' ), 'Site query should return the second test site' );
+
+			get_site_meta( self::$site_id2 );
+
+			$args     = $filter->get_args();
+			$first    = reset( $args );
+			$site_ids = end( $first );
+			$this->assertSameSets( $site_ids, array( self::$site_id, self::$site_id2 ), 'This should have two site\'s meta' );
+		}
+
+		/**
+		 * @ticket 58185
+		 */
+		public function test_lazy_load_site_meta_fields_id() {
+			if ( ! is_site_meta_supported() ) {
+				$this->markTestSkipped( 'Test only runs with the blogmeta database table installed.' );
+			}
+
+			$filter = new MockAction();
+			add_filter( 'update_blog_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+			$q = new WP_Site_Query(
+				array(
+					'ID'     => self::$site_id,
+					'fields' => 'ids',
+				)
+			);
+
+			$this->assertSameSets( array( self::$site_id ), $q->sites, 'Site query should return the first test site' );
+
+			$q = new WP_Site_Query(
+				array(
+					'ID'     => self::$site_id2,
+					'fields' => 'ids',
+				)
+			);
 
+			$this->assertSameSets( array( self::$site_id2 ), $q->sites, 'Site query should return the second test site' );
+
+			get_site_meta( self::$site_id2 );
+
+			$args     = $filter->get_args();
+			$first    = reset( $args );
+			$site_ids = end( $first );
+			$this->assertSameSets( $site_ids, array( self::$site_id, self::$site_id2 ), 'This should have two sites meta' );
+		}
+
+		public function test_query_update_site_meta_cache_false() {
 			if ( ! is_site_meta_supported() ) {
 				$this->markTestSkipped( 'Test only runs with the blogmeta database table installed.' );
 			}
@@ -271,9 +337,9 @@ if ( is_multisite() ) :
 				)
 			);
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 			get_site_meta( self::$site_id, 'foo', true );
-			$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+			$this->assertSame( 1, get_num_queries() - $num_queries );
 		}
 
 		/**
diff --git a/tests/multisite/updateBlogDetails.php b/tests/multisite/updateBlogDetails.php
index d3249a1261..d53c2f8c2b 100644
--- a/tests/multisite/updateBlogDetails.php
+++ b/tests/multisite/updateBlogDetails.php
@@ -127,6 +127,5 @@ if ( is_multisite() ) :
 				array( 'multiple///dirs', '/multiple///dirs/' ),
 			);
 		}
-
 	}
 endif;
diff --git a/tests/multisite/wpNetworkQuery.php b/tests/multisite/wpNetworkQuery.php
index 29b2b8f5f7..f59a4c6628 100644
--- a/tests/multisite/wpNetworkQuery.php
+++ b/tests/multisite/wpNetworkQuery.php
@@ -428,8 +428,6 @@ if ( is_multisite() ) :
 		 * @ticket 41347
 		 */
 		public function test_wp_network_query_cache_with_different_fields_no_count() {
-			global $wpdb;
-
 			$q                 = new WP_Network_Query();
 			$query_1           = $q->query(
 				array(
@@ -438,7 +436,7 @@ if ( is_multisite() ) :
 					'order'  => 'ASC',
 				)
 			);
-			$number_of_queries = $wpdb->num_queries;
+			$number_of_queries = get_num_queries();
 
 			$query_2 = $q->query(
 				array(
@@ -448,15 +446,13 @@ if ( is_multisite() ) :
 				)
 			);
 
-			$this->assertSame( $number_of_queries, $wpdb->num_queries );
+			$this->assertSame( $number_of_queries, get_num_queries() );
 		}
 
 		/**
 		 * @ticket 41347
 		 */
 		public function test_wp_network_query_cache_with_different_fields_active_count() {
-			global $wpdb;
-
 			$q = new WP_Network_Query();
 
 			$query_1           = $q->query(
@@ -467,7 +463,7 @@ if ( is_multisite() ) :
 					'count'  => true,
 				)
 			);
-			$number_of_queries = $wpdb->num_queries;
+			$number_of_queries = get_num_queries();
 
 			$query_2 = $q->query(
 				array(
@@ -477,15 +473,13 @@ if ( is_multisite() ) :
 					'count'  => true,
 				)
 			);
-			$this->assertSame( $number_of_queries, $wpdb->num_queries );
+			$this->assertSame( $number_of_queries, get_num_queries() );
 		}
 
 		/**
 		 * @ticket 41347
 		 */
 		public function test_wp_network_query_cache_with_same_fields_different_count() {
-			global $wpdb;
-
 			$q = new WP_Network_Query();
 
 			$query_1 = $q->query(
@@ -496,7 +490,7 @@ if ( is_multisite() ) :
 				)
 			);
 
-			$number_of_queries = $wpdb->num_queries;
+			$number_of_queries = get_num_queries();
 
 			$query_2 = $q->query(
 				array(
@@ -506,7 +500,7 @@ if ( is_multisite() ) :
 					'count'  => true,
 				)
 			);
-			$this->assertSame( $number_of_queries + 1, $wpdb->num_queries );
+			$this->assertSame( $number_of_queries + 1, get_num_queries() );
 		}
 
 		/**
@@ -568,11 +562,9 @@ if ( is_multisite() ) :
 		 * @ticket 47599
 		 */
 		public function test_networks_pre_query_filter_should_bypass_database_query() {
-			global $wpdb;
-
 			add_filter( 'networks_pre_query', array( __CLASS__, 'filter_networks_pre_query' ), 10, 2 );
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 
 			$q       = new WP_Network_Query();
 			$results = $q->query( array() );
@@ -580,7 +572,7 @@ if ( is_multisite() ) :
 			remove_filter( 'networks_pre_query', array( __CLASS__, 'filter_networks_pre_query' ), 10, 2 );
 
 			// Make sure no queries were executed.
-			$this->assertSame( $num_queries, $wpdb->num_queries );
+			$this->assertSame( $num_queries, get_num_queries() );
 
 			// We manually inserted a non-existing site and overrode the results with it.
 			$this->assertSame( array( 555 ), $results );
diff --git a/tests/multisite/wpSiteQuery.php b/tests/multisite/wpSiteQuery.php
index 8d1d84c1f0..2b2bed37de 100644
--- a/tests/multisite/wpSiteQuery.php
+++ b/tests/multisite/wpSiteQuery.php
@@ -779,7 +779,6 @@ if ( is_multisite() ) :
 		 * @ticket 41197
 		 */
 		public function test_wp_site_query_cache_with_different_fields_no_count() {
-			global $wpdb;
 			$q                 = new WP_Site_Query();
 			$query_1           = $q->query(
 				array(
@@ -789,7 +788,7 @@ if ( is_multisite() ) :
 					'order'      => 'ASC',
 				)
 			);
-			$number_of_queries = $wpdb->num_queries;
+			$number_of_queries = get_num_queries();
 
 			$query_2 = $q->query(
 				array(
@@ -800,14 +799,13 @@ if ( is_multisite() ) :
 				)
 			);
 
-			$this->assertSame( $number_of_queries, $wpdb->num_queries );
+			$this->assertSame( $number_of_queries, get_num_queries() );
 		}
 
 		/**
 		 * @ticket 41197
 		 */
 		public function test_wp_site_query_cache_with_different_fields_active_count() {
-			global $wpdb;
 			$q = new WP_Site_Query();
 
 			$query_1           = $q->query(
@@ -819,7 +817,7 @@ if ( is_multisite() ) :
 					'count'      => true,
 				)
 			);
-			$number_of_queries = $wpdb->num_queries;
+			$number_of_queries = get_num_queries();
 
 			$query_2 = $q->query(
 				array(
@@ -830,14 +828,13 @@ if ( is_multisite() ) :
 					'count'      => true,
 				)
 			);
-			$this->assertSame( $number_of_queries, $wpdb->num_queries );
+			$this->assertSame( $number_of_queries, get_num_queries() );
 		}
 
 		/**
 		 * @ticket 41197
 		 */
 		public function test_wp_site_query_cache_with_same_fields_different_count() {
-			global $wpdb;
 			$q = new WP_Site_Query();
 
 			$query_1 = $q->query(
@@ -860,7 +857,7 @@ if ( is_multisite() ) :
 					'count'      => true,
 				)
 			);
-			$this->assertSame( $number_of_queries + 1, $wpdb->num_queries );
+			$this->assertSame( $number_of_queries + 1, get_num_queries() );
 		}
 
 		/**
@@ -1119,11 +1116,9 @@ if ( is_multisite() ) :
 		 * @ticket 47599
 		 */
 		public function test_sites_pre_query_filter_should_bypass_database_query() {
-			global $wpdb;
-
 			add_filter( 'sites_pre_query', array( __CLASS__, 'filter_sites_pre_query' ), 10, 2 );
 
-			$num_queries = $wpdb->num_queries;
+			$num_queries = get_num_queries();
 
 			$q       = new WP_Site_Query();
 			$results = $q->query( array() );
@@ -1131,7 +1126,7 @@ if ( is_multisite() ) :
 			remove_filter( 'sites_pre_query', array( __CLASS__, 'filter_sites_pre_query' ), 10, 2 );
 
 			// Make sure no queries were executed.
-			$this->assertSame( $num_queries, $wpdb->num_queries );
+			$this->assertSame( $num_queries, get_num_queries() );
 
 			// We manually inserted a non-existing site and overrode the results with it.
 			$this->assertSame( array( 555 ), $results );
diff --git a/tests/oembed/controller.php b/tests/oembed/controller.php
index 238b1faf1f..821eeac7e3 100644
--- a/tests/oembed/controller.php
+++ b/tests/oembed/controller.php
@@ -171,7 +171,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 		}
 		$this->assertIsString( $url );
 		$this->assertIsArray( $args );
-		$this->oembed_result_filter_count++;
+		++$this->oembed_result_filter_count;
 		return $data;
 	}
 
diff --git a/tests/oembed/template.php b/tests/oembed/template.php
index 20643c92a2..12092ff669 100644
--- a/tests/oembed/template.php
+++ b/tests/oembed/template.php
@@ -10,6 +10,8 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		global $wp_scripts;
 		$wp_scripts = null;
+
+		remove_action( 'wp_print_styles', 'print_emoji_styles' );
 	}
 
 	public function tear_down() {
@@ -343,15 +345,4 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 		wp_maybe_enqueue_oembed_host_js( $post_embed );
 		$this->assertFalse( $scripts->query( 'wp-embed', 'enqueued' ) );
 	}
-
-	/**
-	 * Confirms that no ampersands exist in src/wp-includes/js/wp-embed.js.
-	 *
-	 * See also the `verify:wp-embed` Grunt task for verifying the built file.
-	 *
-	 * @ticket 34698
-	 */
-	public function test_js_no_ampersands() {
-		$this->assertStringNotContainsString( '&', file_get_contents( ABSPATH . WPINC . '/js/wp-embed.js' ) );
-	}
 }
diff --git a/tests/option/getOptions.php b/tests/option/getOptions.php
new file mode 100644
index 0000000000..7435dce188
--- /dev/null
+++ b/tests/option/getOptions.php
@@ -0,0 +1,91 @@
+<?php
+/**
+ * Test get_options().
+ *
+ * @group option
+ *
+ * @covers ::get_options
+ */
+class Tests_Option_GetOptions extends WP_UnitTestCase {
+
+	/**
+	 * Tests that get_options() retrieves specified options.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_get_options() {
+		// Create some options to prime.
+		$options_to_prime = array(
+			'option1',
+			'option2',
+		);
+
+		/*
+		 * Set values for the options,
+		 * clear the cache for the options,
+		 * check options are not in cache initially.
+		 */
+		foreach ( $options_to_prime as $option ) {
+			update_option( $option, "value_$option", false );
+			wp_cache_delete( $option, 'options' );
+			$this->assertFalse( wp_cache_get( $option, 'options' ), "$option was not deleted from the cache." );
+		}
+
+		// Call the get_options function to retrieve the options.
+		$options = get_options( array( 'option1', 'option2' ) );
+
+		// Check that options are now in the cache.
+		foreach ( $options_to_prime as $option ) {
+			$this->assertSame( wp_cache_get( $option, 'options' ), get_option( $option ), "$option was not primed." );
+		}
+
+		// Check that the retrieved options are correct.
+		$this->assertSame( get_option( 'option1' ), $options['option1'], 'Retrieved option1 does not match expected value.' );
+		$this->assertSame( get_option( 'option2' ), $options['option2'], 'Retrieved option2 does not match expected value.' );
+	}
+
+	/**
+	 * Tests get_options() with an empty input array.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_get_options_with_empty_array() {
+		// Call the get_options function with an empty array.
+		$options = get_options( array() );
+
+		// Make sure the result is an empty array.
+		$this->assertIsArray( $options, 'An array should have been returned.' );
+		$this->assertEmpty( $options, 'No options should have been returned.' );
+	}
+
+	/**
+	 * Tests get_options() with options that include some nonexistent options.
+	 */
+	public function test_get_options_with_nonexistent_options() {
+		// Create some options to prime.
+		$options_to_prime = array(
+			'option1',
+		);
+
+		// Make sure options are not in cache or database initially.
+		$this->assertFalse( wp_cache_get( 'option1', 'options' ), 'option1 was not deleted from the cache.' );
+		$this->assertFalse( wp_cache_get( 'nonexistent_option', 'options' ), 'nonexistent_option was not deleted from the cache.' );
+
+		// Call the get_options function with an array that includes a nonexistent option.
+		$options = get_options( array( 'option1', 'nonexistent_option' ) );
+
+		// Check that the retrieved options are correct.
+		$this->assertSame( get_option( 'option1' ), $options['option1'], 'Retrieved option1 does not match expected value.' );
+
+		// Check that options are present in the notoptions cache.
+		$new_notoptions = wp_cache_get( 'notoptions', 'options' );
+		foreach ( $options_to_prime as $option ) {
+			$this->assertTrue( isset( $new_notoptions[ $option ] ), "$option was not added to the notoptions cache." );
+		}
+
+		// Check that the nonexistent option is in the result array.
+		$this->assertArrayHasKey( 'nonexistent_option', $options, 'Result array should not contain nonexistent_option.' );
+
+		$this->assertFalse( $options['nonexistent_option'], 'nonexistent_option is present in option.' );
+	}
+}
diff --git a/tests/option/isEqualDatabaseValue.php b/tests/option/isEqualDatabaseValue.php
new file mode 100644
index 0000000000..22d1d2ac1c
--- /dev/null
+++ b/tests/option/isEqualDatabaseValue.php
@@ -0,0 +1,71 @@
+<?php
+/**
+ * Tests for _is_equal_database_value().
+ *
+ * @group option
+ *
+ * @covers ::_is_equal_database_value
+ */
+class Tests_Option_IsEqualDatabaseValue extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 22192
+	 *
+	 * @dataProvider data_is_equal_database_value
+	 *
+	 * @param mixed $old_value The old value to compare.
+	 * @param mixed $new_value The new value to compare.
+	 * @param bool  $expected  The expected result.
+	 */
+	public function test_is_equal_database_value( $old_value, $new_value, $expected ) {
+		$this->assertSame( $expected, _is_equal_database_value( $old_value, $new_value ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_is_equal_database_value() {
+		return array(
+			// Equal values.
+			array( '123', '123', true ),
+
+			// Not equal values.
+			array( '123', '456', false ),
+
+			// Truthy.
+			array( 1, '1', true ),
+			array( 1.0, '1', true ),
+			array( '1', '1', true ),
+			array( true, '1', true ),
+			array( '1.0', '1', false ),
+			array( '    ', '1', false ),
+			array( array( '0' ), '1', false ),
+			array( new stdClass(), '1', false ),
+			array( 'Howdy, admin!', '1', false ),
+
+			// False-ish values and empty strings.
+			array( 0, '0', true ),
+			array( 0.0, '0', true ),
+			array( '0', '0', true ),
+			array( '', '0', false ),
+			array( false, '0', false ),
+			array( null, '0', false ),
+			array( array(), '0', false ),
+
+			// Object values.
+			array( (object) array( 'foo' => 'bar' ), (object) array( 'foo' => 'bar' ), true ),
+			array( (object) array( 'foo' => 'bar' ), (object) array( 'foo' => 'baz' ), false ),
+			array( (object) array( 'foo' => 'bar' ), serialize( (object) array( 'foo' => 'bar' ) ), false ),
+			array( serialize( (object) array( 'foo' => 'bar' ) ), (object) array( 'foo' => 'bar' ), false ),
+			array( serialize( (object) array( 'foo' => 'bar' ) ), (object) array( 'foo' => 'baz' ), false ),
+
+			// Serialized values.
+			array( array( 'foo' => 'bar' ), serialize( array( 'foo' => 'bar' ) ), false ),
+			array( array( 'foo' => 'bar' ), serialize( array( 'foo' => 'baz' ) ), false ),
+			array( serialize( (object) array( 'foo' => 'bar' ) ), serialize( (object) array( 'foo' => 'bar' ) ), true ),
+			array( serialize( (object) array( 'foo' => 'bar' ) ), serialize( (object) array( 'foo' => 'baz' ) ), false ),
+		);
+	}
+}
diff --git a/tests/option/option.php b/tests/option/option.php
index d510528e07..e2e4a8abe9 100644
--- a/tests/option/option.php
+++ b/tests/option/option.php
@@ -100,6 +100,62 @@ class Tests_Option_Option extends WP_UnitTestCase {
 		$this->assertSame( 1, $filter->get_call_count() );
 	}
 
+	/**
+	 * @ticket 58277
+	 *
+	 * @covers ::get_option
+	 */
+	public function test_get_option_notoptions_cache() {
+		$notoptions = array(
+			'invalid' => true,
+		);
+		wp_cache_set( 'notoptions', $notoptions, 'options' );
+
+		$before = get_num_queries();
+		$value  = get_option( 'invalid' );
+		$after  = get_num_queries();
+
+		$this->assertSame( 0, $after - $before );
+	}
+
+	/**
+	 * @ticket 58277
+	 *
+	 * @covers ::get_option
+	 */
+	public function test_get_option_notoptions_set_cache() {
+		get_option( 'invalid' );
+
+		$before = get_num_queries();
+		$value  = get_option( 'invalid' );
+		$after  = get_num_queries();
+
+		$notoptions = wp_cache_get( 'notoptions', 'options' );
+
+		$this->assertSame( 0, $after - $before, 'The notoptions cache was not hit on the second call to `get_option()`.' );
+		$this->assertIsArray( $notoptions, 'The notoptions cache should be set.' );
+		$this->assertArrayHasKey( 'invalid', $notoptions, 'The "invalid" option should be in the notoptions cache.' );
+	}
+
+	/**
+	 * @ticket 58277
+	 *
+	 * @covers ::get_option
+	 */
+	public function test_get_option_notoptions_do_not_load_cache() {
+		add_option( 'foo', 'bar', '', 'no' );
+		wp_cache_delete( 'notoptions', 'options' );
+
+		$before = get_num_queries();
+		$value  = get_option( 'foo' );
+		$after  = get_num_queries();
+
+		$notoptions = wp_cache_get( 'notoptions', 'options' );
+
+		$this->assertSame( 0, $after - $before, 'The options cache was not hit on the second call to `get_option()`.' );
+		$this->assertFalse( $notoptions, 'The notoptions cache should not be set.' );
+	}
+
 	/**
 	 * @covers ::get_option
 	 * @covers ::add_option
@@ -312,4 +368,270 @@ class Tests_Option_Option extends WP_UnitTestCase {
 			array( 'autoload_false', false, 'no' ),
 		);
 	}
+
+	/**
+	 * Ensure the database is getting updated when type changes, but not otherwise.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 *
+	 * @dataProvider data_update_option_type_juggling
+	 */
+	public function test_update_loosey_options( $old_value, $new_value, $update = false ) {
+		add_option( 'foo', $old_value );
+
+		// Comparison will happen against value cached during add_option() above.
+		$updated = update_option( 'foo', $new_value );
+
+		if ( $update ) {
+			$this->assertTrue( $updated, 'This loosely equal option should trigger an update.' );
+		} else {
+			$this->assertFalse( $updated, 'Loosely equal option should not trigger an update.' );
+		}
+	}
+
+	/**
+	 * Ensure the database is getting updated when type changes, but not otherwise.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 *
+	 * @dataProvider data_update_option_type_juggling
+	 */
+	public function test_update_loosey_options_from_db( $old_value, $new_value, $update = false ) {
+		add_option( 'foo', $old_value );
+
+		// Delete cache.
+		wp_cache_delete( 'alloptions', 'options' );
+		$updated = update_option( 'foo', $new_value );
+
+		if ( $update ) {
+			$this->assertTrue( $updated, 'This loosely equal option should trigger an update.' );
+		} else {
+			$this->assertFalse( $updated, 'Loosely equal option should not trigger an update.' );
+		}
+	}
+
+	/**
+	 * Ensure the database is getting updated when type changes, but not otherwise.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 *
+	 * @dataProvider data_update_option_type_juggling
+	 */
+	public function test_update_loosey_options_from_refreshed_cache( $old_value, $new_value, $update = false ) {
+		add_option( 'foo', $old_value );
+
+		// Delete and refresh cache from DB.
+		wp_cache_delete( 'alloptions', 'options' );
+		wp_load_alloptions();
+
+		$updated = update_option( 'foo', $new_value );
+
+		if ( $update ) {
+			$this->assertTrue( $updated, 'This loosely equal option should trigger an update.' );
+		} else {
+			$this->assertFalse( $updated, 'Loosely equal option should not trigger an update.' );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_update_option_type_juggling() {
+		return array(
+			/*
+			 * Truthy values.
+			 * Loosely equal truthy scalar values should never result in a DB update.
+			 */
+			array( '1', '1' ),
+			array( '1', 1 ),
+			array( '1', 1.0 ),
+			array( '1', true ),
+			array( 1, '1' ),
+			array( 1, 1 ),
+			array( 1, 1.0 ),
+			array( 1, true ),
+			array( 1.0, '1' ),
+			array( 1.0, 1 ),
+			array( 1.0, 1.0 ),
+			array( 1.0, true ),
+			array( true, '1' ),
+			array( true, 1 ),
+			array( true, 1.0 ),
+			array( true, true ),
+
+			/*
+			 * Falsey values.
+			 * Loosely equal falsey scalar values only sometimes result in a DB update.
+			 */
+			array( '0', '0' ),
+			array( '0', 0 ),
+			array( '0', 0.0 ),
+			array( '0', false, true ), // Should update.
+			array( '', '' ),
+			array( '', 0, true ), // Should update.
+			array( '', 0.0, true ), // Should update.
+			array( '', false ),
+			array( 0, '0' ),
+			array( 0, '', true ), // Should update.
+			array( 0, 0 ),
+			array( 0, 0.0 ),
+			array( 0, false, true ), // Should update.
+			array( 0.0, '0' ),
+			array( 0.0, '', true ), // Should update.
+			array( 0.0, 0 ),
+			array( 0.0, 0.0 ),
+			array( 0.0, false, true ), // Should update.
+			array( false, '0', true ), // Should update.
+			array( false, '' ),
+			array( false, 0, true ), // Should update.
+			array( false, 0.0, true ), // Should update.
+			array( false, false ),
+
+			/*
+			 * Non scalar values.
+			 * Loosely equal non-scalar values should almost always result in an update.
+			 */
+			array( false, array(), true ),
+			array( 'false', array(), true ),
+			array( '', array(), true ),
+			array( 0, array(), true ),
+			array( '0', array(), true ),
+			array( false, null ), // Does not update.
+			array( 'false', null, true ),
+			array( '', null ), // Does not update.
+			array( 0, null, true ),
+			array( '0', null, true ),
+			array( array(), false, true ),
+			array( array(), 'false', true ),
+			array( array(), '', true ),
+			array( array(), 0, true ),
+			array( array(), '0', true ),
+			array( array(), null, true ),
+			array( null, false ), // Does not update.
+			array( null, 'false', true ),
+			array( null, '' ), // Does not update.
+			array( null, 0, true ),
+			array( null, '0', true ),
+			array( null, array(), true ),
+		);
+	}
+
+	/**
+	 * Tests that update_option() stores an option that uses
+	 * an unfiltered default value of (bool) false.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 */
+	public function test_update_option_should_store_option_with_default_value_false() {
+		global $wpdb;
+
+		$option = 'update_option_default_false';
+		update_option( $option, false );
+
+		$actual = $wpdb->query(
+			$wpdb->prepare(
+				"SELECT option_name FROM $wpdb->options WHERE option_name = %s LIMIT 1",
+				$option
+			)
+		);
+
+		$this->assertSame( 1, $actual );
+	}
+
+	/**
+	 * Tests that update_option() stores an option that uses
+	 * a filtered default value.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 */
+	public function test_update_option_should_store_option_with_filtered_default_value() {
+		global $wpdb;
+
+		$option        = 'update_option_custom_default';
+		$default_value = 'default-value';
+
+		add_filter(
+			"default_option_{$option}",
+			static function () use ( $default_value ) {
+				return $default_value;
+			}
+		);
+
+		update_option( $option, $default_value );
+
+		$actual = $wpdb->query(
+			$wpdb->prepare(
+				"SELECT option_name FROM $wpdb->options WHERE option_name = %s LIMIT 1",
+				$option
+			)
+		);
+
+		$this->assertSame( 1, $actual );
+	}
+
+	/**
+	 * Tests that a non-existing option is added even when its pre filter returns a value.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 */
+	public function test_update_option_with_pre_filter_adds_missing_option() {
+		// Force a return value of integer 0.
+		add_filter( 'pre_option_foo', '__return_zero' );
+
+		/*
+		 * This should succeed, since the 'foo' option does not exist in the database.
+		 * The default value is false, so it differs from 0.
+		 */
+		$this->assertTrue( update_option( 'foo', 0 ) );
+	}
+
+	/**
+	 * Tests that an existing option is updated even when its pre filter returns the same value.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 */
+	public function test_update_option_with_pre_filter_updates_option_with_different_value() {
+		// Add the option with a value of 1 to the database.
+		add_option( 'foo', 1 );
+
+		// Force a return value of integer 0.
+		add_filter( 'pre_option_foo', '__return_zero' );
+
+		/*
+		 * This should succeed, since the 'foo' option has a value of 1 in the database.
+		 * Therefore it differs from 0 and should be updated.
+		 */
+		$this->assertTrue( update_option( 'foo', 0 ) );
+	}
+
+	/**
+	 * Tests that calling update_option() does not permanently remove pre filters.
+	 *
+	 * @ticket 22192
+	 *
+	 * @covers ::update_option
+	 */
+	public function test_update_option_maintains_pre_filters() {
+		add_filter( 'pre_option_foo', '__return_zero' );
+		update_option( 'foo', 0 );
+
+		// Assert that the filter is still present.
+		$this->assertSame( 10, has_filter( 'pre_option_foo', '__return_zero' ) );
+	}
 }
diff --git a/tests/option/primeOptions.php b/tests/option/primeOptions.php
new file mode 100644
index 0000000000..6798d33f04
--- /dev/null
+++ b/tests/option/primeOptions.php
@@ -0,0 +1,130 @@
+<?php
+/**
+ * Test prime_options().
+ *
+ * @group option
+ *
+ * @covers ::prime_options
+ */
+class Tests_Option_PrimeOptions extends WP_UnitTestCase {
+
+	/**
+	 * Tests that prime_options() primes multiple options.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_prime_options() {
+		// Create some options to prime.
+		$options_to_prime = array(
+			'option1',
+			'option2',
+			'option3',
+		);
+
+		/*
+		 * Set values for the options,
+		 * clear the cache for the options,
+		 * check options are not in cache initially.
+		 */
+		foreach ( $options_to_prime as $option ) {
+			update_option( $option, "value_$option", false );
+			wp_cache_delete( $option, 'options' );
+			$this->assertFalse( wp_cache_get( $option, 'options' ), "$option was not deleted from the cache." );
+		}
+
+		// Call the prime_options function to prime the options.
+		prime_options( $options_to_prime );
+
+		// Store the initial database query count.
+		$initial_query_count = get_num_queries();
+
+		// Check that options are only in the 'options' cache group.
+		foreach ( $options_to_prime as $option ) {
+			$this->assertSame(
+				wp_cache_get( $option, 'options' ),
+				get_option( $option ),
+				"$option was not primed to the 'options' cache group."
+			);
+
+			$this->assertFalse(
+				wp_cache_get( $option, 'notoptions' ),
+				get_option( $option ),
+				"$option was primed to the 'notoptions' cache group."
+			);
+		}
+
+		// Ensure no additional database queries were made.
+		$this->assertSame(
+			$initial_query_count,
+			get_num_queries(),
+			'Additional database queries were made.'
+		);
+	}
+
+	/**
+	 * Tests prime_options() with options that do not exist in the database.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_prime_options_with_nonexistent_options() {
+		// Create some options to prime.
+		$options_to_prime = array(
+			'option1',
+			'option2',
+		);
+
+		/*
+		 * Set values for the options,
+		 * clear the cache for the options,
+		 * check options are not in cache initially.
+		 */
+		foreach ( $options_to_prime as $option ) {
+			$this->assertFalse( wp_cache_get( $option, 'options' ), "$option was not deleted from the cache." );
+		}
+
+		// Call the prime_options function to prime the options.
+		prime_options( $options_to_prime );
+
+		// Check that options are not in the cache or database.
+		foreach ( $options_to_prime as $option ) {
+			$this->assertFalse( wp_cache_get( $option, 'options' ), "$option was not deleted from the cache." );
+		}
+
+		// Check that options are present in the notoptions cache.
+		$new_notoptions = wp_cache_get( 'notoptions', 'options' );
+		$this->assertIsArray( $new_notoptions, 'The notoptions cache should be an array.' );
+		foreach ( $options_to_prime as $option ) {
+			$this->assertArrayHasKey( $option, $new_notoptions, "$option was not added to the notoptions cache." );
+		}
+	}
+
+	/**
+	 * Tests prime_options() with an empty array.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_prime_options_with_empty_array() {
+		$alloptions = wp_load_alloptions();
+		$notoptions = wp_cache_get( 'notoptions', 'options' );
+
+		prime_options( array() );
+
+		$this->assertSame( $alloptions, wp_cache_get( 'alloptions', 'options' ), 'The alloptions cache was modified.' );
+		$this->assertSame( $notoptions, wp_cache_get( 'notoptions', 'options' ), 'The notoptions cache was modified.' );
+	}
+
+	/**
+	 * Tests that prime_options handles an empty "notoptions" cache.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_prime_options_handles_empty_notoptions_cache() {
+		wp_cache_delete( 'notoptions', 'options' );
+
+		prime_options( array( 'nonexistent_option' ) );
+
+		$notoptions = wp_cache_get( 'notoptions', 'options' );
+		$this->assertIsArray( $notoptions, 'The notoptions cache should be an array.' );
+		$this->assertArrayHasKey( 'nonexistent_option', $notoptions, 'nonexistent_option was not added to notoptions.' );
+	}
+}
diff --git a/tests/option/primeOptionsByGroup.php b/tests/option/primeOptionsByGroup.php
new file mode 100644
index 0000000000..9d6819664c
--- /dev/null
+++ b/tests/option/primeOptionsByGroup.php
@@ -0,0 +1,75 @@
+<?php
+/**
+ * Test prime_options_by_group().
+ *
+ * @group option
+ *
+ * @covers ::prime_options_by_group
+ */
+class Tests_Option_PrimeOptionsByGroup extends WP_UnitTestCase {
+
+	/**
+	 * Tests that prime_options_by_group() only primes options in the specified group.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_prime_options_by_group() {
+		global $new_allowed_options;
+
+		// Create some options to prime.
+		$new_allowed_options = array(
+			'group1' => array(
+				'option1',
+				'option2',
+			),
+			'group2' => array(
+				'option3',
+			),
+		);
+
+		$options_to_prime = array(
+			'option1',
+			'option2',
+			'option3',
+		);
+
+		/*
+		 * Set values for the options,
+		 * clear the cache for the options,
+		 * check options are not in cache initially.
+		 */
+		foreach ( $options_to_prime as $option ) {
+			update_option( $option, "value_$option", false );
+			wp_cache_delete( $option, 'options' );
+			$this->assertFalse( wp_cache_get( $option, 'options' ), "$option was not deleted from the cache." );
+		}
+
+		// Call the prime_options_by_group function to prime the options.
+		prime_options_by_group( 'group1' );
+
+		// Check that options are now in the cache.
+		$this->assertSame( get_option( 'option1' ), wp_cache_get( 'option1', 'options' ), 'option1 was not primed.' );
+		$this->assertSame( get_option( 'option2' ), wp_cache_get( 'option2', 'options' ), 'option2 was not primed.' );
+
+		// Make sure option3 is still not in cache.
+		$this->assertFalse( wp_cache_get( 'option3', 'options' ), 'option3 was not deleted from the cache.' );
+	}
+
+	/**
+	 * Tests prime_options_by_group() with a nonexistent option group.
+	 *
+	 * @ticket 58962
+	 */
+	public function test_prime_options_by_group_with_nonexistent_group() {
+		// Make sure options are not in cache or database initially.
+		$this->assertFalse( wp_cache_get( 'option1', 'options' ), 'option1 was not deleted from the cache.' );
+		$this->assertFalse( wp_cache_get( 'option2', 'options' ), 'option2 was not deleted from the cache.' );
+
+		// Call the prime_options_by_group function with a nonexistent group.
+		prime_options_by_group( 'nonexistent_group' );
+
+		// Check that options are still not in the cache or database.
+		$this->assertFalse( wp_cache_get( 'option1', 'options' ), 'option1 was not deleted from the cache.' );
+		$this->assertFalse( wp_cache_get( 'option2', 'options' ), 'option2 was not deleted from the cache.' );
+	}
+}
diff --git a/tests/option/sanitizeOption.php b/tests/option/sanitizeOption.php
index e50cec0c62..b4f8293041 100644
--- a/tests/option/sanitizeOption.php
+++ b/tests/option/sanitizeOption.php
@@ -36,6 +36,7 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 			array( 'blogname', '&lt;i&gt;My Site&lt;/i&gt;', '<i>My Site</i>' ),
 			array( 'blog_charset', 'UTF-8', 'UTF-8' ),
 			array( 'blog_charset', 'charset', '">charset<"' ),
+			array( 'blog_charset', '', null ),
 			array( 'blog_public', 1, null ),
 			array( 'blog_public', 1, '1' ),
 			array( 'blog_public', -2, '-2' ),
@@ -45,6 +46,7 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 			array( 'ping_sites', "http://www.example.com\nhttp://example.org", "www.example.com \n\texample.org\n\n" ),
 			array( 'gmt_offset', '0', 0 ),
 			array( 'gmt_offset', '1.5', '1.5' ),
+			array( 'gmt_offset', '', null ),
 			array( 'siteurl', 'http://example.org', 'http://example.org' ),
 			array( 'siteurl', 'http://example.org/subdir', 'http://example.org/subdir' ),
 			array( 'siteurl', get_option( 'siteurl' ), '' ),
@@ -172,5 +174,4 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 			array( new WP_Error( 'wpdb_get_table_charset_failure' ), false, false ), // @ticket 53986
 		);
 	}
-
 }
diff --git a/tests/option/themeMods.php b/tests/option/themeMods.php
index b062554a2c..379d7887f6 100644
--- a/tests/option/themeMods.php
+++ b/tests/option/themeMods.php
@@ -129,5 +129,4 @@ class Tests_Option_ThemeMods extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/option/updateOption.php b/tests/option/updateOption.php
index 7832a7f8fb..1be8aa0cf8 100644
--- a/tests/option/updateOption.php
+++ b/tests/option/updateOption.php
@@ -28,7 +28,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_yes_for_nonexistent_option_when_autoload_param_is_missing() {
-		global $wpdb;
 		$this->flush_cache();
 		update_option( 'test_update_option_default', 'value' );
 		$this->flush_cache();
@@ -36,9 +35,9 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which includes autoload=yes options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'test_update_option_default' );
-		$after  = $wpdb->num_queries;
+		$after  = get_num_queries();
 
 		$this->assertSame( $before, $after );
 		$this->assertSame( $value, 'value' );
@@ -52,7 +51,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_yes_for_nonexistent_option_when_autoload_param_is_yes() {
-		global $wpdb;
 		$this->flush_cache();
 		update_option( 'test_update_option_default', 'value', 'yes' );
 		$this->flush_cache();
@@ -60,9 +58,9 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which includes autoload=yes options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'test_update_option_default' );
-		$after  = $wpdb->num_queries;
+		$after  = get_num_queries();
 
 		$this->assertSame( $before, $after );
 		$this->assertSame( $value, 'value' );
@@ -76,7 +74,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_no_for_nonexistent_option_when_autoload_param_is_no() {
-		global $wpdb;
 		$this->flush_cache();
 		update_option( 'test_update_option_default', 'value', 'no' );
 		$this->flush_cache();
@@ -84,9 +81,9 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which does not include autoload=no options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'test_update_option_default' );
-		$after  = $wpdb->num_queries;
+		$after  = get_num_queries();
 
 		// Database has been hit.
 		$this->assertSame( $before + 1, $after );
@@ -101,7 +98,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_no_for_nonexistent_option_when_autoload_param_is_false() {
-		global $wpdb;
 		$this->flush_cache();
 		update_option( 'test_update_option_default', 'value', false );
 		$this->flush_cache();
@@ -109,9 +105,9 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which does not include autoload=no options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'test_update_option_default' );
-		$after  = $wpdb->num_queries;
+		$after  = get_num_queries();
 
 		// Database has been hit.
 		$this->assertSame( $before + 1, $after );
@@ -126,7 +122,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_autoload_should_be_updated_for_existing_option_when_value_is_changed() {
-		global $wpdb;
 		add_option( 'foo', 'bar', '', 'no' );
 		$updated = update_option( 'foo', 'bar2', true );
 		$this->assertTrue( $updated );
@@ -136,10 +131,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which includes autoload=yes options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'foo' );
 
-		$this->assertSame( $before, $wpdb->num_queries );
+		$this->assertSame( $before, get_num_queries() );
 		$this->assertSame( $value, 'bar2' );
 	}
 
@@ -151,7 +146,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_autoload_should_not_be_updated_for_existing_option_when_value_is_unchanged() {
-		global $wpdb;
 		add_option( 'foo', 'bar', '', 'yes' );
 		$updated = update_option( 'foo', 'bar', false );
 		$this->assertFalse( $updated );
@@ -161,11 +155,11 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which includes autoload=yes options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'foo' );
 
 		// 'foo' should still be autoload=yes, so we should see no additional querios.
-		$this->assertSame( $before, $wpdb->num_queries );
+		$this->assertSame( $before, get_num_queries() );
 		$this->assertSame( $value, 'bar' );
 	}
 
@@ -177,7 +171,6 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	 * @covers ::get_option
 	 */
 	public function test_autoload_should_not_be_updated_for_existing_option_when_value_is_changed_but_no_value_of_autoload_is_provided() {
-		global $wpdb;
 		add_option( 'foo', 'bar', '', 'yes' );
 
 		// Don't pass a value for `$autoload`.
@@ -189,11 +182,11 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		// Populate the alloptions cache, which includes autoload=yes options.
 		wp_load_alloptions();
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		$value  = get_option( 'foo' );
 
 		// 'foo' should still be autoload=yes, so we should see no additional queries.
-		$this->assertSame( $before, $wpdb->num_queries );
+		$this->assertSame( $before, get_num_queries() );
 		$this->assertSame( $value, 'bar2' );
 	}
 
diff --git a/tests/option/wpLoadAlloptions.php b/tests/option/wpLoadAlloptions.php
index 56533255fb..329dc64e6e 100644
--- a/tests/option/wpLoadAlloptions.php
+++ b/tests/option/wpLoadAlloptions.php
@@ -34,10 +34,9 @@ class Tests_Option_wpLoadAlloptions extends WP_UnitTestCase {
 	 * @covers ::wp_load_alloptions
 	 */
 	public function test_if_alloptions_are_retrieved_from_cache() {
-		global $wpdb;
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		wp_load_alloptions();
-		$after = $wpdb->num_queries;
+		$after = get_num_queries();
 
 		// Database has not been hit.
 		$this->assertSame( $before, $after );
@@ -49,14 +48,12 @@ class Tests_Option_wpLoadAlloptions extends WP_UnitTestCase {
 	 * @covers ::wp_load_alloptions
 	 */
 	public function test_if_alloptions_are_retrieved_from_database() {
-		global $wpdb;
-
 		// Delete the existing cache first.
 		wp_cache_delete( 'alloptions', 'options' );
 
-		$before = $wpdb->num_queries;
+		$before = get_num_queries();
 		wp_load_alloptions();
-		$after = $wpdb->num_queries;
+		$after = get_num_queries();
 
 		// Database has been hit.
 		$this->assertSame( $before + 1, $after );
diff --git a/tests/option/wpSetOptionAutoload.php b/tests/option/wpSetOptionAutoload.php
new file mode 100644
index 0000000000..8736005e32
--- /dev/null
+++ b/tests/option/wpSetOptionAutoload.php
@@ -0,0 +1,114 @@
+<?php
+/**
+ * Test wp_set_option_autoload().
+ *
+ * @group option
+ *
+ * @covers ::wp_set_option_autoload
+ */
+class Tests_Option_WpSetOptionAutoload extends WP_UnitTestCase {
+
+	/**
+	 * Tests that setting an option's autoload value to 'yes' works as expected.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_yes() {
+		global $wpdb;
+
+		$option = 'test_option';
+		$value  = 'value';
+
+		add_option( $option, $value, '', 'no' );
+
+		$this->assertTrue( wp_set_option_autoload( $option, 'yes' ), 'Function did not succeed' );
+		$this->assertSame( 'yes', $wpdb->get_var( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s", $option ) ), 'Option autoload value not updated in database' );
+		$this->assertFalse( wp_cache_get( $option, 'options' ), 'Option not deleted from individual cache' );
+		$this->assertFalse( wp_cache_get( 'alloptions', 'options' ), 'Alloptions cache not cleared' );
+	}
+
+	/**
+	 * Tests that setting an option's autoload value to 'no' works as expected.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_no() {
+		global $wpdb;
+
+		$option = 'test_option';
+		$value  = 'value';
+
+		add_option( $option, $value, '', 'yes' );
+
+		$this->assertTrue( wp_set_option_autoload( $option, 'no' ), 'Function did not succeed' );
+		$this->assertSame( 'no', $wpdb->get_var( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s", $option ) ), 'Option autoload value not updated in database' );
+		$this->assertArrayNotHasKey( $option, wp_cache_get( 'alloptions', 'options' ), 'Option not deleted from alloptions cache' );
+	}
+
+	/**
+	 * Tests that setting an option's autoload value to the same value as prior works as expected.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_same() {
+		global $wpdb;
+
+		$option = 'test_option';
+		$value  = 'value';
+
+		add_option( $option, $value, '', 'yes' );
+
+		$this->assertFalse( wp_set_option_autoload( $option, 'yes' ), 'Function did unexpectedly succeed' );
+		$this->assertSame( 'yes', $wpdb->get_var( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s", $option ) ), 'Option autoload value unexpectedly updated in database' );
+	}
+
+	/**
+	 * Tests that setting a missing option's autoload value does not do anything.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_missing() {
+		global $wpdb;
+
+		$option = 'test_option';
+
+		$this->assertFalse( wp_set_option_autoload( $option, 'yes' ), 'Function did unexpectedly succeed' );
+		$this->assertNull( $wpdb->get_var( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s", $option ) ), 'Missing option autoload value was set in database' );
+		$this->assertArrayNotHasKey( $option, wp_cache_get( 'alloptions', 'options' ), 'Missing option found in alloptions cache' );
+		$this->assertFalse( wp_cache_get( $option, 'options' ), 'Missing option found in individual cache' );
+	}
+
+	/**
+	 * Tests setting an option's autoload value to boolean true.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_true() {
+		global $wpdb;
+
+		$option = 'test_option';
+		$value  = 'value';
+
+		add_option( $option, $value, '', false );
+
+		$this->assertTrue( wp_set_option_autoload( $option, true ), 'Function did not succeed' );
+		$this->assertSame( 'yes', $wpdb->get_var( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s", $option ) ), 'Option autoload value not updated in database' );
+	}
+
+	/**
+	 * Tests setting an option's autoload value to boolean false.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_false() {
+		global $wpdb;
+
+		$option = 'test_option';
+		$value  = 'value';
+
+		add_option( $option, $value, '', true );
+
+		$this->assertTrue( wp_set_option_autoload( $option, false ), 'Function did not succeed' );
+		$this->assertSame( 'no', $wpdb->get_var( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s", $option ) ), 'Option autoload value not updated in database' );
+	}
+}
diff --git a/tests/option/wpSetOptionAutoloadValues.php b/tests/option/wpSetOptionAutoloadValues.php
new file mode 100644
index 0000000000..f474bd1093
--- /dev/null
+++ b/tests/option/wpSetOptionAutoloadValues.php
@@ -0,0 +1,240 @@
+<?php
+/**
+ * Test wp_set_option_autoload_values().
+ *
+ * @group option
+ *
+ * @covers ::wp_set_option_autoload_values
+ */
+class Tests_Option_WpSetOptionAutoloadValues extends WP_UnitTestCase {
+
+	/**
+	 * Tests setting options' autoload to 'yes' where for some options this is already the case.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_all_yes_partial_update() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'yes',
+			'test_option2' => 'yes',
+		);
+		add_option( 'test_option1', 'value1', '', 'yes' );
+		add_option( 'test_option2', 'value2', '', 'no' );
+		$expected = array(
+			'test_option1' => false,
+			'test_option2' => true,
+		);
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries + 2, get_num_queries(), 'Function made unexpected amount of database queries' );
+		$this->assertSame( array( 'yes', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $autoload ) {
+			$this->assertFalse( wp_cache_get( $option, 'options' ), sprintf( 'Option %s not deleted from individual cache', $option ) );
+		}
+		$this->assertFalse( wp_cache_get( 'alloptions', 'options' ), 'Alloptions cache not cleared' );
+	}
+
+	/**
+	 * Tests setting options' autoload to 'no' where for some options this is already the case.
+	 *
+	 * In this case, the 'alloptions' cache should not be cleared, but only its options set to 'no' should be deleted.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_all_no_partial_update() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'no',
+			'test_option2' => 'no',
+		);
+		add_option( 'test_option1', 'value1', '', 'yes' );
+		add_option( 'test_option2', 'value2', '', 'no' );
+		$expected = array(
+			'test_option1' => true,
+			'test_option2' => false,
+		);
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries + 2, get_num_queries(), 'Function made unexpected amount of database queries' );
+		$this->assertSame( array( 'no', 'no' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $autoload ) {
+			$this->assertArrayNotHasKey( $option, wp_cache_get( 'alloptions', 'options' ), sprintf( 'Option %s not deleted from alloptions cache', $option ) );
+		}
+	}
+
+	/**
+	 * Tests setting options' autoload to 'yes' where for all of them this is already the case.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_all_yes_no_update() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'yes',
+			'test_option2' => 'yes',
+		);
+		add_option( 'test_option1', 'value1', '', 'yes' );
+		add_option( 'test_option2', 'value2', '', 'yes' );
+		$expected = array(
+			'test_option1' => false,
+			'test_option2' => false,
+		);
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries + 1, get_num_queries(), 'Function made unexpected amount of database queries' );
+		$this->assertSame( array( 'yes', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $autoload ) {
+			$this->assertArrayHasKey( $option, wp_cache_get( 'alloptions', 'options' ), sprintf( 'Option %s unexpectedly deleted from alloptions cache', $option ) );
+		}
+	}
+
+	/**
+	 * Tests setting options' autoload to either 'yes' or 'no' where for some options this is already the case.
+	 *
+	 * The test also covers one option that is entirely missing.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_mixed_partial_update() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'yes',
+			'test_option2' => 'no',
+			'test_option3' => 'yes',
+			'missing_opt'  => 'yes',
+		);
+		add_option( 'test_option1', 'value1', '', 'no' );
+		add_option( 'test_option2', 'value2', '', 'yes' );
+		add_option( 'test_option3', 'value3', '', 'yes' );
+		$expected = array(
+			'test_option1' => true,
+			'test_option2' => true,
+			'test_option3' => false,
+			'missing_opt'  => false,
+		);
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries + 3, get_num_queries(), 'Function made unexpected amount of database queries' );
+		$this->assertSameSets( array( 'yes', 'no', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $autoload ) {
+			$this->assertFalse( wp_cache_get( $option, 'options' ), sprintf( 'Option %s not deleted from individual cache', $option ) );
+		}
+		$this->assertFalse( wp_cache_get( 'alloptions', 'options' ), 'Alloptions cache not cleared' );
+	}
+
+	/**
+	 * Tests setting options' autoload to either 'yes' or 'no' while only the 'no' options actually need to be updated.
+	 *
+	 * In this case, the 'alloptions' cache should not be cleared, but only its options set to 'no' should be deleted.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_mixed_only_update_no() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'yes',
+			'test_option2' => 'no',
+			'test_option3' => 'yes',
+		);
+		add_option( 'test_option1', 'value1', '', 'yes' );
+		add_option( 'test_option2', 'value2', '', 'yes' );
+		add_option( 'test_option3', 'value3', '', 'yes' );
+		$expected = array(
+			'test_option1' => false,
+			'test_option2' => true,
+			'test_option3' => false,
+		);
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries + 2, get_num_queries(), 'Function made unexpected amount of database queries' );
+		$this->assertSameSets( array( 'yes', 'no', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $autoload ) {
+			if ( 'no' === $autoload ) {
+				$this->assertArrayNotHasKey( $option, wp_cache_get( 'alloptions', 'options' ), sprintf( 'Option %s not deleted from alloptions cache', $option ) );
+			} else {
+				$this->assertArrayHasKey( $option, wp_cache_get( 'alloptions', 'options' ), sprintf( 'Option %s unexpectedly deleted from alloptions cache', $option ) );
+			}
+		}
+	}
+
+	/**
+	 * Tests setting options' autoload with a simulated SQL query failure.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_with_sql_query_failure() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'yes',
+			'test_option2' => 'yes',
+		);
+		add_option( 'test_option1', 'value1', '', 'no' );
+		add_option( 'test_option2', 'value2', '', 'no' );
+
+		// Force UPDATE queries to fail, leading to no autoload values being updated.
+		add_filter(
+			'query',
+			static function ( $query ) {
+				if ( str_starts_with( $query, 'UPDATE ' ) ) {
+					return '';
+				}
+				return $query;
+			}
+		);
+		$expected = array(
+			'test_option1' => false,
+			'test_option2' => false,
+		);
+
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( array( 'no', 'no' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+	}
+
+	/**
+	 * Tests setting options' autoload with boolean values.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_with_bool() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => true,
+			'test_option2' => false,
+		);
+		add_option( 'test_option1', 'value1', '', false );
+		add_option( 'test_option2', 'value2', '', true );
+		$expected = array(
+			'test_option1' => true,
+			'test_option2' => true,
+		);
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_option_autoload_values( $options ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries + 3, get_num_queries(), 'Function made unexpected amount of database queries' );
+		$this->assertSameSets( array( 'yes', 'no' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+	}
+
+	/**
+	 * Tests calling the function with an empty array (i.e. do nothing).
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_option_autoload_values_with_empty_array() {
+		$num_queries = get_num_queries();
+		$this->assertSame( array(), wp_set_option_autoload_values( array() ), 'Function produced unexpected result' );
+		$this->assertSame( $num_queries, get_num_queries(), 'Function made unexpected amount of database queries' );
+	}
+}
diff --git a/tests/option/wpSetOptionsAutoload.php b/tests/option/wpSetOptionsAutoload.php
new file mode 100644
index 0000000000..5202283efa
--- /dev/null
+++ b/tests/option/wpSetOptionsAutoload.php
@@ -0,0 +1,190 @@
+<?php
+/**
+ * Test wp_set_options_autoload().
+ *
+ * @group option
+ *
+ * @covers ::wp_set_options_autoload
+ */
+class Tests_Option_WpSetOptionsAutoload extends WP_UnitTestCase {
+
+	/**
+	 * Tests that setting options' autoload value to 'yes' works as expected.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_yes() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'value1',
+			'test_option2' => 'value2',
+		);
+
+		$expected = array();
+		foreach ( $options as $option => $value ) {
+			add_option( $option, $value, '', 'no' );
+			$expected[ $option ] = true;
+		}
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_options_autoload( array_keys( $options ), 'yes' ), 'Function did not succeed' );
+		$this->assertSame( $num_queries + 2, get_num_queries(), 'Updating options autoload value ran too many queries' );
+		$this->assertSame( array( 'yes', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $value ) {
+			$this->assertFalse( wp_cache_get( $option, 'options' ), sprintf( 'Option %s not deleted from individual cache', $option ) );
+		}
+		$this->assertFalse( wp_cache_get( 'alloptions', 'options' ), 'Alloptions cache not cleared' );
+	}
+
+	/**
+	 * Tests that setting options' autoload value to 'no' works as expected.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_no() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'value1',
+			'test_option2' => 'value2',
+		);
+
+		$expected = array();
+		foreach ( $options as $option => $value ) {
+			add_option( $option, $value, '', 'yes' );
+			$expected[ $option ] = true;
+		}
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_options_autoload( array_keys( $options ), 'no' ), 'Function did not succeed' );
+		$this->assertSame( $num_queries + 2, get_num_queries(), 'Updating options autoload value ran too many queries' );
+		$this->assertSame( array( 'no', 'no' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $value ) {
+			$this->assertArrayNotHasKey( $option, wp_cache_get( 'alloptions', 'options' ), sprintf( 'Option %s not deleted from alloptions cache', $option ) );
+		}
+	}
+
+	/**
+	 * Tests that setting options' autoload value to the same value as prior works as expected.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_same() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'value1',
+			'test_option2' => 'value2',
+		);
+
+		$expected = array();
+		foreach ( $options as $option => $value ) {
+			add_option( $option, $value, '', 'yes' );
+			$expected[ $option ] = false;
+		}
+
+		$num_queries = get_num_queries();
+		$this->assertSame( $expected, wp_set_options_autoload( array_keys( $options ), 'yes' ), 'Function did unexpectedly succeed' );
+		$this->assertSame( $num_queries + 1, get_num_queries(), 'Function attempted to update options autoload value in database' );
+		$this->assertSame( array( 'yes', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Options autoload value unexpectedly updated in database' );
+	}
+
+	/**
+	 * Tests that setting missing option's autoload value does not do anything.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_missing() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1',
+			'test_option2',
+		);
+
+		$expected = array();
+		foreach ( $options as $option ) {
+			$expected[ $option ] = false;
+		}
+
+		$this->assertSame( $expected, wp_set_options_autoload( $options, 'yes' ), 'Function did unexpectedly succeed' );
+		$this->assertSame( array(), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Missing options autoload value was set in database' );
+	}
+
+	/**
+	 * Tests that setting option's autoload value only updates those that need to be updated.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_mixed() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'value1',
+			'test_option2' => 'value2',
+		);
+
+		add_option( 'test_option1', $options['test_option1'], '', 'yes' );
+		add_option( 'test_option2', $options['test_option2'], '', 'no' );
+		$expected = array(
+			'test_option1' => false,
+			'test_option2' => true,
+		);
+
+		$this->assertSame( $expected, wp_set_options_autoload( array_keys( $options ), 'yes' ), 'Function produced unexpected result' );
+		$this->assertSame( array( 'yes', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+		foreach ( $options as $option => $value ) {
+			$this->assertFalse( wp_cache_get( $option, 'options' ), sprintf( 'Option %s not deleted from individual cache', $option ) );
+		}
+		$this->assertFalse( wp_cache_get( 'alloptions', 'options' ), 'Alloptions cache not cleared' );
+	}
+
+	/**
+	 * Tests setting option's autoload value with boolean true.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_true() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'value1',
+			'test_option2' => 'value2',
+		);
+
+		add_option( 'test_option1', $options['test_option1'], '', false );
+		add_option( 'test_option2', $options['test_option2'], '', false );
+		$expected = array(
+			'test_option1' => true,
+			'test_option2' => true,
+		);
+
+		$this->assertSame( $expected, wp_set_options_autoload( array_keys( $options ), true ), 'Function produced unexpected result' );
+		$this->assertSame( array( 'yes', 'yes' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+	}
+
+	/**
+	 * Tests setting option's autoload value with boolean false.
+	 *
+	 * @ticket 58964
+	 */
+	public function test_wp_set_options_autoload_false() {
+		global $wpdb;
+
+		$options = array(
+			'test_option1' => 'value1',
+			'test_option2' => 'value2',
+		);
+
+		add_option( 'test_option1', $options['test_option1'], '', true );
+		add_option( 'test_option2', $options['test_option2'], '', true );
+		$expected = array(
+			'test_option1' => true,
+			'test_option2' => true,
+		);
+
+		$this->assertSame( $expected, wp_set_options_autoload( array_keys( $options ), false ), 'Function produced unexpected result' );
+		$this->assertSame( array( 'no', 'no' ), $wpdb->get_col( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name IN (" . implode( ',', array_fill( 0, count( $options ), '%s' ) ) . ')', ...array_keys( $options ) ) ), 'Option autoload values not updated in database' );
+	}
+}
diff --git a/tests/pluggable/signatures.php b/tests/pluggable/signatures.php
index c63de073d9..81fd079621 100644
--- a/tests/pluggable/signatures.php
+++ b/tests/pluggable/signatures.php
@@ -44,10 +44,9 @@ class Tests_Pluggable_Signatures extends WP_UnitTestCase {
 
 			$this->assertSame( $name, $param_ref->getName(), $msg );
 
-			$i++;
+			++$i;
 
 		}
-
 	}
 
 	/**
@@ -66,7 +65,6 @@ class Tests_Pluggable_Signatures extends WP_UnitTestCase {
 			$this->assertTrue( function_exists( $function ), $msg );
 			$this->assertContains( $function, $defined, $msg );
 		}
-
 	}
 
 	/**
@@ -113,7 +111,6 @@ class Tests_Pluggable_Signatures extends WP_UnitTestCase {
 		}
 
 		return $data;
-
 	}
 
 	/**
diff --git a/tests/pluggable/wpMail.php b/tests/pluggable/wpMail.php
index cc6b3df1a1..f7af48bc06 100644
--- a/tests/pluggable/wpMail.php
+++ b/tests/pluggable/wpMail.php
@@ -538,7 +538,7 @@ class Tests_Pluggable_wpMail extends WP_UnitTestCase {
 	 * Tests that AltBody is reset between each wp_mail call.
 	 */
 	public function test_wp_mail_resets_properties() {
-		$wp_mail_set_text_message = function ( $phpmailer ) {
+		$wp_mail_set_text_message = static function ( $phpmailer ) {
 			$phpmailer->AltBody = 'user1';
 		};
 
diff --git a/tests/pomo/mo.php b/tests/pomo/mo.php
index e4ce6c4b16..7ae73abf6c 100644
--- a/tests/pomo/mo.php
+++ b/tests/pomo/mo.php
@@ -70,7 +70,6 @@ class Tests_POMO_MO extends WP_UnitTestCase {
 		);
 		$this->assertEquals( $single_entry, $mo->entries[ $single_entry->key() ] );
 		$this->assertSame( 'not so dragon', $mo->entries[ $single_entry->key() ]->context );
-
 	}
 
 	public function test_translations_merge() {
diff --git a/tests/pomo/pluralForms.php b/tests/pomo/pluralForms.php
index 0343302c68..b676735c59 100644
--- a/tests/pomo/pluralForms.php
+++ b/tests/pomo/pluralForms.php
@@ -21,7 +21,7 @@ class PluralFormsTest extends WP_UnitTestCase {
 			switch ( $char ) {
 				case '?':
 					$res .= ' ? (';
-					$depth++;
+					++$depth;
 					break;
 				case ':':
 					$res .= ') : (';
@@ -43,7 +43,7 @@ class PluralFormsTest extends WP_UnitTestCase {
 	 * @group external-http
 	 */
 	public function test_regression( $lang, $nplurals, $expression ) {
-		require_once dirname( dirname( __DIR__ ) ) . '/includes/plural-form-function.php';
+		require_once dirname( __DIR__, 2 ) . '/includes/plural-form-function.php';
 
 		$parenthesized = self::parenthesize_plural_expression( $expression );
 		$old_style     = tests_make_plural_form_function( $nplurals, $parenthesized );
diff --git a/tests/pomo/po.php b/tests/pomo/po.php
index 8c58099b69..eeaf0aad14 100644
--- a/tests/pomo/po.php
+++ b/tests/pomo/po.php
@@ -340,4 +340,3 @@ msgstr[2] ""',
 
 	// TODO: Add tests for bad files.
 }
-
diff --git a/tests/post.php b/tests/post.php
index e895dd9e76..548c5eb2ca 100644
--- a/tests/post.php
+++ b/tests/post.php
@@ -236,7 +236,7 @@ class Tests_Post extends WP_UnitTestCase {
 		register_post_status( 'test' );
 
 		$counts = wp_count_posts();
-		$this->assertObjectHasAttribute( 'test', $counts );
+		$this->assertObjectHasProperty( 'test', $counts );
 		$this->assertSame( 0, $counts->test );
 	}
 
diff --git a/tests/post/filtering.php b/tests/post/filtering.php
index c4d393be22..5947a29d43 100644
--- a/tests/post/filtering.php
+++ b/tests/post/filtering.php
@@ -14,7 +14,6 @@ class Tests_Post_Filtering extends WP_UnitTestCase {
 		parent::set_up();
 		update_option( 'use_balanceTags', 1 );
 		kses_init_filters();
-
 	}
 
 	public function tear_down() {
diff --git a/tests/post/getBodyClass.php b/tests/post/getBodyClass.php
index 2872218afb..25810e6075 100644
--- a/tests/post/getBodyClass.php
+++ b/tests/post/getBodyClass.php
@@ -257,5 +257,4 @@ class Tests_Post_GetBodyClass extends WP_UnitTestCase {
 		$this->assertContains( 'page', $class );
 		$this->assertContains( "page-id-{$page_id}", $class );
 	}
-
 }
diff --git a/tests/post/getPageByPath.php b/tests/post/getPageByPath.php
index 7e89a3ffc0..8db0274249 100644
--- a/tests/post/getPageByPath.php
+++ b/tests/post/getPageByPath.php
@@ -260,8 +260,6 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 	 * @ticket 36711
 	 */
 	public function test_should_hit_cache() {
-		global $wpdb;
-
 		$page = self::factory()->post->create(
 			array(
 				'post_type' => 'page',
@@ -273,35 +271,33 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 		$found = get_page_by_path( 'foo' );
 		$this->assertSame( $page, $found->ID );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_page_by_path( 'foo' );
 		$this->assertSame( $page, $found->ID );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 36711
 	 */
 	public function test_bad_path_should_be_cached() {
-		global $wpdb;
-
 		// Prime cache.
 		$found = get_page_by_path( 'foo' );
 		$this->assertNull( $found );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_page_by_path( 'foo' );
 		$this->assertNull( $found );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 36711
 	 */
 	public function test_bad_path_served_from_cache_should_not_fall_back_on_current_post() {
-		global $wpdb, $post;
+		global $post;
 
 		// Fake the global.
 		$post = self::factory()->post->create_and_get();
@@ -310,11 +306,11 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 		$found = get_page_by_path( 'foo' );
 		$this->assertNull( $found );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_page_by_path( 'foo' );
 		$this->assertNull( $found );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		unset( $post );
 	}
@@ -323,8 +319,6 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 	 * @ticket 36711
 	 */
 	public function test_cache_should_not_match_post_in_different_post_type_with_same_path() {
-		global $wpdb;
-
 		register_post_type( 'wptests_pt' );
 
 		$p1 = self::factory()->post->create(
@@ -345,20 +339,18 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 		$found = get_page_by_path( 'foo' );
 		$this->assertSame( $p1, $found->ID );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_page_by_path( 'foo', OBJECT, 'wptests_pt' );
 		$this->assertSame( $p2, $found->ID );
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 36711
 	 */
 	public function test_cache_should_be_invalidated_when_post_name_is_edited() {
-		global $wpdb;
-
 		$page = self::factory()->post->create(
 			array(
 				'post_type' => 'page',
@@ -377,12 +369,12 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_page_by_path( 'bar' );
 		$this->assertSame( $page, $found->ID );
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		++$num_queries;
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/post/getPageByTitle.php b/tests/post/getPageByTitle.php
index a85d8f42c5..084453cbb0 100644
--- a/tests/post/getPageByTitle.php
+++ b/tests/post/getPageByTitle.php
@@ -17,5 +17,4 @@ class Tests_Post_GetPageByTitle extends WP_UnitTestCase {
 	public function test_get_page_by_title_should_be_deprecated() {
 		$this->assertNull( get_page_by_title( '#57041 Page' ) );
 	}
-
 }
diff --git a/tests/post/getPages.php b/tests/post/getPages.php
index 3de294aa22..76735bae86 100644
--- a/tests/post/getPages.php
+++ b/tests/post/getPages.php
@@ -10,8 +10,6 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 	 * @ticket 23167
 	 */
 	public function test_get_pages_cache() {
-		global $wpdb;
-
 		self::factory()->post->create_many( 3, array( 'post_type' => 'page' ) );
 		wp_cache_delete( 'last_changed', 'posts' );
 		$this->assertFalse( wp_cache_get( 'last_changed', 'posts' ) );
@@ -20,7 +18,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$this->assertCount( 3, $pages );
 		$time1 = wp_cache_get( 'last_changed', 'posts' );
 		$this->assertNotEmpty( $time1 );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
@@ -29,7 +27,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$pages = get_pages();
 		$this->assertCount( 3, $pages );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
@@ -39,18 +37,18 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$pages = get_pages( array( 'number' => 2 ) );
 		$this->assertCount( 2, $pages );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Again. num_queries and last_changed should remain the same.
 		$pages = get_pages( array( 'number' => 2 ) );
 		$this->assertCount( 2, $pages );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
@@ -59,7 +57,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$pages = get_pages();
 		$this->assertCount( 3, $pages );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
@@ -68,13 +66,13 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		clean_post_cache( $pages[0]->ID );
 		$this->assertNotEquals( $time1, $time2 = wp_cache_get( 'last_changed', 'posts' ) );
 		get_post( $pages[0]->ID );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// last_changed bumped so num_queries should increment.
 		$pages = get_pages( array( 'number' => 2 ) );
 		$this->assertCount( 2, $pages );
 		$this->assertSame( $time2, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
@@ -87,14 +85,14 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$new_changed_float = $this->_microtime_to_float( wp_cache_get( 'last_changed', 'posts' ) );
 		$this->assertGreaterThan( $old_changed_float, $new_changed_float );
 
-		$num_queries  = $wpdb->num_queries;
+		$num_queries  = get_num_queries();
 		$last_changed = wp_cache_get( 'last_changed', 'posts' );
 
 		// num_queries should bump after wp_delete_post() bumps last_changed.
 		$pages = get_pages();
 		$this->assertCount( 2, $pages );
 		$this->assertSame( $last_changed, wp_cache_get( 'last_changed', 'posts' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
@@ -104,22 +102,20 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 	 * @ticket 43514
 	 */
 	public function test_get_pages_cache_empty() {
-		global $wpdb;
-
 		wp_cache_delete( 'last_changed', 'posts' );
 		$this->assertFalse( wp_cache_get( 'last_changed', 'posts' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$pages = get_pages(); // Database gets queried.
 
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$pages = get_pages(); // Database should not get queried.
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -278,25 +274,21 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		add_post_meta( $posts[1], 'some-meta-key', '' );
 		add_post_meta( $posts[2], 'some-meta-key', '1' );
 
-		$this->assertSame(
+		$this->assertCount(
 			1,
-			count(
-				get_pages(
-					array(
-						'meta_key'   => 'some-meta-key',
-						'meta_value' => '0',
-					)
+			get_pages(
+				array(
+					'meta_key'   => 'some-meta-key',
+					'meta_value' => '0',
 				)
 			)
 		);
-		$this->assertSame(
+		$this->assertCount(
 			1,
-			count(
-				get_pages(
-					array(
-						'meta_key'   => 'some-meta-key',
-						'meta_value' => '1',
-					)
+			get_pages(
+				array(
+					'meta_key'   => 'some-meta-key',
+					'meta_value' => '1',
 				)
 			)
 		);
@@ -329,6 +321,189 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$this->assertSame( $inc, $exc_result );
 	}
 
+	/**
+	 * @ticket 12821
+	 * @covers ::get_pages
+	 */
+	public function test_get_pages_test_filter() {
+		register_post_type( 'wptests_pt', array( 'hierarchical' => true ) );
+
+		$posts              = self::factory()->post->create_many(
+			2,
+			array(
+				'post_type' => 'wptests_pt',
+			)
+		);
+		$query_args_values  = array();
+		$parsed_args_values = array();
+
+		// Filter the query to return the wptests_pt post type.
+		add_filter(
+			'get_pages_query_args',
+			static function ( $query_args, $parsed_args ) use ( &$query_args_values, &$parsed_args_values ) {
+				$query_args['post_type'] = 'wptests_pt';
+				$query_args_values       = $query_args;
+				$parsed_args_values      = $parsed_args;
+				return $query_args;
+			},
+			10,
+			2
+		);
+
+		$pages    = get_pages();
+		$page_ids = wp_list_pluck( $pages, 'ID' );
+		$this->assertSameSets( $posts, $page_ids, 'The return post ids should match the post type wptests_pt.' );
+
+		$query_args = array(
+			'orderby'                => array( 'post_title' => 'ASC' ),
+			'order'                  => 'ASC',
+			'post__not_in'           => array(),
+			'meta_key'               => '',
+			'meta_value'             => '',
+			'posts_per_page'         => -1,
+			'offset'                 => 0,
+			'post_type'              => 'wptests_pt',
+			'post_status'            => array( 'publish' ),
+			'update_post_term_cache' => false,
+			'update_post_meta_cache' => false,
+			'ignore_sticky_posts'    => true,
+			'no_found_rows'          => true,
+		);
+
+		$this->assertSameSets( $query_args, $query_args_values, 'Query arguments should match expected values' );
+
+		$parsed_args = array(
+			'child_of'     => 0,
+			'sort_order'   => 'ASC',
+			'sort_column'  => 'post_title',
+			'hierarchical' => 1,
+			'exclude'      => array(),
+			'include'      => array(),
+			'meta_key'     => '',
+			'meta_value'   => '',
+			'authors'      => '',
+			'parent'       => -1,
+			'exclude_tree' => array(),
+			'number'       => '',
+			'offset'       => 0,
+			'post_type'    => 'page',
+			'post_status'  => 'publish',
+		);
+
+		$this->assertSameSets( $parsed_args, $parsed_args_values, 'Parsed arguments should match expected values' );
+	}
+
+	/**
+	 * @ticket 12821
+	 * @covers ::get_pages
+	 * @dataProvider data_get_pages_args
+	 */
+	public function test_get_pages_args_test_filter( $args, $expected_query_args ) {
+		$filter = new MockAction();
+		add_filter( 'get_pages_query_args', array( $filter, 'filter' ), 10, 2 );
+
+		$results = get_pages( $args );
+
+		$this->assertIsArray( $results, 'get_pages should result an array' );
+
+		$filter_args = $filter->get_args();
+
+		$default_args = array(
+			'orderby'                => array( 'post_title' => 'ASC' ),
+			'order'                  => 'ASC',
+			'post__not_in'           => array(),
+			'meta_key'               => '',
+			'meta_value'             => '',
+			'posts_per_page'         => -1,
+			'offset'                 => 0,
+			'post_type'              => 'page',
+			'post_status'            => array( 'publish' ),
+			'update_post_term_cache' => false,
+			'update_post_meta_cache' => false,
+			'ignore_sticky_posts'    => true,
+			'no_found_rows'          => true,
+		);
+
+		$query_args = wp_parse_args( $expected_query_args, $default_args );
+
+		$this->assertSameSets( $query_args, $filter_args[0][0], 'Unexpected $query_args for get_pages_query_args filter' );
+
+		$defaults = array(
+			'child_of'     => 0,
+			'sort_order'   => 'ASC',
+			'sort_column'  => 'post_title',
+			'hierarchical' => 1,
+			'exclude'      => array(),
+			'include'      => array(),
+			'meta_key'     => '',
+			'meta_value'   => '',
+			'authors'      => '',
+			'parent'       => -1,
+			'exclude_tree' => array(),
+			'number'       => '',
+			'offset'       => 0,
+			'post_type'    => 'page',
+			'post_status'  => 'publish',
+		);
+
+		$parsed_args = wp_parse_args( $args, $defaults );
+		$this->assertSameSets( $parsed_args, $filter_args[0][1], 'Unexpected $parsed_args for get_pages_query_args filter' );
+	}
+
+	public function data_get_pages_args() {
+		return array(
+			'default'            => array(
+				'args'                => array(),
+				'expected_query_args' => array(),
+			),
+			'exclude'            => array(
+				'args'                => array( 'exclude' => array( 1, 2, 4 ) ),
+				'expected_query_args' => array( 'post__not_in' => array( 1, 2, 4 ) ),
+			),
+			'post status'        => array(
+				'args'                => array( 'post_status' => 'draft' ),
+				'expected_query_args' => array( 'post_status' => array( 'draft' ) ),
+			),
+			'number'             => array(
+				'args'                => array( 'number' => 99 ),
+				'expected_query_args' => array( 'posts_per_page' => 99 ),
+			),
+			'meta query'         => array(
+				'args'                => array(
+					'meta_key'   => 'foo',
+					'meta_value' => 'bar',
+				),
+				'expected_query_args' => array(
+					'meta_key'   => 'foo',
+					'meta_value' => 'bar',
+				),
+			),
+			'post parent number' => array(
+				'args'                => array( 'parent' => 5 ),
+				'expected_query_args' => array( 'post_parent' => 5 ),
+			),
+			'post parent array'  => array(
+				'args'                => array( 'parent' => array( 5 ) ),
+				'expected_query_args' => array( 'post_parent__in' => array( 5 ) ),
+			),
+			'offset'             => array(
+				'args'                => array( 'offset' => 2 ),
+				'expected_query_args' => array( 'offset' => 2 ),
+			),
+			'authors'            => array(
+				'args'                => array( 'authors' => 2 ),
+				'expected_query_args' => array( 'author__in' => array( 2 ) ),
+			),
+			'sort order'         => array(
+				'args'                => array( 'sort_order' => 'DESC' ),
+				'expected_query_args' => array(
+					'order'   => 'DESC',
+					'orderby' => array( 'post_title' => 'DESC' ),
+				),
+			),
+		);
+	}
+
 	/**
 	 * @ticket 12821
 	 */
@@ -726,7 +901,6 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		// How it should work.
 		$found_pages = wp_list_filter( $pages, array( 'post_parent' => $page_1 ) );
 		$this->assertSameSets( array( $page_3, $page_5 ), wp_list_pluck( $found_pages, 'ID' ) );
-
 	}
 
 	/**
@@ -1002,4 +1176,35 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 			'Check that ORDER is post date.'
 		);
 	}
+
+	/**
+	 * Tests that the legacy `post_modified_gmt` orderby values are translated to the proper `WP_Query` values.
+	 *
+	 * @ticket 59226
+	 */
+	public function test_get_pages_order_by_post_modified_gmt() {
+		global $wpdb;
+
+		get_pages(
+			array(
+				'sort_column' => 'post_modified_gmt',
+			)
+		);
+		$this->assertStringContainsString(
+			"ORDER BY $wpdb->posts.post_modified ASC",
+			$wpdb->last_query,
+			'Check that ORDER is post modified when using post_modified_gmt.'
+		);
+
+		get_pages(
+			array(
+				'sort_column' => 'modified_gmt',
+			)
+		);
+		$this->assertStringContainsString(
+			"ORDER BY $wpdb->posts.post_modified ASC",
+			$wpdb->last_query,
+			'Check that ORDER is post modified when using modified_gmt.'
+		);
+	}
 }
diff --git a/tests/post/getPostClass.php b/tests/post/getPostClass.php
index faedf73c96..64f60a2636 100644
--- a/tests/post/getPostClass.php
+++ b/tests/post/getPostClass.php
@@ -121,8 +121,6 @@ class Tests_Post_GetPostClass extends WP_UnitTestCase {
 	 * @group cache
 	 */
 	public function test_taxonomy_classes_hit_cache() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		wp_set_post_terms( $this->post_id, array( 'foo', 'bar' ), 'wptests_tax' );
 		wp_set_post_terms( $this->post_id, array( 'footag', 'bartag' ), 'post_tag' );
@@ -131,10 +129,10 @@ class Tests_Post_GetPostClass extends WP_UnitTestCase {
 		update_object_term_cache( $this->post_id, 'post' );
 		update_meta_cache( 'post', $this->post_id );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_post_class( '', $this->post_id );
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 }
diff --git a/tests/post/getPostTypeLabels.php b/tests/post/getPostTypeLabels.php
index 9761e419b0..2a0e7f0d32 100644
--- a/tests/post/getPostTypeLabels.php
+++ b/tests/post/getPostTypeLabels.php
@@ -95,9 +95,9 @@ class Tests_Post_GetPostTypeLabels extends WP_UnitTestCase {
 
 		unregister_post_type( 'foo' );
 
-		$this->assertObjectHasAttribute( 'labels', $post_type_object );
-		$this->assertObjectHasAttribute( 'label', $post_type_object );
-		$this->assertObjectHasAttribute( 'not_found_in_trash', $post_type_object->labels );
+		$this->assertObjectHasProperty( 'labels', $post_type_object );
+		$this->assertObjectHasProperty( 'label', $post_type_object );
+		$this->assertObjectHasProperty( 'not_found_in_trash', $post_type_object->labels );
 	}
 
 	public function test_label_should_be_derived_from_labels_when_registering_a_post_type() {
@@ -122,8 +122,8 @@ class Tests_Post_GetPostTypeLabels extends WP_UnitTestCase {
 		add_filter( 'post_type_labels_foo', array( $this, 'filter_post_type_labels' ) );
 		register_post_type( 'foo' );
 
-		$this->assertObjectHasAttribute( 'featured_image', get_post_type_object( 'foo' )->labels );
-		$this->assertObjectHasAttribute( 'set_featured_image', get_post_type_object( 'foo' )->labels );
+		$this->assertObjectHasProperty( 'featured_image', get_post_type_object( 'foo' )->labels );
+		$this->assertObjectHasProperty( 'set_featured_image', get_post_type_object( 'foo' )->labels );
 
 		unregister_post_type( 'foo' );
 		remove_filter( 'post_type_labels_foo', array( $this, 'filter_post_type_labels' ) );
diff --git a/tests/post/meta.php b/tests/post/meta.php
index 0efca37f6b..84a8558b75 100644
--- a/tests/post/meta.php
+++ b/tests/post/meta.php
@@ -64,7 +64,6 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 		// Check it is deleted.
 		$this->assertSame( '', get_post_meta( self::$post_id, 'unique', true ) );
 		$this->assertSame( array(), get_post_meta( self::$post_id, 'unique', false ) );
-
 	}
 
 	public function test_nonunique_postmeta() {
@@ -128,7 +127,6 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 		$this->assertSame( array( 'new' ), get_post_meta( self::$post_id, 'unique_update', false ) );
 		$this->assertSame( 'new', get_post_meta( self::$post_id, 'nonunique_update', true ) );
 		$this->assertSame( array( 'new', 'another new' ), get_post_meta( self::$post_id, 'nonunique_update', false ) );
-
 	}
 
 	public function test_delete_post_meta() {
@@ -145,7 +143,6 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 
 		// Check the other still exists.
 		$this->assertSame( 'value', get_post_meta( self::$post_id_2, 'unique_delete', true ) );
-
 	}
 
 	public function test_delete_post_meta_by_key() {
@@ -249,7 +246,6 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 
 		// Check it exists.
 		$this->assertEqualSets( $funky_meta, get_post_meta( self::$post_id, 'test_funky_post_meta', true ) );
-
 	}
 
 	/**
diff --git a/tests/post/metaRevisions.php b/tests/post/metaRevisions.php
new file mode 100644
index 0000000000..74442b53c8
--- /dev/null
+++ b/tests/post/metaRevisions.php
@@ -0,0 +1,722 @@
+<?php
+
+/**
+ *
+ * Tests for post meta revisioning.
+ *
+ * @group post
+ * @group revision
+ * @group meta
+ * @group meta-revisions
+ */
+class MetaRevisionTests extends WP_UnitTestCase {
+
+	/**
+	 * Callback function to add the revisioned keys.
+	 *
+	 * @param array $keys The array of revisioned keys.
+	 *
+	 * @return array
+	 */
+	public function add_revisioned_keys( $keys ) {
+		$keys[] = 'meta_revision_test';
+		$keys[] = 'meta_multiples_test';
+		return $keys;
+	}
+
+	/**
+	 * Test the revisions system for storage of meta values with slashes.
+	 *
+	 * @param string $passed   The passed data for testing.
+	 *
+	 * @param string $expected The expected value after storing & retrieving.
+	 *
+	 * @group revision
+	 * @group slashed
+	 * @dataProvider slashed_data_provider
+	 */
+	public function test_revisions_stores_meta_values_with_slashes( $passed, $expected ) {
+		// Set up a new post.
+		$post_id = $this->factory->post->create();
+
+		// And update to store an initial revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some initial content',
+				'ID'           => $post_id,
+			)
+		);
+		add_filter( 'wp_post_revision_meta_keys', array( $this, 'add_revisioned_keys' ) );
+
+		// Store a custom meta value, which is not revisioned by default.
+		update_post_meta( $post_id, 'meta_revision_test', wp_slash( $passed ) );
+		$this->assertEquals( $expected, get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		// Update the post, storing a revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some more content',
+				'ID'           => $post_id,
+			)
+		);
+
+		// Overwrite.
+		update_post_meta( $post_id, 'meta_revision_test', 'original' );
+		// Update the post, storing a revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some more content again',
+				'ID'           => $post_id,
+			)
+		);
+
+		// Restore the previous revision.
+		$revisions = (array) wp_get_post_revisions( $post_id );
+
+		// Go back to load the previous revision.
+		array_shift( $revisions );
+		$last_revision = array_shift( $revisions );
+
+		// Restore!
+		wp_restore_post_revision( $last_revision->ID );
+
+		$this->assertEquals( $expected, get_post_meta( $post_id, 'meta_revision_test', true ) );
+	}
+
+	/**
+	 * Provide data for the slashed data tests.
+	 */
+	public function slashed_data_provider() {
+		return array(
+			array(
+				'some\text',
+				'some\text',
+			),
+			array(
+				'test some\ \\extra \\\slashed \\\\text ',
+				'test some\ \\extra \\\slashed \\\\text ',
+			),
+			array(
+				"This \'is\' an example \n of a \"quoted\" string",
+				"This \'is\' an example \n of a \"quoted\" string",
+			),
+			array(
+				'some unslashed text just to test! % & * ( ) #',
+				'some unslashed text just to test! % & * ( ) #',
+			),
+		);
+	}
+
+	/**
+	 * Test the revisions system for storage of meta values.
+	 *
+	 * @group revision
+	 */
+	public function test_revisions_stores_meta_values() {
+		/*
+		 * Set Up.
+		 */
+
+		// Set up a new post.
+		$post_id          = $this->factory->post->create();
+		$original_post_id = $post_id;
+
+		// And update to store an initial revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some initial content',
+				'ID'           => $post_id,
+			)
+		);
+
+		// One revision so far.
+		$revisions = wp_get_post_revisions( $post_id );
+		$this->assertCount( 1, $revisions );
+
+		/*
+		 * First set up a meta value.
+		 */
+
+		// Store a custom meta value, which is not revisioned by default.
+		update_post_meta( $post_id, 'meta_revision_test', 'original' );
+
+		// Update the post, storing a revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some more content',
+				'ID'           => $post_id,
+			)
+		);
+
+		$revisions = wp_get_post_revisions( $post_id );
+		$this->assertCount( 2, $revisions );
+
+		// Next, store some updated meta values for the same key.
+		update_post_meta( $post_id, 'meta_revision_test', 'update1' );
+
+		// Save the post, changing content to force a revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some updated content',
+				'ID'           => $post_id,
+			)
+		);
+
+		$revisions = wp_get_post_revisions( $post_id );
+		$this->assertCount( 3, $revisions );
+
+		/*
+		 * Now restore the original revision.
+		 */
+
+		// Restore the previous revision.
+		$revisions = (array) wp_get_post_revisions( $post_id );
+
+		// Go back two to load the previous revision.
+		array_shift( $revisions );
+		$last_revision = array_shift( $revisions );
+
+		// Restore!
+		wp_restore_post_revision( $last_revision->ID );
+
+		wp_update_post( array( 'ID' => $post_id ) );
+		$revisions = wp_get_post_revisions( $post_id );
+		$this->assertCount( 4, $revisions );
+
+		/*
+		 * Check the meta values to verify they are NOT revisioned - they are not revisioned by default.
+		 */
+
+		// Custom post meta should NOT be restored, orignal value should not be restored, value still 'update1'.
+		$this->assertEquals( 'update1', get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		update_post_meta( $post_id, 'meta_revision_test', 'update2' );
+
+		/*
+		 * Test the revisioning of custom meta when enabled by the wp_post_revision_meta_keys filter.
+		 */
+
+		// Add the custom field to be revised via the wp_post_revision_meta_keys filter.
+		add_filter( 'wp_post_revision_meta_keys', array( $this, 'add_revisioned_keys' ) );
+
+		// Save the post, changing content to force a revision.
+		wp_update_post(
+			array(
+				'post_content' => 'more updated content',
+				'ID'           => $post_id,
+			)
+		);
+
+		$revisions = array_values( wp_get_post_revisions( $post_id ) );
+		$this->assertCount( 5, $revisions );
+		$this->assertEquals( 'update2', get_post_meta( $revisions[0]->ID, 'meta_revision_test', true ) );
+
+		// Store custom meta values, which should now be revisioned.
+		update_post_meta( $post_id, 'meta_revision_test', 'update3' );
+
+		/*
+		 * Save the post again, custom meta should now be revisioned.
+		 *
+		 * Note that a revision is saved even though there is no change
+		 * in post content, because the revisioned post_meta has changed.
+		 */
+		wp_update_post(
+			array(
+				'ID' => $post_id,
+			)
+		);
+
+		// This revision contains the existing post meta ('update3').
+		$revisions = wp_get_post_revisions( $post_id );
+		$this->assertCount( 6, $revisions );
+
+		// Verify that previous post meta is set.
+		$this->assertEquals( 'update3', get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		// Restore the previous revision.
+		$revisions = wp_get_post_revisions( $post_id );
+
+		// Go back two to load the previous revision.
+		array_shift( $revisions );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+
+		/*
+		 * Verify that previous post meta is restored.
+		 */
+		$this->assertEquals( 'update2', get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		// Try storing a blank meta.
+		update_post_meta( $post_id, 'meta_revision_test', '' );
+		wp_update_post(
+			array(
+				'ID' => $post_id,
+			)
+		);
+
+		update_post_meta( $post_id, 'meta_revision_test', 'update 4' );
+		wp_update_post(
+			array(
+				'ID' => $post_id,
+			)
+		);
+
+		// Restore the previous revision.
+		$revisions = wp_get_post_revisions( $post_id );
+		array_shift( $revisions );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+
+		/*
+		 * Verify that previous blank post meta is restored.
+		 */
+		$this->assertEquals( '', get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		/*
+		 * Test not tracking a key - remove the key from the revisioned meta.
+		 */
+		remove_all_filters( 'wp_post_revision_meta_keys' );
+
+		// Meta should no longer be revisioned.
+		update_post_meta( $post_id, 'meta_revision_test', 'update 5' );
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_content' => 'changed content',
+			)
+		);
+		update_post_meta( $post_id, 'meta_revision_test', 'update 6' );
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_content' => 'go updated content',
+			)
+		);
+
+		// Restore the previous revision.
+		$revisions = wp_get_post_revisions( $post_id );
+		array_shift( $revisions );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+
+		/*
+		 * Verify that previous post meta is NOT restored.
+		 */
+		$this->assertEquals( 'update 6', get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		// Add the custom field to be revised via the wp_post_revision_meta_keys filter.
+		add_filter( 'wp_post_revision_meta_keys', array( $this, 'add_revisioned_keys' ) );
+
+		/*
+		 * Test the revisioning of multiple meta keys.
+		 */
+
+		// Add three values for meta.
+		update_post_meta( $post_id, 'meta_revision_test', 'update 7' );
+		add_post_meta( $post_id, 'meta_revision_test', 'update 7 number 2' );
+		add_post_meta( $post_id, 'meta_revision_test', 'update 7 number 3' );
+		wp_update_post( array( 'ID' => $post_id ) );
+
+		// Update all three values.
+		update_post_meta( $post_id, 'meta_revision_test', 'update 8', 'update 7' );
+		update_post_meta( $post_id, 'meta_revision_test', 'update 8 number 2', 'update 7 number 2' );
+		update_post_meta( $post_id, 'meta_revision_test', 'update 8 number 3', 'update 7 number 3' );
+
+		// Restore the previous revision.
+		$revisions     = wp_get_post_revisions( $post_id );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+
+		/*
+		 * Verify that multiple metas stored correctly.
+		 */
+		$this->assertEquals( array( 'update 7', 'update 7 number 2', 'update 7 number 3' ), get_post_meta( $post_id, 'meta_revision_test' ) );
+
+		/*
+		 * Test the revisioning of a multidimensional array.
+		 */
+		$test_array = array(
+			'a' => array(
+				'1',
+				'2',
+				'3',
+			),
+			'b' => 'ok',
+			'c' => array(
+				'multi' => array(
+					'a',
+					'b',
+					'c',
+				),
+				'not'   => 'ok',
+			),
+		);
+
+		// Clear any old value.
+		delete_post_meta( $post_id, 'meta_revision_test' );
+
+		// Set the test meta to the array.
+		update_post_meta( $post_id, 'meta_revision_test', $test_array );
+
+		// Update to save.
+		wp_update_post( array( 'ID' => $post_id ) );
+
+		// Set the test meta blank.
+		update_post_meta( $post_id, 'meta_revision_test', '' );
+
+		// Restore the previous revision.
+		$revisions     = wp_get_post_revisions( $post_id );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+
+		/*
+		 * Verify  multidimensional array stored correctly.
+		 */
+		$stored_array = get_post_meta( $post_id, 'meta_revision_test' );
+		$this->assertEquals( $test_array, $stored_array[0] );
+		/*
+
+		 * Test multiple revisions on the same key.
+		 */
+
+		// Set the test meta to the array.
+		add_post_meta( $post_id, 'meta_multiples_test', 'test1' );
+		add_post_meta( $post_id, 'meta_multiples_test', 'test2' );
+		add_post_meta( $post_id, 'meta_multiples_test', 'test3' );
+
+		// Update to save.
+		wp_update_post( array( 'ID' => $post_id ) );
+
+		$stored_array = get_post_meta( $post_id, 'meta_multiples_test' );
+		$expect       = array( 'test1', 'test2', 'test3' );
+
+		$this->assertEquals( $expect, $stored_array );
+
+		// Restore the previous revision.
+		$revisions     = wp_get_post_revisions( $post_id );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+
+		$stored_array = get_post_meta( $post_id, 'meta_multiples_test' );
+		$expect       = array( 'test1', 'test2', 'test3' );
+
+		$this->assertEquals( $expect, $stored_array );
+
+		// Cleanup!
+		wp_delete_post( $original_post_id );
+	}
+
+	/**
+	 * Verify that only existing meta is revisioned.
+	 */
+	public function only_existing_meta_is_revisioned() {
+		add_filter( 'wp_post_revision_meta_keys', array( $this, 'add_revisioned_keys' ) );
+
+		// Set up a new post.
+		$post_id = $this->factory->post->create(
+			array(
+				'post_content' => 'initial content',
+			)
+		);
+
+		// Revision v1.
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_content' => 'updated content v1',
+			)
+		);
+
+		$this->assertPostNotHasMetaKey( $post_id, 'foo' );
+		$this->assertPostNotHasMetaKey( $post_id, 'bar' );
+
+		$revisions = wp_get_post_revisions( $post_id );
+		$revision  = array_shift( $revisions );
+		$this->assertEmpty( get_metadata( 'post', $revision->ID ) );
+
+		// Revision v2.
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_content' => 'updated content v2',
+				'meta_input'   => array(
+					'foo' => 'foo v2',
+				),
+			)
+		);
+
+		$this->assertPostHasMetaKey( $post_id, 'foo' );
+		$this->assertPostNotHasMetaKey( $post_id, 'bar' );
+		$this->assertPostNotHasMetaKey( $post_id, 'meta_revision_test' );
+
+		$revisions = wp_get_post_revisions( $post_id );
+		$revision  = array_shift( $revisions );
+		$this->assertPostHasMetaKey( $revision->ID, 'foo' );
+		$this->assertPostNotHasMetaKey( $revision->ID, 'bar' );
+		$this->assertPostNotHasMetaKey( $revision->ID, 'meta_revision_test' );
+	}
+
+	/**
+	 * Verify that blank strings are revisioned correctly.
+	 */
+	public function blank_meta_is_revisioned() {
+
+		add_filter( 'wp_post_revision_meta_keys', array( $this, 'add_revisioned_keys' ) );
+
+		// Set up a new post.
+		$post_id = $this->factory->post->create(
+			array(
+				'post_content' => 'initial content',
+				'meta_input'   => array(
+					'foo' => 'foo',
+				),
+			)
+		);
+
+		// Set the test meta to an empty string.
+		update_post_meta( $post_id, 'foo', '' );
+
+		// Update to save.
+		wp_update_post( array( 'ID' => $post_id ) );
+
+		$stored_array = get_post_meta( $post_id, 'meta_multiples_test' );
+		$expect       = array( 'test1', 'test2', 'test3' );
+
+		$this->assertEquals( $expect, $stored_array );
+
+		// Restore the previous revision.
+		$revisions     = wp_get_post_revisions( $post_id );
+		$last_revision = array_shift( $revisions );
+		wp_restore_post_revision( $last_revision->ID );
+		$stored_data = get_post_meta( $post_id, 'foo' );
+		$this->assertEquals( '', $stored_data[0] );
+	}
+
+	/**
+	 * Test revisioning of meta with a default value.
+	 */
+	public function test_revisionining_of_meta_with_default_value() {
+
+		// Add a meta field to revision that includes a default value.
+		register_post_meta(
+			'post',
+			'meta_revision_test',
+			array(
+				'single'            => true,
+				'default'           => 'default value',
+				'revisions_enabled' => true,
+			)
+		);
+
+		// Set up a new post.
+		$post_id = $this->factory->post->create(
+			array(
+				'post_content' => 'initial content',
+				'meta_input'   => array(
+					'meta_revision_test' => 'foo',
+				),
+			)
+		);
+
+		// Set the test meta to an empty string.
+		update_post_meta( $post_id, 'meta_revision_test', '' );
+
+		// Update to save.
+		wp_update_post( array( 'ID' => $post_id ) );
+
+		// Check that the meta is blank.
+		$stored_data = get_post_meta( $post_id, 'meta_revision_test', true );
+		$this->assertEquals( '', $stored_data );
+
+		// Also verify that the latest revision has blank stored for the meta.
+		$revisions     = wp_get_post_revisions( $post_id );
+		$last_revision = array_shift( $revisions );
+		$stored_data   = get_post_meta( $last_revision->ID, 'meta_revision_test', true );
+		$this->assertEquals( '', $stored_data );
+
+		// Delete the meta.
+		delete_post_meta( $post_id, 'meta_revision_test' );
+
+		// Update to save.
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_content' => 'content update 1',
+			)
+		);
+
+		// Check that the default meta value is returned.
+		$this->assertEquals( 'default value', get_post_meta( $post_id, 'meta_revision_test', true ) );
+
+		// Also verify that the latest revision has the default value returned for the meta.
+		$revisions     = wp_get_post_revisions( $post_id );
+		$last_revision = array_shift( $revisions );
+
+		// No ,eta data should be stored in the revision.
+		$this->assertEquals( array(), get_post_meta( $last_revision->ID ) );
+
+		// Set the test meta again.
+		update_post_meta( $post_id, 'meta_revision_test', 'test' );
+
+		// Update to save.
+		wp_update_post( array( 'ID' => $post_id ) );
+
+		// Now restore the previous revision.
+		wp_restore_post_revision( $last_revision->ID );
+
+		// Verify the default meta value is still returned.
+		$this->assertEquals( 'default value', get_post_meta( $post_id, 'meta_revision_test', true ) );
+	}
+
+	/**
+	 * @dataProvider data_register_post_meta_supports_revisions
+	 */
+	public function test_register_post_meta_supports_revisions( $post_type, $meta_key, $args, $expected_is_revisioned ) {
+		register_post_meta( $post_type, $meta_key, $args );
+
+		// Set up a new post.
+		$post_id = $this->factory->post->create(
+			array(
+				'post_content' => 'initial content',
+				'post_type'    => $post_type,
+				'meta_input'   => array(
+					$meta_key => 'foo',
+				),
+			)
+		);
+
+		// Update the post meta and post to save.
+		update_post_meta( $post_id, $meta_key, 'bar' );
+		wp_update_post(
+			array(
+				'ID'         => $post_id,
+				'post_title' => 'updated title',
+			)
+		);
+
+		// Check the last revision for the post to see if the meta key was revisioned
+		$revisions       = wp_get_post_revisions( $post_id );
+		$revision        = array_shift( $revisions );
+		$revisioned_meta = get_post_meta( $revision->ID, $meta_key, true );
+		$this->assertEquals( $expected_is_revisioned, 'bar' === $revisioned_meta );
+
+		// Reset global so subsequent data tests do not get polluted.
+		$GLOBALS['wp_meta_keys'] = array();
+	}
+
+	public function data_register_post_meta_supports_revisions() {
+		return array(
+			array( 'post', 'registered_key1', array( 'single' => true ), false ),
+			array(
+				'post',
+				'registered_key1',
+				array(
+					'single'            => true,
+					'revisions_enabled' => true,
+				),
+				true,
+			),
+			array( 'page', 'registered_key2', array( 'revisions_enabled' => false ), false ),
+			array( 'page', 'registered_key2', array( 'revisions_enabled' => true ), true ),
+			array( '', 'registered_key3', array( 'revisions_enabled' => false ), false ),
+			array( '', 'registered_key3', array( 'revisions_enabled' => true ), true ),
+		);
+	}
+
+	/**
+	 * Assert the a post has a meta key.
+	 *
+	 * @param int    $post_id        The ID of the post to check.
+	 * @param string $meta_key The meta key to check for.
+	 */
+	protected function assertPostHasMetaKey( $post_id, $meta_key ) {
+		$this->assertArrayHasKey( $meta_key, get_metadata( 'post', $post_id ) );
+	}
+
+	/**
+	 * Assert that post does not have a meta key.
+	 *
+	 * @param int    $post_id        The ID of the post to check.
+	 * @param string $meta_key The meta key to check for.
+	 */
+	protected function assertPostNotHasMetaKey( $post_id, $meta_key ) {
+		$this->assertArrayNotHasKey( $meta_key, get_metadata( 'post', $post_id ) );
+	}
+
+	/**
+	 * Test post meta revisioning with a custom post type, as well as the "page" post type.
+	 *
+	 * @dataProvider page_post_type_data_provider
+	 */
+	public function test_revisions_stores_meta_values_page_and_cpt( $passed, $expected, $post_type, $supports_revisions = false ) {
+
+		// If the post type doesn't exist, create it, potentially supporting revisions.
+		if ( ! post_type_exists( $post_type ) ) {
+			register_post_type(
+				$post_type,
+				array(
+					'public'   => true,
+					'supports' => $supports_revisions ? array( 'revisions' ) : array(),
+				)
+			);
+		}
+
+		// Create a test post.
+		$page_id = $this->factory->post->create(
+			array(
+				'post_type'    => $post_type,
+				'post_content' => 'some initial content',
+			)
+		);
+
+		// Add the revisioning filter.
+		add_filter( 'wp_post_revision_meta_keys', array( $this, 'add_revisioned_keys' ) );
+
+		// Test revisioning.
+		update_post_meta( $page_id, 'meta_revision_test', wp_slash( $passed ) );
+
+		// Update the post, storing a revision.
+		wp_update_post(
+			array(
+				'post_content' => 'some more content',
+				'ID'           => $page_id,
+			)
+		);
+
+		// Retrieve the created revision.
+		$revisions = (array) wp_get_post_revisions( $page_id );
+
+		if ( $expected ) {
+			// Go back to load the previous revision.
+			$last_revision = array_shift( $revisions );
+				wp_restore_post_revision( $last_revision->ID );
+			$this->assertEquals( $expected, get_post_meta( $page_id, 'meta_revision_test', true ) );
+		} else {
+			$this->assertEmpty( $revisions );
+		}
+	}
+
+	/**
+	 * Provide data for the page post type tests.
+	 */
+	public function page_post_type_data_provider() {
+		return array(
+			array(
+				'Test string',
+				'Test string',
+				'page',
+			),
+			array(
+				'Test string',
+				false,
+				'custom_type',
+			),
+			array(
+				'Test string',
+				'Test string',
+				'custom_type',
+				true,
+			),
+		);
+	}
+}
diff --git a/tests/post/nav-menu.php b/tests/post/nav-menu.php
index 918b76e8e1..625d1bc12c 100644
--- a/tests/post/nav-menu.php
+++ b/tests/post/nav-menu.php
@@ -57,7 +57,6 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		// After falling back, the markup should not include whitespace around <li>'s.
 		$this->assertDoesNotMatchRegularExpression( '/\s<li.*>|<\/li>\s/U', $menu );
 		$this->assertMatchesRegularExpression( '/><li.*>|<\/li></U', $menu );
-
 	}
 
 	/**
@@ -215,7 +214,6 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		$custom_item = wp_filter_object_list( $menu_items, array( 'db_id' => $custom_item_id ) );
 		$custom_item = array_pop( $custom_item );
 		$this->assertSame( 'WordPress.org', $custom_item->title );
-
 	}
 
 	public function test_wp_get_nav_menu_items_with_taxonomy_term() {
@@ -304,6 +302,7 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		add_filter( 'update_term_metadata_cache', array( $action, 'filter' ), 10, 2 );
 
 		update_menu_item_cache( $query_result );
+		get_term_meta( $term_id );
 
 		$args = $action->get_args();
 		$last = end( $args );
@@ -341,13 +340,13 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		add_filter( 'update_post_metadata_cache', array( $action, 'filter' ), 10, 2 );
 
 		$start_num_queries = get_num_queries();
-		wp_get_nav_menu_items( $this->menu_id );
+		wp_get_nav_menu_items( $this->menu_id, array( 'nopaging' => false ) );
 		$queries_made = get_num_queries() - $start_num_queries;
-		$this->assertSame( 6, $queries_made, 'Only does 6 database queries when running wp_get_nav_menu_items.' );
+		$this->assertSame( 7, $queries_made, 'Only does 7 database queries when running wp_get_nav_menu_items.' );
 
 		$args = $action->get_args();
 		$this->assertSameSets( $menu_nav_ids, $args[0][1], '_prime_post_caches() was not executed.' );
-		$this->assertSameSets( $post_ids, $args[1][1], '_prime_post_caches() was not executed.' );
+		$this->assertSameSets( $post_ids, $args[2][1], '_prime_post_caches() was not executed.' );
 	}
 
 	/**
@@ -382,13 +381,15 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		add_filter( 'update_post_metadata_cache', array( $action_posts, 'filter' ), 10, 2 );
 
 		$start_num_queries = get_num_queries();
-		wp_get_nav_menu_items( $this->menu_id );
+		wp_get_nav_menu_items( $this->menu_id, array( 'nopaging' => false ) );
+		get_term_meta( $term_ids[0] );
 		$queries_made = get_num_queries() - $start_num_queries;
-		$this->assertSame( 6, $queries_made, 'Only does 6 database queries when running wp_get_nav_menu_items.' );
+		$this->assertSame( 7, $queries_made, 'Only does 7 database queries when running wp_get_nav_menu_items.' );
 
-		$args = $action_terms->get_args();
-		$last = end( $args );
-		$this->assertSameSets( $term_ids, $last[1], '_prime_term_caches() was not executed.' );
+		$args       = $action_terms->get_args();
+		$first      = reset( $args );
+		$term_ids[] = $this->menu_id;
+		$this->assertSameSets( $term_ids, $first[1], '_prime_term_caches() was not executed.' );
 
 		$args = $action_posts->get_args();
 		$this->assertSameSets( $menu_nav_ids, $args[0][1], '_prime_post_caches() was not executed.' );
@@ -588,6 +589,30 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		$this->assertTrue( ! _is_valid_nav_menu_item( $menu_item ) );
 	}
 
+	/**
+	 * @ticket 56577
+	 */
+	public function test_wp_setup_nav_menu_item_short_circuit_filter() {
+		$post_id = self::factory()->post->create();
+
+		$menu_item_id = wp_update_nav_menu_item(
+			$this->menu_id,
+			0,
+			array(
+				'menu-item-type'      => 'post_type',
+				'menu-item-object'    => 'post',
+				'menu-item-object-id' => $post_id,
+				'menu-item-status'    => 'publish',
+			)
+		);
+
+		add_filter( 'pre_wp_setup_nav_menu_item', '__return_empty_string' );
+
+		$custom_item = wp_setup_nav_menu_item( get_post( $menu_item_id ) );
+
+		$this->assertSame( '', $custom_item );
+	}
+
 	/**
 	 * @ticket 35206
 	 */
@@ -736,7 +761,6 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		remove_filter( 'nav_menu_item_title', array( $this, 'confirm_third_param_args_object' ), 10, 3 );
 
 		remove_filter( 'walker_nav_menu_start_el', array( $this, 'confirm_forth_param_args_object' ), 10, 4 );
-
 	}
 
 	/**
@@ -1213,7 +1237,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-status'    => 'publish',
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1227,7 +1252,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date-gmt' => $post_date_gmt,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertSame( get_date_from_gmt( $post_date_gmt ), $post->post_date );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1241,7 +1267,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date-gmt' => $invalid_date,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertSame( '1970-01-01 00:00:00', $post->post_date );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1255,7 +1282,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date' => $post_date,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertSame( $post_date, $post->post_date );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1270,7 +1298,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date-gmt' => $post_date_gmt,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertSame( $post_date, $post->post_date );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1285,7 +1314,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date-gmt' => $invalid_date,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertSame( $post_date, $post->post_date );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1299,7 +1329,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date' => $invalid_date,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1314,7 +1345,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date-gmt' => $post_date_gmt,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
 
 		$menu_item_id = wp_update_nav_menu_item(
@@ -1329,7 +1361,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 				'menu-item-post-date-gmt' => $invalid_date,
 			)
 		);
-		$post         = get_post( $menu_item_id );
+
+		$post = get_post( $menu_item_id );
 		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
 	}
 }
diff --git a/tests/post/query.php b/tests/post/query.php
index f67078117c..9c118cbb9e 100644
--- a/tests/post/query.php
+++ b/tests/post/query.php
@@ -555,11 +555,9 @@ class Tests_Post_Query extends WP_UnitTestCase {
 	 * @ticket 36687
 	 */
 	public function test_posts_pre_query_filter_should_bypass_database_query() {
-		global $wpdb;
-
 		add_filter( 'posts_pre_query', array( __CLASS__, 'filter_posts_pre_query' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$q           = new WP_Query(
 			array(
 				'fields'        => 'ids',
@@ -569,7 +567,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 
 		remove_filter( 'posts_pre_query', array( __CLASS__, 'filter_posts_pre_query' ) );
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSame( array( 12345 ), $q->posts );
 	}
 
@@ -777,4 +775,21 @@ class Tests_Post_Query extends WP_UnitTestCase {
 
 		$this->assertIsInt( $q->found_posts );
 	}
+
+	/**
+	 * @ticket 57296
+	 * @covers WP_Query::get_posts
+	 */
+	public function test_split_the_query_object_cache() {
+		$filter = new MockAction();
+		add_filter( 'split_the_query', array( $filter, 'filter' ) );
+
+		$q = new WP_Query(
+			array(
+				'posts_per_page' => 501,
+			)
+		);
+
+		$this->assertSame( (bool) wp_using_ext_object_cache(), $filter->get_args()[0][0] );
+	}
 }
diff --git a/tests/post/revisions.php b/tests/post/revisions.php
index cc17ccd60d..a4e45aefcf 100644
--- a/tests/post/revisions.php
+++ b/tests/post/revisions.php
@@ -736,7 +736,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 					)
 				);
 
-				$latest_revision_id++;
+				++$latest_revision_id;
 			}
 		}
 
@@ -784,7 +784,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 					)
 				);
 
-				$latest_revision_id++;
+				++$latest_revision_id;
 			}
 		}
 
@@ -883,7 +883,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 
 		add_filter(
 			'wp_revisions_to_keep',
-			static function() {
+			static function () {
 				return 1;
 			}
 		);
diff --git a/tests/post/thumbnails.php b/tests/post/thumbnails.php
index 73199e4b4e..b06ec02570 100644
--- a/tests/post/thumbnails.php
+++ b/tests/post/thumbnails.php
@@ -450,6 +450,135 @@ class Tests_Post_Thumbnail_Template extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Tests that `_wp_post_thumbnail_context_filter()` returns 'the_post_thumbnail'.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers::_wp_post_thumbnail_context_filter
+	 */
+	public function test_wp_post_thumbnail_context_filter_should_return_the_post_thumbnail() {
+		$this->assertSame( 'the_post_thumbnail', _wp_post_thumbnail_context_filter( 'wp_get_attachment_image' ) );
+	}
+
+	/**
+	 * Tests that `::_wp_post_thumbnail_context_filter_add` adds a filter to override the context
+	 * used in `wp_get_attachment_image()`.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers ::_wp_post_thumbnail_context_filter_add
+	 */
+	public function test_wp_post_thumbnail_context_filter_add_should_add_the_filter() {
+		$last_context = '';
+		$this->track_last_attachment_image_context( $last_context );
+
+		_wp_post_thumbnail_context_filter_add();
+		wp_get_attachment_image( self::$attachment_id );
+
+		$this->assertSame( 'the_post_thumbnail', $last_context );
+	}
+
+	/**
+	 * Tests that `_wp_post_thumbnail_context_filter_remove()` removes a filter to override the context
+	 * used in `wp_get_attachment_image()`.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers ::_wp_post_thumbnail_context_filter_remove
+	 */
+	public function test_wp_post_thumbnail_context_filter_remove_should_remove_the_filter() {
+		$last_context = '';
+		$this->track_last_attachment_image_context( $last_context );
+
+		_wp_post_thumbnail_context_filter_add();
+		wp_get_attachment_image( self::$attachment_id );
+
+		// Verify that the filter has been added before testing that it has been removed.
+		$this->assertSame(
+			'the_post_thumbnail',
+			$last_context,
+			'The filter was not added.'
+		);
+
+		_wp_post_thumbnail_context_filter_remove();
+
+		// The context should no longer be modified by the filter.
+		wp_get_attachment_image( self::$attachment_id );
+
+		$this->assertSame(
+			'wp_get_attachment_image',
+			$last_context,
+			'The filter was not removed.'
+		);
+	}
+
+	/**
+	 * Tests that `get_the_post_thumbnail()` uses the 'the_post_thumbnail' context.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers ::get_the_post_thumbnail
+	 */
+	public function test_get_the_post_thumbnail_should_use_the_post_thumbnail_context() {
+		$last_context = '';
+		$this->track_last_attachment_image_context( $last_context );
+
+		set_post_thumbnail( self::$post, self::$attachment_id );
+		get_the_post_thumbnail( self::$post );
+
+		$this->assertSame( 'the_post_thumbnail', $last_context );
+	}
+
+	/**
+	 * Tests that `get_the_post_thumbnail()` restores the context afterwards.
+	 *
+	 * @ticket 58212
+	 *
+	 * @covers ::get_the_post_thumbnail
+	 */
+	public function test_get_the_post_thumbnail_should_remove_the_post_thumbnail_context_afterwards() {
+		$last_context = '';
+		$this->track_last_attachment_image_context( $last_context );
+
+		set_post_thumbnail( self::$post, self::$attachment_id );
+		get_the_post_thumbnail( self::$post );
+
+		// Verify that the context was overridden before testing that it has been restored.
+		$this->assertSame(
+			'the_post_thumbnail',
+			$last_context,
+			'The context was not overridden.'
+		);
+
+		// The context should no longer be overridden.
+		wp_get_attachment_image( self::$attachment_id );
+
+		$this->assertSame(
+			'wp_get_attachment_image',
+			$last_context,
+			'The context was not restored.'
+		);
+	}
+
+	/**
+	 * Helper method to keep track of the last context returned by the 'wp_get_attachment_image_context' filter.
+	 *
+	 * The method parameter is passed by reference and therefore will always contain the last context value.
+	 *
+	 * @param mixed $last_context Variable to track last context. Passed by reference.
+	 */
+	private function track_last_attachment_image_context( &$last_context ) {
+		add_filter(
+			'wp_get_attachment_image_context',
+			static function ( $context ) use ( &$last_context ) {
+				$last_context = $context;
+				return $context;
+			},
+			11
+		);
+	}
+
 	public function filter_post_thumbnail_size( $size, $post_id ) {
 		if ( is_array( $this->current_size_filter_data ) && isset( $this->current_size_filter_data[ $post_id ] ) ) {
 			return $this->current_size_filter_data[ $post_id ];
diff --git a/tests/post/updatePostCache.php b/tests/post/updatePostCache.php
index cfb279b67c..9427ec6fbd 100644
--- a/tests/post/updatePostCache.php
+++ b/tests/post/updatePostCache.php
@@ -57,7 +57,7 @@ class Tests_Post_UpdatePostCache extends WP_UnitTestCase {
 			'The cached post is not an object'
 		);
 
-		$this->assertObjectHasAttribute(
+		$this->assertObjectHasProperty(
 			'filter',
 			$cached_post,
 			'The cached post does not have a "filter" property'
@@ -98,7 +98,7 @@ class Tests_Post_UpdatePostCache extends WP_UnitTestCase {
 			'The cached post is not an object'
 		);
 
-		$this->assertObjectHasAttribute(
+		$this->assertObjectHasProperty(
 			'filter',
 			$cached_post,
 			'The cached post does not have a "filter" property'
@@ -126,7 +126,7 @@ class Tests_Post_UpdatePostCache extends WP_UnitTestCase {
 			'The cached post is not an object'
 		);
 
-		$this->assertObjectHasAttribute(
+		$this->assertObjectHasProperty(
 			'filter',
 			$cached_post,
 			'The cached post does not have a "filter" property'
diff --git a/tests/post/walkerPage.php b/tests/post/walkerPage.php
index a5a632dcda..d8a2312a54 100644
--- a/tests/post/walkerPage.php
+++ b/tests/post/walkerPage.php
@@ -33,7 +33,7 @@ class Tests_Post_Walker_Page extends WP_UnitTestCase {
 
 		add_filter(
 			'page_menu_link_attributes',
-			static function( $atts ) use ( $value ) {
+			static function ( $atts ) use ( $value ) {
 				$atts['data-test'] = $value;
 				return $atts;
 			}
diff --git a/tests/post/wpGetAttachmentLink.php b/tests/post/wpGetAttachmentLink.php
index 2d658e002e..141b8a2427 100644
--- a/tests/post/wpGetAttachmentLink.php
+++ b/tests/post/wpGetAttachmentLink.php
@@ -41,7 +41,7 @@ class Tests_Post_WpGetAttachmentLink extends WP_UnitTestCase {
 
 		add_filter(
 			'wp_get_attachment_link_attributes',
-			static function( $attr ) use ( $attributes ) {
+			static function ( $attr ) use ( $attributes ) {
 				return array_merge( $attr, $attributes );
 			}
 		);
diff --git a/tests/post/wpInsertPost.php b/tests/post/wpInsertPost.php
index 167d29dd39..1b0838cf06 100644
--- a/tests/post/wpInsertPost.php
+++ b/tests/post/wpInsertPost.php
@@ -304,7 +304,6 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 
 		// There should be a publish_future_post hook scheduled on the future date.
 		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
-
 	}
 
 	/**
@@ -650,7 +649,6 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 
 		$this->assertInstanceOf( 'WP_Error', wp_insert_post( $post, true ) );
 		$this->assertInstanceOf( 'WP_Error', wp_update_post( $post, true ) );
-
 	}
 
 	/**
diff --git a/tests/post/wpTrashPost.php b/tests/post/wpTrashPost.php
new file mode 100644
index 0000000000..1b1a5d6aad
--- /dev/null
+++ b/tests/post/wpTrashPost.php
@@ -0,0 +1,129 @@
+<?php
+
+/**
+ * @group post
+ *
+ * @covers ::wp_trash_post
+ */
+class Tests_Post_WpTrashPost extends WP_UnitTestCase {
+	/**
+	 * @var WP_Post
+	 */
+	protected $post;
+
+	public function set_up() {
+		parent::set_up();
+
+		$this->post = $this->factory()->post->create_and_get(
+			array(
+				'post_status' => 'draft',
+			)
+		);
+	}
+
+	/**
+	 * Tests that wp_trash_post() returns a WP_Post object
+	 * and sets the correct post meta to trash a post.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_trash_post
+	 */
+	public function test_trash_post() {
+		$result = wp_trash_post( $this->post->ID );
+
+		$this->assertInstanceOf( 'WP_Post', $result, 'wp_trash_post returned value should be an instance of WP_Post.' );
+
+		$trashed = get_posts(
+			array(
+				'post_status' => 'trash',
+				'fields'      => 'ids',
+			)
+		);
+
+		$this->assertContains( $this->post->ID, $trashed, 'The post should be trashed.' );
+
+		$trashed_post_metas = get_post_meta( $this->post->ID );
+
+		$this->assertArrayHasKey( '_wp_trash_meta_status', $trashed_post_metas, 'Trashed post should have _wp_trash_meta_status meta set.' );
+		$this->assertCount( 1, $trashed_post_metas['_wp_trash_meta_status'], 'Trashed post should have only one _wp_trash_meta_status meta set.' );
+		$this->assertSame( $this->post->post_status, reset( $trashed_post_metas['_wp_trash_meta_status'] ), 'Trashed post should have _wp_trash_meta_status meta set to previous post status.' );
+		$this->assertArrayHasKey( '_wp_trash_meta_time', $trashed_post_metas, 'Trashed post should have _wp_trash_meta_time meta set.' );
+		$this->assertCount( 1, $trashed_post_metas['_wp_trash_meta_time'], 'Trashed post should have only one _wp_trash_meta_time meta set.' );
+	}
+
+	/**
+	 * Tests that wp_trash_post() applies 'pre_trash_post' filters
+	 * and passes the expected values to callbacks.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_trash_post
+	 */
+	public function test_pre_trash_post_hook() {
+		add_filter(
+			'pre_trash_post',
+			function ( $trash, $post, $previous_status ) {
+				$this->assertNull( $trash, 'pre_trash_post first parameter should be null.' );
+				$this->assertSame( $this->post->ID, $post->ID, 'pre_trash_post second parameter should be the trashed post ID.' );
+				$this->assertSame( $this->post->post_status, $previous_status, 'pre_trash_post third parameter should be the previous trashed post status.' );
+
+				return $trash;
+			},
+			10,
+			3
+		);
+
+		wp_trash_post( $this->post->ID );
+
+		$this->assertGreaterThan( 0, did_filter( 'pre_trash_post' ), 'pre_trash_post filter was not called.' );
+	}
+
+	/**
+	 * Tests that wp_trash_post() triggers the 'wp_trash_post' action
+	 * and passes the expected values to callbacks.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_trash_post
+	 */
+	public function test_wp_trash_post_hook() {
+		add_action(
+			'wp_trash_post',
+			function ( $post_id, $previous_status ) {
+				$this->assertSame( $this->post->ID, $post_id, 'wp_trash_post first parameter should be the trashed post ID.' );
+				$this->assertSame( $this->post->post_status, $previous_status, 'wp_trash_post second parameter should be the previous trashed post status.' );
+			},
+			10,
+			2
+		);
+
+		wp_trash_post( $this->post->ID );
+
+		$this->assertGreaterThan( 0, did_action( 'wp_trash_post' ), 'wp_trash_post action was not called.' );
+	}
+
+	/**
+	 * Tests that wp_trash_post() triggers the 'trashed_post' action
+	 * and passes the expected values to callbacks.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_trash_post
+	 */
+	public function test_trashed_post_hook() {
+		add_action(
+			'trashed_post',
+			function ( $post_id, $previous_status ) {
+				$this->assertSame( $this->post->ID, $post_id, 'trashed_post first parameter should be the trashed post ID.' );
+				$this->assertSame( $this->post->post_status, $previous_status, 'trashed_post second parameter should be the previous trashed post status.' );
+			},
+			10,
+			2
+		);
+
+		wp_trash_post( $this->post->ID );
+
+		$this->assertGreaterThan( 0, did_action( 'trashed_post' ), 'trashed_post action was not called.' );
+	}
+}
diff --git a/tests/post/wpUntrashPost.php b/tests/post/wpUntrashPost.php
new file mode 100644
index 0000000000..a4843dd2a2
--- /dev/null
+++ b/tests/post/wpUntrashPost.php
@@ -0,0 +1,132 @@
+<?php
+
+/**
+ * @group post
+ *
+ * @covers ::wp_untrash_post
+ */
+class Tests_Post_WpUntrashPost extends WP_UnitTestCase {
+	/**
+	 * @var WP_Post
+	 */
+	protected $trashed_post;
+
+	public function set_up() {
+		parent::set_up();
+
+		$this->trashed_post = wp_trash_post(
+			$this->factory()->post->create(
+				array(
+					'post_status' => 'draft',
+				)
+			)
+		);
+	}
+
+	/**
+	 * Tests that wp_untrash_post() returns a WP_Post object,
+	 * removes post meta for an untrashed post and sets it to a 'Draft'.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_untrash_post
+	 */
+	public function test_untrash_post() {
+		$result = wp_untrash_post( $this->trashed_post->ID );
+
+		$this->assertInstanceOf( 'WP_Post', $result, 'wp_untrash_post returned value should be an instance of WP_Post.' );
+
+		$trashed = get_posts(
+			array(
+				'post_status' => 'trash',
+				'fields'      => 'ids',
+			)
+		);
+
+		$this->assertNotContains( $this->trashed_post->ID, $trashed, 'Untrashed post should not belong to trashed posts anymore.' );
+
+		$untrashed_post_metas = get_post_meta( $this->trashed_post->ID );
+
+		$this->assertArrayNotHasKey( '_wp_trash_meta_status', $untrashed_post_metas, 'Untrashed post should not have _wp_trash_meta_status meta anymore.' );
+		$this->assertArrayNotHasKey( '_wp_trash_meta_time', $untrashed_post_metas, 'Untrashed post should not have _wp_trash_meta_time meta anymore.' );
+
+		$post = get_post( $this->trashed_post->ID );
+
+		$this->assertSame( 'draft', $post->post_status, 'Untrashed post should have its previous status set correctly.' );
+	}
+
+	/**
+	 * Tests that wp_untrash_post() applies 'pre_untrash_post' filters
+	 * and passes the expected values to callbacks.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_untrash_post
+	 */
+	public function test_pre_untrash_post_hook() {
+		add_filter(
+			'pre_untrash_post',
+			function ( $trash, $post, $previous_status ) {
+				$this->assertNull( $trash, 'pre_untrash_post first parameter should be null.' );
+				$this->assertSame( $this->trashed_post->ID, $post->ID, 'pre_untrash_post second parameter should be the trashed post ID.' );
+				$this->assertSame( $this->trashed_post->post_status, $previous_status, 'pre_untrash_post third parameter should be the previous trashed post status.' );
+
+				return $trash;
+			},
+			10,
+			3
+		);
+
+		wp_untrash_post( $this->trashed_post->ID );
+
+		$this->assertGreaterThan( 0, did_filter( 'pre_untrash_post' ), 'pre_untrash_post filter was not called.' );
+	}
+
+	/**
+	 * Tests that wp_untrash_post() triggers the 'untrash_post' action
+	 * and passes the expected values to callbacks.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_untrash_post
+	 */
+	public function test_untrash_post_hook() {
+		add_action(
+			'untrash_post',
+			function ( $post_id, $previous_status ) {
+				$this->assertSame( $this->trashed_post->ID, $post_id, 'untrash_post first parameter should be the trashed post ID.' );
+				$this->assertSame( $this->trashed_post->post_status, $previous_status, 'untrash_post second parameter should be the previous trashed post status.' );
+			},
+			10,
+			2
+		);
+
+		wp_untrash_post( $this->trashed_post->ID );
+
+		$this->assertGreaterThan( 0, did_action( 'untrash_post' ), 'untrash_post action was not called.' );
+	}
+
+	/**
+	 * Tests that wp_untrash_post() triggers the 'untrashed_post' action
+	 * and passes the expected values to callbacks.
+	 *
+	 * @ticket 58392
+	 *
+	 * @covers ::wp_untrash_post
+	 */
+	public function test_untrashed_post_hook() {
+		add_action(
+			'untrashed_post',
+			function ( $post_id, $previous_status ) {
+				$this->assertSame( $this->trashed_post->ID, $post_id, 'untrashed_post first parameter should be the trashed post ID.' );
+				$this->assertSame( $this->trashed_post->post_status, $previous_status, 'untrashed_post second parameter should be the previous trashed post status.' );
+			},
+			10,
+			2
+		);
+
+		wp_untrash_post( $this->trashed_post->ID );
+
+		$this->assertGreaterThan( 0, did_action( 'untrashed_post' ), 'untrashed_post action was not called.' );
+	}
+}
diff --git a/tests/privacy/wpPrivacySendRequestConfirmationNotification.php b/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
index 5374cd5701..951039cb08 100644
--- a/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
+++ b/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
@@ -240,5 +240,4 @@ class Tests_Privacy_wpPrivacySendRequestConfirmationNotification extends WP_Unit
 
 		return $headers;
 	}
-
 }
diff --git a/tests/query.php b/tests/query.php
index 9c4ca439a5..37dd51a063 100644
--- a/tests/query.php
+++ b/tests/query.php
@@ -730,7 +730,7 @@ class Tests_Query extends WP_UnitTestCase {
 	public function test_posts_clauses_filter_should_receive_filtered_clauses() {
 		add_filter(
 			'posts_join_paged',
-			static function() {
+			static function () {
 				return '/* posts_join_paged */';
 			}
 		);
@@ -755,7 +755,7 @@ class Tests_Query extends WP_UnitTestCase {
 	public function test_posts_clauses_request_filter_should_receive_filtered_clauses() {
 		add_filter(
 			'posts_join_request',
-			static function() {
+			static function () {
 				return '/* posts_join_request */';
 			}
 		);
@@ -897,4 +897,71 @@ class Tests_Query extends WP_UnitTestCase {
 		$this->assertFalse( $q->is_tax() );
 		$this->assertFalse( $q->is_tag( 'non-existent-tag' ) );
 	}
+
+	/**
+	 * Test if $before_loop is true before loop.
+	 *
+	 * @ticket 58211
+	 */
+	public function test_before_loop_value_set_true_before_the_loop() {
+		// Get a new query with 3 posts.
+		$query = $this->get_new_wp_query_with_posts( 3 );
+
+		$this->assertTrue( $query->before_loop );
+	}
+
+	/**
+	 * Test $before_loop value is set to false when the loop starts.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers WP_Query::the_post
+	 */
+	public function test_before_loop_value_set_to_false_in_loop_with_post() {
+		// Get a new query with 2 posts.
+		$query = $this->get_new_wp_query_with_posts( 2 );
+
+		while ( $query->have_posts() ) {
+			// $before_loop should be set false as soon as the_post is called for the first time.
+			$query->the_post();
+
+			$this->assertFalse( $query->before_loop );
+			break;
+		}
+	}
+
+	/**
+	 * Test $before_loop value is set to false when there is no post in the loop.
+	 *
+	 * @ticket 58211
+	 *
+	 * @covers WP_Query::have_posts
+	 */
+	public function test_before_loop_set_false_after_loop_with_no_post() {
+		// New query without any posts in the result.
+		$query = new WP_Query(
+			array(
+				'category_name' => 'non-existent-category',
+			)
+		);
+
+		// There will not be any posts, so the loop will never actually enter.
+		while ( $query->have_posts() ) {
+			$query->the_post();
+		}
+
+		// Still, this should be false as there are no results and entering the loop was attempted.
+		$this->assertFalse( $query->before_loop );
+	}
+
+	/**
+	 * Get a new query with a given number of posts.
+	 *
+	 * @param int $no_of_posts Number of posts to be added in the query.
+	 */
+	public function get_new_wp_query_with_posts( $no_of_posts ) {
+		$post_ids = self::factory()->post->create_many( $no_of_posts );
+		$query    = new WP_Query( array( 'post__in' => $post_ids ) );
+		return $query;
+	}
 }
diff --git a/tests/query/cacheResults.php b/tests/query/cacheResults.php
index 6ddaffd273..b3923d8229 100644
--- a/tests/query/cacheResults.php
+++ b/tests/query/cacheResults.php
@@ -1079,6 +1079,85 @@ class Test_Query_CacheResults extends WP_UnitTestCase {
 		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
 	}
 
+	/**
+	 * @ticket 58599
+	 */
+	public function test_query_posts_fields_request() {
+		global $wpdb;
+
+		$args = array(
+			'update_post_meta_cache' => false,
+			'update_post_term_cache' => false,
+			'no_found_rows'          => true,
+		);
+
+		add_filter( 'posts_fields_request', array( $this, 'filter_posts_fields_request' ) );
+
+		$before = get_num_queries();
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+		$after  = get_num_queries();
+
+		foreach ( $posts1 as $_post ) {
+			$this->assertNotSame( get_post( $_post->ID )->post_content, $_post->post_content );
+		}
+
+		$this->assertSame( 2, $after - $before, 'There should only be 2 queries run, one for request and one prime post objects.' );
+
+		$this->assertStringContainsString(
+			"SELECT $wpdb->posts.*",
+			$wpdb->last_query,
+			'Check that _prime_post_caches is called.'
+		);
+	}
+
+	public function filter_posts_fields_request( $fields ) {
+		global $wpdb;
+		return "{$wpdb->posts}.ID";
+	}
+
+	/**
+	 * @ticket 58599
+	 * @dataProvider data_query_filter_posts_results
+	 */
+	public function test_query_filter_posts_results( $filter ) {
+		global $wpdb;
+
+		$args = array(
+			'update_post_meta_cache' => false,
+			'update_post_term_cache' => false,
+			'no_found_rows'          => true,
+		);
+
+		add_filter( $filter, array( $this, 'filter_posts_results' ) );
+
+		$before = get_num_queries();
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+		$after  = get_num_queries();
+
+		$this->assertCount( 1, $posts1 );
+
+		$this->assertSame( 2, $after - $before, 'There should only be 2 queries run, one for request and one prime post objects.' );
+
+		$this->assertStringContainsString(
+			"SELECT $wpdb->posts.*",
+			$wpdb->last_query,
+			'Check that _prime_post_caches is called.'
+		);
+	}
+
+	public function filter_posts_results() {
+		return array( get_post( self::$posts[0] ) );
+	}
+
+	public function data_query_filter_posts_results() {
+		return array(
+			array( 'posts_results' ),
+			array( 'the_posts' ),
+		);
+	}
+
 	/**
 	 * @ticket 22176
 	 */
diff --git a/tests/query/commentCount.php b/tests/query/commentCount.php
index 5a759a3f06..d995c4b422 100644
--- a/tests/query/commentCount.php
+++ b/tests/query/commentCount.php
@@ -190,7 +190,6 @@ class Tests_Query_CommentCount extends WP_UnitTestCase {
 		}
 
 		$this->assertSameSets( $expected, $found_post_ids );
-
 	}
 	public function test_operator_equal_or_greater_than() {
 		$args = array(
@@ -371,4 +370,3 @@ class Tests_Query_CommentCount extends WP_UnitTestCase {
 		$this->assertSameSets( $expected, $found_post_ids );
 	}
 }
-
diff --git a/tests/query/commentFeed.php b/tests/query/commentFeed.php
index 35c4eb0b60..23a37f2b40 100644
--- a/tests/query/commentFeed.php
+++ b/tests/query/commentFeed.php
@@ -28,7 +28,6 @@ class Tests_Query_CommentFeed extends WP_UnitTestCase {
 	 * @ticket 36904
 	 */
 	public function test_archive_comment_feed() {
-		global $wpdb;
 		add_filter( 'split_the_query', '__return_false' );
 		$q1   = new WP_Query();
 		$args = array(
@@ -42,12 +41,12 @@ class Tests_Query_CommentFeed extends WP_UnitTestCase {
 			'cache_results'          => false,
 		);
 		$q1->query( $args );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$q2          = new WP_Query();
 		$q2->query( $args );
 		$this->assertTrue( $q2->is_comment_feed() );
 		$this->assertFalse( $q2->is_singular() );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 
 	/**
@@ -87,7 +86,6 @@ class Tests_Query_CommentFeed extends WP_UnitTestCase {
 	 * @ticket 36904
 	 */
 	public function test_single_comment_feed() {
-		global $wpdb;
 		$post = get_post( self::$post_ids[0] );
 
 		$q1   = new WP_Query();
@@ -103,12 +101,12 @@ class Tests_Query_CommentFeed extends WP_UnitTestCase {
 		);
 
 		$q1->query( $args );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$q2          = new WP_Query();
 		$q2->query( $args );
 
 		$this->assertTrue( $q2->is_comment_feed() );
 		$this->assertTrue( $q2->is_singular() );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 }
diff --git a/tests/query/conditionals.php b/tests/query/conditionals.php
index c447c638d6..05278ffd7a 100644
--- a/tests/query/conditionals.php
+++ b/tests/query/conditionals.php
@@ -395,7 +395,6 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 			$this->go_to( "/{$feed}/" );
 			$this->assertQueryTrue( 'is_feed' );
 		}
-
 	}
 
 	public function test_main_feed() {
@@ -440,7 +439,6 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 				$this->go_to( "/comments/{$type}" );
 				$this->assertQueryTrue( 'is_feed', 'is_comment_feed' );
 		}
-
 	}
 
 	// 'search/(.+)/feed/(feed|rdf|rss|rss2|atom)/?$' => 'index.php?s=$matches[1]&feed=$matches[2]',
@@ -771,7 +769,6 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 		$this->go_to( get_permalink( $post_id ) . '2/' );
 		// Should is_paged be true also?
 		$this->assertQueryTrue( 'is_single', 'is_singular' );
-
 	}
 
 	// '[0-9]{4}/[0-9]{1,2}/[0-9]{1,2}/[^/]+/([^/]+)/?$' => 'index.php?attachment=$matches[1]',
@@ -1644,14 +1641,14 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 		// Get the list of `is_*()` conditional tags.
 		$functions = array_filter(
 			get_class_methods( 'WP_Query' ),
-			static function( $function_name ) {
+			static function ( $function_name ) {
 				return str_starts_with( $function_name, 'is_' );
 			}
 		);
 
 		// Wrap each function name in an array.
 		$functions = array_map(
-			static function( $function_name ) {
+			static function ( $function_name ) {
 				return array( $function_name );
 			},
 			$functions
@@ -1692,5 +1689,4 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 			array( 'the_comment', null ),
 		);
 	}
-
 }
diff --git a/tests/query/isTerm.php b/tests/query/isTerm.php
index 0527201ce2..8eb6d05d6b 100644
--- a/tests/query/isTerm.php
+++ b/tests/query/isTerm.php
@@ -25,9 +25,6 @@ class Tests_Query_IsTerm extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
-		$GLOBALS['wp_the_query'] = new WP_Query();
-		$GLOBALS['wp_query']     = $GLOBALS['wp_the_query'];
-
 		$this->set_permalink_structure( '/%year%/%monthnum%/%day%/%postname%/' );
 
 		create_initial_taxonomies();
diff --git a/tests/query/lazyLoadCommentMeta.php b/tests/query/lazyLoadCommentMeta.php
index 93a8d3630f..420fd45b23 100644
--- a/tests/query/lazyLoadCommentMeta.php
+++ b/tests/query/lazyLoadCommentMeta.php
@@ -26,6 +26,8 @@ class Tests_Lazy_Load_Comment_Meta extends WP_UnitTestCase {
 	 * @ticket 57901
 	 *
 	 * @covers ::wp_queue_comments_for_comment_meta_lazyload
+	 *
+	 * @expectedDeprecated wp_queue_comments_for_comment_meta_lazyload
 	 */
 	public function test_wp_queue_comments_for_comment_meta_lazyload() {
 		$filter = new MockAction();
@@ -45,6 +47,8 @@ class Tests_Lazy_Load_Comment_Meta extends WP_UnitTestCase {
 	 * @ticket 57901
 	 *
 	 * @covers ::wp_queue_comments_for_comment_meta_lazyload
+	 *
+	 * @expectedDeprecated wp_queue_comments_for_comment_meta_lazyload
 	 */
 	public function test_wp_queue_comments_for_comment_meta_lazyload_new_comment() {
 		$filter = new MockAction();
diff --git a/tests/query/lazyLoadTermMeta.php b/tests/query/lazyLoadTermMeta.php
index 85ef586dc6..fc34f84bb3 100644
--- a/tests/query/lazyLoadTermMeta.php
+++ b/tests/query/lazyLoadTermMeta.php
@@ -45,6 +45,7 @@ class Test_Lazy_Load_Term_Meta extends WP_UnitTestCase {
 	 * @covers ::wp_queue_posts_for_term_meta_lazyload
 	 */
 	public function test_wp_queue_posts_for_term_meta_lazyload() {
+		$this->reset_lazyload_queue();
 		$filter = new MockAction();
 		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
 		new WP_Query(
diff --git a/tests/query/metaQuery.php b/tests/query/metaQuery.php
index c9e73ec8a5..e930ef3266 100644
--- a/tests/query/metaQuery.php
+++ b/tests/query/metaQuery.php
@@ -1920,7 +1920,6 @@ class Tests_Query_MetaQuery extends WP_UnitTestCase {
 		);
 
 		$this->assertSameSets( array( $posts[0] ), $q->posts );
-
 	}
 
 	/**
diff --git a/tests/query/results.php b/tests/query/results.php
index bf653d378a..40d05a4d9f 100644
--- a/tests/query/results.php
+++ b/tests/query/results.php
@@ -768,7 +768,6 @@ class Tests_Query_Results extends WP_UnitTestCase {
 			$this->assertIsInt( $post->ID );
 			$this->assertIsInt( $post->post_parent );
 		}
-
 	}
 
 	/**
diff --git a/tests/query/searchColumns.php b/tests/query/searchColumns.php
index 463bef8107..9ef30c2113 100644
--- a/tests/query/searchColumns.php
+++ b/tests/query/searchColumns.php
@@ -410,5 +410,4 @@ class Tests_Query_SearchColumns extends WP_UnitTestCase {
 		$search_columns = array( 'post_non_existing_column' );
 		return $search_columns;
 	}
-
 }
diff --git a/tests/query/stickies.php b/tests/query/stickies.php
index 0070f4cb31..81a991c6d7 100644
--- a/tests/query/stickies.php
+++ b/tests/query/stickies.php
@@ -136,7 +136,7 @@ class Tests_Query_Stickies extends WP_UnitTestCase {
 		$post_ids     = self::factory()->post->create_many( $sticky_count, array( 'post_date' => $post_date ) );
 		add_filter(
 			'pre_option_sticky_posts',
-			function () use ( $post_ids ) {
+			static function () use ( $post_ids ) {
 				return $post_ids;
 			}
 		);
diff --git a/tests/query/vars.php b/tests/query/vars.php
index 4b4b96561b..87e7fa7bb7 100644
--- a/tests/query/vars.php
+++ b/tests/query/vars.php
@@ -80,5 +80,4 @@ class Tests_Query_Vars extends WP_UnitTestCase {
 			'Care should be taken when introducing new public query vars. See https://core.trac.wordpress.org/ticket/35115'
 		);
 	}
-
 }
diff --git a/tests/rest-api.php b/tests/rest-api.php
index 20b23fc0fb..4a575b8803 100644
--- a/tests/rest-api.php
+++ b/tests/rest-api.php
@@ -2512,10 +2512,10 @@ class Tests_REST_API extends WP_UnitTestCase {
 		$this->assertArrayHasKey( 'description', $preload_data['/']['body'] );
 		$this->assertArrayHasKey( 'routes', $preload_data['/']['body'] );
 
-		// Filtered request only has the desired fields + links
+		// Filtered request only has the desired fields.
 		$this->assertSame(
 			array_keys( $preload_data['/?_fields=description']['body'] ),
-			array( 'description', '_links' )
+			array( 'description' )
 		);
 	}
 
diff --git a/tests/rest-api/rest-application-passwords-controller.php b/tests/rest-api/rest-application-passwords-controller.php
index 0515c31512..96d1b193bb 100644
--- a/tests/rest-api/rest-application-passwords-controller.php
+++ b/tests/rest-api/rest-application-passwords-controller.php
@@ -961,7 +961,7 @@ class WP_Test_REST_Application_Passwords_Controller extends WP_Test_REST_Control
 		$this->setup_app_password_authenticated_request();
 		add_action(
 			'application_password_did_authenticate',
-			static function() {
+			static function () {
 				$GLOBALS['wp_rest_application_password_uuid'] = 'invalid_uuid';
 			}
 		);
diff --git a/tests/rest-api/rest-attachments-controller.php b/tests/rest-api/rest-attachments-controller.php
index 55cf74f3d7..0e721258ed 100644
--- a/tests/rest-api/rest-attachments-controller.php
+++ b/tests/rest-api/rest-attachments-controller.php
@@ -1787,7 +1787,6 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		}
 
 		$this->assertSame( wp_get_attachment_url( $attachment->ID ), $data['source_url'] );
-
 	}
 
 	/**
@@ -1984,11 +1983,11 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function filter_rest_insert_attachment( $attachment ) {
-		self::$rest_insert_attachment_count++;
+		++self::$rest_insert_attachment_count;
 	}
 
 	public function filter_rest_after_insert_attachment( $attachment ) {
-		self::$rest_after_insert_attachment_count++;
+		++self::$rest_after_insert_attachment_count;
 	}
 
 	/**
diff --git a/tests/rest-api/rest-autosaves-controller.php b/tests/rest-api/rest-autosaves-controller.php
index b043b5e073..c268b74518 100644
--- a/tests/rest-api/rest-autosaves-controller.php
+++ b/tests/rest-api/rest-autosaves-controller.php
@@ -215,12 +215,13 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 			'author',
 			'date',
 			'date_gmt',
+			'id',
+			'meta',
 			'modified',
 			'modified_gmt',
-			'guid',
-			'id',
 			'parent',
 			'slug',
+			'guid',
 			'title',
 			'excerpt',
 			'content',
@@ -259,7 +260,6 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/posts/' . REST_TESTS_IMPOSSIBLY_HIGH_NUMBER . '/autosaves/' . self::$autosave_post_id );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_post_invalid_parent', $response, 404 );
-
 	}
 
 	public function test_get_item_invalid_parent_post_type() {
@@ -289,7 +289,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertCount( 13, $properties );
+		$this->assertCount( 14, $properties );
 		$this->assertArrayHasKey( 'author', $properties );
 		$this->assertArrayHasKey( 'content', $properties );
 		$this->assertArrayHasKey( 'date', $properties );
@@ -303,6 +303,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		$this->assertArrayHasKey( 'slug', $properties );
 		$this->assertArrayHasKey( 'title', $properties );
 		$this->assertArrayHasKey( 'preview_link', $properties );
+		$this->assertArrayHasKey( 'meta', $properties );
 	}
 
 	public function test_create_item() {
@@ -340,6 +341,76 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		$this->check_create_autosave_response( $response );
 	}
 
+	public function test_update_item_with_meta() {
+		wp_set_current_user( self::$editor_id );
+		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
+		register_post_meta(
+			'post',
+			'foo',
+			array(
+				'show_in_rest'      => true,
+				'revisions_enabled' => true,
+				'single'            => true,
+			)
+		);
+		$params = $this->set_post_data(
+			array(
+				'id'     => self::$post_id,
+				'author' => self::$contributor_id,
+				'meta'   => array(
+					'foo' => 'bar',
+				),
+			)
+		);
+
+		$request->set_body_params( $params );
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->check_create_autosave_response( $response );
+
+		$data = $response->get_data();
+		$this->assertArrayHasKey( 'meta', $data );
+		$this->assertArrayHasKey( 'foo', $data['meta'] );
+		$this->assertSame( 'bar', $data['meta']['foo'] );
+	}
+
+	public function test_update_item_with_json_meta() {
+		$meta = '[{\"content\":\"foot 1\",\"id\":\"fa97a10d-7401-42b9-ac54-df8f4510749a\"},{\"content\":\"fdddddoot 2\\\"\",\"id\":\"2216d0aa-34b8-42b4-b441-84dedc0406e0\"}]';
+		wp_set_current_user( self::$editor_id );
+		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
+		register_post_meta(
+			'post',
+			'foo',
+			array(
+				'show_in_rest'      => true,
+				'revisions_enabled' => true,
+				'single'            => true,
+			)
+		);
+		$params = $this->set_post_data(
+			array(
+				'id'     => self::$post_id,
+				'author' => self::$contributor_id,
+				'meta'   => array(
+					'foo' => $meta,
+				),
+			)
+		);
+
+		$request->set_body_params( $params );
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->check_create_autosave_response( $response );
+
+		$data = $response->get_data();
+		$this->assertArrayHasKey( 'meta', $data );
+		$this->assertArrayHasKey( 'foo', $data['meta'] );
+		$values = json_decode( wp_unslash( $data['meta']['foo'] ), true );
+		$this->assertNotNull( $values );
+	}
+
 	public function test_update_item_nopriv() {
 		wp_set_current_user( self::$contributor_id );
 
@@ -688,22 +759,29 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 			'post_status'  => 'publish',
 		);
 		$post_id   = wp_insert_post( $post_data );
-
 		wp_set_current_user( self::$editor_id );
 
+		// Make a small change create the initial autosave.
 		$autosave_data = array(
-			'post_content' => $post_data['post_content'],
+			'post_content' => 'Test post content changed',
 		);
-
-		// Create autosaves response.
-		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . $post_id . '/autosaves' );
+		$request       = new WP_REST_Request( 'POST', '/wp/v2/posts/' . $post_id . '/autosaves' );
 		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $autosave_data ) );
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->assertSame( 200, $response->get_status() );
+
+		// Store the first autosave ID.
+		$autosave = $response->get_data();
+
+		// Try creating an autosave using the REST endpoint with unchanged content.
+		$request->set_body( wp_json_encode( $autosave_data ) );
 
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
 
-		$this->assertSame( 400, $response->get_status(), 'Response status is not 400.' );
-		$this->assertSame( 'rest_autosave_no_changes', $data['code'], 'Response "code" is not "rest_autosave_no_changes"' );
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSame( $autosave['id'], $data['id'], 'Original autosave was not returned' );
 	}
 }
diff --git a/tests/rest-api/rest-block-directory-controller.php b/tests/rest-api/rest-block-directory-controller.php
index c3cac6011e..f61b317240 100644
--- a/tests/rest-api/rest-block-directory-controller.php
+++ b/tests/rest-api/rest-block-directory-controller.php
@@ -359,7 +359,7 @@ class WP_REST_Block_Directory_Controller_Test extends WP_Test_REST_Controller_Te
 	private function mock_remote_request( array $expected ) {
 		add_filter(
 			'pre_http_request',
-			static function() use ( $expected ) {
+			static function () use ( $expected ) {
 				$default = array(
 					'headers'  => array(),
 					'response' => array(
diff --git a/tests/rest-api/rest-block-renderer-controller.php b/tests/rest-api/rest-block-renderer-controller.php
index 3c79da5651..3573ecb6e0 100644
--- a/tests/rest-api/rest-block-renderer-controller.php
+++ b/tests/rest-api/rest-block-renderer-controller.php
@@ -429,7 +429,7 @@ class REST_Block_Renderer_Controller_Test extends WP_Test_REST_Controller_Testca
 	public function test_get_item_with_pre_render_block_filter() {
 		wp_set_current_user( self::$user_id );
 
-		$pre_render_filter = static function( $output, $block ) {
+		$pre_render_filter = static function ( $output, $block ) {
 			if ( $block['blockName'] === self::$block_name ) {
 				return '<p>Alternate content.</p>';
 			}
diff --git a/tests/rest-api/rest-block-type-controller.php b/tests/rest-api/rest-block-type-controller.php
index 4dc177722e..2745b61195 100644
--- a/tests/rest-api/rest-block-type-controller.php
+++ b/tests/rest-api/rest-block-type-controller.php
@@ -62,6 +62,8 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		self::delete_user( self::$admin_id );
 		self::delete_user( self::$subscriber_id );
 		unregister_block_type( 'fake/test' );
+		unregister_block_type( 'fake/invalid' );
+		unregister_block_type( 'fake/false' );
 	}
 
 	/**
@@ -138,7 +140,6 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
 		$this->assertSameSets( array( $block_styles ), $data['styles'] );
-
 	}
 
 	/**
@@ -179,7 +180,6 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			),
 		);
 		$this->assertSameSets( $expected, $data['styles'] );
-
 	}
 
 	/**
@@ -196,31 +196,35 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 
 	/**
 	 * @ticket 47620
+	 * @ticket 57585
+	 * @ticket 59346
 	 */
 	public function test_get_item_invalid() {
 		$block_type = 'fake/invalid';
 		$settings   = array(
 			'title'            => true,
-			'description'      => true,
+			'category'         => true,
+			'parent'           => 'invalid_parent',
+			'ancestor'         => 'invalid_ancestor',
 			'icon'             => true,
+			'description'      => true,
+			'keywords'         => 'invalid_keywords',
+			'textdomain'       => true,
 			'attributes'       => 'invalid_attributes',
 			'provides_context' => 'invalid_provides_context',
 			'uses_context'     => 'invalid_uses_context',
-			'category'         => true,
+			'selectors'        => 'invalid_selectors',
+			'supports'         => 'invalid_supports',
+			'styles'           => array(),
+			'example'          => 'invalid_example',
+			'variations'       => 'invalid_variations',
+			'block_hooks'      => 'invalid_block_hooks',
+			'render_callback'  => 'invalid_callback',
 			'editor_script'    => true,
 			'script'           => true,
 			'view_script'      => true,
 			'editor_style'     => true,
 			'style'            => true,
-			'keywords'         => 'invalid_keywords',
-			'example'          => 'invalid_example',
-			'parent'           => 'invalid_parent',
-			'ancestor'         => 'invalid_ancestor',
-			'supports'         => 'invalid_supports',
-			'styles'           => array(),
-			'render_callback'  => 'invalid_callback',
-			'textdomain'       => true,
-			'variations'       => 'invalid_variations',
 		);
 		register_block_type( $block_type, $settings );
 		wp_set_current_user( self::$admin_id );
@@ -229,14 +233,13 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$data     = $response->get_data();
 		$this->assertSame( $block_type, $data['name'] );
 		$this->assertSame( '1', $data['title'] );
-		$this->assertSame( '1', $data['description'] );
+		$this->assertNull( $data['category'] );
+		$this->assertSameSets( array( 'invalid_parent' ), $data['parent'] );
+		$this->assertSameSets( array( 'invalid_ancestor' ), $data['ancestor'] );
 		$this->assertNull( $data['icon'] );
-		$this->assertSameSets( array(), $data['editor_script_handles'] );
-		$this->assertSameSets( array(), $data['script_handles'] );
-		$this->assertSameSets( array(), $data['view_script_handles'] );
-		$this->assertSameSets( array(), $data['editor_style_handles'] );
-		$this->assertSameSets( array(), $data['style_handles'] );
-		$this->assertSameSets( array(), $data['provides_context'] );
+		$this->assertSame( '1', $data['description'] );
+		$this->assertSameSets( array( 'invalid_keywords' ), $data['keywords'] );
+		$this->assertNull( $data['textdomain'] );
 		$this->assertSameSetsWithIndex(
 			array(
 				'lock' => array( 'type' => 'object' ),
@@ -244,52 +247,58 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			$data['attributes']
 		);
 		$this->assertSameSets( array( 'invalid_uses_context' ), $data['uses_context'] );
-		$this->assertSameSets( array( 'invalid_keywords' ), $data['keywords'] );
-		$this->assertSameSets( array( 'invalid_parent' ), $data['parent'] );
-		$this->assertSameSets( array( 'invalid_ancestor' ), $data['ancestor'] );
+		$this->assertSameSets( array(), $data['provides_context'] );
+		$this->assertSameSets( array(), $data['selectors'], 'invalid selectors defaults to empty array' );
 		$this->assertSameSets( array(), $data['supports'] );
 		$this->assertSameSets( array(), $data['styles'] );
 		$this->assertNull( $data['example'] );
-		$this->assertNull( $data['category'] );
-		$this->assertNull( $data['textdomain'] );
-		$this->assertFalse( $data['is_dynamic'] );
 		$this->assertSameSets( array( array() ), $data['variations'] );
+		$this->assertSameSets( array(), $data['block_hooks'], 'invalid block_hooks defaults to empty array' );
+		$this->assertSameSets( array(), $data['editor_script_handles'] );
+		$this->assertSameSets( array(), $data['script_handles'] );
+		$this->assertSameSets( array(), $data['view_script_handles'] );
+		$this->assertSameSets( array(), $data['editor_style_handles'] );
+		$this->assertSameSets( array(), $data['style_handles'] );
+		$this->assertFalse( $data['is_dynamic'] );
 		// Deprecated properties.
 		$this->assertNull( $data['editor_script'] );
 		$this->assertNull( $data['script'] );
 		$this->assertNull( $data['view_script'] );
 		$this->assertNull( $data['editor_style'] );
 		$this->assertNull( $data['style'] );
-
 	}
 
 	/**
 	 * @ticket 47620
+	 * @ticket 57585
+	 * @ticket 59346
 	 */
 	public function test_get_item_defaults() {
 		$block_type = 'fake/false';
 		$settings   = array(
 			'title'            => false,
-			'description'      => false,
+			'category'         => false,
+			'parent'           => false,
+			'ancestor'         => false,
 			'icon'             => false,
+			'description'      => false,
+			'keywords'         => false,
+			'textdomain'       => false,
 			'attributes'       => false,
 			'provides_context' => false,
 			'uses_context'     => false,
-			'category'         => false,
+			'selectors'        => false,
+			'supports'         => false,
+			'styles'           => false,
+			'example'          => false,
+			'variations'       => false,
+			'block_hooks'      => false,
 			'editor_script'    => false,
 			'script'           => false,
 			'view_script'      => false,
 			'editor_style'     => false,
 			'style'            => false,
-			'keywords'         => false,
-			'parent'           => false,
-			'ancestor'         => false,
-			'supports'         => false,
-			'styles'           => false,
 			'render_callback'  => false,
-			'textdomain'       => false,
-			'example'          => false,
-			'variations'       => false,
 		);
 		register_block_type( $block_type, $settings );
 		wp_set_current_user( self::$admin_id );
@@ -298,13 +307,13 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$data     = $response->get_data();
 		$this->assertSame( $block_type, $data['name'] );
 		$this->assertSame( '', $data['title'] );
-		$this->assertSame( '', $data['description'] );
+		$this->assertNull( $data['category'] );
+		$this->assertSameSets( array(), $data['parent'] );
+		$this->assertSameSets( array(), $data['ancestor'] );
 		$this->assertNull( $data['icon'] );
-		$this->assertSameSets( array(), $data['editor_script_handles'] );
-		$this->assertSameSets( array(), $data['script_handles'] );
-		$this->assertSameSets( array(), $data['view_script_handles'] );
-		$this->assertSameSets( array(), $data['editor_style_handles'] );
-		$this->assertSameSets( array(), $data['style_handles'] );
+		$this->assertSame( '', $data['description'] );
+		$this->assertSameSets( array(), $data['keywords'] );
+		$this->assertNull( $data['textdomain'] );
 		$this->assertSameSetsWithIndex(
 			array(
 				'lock' => array( 'type' => 'object' ),
@@ -313,17 +322,18 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		);
 		$this->assertSameSets( array(), $data['provides_context'] );
 		$this->assertSameSets( array(), $data['uses_context'] );
-		$this->assertSameSets( array(), $data['keywords'] );
-		$this->assertSameSets( array(), $data['parent'] );
-		$this->assertSameSets( array(), $data['ancestor'] );
+		$this->assertSameSets( array(), $data['selectors'], 'selectors defaults to empty array' );
 		$this->assertSameSets( array(), $data['supports'] );
 		$this->assertSameSets( array(), $data['styles'] );
 		$this->assertNull( $data['example'] );
-		$this->assertNull( $data['category'] );
-		$this->assertNull( $data['example'] );
-		$this->assertNull( $data['textdomain'] );
-		$this->assertFalse( $data['is_dynamic'] );
 		$this->assertSameSets( array(), $data['variations'] );
+		$this->assertSameSets( array(), $data['block_hooks'], 'block_hooks defaults to empty array' );
+		$this->assertSameSets( array(), $data['editor_script_handles'] );
+		$this->assertSameSets( array(), $data['script_handles'] );
+		$this->assertSameSets( array(), $data['view_script_handles'] );
+		$this->assertSameSets( array(), $data['editor_style_handles'] );
+		$this->assertSameSets( array(), $data['style_handles'] );
+		$this->assertFalse( $data['is_dynamic'] );
 		// Deprecated properties.
 		$this->assertNull( $data['editor_script'] );
 		$this->assertNull( $data['script'] );
@@ -534,6 +544,8 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 
 	/**
 	 * @ticket 47620
+	 * @ticket 57585
+	 * @ticket 59346
 	 */
 	public function test_get_item_schema() {
 		wp_set_current_user( self::$admin_id );
@@ -541,37 +553,38 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertCount( 28, $properties );
+		$this->assertCount( 30, $properties );
 		$this->assertArrayHasKey( 'api_version', $properties );
+		$this->assertArrayHasKey( 'name', $properties );
 		$this->assertArrayHasKey( 'title', $properties );
+		$this->assertArrayHasKey( 'category', $properties );
+		$this->assertArrayHasKey( 'parent', $properties );
+		$this->assertArrayHasKey( 'ancestor', $properties );
 		$this->assertArrayHasKey( 'icon', $properties );
 		$this->assertArrayHasKey( 'description', $properties );
 		$this->assertArrayHasKey( 'keywords', $properties );
-		$this->assertArrayHasKey( 'styles', $properties );
 		$this->assertArrayHasKey( 'textdomain', $properties );
-		$this->assertArrayHasKey( 'name', $properties );
 		$this->assertArrayHasKey( 'attributes', $properties );
+		$this->assertArrayHasKey( 'provides_context', $properties );
+		$this->assertArrayHasKey( 'uses_context', $properties );
+		$this->assertArrayHasKey( 'selectors', $properties, 'schema must contain selectors' );
 		$this->assertArrayHasKey( 'supports', $properties );
-		$this->assertArrayHasKey( 'category', $properties );
-		$this->assertArrayHasKey( 'is_dynamic', $properties );
+		$this->assertArrayHasKey( 'styles', $properties );
+		$this->assertArrayHasKey( 'example', $properties );
+		$this->assertArrayHasKey( 'variations', $properties );
+		$this->assertArrayHasKey( 'block_hooks', $properties );
 		$this->assertArrayHasKey( 'editor_script_handles', $properties );
 		$this->assertArrayHasKey( 'script_handles', $properties );
 		$this->assertArrayHasKey( 'view_script_handles', $properties );
 		$this->assertArrayHasKey( 'editor_style_handles', $properties );
 		$this->assertArrayHasKey( 'style_handles', $properties );
-		$this->assertArrayHasKey( 'parent', $properties );
-		$this->assertArrayHasKey( 'example', $properties );
-		$this->assertArrayHasKey( 'uses_context', $properties );
-		$this->assertArrayHasKey( 'provides_context', $properties );
-		$this->assertArrayHasKey( 'variations', $properties );
-		$this->assertArrayHasKey( 'ancestor', $properties );
+		$this->assertArrayHasKey( 'is_dynamic', $properties );
 		// Deprecated properties.
 		$this->assertArrayHasKey( 'editor_script', $properties );
 		$this->assertArrayHasKey( 'script', $properties );
 		$this->assertArrayHasKey( 'view_script', $properties );
 		$this->assertArrayHasKey( 'editor_style', $properties );
 		$this->assertArrayHasKey( 'style', $properties );
-
 	}
 
 	/**
@@ -660,6 +673,7 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 	 * Util check block type object against.
 	 *
 	 * @since 5.5.0
+	 * @since 6.4.0 Added the `block_hooks` extra field.
 	 *
 	 * @param WP_Block_Type $block_type Sample block type.
 	 * @param array         $data Data to compare against.
@@ -673,23 +687,27 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$extra_fields = array(
 			'api_version',
 			'name',
-			'category',
-			'editor_script_handles',
-			'script_handles',
-			'view_script_handles',
-			'editor_style_handles',
-			'style_handles',
 			'title',
+			'category',
+			'parent',
+			'ancestor',
 			'icon',
 			'description',
 			'keywords',
-			'parent',
+			'textdomain',
 			'provides_context',
 			'uses_context',
+			'selectors',
 			'supports',
 			'styles',
-			'textdomain',
 			'example',
+			'variations',
+			'block_hooks',
+			'editor_script_handles',
+			'script_handles',
+			'view_script_handles',
+			'editor_style_handles',
+			'style_handles',
 			// Deprecated fields.
 			'editor_script',
 			'script',
diff --git a/tests/rest-api/rest-blocks-controller.php b/tests/rest-api/rest-blocks-controller.php
index 48208d2175..1cdd3474dd 100644
--- a/tests/rest-api/rest-blocks-controller.php
+++ b/tests/rest-api/rest-blocks-controller.php
@@ -220,4 +220,39 @@ class REST_Blocks_Controller_Test extends WP_UnitTestCase {
 			$data['content']
 		);
 	}
+
+	/**
+	 * Check that the `wp_pattern_sync_status` postmeta is moved from meta array to top
+	 * level of response.
+	 *
+	 * @ticket 58677
+	 */
+	public function test_wp_patterns_sync_status_post_meta() {
+		register_post_meta(
+			'wp_block',
+			'wp_pattern_sync_status',
+			array(
+				'single'       => true,
+				'type'         => 'string',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'string',
+						'properties' => array(
+							'sync_status' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+		wp_set_current_user( self::$user_ids['author'] );
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/blocks/' . self::$post_id );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'wp_pattern_sync_status', $data );
+		$this->assertArrayNotHasKey( 'wp_pattern_sync_status', $data['meta'] );
+	}
 }
diff --git a/tests/rest-api/rest-categories-controller.php b/tests/rest-api/rest-categories-controller.php
index a6ad0cf700..9da866a87b 100644
--- a/tests/rest-api/rest-categories-controller.php
+++ b/tests/rest-api/rest-categories-controller.php
@@ -223,7 +223,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 			'parent'     => 0,
 		);
 		$categories = get_terms( 'category', $args );
-		$this->assertSame( count( $categories ), count( $data ) );
+		$this->assertCount( count( $categories ), $data );
 	}
 
 	public function test_get_items_parent_zero_arg_string() {
@@ -255,7 +255,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 			'parent'     => 0,
 		);
 		$categories = get_terms( 'category', $args );
-		$this->assertSame( count( $categories ), count( $data ) );
+		$this->assertCount( count( $categories ), $data );
 	}
 
 	public function test_get_items_by_parent_non_found() {
@@ -631,8 +631,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 
 		// 3rd page.
 		self::factory()->category->create();
-		$total_categories++;
-		$total_pages++;
+		++$total_categories;
+		++$total_pages;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
 		$request->set_param( 'page', 3 );
 		$response = rest_get_server()->dispatch( $request );
@@ -1189,7 +1189,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 			'hide_empty' => false,
 		);
 		$categories = get_terms( 'category', $args );
-		$this->assertSame( count( $categories ), count( $data ) );
+		$this->assertCount( count( $categories ), $data );
 		$this->assertSame( $categories[0]->term_id, $data[0]['id'] );
 		$this->assertSame( $categories[0]->name, $data[0]['name'] );
 		$this->assertSame( $categories[0]->slug, $data[0]['slug'] );
diff --git a/tests/rest-api/rest-comments-controller.php b/tests/rest-api/rest-comments-controller.php
index 9b4444f559..ab8f672c5d 100644
--- a/tests/rest-api/rest-comments-controller.php
+++ b/tests/rest-api/rest-comments-controller.php
@@ -828,8 +828,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 				'comment_post_ID' => self::$post_id,
 			)
 		);
-		$total_comments++;
-		$total_pages++;
+		++$total_comments;
+		++$total_pages;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_param( 'page', 3 );
 		$response = rest_get_server()->dispatch( $request );
diff --git a/tests/rest-api/rest-controller.php b/tests/rest-api/rest-controller.php
index f7da75327a..33ac4f3c81 100644
--- a/tests/rest-api/rest-controller.php
+++ b/tests/rest-api/rest-controller.php
@@ -362,7 +362,6 @@ class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
 
 		// Ignored properties.
 		$this->assertArrayNotHasKey( 'ignored_prop', $args['someobject'] );
-
 	}
 
 	/**
diff --git a/tests/rest-api/rest-global-styles-revisions-controller.php b/tests/rest-api/rest-global-styles-revisions-controller.php
new file mode 100644
index 0000000000..30e5b983ea
--- /dev/null
+++ b/tests/rest-api/rest-global-styles-revisions-controller.php
@@ -0,0 +1,831 @@
+<?php
+/**
+ * Unit tests covering WP_REST_Global_Styles_Revisions_Controller functionality.
+ *
+ * @package WordPress
+ * @subpackage REST API
+ *
+ * @covers WP_REST_Global_Styles_Revisions_Controller
+ *
+ * @group restapi-global-styles
+ * @group restapi
+ */
+class WP_REST_Global_Styles_Revisions_Controller_Test extends WP_Test_REST_Controller_Testcase {
+	/**
+	 * @var int
+	 */
+	protected static $admin_id;
+
+	/**
+	 * @var int
+	 */
+	protected static $second_admin_id;
+
+	/**
+	 * @var int
+	 */
+	protected static $author_id;
+
+	/**
+	 * @var int
+	 */
+	protected static $global_styles_id;
+
+	/**
+	 * @var int
+	 */
+	private $total_revisions;
+
+	/**
+	 * @var array
+	 */
+	private $revision_1;
+
+	/**
+	 * @var int
+	 */
+	private $revision_1_id;
+
+	/**
+	 * @var array
+	 */
+	private $revision_2;
+
+	/**
+	 * @var int
+	 */
+	private $revision_2_id;
+
+	/**
+	 * @var array
+	 */
+	private $revision_3;
+
+	/**
+	 * @var int
+	 */
+	private $revision_3_id;
+
+	/**
+	 * Create fake data before our tests run.
+	 *
+	 * @param WP_UnitTest_Factory $factory Helper that lets us create fake data.
+	 */
+	public static function wpSetupBeforeClass( $factory ) {
+		self::$admin_id        = $factory->user->create(
+			array(
+				'role' => 'administrator',
+			)
+		);
+		self::$second_admin_id = $factory->user->create(
+			array(
+				'role' => 'administrator',
+			)
+		);
+		self::$author_id       = $factory->user->create(
+			array(
+				'role' => 'author',
+			)
+		);
+
+		wp_set_current_user( self::$admin_id );
+		// This creates the global styles for the current theme.
+		self::$global_styles_id = $factory->post->create(
+			array(
+				'post_content' => '{"version": ' . WP_Theme_JSON::LATEST_SCHEMA . ', "isGlobalStylesUserThemeJSON": true }',
+				'post_status'  => 'publish',
+				'post_title'   => __( 'Custom Styles', 'default' ),
+				'post_type'    => 'wp_global_styles',
+				'post_name'    => 'wp-global-styles-tt1-blocks-revisions',
+				'tax_input'    => array(
+					'wp_theme' => 'tt1-blocks',
+				),
+			)
+		);
+
+		// Update post to create a new revisions.
+		$new_styles_post = array(
+			'ID'           => self::$global_styles_id,
+			'post_content' => wp_json_encode(
+				array(
+					'version'                     => WP_Theme_JSON::LATEST_SCHEMA,
+					'isGlobalStylesUserThemeJSON' => true,
+					'styles'                      => array(
+						'color' => array(
+							'background' => 'hotpink',
+						),
+					),
+					'settings'                    => array(
+						'color' => array(
+							'palette' => array(
+								'custom' => array(
+									array(
+										'name'  => 'Ghost',
+										'slug'  => 'ghost',
+										'color' => 'ghost',
+									),
+								),
+							),
+						),
+					),
+				)
+			),
+		);
+
+		wp_update_post( $new_styles_post, true );
+
+		$new_styles_post = array(
+			'ID'           => self::$global_styles_id,
+			'post_content' => wp_json_encode(
+				array(
+					'version'                     => WP_Theme_JSON::LATEST_SCHEMA,
+					'isGlobalStylesUserThemeJSON' => true,
+					'styles'                      => array(
+						'color' => array(
+							'background' => 'lemonchiffon',
+						),
+					),
+					'settings'                    => array(
+						'color' => array(
+							'palette' => array(
+								'custom' => array(
+									array(
+										'name'  => 'Gwanda',
+										'slug'  => 'gwanda',
+										'color' => 'gwanda',
+									),
+								),
+							),
+						),
+					),
+				)
+			),
+		);
+
+		wp_update_post( $new_styles_post, true );
+
+		$new_styles_post = array(
+			'ID'           => self::$global_styles_id,
+			'post_content' => wp_json_encode(
+				array(
+					'version'                     => WP_Theme_JSON::LATEST_SCHEMA,
+					'isGlobalStylesUserThemeJSON' => true,
+					'styles'                      => array(
+						'color' => array(
+							'background' => 'chocolate',
+						),
+					),
+					'settings'                    => array(
+						'color' => array(
+							'palette' => array(
+								'custom' => array(
+									array(
+										'name'  => 'Stacy',
+										'slug'  => 'stacy',
+										'color' => 'stacy',
+									),
+								),
+							),
+						),
+					),
+				)
+			),
+		);
+
+		wp_update_post( $new_styles_post, true );
+		wp_set_current_user( 0 );
+	}
+
+	/**
+	 * Removes users after our tests run.
+	 */
+	public static function wpTearDownAfterClass() {
+		self::delete_user( self::$admin_id );
+		self::delete_user( self::$second_admin_id );
+		self::delete_user( self::$author_id );
+	}
+
+	/**
+	 * Sets up before tests.
+	 */
+	public function set_up() {
+		parent::set_up();
+		switch_theme( 'tt1-blocks' );
+		$revisions             = wp_get_post_revisions( self::$global_styles_id );
+		$this->total_revisions = count( $revisions );
+
+		$this->revision_1    = array_pop( $revisions );
+		$this->revision_1_id = $this->revision_1->ID;
+
+		$this->revision_2    = array_pop( $revisions );
+		$this->revision_2_id = $this->revision_2->ID;
+
+		$this->revision_3    = array_pop( $revisions );
+		$this->revision_3_id = $this->revision_3->ID;
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::register_routes
+	 */
+	public function test_register_routes() {
+		$routes = rest_get_server()->get_routes();
+		$this->assertArrayHasKey(
+			'/wp/v2/global-styles/(?P<parent>[\d]+)/revisions',
+			$routes,
+			'Global style revisions based on the given parentID route does not exist.'
+		);
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_missing_parent() {
+		wp_set_current_user( self::$admin_id );
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . REST_TESTS_IMPOSSIBLY_HIGH_NUMBER . '/revisions' );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( 'rest_post_invalid_parent', $response, 404 );
+	}
+
+	/**
+	 * Utility function to check the items in WP_REST_Global_Styles_Controller::get_items
+	 * against the expected values.
+	 *
+	 * @ticket 58524
+	 */
+	protected function check_get_revision_response( $response_revision_item, $revision_expected_item ) {
+		$this->assertSame( (int) $revision_expected_item->post_author, $response_revision_item['author'], 'Check that the revision item `author` exists.' );
+		$this->assertSame( mysql_to_rfc3339( $revision_expected_item->post_date ), $response_revision_item['date'], 'Check that the revision item `date` exists.' );
+		$this->assertSame( mysql_to_rfc3339( $revision_expected_item->post_date_gmt ), $response_revision_item['date_gmt'], 'Check that the revision item `date_gmt` exists.' );
+		$this->assertSame( mysql_to_rfc3339( $revision_expected_item->post_modified ), $response_revision_item['modified'], 'Check that the revision item `modified` exists.' );
+		$this->assertSame( mysql_to_rfc3339( $revision_expected_item->post_modified_gmt ), $response_revision_item['modified_gmt'], 'Check that the revision item `modified_gmt` exists.' );
+		$this->assertSame( $revision_expected_item->post_parent, $response_revision_item['parent'], 'Check that an id for the parent exists.' );
+
+		// Global styles.
+		$config = ( new WP_Theme_JSON( json_decode( $revision_expected_item->post_content, true ), 'custom' ) )->get_raw_data();
+		$this->assertEquals(
+			$config['settings'],
+			$response_revision_item['settings'],
+			'Check that the revision settings exist in the response.'
+		);
+		$this->assertEquals(
+			$config['styles'],
+			$response_revision_item['styles'],
+			'Check that the revision styles match the updated styles.'
+		);
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items() {
+		wp_set_current_user( self::$admin_id );
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertSame( 200, $response->get_status(), 'Response status is 200.' );
+		$this->assertCount( $this->total_revisions, $data, 'Check that correct number of revisions exists.' );
+
+		// Reverse chronology.
+		$this->assertSame( $this->revision_3_id, $data[0]['id'] );
+		$this->check_get_revision_response( $data[0], $this->revision_3 );
+
+		$this->assertSame( $this->revision_2_id, $data[1]['id'] );
+		$this->check_get_revision_response( $data[1], $this->revision_2 );
+
+		$this->assertSame( $this->revision_1_id, $data[2]['id'] );
+		$this->check_get_revision_response( $data[2], $this->revision_1 );
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_eligible_roles() {
+		wp_set_current_user( self::$second_admin_id );
+		$config              = array(
+			'version'                     => WP_Theme_JSON::LATEST_SCHEMA,
+			'isGlobalStylesUserThemeJSON' => true,
+			'styles'                      => array(
+				'color' => array(
+					'background' => 'whitesmoke',
+				),
+			),
+			'settings'                    => array(),
+		);
+		$updated_styles_post = array(
+			'ID'           => self::$global_styles_id,
+			'post_content' => wp_json_encode( $config ),
+		);
+
+		wp_update_post( $updated_styles_post, true );
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertCount( $this->total_revisions + 1, $data, 'Check that extra revision exist' );
+		$this->assertEquals( self::$second_admin_id, $data[0]['author'], 'Check that second author id returns expected value.' );
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items with context arg.
+	 */
+	public function test_get_item_embed_context() {
+		wp_set_current_user( self::$admin_id );
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_param( 'context', 'embed' );
+		$response = rest_get_server()->dispatch( $request );
+		$fields   = array(
+			'author',
+			'date',
+			'id',
+			'parent',
+		);
+		$data     = $response->get_data();
+		$this->assertSameSets( $fields, array_keys( $data[0] ) );
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_item_schema
+	 */
+	public function test_get_item_schema() {
+		$request    = new WP_REST_Request( 'OPTIONS', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$response   = rest_get_server()->dispatch( $request );
+		$data       = $response->get_data();
+		$properties = $data['schema']['properties'];
+
+		$this->assertCount( 9, $properties, 'Schema properties array has exactly 9 elements.' );
+		$this->assertArrayHasKey( 'id', $properties, 'Schema properties array has "id" key.' );
+		$this->assertArrayHasKey( 'styles', $properties, 'Schema properties array has "styles" key.' );
+		$this->assertArrayHasKey( 'settings', $properties, 'Schema properties array has "settings" key.' );
+		$this->assertArrayHasKey( 'parent', $properties, 'Schema properties array has "parent" key.' );
+		$this->assertArrayHasKey( 'author', $properties, 'Schema properties array has "author" key.' );
+		$this->assertArrayHasKey( 'date', $properties, 'Schema properties array has "date" key.' );
+		$this->assertArrayHasKey( 'date_gmt', $properties, 'Schema properties array has "date_gmt" key.' );
+		$this->assertArrayHasKey( 'modified', $properties, 'Schema properties array has "modified" key.' );
+		$this->assertArrayHasKey( 'modified_gmt', $properties, 'Schema properties array has "modified_gmt" key.' );
+	}
+
+	/**
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_item_permissions_check
+	 */
+	public function test_get_item_permissions_check() {
+		wp_set_current_user( self::$author_id );
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->assertErrorResponse( 'rest_cannot_view', $response, 403 );
+	}
+
+	/**
+	 * Tests the pagination header of the first page.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_pagination_header_of_the_first_page
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_pagination_header_of_the_first_page() {
+		wp_set_current_user( self::$admin_id );
+
+		$rest_route  = '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions';
+		$per_page    = 2;
+		$total_pages = (int) ceil( $this->total_revisions / $per_page );
+		$page        = 1;  // First page.
+
+		$request = new WP_REST_Request( 'GET', $rest_route );
+		$request->set_query_params(
+			array(
+				'per_page' => $per_page,
+				'page'     => $page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$headers  = $response->get_headers();
+		$this->assertSame( $this->total_revisions, $headers['X-WP-Total'] );
+		$this->assertSame( $total_pages, $headers['X-WP-TotalPages'] );
+		$next_link = add_query_arg(
+			array(
+				'per_page' => $per_page,
+				'page'     => $page + 1,
+			),
+			rest_url( $rest_route )
+		);
+		$this->assertStringNotContainsString( 'rel="prev"', $headers['Link'] );
+		$this->assertStringContainsString( '<' . $next_link . '>; rel="next"', $headers['Link'] );
+	}
+
+	/**
+	 * Tests the pagination header of the last page.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_pagination_header_of_the_last_page
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_pagination_header_of_the_last_page() {
+		wp_set_current_user( self::$admin_id );
+
+		$rest_route  = '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions';
+		$per_page    = 2;
+		$total_pages = (int) ceil( $this->total_revisions / $per_page );
+		$page        = 2;  // Last page.
+
+		$request = new WP_REST_Request( 'GET', $rest_route );
+		$request->set_query_params(
+			array(
+				'per_page' => $per_page,
+				'page'     => $page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$headers  = $response->get_headers();
+		$this->assertSame( $this->total_revisions, $headers['X-WP-Total'] );
+		$this->assertSame( $total_pages, $headers['X-WP-TotalPages'] );
+		$prev_link = add_query_arg(
+			array(
+				'per_page' => $per_page,
+				'page'     => $page - 1,
+			),
+			rest_url( $rest_route )
+		);
+		$this->assertStringContainsString( '<' . $prev_link . '>; rel="prev"', $headers['Link'] );
+	}
+
+	/**
+	 * Tests that invalid 'per_page' query should error.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_invalid_per_page_should_error
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_invalid_per_page_should_error() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = -1; // Invalid number.
+		$expected_error  = 'rest_invalid_param';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_param( 'per_page', $per_page );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that out of bounds 'page' query should error.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_out_of_bounds_page_should_error
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_out_of_bounds_page_should_error() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = 2;
+		$total_pages     = (int) ceil( $this->total_revisions / $per_page );
+		$page            = $total_pages + 1; // Out of bound page.
+		$expected_error  = 'rest_revision_invalid_page_number';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'per_page' => $per_page,
+				'page'     => $page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that impossibly high 'page' query should error.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_invalid_max_pages_should_error
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_invalid_max_pages_should_error() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = 2;
+		$page            = REST_TESTS_IMPOSSIBLY_HIGH_NUMBER; // Invalid number.
+		$expected_error  = 'rest_revision_invalid_page_number';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'per_page' => $per_page,
+				'page'     => $page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that the default query should fetch all revisions.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_default_query_should_fetch_all_revisons
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_default_query_should_fetch_all_revisons() {
+		wp_set_current_user( self::$admin_id );
+
+		$expected_count = $this->total_revisions;
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertCount( $expected_count, $response->get_data() );
+	}
+
+	/**
+	 * Tests that 'offset' query shouldn't work without 'per_page' (fallback -1).
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_offset_should_not_work_without_per_page
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_offset_should_not_work_without_per_page() {
+		wp_set_current_user( self::$admin_id );
+
+		$offset         = 1;
+		$expected_count = $this->total_revisions;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_param( 'offset', $offset );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertCount( $expected_count, $response->get_data() );
+	}
+
+	/**
+	 * Tests that 'offset' query should work with 'per_page'.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_offset_should_work_with_per_page
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_offset_should_work_with_per_page() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page       = 2;
+		$offset         = 1;
+		$expected_count = 2;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => $offset,
+				'per_page' => $per_page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertCount( $expected_count, $response->get_data() );
+	}
+
+	/**
+	 * Tests that 'offset' query should take priority over 'page'.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_offset_should_take_priority_over_page
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_offset_should_take_priority_over_page() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page       = 2;
+		$offset         = 1;
+		$page           = 1;
+		$expected_count = 2;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => $offset,
+				'per_page' => $per_page,
+				'page'     => $page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertCount( $expected_count, $response->get_data() );
+	}
+
+	/**
+	 * Tests that 'offset' query, as the total revisions count, should return empty data.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_total_revisions_offset_should_return_empty_data
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_total_revisions_offset_should_return_empty_data() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = 2;
+		$offset          = $this->total_revisions;
+		$expected_error  = 'rest_revision_invalid_offset_number';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => $offset,
+				'per_page' => $per_page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that out of bound 'offset' query should error.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_out_of_bound_offset_should_error
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_out_of_bound_offset_should_error() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = 2;
+		$offset          = $this->total_revisions + 1;
+		$expected_error  = 'rest_revision_invalid_offset_number';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => $offset,
+				'per_page' => $per_page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that impossible high number for 'offset' query should error.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_impossible_high_number_offset_should_error
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_impossible_high_number_offset_should_error() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = 2;
+		$offset          = REST_TESTS_IMPOSSIBLY_HIGH_NUMBER;
+		$expected_error  = 'rest_revision_invalid_offset_number';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => $offset,
+				'per_page' => $per_page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that invalid 'offset' query should error.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_invalid_offset_should_error
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_invalid_offset_should_error() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page        = 2;
+		$offset          = 'moreplease';
+		$expected_error  = 'rest_invalid_param';
+		$expected_status = 400;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => $offset,
+				'per_page' => $per_page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected_error, $response, $expected_status );
+	}
+
+	/**
+	 * Tests that out of bounds 'page' query should not error when offset is provided,
+	 * because it takes precedence.
+	 *
+	 * Duplicate of WP_Test_REST_Revisions_Controller::test_get_items_out_of_bounds_page_should_not_error_if_offset
+	 *
+	 * @ticket 58524
+	 *
+	 * @covers WP_REST_Global_Styles_Controller::get_items
+	 */
+	public function test_get_items_out_of_bounds_page_should_not_error_if_offset() {
+		wp_set_current_user( self::$admin_id );
+
+		$per_page       = 2;
+		$total_pages    = (int) ceil( $this->total_revisions / $per_page );
+		$page           = $total_pages + 1; // Out of bound page.
+		$expected_count = 2;
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id . '/revisions' );
+		$request->set_query_params(
+			array(
+				'offset'   => 1,
+				'per_page' => $per_page,
+				'page'     => $page,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertCount( $expected_count, $response->get_data() );
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_context_param() {
+		// Controller does not implement test_context_param().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_get_item() {
+		// Controller does not implement get_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
+}
diff --git a/tests/rest-api/rest-navigation-fallback-controller.php b/tests/rest-api/rest-navigation-fallback-controller.php
new file mode 100644
index 0000000000..43111020e2
--- /dev/null
+++ b/tests/rest-api/rest-navigation-fallback-controller.php
@@ -0,0 +1,244 @@
+<?php
+/**
+ * Unit tests covering WP_REST_Navigation_Fallback_Controller functionality.
+ *
+ * Note: that these tests are designed to provide high level coverage only. The majority of the tests
+ * are made directly against the WP_Navigation_Fallback class as this:
+ *
+ * - is where the bulk of the logic is.
+ * - is also consumed by the Navigation block's server side rendering.
+ *
+ * @package WordPress
+ * @subpackage REST API
+ *
+ * @covers WP_REST_Navigation_Fallback_Controller
+ */
+
+/**
+ * @group restapi
+ * @group navigation
+ */
+class WP_REST_Navigation_Fallback_Controller_Test extends WP_Test_REST_Controller_Testcase {
+
+	protected static $admin_user;
+	protected static $editor_user;
+
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$admin_user = $factory->user->create( array( 'role' => 'administrator' ) );
+
+		self::$editor_user = $factory->user->create( array( 'role' => 'editor' ) );
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		wp_set_current_user( self::$admin_user );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller::register_routes
+	 *
+	 * @since 6.3.0 Added Navigation Fallbacks endpoint.
+	 */
+	public function test_register_routes() {
+		$routes = rest_get_server()->get_routes();
+
+		$this->assertArrayHasKey( '/wp-block-editor/v1/navigation-fallback', $routes, 'Fallback route should be registered.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller
+	 *
+	 * @since 6.3.0 Added Navigation Fallbacks endpoint.
+	 */
+	public function test_should_not_return_menus_for_users_without_permissions() {
+
+		wp_set_current_user( self::$editor_user );
+
+		$request  = new WP_REST_Request( 'GET', '/wp-block-editor/v1/navigation-fallback' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertEquals( 403, $response->get_status(), 'Response should indicate user does not have permission.' );
+
+		$this->assertEquals( 'rest_cannot_create', $data['code'], 'Response should indicate user cannot create.' );
+
+		$this->assertEquals( 'Sorry, you are not allowed to create Navigation Menus as this user.', $data['message'], 'Response should indicate failed request status.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller
+	 *
+	 * @since 6.3.0 Added Navigation Fallbacks endpoint.
+	 */
+	public function test_get_item() {
+
+		$request  = new WP_REST_Request( 'GET', '/wp-block-editor/v1/navigation-fallback' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertEquals( 200, $response->get_status(), 'Status should indicate successful request.' );
+
+		$this->assertIsArray( $data, 'Response should be of correct type.' );
+
+		$this->assertArrayHasKey( 'id', $data, 'Response should contain expected fields.' );
+
+		$this->assertEquals( 'wp_navigation', get_post_type( $data['id'] ), '"id" field should represent a post of type "wp_navigation"' );
+
+		// Check that only a single Navigation fallback was created.
+		$navs_in_db = $this->get_navigations_in_database();
+
+		$this->assertCount( 1, $navs_in_db, 'Only a single Navigation menu should be present in the database.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller
+	 *
+	 * @since 6.3.0 Added Navigation Fallbacks endpoint.
+	 */
+	public function test_get_item_schema() {
+		$request  = new WP_REST_Request( 'OPTIONS', '/wp-block-editor/v1/navigation-fallback' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertEquals( 200, $response->get_status(), 'Status should indicate successful request.' );
+
+		$this->assertArrayHasKey( 'schema', $data, '"schema" key should exist in response.' );
+
+		$schema = $data['schema'];
+
+		$this->assertEquals( 'object', $schema['type'], 'The schema type should match the expected type.' );
+
+		$this->assertArrayHasKey( 'id', $schema['properties'], 'Schema should have an "id" property.' );
+		$this->assertEquals( 'integer', $schema['properties']['id']['type'], 'Schema "id" property should be an integer.' );
+		$this->assertTrue( $schema['properties']['id']['readonly'], 'Schema "id" property should be readonly.' );
+	}
+
+	/**
+	 * @ticket 58557
+	 * @covers WP_REST_Navigation_Fallback_Controller
+	 *
+	 * @since 6.3.0 Added Navigation Fallbacks endpoint.
+	 */
+	public function test_adds_links() {
+		$request  = new WP_REST_Request( 'GET', '/wp-block-editor/v1/navigation-fallback' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$navigation_post_id = $data['id'];
+
+		$links = $response->get_links();
+
+		$this->assertNotEmpty( $links, 'Response should contain links.' );
+
+		$this->assertArrayHasKey( 'self', $links, 'Response should contain a "self" link.' );
+
+		$this->assertStringContainsString( 'wp/v2/navigation/' . $navigation_post_id, $links['self'][0]['href'], 'Self link should reference the correct Navigation Menu post resource url.' );
+
+		$this->assertTrue( $links['self'][0]['attributes']['embeddable'], 'Self link should be embeddable.' );
+	}
+
+	/**
+	 * Tests that the correct filters are applied to the context parameter.
+	 *
+	 * By default, the REST response for the Posts Controller will not return all fields
+	 * when the context is set to 'embed'. Assert that correct additional fields are added
+	 * to the embedded Navigation Post, when the navigation fallback endpoint
+	 * is called with the `_embed` param.
+	 *
+	 * @ticket 58557
+	 *
+	 * @covers ::wp_add_fields_to_navigation_fallback_embedded_links
+	 *
+	 * @since 6.3.0 Added Navigation Fallbacks endpoint.
+	 */
+	public function test_embedded_navigation_post_contains_required_fields() {
+		// First we'll use the navigation fallback to get a link to the navigation endpoint.
+		$request  = new WP_REST_Request( 'GET', '/wp-block-editor/v1/navigation-fallback' );
+		$response = rest_get_server()->dispatch( $request );
+		$links    = $response->get_links();
+
+		// Extract the navigation endpoint URL from the response.
+		$embedded_navigation_href = $links['self'][0]['href'];
+		preg_match( '/\?rest_route=(.*)/', $embedded_navigation_href, $matches );
+		$navigation_endpoint = $matches[1];
+
+		// Fetch the "linked" navigation post from the endpoint, with the context parameter set to 'embed' to simulate fetching embedded links.
+		$request = new WP_REST_Request( 'GET', $navigation_endpoint );
+		$request->set_param( 'context', 'embed' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		// Verify that the additional status field is present.
+		$this->assertArrayHasKey( 'status', $data, 'Response title should contain a "status" field.' );
+
+		// Verify that the additional content fields are present.
+		$this->assertArrayHasKey( 'content', $data, 'Response should contain a "content" field.' );
+		$this->assertArrayHasKey( 'raw', $data['content'], 'Response content should contain a "raw" field.' );
+		$this->assertArrayHasKey( 'rendered', $data['content'], 'Response content should contain a "rendered" field.' );
+		$this->assertArrayHasKey( 'block_version', $data['content'], 'Response should contain a "block_version" field.' );
+
+		// Verify that the additional title.raw field is present.
+		$this->assertArrayHasKey( 'raw', $data['title'], 'Response title should contain a "raw" key.' );
+	}
+
+	private function get_navigations_in_database() {
+		$navs_in_db = new WP_Query(
+			array(
+				'post_type'      => 'wp_navigation',
+				'post_status'    => 'publish',
+				'posts_per_page' => -1,
+				'orderby'        => 'date',
+				'order'          => 'DESC',
+			)
+		);
+
+		return $navs_in_db->posts ? $navs_in_db->posts : array();
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_prepare_item() {
+		// Covered by the core test.
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_context_param() {
+		// Covered by the core test.
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_get_items() {
+		// Covered by the core test.
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
+}
diff --git a/tests/rest-api/rest-pages-controller.php b/tests/rest-api/rest-pages-controller.php
index 9900c5a003..75c005b275 100644
--- a/tests/rest-api/rest-pages-controller.php
+++ b/tests/rest-api/rest-pages-controller.php
@@ -787,5 +787,4 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$args['type'] = 'page';
 		return $args;
 	}
-
 }
diff --git a/tests/rest-api/rest-pattern-directory-controller.php b/tests/rest-api/rest-pattern-directory-controller.php
index 77b99af76b..eda42beebe 100644
--- a/tests/rest-api/rest-pattern-directory-controller.php
+++ b/tests/rest-api/rest-pattern-directory-controller.php
@@ -310,7 +310,7 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		// Test that filter changes uncached values.
 		add_filter(
 			'rest_prepare_block_pattern',
-			static function( $response ) {
+			static function ( $response ) {
 				return 'initial value';
 			}
 		);
@@ -324,7 +324,7 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		// Test that filter changes cached values (the previous request primed the cache).
 		add_filter(
 			'rest_prepare_block_pattern',
-			static function( $response ) {
+			static function ( $response ) {
 				return 'modified the cache';
 			},
 			11
@@ -653,7 +653,6 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		} else {
 			$this->assertNotSame( $result_1, $result_2, $message );
 		}
-
 	}
 
 	/**
diff --git a/tests/rest-api/rest-plugins-controller.php b/tests/rest-api/rest-plugins-controller.php
index 1375c81061..1da20c8315 100644
--- a/tests/rest-api/rest-plugins-controller.php
+++ b/tests/rest-api/rest-plugins-controller.php
@@ -537,7 +537,7 @@ class WP_REST_Plugins_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		wp_set_current_user( self::$super_admin );
 		add_filter(
 			'pre_http_request',
-			static function() {
+			static function () {
 				/*
 				 * Mocks the request to:
 				 * https://api.wordpress.org/plugins/info/1.2/?action=plugin_information&request%5Bslug%5D=alex-says-this-block-definitely-doesnt-exist&request%5Bfields%5D%5Bsections%5D=0&request%5Bfields%5D%5Blanguage_packs%5D=1&request%5Blocale%5D=en_US&request%5Bwp_version%5D=5.9
diff --git a/tests/rest-api/rest-post-meta-fields.php b/tests/rest-api/rest-post-meta-fields.php
index 3c627dfd59..dcf39f59c9 100644
--- a/tests/rest-api/rest-post-meta-fields.php
+++ b/tests/rest-api/rest-post-meta-fields.php
@@ -17,7 +17,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 			'cpt',
 			array(
 				'show_in_rest' => true,
-				'supports'     => array( 'custom-fields' ),
+				'supports'     => array( 'custom-fields', 'revisions' ),
 			)
 		);
 
@@ -157,7 +157,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 			'cpt',
 			array(
 				'show_in_rest' => true,
-				'supports'     => array( 'custom-fields' ),
+				'supports'     => array( 'custom-fields', 'revisions' ),
 			)
 		);
 
@@ -1376,8 +1376,6 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 	 * @dataProvider data_update_value_return_success_with_same_value
 	 */
 	public function test_update_value_return_success_with_same_value( $meta_key, $meta_value ) {
-		add_post_meta( self::$post_id, $meta_key, $meta_value );
-
 		$this->grant_write_permission();
 
 		$data = array(
@@ -1392,6 +1390,12 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 		$response = rest_get_server()->dispatch( $request );
 
 		$this->assertSame( 200, $response->get_status() );
+
+		// Verify the returned meta value is correct.
+		$data = $response->get_data();
+		$this->assertArrayHasKey( 'meta', $data );
+		$this->assertArrayHasKey( $meta_key, $data['meta'] );
+		$this->assertSame( $meta_value, $data['meta'][ $meta_key ] );
 	}
 
 	public function data_update_value_return_success_with_same_value() {
@@ -2299,6 +2303,42 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 		$this->assertSame( array( 'project' => 'WordCamp' ), $data['meta']['object'] );
 	}
 
+	/**
+	 * @ticket 57745
+	 */
+	public function test_update_meta_with_unchanged_values_and_custom_authentication() {
+		register_post_meta(
+			'post',
+			'authenticated',
+			array(
+				'single'        => true,
+				'type'          => 'boolean',
+				'default'       => false,
+				'show_in_rest'  => true,
+				'auth_callback' => '__return_false',
+			)
+		);
+
+		add_post_meta( self::$post_id, 'authenticated', false );
+
+		$this->grant_write_permission();
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'authenticated' => false,
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		$data = $response->get_data();
+		$this->assertSame( false, $data['meta']['authenticated'] );
+	}
+
 	/**
 	 * @ticket 43392
 	 */
@@ -2706,7 +2746,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 				'single'            => true,
 				'type'              => 'boolean',
 				'show_in_rest'      => true,
-				'sanitize_callback' => static function( $value ) {
+				'sanitize_callback' => static function ( $value ) {
 					return $value ? '1' : '0';
 				},
 			)
@@ -3076,4 +3116,358 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 		}
 		return $query;
 	}
+
+
+	/**
+	 * Test that single post meta is revisioned when saving to the posts REST API endpoint.
+	 *
+	 * @ticket 20564
+	 */
+	public function test_revisioned_single_post_meta_with_posts_endpoint() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'foo',
+			array(
+				'single'            => true,
+				'show_in_rest'      => true,
+				'revisions_enabled' => true,
+			)
+		);
+
+		$post_id = self::$post_id;
+
+		// Update the post, saving the meta.
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 1',
+				'meta'  => array(
+					'foo' => 'bar',
+				),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions   = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+		$revision_id = array_shift( $revisions )->ID;
+
+		// @todo Ensure the revisions endpoint returns the correct meta values
+		// Check that the revisions endpoint returns the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d/revisions/%d', $post_id, $revision_id ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+		$data = $response->get_data();
+		$this->assertSame( 'bar', $response->get_data()['meta']['foo'] );
+
+		// Check that the post meta is set correctly.
+		$this->assertSame( 'bar', get_post_meta( $revision_id, 'foo', true ) );
+
+		// Create two more revisions with different meta values for the foo key.
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 2',
+				'meta'  => array(
+					'foo' => 'baz',
+				),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions     = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+		$revision_id_2 = array_shift( $revisions )->ID;
+
+		// Check that the revision has the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d/revisions/%d', $post_id, $revision_id_2 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSame( 'baz', $response->get_data()['meta']['foo'] );
+
+		// Check that the post meta is set correctly.
+		$this->assertSame( 'baz', get_post_meta( $revision_id_2, 'foo', true ) );
+
+		// One more revision!
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 3',
+				'meta'  => array(
+					'foo' => 'qux',
+				),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions     = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+		$revision_id_3 = array_shift( $revisions )->ID;
+
+		// Check that the revision has the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d/revisions/%d', $post_id, $revision_id_3 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSame( 'qux', $response->get_data()['meta']['foo'] );
+
+		// Check that the post meta is set correctly.
+		$this->assertSame( 'qux', get_post_meta( $revision_id_3, 'foo', true ) );
+
+		// Restore Revision 3 and verify the post gets the correct meta value.
+		wp_restore_post_revision( $revision_id_3 );
+		$this->assertSame( 'qux', get_post_meta( $post_id, 'foo', true ) );
+
+		// Restore Revision 2 and verify the post gets the correct meta value.
+		wp_restore_post_revision( $revision_id_2 );
+		$this->assertSame( 'baz', get_post_meta( $post_id, 'foo', true ) );
+	}
+
+	/**
+	 * Test that multi-post meta is revisioned when saving to the posts REST API endpoint.
+	 *
+	 * @ticket 20564
+	 */
+	public function test_revisioned_multiple_post_meta_with_posts_endpoint() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'foo',
+			array(
+				'single'            => false,
+				'show_in_rest'      => true,
+				'revisions_enabled' => true,
+			)
+		);
+
+		$post_id = self::$post_id;
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 1',
+				'meta'  => array(
+					'foo' => array(
+						'bar',
+						'bat',
+						'baz',
+					),
+				),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Log the current post meta.
+		$meta = get_post_meta( $post_id );
+
+		// Update the post.
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 1 update',
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions     = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+		$revision_id_1 = array_shift( $revisions )->ID;
+
+		// Check that the revision has the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d/revisions/%d', $post_id, $revision_id_1 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		$this->assertSame(
+			array( 'bar', 'bat', 'baz' ),
+			$response->get_data()['meta']['foo']
+		);
+		$this->assertSame(
+			array( 'bar', 'bat', 'baz' ),
+			get_post_meta( $revision_id_1, 'foo' )
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 2',
+				'meta'  => array(
+					'foo' => array(
+						'car',
+						'cat',
+					),
+				),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions     = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+		$revision_id_2 = array_shift( $revisions )->ID;
+
+		// Check that the revision has the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d/revisions/%d', $post_id, $revision_id_2 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		$this->assertSame(
+			array( 'car', 'cat' ),
+			$response->get_data()['meta']['foo']
+		);
+		$this->assertSame( array( 'car', 'cat' ), get_post_meta( $revision_id_2, 'foo' ) );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 3',
+				'meta'  => array(
+					'foo' => null,
+				),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions     = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+		$revision_id_3 = array_shift( $revisions )->ID;
+
+		// Check that the revision has the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d/revisions/%d', $post_id, $revision_id_3 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		$this->assertSame(
+			array(),
+			$response->get_data()['meta']['foo']
+		);
+		$this->assertSame( array(), get_post_meta( $revision_id_3, 'foo' ) );
+
+		// Restore Revision 3 and verify the post gets the correct meta value.
+		wp_restore_post_revision( $revision_id_3 );
+		$this->assertSame( array(), get_post_meta( $post_id, 'foo' ) );
+
+		// Restore Revision 2 and verify the post gets the correct meta value.
+		wp_restore_post_revision( $revision_id_2 );
+		$this->assertSame( array( 'car', 'cat' ), get_post_meta( $post_id, 'foo' ) );
+	}
+
+	/**
+	 * Test post meta revisions with a custom post type and the page post type.
+	 *
+	 * @group revision
+	 * @dataProvider data_revisioned_single_post_meta_with_posts_endpoint_page_and_cpt_data_provider
+	 */
+	public function test_revisioned_single_post_meta_with_posts_endpoint_page_and_cpt( $passed, $expected, $post_type ) {
+
+		$this->grant_write_permission();
+
+		// Create the custom meta.
+		register_post_meta(
+			$post_type,
+			'foo',
+			array(
+				'show_in_rest'      => true,
+				'revisions_enabled' => true,
+				'single'            => true,
+				'type'              => 'string',
+			)
+		);
+
+		// Set up a new post.
+		$post_id = $this->factory->post->create(
+			array(
+				'post_content' => 'initial content',
+				'post_type'    => $post_type,
+				'meta_input'   => array(
+					'foo' => 'foo',
+				),
+			)
+		);
+
+		$plural_mapping = array(
+			'page' => 'pages',
+			'cpt'  => 'cpt',
+		);
+		$request        = new WP_REST_Request( 'GET', sprintf( '/wp/v2/%s', $plural_mapping[ $post_type ] ) );
+
+		$response = rest_get_server()->dispatch( $request );
+
+		$request = new WP_REST_Request( 'POST', sprintf( '/wp/v2/%s/%d', $plural_mapping[ $post_type ], $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 1',
+				'meta'  => array(
+					'foo' => $passed,
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Update the post.
+		$request = new WP_REST_Request( 'POST', sprintf( '/wp/v2/%s/%d', $plural_mapping[ $post_type ], $post_id ) );
+		$request->set_body_params(
+			array(
+				'title' => 'Revision 1 update',
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		// Get the last revision.
+		$revisions = wp_get_post_revisions( $post_id, array( 'posts_per_page' => 1 ) );
+
+		$revision_id_1 = array_shift( $revisions )->ID;
+
+		// Check that the revision has the correct meta value.
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/%s/%d/revisions/%d', $plural_mapping[ $post_type ], $post_id, $revision_id_1 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status() );
+
+		$this->assertSame(
+			$passed,
+			$response->get_data()['meta']['foo']
+		);
+
+		$this->assertSame(
+			array( $passed ),
+			get_post_meta( $revision_id_1, 'foo' )
+		);
+
+		unregister_post_meta( $post_type, 'foo' );
+		wp_delete_post( $post_id, true );
+	}
+
+	/**
+	 * Provide data for the meta revision checks.
+	 */
+	public function data_revisioned_single_post_meta_with_posts_endpoint_page_and_cpt_data_provider() {
+		return array(
+			array(
+				'Test string',
+				'Test string',
+				'cpt',
+			),
+			array(
+				'Test string',
+				'Test string',
+				'page',
+			),
+			array(
+				'Test string',
+				false,
+				'cpt',
+			),
+		);
+	}
 }
diff --git a/tests/rest-api/rest-post-statuses-controller.php b/tests/rest-api/rest-post-statuses-controller.php
index 366e596459..f6bb1d795a 100644
--- a/tests/rest-api/rest-post-statuses-controller.php
+++ b/tests/rest-api/rest-post-statuses-controller.php
@@ -225,5 +225,4 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 		$obj  = get_post_status_object( 'publish' );
 		$this->check_post_status_obj( $obj, $data, $response->get_links() );
 	}
-
 }
diff --git a/tests/rest-api/rest-post-types-controller.php b/tests/rest-api/rest-post-types-controller.php
index 1c2a0b53b4..c902aefbd3 100644
--- a/tests/rest-api/rest-post-types-controller.php
+++ b/tests/rest-api/rest-post-types-controller.php
@@ -36,7 +36,7 @@ class WP_Test_REST_Post_Types_Controller extends WP_Test_REST_Controller_Testcas
 
 		$data       = $response->get_data();
 		$post_types = get_post_types( array( 'show_in_rest' => true ), 'objects' );
-		$this->assertSame( count( $post_types ), count( $data ) );
+		$this->assertCount( count( $post_types ), $data );
 		$this->assertSame( $post_types['post']->name, $data['post']['slug'] );
 		$this->check_post_type_obj( 'view', $post_types['post'], $data['post'], $data['post']['_links'] );
 		$this->assertSame( $post_types['page']->name, $data['page']['slug'] );
@@ -263,5 +263,4 @@ class WP_Test_REST_Post_Types_Controller extends WP_Test_REST_Controller_Testcas
 		$obj  = get_post_type_object( $post_type );
 		$this->check_post_type_obj( $context, $obj, $data, $response->get_links() );
 	}
-
 }
diff --git a/tests/rest-api/rest-posts-controller.php b/tests/rest-api/rest-posts-controller.php
index 353325fc81..3b58464295 100644
--- a/tests/rest-api/rest-posts-controller.php
+++ b/tests/rest-api/rest-posts-controller.php
@@ -1662,8 +1662,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		// 3rd page.
 		self::factory()->post->create();
-		$total_posts++;
-		$total_pages++;
+		++$total_posts;
+		++$total_pages;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$request->set_param( 'page', 3 );
 		$response = rest_get_server()->dispatch( $request );
@@ -2278,8 +2278,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_prepare_item_filters_content_when_needed() {
 		$filter_count   = 0;
-		$filter_content = static function() use ( &$filter_count ) {
-			$filter_count++;
+		$filter_content = static function () use ( &$filter_count ) {
+			++$filter_count;
 			return '<p>Filtered content.</p>';
 		};
 		add_filter( 'the_content', $filter_content );
@@ -2314,8 +2314,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_prepare_item_skips_content_filter_if_not_needed() {
 		$filter_count   = 0;
-		$filter_content = static function() use ( &$filter_count ) {
-			$filter_count++;
+		$filter_content = static function () use ( &$filter_count ) {
+			++$filter_count;
 			return '<p>Filtered content.</p>';
 		};
 		add_filter( 'the_content', $filter_content );
@@ -4302,7 +4302,6 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$routes = rest_get_server()->get_routes();
 		$this->assertArrayNotHasKey( '/wp/v2/invalid-controller', $routes );
 		_unregister_post_type( 'invalid-controller' );
-
 	}
 
 	public function test_get_item_schema() {
@@ -5028,7 +5027,6 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertSame( 200, $response->get_status() );
 		$this->assertArrayNotHasKey( 'permalink_template', $data );
 		$this->assertArrayNotHasKey( 'generated_slug', $data );
-
 	}
 
 	/**
diff --git a/tests/rest-api/rest-request-validation.php b/tests/rest-api/rest-request-validation.php
index 4444fb6065..3d81536099 100644
--- a/tests/rest-api/rest-request-validation.php
+++ b/tests/rest-api/rest-request-validation.php
@@ -202,5 +202,4 @@ class WP_Test_REST_Request_Validation extends WP_Test_REST_TestCase {
 		$ret = rest_validate_request_arg( 9, $request, 'lessthanmax' );
 		$this->assertTrue( $ret );
 	}
-
 }
diff --git a/tests/rest-api/rest-revisions-controller.php b/tests/rest-api/rest-revisions-controller.php
index e0b713c882..74cd040d85 100644
--- a/tests/rest-api/rest-revisions-controller.php
+++ b/tests/rest-api/rest-revisions-controller.php
@@ -179,6 +179,7 @@ class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase
 			'modified_gmt',
 			'guid',
 			'id',
+			'meta',
 			'parent',
 			'slug',
 			'title',
@@ -335,7 +336,7 @@ class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertCount( 12, $properties );
+		$this->assertCount( 13, $properties );
 		$this->assertArrayHasKey( 'author', $properties );
 		$this->assertArrayHasKey( 'content', $properties );
 		$this->assertArrayHasKey( 'date', $properties );
@@ -348,6 +349,7 @@ class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertArrayHasKey( 'parent', $properties );
 		$this->assertArrayHasKey( 'slug', $properties );
 		$this->assertArrayHasKey( 'title', $properties );
+		$this->assertArrayHasKey( 'meta', $properties );
 	}
 
 	public function test_create_item() {
diff --git a/tests/rest-api/rest-schema-setup.php b/tests/rest-api/rest-schema-setup.php
index f3efbb5305..dfd98877d8 100644
--- a/tests/rest-api/rest-schema-setup.php
+++ b/tests/rest-api/rest-schema-setup.php
@@ -134,6 +134,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp/v2/comments',
 			'/wp/v2/comments/(?P<id>[\\d]+)',
 			'/wp/v2/global-styles/(?P<id>[\/\w-]+)',
+			'/wp/v2/global-styles/(?P<parent>[\d]+)/revisions',
 			'/wp/v2/global-styles/themes/(?P<stylesheet>[\/\s%\w\.\(\)\[\]\@_\-]+)/variations',
 			'/wp/v2/global-styles/themes/(?P<stylesheet>[^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)',
 			'/wp/v2/search',
@@ -185,6 +186,8 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp-site-health/v1/tests/authorization-header',
 			'/wp-site-health/v1/tests/page-cache',
 			'/wp-site-health/v1/directory-sizes',
+			'/wp/v2/wp_pattern_category',
+			'/wp/v2/wp_pattern_category/(?P<id>[\d]+)',
 		);
 
 		$this->assertSameSets( $expected_routes, $routes );
diff --git a/tests/rest-api/rest-search-controller.php b/tests/rest-api/rest-search-controller.php
index 2e39d385d9..7345d45f86 100644
--- a/tests/rest-api/rest-search-controller.php
+++ b/tests/rest-api/rest-search-controller.php
@@ -888,5 +888,4 @@ class WP_Test_REST_Search_Controller extends WP_Test_REST_Controller_Testcase {
 			wp_list_pluck( $response->get_data(), 'id' )
 		);
 	}
-
 }
diff --git a/tests/rest-api/rest-server.php b/tests/rest-api/rest-server.php
index 3a7bf78353..6432026697 100644
--- a/tests/rest-api/rest-server.php
+++ b/tests/rest-api/rest-server.php
@@ -937,7 +937,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 	 * @ticket 56566
 	 */
 	public function test_link_embedding_returning_wp_error() {
-		$return_wp_error = function() {
+		$return_wp_error = static function () {
 			return new WP_Error( 'some-error', 'This is not valid!' );
 		};
 		add_filter( 'rest_pre_dispatch', $return_wp_error );
@@ -1119,6 +1119,59 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertArrayHasKey( 'site_icon_url', $data );
 	}
 
+	/**
+	 * @ticket 57902
+	 *
+	 * @covers WP_REST_Server::get_index
+	 */
+	public function test_get_index_fields_name() {
+		$server = new WP_REST_Server();
+
+		$request = new WP_REST_Request( 'GET', '/' );
+		$request->set_param( '_fields', 'name' );
+		$index = $server->dispatch( $request );
+		$index = rest_filter_response_fields( $index, $server, $request );
+		$data  = $index->get_data();
+		$links = $index->get_links();
+
+		$this->assertArrayHasKey( 'name', $data );
+		$this->assertArrayNotHasKey( 'help', $links );
+	}
+
+	/**
+	 * @ticket 57902
+	 *
+	 * @covers WP_REST_Server::get_index
+	 *
+	 * @dataProvider data_get_index_should_return_help_and_not_name
+	 *
+	 * @param string $field The field to add to the request.
+	 */
+	public function test_get_index_should_return_help_and_not_name( $field ) {
+		$server = new WP_REST_Server();
+
+		$request = new WP_REST_Request( 'GET', '/' );
+		$request->set_param( '_fields', $field );
+		$index = $server->dispatch( $request );
+		$index = rest_filter_response_fields( $index, $server, $request );
+		$data  = $index->get_data();
+		$links = $index->get_links();
+
+		$this->assertArrayNotHasKey( 'name', $data );
+		$this->assertArrayHasKey( 'help', $links );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @throws Exception
+	 *
+	 * @return array
+	 */
+	public function data_get_index_should_return_help_and_not_name() {
+		return self::text_array_to_dataprovider( array( '_links', '_embedded' ) );
+	}
+
 	/**
 	 * @ticket 50152
 	 */
@@ -1261,7 +1314,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 
 		$result = json_decode( rest_get_server()->sent_body );
 
-		$this->assertObjectNotHasAttribute( 'code', $result );
+		$this->assertObjectNotHasProperty( 'code', $result );
 	}
 
 	public function test_link_header_on_requests() {
@@ -1671,7 +1724,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 			'/test',
 			array(
 				'methods'             => array( 'GET' ),
-				'callback'            => static function() {
+				'callback'            => static function () {
 					return new WP_REST_Response( 'data', 204 );
 				},
 				'permission_callback' => '__return_true',
@@ -1682,7 +1735,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 			'/test',
 			array(
 				'methods'             => array( 'GET' ),
-				'callback'            => static function() {
+				'callback'            => static function () {
 					return new WP_REST_Response( 'data', 204 );
 				},
 				'permission_callback' => '__return_true',
@@ -2080,7 +2133,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 	public function test_batch_v1_max_requests() {
 		add_filter(
 			'rest_get_max_batch_size',
-			static function() {
+			static function () {
 				return 5;
 			}
 		);
@@ -2188,7 +2241,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 			array(
 				array(
 					'methods'             => \WP_REST_Server::READABLE,
-					'callback'            => function() {
+					'callback'            => static function () {
 						return new \WP_REST_Response( INF );
 					},
 					'permission_callback' => '__return_true',
@@ -2200,6 +2253,36 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertSame( 500, rest_get_server()->status );
 	}
 
+	/**
+	 * @ticket 57752
+	 */
+	public function test_rest_exposed_cors_headers_filter_receives_request_object() {
+		$mock_hook = new MockAction();
+		add_filter( 'rest_exposed_cors_headers', array( $mock_hook, 'filter' ), 10, 2 );
+
+		rest_get_server()->serve_request( '/test-exposed-cors-headers' );
+
+		$this->assertCount( 1, $mock_hook->get_events() );
+		$this->assertCount( 2, $mock_hook->get_events()[0]['args'] );
+		$this->assertInstanceOf( 'WP_REST_Request', $mock_hook->get_events()[0]['args'][1] );
+		$this->assertSame( '/test-exposed-cors-headers', $mock_hook->get_events()[0]['args'][1]->get_route() );
+	}
+
+	/**
+	 * @ticket 57752
+	 */
+	public function test_rest_allowed_cors_headers_filter_receives_request_object() {
+		$mock_hook = new MockAction();
+		add_filter( 'rest_allowed_cors_headers', array( $mock_hook, 'filter' ), 10, 2 );
+
+		rest_get_server()->serve_request( '/test-allowed-cors-headers' );
+
+		$this->assertCount( 1, $mock_hook->get_events() );
+		$this->assertCount( 2, $mock_hook->get_events()[0]['args'] );
+		$this->assertInstanceOf( 'WP_REST_Request', $mock_hook->get_events()[0]['args'][1] );
+		$this->assertSame( '/test-allowed-cors-headers', $mock_hook->get_events()[0]['args'][1]->get_route() );
+	}
+
 	public function _validate_as_integer_123( $value, $request, $key ) {
 		if ( ! is_int( $value ) ) {
 			return new WP_Error( 'some-error', 'This is not valid!' );
diff --git a/tests/rest-api/rest-sidebars-controller.php b/tests/rest-api/rest-sidebars-controller.php
index 8210d916f3..0bddf12df9 100644
--- a/tests/rest-api/rest-sidebars-controller.php
+++ b/tests/rest-api/rest-sidebars-controller.php
@@ -311,7 +311,6 @@ class WP_Test_REST_Sidebars_Controller extends WP_Test_REST_Controller_Testcase
 			),
 			$data
 		);
-
 	}
 
 	/**
@@ -1013,7 +1012,7 @@ class WP_Test_REST_Sidebars_Controller extends WP_Test_REST_Controller_Testcase
 			if ( isset( $item['_links'] ) ) {
 				unset( $data[ $count ]['_links'] );
 			}
-			$count++;
+			++$count;
 		}
 
 		return $data;
diff --git a/tests/rest-api/rest-tags-controller.php b/tests/rest-api/rest-tags-controller.php
index 6c96987627..843faadea3 100644
--- a/tests/rest-api/rest-tags-controller.php
+++ b/tests/rest-api/rest-tags-controller.php
@@ -415,7 +415,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$i = 0;
 		foreach ( $tags as $tag ) {
 			$this->assertSame( $tag['name'], "Tag {$i}" );
-			$i++;
+			++$i;
 		}
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
@@ -430,7 +430,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 		foreach ( $tags as $tag ) {
 			$this->assertSame( $tag['name'], "Tag {$i}" );
-			$i++;
+			++$i;
 		}
 	}
 
@@ -599,8 +599,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 		// 3rd page.
 		self::factory()->tag->create();
-		$total_tags++;
-		$total_pages++;
+		++$total_tags;
+		++$total_pages;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'page', 3 );
 		$response = rest_get_server()->dispatch( $request );
@@ -1336,8 +1336,6 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 38504
 	 */
 	public function test_object_term_queries_are_cached() {
-		global $wpdb;
-
 		$tags = self::factory()->tag->create_many( 2 );
 		$p    = self::factory()->post->create();
 		wp_set_object_terms( $p, $tags[0], 'post_tag' );
@@ -1349,7 +1347,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 		unset( $request, $response );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'post', $p );
@@ -1357,7 +1355,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$found_2  = wp_list_pluck( $response->data, 'id' );
 
 		$this->assertSameSets( $found_1, $found_2 );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -1411,7 +1409,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 			'hide_empty' => false,
 		);
 		$tags = get_terms( 'post_tag', $args );
-		$this->assertSame( count( $tags ), count( $data ) );
+		$this->assertCount( count( $tags ), $data );
 		$this->assertSame( $tags[0]->term_id, $data[0]['id'] );
 		$this->assertSame( $tags[0]->name, $data[0]['name'] );
 		$this->assertSame( $tags[0]->slug, $data[0]['slug'] );
diff --git a/tests/rest-api/rest-taxonomies-controller.php b/tests/rest-api/rest-taxonomies-controller.php
index 6da465be25..86ad0daf35 100644
--- a/tests/rest-api/rest-taxonomies-controller.php
+++ b/tests/rest-api/rest-taxonomies-controller.php
@@ -50,7 +50,7 @@ class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcas
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$taxonomies = $this->get_public_taxonomies( get_taxonomies( '', 'objects' ) );
-		$this->assertSame( count( $taxonomies ), count( $data ) );
+		$this->assertCount( count( $taxonomies ), $data );
 		$this->assertSame( 'Categories', $data['category']['name'] );
 		$this->assertSame( 'category', $data['category']['slug'] );
 		$this->assertTrue( $data['category']['hierarchical'] );
@@ -69,7 +69,7 @@ class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcas
 		$taxonomies = get_taxonomies( '', 'objects' );
 		unset( $taxonomies['nav_menu'] ); // Menus are not editable by contributors.
 		$taxonomies = $this->get_public_taxonomies( $taxonomies );
-		$this->assertSame( count( $taxonomies ), count( $data ) );
+		$this->assertCount( count( $taxonomies ), $data );
 		$this->assertSame( 'Categories', $data['category']['name'] );
 		$this->assertSame( 'category', $data['category']['slug'] );
 		$this->assertTrue( $data['category']['hierarchical'] );
@@ -286,7 +286,7 @@ class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcas
 		$this->assertSame( 200, $response->get_status() );
 		$data       = $response->get_data();
 		$taxonomies = $this->get_public_taxonomies( get_object_taxonomies( $type, 'objects' ) );
-		$this->assertSame( count( $taxonomies ), count( $data ) );
+		$this->assertCount( count( $taxonomies ), $data );
 	}
 
 	/**
@@ -316,5 +316,4 @@ class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcas
 			get_taxonomy( 'test' )->get_rest_controller()
 		);
 	}
-
 }
diff --git a/tests/rest-api/rest-test-controller.php b/tests/rest-api/rest-test-controller.php
index 042f37cf8b..48b326407d 100644
--- a/tests/rest-api/rest-test-controller.php
+++ b/tests/rest-api/rest-test-controller.php
@@ -180,5 +180,4 @@ class WP_REST_Test_Controller extends WP_REST_Controller {
 
 		return $this->add_additional_fields_schema( $schema );
 	}
-
 }
diff --git a/tests/rest-api/rest-themes-controller.php b/tests/rest-api/rest-themes-controller.php
index 995b11f51d..24b564debb 100644
--- a/tests/rest-api/rest-themes-controller.php
+++ b/tests/rest-api/rest-themes-controller.php
@@ -172,6 +172,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 			'author',
 			'author_uri',
 			'description',
+			'is_block_theme',
 			'name',
 			'requires_php',
 			'requires_wp',
@@ -185,6 +186,8 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 			'theme_uri',
 			'version',
 		);
+		$this->assertIsArray( $data );
+		$this->assertNotEmpty( $data );
 		$this->assertSameSets( $fields, array_keys( $data[0] ) );
 	}
 
@@ -208,6 +211,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 			'author',
 			'author_uri',
 			'description',
+			'is_block_theme',
 			'name',
 			'requires_php',
 			'requires_wp',
@@ -220,6 +224,8 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 			'theme_uri',
 			'version',
 		);
+		$this->assertIsArray( $data );
+		$this->assertNotEmpty( $data );
 		$this->assertSameSets( $fields, array_keys( $data[0] ) );
 
 		$this->assertContains( 'twentytwenty', wp_list_pluck( $data, 'stylesheet' ) );
@@ -343,7 +349,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 		$response   = self::perform_active_theme_request( 'OPTIONS' );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertCount( 15, $properties );
+		$this->assertCount( 16, $properties );
 
 		$this->assertArrayHasKey( 'author', $properties );
 		$this->assertArrayHasKey( 'raw', $properties['author']['properties'] );
@@ -357,6 +363,8 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertArrayHasKey( 'raw', $properties['description']['properties'] );
 		$this->assertArrayHasKey( 'rendered', $properties['description']['properties'] );
 
+		$this->assertArrayHasKey( 'is_block_theme', $properties );
+
 		$this->assertArrayHasKey( 'name', $properties );
 		$this->assertArrayHasKey( 'raw', $properties['name']['properties'] );
 		$this->assertArrayHasKey( 'rendered', $properties['name']['properties'] );
@@ -471,6 +479,27 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertSame( '5.3', $result[0]['requires_wp'] );
 	}
 
+	/**
+	 * @ticket 58123
+	 * @covers WP_REST_Themes_Controller::prepare_item_for_response
+	 */
+	public function test_theme_is_block_theme() {
+		// Test classic theme, activated in test setup.
+		$response = self::perform_active_theme_request();
+		$result   = $response->get_data();
+
+		$this->assertArrayHasKey( 'is_block_theme', $result[0] );
+		$this->assertFalse( $result[0]['is_block_theme'] );
+
+		// Test block theme.
+		switch_theme( 'block-theme' );
+		$response = self::perform_active_theme_request();
+		$result   = $response->get_data();
+
+		$this->assertArrayHasKey( 'is_block_theme', $result[0] );
+		$this->assertTrue( $result[0]['is_block_theme'] );
+	}
+
 	/**
 	 * @ticket 49906
 	 */
@@ -1234,6 +1263,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 			'author',
 			'author_uri',
 			'description',
+			'is_block_theme',
 			'name',
 			'requires_php',
 			'requires_wp',
@@ -1384,7 +1414,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 			'wp/v2',
 			sprintf( '/themes/(?P<stylesheet>%s)//test', WP_REST_Themes_Controller::PATTERN ),
 			array(
-				'callback'            => function ( WP_REST_Request $request ) {
+				'callback'            => static function ( WP_REST_Request $request ) {
 					return $request['stylesheet'];
 				},
 				'permission_callback' => '__return_true',
diff --git a/tests/rest-api/rest-users-controller.php b/tests/rest-api/rest-users-controller.php
index 8373f8d200..f4dbc2d57f 100644
--- a/tests/rest-api/rest-users-controller.php
+++ b/tests/rest-api/rest-users-controller.php
@@ -339,8 +339,8 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 
 		// 3rd page.
 		self::factory()->user->create();
-		$total_users++;
-		$total_pages++;
+		++$total_users;
+		++$total_pages;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'page', 3 );
 		$response = rest_get_server()->dispatch( $request );
@@ -632,7 +632,6 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
 		$this->assertCount( 0, $data );
-
 	}
 
 	public function test_get_items_exclude_query() {
@@ -2701,7 +2700,6 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertArrayHasKey( 'url', $properties );
 		$this->assertArrayHasKey( 'username', $properties );
 		$this->assertArrayHasKey( 'roles', $properties );
-
 	}
 
 	public function test_get_item_schema_show_avatar() {
diff --git a/tests/rest-api/rest-widget-types-controller.php b/tests/rest-api/rest-widget-types-controller.php
index e9b46d444f..cac586447e 100644
--- a/tests/rest-api/rest-widget-types-controller.php
+++ b/tests/rest-api/rest-widget-types-controller.php
@@ -161,7 +161,7 @@ class WP_Test_REST_Widget_Types_Controller extends WP_Test_REST_Controller_Testc
 		$data         = $response->get_data();
 		$text_widgets = array_filter(
 			$data,
-			static function( $widget ) {
+			static function ( $widget ) {
 				return 'text' === $widget['id'];
 			}
 		);
@@ -189,7 +189,7 @@ class WP_Test_REST_Widget_Types_Controller extends WP_Test_REST_Controller_Testc
 		wp_register_sidebar_widget(
 			$widget_id,
 			'WP legacy widget',
-			static function() {}
+			static function () {}
 		);
 		wp_set_current_user( self::$admin_id );
 		$request     = new WP_REST_Request( 'GET', '/wp/v2/widget-types/' . $widget_id );
@@ -220,7 +220,7 @@ class WP_Test_REST_Widget_Types_Controller extends WP_Test_REST_Controller_Testc
 		wp_register_sidebar_widget(
 			$widget_id,
 			'&#8216;Legacy &#8209; Archive &#8209; Widget&#8217;',
-			static function() {},
+			static function () {},
 			array(
 				'description' => '&#8220;A great &amp; interesting archive of your site&#8217;s posts!&#8221;',
 			)
diff --git a/tests/rest-api/rest-widgets-controller.php b/tests/rest-api/rest-widgets-controller.php
index 22516737c3..69672a7226 100644
--- a/tests/rest-api/rest-widgets-controller.php
+++ b/tests/rest-api/rest-widgets-controller.php
@@ -1551,7 +1551,7 @@ class WP_Test_REST_Widgets_Controller extends WP_Test_REST_Controller_Testcase {
 			if ( is_array( $item ) && isset( $item['_links'] ) ) {
 				unset( $data[ $count ]['_links'] );
 			}
-			$count++;
+			++$count;
 		}
 
 		return $data;
diff --git a/tests/rest-api/wpRestBlockPatternCategoriesController.php b/tests/rest-api/wpRestBlockPatternCategoriesController.php
index 77481112a0..63c2256b36 100644
--- a/tests/rest-api/wpRestBlockPatternCategoriesController.php
+++ b/tests/rest-api/wpRestBlockPatternCategoriesController.php
@@ -65,7 +65,7 @@ class Tests_REST_WpRestBlockPatternCategoriesController extends WP_Test_REST_Con
 		self::$registry_instance_property = new ReflectionProperty( 'WP_Block_Pattern_Categories_Registry', 'instance' );
 		self::$registry_instance_property->setAccessible( true );
 		$test_registry = new WP_Block_Pattern_Categories_Registry();
-		self::$registry_instance_property->setValue( $test_registry );
+		self::$registry_instance_property->setValue( null, $test_registry );
 
 		// Register some categories in the test registry.
 		$test_registry->register(
@@ -88,7 +88,7 @@ class Tests_REST_WpRestBlockPatternCategoriesController extends WP_Test_REST_Con
 		self::delete_user( self::$admin_id );
 
 		// Restore the original registry instance.
-		self::$registry_instance_property->setValue( self::$orig_registry );
+		self::$registry_instance_property->setValue( null, self::$orig_registry );
 		self::$registry_instance_property->setAccessible( false );
 		self::$registry_instance_property = null;
 		self::$orig_registry              = null;
diff --git a/tests/rest-api/wpRestBlockPatternsController.php b/tests/rest-api/wpRestBlockPatternsController.php
index 319eb20bab..2dc3bb83a3 100644
--- a/tests/rest-api/wpRestBlockPatternsController.php
+++ b/tests/rest-api/wpRestBlockPatternsController.php
@@ -65,7 +65,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 		self::$registry_instance_property = new ReflectionProperty( 'WP_Block_Patterns_Registry', 'instance' );
 		self::$registry_instance_property->setAccessible( true );
 		$test_registry = new WP_Block_Pattern_Categories_Registry();
-		self::$registry_instance_property->setValue( $test_registry );
+		self::$registry_instance_property->setValue( null, $test_registry );
 
 		// Register some patterns in the test registry.
 		$test_registry->register(
@@ -76,6 +76,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 				'viewportWidth' => 1440,
 				'categories'    => array( 'test' ),
 				'templateTypes' => array( 'page' ),
+				'source'        => 'theme',
 			)
 		);
 
@@ -86,6 +87,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 				'content'       => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
 				'categories'    => array( 'test' ),
 				'templateTypes' => array( 'single' ),
+				'source'        => 'core',
 			)
 		);
 
@@ -95,6 +97,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 				'title'      => 'Pattern Three',
 				'content'    => '<!-- wp:paragraph --><p>Three</p><!-- /wp:paragraph -->',
 				'categories' => array( 'test', 'buttons', 'query' ),
+				'source'     => 'pattern-directory/featured',
 			)
 		);
 	}
@@ -103,7 +106,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 		self::delete_user( self::$admin_id );
 
 		// Restore the original registry instance.
-		self::$registry_instance_property->setValue( self::$orig_registry );
+		self::$registry_instance_property->setValue( null, self::$orig_registry );
 		self::$registry_instance_property->setAccessible( false );
 		self::$registry_instance_property = null;
 		self::$orig_registry              = null;
@@ -124,7 +127,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 		wp_set_current_user( self::$admin_id );
 
 		$request            = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
-		$request['_fields'] = 'name,content,template_types';
+		$request['_fields'] = 'name,content,source,template_types';
 		$response           = rest_get_server()->dispatch( $request );
 		$data               = $response->get_data();
 
@@ -135,6 +138,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 				'name'           => 'test/one',
 				'content'        => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
 				'template_types' => array( 'page' ),
+				'source'         => 'theme',
 			),
 			$data[0],
 			'WP_REST_Block_Patterns_Controller::get_items() should return test/one'
@@ -144,6 +148,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 				'name'           => 'test/two',
 				'content'        => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
 				'template_types' => array( 'single' ),
+				'source'         => 'core',
 			),
 			$data[1],
 			'WP_REST_Block_Patterns_Controller::get_items() should return test/two'
diff --git a/tests/rest-api/wpRestMenuItemsController.php b/tests/rest-api/wpRestMenuItemsController.php
index 4687700cc7..285da9cd48 100644
--- a/tests/rest-api/wpRestMenuItemsController.php
+++ b/tests/rest-api/wpRestMenuItemsController.php
@@ -743,7 +743,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertSame( 18, count( $properties ) );
+		$this->assertCount( 18, $properties );
 		$this->assertArrayHasKey( 'type_label', $properties );
 		$this->assertArrayHasKey( 'attr_title', $properties );
 		$this->assertArrayHasKey( 'classes', $properties );
@@ -918,7 +918,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 			foreach ( $taxonomies as $taxonomy ) {
 				$this->assertSame( $taxonomy->name, $links['https://api.w.org/term'][ $num ]['attributes']['taxonomy'] );
 				$this->assertSame( add_query_arg( 'post', $data['id'], rest_url( 'wp/v2/' . $taxonomy->rest_base ) ), $links['https://api.w.org/term'][ $num ]['href'] );
-				$num++;
+				++$num;
 			}
 
 			if ( 'post_type' === $data['type'] ) {
diff --git a/tests/rest-api/wpRestMenuLocationsController.php b/tests/rest-api/wpRestMenuLocationsController.php
index a2f7df075d..b324ce23c7 100644
--- a/tests/rest-api/wpRestMenuLocationsController.php
+++ b/tests/rest-api/wpRestMenuLocationsController.php
@@ -181,7 +181,7 @@ class Tests_REST_WpRestMenuLocationsController extends WP_Test_REST_Controller_T
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertSame( 3, count( $properties ) );
+		$this->assertCount( 3, $properties );
 		$this->assertArrayHasKey( 'name', $properties );
 		$this->assertArrayHasKey( 'description', $properties );
 		$this->assertArrayHasKey( 'menu', $properties );
diff --git a/tests/rest-api/wpRestMenusController.php b/tests/rest-api/wpRestMenusController.php
index 09de72bb87..58780ca200 100644
--- a/tests/rest-api/wpRestMenusController.php
+++ b/tests/rest-api/wpRestMenusController.php
@@ -338,7 +338,7 @@ class Tests_REST_WpRestMenusController extends WP_Test_REST_Controller_Testcase
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertSame( 7, count( $properties ) );
+		$this->assertCount( 7, $properties );
 		$this->assertArrayHasKey( 'id', $properties );
 		$this->assertArrayHasKey( 'description', $properties );
 		$this->assertArrayHasKey( 'meta', $properties );
@@ -573,7 +573,7 @@ class Tests_REST_WpRestMenusController extends WP_Test_REST_Controller_Testcase
 			'hide_empty' => false,
 		);
 		$tags = get_terms( self::TAXONOMY, $args );
-		$this->assertSame( count( $tags ), count( $data ) );
+		$this->assertCount( count( $tags ), $data );
 		$this->assertSame( $tags[0]->term_id, $data[0]['id'] );
 		$this->assertSame( $tags[0]->name, $data[0]['name'] );
 		$this->assertSame( $tags[0]->slug, $data[0]['slug'] );
diff --git a/tests/rest-api/wpRestTemplatesController.php b/tests/rest-api/wpRestTemplatesController.php
index 811767444d..266ca89a33 100644
--- a/tests/rest-api/wpRestTemplatesController.php
+++ b/tests/rest-api/wpRestTemplatesController.php
@@ -118,6 +118,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => true,
 				'author'         => 0,
+				'modified'       => mysql_to_rfc3339( self::$post->post_modified ),
 			),
 			$this->find_and_normalize_template_by_id( $data, 'default//my_template' )
 		);
@@ -162,6 +163,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => true,
 				'author'         => 0,
+				'modified'       => mysql_to_rfc3339( self::$post->post_modified ),
 			),
 			$data
 		);
@@ -198,6 +200,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => true,
 				'author'         => 0,
+				'modified'       => mysql_to_rfc3339( self::$post->post_modified ),
 			),
 			$data
 		);
@@ -257,6 +260,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => true,
 				'author'         => self::$admin_id,
+				'modified'       => mysql_to_rfc3339( $post->post_modified ),
 			),
 			$data
 		);
@@ -413,6 +417,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
+		$modified = get_post( $data['wp_id'] )->post_modified;
 		unset( $data['_links'] );
 		unset( $data['wp_id'] );
 
@@ -436,6 +441,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => true,
 				'author'         => self::$admin_id,
+				'modified'       => mysql_to_rfc3339( $modified ),
 			),
 			$data
 		);
@@ -459,6 +465,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
+		$modified = get_post( $data['wp_id'] )->post_modified;
 		unset( $data['_links'] );
 		unset( $data['wp_id'] );
 
@@ -482,6 +489,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => false,
 				'author'         => self::$admin_id,
+				'modified'       => mysql_to_rfc3339( $modified ),
 			),
 			$data
 		);
@@ -509,6 +517,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
+		$modified = get_post( $data['wp_id'] )->post_modified;
 		unset( $data['_links'] );
 		unset( $data['wp_id'] );
 
@@ -532,6 +541,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 				'has_theme_file' => false,
 				'is_custom'      => true,
 				'author'         => self::$admin_id,
+				'modified'       => mysql_to_rfc3339( $modified ),
 			),
 			$data
 		);
@@ -690,7 +700,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertCount( 14, $properties );
+		$this->assertCount( 15, $properties );
 		$this->assertArrayHasKey( 'id', $properties );
 		$this->assertArrayHasKey( 'description', $properties );
 		$this->assertArrayHasKey( 'slug', $properties );
@@ -706,6 +716,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		$this->assertArrayHasKey( 'has_theme_file', $properties );
 		$this->assertArrayHasKey( 'is_custom', $properties );
 		$this->assertArrayHasKey( 'author', $properties );
+		$this->assertArrayHasKey( 'modified', $properties );
 	}
 
 	protected function find_and_normalize_template_by_id( $templates, $id ) {
@@ -736,8 +747,10 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/templates' );
 		$request->set_body_params( $body_params );
-		$response = rest_get_server()->dispatch( $request );
-		$data     = $response->get_data();
+		$response             = rest_get_server()->dispatch( $request );
+		$data                 = $response->get_data();
+		$modified             = get_post( $data['wp_id'] )->post_modified;
+		$expected['modified'] = mysql_to_rfc3339( $modified );
 		unset( $data['_links'] );
 		unset( $data['wp_id'] );
 
@@ -824,5 +837,52 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		$request->set_param( 'template_prefix', 'page' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertSame( 'page', $response->get_data()['slug'], 'Should fallback to `page.html`.' );
+		// Should fallback to `index.html`.
+		$request->set_param( 'slug', 'author' );
+		$request->set_param( 'ignore_empty', true );
+		$request->set_param( 'template_prefix', 'tag' );
+		$request->set_param( 'is_custom', false );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 'index', $response->get_data()['slug'], 'Should fallback to `index.html` when  ignore_empty is `true`.' );
+	}
+
+	/**
+	 * @ticket 57851
+	 *
+	 * @covers WP_REST_Templates_Controller::prepare_item_for_database
+	 */
+	public function test_prepare_item_for_database() {
+		$endpoint = new WP_REST_Templates_Controller( 'wp_template_part' );
+
+		$prepare_item_for_database = new ReflectionMethod( $endpoint, 'prepare_item_for_database' );
+		$prepare_item_for_database->setAccessible( true );
+
+		$body_params = array(
+			'title'   => 'Untitled Template Part',
+			'slug'    => 'untitled-template-part',
+			'content' => '',
+		);
+
+		$request = new WP_REST_Request( 'POST', '/wp/v2/template-parts' );
+		$request->set_body_params( $body_params );
+
+		$prepared = $prepare_item_for_database->invoke( $endpoint, $request );
+
+		$this->assertInstanceOf( 'stdClass', $prepared, 'The item could not be prepared for the database.' );
+
+		$this->assertObjectHasProperty( 'post_type', $prepared, 'The "post_type" was not included in the prepared template part.' );
+		$this->assertObjectHasProperty( 'post_status', $prepared, 'The "post_status" was not included in the prepared template part.' );
+		$this->assertObjectHasProperty( 'tax_input', $prepared, 'The "tax_input" was not included in the prepared template part.' );
+		$this->assertArrayHasKey( 'wp_theme', $prepared->tax_input, 'The "wp_theme" tax was not included in the prepared template part.' );
+		$this->assertArrayHasKey( 'wp_template_part_area', $prepared->tax_input, 'The "wp_template_part_area" tax was not included in the prepared template part.' );
+		$this->assertObjectHasProperty( 'post_content', $prepared, 'The "post_content" was not included in the prepared template part.' );
+		$this->assertObjectHasProperty( 'post_title', $prepared, 'The "post_title" was not included in the prepared template part.' );
+
+		$this->assertSame( 'wp_template_part', $prepared->post_type, 'The "post_type" in the prepared template part should be "wp_template_part".' );
+		$this->assertSame( 'publish', $prepared->post_status, 'The post status in the prepared template part should be "publish".' );
+		$this->assertSame( WP_TEMPLATE_PART_AREA_UNCATEGORIZED, $prepared->tax_input['wp_template_part_area'], 'The area in the prepared template part should be uncategorized.' );
+		$this->assertSame( 'Untitled Template Part', $prepared->post_title, 'The title was not correct in the prepared template part.' );
+
+		$this->assertEmpty( $prepared->post_content, 'The content was not correct in the prepared template part.' );
 	}
 }
diff --git a/tests/rest-api/wpRestUrlDetailsController.php b/tests/rest-api/wpRestUrlDetailsController.php
index 24cc517365..27f526f9d2 100644
--- a/tests/rest-api/wpRestUrlDetailsController.php
+++ b/tests/rest-api/wpRestUrlDetailsController.php
@@ -284,7 +284,6 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 
 		$expected = strtolower( 'Unable to retrieve body from response at this URL' );
 		$this->assertStringContainsString( $expected, strtolower( $data['message'] ), 'Response "message" does not contain "' . $expected . '"' );
-
 	}
 
 	/**
@@ -297,7 +296,7 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 
 		add_filter(
 			'rest_url_details_http_request_args',
-			static function( $args, $url ) {
+			static function ( $args, $url ) {
 				return array_merge(
 					$args,
 					array(
@@ -340,7 +339,7 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 		// Force cache to return a known value as the remote URL http response body.
 		add_filter(
 			"pre_site_transient_{$transient_name}",
-			static function() {
+			static function () {
 				return '<html><head><title>This value from cache.</title></head><body></body></html>';
 			}
 		);
@@ -368,7 +367,7 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 	public function test_allows_filtering_data_retrieved_for_a_given_url() {
 		add_filter(
 			'rest_prepare_url_details',
-			static function( $response ) {
+			static function ( $response ) {
 
 				$data = $response->get_data();
 
@@ -382,7 +381,6 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 				);
 
 				return $response;
-
 			}
 		);
 
@@ -419,7 +417,7 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 		 */
 		add_filter(
 			'rest_prepare_url_details',
-			static function( $response, $url ) {
+			static function ( $response, $url ) {
 				return new WP_REST_Response(
 					array(
 						'status'        => 418,
diff --git a/tests/rewrite/addRewriteEndpoint.php b/tests/rewrite/addRewriteEndpoint.php
index 0c4c7a332d..7b3ada5feb 100644
--- a/tests/rewrite/addRewriteEndpoint.php
+++ b/tests/rewrite/addRewriteEndpoint.php
@@ -108,5 +108,4 @@ class Tests_Rewrite_AddRewriteEndpoint extends WP_UnitTestCase {
 		$this->assertTrue( is_404() );
 		$this->assertSame( '', get_query_var( 'page_endpoint' ) );
 	}
-
 }
diff --git a/tests/robots.php b/tests/robots.php
index 87b0e6fb90..356224e79b 100644
--- a/tests/robots.php
+++ b/tests/robots.php
@@ -39,7 +39,7 @@ class Tests_Robots extends WP_UnitTestCase {
 	public function test_wp_robots_parses_directives_correctly() {
 		add_filter(
 			'wp_robots',
-			static function( array $robots ) {
+			static function ( array $robots ) {
 				// Directives that should have values must use strings.
 				$robots['directive-with-value']         = 'yes';
 				$robots['directive-with-numeric-value'] = '1';
diff --git a/tests/shortcode.php b/tests/shortcode.php
index 1c19cfb42d..e8aa82c5a8 100644
--- a/tests/shortcode.php
+++ b/tests/shortcode.php
@@ -781,7 +781,6 @@ EOF;
 
 		$js = str_replace( "\'", "'", $matches[1] );
 		$this->assertSame( $php, $js );
-
 	}
 
 	/**
diff --git a/tests/sitemaps/wpSitemapsUsers.php b/tests/sitemaps/wpSitemapsUsers.php
index d52e191835..eae9c03b27 100644
--- a/tests/sitemaps/wpSitemapsUsers.php
+++ b/tests/sitemaps/wpSitemapsUsers.php
@@ -2,6 +2,8 @@
 
 /**
  * @group sitemaps
+ *
+ * @coversDefaultClass WP_Sitemaps_Users
  */
 class Tests_Sitemaps_wpSitemapsUsers extends WP_UnitTestCase {
 
@@ -10,14 +12,14 @@ class Tests_Sitemaps_wpSitemapsUsers extends WP_UnitTestCase {
 	 *
 	 * @var array
 	 */
-	public static $users;
+	private static $users;
 
 	/**
 	 * Editor ID for use in some tests.
 	 *
 	 * @var int
 	 */
-	public static $editor_id;
+	private static $editor_id;
 
 	/**
 	 * Set up fixtures.
@@ -32,6 +34,8 @@ class Tests_Sitemaps_wpSitemapsUsers extends WP_UnitTestCase {
 	/**
 	 * Test getting a URL list for a users sitemap page via
 	 * WP_Sitemaps_Users::get_url_list().
+	 *
+	 * @covers ::get_url_list
 	 */
 	public function test_get_url_list_users() {
 		// Set up the user to an editor to assign posts to other users.
@@ -40,7 +44,7 @@ class Tests_Sitemaps_wpSitemapsUsers extends WP_UnitTestCase {
 		// Create a set of posts for each user and generate the expected URL list data.
 		$expected = array_map(
 			static function ( $user_id ) {
-				$post = self::factory()->post->create_and_get( array( 'post_author' => $user_id ) );
+				self::factory()->post->create( array( 'post_author' => $user_id ) );
 
 				return array(
 					'loc' => get_author_posts_url( $user_id ),
@@ -55,4 +59,34 @@ class Tests_Sitemaps_wpSitemapsUsers extends WP_UnitTestCase {
 
 		$this->assertSameSets( $expected, $url_list );
 	}
+
+	/**
+	 * @covers ::get_url_list
+	 * @covers ::get_users_query_args
+	 */
+	public function test_get_url_list_skips_users_with_only_attachments_and_pages() {
+		// Set up the user to an editor to assign posts to other users.
+		wp_set_current_user( self::$editor_id );
+
+		foreach ( self::$users as $user_id ) {
+			self::factory()->post->create(
+				array(
+					'post_author' => $user_id,
+					'post_type'   => 'attachment',
+				)
+			);
+			self::factory()->post->create(
+				array(
+					'post_author' => $user_id,
+					'post_type'   => 'page',
+				)
+			);
+		}
+
+		$user_provider = new WP_Sitemaps_Users();
+
+		$url_list = $user_provider->get_url_list( 1 );
+
+		$this->assertEmpty( $url_list );
+	}
 }
diff --git a/tests/style-engine/styleEngine.php b/tests/style-engine/styleEngine.php
index 616c332095..b1a01563c2 100644
--- a/tests/style-engine/styleEngine.php
+++ b/tests/style-engine/styleEngine.php
@@ -25,6 +25,8 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 	 * Tests generating block styles and classnames based on various manifestations of the $block_styles argument.
 	 *
 	 * @ticket 56467
+	 * @ticket 58549
+	 * @ticket 58590
 	 *
 	 * @covers ::wp_style_engine_get_styles
 	 *
@@ -181,6 +183,19 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 				),
 			),
 
+			'inline_valid_shadow_style'                    => array(
+				'block_styles'    => array(
+					'shadow' => 'inset 5em 1em gold',
+				),
+				'options'         => null,
+				'expected_output' => array(
+					'css'          => 'box-shadow:inset 5em 1em gold;',
+					'declarations' => array(
+						'box-shadow' => 'inset 5em 1em gold',
+					),
+				),
+			),
+
 			'inline_valid_typography_style'                => array(
 				'block_styles'    => array(
 					'typography' => array(
@@ -189,6 +204,7 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 						'fontStyle'      => 'italic',
 						'fontWeight'     => '800',
 						'lineHeight'     => '1.3',
+						'textColumns'    => '2',
 						'textDecoration' => 'underline',
 						'textTransform'  => 'uppercase',
 						'letterSpacing'  => '2',
@@ -196,13 +212,14 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 				),
 				'options'         => null,
 				'expected_output' => array(
-					'css'          => 'font-size:clamp(2em, 2vw, 4em);font-family:Roboto,Oxygen-Sans,Ubuntu,sans-serif;font-style:italic;font-weight:800;line-height:1.3;text-decoration:underline;text-transform:uppercase;letter-spacing:2;',
+					'css'          => 'font-size:clamp(2em, 2vw, 4em);font-family:Roboto,Oxygen-Sans,Ubuntu,sans-serif;font-style:italic;font-weight:800;line-height:1.3;column-count:2;text-decoration:underline;text-transform:uppercase;letter-spacing:2;',
 					'declarations' => array(
 						'font-size'       => 'clamp(2em, 2vw, 4em)',
 						'font-family'     => 'Roboto,Oxygen-Sans,Ubuntu,sans-serif',
 						'font-style'      => 'italic',
 						'font-weight'     => '800',
 						'line-height'     => '1.3',
+						'column-count'    => '2',
 						'text-decoration' => 'underline',
 						'text-transform'  => 'uppercase',
 						'letter-spacing'  => '2',
@@ -492,6 +509,25 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 					),
 				),
 			),
+
+			'inline_background_image_url_with_background_size' => array(
+				'block_styles'    => array(
+					'background' => array(
+						'backgroundImage' => array(
+							'url' => 'https://example.com/image.jpg',
+						),
+						'backgroundSize'  => 'cover',
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => "background-image:url('https://example.com/image.jpg');background-size:cover;",
+					'declarations' => array(
+						'background-image' => "url('https://example.com/image.jpg')",
+						'background-size'  => 'cover',
+					),
+				),
+			),
 		);
 	}
 
@@ -637,6 +673,7 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 	/**
 	 * Tests that incoming styles are deduped and merged.
 	 *
+	 * @ticket 58811
 	 * @ticket 56467
 	 *
 	 * @covers ::wp_style_engine_get_stylesheet_from_css_rules
@@ -680,6 +717,6 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 
 		$compiled_stylesheet = wp_style_engine_get_stylesheet_from_css_rules( $css_rules, array( 'prettify' => false ) );
 
-		$this->assertSame( '.gandalf{color:white;height:190px;border-style:dotted;padding:10px;margin-bottom:100px;}.dumbledore,.rincewind{color:grey;height:90px;border-style:dotted;}', $compiled_stylesheet );
+		$this->assertSame( '.gandalf{color:white;height:190px;border-style:dotted;padding:10px;margin-bottom:100px;}.dumbledore{color:grey;height:90px;border-style:dotted;}.rincewind{color:grey;height:90px;border-style:dotted;}', $compiled_stylesheet );
 	}
 }
diff --git a/tests/style-engine/wpStyleEngineProcessor.php b/tests/style-engine/wpStyleEngineProcessor.php
index 46201dab14..d38f46d0de 100644
--- a/tests/style-engine/wpStyleEngineProcessor.php
+++ b/tests/style-engine/wpStyleEngineProcessor.php
@@ -81,16 +81,19 @@ class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
 		$a_wonderful_processor = new WP_Style_Engine_Processor();
 		$a_wonderful_processor->add_rules( array( $a_wonderful_css_rule, $a_very_wonderful_css_rule, $a_more_wonderful_css_rule ) );
 
-		$expected = '.a-more-wonderful-rule {
-	font-family: Wonderful sans;
-	font-size: 1em;
+		$expected = '.a-wonderful-rule {
+	color: var(--wonderful-color);
 	background-color: orange;
 }
-.a-wonderful-rule,
 .a-very_wonderful-rule {
 	color: var(--wonderful-color);
 	background-color: orange;
 }
+.a-more-wonderful-rule {
+	font-family: Wonderful sans;
+	font-size: 1em;
+	background-color: orange;
+}
 ';
 		$this->assertSameIgnoreEOL(
 			$expected,
@@ -184,6 +187,9 @@ class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
 	/**
 	 * Tests printing out 'unoptimized' CSS, that is, uncombined selectors and duplicate CSS rules.
 	 *
+	 * This is the default.
+	 *
+	 * @ticket 58811
 	 * @ticket 56467
 	 *
 	 * @covers ::get_css
@@ -230,11 +236,12 @@ class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
 	/**
 	 * Tests that 'optimized' CSS is output, that is, that duplicate CSS rules are combined under their corresponding selectors.
 	 *
+	 * @ticket 58811
 	 * @ticket 56467
 	 *
 	 * @covers ::get_css
 	 */
-	public function test_should_optimize_css_output_by_default() {
+	public function test_should_not_optimize_css_output_by_default() {
 		$a_sweet_rule = new WP_Style_Engine_CSS_Rule(
 			'.a-sweet-rule',
 			array(
@@ -255,14 +262,15 @@ class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
 		$a_sweet_processor->add_rules( array( $a_sweet_rule, $a_sweeter_rule ) );
 
 		$this->assertSame(
-			'.a-sweet-rule,#an-even-sweeter-rule > marquee{color:var(--sweet-color);background-color:purple;}',
+			'.a-sweet-rule{color:var(--sweet-color);background-color:purple;}#an-even-sweeter-rule > marquee{color:var(--sweet-color);background-color:purple;}',
 			$a_sweet_processor->get_css( array( 'prettify' => false ) )
 		);
 	}
 
 	/**
-	 * Tests that incoming CSS rules are merged with existing CSS rules.
+	 * Tests that incoming CSS rules are optimized and merged with existing CSS rules.
 	 *
+	 * @ticket 58811
 	 * @ticket 56467
 	 *
 	 * @covers ::add_rules
@@ -286,7 +294,12 @@ class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
 
 		$this->assertSame(
 			'.a-lovely-rule,.a-lovelier-rule{border-color:purple;}',
-			$a_lovely_processor->get_css( array( 'prettify' => false ) ),
+			$a_lovely_processor->get_css(
+				array(
+					'prettify' => false,
+					'optimize' => true,
+				)
+			),
 			'Return value of get_css() does not match expectations when combining 2 CSS rules'
 		);
 
@@ -308,7 +321,12 @@ class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
 
 		$this->assertSame(
 			'.a-lovely-rule,.a-lovelier-rule,.a-most-lovely-rule,.a-perfectly-lovely-rule{border-color:purple;}',
-			$a_lovely_processor->get_css( array( 'prettify' => false ) ),
+			$a_lovely_processor->get_css(
+				array(
+					'prettify' => false,
+					'optimize' => true,
+				)
+			),
 			'Return value of get_css() does not match expectations when combining 4 CSS rules'
 		);
 	}
diff --git a/tests/taxonomy.php b/tests/taxonomy.php
index 9b31b573a2..2a4ee3b560 100644
--- a/tests/taxonomy.php
+++ b/tests/taxonomy.php
@@ -12,6 +12,10 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 		$this->assertSame( array( 'link_category' ), get_object_taxonomies( 'link' ) );
 	}
 
+	public function test_get_block_taxonomies() {
+		$this->assertSame( array( 'wp_pattern_category' ), get_object_taxonomies( 'wp_block' ) );
+	}
+
 	/**
 	 * @ticket 5417
 	 */
@@ -119,6 +123,7 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 		$this->assertTrue( taxonomy_exists( 'category' ) );
 		$this->assertTrue( taxonomy_exists( 'post_tag' ) );
 		$this->assertTrue( taxonomy_exists( 'link_category' ) );
+		$this->assertTrue( taxonomy_exists( 'wp_pattern_category' ) );
 	}
 
 	public function test_taxonomy_exists_unknown() {
@@ -284,7 +289,7 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 		// Create a post type to test with.
 		$post_type = 'test_cpt';
 		$this->assertFalse( get_post_type( $post_type ) );
-		$this->assertObjectHasAttribute( 'name', register_post_type( $post_type ) );
+		$this->assertObjectHasProperty( 'name', register_post_type( $post_type ) );
 
 		// Core taxonomy, core post type.
 		$this->assertTrue( unregister_taxonomy_for_object_type( 'category', 'post' ) );
@@ -318,7 +323,6 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 
 		unset( $GLOBALS['wp_taxonomies'][ $tax ] );
 		_unregister_post_type( $post_type );
-
 	}
 
 	/**
diff --git a/tests/template.php b/tests/template.php
index c79082dff3..82505bba8e 100644
--- a/tests/template.php
+++ b/tests/template.php
@@ -629,6 +629,44 @@ class Tests_Template extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Tests that `locate_template()` uses the current theme even after switching the theme.
+	 *
+	 * @ticket 18298
+	 *
+	 * @covers ::locate_template
+	 */
+	public function test_locate_template_uses_current_theme() {
+		$themes = wp_get_themes();
+
+		// Look for parent themes with an index.php template.
+		$relevant_themes = array();
+		foreach ( $themes as $theme ) {
+			if ( $theme->get_stylesheet() !== $theme->get_template() ) {
+				continue;
+			}
+			$php_templates = $theme['Template Files'];
+			if ( ! isset( $php_templates['index.php'] ) ) {
+				continue;
+			}
+			$relevant_themes[] = $theme;
+		}
+		if ( count( $relevant_themes ) < 2 ) {
+			$this->markTestSkipped( 'Test requires at least two parent themes with an index.php template.' );
+		}
+
+		$template_names = array( 'index.php' );
+
+		$old_theme = $relevant_themes[0];
+		$new_theme = $relevant_themes[1];
+
+		switch_theme( $old_theme->get_stylesheet() );
+		$this->assertSame( $old_theme->get_stylesheet_directory() . '/index.php', locate_template( $template_names ), 'Incorrect index template found in initial theme.' );
+
+		switch_theme( $new_theme->get_stylesheet() );
+		$this->assertSame( $new_theme->get_stylesheet_directory() . '/index.php', locate_template( $template_names ), 'Incorrect index template found in theme after switch.' );
+	}
+
 	public function assertTemplateHierarchy( $url, array $expected, $message = '' ) {
 		$this->go_to( $url );
 		$hierarchy = $this->get_template_hierarchy();
@@ -678,5 +716,4 @@ class Tests_Template extends WP_UnitTestCase {
 		$this->hierarchy = array_merge( $this->hierarchy, $hierarchy );
 		return $hierarchy;
 	}
-
 }
diff --git a/tests/term.php b/tests/term.php
index 09235e25b9..2c1e58d2ec 100644
--- a/tests/term.php
+++ b/tests/term.php
@@ -308,4 +308,74 @@ class Tests_Term extends WP_UnitTestCase {
 		$cat_id2 = self::factory()->category->create( array( 'parent' => $cat_id1 ) );
 		$this->assertWPError( $cat_id2 );
 	}
+
+	/**
+	 * @ticket 58329
+	 *
+	 * @covers ::get_term
+	 *
+	 */
+	public function test_get_term_sanitize_once() {
+		$cat_id1 = self::factory()->category->create();
+		$_term   = get_term( $cat_id1, '', OBJECT, 'edit' );
+
+		$filter = new MockAction();
+		add_filter( 'edit_term_slug', array( $filter, 'filter' ) );
+
+		$term = get_term( $_term, '', OBJECT, 'edit' );
+
+		$this->assertSame( 0, $filter->get_call_count(), 'The term was filtered more than once' );
+		$this->assertSame( $_term, $term, 'Both terms should match' );
+	}
+
+	/**
+	 * @ticket 58329
+	 *
+	 * @covers ::get_term
+	 *
+	 * @dataProvider data_get_term_filter
+	 *
+	 * @param string $filter How to sanitize term fields.
+	 */
+	public function test_get_term_should_set_term_filter_property_to_filter_argument( $filter ) {
+		$cat_id1 = self::factory()->category->create();
+
+		$term = get_term( $cat_id1, '', OBJECT, $filter );
+
+		$this->assertSame( $filter, $term->filter, "The term's 'filter' property should be set to '$filter'." );
+	}
+
+	/**
+	 * @ticket 58329
+	 *
+	 * @covers ::get_term
+	 *
+	 * @dataProvider data_get_term_filter
+	 *
+	 * @param string $filter How to sanitize term fields.
+	 */
+	public function test_get_term_filtered( $filter ) {
+		$cat_id1 = self::factory()->category->create();
+		$cat     = self::factory()->category->create_and_get();
+		add_filter(
+			'get_term',
+			static function () use ( $cat ) {
+				return $cat;
+			}
+		);
+
+		$term = get_term( $cat_id1, '', OBJECT, $filter );
+
+		$this->assertSame( $filter, $term->filter, "The term's 'filter' property should be set to '$filter'." );
+		$this->assertSame( $term, $cat, 'The returned term should match the filtered term' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_term_filter() {
+		return self::text_array_to_dataprovider( array( 'edit', 'db', 'display', 'attribute', 'js', 'rss', 'raw' ) );
+	}
 }
diff --git a/tests/term/cache.php b/tests/term/cache.php
index 3a12bc1b04..ac418fbcfd 100644
--- a/tests/term/cache.php
+++ b/tests/term/cache.php
@@ -73,12 +73,12 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 				case 2:
 					$parent    = wp_insert_term( 'Child' . $i, $tax, array( 'parent' => $parent_id ) );
 					$parent_id = $parent['term_id'];
-					$children++;
+					++$children;
 					break;
 				case 3:
 					wp_insert_term( 'Grandchild' . $i, $tax, array( 'parent' => $parent_id ) );
 					$parent_id = 0;
-					$children++;
+					++$children;
 					break;
 			}
 
@@ -93,7 +93,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 			if ( 0 === ( $i % 3 ) ) {
 				$step = 1;
 			} else {
-				$step++;
+				++$step;
 			}
 		}
 
@@ -101,8 +101,6 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_should_update_term_cache_when_passed_an_object() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$term = self::factory()->term->create(
 			array(
@@ -116,7 +114,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		// Affirm that the cache is empty.
 		$this->assertEmpty( wp_cache_get( $term, 'terms' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// get_term() will only be update the cache if the 'filter' prop is unset.
 		unset( $term_object->filter );
@@ -124,13 +122,11 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		$term_object_2 = get_term( $term_object, 'wptests_tax' );
 
 		// No new queries should have fired.
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertSame( $term_object, $term_object_2 );
 	}
 
 	public function test_get_term_should_update_term_cache_when_passed_a_valid_term_identifier() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$term = self::factory()->term->create(
 			array(
@@ -143,23 +139,21 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		// Affirm that the cache is empty.
 		$this->assertEmpty( wp_cache_get( $term, 'terms' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Prime cache.
 		$term_object = get_term( $term, 'wptests_tax' );
 		$this->assertNotEmpty( wp_cache_get( $term, 'terms' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
 		$term_object_2 = get_term( $term, 'wptests_tax' );
 
 		// No new queries should have fired.
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 		$this->assertEquals( $term_object, $term_object_2 );
 	}
 
 	public function test_get_term_by_should_update_term_cache_when_passed_a_valid_term_identifier() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$term = self::factory()->term->create(
 			array(
@@ -172,17 +166,17 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		// Affirm that the cache is empty.
 		$this->assertEmpty( wp_cache_get( $term, 'terms' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Prime cache.
 		$term_object = get_term_by( 'id', $term, 'wptests_tax' );
 		$this->assertNotEmpty( wp_cache_get( $term, 'terms' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
 		$term_object_2 = get_term( $term, 'wptests_tax' );
 
 		// No new queries should have fired.
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 		$this->assertEquals( $term_object, $term_object_2 );
 	}
 
@@ -190,8 +184,6 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	 * @ticket 30749
 	 */
 	public function test_get_terms_should_update_cache_for_located_terms() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 
 		$terms = self::factory()->term->create_many(
@@ -208,13 +200,13 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $term_id ) {
 			get_term( $term_id, 'wptests_tax' );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		_unregister_taxonomy( 'wptests_tax' );
 	}
@@ -242,8 +234,6 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	 * @ticket 21760
 	 */
 	public function test_get_term_by_slug_cache() {
-		global $wpdb;
-
 		$term_id = self::factory()->term->create(
 			array(
 				'slug'     => 'burrito',
@@ -253,28 +243,26 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		);
 
 		clean_term_cache( $term_id, 'post_tag' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$term        = get_term_by( 'slug', 'burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
 		$this->assertSame( 'Taco', $term->name );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// This should now hit cache.
 		$term = get_term_by( 'slug', 'burrito', 'post_tag' );
 		$this->assertSame( 'Taco', $term->name );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		$this->assertEquals( get_term( $term_id, 'post_tag' ), $term );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 21760
 	 */
 	public function test_get_term_by_slug_cache_update() {
-		global $wpdb;
-
 		$term_id = self::factory()->term->create(
 			array(
 				'slug'     => 'burrito',
@@ -284,35 +272,33 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		);
 
 		clean_term_cache( $term_id, 'post_tag' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$term        = get_term_by( 'slug', 'burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
 		$this->assertSame( 'Taco', $term->name );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// This should now hit cache.
 		$term = get_term_by( 'slug', 'burrito', 'post_tag' );
 		$this->assertSame( 'Taco', $term->name );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Update the tag which invalidates the cache.
 		wp_update_term( $term_id, 'post_tag', array( 'name' => 'No Taco' ) );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// This should not hit cache.
 		$term        = get_term_by( 'slug', 'burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
 		$this->assertSame( 'No Taco', $term->name );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 21760
 	 */
 	public function test_get_term_by_name_cache() {
-		global $wpdb;
-
 		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
@@ -322,26 +308,24 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		);
 
 		clean_term_cache( $term_id, 'post_tag' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		get_term_by( 'name', 'Burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// This should now hit cache.
 		$term = get_term_by( 'name', 'Burrito', 'post_tag' );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		$this->assertEquals( get_term( $term_id, 'post_tag' ), $term );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 21760
 	 */
 	public function test_get_term_by_name_cache_update() {
-		global $wpdb;
-
 		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
@@ -351,32 +335,30 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		);
 
 		clean_term_cache( $term_id, 'post_tag' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		get_term_by( 'name', 'Burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// This should now hit cache.
 		get_term_by( 'name', 'Burrito', 'post_tag' );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Update the tag which invalidates the cache.
 		wp_update_term( $term_id, 'post_tag', array( 'slug' => 'taco' ) );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// This should not hit cache.
 		get_term_by( 'name', 'burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 21760
 	 */
 	public function test_invalidating_term_caches_should_fail_when_invalidation_is_suspended() {
-		global $wpdb;
-
 		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
@@ -385,7 +367,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		);
 
 		clean_term_cache( $term_id, 'post_tag' );
-		$num_queries  = $wpdb->num_queries;
+		$num_queries  = get_num_queries();
 		$last_changed = wp_cache_get( 'last_changed', 'terms' );
 
 		$term1       = get_term_by( 'name', 'Burrito', 'post_tag' );
@@ -393,18 +375,18 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 
 		// Verify the term is cached.
 		$term2 = get_term_by( 'name', 'Burrito', 'post_tag' );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertEquals( $term1, $term2 );
 
 		$suspend = wp_suspend_cache_invalidation();
 
 		// Update the tag.
 		wp_update_term( $term_id, 'post_tag', array( 'name' => 'Taco' ) );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Verify that the cached term still matches the initial cached term.
 		$term3 = get_term_by( 'name', 'Burrito', 'post_tag' );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertEquals( $term1, $term3 );
 
 		// Verify that last changed has not been updated as part of an invalidation routine.
@@ -418,8 +400,6 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	 * @ticket 21760
 	 */
 	public function test_get_term_by_does_not_prime_term_meta_cache() {
-		global $wpdb;
-
 		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
@@ -429,18 +409,18 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		add_term_meta( $term_id, 'foo', 'bar' );
 
 		clean_term_cache( $term_id, 'post_tag' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$term        = get_term_by( 'name', 'Burrito', 'post_tag' );
 		$num_queries = $num_queries + 2;
 		$this->assertInstanceOf( 'WP_Term', $term );
 		$this->assertSame( $term_id, $term->term_id );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		$term_meta = get_term_meta( $term_id, 'foo', true );
-		$num_queries++;
+		++$num_queries;
 		$this->assertSame( $term_meta, 'bar' );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/term/getTagLink.php b/tests/term/getTagLink.php
index cd55353b25..bca2f7b91d 100644
--- a/tests/term/getTagLink.php
+++ b/tests/term/getTagLink.php
@@ -5,16 +5,56 @@
  * @covers ::get_tag_link
  */
 class Tests_Term_GetTagLink extends WP_UnitTestCase {
-	public function test_success() {
-		$t = self::factory()->term->create(
+	/**
+	 * Tag ID.
+	 *
+	 * @var int
+	 */
+	public static $tag_id;
+
+	/**
+	 * Test taxonomy term ID.
+	 *
+	 * @var int
+	 */
+	public static $term_id;
+
+	/**
+	 * Set up shared fixtures.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$tag_id = $factory->term->create(
 			array(
 				'taxonomy' => 'post_tag',
-				'slug'     => 'term-slug',
+				'slug'     => 'test-tag',
 			)
 		);
 
-		$found    = get_tag_link( $t );
-		$expected = home_url( '?tag=term-slug' );
+		register_taxonomy( 'wptests_tax', 'post' );
+		self::$term_id = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'slug'     => 'test-term',
+			)
+		);
+	}
+
+	/**
+	 * Set up the test fixture.
+	 */
+	public function set_up() {
+		parent::set_up();
+		// Required as taxonomies are reset between tests.
+		register_taxonomy( 'wptests_tax', 'post' );
+	}
+
+	public function test_success() {
+		$tag_id = self::$tag_id;
+
+		$found    = get_tag_link( $tag_id );
+		$expected = home_url( '?tag=test-tag' );
 
 		$this->assertSame( $expected, $found );
 	}
@@ -23,18 +63,11 @@ class Tests_Term_GetTagLink extends WP_UnitTestCase {
 	 * @ticket 42771
 	 */
 	public function test_should_return_link_for_term_from_another_taxonomy_on_primed_cache() {
-		register_taxonomy( 'wptests_tax', 'post' );
+		$term_id = self::$term_id;
 
-		$t = self::factory()->term->create(
-			array(
-				'taxonomy' => 'wptests_tax',
-				'slug'     => 'test-term',
-			)
-		);
-
-		$term = get_term( $t );
+		$term = get_term( $term_id );
 
-		$found    = get_tag_link( $t );
+		$found    = get_tag_link( $term_id );
 		$expected = home_url( '?wptests_tax=test-term' );
 
 		$this->assertSame( $expected, $found );
@@ -44,18 +77,11 @@ class Tests_Term_GetTagLink extends WP_UnitTestCase {
 	 * @ticket 42771
 	 */
 	public function test_should_return_link_for_term_from_another_taxonomy_on_empty_cache() {
-		register_taxonomy( 'wptests_tax', 'post' );
-
-		$t = self::factory()->term->create(
-			array(
-				'taxonomy' => 'wptests_tax',
-				'slug'     => 'test-term',
-			)
-		);
+		$term_id = self::$term_id;
 
-		clean_term_cache( $t );
+		clean_term_cache( $term_id );
 
-		$found    = get_tag_link( $t );
+		$found    = get_tag_link( $term_id );
 		$expected = home_url( '?wptests_tax=test-term' );
 
 		$this->assertSame( $expected, $found );
diff --git a/tests/term/getTerm.php b/tests/term/getTerm.php
index ec618e190d..ed6acab691 100644
--- a/tests/term/getTerm.php
+++ b/tests/term/getTerm.php
@@ -2,11 +2,44 @@
 
 /**
  * @group taxonomy
+ *
+ * @covers ::get_term
  */
 class Tests_Term_GetTerm extends WP_UnitTestCase {
+	/**
+	 * Shared terms.
+	 *
+	 * @var array[]
+	 */
+	public static $shared_terms = array();
+
+	/**
+	 * Test taxonomy term object.
+	 *
+	 * @var WP_Term
+	 */
+	public static $term;
+
+	/**
+	 * Set up shared fixtures.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		register_taxonomy( 'wptests_tax', 'post' );
+		self::$shared_terms = self::generate_shared_terms();
+
+		self::$term = $factory->term->create_and_get( array( 'taxonomy' => 'wptests_tax' ) );
+	}
+
+	/**
+	 * Set up the test fixtures.
+	 */
 	public function set_up() {
 		parent::set_up();
+		// Required as taxonomies are reset between tests.
 		register_taxonomy( 'wptests_tax', 'post' );
+		register_taxonomy( 'wptests_tax_2', 'post' );
 	}
 
 	/**
@@ -14,35 +47,35 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 *
 	 * @return array Array of term_id/old_term_id/term_taxonomy_id triplets.
 	 */
-	protected function generate_shared_terms() {
+	protected static function generate_shared_terms() {
 		global $wpdb;
 
 		register_taxonomy( 'wptests_tax_2', 'post' );
 
-		$t1 = wp_insert_term( 'Foo', 'wptests_tax' );
-		$t2 = wp_insert_term( 'Foo', 'wptests_tax_2' );
+		$term_1 = wp_insert_term( 'Foo', 'wptests_tax' );
+		$term_2 = wp_insert_term( 'Foo', 'wptests_tax_2' );
 
 		// Manually modify because shared terms shouldn't naturally occur.
 		$wpdb->update(
 			$wpdb->term_taxonomy,
-			array( 'term_id' => $t1['term_id'] ),
-			array( 'term_taxonomy_id' => $t2['term_taxonomy_id'] ),
+			array( 'term_id' => $term_1['term_id'] ),
+			array( 'term_taxonomy_id' => $term_2['term_taxonomy_id'] ),
 			array( '%d' ),
 			array( '%d' )
 		);
 
-		clean_term_cache( $t1['term_id'] );
+		clean_term_cache( $term_1['term_id'] );
 
 		return array(
 			array(
-				'term_id'          => $t1['term_id'],
-				'old_term_id'      => $t1['term_id'],
-				'term_taxonomy_id' => $t1['term_taxonomy_id'],
+				'term_id'          => $term_1['term_id'],
+				'old_term_id'      => $term_1['term_id'],
+				'term_taxonomy_id' => $term_1['term_taxonomy_id'],
 			),
 			array(
-				'term_id'          => $t1['term_id'],
-				'old_term_id'      => $t2['term_id'],
-				'term_taxonomy_id' => $t2['term_taxonomy_id'],
+				'term_id'          => $term_1['term_id'],
+				'old_term_id'      => $term_2['term_id'],
+				'term_taxonomy_id' => $term_2['term_taxonomy_id'],
 			),
 		);
 	}
@@ -60,17 +93,15 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	}
 
 	public function test_passing_term_object_should_skip_database_query_when_filter_property_is_empty() {
-		global $wpdb;
-
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => 'wptests_tax' ) );
+		$term = self::$term;
 		clean_term_cache( $term->term_id, 'wptests_tax' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		unset( $term->filter );
 		$term_a = get_term( $term, 'wptests_tax' );
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	public function test_passing_term_string_that_casts_to_int_0_should_return_null() {
@@ -82,36 +113,34 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	}
 
 	public function test_cache_should_be_populated_by_successful_fetch() {
-		global $wpdb;
-
-		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
-		clean_term_cache( $t, 'wptests_tax' );
+		$term_id = self::$term->term_id;
+		clean_term_cache( $term_id, 'wptests_tax' );
 
 		// Prime cache.
-		$term_a      = get_term( $t, 'wptests_tax' );
-		$num_queries = $wpdb->num_queries;
+		$term_a      = get_term( $term_id, 'wptests_tax' );
+		$num_queries = get_num_queries();
 
 		// Second call shouldn't require a database query.
-		$term_b = get_term( $t, 'wptests_tax' );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$term_b = get_term( $term_id, 'wptests_tax' );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertEquals( $term_a, $term_b );
 	}
 
 	public function test_output_object() {
-		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
-		$this->assertIsObject( get_term( $t, 'wptests_tax', OBJECT ) );
+		$term_id = self::$term->term_id;
+		$this->assertIsObject( get_term( $term_id, 'wptests_tax', OBJECT ) );
 	}
 
 	public function test_output_array_a() {
-		$t    = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
-		$term = get_term( $t, 'wptests_tax', ARRAY_A );
+		$term_id = self::$term->term_id;
+		$term    = get_term( $term_id, 'wptests_tax', ARRAY_A );
 		$this->assertIsArray( $term );
 		$this->assertArrayHasKey( 'term_id', $term );
 	}
 
 	public function test_output_array_n() {
-		$t    = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
-		$term = get_term( $t, 'wptests_tax', ARRAY_N );
+		$term_id = self::$term->term_id;
+		$term    = get_term( $term_id, 'wptests_tax', ARRAY_N );
 		$this->assertIsArray( $term );
 		$this->assertArrayNotHasKey( 'term_id', $term );
 		foreach ( $term as $k => $v ) {
@@ -120,8 +149,8 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	}
 
 	public function test_output_should_fall_back_to_object_for_invalid_input() {
-		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
-		$this->assertIsObject( get_term( $t, 'wptests_tax', 'foo' ) );
+		$term_id = self::$term->term_id;
+		$this->assertIsObject( get_term( $term_id, 'wptests_tax', 'foo' ) );
 	}
 
 	/**
@@ -131,10 +160,10 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	public function test_numeric_properties_should_be_cast_to_ints() {
 		global $wpdb;
 
-		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
+		$term_id = self::$term->term_id;
 
 		// Get raw data from the database.
-		$term_data = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->terms t JOIN $wpdb->term_taxonomy tt ON ( t.term_id = tt.term_id ) WHERE t.term_id = %d", $t ) );
+		$term_data = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->terms t JOIN $wpdb->term_taxonomy tt ON ( t.term_id = tt.term_id ) WHERE t.term_id = %d", $term_id ) );
 
 		$contexts = array( 'raw', 'edit', 'db', 'display', 'rss', 'attribute', 'js' );
 
@@ -154,7 +183,7 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34332
 	 */
 	public function test_should_return_null_when_provided_taxonomy_does_not_match_actual_term_taxonomy() {
-		$term_id = self::factory()->term->create( array( 'taxonomy' => 'post_tag' ) );
+		$term_id = self::$term->term_id;
 		$this->assertNull( get_term( $term_id, 'category' ) );
 	}
 
@@ -162,7 +191,7 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34533
 	 */
 	public function test_should_return_wp_error_when_term_is_shared_and_no_taxonomy_is_specified() {
-		$terms = $this->generate_shared_terms();
+		$terms = self::$shared_terms;
 
 		$found = get_term( $terms[0]['term_id'] );
 
@@ -173,7 +202,7 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34533
 	 */
 	public function test_should_return_term_when_term_is_shared_and_correct_taxonomy_is_specified() {
-		$terms = $this->generate_shared_terms();
+		$terms = self::$shared_terms;
 
 		$found = get_term( $terms[0]['term_id'], 'wptests_tax' );
 
@@ -185,7 +214,7 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34533
 	 */
 	public function test_should_return_null_when_term_is_shared_and_incorrect_taxonomy_is_specified() {
-		$terms = $this->generate_shared_terms();
+		$terms = self::$shared_terms;
 
 		$found = get_term( $terms[0]['term_id'], 'post_tag' );
 
@@ -196,19 +225,17 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34533
 	 */
 	public function test_shared_term_in_cache_should_be_ignored_when_specifying_a_different_taxonomy() {
-		global $wpdb;
-
-		$terms = $this->generate_shared_terms();
+		$terms = self::$shared_terms;
 
 		// Prime cache for 'wptests_tax'.
 		get_term( $terms[0]['term_id'], 'wptests_tax' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Database should be hit again.
 		$found = get_term( $terms[1]['term_id'], 'wptests_tax_2' );
-		$num_queries++;
+		++$num_queries;
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 		$this->assertInstanceOf( 'WP_Term', $found );
 		$this->assertSame( 'wptests_tax_2', $found->taxonomy );
 	}
@@ -217,11 +244,11 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34533
 	 */
 	public function test_should_return_error_when_only_matching_term_is_in_an_invalid_taxonomy() {
-		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
+		$term_id = self::$term->term_id;
 
 		_unregister_taxonomy( 'wptests_tax' );
 
-		$found = get_term( $t );
+		$found = get_term( $term_id );
 		$this->assertWPError( $found );
 		$this->assertSame( 'invalid_taxonomy', $found->get_error_code() );
 	}
@@ -230,7 +257,7 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 	 * @ticket 34533
 	 */
 	public function test_term_should_be_returned_when_id_is_shared_only_with_invalid_taxonomies() {
-		$terms = $this->generate_shared_terms();
+		$terms = self::$shared_terms;
 
 		_unregister_taxonomy( 'wptests_tax' );
 
diff --git a/tests/term/getTermBy.php b/tests/term/getTermBy.php
index 6422e44f0a..32974d13c5 100644
--- a/tests/term/getTermBy.php
+++ b/tests/term/getTermBy.php
@@ -111,8 +111,6 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 	 * @ticket 14162
 	 */
 	public function test_should_prime_term_cache() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$t = self::factory()->term->create(
 			array(
@@ -123,18 +121,18 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 
 		clean_term_cache( $t, 'wptests_tax' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$found       = get_term_by( 'slug', 'foo', 'wptests_tax' );
 		$num_queries = $num_queries + 2;
 
 		$this->assertInstanceOf( 'WP_Term', $found );
 		$this->assertSame( $t, $found->term_id );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// Calls to `get_term()` should now hit cache.
 		$found2 = get_term( $t );
 		$this->assertSame( $t, $found->term_id );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/term/getTermField.php b/tests/term/getTermField.php
index c69044564c..fdcfbdc028 100644
--- a/tests/term/getTermField.php
+++ b/tests/term/getTermField.php
@@ -2,53 +2,72 @@
 
 /**
  * @group taxonomy
+ *
+ * @covers ::get_term_field
  */
 class Tests_Term_getTermField extends WP_UnitTestCase {
 
-	public $taxonomy = 'wptests_tax';
+	public static $taxonomy = 'wptests_tax';
+
+	public static $term;
+
+	/**
+	 * Set up shared fixtures.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		register_taxonomy( self::$taxonomy, 'post' );
+		self::$term = $factory->term->create_and_get(
+			array(
+				'taxonomy'    => self::$taxonomy,
+				'description' => wpautop( 'Test term description' ),
+			)
+		);
+	}
 
 	public function set_up() {
 		parent::set_up();
-
-		register_taxonomy( $this->taxonomy, 'post' );
+		// Required as taxonomies are reset between tests.
+		register_taxonomy( self::$taxonomy, 'post' );
 	}
 
 	/**
 	 * @ticket 34245
 	 */
 	public function test_get_term_field_should_not_return_error_for_empty_taxonomy() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
 		$found = get_term_field( 'taxonomy', $term->term_id, '' );
 		$this->assertNotWPError( $found );
-		$this->assertSame( $this->taxonomy, $found );
+		$this->assertSame( self::$taxonomy, $found );
 	}
 
 	/**
 	 * @ticket 34245
 	 */
 	public function test_get_term_field_supplying_a_taxonomy() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
 		$found = get_term_field( 'taxonomy', $term->term_id, $term->taxonomy );
-		$this->assertSame( $this->taxonomy, $found );
+		$this->assertSame( self::$taxonomy, $found );
 	}
 
 	/**
 	 * @ticket 34245
 	 */
 	public function test_get_term_field_supplying_no_taxonomy() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
 		$found = get_term_field( 'taxonomy', $term->term_id );
-		$this->assertSame( $this->taxonomy, $found );
+		$this->assertSame( self::$taxonomy, $found );
 	}
 
 	/**
 	 * @ticket 34245
 	 */
 	public function test_get_term_field_should_accept_a_WP_Term_id_or_object() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
 		$this->assertInstanceOf( 'WP_Term', $term );
 		$this->assertSame( $term->term_id, get_term_field( 'term_id', $term ) );
@@ -60,7 +79,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	 * @ticket 34245
 	 */
 	public function test_get_term_field_invalid_taxonomy_should_return_WP_Error() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
 		$found = get_term_field( 'taxonomy', $term, 'foo-taxonomy' );
 		$this->assertWPError( $found );
@@ -71,7 +90,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	 * @ticket 34245
 	 */
 	public function test_get_term_field_invalid_term_should_return_WP_Error() {
-		$found = get_term_field( 'taxonomy', 0, $this->taxonomy );
+		$found = get_term_field( 'taxonomy', 0, self::$taxonomy );
 
 		$this->assertWPError( $found );
 		$this->assertSame( 'invalid_term', $found->get_error_code() );
@@ -83,7 +102,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_field_term_id() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
 		$this->assertSame( $term->term_id, get_term_field( 'term_id', $term ) );
 		$this->assertSame( $term->term_id, get_term_field( 'term_id', $term->data ) );
@@ -96,7 +115,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 		$term = self::factory()->term->create_and_get(
 			array(
 				'name'     => $name,
-				'taxonomy' => $this->taxonomy,
+				'taxonomy' => self::$taxonomy,
 			)
 		);
 
@@ -110,7 +129,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 
 		$term = self::factory()->term->create_and_get(
 			array(
-				'taxonomy' => $this->taxonomy,
+				'taxonomy' => self::$taxonomy,
 				'slug'     => $slug,
 			)
 		);
@@ -125,7 +144,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 
 		$term = self::factory()->term->create_and_get(
 			array(
-				'taxonomy' => $this->taxonomy,
+				'taxonomy' => self::$taxonomy,
 				'name'     => $name,
 			)
 		);
@@ -138,7 +157,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	public function test_get_term_field_slug_when_slug_and_name_are_not_set() {
 		$term = self::factory()->term->create_and_get(
 			array(
-				'taxonomy' => $this->taxonomy,
+				'taxonomy' => self::$taxonomy,
 			)
 		);
 
@@ -148,33 +167,28 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_field_taxonomy() {
-		$term = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$term = self::$term;
 
-		$this->assertSame( $this->taxonomy, get_term_field( 'taxonomy', $term ) );
-		$this->assertSame( $this->taxonomy, get_term_field( 'taxonomy', $term->data ) );
-		$this->assertSame( $this->taxonomy, get_term_field( 'taxonomy', $term->term_id ) );
+		$this->assertSame( self::$taxonomy, get_term_field( 'taxonomy', $term ) );
+		$this->assertSame( self::$taxonomy, get_term_field( 'taxonomy', $term->data ) );
+		$this->assertSame( self::$taxonomy, get_term_field( 'taxonomy', $term->term_id ) );
 	}
 
 	public function test_get_term_field_description() {
-		$desc = wpautop( 'baz' );
+		$description = wpautop( 'Test term description' );
 
-		$term = self::factory()->term->create_and_get(
-			array(
-				'taxonomy'    => $this->taxonomy,
-				'description' => $desc,
-			)
-		);
+		$term = self::$term;
 
-		$this->assertSame( $desc, get_term_field( 'description', $term ) );
-		$this->assertSame( $desc, get_term_field( 'description', $term->data ) );
-		$this->assertSame( $desc, get_term_field( 'description', $term->term_id ) );
+		$this->assertSame( $description, get_term_field( 'description', $term ) );
+		$this->assertSame( $description, get_term_field( 'description', $term->data ) );
+		$this->assertSame( $description, get_term_field( 'description', $term->term_id ) );
 	}
 
 	public function test_get_term_field_parent() {
-		$parent = self::factory()->term->create_and_get( array( 'taxonomy' => $this->taxonomy ) );
+		$parent = self::$term;
 		$term   = self::factory()->term->create_and_get(
 			array(
-				'taxonomy' => $this->taxonomy,
+				'taxonomy' => self::$taxonomy,
 				'parent'   => $parent->term_id,
 			)
 		);
diff --git a/tests/term/getTermLink.php b/tests/term/getTermLink.php
index 2a92d8afee..94307ba697 100644
--- a/tests/term/getTermLink.php
+++ b/tests/term/getTermLink.php
@@ -259,7 +259,7 @@ class Tests_Term_GetTermLink extends WP_UnitTestCase {
 
 		add_filter(
 			'term_link',
-			function( $location, $term ) {
+			function ( $location, $term ) {
 				$this->assertInstanceOf( 'WP_Term', $term );
 			},
 			10,
diff --git a/tests/term/getTerms.php b/tests/term/getTerms.php
index 5c0d67f72e..6162b28e38 100644
--- a/tests/term/getTerms.php
+++ b/tests/term/getTerms.php
@@ -134,26 +134,24 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 	 * @ticket 23326
 	 */
 	public function test_get_terms_cache() {
-		global $wpdb;
-
 		$this->set_up_three_posts_and_tags();
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// last_changed and num_queries should bump.
 		$terms = get_terms( 'post_tag', array( 'update_term_meta_cache' => false ) );
 		$this->assertCount( 3, $terms );
 		$time1 = wp_cache_get( 'last_changed', 'terms' );
 		$this->assertNotEmpty( $time1 );
-		$this->assertSame( $num_queries + 2, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 2, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Again. last_changed and num_queries should remain the same.
 		$terms = get_terms( 'post_tag', array( 'update_term_meta_cache' => false ) );
 		$this->assertCount( 3, $terms );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'terms' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -167,21 +165,21 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		// Prime cache.
 		$terms       = get_terms( 'post_tag' );
 		$time1       = wp_cache_get( 'last_changed', 'terms' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// num_queries should bump, last_changed should remain the same.
 		$terms = get_terms( 'post_tag', array( 'number' => 2 ) );
 		$this->assertCount( 2, $terms );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'terms' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Again. last_changed and num_queries should remain the same.
 		$terms = get_terms( 'post_tag', array( 'number' => 2 ) );
 		$this->assertCount( 2, $terms );
 		$this->assertSame( $time1, wp_cache_get( 'last_changed', 'terms' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -195,12 +193,12 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		// Prime cache.
 		$terms       = get_terms( 'post_tag' );
 		$time1       = wp_cache_get( 'last_changed', 'terms' );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Force last_changed to bump.
 		wp_delete_term( $terms[0]->term_id, 'post_tag' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$time2       = wp_cache_get( 'last_changed', 'terms' );
 		$this->assertNotEquals( $time1, $time2 );
 
@@ -208,15 +206,15 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$terms = get_terms( 'post_tag' );
 		$this->assertCount( 2, $terms );
 		$this->assertSame( $time2, wp_cache_get( 'last_changed', 'terms' ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		// Again. last_changed and num_queries should remain the same.
 		$terms = get_terms( 'post_tag' );
 		$this->assertCount( 2, $terms );
 		$this->assertSame( $time2, wp_cache_get( 'last_changed', 'terms' ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// @todo Repeat with term insert and update.
 	}
@@ -427,7 +425,6 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		);
 
 		$this->assertSame( array( $term_id2, $term_id22 ), $terms );
-
 	}
 
 	/**
@@ -803,7 +800,6 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 			),
 			$terms
 		);
-
 	}
 
 	/**
@@ -848,13 +844,11 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 	 * @ticket 31118
 	 */
 	public function test_child_of_should_skip_query_when_specified_parent_is_not_found_in_hierarchy_cache() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
 
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_terms(
 			'wptests_tax',
@@ -865,7 +859,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		);
 
 		$this->assertEmpty( $found );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -2473,13 +2467,11 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 	 * @ticket 31118
 	 */
 	public function test_parent_should_skip_query_when_specified_parent_is_not_found_in_hierarchy_cache() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
 
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_terms(
 			'wptests_tax',
@@ -2490,7 +2482,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		);
 
 		$this->assertEmpty( $found );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -2756,7 +2748,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 	/**
 	 * @ticket 10142
 	 */
-	public function test_termmeta_cache_should_be_primed_by_default() {
+	public function test_termmeta_cache_should_be_lazy_loaded_by_default() {
 		global $wpdb;
 
 		register_taxonomy( 'wptests_tax', 'post' );
@@ -2773,13 +2765,13 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $t ) {
 			$this->assertSame( 'bar', get_term_meta( $t, 'foo', true ) );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 
 	/**
@@ -2803,13 +2795,13 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $t ) {
 			$this->assertSame( 'bar', get_term_meta( $t, 'foo', true ) );
 		}
 
-		$this->assertSame( $num_queries + 3, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 3, get_num_queries() );
 	}
 
 	/**
@@ -2908,7 +2900,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$found = get_terms(
 			'wptests_tax',
@@ -2918,7 +2910,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		$this->assertNotEmpty( $found );
 
@@ -2931,8 +2923,6 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 	 * @ticket 14162
 	 */
 	public function test_should_prime_individual_term_cache_when_fields_is_all() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 2, array( 'taxonomy' => 'wptests_tax' ) );
 
@@ -2944,10 +2934,9 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$term0       = get_term( $terms[0] );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
-
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -3036,6 +3025,39 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$this->assertSameSets( array( $terms[1] ), $found );
 	}
 
+	/**
+	 * @ticket 52710
+	 */
+	public function test_get_terms_without_update_get_terms_cache() {
+		$this->set_up_three_posts_and_tags();
+
+		$num_queries = get_num_queries();
+
+		// last_changed and num_queries should bump.
+		$terms = get_terms(
+			'post_tag',
+			array(
+				'cache_results'          => false,
+				'update_term_meta_cache' => false,
+			)
+		);
+		$this->assertCount( 3, $terms, 'After running get_terms, 3 terms should be returned' );
+		$this->assertSame( $num_queries + 2, get_num_queries(), 'There should be only 2 queries run, only term query and priming terms' );
+
+		$num_queries = get_num_queries();
+
+		// last_changed and num_queries should bump again.
+		$terms = get_terms(
+			'post_tag',
+			array(
+				'cache_results'          => false,
+				'update_term_meta_cache' => false,
+			)
+		);
+		$this->assertCount( 3, $terms, 'After running get_terms for a second time, 3 terms should be returned' );
+		$this->assertSame( $num_queries + 1, get_num_queries(), 'On the second run, only run the term query, priming terms happens on the first run' );
+	}
+
 	/**
 	 * @ticket 35935
 	 */
@@ -3150,7 +3172,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$num_queries_1 = get_num_queries();
 		$query2        = get_terms( $args_2 );
 		$this->assertSame( $num_queries_1, get_num_queries() );
-		$this->assertSame( count( $query1 ), count( $query2 ) );
+		$this->assertCount( count( $query1 ), $query2 );
 	}
 
 	/**
diff --git a/tests/term/getTheTerms.php b/tests/term/getTheTerms.php
index 2bd99863ce..67362327c8 100644
--- a/tests/term/getTheTerms.php
+++ b/tests/term/getTheTerms.php
@@ -195,10 +195,9 @@ class Tests_Term_GetTheTerms extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36814
+	 * @ticket 57701
 	 */
-	public function test_uncached_terms_should_be_primed_with_a_single_query() {
-		global $wpdb;
-
+	public function test_uncached_terms_should_not_be_primed_with_a_single_query_by_default() {
 		register_taxonomy( 'wptests_tax', 'post' );
 
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
@@ -210,14 +209,13 @@ class Tests_Term_GetTheTerms extends WP_UnitTestCase {
 		// Clean cache for two of the terms.
 		clean_term_cache( array( $terms[0], $terms[1] ), 'wptests_tax', false );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$found       = get_the_terms( self::$post_ids[0], 'wptests_tax' );
 
 		$this->assertSameSets( $terms, wp_list_pluck( $found, 'term_id' ) );
 
-		$num_queries++;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
-
+		// Two extra queries are expected as the cache is not primed and hence terms need to be queried.
+		$this->assertSame( 1, get_num_queries() - $num_queries );
 	}
 
 	/**
diff --git a/tests/term/isObjectInTerm.php b/tests/term/isObjectInTerm.php
index f0984ef49b..fbaf7e1776 100644
--- a/tests/term/isObjectInTerm.php
+++ b/tests/term/isObjectInTerm.php
@@ -135,46 +135,42 @@ class Tests_IsObjectInTerm extends WP_UnitTestCase {
 	 * @ticket 32044
 	 */
 	public function test_should_populate_and_hit_relationships_cache() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 2, array( 'taxonomy' => 'wptests_tax' ) );
 
 		$o = 12345;
 		wp_set_object_terms( $o, $terms[0], 'wptests_tax' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( is_object_in_term( $o, 'wptests_tax', $terms[0] ) );
 		$num_queries = $num_queries + 2;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		$this->assertFalse( is_object_in_term( $o, 'wptests_tax', $terms[1] ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 32044
 	 */
 	public function test_should_not_be_fooled_by_a_stale_relationship_cache() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 2, array( 'taxonomy' => 'wptests_tax' ) );
 
 		$o = 12345;
 		wp_set_object_terms( $o, $terms[0], 'wptests_tax' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( is_object_in_term( $o, 'wptests_tax', $terms[0] ) );
 		$num_queries = $num_queries + 2;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		wp_set_object_terms( $o, $terms[1], 'wptests_tax' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertTrue( is_object_in_term( $o, 'wptests_tax', $terms[1] ) );
 		$num_queries = $num_queries + 2;
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/term/meta.php b/tests/term/meta.php
index 976889fd8b..248d190917 100644
--- a/tests/term/meta.php
+++ b/tests/term/meta.php
@@ -114,11 +114,6 @@ class Tests_Term_Meta extends WP_UnitTestCase {
 	}
 
 	public function test_term_meta_should_be_lazy_loaded_for_all_terms_in_wp_query_loop() {
-		global $wpdb;
-
-		// Clear any previous term IDs from the queue.
-		wp_metadata_lazyloader()->reset_queue( 'term' );
-
 		$p = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		register_taxonomy( 'wptests_tax', 'post' );
@@ -142,20 +137,20 @@ class Tests_Term_Meta extends WP_UnitTestCase {
 				the_post();
 
 				// First request will hit the database.
-				$num_queries = $wpdb->num_queries;
+				$num_queries = get_num_queries();
 				$this->assertSame( 'bar', get_term_meta( $terms[0], 'foo', true ) );
-				$num_queries++;
-				$this->assertSame( $num_queries, $wpdb->num_queries );
+				++$num_queries;
+				$this->assertSame( $num_queries, get_num_queries() );
 
 				// Second and third requests should be in cache.
 				$this->assertSame( 'bar', get_term_meta( $terms[1], 'foo', true ) );
 				$this->assertSame( 'bar', get_term_meta( $terms[2], 'foo', true ) );
-				$this->assertSame( $num_queries, $wpdb->num_queries );
+				$this->assertSame( $num_queries, get_num_queries() );
 
 				// Querying a term not primed should result in a hit.
-				$num_queries++;
+				++$num_queries;
 				$this->assertSame( 'bar', get_term_meta( $orphan_term, 'foo', true ) );
-				$this->assertSame( $num_queries, $wpdb->num_queries );
+				$this->assertSame( $num_queries, get_num_queries() );
 			}
 		}
 	}
@@ -189,8 +184,6 @@ class Tests_Term_Meta extends WP_UnitTestCase {
 	 * @ticket 36593
 	 */
 	public function test_lazy_load_term_meta_false() {
-		global $wpdb;
-
 		$p = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		register_taxonomy( 'wptests_tax', 'post' );
@@ -199,7 +192,7 @@ class Tests_Term_Meta extends WP_UnitTestCase {
 		foreach ( $terms as $t ) {
 			add_term_meta( $t, 'foo', 'bar' );
 		}
-
+		$this->reset_lazyload_queue();
 		$q = new WP_Query(
 			array(
 				'cache_results'          => true,
@@ -213,14 +206,14 @@ class Tests_Term_Meta extends WP_UnitTestCase {
 				$q->the_post();
 
 				// Requests will hit the database.
-				$num_queries = $wpdb->num_queries;
+				$num_queries = get_num_queries();
 				$this->assertSame( 'bar', get_term_meta( $terms[0], 'foo', true ) );
-				$num_queries++;
-				$this->assertSame( $num_queries, $wpdb->num_queries );
+				++$num_queries;
+				$this->assertSame( $num_queries, get_num_queries() );
 
 				$this->assertSame( 'bar', get_term_meta( $terms[1], 'foo', true ) );
-				$num_queries++;
-				$this->assertSame( $num_queries, $wpdb->num_queries );
+				++$num_queries;
+				$this->assertSame( $num_queries, get_num_queries() );
 			}
 		}
 	}
diff --git a/tests/term/query.php b/tests/term/query.php
index b15b4787fc..682e86a8df 100644
--- a/tests/term/query.php
+++ b/tests/term/query.php
@@ -46,6 +46,46 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $term_2 ), $q->terms );
 	}
 
+	/**
+	 * @ticket 57645
+	 */
+	public function test_lazy_load_term_meta() {
+		$filter = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		register_taxonomy( 'wptests_tax_1', 'post' );
+		register_taxonomy( 'wptests_tax_2', 'post' );
+
+		$term_1 = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax_1' ) );
+		$term_2 = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax_2' ) );
+
+		$q = new WP_Term_Query(
+			array(
+				'taxonomy'   => 'wptests_tax_1',
+				'fields'     => 'ids',
+				'hide_empty' => false,
+			)
+		);
+
+		$this->assertSameSets( array( $term_1 ), $q->terms );
+
+		$q = new WP_Term_Query(
+			array(
+				'taxonomy'   => 'wptests_tax_2',
+				'fields'     => 'ids',
+				'hide_empty' => false,
+			)
+		);
+
+		$this->assertSameSets( array( $term_2 ), $q->terms );
+
+		get_term_meta( $term_1 );
+
+		$args     = $filter->get_args();
+		$first    = reset( $args );
+		$term_ids = end( $first );
+		$this->assertSameSets( $term_ids, array( $term_1, $term_2 ) );
+	}
+
 	public function test_taxonomy_should_accept_taxonomy_array() {
 		register_taxonomy( 'wptests_tax_1', 'post' );
 		register_taxonomy( 'wptests_tax_2', 'post' );
@@ -362,7 +402,7 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		$this->assertNotEmpty( $terms );
 		foreach ( $terms as $term ) {
 			$this->assertInstanceOf( 'WP_Term', $term );
-			$this->assertObjectHasAttribute( 'object_id', $term );
+			$this->assertObjectHasProperty( 'object_id', $term );
 		}
 
 		// Run again to check the cached response.
@@ -370,7 +410,7 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		$this->assertNotEmpty( $terms );
 		foreach ( $terms as $term ) {
 			$this->assertInstanceOf( 'WP_Term', $term );
-			$this->assertObjectHasAttribute( 'object_id', $term );
+			$this->assertObjectHasProperty( 'object_id', $term );
 		}
 	}
 
@@ -416,8 +456,6 @@ class Tests_Term_Query extends WP_UnitTestCase {
 	 * @group cache
 	 */
 	public function test_count_query_should_be_cached() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax_1', 'post' );
 
 		$terms = self::factory()->term->create_many( 2, array( 'taxonomy' => 'wptests_tax_1' ) );
@@ -432,7 +470,7 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		$count = $query->get_terms();
 		$this->assertEquals( 2, $count );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$query = new WP_Term_Query(
 			array(
@@ -443,7 +481,7 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		);
 		$count = $query->get_terms();
 		$this->assertEquals( 2, $count );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -660,6 +698,106 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		$this->assertSame( 0, $q->query( $args ) );
 	}
 
+	/**
+	 * If fields have filtered, cached results should work.
+	 *
+	 * @ticket 58116
+	 * @group cache
+	 */
+	public function test_query_filter_fields() {
+		$post_id = self::factory()->post->create();
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$term_id = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+		wp_set_object_terms( $post_id, array( $term_id ), 'wptests_tax' );
+		$post_draft_id = self::factory()->post->create( array( 'post_type' => 'draft' ) );
+		wp_set_object_terms( $post_draft_id, array( $term_id ), 'wptests_tax' );
+
+		add_filter( 'terms_clauses', array( $this, 'filter_fields_terms_clauses' ), 10, 3 );
+
+		$args = array(
+			'taxonomy'    => 'wptests_tax',
+			'hide_empty'  => false,
+			'post_type'   => 'post',
+			'post_status' => 'publish',
+		);
+
+		$q1     = new WP_Term_Query();
+		$terms1 = $q1->query( $args );
+		$q2     = new WP_Term_Query();
+		$terms2 = $q2->query( $args );
+		$this->assertSameSets( wp_list_pluck( $terms1, 'term_id' ), wp_list_pluck( $terms2, 'term_id' ), 'Term IDs are expected to match' );
+		$this->assertSameSets( wp_list_pluck( $terms1, 'count' ), wp_list_pluck( $terms2, 'count' ), 'Term counts are expected to match' );
+	}
+
+	/**
+	 * Filter `terms_clauses` to change the field requested. The filter is from example code given in #58116.
+	 */
+	public function filter_fields_terms_clauses( $clauses, $taxonomies, $args ) {
+		global $wpdb;
+
+		// Set to query specific posts types if set.
+		if ( ! empty( $args['post_type'] ) ) {
+			$clauses['fields']  = 'DISTINCT t.term_id, tt.term_taxonomy_id, tt.taxonomy, tt.description, tt.parent, COUNT(p.post_type) AS count';
+			$clauses['join']   .= ' LEFT JOIN ' . $wpdb->term_relationships . ' AS r ON r.term_taxonomy_id = tt.term_taxonomy_id LEFT JOIN ' . $wpdb->posts . ' AS p ON p.ID = r.object_id';
+			$clauses['where']  .= " AND (p.post_type = '" . $args['post_type'] . "' OR p.post_type IS NULL)";
+			$clauses['orderby'] = 'GROUP BY t.term_id ' . $clauses['orderby'];
+		}
+
+		// Set to query posts with specific status.
+		if ( ! empty( $args['post_status'] ) ) {
+			$clauses['where'] .= " AND (p.post_status = '" . $args['post_status'] . "')";
+		}
+		return $clauses;
+	}
+
+	/**
+	 * If fields have filtered, cached results should work.
+	 *
+	 * @ticket 58116
+	 * @group cache
+	 */
+	public function test_query_filter_select_fields() {
+		$post_id = self::factory()->post->create();
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$term_id = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+		wp_set_object_terms( $post_id, array( $term_id ), 'wptests_tax' );
+		$post_draft_id = self::factory()->post->create( array( 'post_type' => 'draft' ) );
+		wp_set_object_terms( $post_draft_id, array( $term_id ), 'wptests_tax' );
+
+		add_filter( 'get_terms_fields', array( $this, 'filter_get_terms_fields' ) );
+
+		$args = array(
+			'taxonomy'    => 'wptests_tax',
+			'hide_empty'  => false,
+			'post_type'   => 'post',
+			'post_status' => 'publish',
+		);
+
+		$q1     = new WP_Term_Query();
+		$terms1 = $q1->query( $args );
+		$q2     = new WP_Term_Query();
+		$terms2 = $q2->query( $args );
+		$this->assertSameSets( wp_list_pluck( $terms1, 'term_id' ), wp_list_pluck( $terms2, 'term_id' ), 'Term IDs are expected to match' );
+		$this->assertSameSets( wp_list_pluck( $terms1, 'parent' ), wp_list_pluck( $terms2, 'parent' ), 'Term parent are expected to match' );
+	}
+
+	/**
+	 * Filter `get_terms_fields` to change the field requested.
+	 */
+	public function filter_get_terms_fields( $select ) {
+		return array( 't.term_id', 'tt.parent' );
+	}
+
 	/**
 	 * The terms property should be an empty array for fields not as count and parent set.
 	 *
@@ -763,11 +901,9 @@ class Tests_Term_Query extends WP_UnitTestCase {
 	 * @ticket 41246
 	 */
 	public function test_terms_pre_query_filter_should_bypass_database_query() {
-		global $wpdb;
-
 		add_filter( 'terms_pre_query', array( __CLASS__, 'filter_terms_pre_query' ), 10, 2 );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		$q       = new WP_Term_Query();
 		$results = $q->query(
@@ -779,7 +915,7 @@ class Tests_Term_Query extends WP_UnitTestCase {
 		remove_filter( 'terms_pre_query', array( __CLASS__, 'filter_terms_pre_query' ), 10, 2 );
 
 		// Make sure no queries were executed.
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// We manually inserted a non-existing term and overrode the results with it.
 		$this->assertSame( array( 555 ), $q->terms );
diff --git a/tests/term/termExists.php b/tests/term/termExists.php
index c50cf7086d..caf88cc4de 100644
--- a/tests/term/termExists.php
+++ b/tests/term/termExists.php
@@ -320,7 +320,6 @@ class Tests_TermExists extends WP_UnitTestCase {
 	 * @covers ::term_exists()
 	 */
 	public function test_term_exists_caching() {
-		global $wpdb;
 		register_taxonomy( 'wptests_tax', 'post' );
 
 		$slug = __FUNCTION__;
@@ -331,14 +330,14 @@ class Tests_TermExists extends WP_UnitTestCase {
 			)
 		);
 		$this->assertEquals( $t, term_exists( $slug ) );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertEquals( $t, term_exists( $slug ) );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		$this->assertTrue( wp_delete_term( $t, 'wptests_tax' ) );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertNull( term_exists( $slug ) );
-		$this->assertSame( $num_queries + 2, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 2, get_num_queries() );
 
 		// Clean up.
 		_unregister_taxonomy( 'wptests_tax' );
@@ -349,7 +348,6 @@ class Tests_TermExists extends WP_UnitTestCase {
 	 * @covers ::term_exists()
 	 */
 	public function test_term_exists_caching_suspend_cache_invalidation() {
-		global $wpdb;
 		register_taxonomy( 'wptests_tax', 'post' );
 
 		wp_suspend_cache_invalidation( true );
@@ -362,9 +360,9 @@ class Tests_TermExists extends WP_UnitTestCase {
 		);
 
 		$this->assertEquals( $t, term_exists( $slug ) );
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$this->assertEquals( $t, term_exists( $slug ) );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 		wp_suspend_cache_invalidation( false );
 
 		// Clean up.
diff --git a/tests/term/wpGetObjectTerms.php b/tests/term/wpGetObjectTerms.php
index f246fccf71..948ba1e1c3 100644
--- a/tests/term/wpGetObjectTerms.php
+++ b/tests/term/wpGetObjectTerms.php
@@ -614,10 +614,9 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 10142
+	 * @ticket 57701
 	 */
-	public function test_termmeta_cache_should_be_primed_by_default() {
-		global $wpdb;
-
+	public function test_termmeta_cache_should_not_be_lazy_loaded_by_default() {
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
 		add_term_meta( $terms[0], 'foo', 'bar' );
@@ -629,21 +628,20 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 
 		$found = wp_get_object_terms( $p, 'wptests_tax' );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $t ) {
 			$this->assertSame( 'bar', get_term_meta( $t, 'foo', true ) );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		// Here we had extra queries as the term meta cache was not primed by default.
+		$this->assertSame( 3, get_num_queries() - $num_queries );
 	}
 
 	/**
 	 * @ticket 10142
 	 */
 	public function test_termmeta_cache_should_not_be_primed_when_update_term_meta_cache_is_false() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
 		add_term_meta( $terms[0], 'foo', 'bar' );
@@ -661,21 +659,19 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $t ) {
 			$this->assertSame( 'bar', get_term_meta( $t, 'foo', true ) );
 		}
 
-		$this->assertSame( $num_queries + 3, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 3, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 36932
 	 */
 	public function test_termmeta_cache_should_be_primed_when_fields_is_all_with_object_id() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
 		add_term_meta( $terms[0], 'foo', 'bar' );
@@ -694,21 +690,19 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $t ) {
 			$this->assertSame( 'bar', get_term_meta( $t, 'foo', true ) );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 
 	/**
 	 * @ticket 36932
 	 */
 	public function test_termmeta_cache_should_be_primed_when_fields_is_ids() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$terms = self::factory()->term->create_many( 3, array( 'taxonomy' => 'wptests_tax' ) );
 		add_term_meta( $terms[0], 'foo', 'bar' );
@@ -727,13 +721,13 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 
 		foreach ( $terms as $t ) {
 			$this->assertSame( 'bar', get_term_meta( $t, 'foo', true ) );
 		}
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 
 	/**
@@ -816,8 +810,6 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 	 * @ticket 14162
 	 */
 	public function test_should_prime_cache_for_found_terms() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax', 'post' );
 		$p = self::factory()->post->create();
 		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
@@ -831,9 +823,9 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 			)
 		);
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$term        = get_term( $t );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
@@ -858,15 +850,13 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 		}
 
 		$term = get_term( $t );
-		$this->assertObjectNotHasAttribute( 'object_id', $term );
+		$this->assertObjectNotHasProperty( 'object_id', $term );
 	}
 
 	/**
 	 * @ticket 14162
 	 */
 	public function test_term_cache_should_be_primed_for_all_taxonomies() {
-		global $wpdb;
-
 		register_taxonomy( 'wptests_tax1', 'post' );
 		register_taxonomy( 'wptests_tax2', 'post' );
 		$p  = self::factory()->post->create();
@@ -888,10 +878,10 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 
 		$this->assertSameSets( array( $t1, $t2 ), wp_list_pluck( $found, 'term_id' ) );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$term1       = get_term( $t1 );
 		$term2       = get_term( $t2 );
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 	}
 
 	/**
diff --git a/tests/term/wpInsertTerm.php b/tests/term/wpInsertTerm.php
index a2839d3c45..d99593b1d5 100644
--- a/tests/term/wpInsertTerm.php
+++ b/tests/term/wpInsertTerm.php
@@ -146,7 +146,6 @@ class Tests_Term_WpInsertTerm extends WP_UnitTestCase {
 		_unregister_taxonomy( 'wptests_tax' );
 
 		$this->assertSame( 'quality', $term->slug );
-
 	}
 
 	public function test_wp_insert_term_slug_whitespace_string() {
@@ -851,7 +850,6 @@ class Tests_Term_WpInsertTerm extends WP_UnitTestCase {
 		$term_2 = get_term( $t2, 'wptests_tax' );
 		$this->assertSame( $t2, $term_2->term_id );
 		$this->assertSame( 'Foo', $term_2->name );
-
 	}
 
 	/**
diff --git a/tests/term/wpSetObjectTerms.php b/tests/term/wpSetObjectTerms.php
index 8032a50e79..20631e0599 100644
--- a/tests/term/wpSetObjectTerms.php
+++ b/tests/term/wpSetObjectTerms.php
@@ -2,13 +2,17 @@
 
 /**
  * @group taxonomy
+ *
+ * @covers ::wp_set_object_terms
  */
 class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
-	protected $taxonomy        = 'category';
+	protected static $taxonomy = 'category';
 	protected static $post_ids = array();
+	protected static $term_ids = array();
 
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$post_ids = $factory->post->create_many( 5 );
+		self::$term_ids = $factory->term->create_many( 5, array( 'taxonomy' => self::$taxonomy ) );
 	}
 
 	/**
@@ -105,26 +109,26 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$terms = array();
 		for ( $i = 0; $i < 3; $i++ ) {
 			$term   = "term_{$i}";
-			$result = wp_insert_term( $term, $this->taxonomy );
+			$result = wp_insert_term( $term, self::$taxonomy );
 			$this->assertIsArray( $result );
 			$term_id[ $term ] = $result['term_id'];
 		}
 
 		foreach ( $ids as $id ) {
-			$tt = wp_set_object_terms( $id, array_values( $term_id ), $this->taxonomy );
+			$tt = wp_set_object_terms( $id, array_values( $term_id ), self::$taxonomy );
 			// Should return three term taxonomy IDs.
 			$this->assertCount( 3, $tt );
 		}
 
 		// Each term should be associated with every post.
 		foreach ( $term_id as $term => $id ) {
-			$actual = get_objects_in_term( $id, $this->taxonomy );
+			$actual = get_objects_in_term( $id, self::$taxonomy );
 			$this->assertSame( $ids, array_map( 'intval', $actual ) );
 		}
 
 		// Each term should have a count of 5.
 		foreach ( array_keys( $term_id ) as $term ) {
-			$t = get_term_by( 'name', $term, $this->taxonomy );
+			$t = get_term_by( 'name', $term, self::$taxonomy );
 			$this->assertSame( 5, $t->count );
 		}
 	}
@@ -139,25 +143,25 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		);
 
 		foreach ( $ids as $id ) {
-			$tt = wp_set_object_terms( $id, $terms, $this->taxonomy );
+			$tt = wp_set_object_terms( $id, $terms, self::$taxonomy );
 			// Should return three term taxonomy IDs.
 			$this->assertCount( 3, $tt );
 			// Remember which term has which term_id.
 			for ( $i = 0; $i < 3; $i++ ) {
-				$term                    = get_term_by( 'name', $terms[ $i ], $this->taxonomy );
+				$term                    = get_term_by( 'name', $terms[ $i ], self::$taxonomy );
 				$term_id[ $terms[ $i ] ] = (int) $term->term_id;
 			}
 		}
 
 		// Each term should be associated with every post.
 		foreach ( $term_id as $term => $id ) {
-			$actual = get_objects_in_term( $id, $this->taxonomy );
+			$actual = get_objects_in_term( $id, self::$taxonomy );
 			$this->assertSame( $ids, array_map( 'intval', $actual ) );
 		}
 
 		// Each term should have a count of 5.
 		foreach ( $terms as $term ) {
-			$t = get_term_by( 'name', $term, $this->taxonomy );
+			$t = get_term_by( 'name', $term, self::$taxonomy );
 			$this->assertSame( 5, $t->count );
 		}
 	}
@@ -253,7 +257,7 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$terms_1 = array();
 		for ( $i = 0; $i < 3; $i++ ) {
 			$term   = "term_{$i}";
-			$result = wp_insert_term( $term, $this->taxonomy );
+			$result = wp_insert_term( $term, self::$taxonomy );
 			$this->assertIsArray( $result );
 			$terms_1[ $i ] = $result['term_id'];
 		}
@@ -263,17 +267,17 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$terms_2[0] = $terms_1[1];
 
 		$term       = 'term';
-		$result     = wp_insert_term( $term, $this->taxonomy );
+		$result     = wp_insert_term( $term, self::$taxonomy );
 		$terms_2[1] = $result['term_id'];
 
 		// Set the initial terms.
-		$tt_1 = wp_set_object_terms( $post_id, $terms_1, $this->taxonomy );
+		$tt_1 = wp_set_object_terms( $post_id, $terms_1, self::$taxonomy );
 		$this->assertCount( 3, $tt_1 );
 
 		// Make sure they're correct.
 		$terms = wp_get_object_terms(
 			$post_id,
-			$this->taxonomy,
+			self::$taxonomy,
 			array(
 				'fields'  => 'ids',
 				'orderby' => 'term_id',
@@ -282,13 +286,13 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$this->assertSame( $terms_1, $terms );
 
 		// Change the terms.
-		$tt_2 = wp_set_object_terms( $post_id, $terms_2, $this->taxonomy );
+		$tt_2 = wp_set_object_terms( $post_id, $terms_2, self::$taxonomy );
 		$this->assertCount( 2, $tt_2 );
 
 		// Make sure they're correct.
 		$terms = wp_get_object_terms(
 			$post_id,
-			$this->taxonomy,
+			self::$taxonomy,
 			array(
 				'fields'  => 'ids',
 				'orderby' => 'term_id',
@@ -298,7 +302,6 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 
 		// Make sure the term taxonomy ID for 'bar' matches.
 		$this->assertSame( $tt_1[1], $tt_2[0] );
-
 	}
 
 	/**
@@ -311,13 +314,13 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$terms_2 = array( 'bar', 'bing' );
 
 		// Set the initial terms.
-		$tt_1 = wp_set_object_terms( $post_id, $terms_1, $this->taxonomy );
+		$tt_1 = wp_set_object_terms( $post_id, $terms_1, self::$taxonomy );
 		$this->assertCount( 3, $tt_1 );
 
 		// Make sure they're correct.
 		$terms = wp_get_object_terms(
 			$post_id,
-			$this->taxonomy,
+			self::$taxonomy,
 			array(
 				'fields'  => 'names',
 				'orderby' => 'term_id',
@@ -326,13 +329,13 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$this->assertSame( $terms_1, $terms );
 
 		// Change the terms.
-		$tt_2 = wp_set_object_terms( $post_id, $terms_2, $this->taxonomy );
+		$tt_2 = wp_set_object_terms( $post_id, $terms_2, self::$taxonomy );
 		$this->assertCount( 2, $tt_2 );
 
 		// Make sure they're correct.
 		$terms = wp_get_object_terms(
 			$post_id,
-			$this->taxonomy,
+			self::$taxonomy,
 			array(
 				'fields'  => 'names',
 				'orderby' => 'term_id',
@@ -342,7 +345,6 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 
 		// Make sure the term taxonomy ID for 'bar' matches.
 		$this->assertEquals( $tt_1[1], $tt_2[0] );
-
 	}
 
 	public function test_should_create_term_that_does_not_exist() {
@@ -430,4 +432,48 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 
 		$this->assertSame( array(), $tt_ids );
 	}
+
+	/**
+	 * Tests that empty values clear an object of all terms.
+	 *
+	 * @ticket 57923
+	 *
+	 * @dataProvider data_empty_value_should_clear_terms
+	 *
+	 * @param mixed $empty_value An empty value.
+	 */
+	public function test_empty_value_should_clear_terms( $empty_value ) {
+		$post_id = self::$post_ids[0];
+
+		// Assign some terms.
+		wp_set_object_terms( $post_id, self::$term_ids, self::$taxonomy );
+
+		// Make sure the terms are set.
+		$terms = wp_get_object_terms( $post_id, self::$taxonomy, array( 'fields' => 'names' ) );
+		$this->assertNotEmpty( $terms, 'Terms should initially be applied to post object.' );
+
+		// Remove terms by passing an empty value.
+		wp_set_object_terms( $post_id, $empty_value, self::$taxonomy );
+
+		// Make sure the terms have been removed.
+		$terms = wp_get_object_terms( $post_id, self::$taxonomy, array( 'fields' => 'names' ) );
+		$this->assertEmpty( $terms, 'An empty() value should clear terms from the post object.' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_empty_value_should_clear_terms() {
+		return array(
+			'(bool) false' => array( false ),
+			'null'         => array( null ),
+			'(int) 0'      => array( 0 ),
+			'(float) 0.0'  => array( 0.0 ),
+			'empty string' => array( '' ),
+			'(string) 0'   => array( '0' ),
+			'empty array'  => array( array() ),
+		);
+	}
 }
diff --git a/tests/term/wpTaxonomy.php b/tests/term/wpTaxonomy.php
index 8914228dc4..4106e60f3b 100644
--- a/tests/term/wpTaxonomy.php
+++ b/tests/term/wpTaxonomy.php
@@ -97,7 +97,6 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 
 		$this->assertSame( 10, $has_action );
 		$this->assertFalse( $has_action_after );
-
 	}
 
 	public function test_applies_registration_args_filters() {
diff --git a/tests/term/wpUpdateTerm.php b/tests/term/wpUpdateTerm.php
index 32d93258da..cbbd5780d6 100644
--- a/tests/term/wpUpdateTerm.php
+++ b/tests/term/wpUpdateTerm.php
@@ -802,5 +802,4 @@ class Tests_Term_WpUpdateTerm extends WP_UnitTestCase {
 		$this->assertWPError( $found );
 		$this->assertSame( 'invalid_term', $found->get_error_code() );
 	}
-
 }
diff --git a/tests/theme-previews.php b/tests/theme-previews.php
new file mode 100644
index 0000000000..e4abd621b2
--- /dev/null
+++ b/tests/theme-previews.php
@@ -0,0 +1,27 @@
+<?php
+
+/**
+ * test wp-includes/theme-previews.php
+ *
+ * @group themes
+ */
+class Tests_Theme_Previews extends WP_UnitTestCase {
+	public function set_up() {
+		parent::set_up();
+	}
+
+	public function tear_down() {
+		unset( $_GET['wp_theme_preview'] );
+		parent::tear_down();
+	}
+
+	public function test_initialize_theme_preview_hooks() {
+		$_GET['wp_theme_preview'] = 'twentytwentythree';
+		do_action( 'plugins_loaded' ); // Ensure `plugins_loaded` triggers `initialize_theme_preview_hooks`.
+
+		$this->assertEquals( has_filter( 'stylesheet', 'wp_get_theme_preview_path' ), 10 );
+		$this->assertEquals( has_filter( 'template', 'wp_get_theme_preview_path' ), 10 );
+		$this->assertEquals( has_action( 'init', 'wp_attach_theme_preview_middleware' ), 10 );
+		$this->assertEquals( has_action( 'admin_head', 'wp_block_theme_activate_nonce' ), 10 );
+	}
+}
diff --git a/tests/theme.php b/tests/theme.php
index 378ed16093..721fa81f22 100644
--- a/tests/theme.php
+++ b/tests/theme.php
@@ -22,6 +22,7 @@ class Tests_Theme extends WP_UnitTestCase {
 		'twentytwentyone',
 		'twentytwentytwo',
 		'twentytwentythree',
+		'twentytwentyfour',
 	);
 
 	/**
@@ -36,8 +37,9 @@ class Tests_Theme extends WP_UnitTestCase {
 
 		parent::set_up();
 
+		// Sets up the `wp-content/themes/` directory to ensure consistency when running tests.
 		$this->orig_theme_dir = $wp_theme_directories;
-		$wp_theme_directories = array( WP_CONTENT_DIR . '/themes' );
+		$wp_theme_directories = array( WP_CONTENT_DIR . '/themes', realpath( DIR_TESTDATA . '/themedir1' ) );
 
 		add_filter( 'extra_theme_headers', array( $this, 'theme_data_extra_headers' ) );
 		wp_clean_themes_cache();
@@ -282,6 +284,11 @@ class Tests_Theme extends WP_UnitTestCase {
 
 		for ( $i = 0; $i < 3; $i++ ) {
 			foreach ( $themes as $name => $theme ) {
+				// Skip invalid theme directory names (such as `block_theme-[0.4.0]`).
+				if ( ! preg_match( '/^[a-z0-9-]+$/', $theme['Stylesheet'] ) ) {
+					continue;
+				}
+
 				// Switch to this theme.
 				if ( 2 === $i ) {
 					switch_theme( $theme['Template'], $theme['Stylesheet'] );
@@ -289,16 +296,16 @@ class Tests_Theme extends WP_UnitTestCase {
 					switch_theme( $theme['Stylesheet'] );
 				}
 
-				$this->assertSame( $name, get_current_theme() );
+				$this->assertSame( $theme['Name'], get_current_theme() );
 
 				// Make sure the various get_* functions return the correct values.
 				$this->assertSame( $theme['Template'], get_template() );
 				$this->assertSame( $theme['Stylesheet'], get_stylesheet() );
 
-				$root_fs = get_theme_root();
+				$root_fs = $theme->get_theme_root();
 				$this->assertTrue( is_dir( $root_fs ) );
 
-				$root_uri = get_theme_root_uri();
+				$root_uri = $theme->get_theme_root_uri();
 				$this->assertNotEmpty( $root_uri );
 
 				$this->assertSame( $root_fs . '/' . get_stylesheet(), get_stylesheet_directory() );
@@ -309,19 +316,38 @@ class Tests_Theme extends WP_UnitTestCase {
 				$this->assertSame( $root_fs . '/' . get_template(), get_template_directory() );
 				$this->assertSame( $root_uri . '/' . get_template(), get_template_directory_uri() );
 
-				// get_query_template()
+				// Skip block themes for get_query_template() tests since this test is focused on classic templates.
+				if ( wp_is_block_theme() && current_theme_supports( 'block-templates' ) ) {
+					continue;
+				}
 
 				// Template file that doesn't exist.
 				$this->assertSame( '', get_query_template( 'nonexistant' ) );
 
 				// Template files that do exist.
-				/*
 				foreach ( $theme['Template Files'] as $path ) {
-					$file = basename($path, '.php');
-					FIXME: untestable because get_query_template() uses TEMPLATEPATH.
-					$this->assertSame('', get_query_template($file));
+					$file = basename( $path, '.php' );
+
+					// The functions.php file is not a template.
+					if ( 'functions' === $file ) {
+						continue;
+					}
+
+					// Underscores are not supported by `locate_template()`.
+					if ( 'taxonomy-post_format' === $file ) {
+						$file = 'taxonomy';
+					}
+
+					$child_theme_file  = get_stylesheet_directory() . '/' . $file . '.php';
+					$parent_theme_file = get_template_directory() . '/' . $file . '.php';
+					if ( file_exists( $child_theme_file ) ) {
+						$this->assertSame( $child_theme_file, get_query_template( $file ) );
+					} elseif ( file_exists( $parent_theme_file ) ) {
+						$this->assertSame( $parent_theme_file, get_query_template( $file ) );
+					} else {
+						$this->assertSame( '', get_query_template( $file ) );
+					}
 				}
-				*/
 
 				// These are kind of tautologies but at least exercise the code.
 				$this->assertSame( get_404_template(), get_query_template( '404' ) );
@@ -854,6 +880,184 @@ class Tests_Theme extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Tests that a theme in the custom test data theme directory is recognized.
+	 *
+	 * @ticket 18298
+	 */
+	public function test_theme_in_custom_theme_dir_is_valid() {
+		switch_theme( 'block-theme' );
+		$this->assertTrue( wp_get_theme()->exists() );
+	}
+
+	/**
+	 * Tests that `is_child_theme()` returns true for child theme.
+	 *
+	 * @ticket 18298
+	 *
+	 * @covers ::is_child_theme
+	 */
+	public function test_is_child_theme_true() {
+		switch_theme( 'block-theme-child' );
+		$this->assertTrue( is_child_theme() );
+	}
+
+	/**
+	 * Tests that `is_child_theme()` returns false for parent theme.
+	 *
+	 * @ticket 18298
+	 *
+	 * @covers ::is_child_theme
+	 */
+	public function test_is_child_theme_false() {
+		switch_theme( 'block-theme' );
+		$this->assertFalse( is_child_theme() );
+	}
+
+	/**
+	 * Tests that the child theme directory is correctly detected.
+	 *
+	 * @ticket 18298
+	 *
+	 * @covers ::get_stylesheet_directory
+	 */
+	public function test_get_stylesheet_directory() {
+		switch_theme( 'block-theme-child' );
+		$this->assertSame( realpath( DIR_TESTDATA ) . '/themedir1/block-theme-child', get_stylesheet_directory() );
+	}
+
+	/**
+	 * Tests that the parent theme directory is correctly detected.
+	 *
+	 * @ticket 18298
+	 *
+	 * @covers ::get_template_directory
+	 */
+	public function test_get_template_directory() {
+		switch_theme( 'block-theme-child' );
+		$this->assertSame( realpath( DIR_TESTDATA ) . '/themedir1/block-theme', get_template_directory() );
+	}
+
+	/**
+	 * Tests that get_stylesheet_directory() behaves correctly with filters.
+	 *
+	 * @ticket 18298
+	 * @dataProvider data_get_stylesheet_directory_with_filter
+	 *
+	 * @covers ::get_stylesheet_directory
+	 *
+	 * @param string   $theme     Theme slug / directory name.
+	 * @param string   $hook_name Filter hook name.
+	 * @param callable $callback  Filter callback.
+	 * @param string   $expected  Expected stylesheet directory with the filter active.
+	 */
+	public function test_get_stylesheet_directory_with_filter( $theme, $hook_name, $callback, $expected ) {
+		switch_theme( $theme );
+
+		// Add filter, then call get_stylesheet_directory() to compute value.
+		add_filter( $hook_name, $callback );
+		$this->assertSame( $expected, get_stylesheet_directory(), 'Stylesheet directory returned incorrect result not considering filters' );
+
+		// Remove filter again, then ensure result is recalculated and not the same as before.
+		remove_filter( $hook_name, $callback );
+		$this->assertNotSame( $expected, get_stylesheet_directory(), 'Stylesheet directory returned previous value even though filters were removed' );
+	}
+
+	/**
+	 * Data provider for `test_get_stylesheet_directory_with_filter()`.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_stylesheet_directory_with_filter() {
+		return array(
+			'with stylesheet_directory filter' => array(
+				'block-theme',
+				'stylesheet_directory',
+				static function ( $dir ) {
+					return str_replace( realpath( DIR_TESTDATA ) . '/themedir1', '/fantasy-dir', $dir );
+				},
+				'/fantasy-dir/block-theme',
+			),
+			'with theme_root filter'           => array(
+				'block-theme',
+				'theme_root',
+				static function () {
+					return '/fantasy-dir';
+				},
+				'/fantasy-dir/block-theme',
+			),
+			'with stylesheet filter'           => array(
+				'block-theme',
+				'stylesheet',
+				static function () {
+					return 'another-theme';
+				},
+				// Because the theme does not exist, `get_theme_root()` returns the default themes directory.
+				WP_CONTENT_DIR . '/themes/another-theme',
+			),
+		);
+	}
+
+	/**
+	 * Tests that get_template_directory() behaves correctly with filters.
+	 *
+	 * @ticket 18298
+	 * @dataProvider data_get_template_directory_with_filter
+	 *
+	 * @covers ::get_template_directory
+	 *
+	 * @param string   $theme     Theme slug / directory name.
+	 * @param string   $hook_name Filter hook name.
+	 * @param callable $callback  Filter callback.
+	 * @param string   $expected  Expected template directory with the filter active.
+	 */
+	public function test_get_template_directory_with_filter( $theme, $hook_name, $callback, $expected ) {
+		switch_theme( $theme );
+
+		// Add filter, then call get_template_directory() to compute value.
+		add_filter( $hook_name, $callback );
+		$this->assertSame( $expected, get_template_directory(), 'Template directory returned incorrect result not considering filters' );
+
+		// Remove filter again, then ensure result is recalculated and not the same as before.
+		remove_filter( $hook_name, $callback );
+		$this->assertNotSame( $expected, get_template_directory(), 'Template directory returned previous value even though filters were removed' );
+	}
+
+	/**
+	 * Data provider for `test_get_template_directory_with_filter()`.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_template_directory_with_filter() {
+		return array(
+			'with template_directory filter' => array(
+				'block-theme',
+				'template_directory',
+				static function ( $dir ) {
+					return str_replace( realpath( DIR_TESTDATA ) . '/themedir1', '/fantasy-dir', $dir );
+				},
+				'/fantasy-dir/block-theme',
+			),
+			'with theme_root filter'         => array(
+				'block-theme',
+				'theme_root',
+				static function () {
+					return '/fantasy-dir';
+				},
+				'/fantasy-dir/block-theme',
+			),
+			'with template filter'           => array(
+				'block-theme',
+				'template',
+				static function () {
+					return 'another-theme';
+				},
+				// Because the theme does not exist, `get_theme_root()` returns the default themes directory.
+				WP_CONTENT_DIR . '/themes/another-theme',
+			),
+		);
+	}
+
 	/**
 	 * Helper function to ensure that a block theme is available and active.
 	 */
diff --git a/tests/theme/customHeader.php b/tests/theme/customHeader.php
index 21350deeda..b994d7f2dc 100644
--- a/tests/theme/customHeader.php
+++ b/tests/theme/customHeader.php
@@ -88,7 +88,7 @@ class Tests_Theme_CustomHeader extends WP_UnitTestCase {
 	 *
 	 * @ticket 56180
 	 *
-	 * @covers get_header_image
+	 * @covers ::get_header_image
 	 *
 	 * @dataProvider data_filter_header_image
 	 *
@@ -98,7 +98,7 @@ class Tests_Theme_CustomHeader extends WP_UnitTestCase {
 	public function test_filter_header_image( $header_image, $expected ) {
 		add_filter(
 			'get_header_image',
-			static function() use ( $header_image ) {
+			static function () use ( $header_image ) {
 				return $header_image;
 			}
 		);
@@ -174,6 +174,82 @@ class Tests_Theme_CustomHeader extends WP_UnitTestCase {
 		$this->assertStringContainsString( sprintf( 'src="%s"', $custom ), $html );
 	}
 
+	/**
+	 * Tests default values of performance attributes for "get_header_image_tag".
+	 *
+	 * @ticket 58680
+	 */
+	public function test_get_header_image_tag_with_default_performance_attributes() {
+		$this->add_theme_support(
+			array(
+				'default-image' => 'http://localhost/default-header.jpg',
+				'width'         => 60,
+				'height'        => 60,
+			)
+		);
+
+		add_filter(
+			'wp_min_priority_img_pixels',
+			static function () {
+				return 2500; // 50*50=2500
+			}
+		);
+
+		wp_high_priority_element_flag( true );
+
+		$html = get_header_image_tag();
+		$this->assertStringNotContainsString( ' loading="lazy"', $html );
+		$this->assertStringContainsString( ' fetchpriority="high"', $html );
+		$this->assertStringContainsString( ' decoding="async"', $html );
+	}
+
+	/**
+	 * Tests custom values of performance attributes for "get_header_image_tag".
+	 *
+	 * @ticket 58680
+	 */
+	public function test_get_header_image_tag_with_custom_performance_attributes() {
+		$this->add_theme_support(
+			array(
+				'default-image' => 'http://localhost/default-header.jpg',
+				'width'         => 500,
+				'height'        => 500,
+			)
+		);
+
+		$html = get_header_image_tag(
+			array(
+				'fetchpriority' => '',
+				'decoding'      => '',
+			)
+		);
+		$this->assertStringNotContainsString( ' fetchpriority="high"', $html );
+		$this->assertStringNotContainsString( ' decoding="async"', $html );
+	}
+
+	/**
+	 * Tests custom lazy loading for "get_header_image_tag".
+	 *
+	 * @ticket 58680
+	 */
+	public function test_get_header_image_tag_with_custom_lazy_loading() {
+		$this->add_theme_support(
+			array(
+				'default-image' => 'http://localhost/default-header.jpg',
+				'width'         => 500,
+				'height'        => 500,
+			)
+		);
+
+		$html = get_header_image_tag(
+			array(
+				'loading' => 'lazy',
+			)
+		);
+		$this->assertStringNotContainsString( ' fetchpriority="high"', $html );
+		$this->assertStringContainsString( ' loading="lazy"', $html );
+	}
+
 	public function test_get_custom_header_markup_without_registered_default_image() {
 		$this->add_theme_support();
 
diff --git a/tests/theme/themeDir.php b/tests/theme/themeDir.php
index ea721e5a44..eedd92bcf6 100644
--- a/tests/theme/themeDir.php
+++ b/tests/theme/themeDir.php
@@ -112,7 +112,6 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 		$this->assertSame( self::THEME_ROOT . '/sandbox', $theme['Stylesheet Dir'] );
 		$this->assertSame( 'publish', $theme['Status'] );
 		$this->assertSame( '', $theme['Parent Theme'] );
-
 	}
 
 	/**
@@ -144,7 +143,6 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 		$this->assertSame( self::THEME_ROOT . '/stylesheetonly', $theme['Stylesheet Dir'] );
 		$this->assertSame( 'publish', $theme['Status'] );
 		$this->assertSame( 'Sandbox', $theme['Parent Theme'] );
-
 	}
 
 	/**
@@ -178,14 +176,17 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 			'REST Theme',
 			'Block Theme',
 			'Block Theme Child Theme',
+			'Block Theme Child Deprecated Path',
 			'Block Theme Child with no theme.json',
+			'Block Theme Child Theme With Fluid Layout',
 			'Block Theme Child Theme With Fluid Typography',
 			'Block Theme Child Theme With Fluid Typography Config',
 			'Block Theme Non Latin',
 			'Block Theme [0.4.0]',
 			'Block Theme [1.0.0] in subdirectory',
 			'Block Theme Deprecated Path',
-			'Webfonts theme',
+			'Block Theme Post Content Default',
+			'Block Theme with defined Typography Fonts',
 			'Empty `fontFace` in theme.json - no webfonts defined',
 			'A theme with the Update URI header',
 		);
diff --git a/tests/theme/wpAddGlobalStylesForBlocks.php b/tests/theme/wpAddGlobalStylesForBlocks.php
index 6d55f24ec9..b009ac7233 100644
--- a/tests/theme/wpAddGlobalStylesForBlocks.php
+++ b/tests/theme/wpAddGlobalStylesForBlocks.php
@@ -18,6 +18,11 @@ class Tests_Theme_WpAddGlobalStylesForBlocks extends WP_Theme_UnitTestCase {
 	 */
 	private $test_blocks = array();
 
+	public function set_up() {
+		parent::set_up();
+		remove_action( 'wp_print_styles', 'print_emoji_styles' );
+	}
+
 	public function tear_down() {
 		// Unregister test blocks.
 		if ( ! empty( $this->test_blocks ) ) {
@@ -139,6 +144,88 @@ class Tests_Theme_WpAddGlobalStylesForBlocks extends WP_Theme_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 57868
+	 */
+	public function test_third_party_blocks_inline_styles_for_elements_get_rendered_when_per_block() {
+		$this->set_up_third_party_block();
+		add_filter( 'should_load_separate_core_block_assets', '__return_true' );
+
+		wp_register_style( 'global-styles', false, array(), true, true );
+		wp_enqueue_style( 'global-styles' );
+		wp_add_global_styles_for_blocks();
+
+		$actual = get_echo( 'wp_print_styles' );
+
+		$this->assertStringContainsString(
+			'.wp-block-my-third-party-block cite{color: white;}',
+			$actual
+		);
+	}
+
+	/**
+	 * @ticket 57868
+	 */
+	public function test_third_party_blocks_inline_styles_for_elements_get_rendered() {
+		wp_register_style( 'global-styles', false, array(), true, true );
+		wp_enqueue_style( 'global-styles' );
+		wp_add_global_styles_for_blocks();
+
+		$actual = get_echo( 'wp_print_styles' );
+
+		$this->assertStringContainsString(
+			'.wp-block-my-third-party-block cite{color: white;}',
+			$actual
+		);
+	}
+
+	/**
+	 * @ticket 57868
+	 *
+	 * @dataProvider data_wp_get_block_name_from_theme_json_path
+	 *
+	 * @param array  $path     An array of keys describing the path to a property in theme.json.
+	 * @param string $expected The expected block name.
+	 */
+	public function test_wp_get_block_name_from_theme_json_path( $path, $expected ) {
+		$block_name = wp_get_block_name_from_theme_json_path( $path );
+		$this->assertSame( $expected, $block_name );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_block_name_from_theme_json_path() {
+		return array(
+			'core block styles'             => array(
+				array( 'styles', 'blocks', 'core/navigation' ),
+				'core/navigation',
+			),
+			'core block element styles'     => array(
+				array( 'styles', 'blocks', 'core/navigation', 'elements', 'link' ),
+				'core/navigation',
+			),
+			'custom block styles'           => array(
+				array( 'styles', 'blocks', 'my/third-party-block' ),
+				'my/third-party-block',
+			),
+			'custom block element styles'   => array(
+				array( 'styles', 'blocks', 'my/third-party-block', 'elements', 'cite' ),
+				'my/third-party-block',
+			),
+			'custom block wrong format'     => array(
+				array( 'styles', 'my/third-party-block' ),
+				'',
+			),
+			'invalid path but works for BC' => array(
+				array( 'something', 'core/image' ),
+				'core/image',
+			),
+		);
+	}
+
 	private function set_up_third_party_block() {
 		switch_theme( 'block-theme' );
 
diff --git a/tests/theme/wpGetBlockCssSelector.php b/tests/theme/wpGetBlockCssSelector.php
new file mode 100644
index 0000000000..670007dbb0
--- /dev/null
+++ b/tests/theme/wpGetBlockCssSelector.php
@@ -0,0 +1,355 @@
+<?php
+/**
+ * Tests wp_get_block_css_selector().
+ *
+ * @since 6.3.0
+ *
+ * @group themes
+ *
+ * @covers ::wp_get_block_css_selector
+ */
+
+class Tests_Theme_WpGetBlockCssSelector extends WP_Theme_UnitTestCase {
+	private $test_block_name;
+
+	public function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+	}
+
+	public function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::tear_down();
+	}
+
+	private function register_test_block( $name, $selectors = null, $supports = null ) {
+		$this->test_block_name = $name;
+
+		return register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(),
+				'selectors'   => $selectors,
+				'supports'    => $supports,
+			)
+		);
+	}
+
+	/**
+	* @ticket 58586
+	*/
+	public function test_get_root_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/block-with-selectors',
+			array( 'root' => '.wp-custom-block-class' )
+		);
+
+		$selector = wp_get_block_css_selector( $block_type );
+		$this->assertEquals( '.wp-custom-block-class', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_get_root_selector_via_experimental_property() {
+		$block_type = self::register_test_block(
+			'test/block-without-selectors',
+			null,
+			array( '__experimentalSelector' => '.experimental-selector' )
+		);
+
+		$selector = wp_get_block_css_selector( $block_type );
+		$this->assertEquals( '.experimental-selector', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_default_root_selector_generation_for_core_block() {
+		$block_type = self::register_test_block(
+			'core/without-selectors-or-supports',
+			null,
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type );
+		$this->assertEquals( '.wp-block-without-selectors-or-supports', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_default_root_selector_generation() {
+		$block_type = self::register_test_block(
+			'test/without-selectors-or-supports',
+			null,
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type );
+		$this->assertEquals( '.wp-block-test-without-selectors-or-supports', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_get_feature_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/feature-selector',
+			array( 'typography' => array( 'root' => '.typography' ) ),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography' );
+		$this->assertEquals( '.typography', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_get_feature_selector_via_selectors_api_shorthand_property() {
+		$block_type = self::register_test_block(
+			'test/shorthand-feature-selector',
+			array( 'typography' => '.typography' ),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography' );
+		$this->assertEquals( '.typography', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_no_feature_level_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/null-feature-selector',
+			array( 'root' => '.fallback-root-selector' ),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography' );
+		$this->assertEquals( null, $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_fallback_feature_level_selector_via_selectors_api_to_generated_class() {
+		$block_type = self::register_test_block(
+			'test/fallback-feature-selector',
+			array(),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography', true );
+		$this->assertEquals( '.wp-block-test-fallback-feature-selector', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_fallback_feature_level_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/fallback-feature-selector',
+			array( 'root' => '.fallback-root-selector' ),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography', true );
+		$this->assertEquals( '.fallback-root-selector', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_get_feature_selector_via_experimental_property() {
+		$block_type = self::register_test_block(
+			'test/experimental-feature-selector',
+			null,
+			array(
+				'typography' => array(
+					'__experimentalSelector' => '.experimental-typography',
+				),
+			)
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography' );
+		$this->assertEquals( '.wp-block-test-experimental-feature-selector .experimental-typography', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_fallback_feature_selector_via_experimental_property() {
+		$block_type = self::register_test_block(
+			'test/fallback-feature-selector',
+			null,
+			array()
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography', true );
+		$this->assertEquals( '.wp-block-test-fallback-feature-selector', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_no_feature_selector_via_experimental_property() {
+		$block_type = self::register_test_block(
+			'test/null-experimental-feature-selector',
+			null,
+			array()
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography' );
+		$this->assertEquals( null, $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_get_subfeature_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/subfeature-selector',
+			array(
+				'typography' => array(
+					'textDecoration' => '.root .typography .text-decoration',
+				),
+			),
+			null
+		);
+
+		$selector = wp_get_block_css_selector(
+			$block_type,
+			array( 'typography', 'textDecoration' )
+		);
+
+		$this->assertEquals( '.root .typography .text-decoration', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_fallback_subfeature_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/subfeature-selector',
+			array(
+				'typography' => array( 'root' => '.root .typography' ),
+			),
+			null
+		);
+
+		$selector = wp_get_block_css_selector(
+			$block_type,
+			array( 'typography', 'textDecoration' ),
+			true
+		);
+
+		$this->assertEquals( '.root .typography', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_no_subfeature_level_selector_via_selectors_api() {
+		$block_type = self::register_test_block(
+			'test/null-subfeature-selector',
+			array(),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, array( 'typography', 'fontSize' ) );
+		$this->assertEquals( null, $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_fallback_subfeature_selector_via_experimental_property() {
+		$block_type = self::register_test_block(
+			'test/fallback-subfeature-selector',
+			null,
+			array()
+		);
+
+		$selector = wp_get_block_css_selector(
+			$block_type,
+			array( 'typography', 'fontSize' ),
+			true
+		);
+		$this->assertEquals( '.wp-block-test-fallback-subfeature-selector', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_no_subfeature_selector_via_experimental_property() {
+		$block_type = self::register_test_block(
+			'test/null-experimental-subfeature-selector',
+			null,
+			array()
+		);
+
+		$selector = wp_get_block_css_selector(
+			$block_type,
+			array( 'typography', 'fontSize' )
+		);
+		$this->assertEquals( null, $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_empty_target_returns_null() {
+		$block_type = self::register_test_block(
+			'test/null-experimental-subfeature-selector',
+			null,
+			array()
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, array() );
+		$this->assertEquals( null, $selector );
+
+		$selector = wp_get_block_css_selector( $block_type, '' );
+		$this->assertEquals( null, $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_string_targets_for_features() {
+		$block_type = self::register_test_block(
+			'test/target-types-for-features',
+			array( 'typography' => '.found' ),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography' );
+		$this->assertEquals( '.found', $selector );
+
+		$selector = wp_get_block_css_selector( $block_type, array( 'typography' ) );
+		$this->assertEquals( '.found', $selector );
+	}
+
+	/**
+	 * @ticket 58586
+	 */
+	public function test_string_targets_for_subfeatures() {
+		$block_type = self::register_test_block(
+			'test/target-types-for-features',
+			array(
+				'typography' => array( 'fontSize' => '.found' ),
+			),
+			null
+		);
+
+		$selector = wp_get_block_css_selector( $block_type, 'typography.fontSize' );
+		$this->assertEquals( '.found', $selector );
+
+		$selector = wp_get_block_css_selector( $block_type, array( 'typography', 'fontSize' ) );
+		$this->assertEquals( '.found', $selector );
+	}
+}
diff --git a/tests/theme/wpGetGlobalStylesSvgFilters.php b/tests/theme/wpGetGlobalStylesSvgFilters.php
deleted file mode 100644
index b1d23efb4d..0000000000
--- a/tests/theme/wpGetGlobalStylesSvgFilters.php
+++ /dev/null
@@ -1,37 +0,0 @@
-<?php
-/**
- * Tests wp_get_global_styles_svg_filters().
- *
- * @group themes
- */
-class Tests_Theme_wpGetGlobalStylesSvgFilters extends WP_UnitTestCase {
-	public function set_up() {
-		parent::set_up();
-		// Clear caches.
-		wp_clean_themes_cache();
-	}
-
-	public function tear_down() {
-		wp_clean_themes_cache();
-
-		parent::tear_down();
-	}
-
-	/**
-	 * Tests that switching themes recalculates the svgs.
-	 *
-	 * @covers ::wp_get_global_styles_svg_filters
-	 *
-	 * @ticket 57568
-	 */
-	public function test_switching_themes_should_recalculate_svg() {
-		$svg_for_default_theme = wp_get_global_styles_svg_filters();
-		switch_theme( 'block-theme' );
-		$svg_for_block_theme = wp_get_global_styles_svg_filters();
-		switch_theme( WP_DEFAULT_THEME );
-
-		$this->assertStringContainsString( '<svg', $svg_for_default_theme, 'Default theme should contain SVG' );
-		$this->assertStringContainsString( '<svg', $svg_for_default_theme, 'Block theme should contain SVG' );
-		$this->assertNotSame( $svg_for_default_theme, $svg_for_block_theme, 'Cache value should have changed' );
-	}
-}
diff --git a/tests/theme/wpGetGlobalStylesheet.php b/tests/theme/wpGetGlobalStylesheet.php
index 6213a383e3..40d87940b4 100644
--- a/tests/theme/wpGetGlobalStylesheet.php
+++ b/tests/theme/wpGetGlobalStylesheet.php
@@ -220,6 +220,29 @@ class Tests_Theme_WpGetGlobalStylesheet extends WP_Theme_UnitTestCase {
 		$this->assertStringContainsString( $expected, $stylesheet_for_block_theme, 'Custom font size (100px) should be present for block theme' );
 	}
 
+	/**
+	 * Tests that the function relies on the development mode for whether to use caching.
+	 *
+	 * @ticket 57487
+	 */
+	public function test_caching_is_used_when_developing_theme() {
+		global $_wp_tests_development_mode;
+
+		$this->maybe_switch_theme( 'block-theme' );
+
+		// Store CSS in cache.
+		$css = '.my-class { display: block; }';
+		wp_cache_set( 'wp_get_global_stylesheet', $css, 'theme_json' );
+
+		// By default, caching should be used, so the above value will be returned.
+		$_wp_tests_development_mode = '';
+		$this->assertSame( $css, wp_get_global_stylesheet(), 'Caching was not used despite development mode disabled' );
+
+		// When the development mode is set to 'theme', caching should not be used.
+		$_wp_tests_development_mode = 'theme';
+		$this->assertNotSame( $css, wp_get_global_stylesheet(), 'Caching was used despite theme development mode' );
+	}
+
 	/**
 	 * Adds the 'editor-font-sizes' theme support with custom font sizes.
 	 *
diff --git a/tests/theme/wpThemeJson.php b/tests/theme/wpThemeJson.php
index ddbceeadd1..6da723583b 100644
--- a/tests/theme/wpThemeJson.php
+++ b/tests/theme/wpThemeJson.php
@@ -262,6 +262,9 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 		$actual   = $theme_json->get_settings();
 		$expected = array(
+			'background' => array(
+				'backgroundImage' => true,
+			),
 			'border'     => array(
 				'width'  => true,
 				'style'  => true,
@@ -269,7 +272,10 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 				'color'  => true,
 			),
 			'color'      => array(
-				'link' => true,
+				'link'    => true,
+				'heading' => true,
+				'button'  => true,
+				'caption' => true,
 			),
 			'dimensions' => array(
 				'minHeight' => true,
@@ -292,6 +298,9 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 					),
 				),
 				'core/group'     => array(
+					'background' => array(
+						'backgroundImage' => true,
+					),
 					'border'     => array(
 						'width'  => true,
 						'style'  => true,
@@ -299,7 +308,10 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'color'  => true,
 					),
 					'color'      => array(
-						'link' => true,
+						'link'    => true,
+						'heading' => true,
+						'button'  => true,
+						'caption' => true,
 					),
 					'dimensions' => array(
 						'minHeight' => true,
@@ -372,6 +384,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 54336
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_support_for_shorthand_and_longhand_values() {
 		$theme_json = new WP_Theme_JSON(
@@ -409,13 +422,14 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-group{border-radius: 10px;margin: 1em;padding: 24px;}.wp-block-image{margin-bottom: 30px;padding-top: 15px;}.wp-block-image img, .wp-block-image .wp-block-image__crop-area{border-top-left-radius: 10px;border-bottom-right-radius: 1em;}';
+		$styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-group{border-radius: 10px;margin: 1em;padding: 24px;}.wp-block-image{margin-bottom: 30px;padding-top: 15px;}.wp-block-image img, .wp-block-image .wp-block-image__crop-area, .wp-block-image .components-placeholder{border-top-left-radius: 10px;border-bottom-right-radius: 1em;}';
 		$this->assertSame( $styles, $theme_json->get_stylesheet() );
 		$this->assertSame( $styles, $theme_json->get_stylesheet( array( 'styles' ) ) );
 	}
 
 	/**
 	 * @ticket 54336
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_skips_disabled_protected_properties() {
 		$theme_json = new WP_Theme_JSON(
@@ -441,13 +455,15 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
 	}
 
 	/**
 	 * @ticket 54336
+	 * @ticket 58548
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_renders_enabled_protected_properties() {
 		$theme_json = new WP_Theme_JSON(
@@ -466,7 +482,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: 1em; }body { --wp--style--block-gap: 1em; }';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.wp-site-blocks) > * { margin-block-start: 1em; margin-block-end: 0; }:where(.wp-site-blocks) > :first-child:first-child { margin-block-start: 0; }:where(.wp-site-blocks) > :last-child:last-child { margin-block-end: 0; }body { --wp--style--block-gap: 1em; }:where(body .is-layout-flow)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-flow)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-flow)  > *{margin-block-start: 1em;margin-block-end: 0;}:where(body .is-layout-constrained)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-constrained)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-constrained)  > *{margin-block-start: 1em;margin-block-end: 0;}:where(body .is-layout-flex) {gap: 1em;}:where(body .is-layout-grid) {gap: 1em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
 	}
@@ -475,6 +491,8 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 * @ticket 53175
 	 * @ticket 54336
 	 * @ticket 56611
+	 * @ticket 58549
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet() {
 		$theme_json = new WP_Theme_JSON(
@@ -547,7 +565,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						),
 					),
 					'blocks'   => array(
-						'core/group'     => array(
+						'core/group'        => array(
 							'color'    => array(
 								'gradient' => 'var:preset|gradient|custom-gradient',
 							),
@@ -565,7 +583,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								'padding' => '24px',
 							),
 						),
-						'core/heading'   => array(
+						'core/heading'      => array(
 							'color'    => array(
 								'text' => '#123456',
 							),
@@ -581,7 +599,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								),
 							),
 						),
-						'core/post-date' => array(
+						'core/post-date'    => array(
 							'color'    => array(
 								'text' => '#123456',
 							),
@@ -594,7 +612,12 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								),
 							),
 						),
-						'core/image'     => array(
+						'core/post-excerpt' => array(
+							'typography' => array(
+								'textColumns' => 2,
+							),
+						),
+						'core/image'        => array(
 							'border'  => array(
 								'radius' => array(
 									'topLeft'     => '10px',
@@ -619,8 +642,8 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$variables = "body{--wp--preset--color--grey: grey;--wp--preset--gradient--custom-gradient: linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%);--wp--preset--duotone--custom-duotone: url('#wp-duotone-custom-duotone');--wp--preset--font-family--small: 14px;--wp--preset--font-family--big: 41px;}.wp-block-group{--wp--custom--base-font: 16;--wp--custom--line-height--small: 1.2;--wp--custom--line-height--medium: 1.4;--wp--custom--line-height--large: 1.8;}";
-		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{color: var(--wp--preset--color--grey);}a:where(:not(.wp-element-button)){background-color: #333;color: #111;}.wp-element-button, .wp-block-button__link{box-shadow: 10px 10px 5px 0px rgba(0,0,0,0.66);}.wp-block-group{background: var(--wp--preset--gradient--custom-gradient);border-radius: 10px;padding: 24px;}.wp-block-group a:where(:not(.wp-element-button)){color: #111;}.wp-block-heading{color: #123456;}.wp-block-heading a:where(:not(.wp-element-button)){background-color: #333;color: #111;font-size: 60px;}.wp-block-post-date{color: #123456;}.wp-block-post-date a:where(:not(.wp-element-button)){background-color: #777;color: #555;}.wp-block-image{margin-bottom: 30px;}.wp-block-image img, .wp-block-image .components-placeholder{filter: var(--wp--preset--duotone--custom-duotone);}.wp-block-image img, .wp-block-image .wp-block-image__crop-area{border-top-left-radius: 10px;border-bottom-right-radius: 1em;}';
+		$variables = 'body{--wp--preset--color--grey: grey;--wp--preset--gradient--custom-gradient: linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%);--wp--preset--font-family--small: 14px;--wp--preset--font-family--big: 41px;}.wp-block-group{--wp--custom--base-font: 16;--wp--custom--line-height--small: 1.2;--wp--custom--line-height--medium: 1.4;--wp--custom--line-height--large: 1.8;}';
+		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{color: var(--wp--preset--color--grey);}a:where(:not(.wp-element-button)){background-color: #333;color: #111;}.wp-element-button, .wp-block-button__link{box-shadow: 10px 10px 5px 0px rgba(0,0,0,0.66);}.wp-block-group{background: var(--wp--preset--gradient--custom-gradient);border-radius: 10px;padding: 24px;}.wp-block-group a:where(:not(.wp-element-button)){color: #111;}.wp-block-heading{color: #123456;}.wp-block-heading a:where(:not(.wp-element-button)){background-color: #333;color: #111;font-size: 60px;}.wp-block-post-date{color: #123456;}.wp-block-post-date a:where(:not(.wp-element-button)){background-color: #777;color: #555;}.wp-block-post-excerpt{column-count: 2;}.wp-block-image{margin-bottom: 30px;}.wp-block-image img, .wp-block-image .wp-block-image__crop-area, .wp-block-image .components-placeholder{border-top-left-radius: 10px;border-bottom-right-radius: 1em;}.wp-block-image img, .wp-block-image .components-placeholder{filter: var(--wp--preset--duotone--custom-duotone);}';
 		$presets   = '.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}.has-custom-gradient-gradient-background{background: var(--wp--preset--gradient--custom-gradient) !important;}.has-small-font-family{font-family: var(--wp--preset--font-family--small) !important;}.has-big-font-family{font-family: var(--wp--preset--font-family--big) !important;}';
 		$all       = $variables . $styles . $presets;
 		$this->assertSame( $all, $theme_json->get_stylesheet() );
@@ -663,6 +686,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	/**
 	 * @ticket 53175
 	 * @ticket 54336
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_preset_rules_come_after_block_rules() {
 		$theme_json = new WP_Theme_JSON(
@@ -694,7 +718,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-group{color: red;}';
+		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-group{color: red;}';
 		$presets   = '.wp-block-group.has-grey-color{color: var(--wp--preset--color--grey) !important;}.wp-block-group.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.wp-block-group.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}';
 		$variables = '.wp-block-group{--wp--preset--color--grey: grey;}';
 		$all       = $variables . $styles . $presets;
@@ -747,12 +771,12 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'body{--wp--preset--color--grey: grey;--wp--preset--color--dark-grey: grey;--wp--preset--color--light-grey: grey;--wp--preset--color--white-2-black: grey;--wp--custom--white-2-black: value;}',
 			$theme_json->get_stylesheet( array( 'variables' ) )
 		);
-
 	}
 
 	/**
 	 * @ticket 53175
 	 * @ticket 54336
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_preset_values_are_marked_as_important() {
 		$theme_json = new WP_Theme_JSON(
@@ -787,13 +811,14 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		);
 
 		$this->assertSame(
-			'body{--wp--preset--color--grey: grey;}body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }p{background-color: blue;color: red;font-size: 12px;line-height: 1.3;}.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}',
+			'body{--wp--preset--color--grey: grey;}body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}p{background-color: blue;color: red;font-size: 12px;line-height: 1.3;}.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}',
 			$theme_json->get_stylesheet()
 		);
 	}
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_handles_whitelisted_element_pseudo_selectors() {
 		$theme_json = new WP_Theme_JSON(
@@ -828,7 +853,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = 'a:where(:not(.wp-element-button)){background-color: red;color: green;}a:where(:not(.wp-element-button)):hover{background-color: green;color: red;font-size: 10em;text-transform: uppercase;}a:where(:not(.wp-element-button)):focus{background-color: black;color: yellow;}';
 
@@ -840,6 +865,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_handles_only_pseudo_selector_rules_for_given_property() {
 		$theme_json = new WP_Theme_JSON(
@@ -870,7 +896,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = 'a:where(:not(.wp-element-button)):hover{background-color: green;color: red;font-size: 10em;text-transform: uppercase;}a:where(:not(.wp-element-button)):focus{background-color: black;color: yellow;}';
 
@@ -882,6 +908,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_ignores_pseudo_selectors_on_non_whitelisted_elements() {
 		$theme_json = new WP_Theme_JSON(
@@ -912,7 +939,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = 'h4{background-color: red;color: green;}';
 
@@ -924,6 +951,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_ignores_non_whitelisted_pseudo_selectors() {
 		$theme_json = new WP_Theme_JSON(
@@ -954,7 +982,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = 'a:where(:not(.wp-element-button)){background-color: red;color: green;}a:where(:not(.wp-element-button)):hover{background-color: green;color: red;}';
 
@@ -967,6 +995,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_handles_priority_of_elements_vs_block_elements_pseudo_selectors() {
 		$theme_json = new WP_Theme_JSON(
@@ -1005,7 +1034,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = '.wp-block-group a:where(:not(.wp-element-button)){background-color: red;color: green;}.wp-block-group a:where(:not(.wp-element-button)):hover{background-color: green;color: red;font-size: 10em;text-transform: uppercase;}.wp-block-group a:where(:not(.wp-element-button)):focus{background-color: black;color: yellow;}';
 
@@ -1017,6 +1046,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_handles_whitelisted_block_level_element_pseudo_selectors() {
 		$theme_json = new WP_Theme_JSON(
@@ -1055,7 +1085,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = 'a:where(:not(.wp-element-button)){background-color: red;color: green;}a:where(:not(.wp-element-button)):hover{background-color: green;color: red;}.wp-block-group a:where(:not(.wp-element-button)):hover{background-color: black;color: yellow;}';
 
@@ -1971,30 +2001,30 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'version' => WP_Theme_JSON::LATEST_SCHEMA,
 			'styles'  => array(
 				'color'    => array(
-					'text' => 'var:preset|color|dark-red',
+					'text' => 'var(--wp--preset--color--dark-red)',
 				),
 				'elements' => array(
 					'link' => array(
 						'color' => array(
-							'text'       => 'var:preset|color|dark-pink',
-							'background' => 'var:preset|color|dark-red',
+							'text'       => 'var(--wp--preset--color--dark-pink)',
+							'background' => 'var(--wp--preset--color--dark-red)',
 						),
 					),
 				),
 				'blocks'   => array(
 					'core/image' => array(
 						'filter' => array(
-							'duotone' => 'var:preset|duotone|blue-red',
+							'duotone' => 'var(--wp--preset--duotone--blue-red)',
 						),
 					),
 					'core/group' => array(
 						'color'    => array(
-							'text' => 'var:preset|color|dark-gray',
+							'text' => 'var(--wp--preset--color--dark-gray)',
 						),
 						'elements' => array(
 							'link' => array(
 								'color' => array(
-									'text' => 'var:preset|color|dark-pink',
+									'text' => 'var(--wp--preset--color--dark-pink)',
 								),
 							),
 						),
@@ -3133,6 +3163,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 * e.g. array( 'ref' => 'styles.color.background' ) => "#ffffff".
 	 *
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_property_value_valid() {
 		$theme_json = new WP_Theme_JSON(
@@ -3155,7 +3186,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;color: #000000;}.wp-element-button, .wp-block-button__link{background-color: #000000;color: #ffffff;}';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{background-color: #ffffff;color: #000000;}.wp-element-button, .wp-block-button__link{background-color: #000000;color: #ffffff;}';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 	}
 
@@ -3212,6 +3243,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 * should be left untouched.
 	 *
 	 * @ticket 56467
+	 * @ticket 58550
 	 * @expectedIncorrectUsage get_property_value
 	 */
 	public function test_get_property_value_loop() {
@@ -3235,7 +3267,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;}.wp-element-button, .wp-block-button__link{color: #ffffff;}';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{background-color: #ffffff;}.wp-element-button, .wp-block-button__link{color: #ffffff;}';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 	}
 
@@ -3244,6 +3276,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 * should be left unprocessed.
 	 *
 	 * @ticket 56467
+	 * @ticket 58550
 	 * @expectedIncorrectUsage get_property_value
 	 */
 	public function test_get_property_value_recursion() {
@@ -3267,7 +3300,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;color: #ffffff;}.wp-element-button, .wp-block-button__link{color: #ffffff;}';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{background-color: #ffffff;color: #ffffff;}.wp-element-button, .wp-block-button__link{color: #ffffff;}';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 	}
 
@@ -3276,6 +3309,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 * should be left unprocessed.
 	 *
 	 * @ticket 56467
+	 * @ticket 58550
 	 * @expectedIncorrectUsage get_property_value
 	 */
 	public function test_get_property_value_self() {
@@ -3291,25 +3325,20 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;}';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{background-color: #ffffff;}';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 	}
 
 	/**
-	 * @dataProvider data_get_layout_definitions
-	 *
 	 * @ticket 56467
-	 *
-	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 * @ticket 58548
+	 * @ticket 58550
 	 */
-	public function test_get_stylesheet_generates_layout_styles( $layout_definitions ) {
+	public function test_get_stylesheet_generates_layout_styles() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'layout'  => array(
-						'definitions' => $layout_definitions,
-					),
 					'spacing' => array(
 						'blockGap' => true,
 					),
@@ -3325,26 +3354,21 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 		// Results also include root site blocks styles.
 		$this->assertSame(
-			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: 1em; }body { --wp--style--block-gap: 1em; }body .is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}body .is-layout-flow > * + *{margin-block-start: 1em;margin-block-end: 0;}body .is-layout-flex{gap: 1em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}',
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.wp-site-blocks) > * { margin-block-start: 1em; margin-block-end: 0; }:where(.wp-site-blocks) > :first-child:first-child { margin-block-start: 0; }:where(.wp-site-blocks) > :last-child:last-child { margin-block-end: 0; }body { --wp--style--block-gap: 1em; }:where(body .is-layout-flow)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-flow)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-flow)  > *{margin-block-start: 1em;margin-block-end: 0;}:where(body .is-layout-constrained)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-constrained)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-constrained)  > *{margin-block-start: 1em;margin-block-end: 0;}:where(body .is-layout-flex) {gap: 1em;}:where(body .is-layout-grid) {gap: 1em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}',
 			$theme_json->get_stylesheet( array( 'styles' ) )
 		);
 	}
 
 	/**
-	 * @dataProvider data_get_layout_definitions
-	 *
 	 * @ticket 56467
-	 *
-	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 * @ticket 58548
+	 * @ticket 58550
 	 */
-	public function test_get_stylesheet_generates_layout_styles_with_spacing_presets( $layout_definitions ) {
+	public function test_get_stylesheet_generates_layout_styles_with_spacing_presets() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'layout'  => array(
-						'definitions' => $layout_definitions,
-					),
 					'spacing' => array(
 						'blockGap' => true,
 					),
@@ -3360,26 +3384,20 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 		// Results also include root site blocks styles.
 		$this->assertSame(
-			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: var(--wp--preset--spacing--60); }body { --wp--style--block-gap: var(--wp--preset--spacing--60); }body .is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}body .is-layout-flow > * + *{margin-block-start: var(--wp--preset--spacing--60);margin-block-end: 0;}body .is-layout-flex{gap: var(--wp--preset--spacing--60);}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}',
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.wp-site-blocks) > * { margin-block-start: var(--wp--preset--spacing--60); margin-block-end: 0; }:where(.wp-site-blocks) > :first-child:first-child { margin-block-start: 0; }:where(.wp-site-blocks) > :last-child:last-child { margin-block-end: 0; }body { --wp--style--block-gap: var(--wp--preset--spacing--60); }:where(body .is-layout-flow)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-flow)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-flow)  > *{margin-block-start: var(--wp--preset--spacing--60);margin-block-end: 0;}:where(body .is-layout-constrained)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-constrained)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-constrained)  > *{margin-block-start: var(--wp--preset--spacing--60);margin-block-end: 0;}:where(body .is-layout-flex) {gap: var(--wp--preset--spacing--60);}:where(body .is-layout-grid) {gap: var(--wp--preset--spacing--60);}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}',
 			$theme_json->get_stylesheet( array( 'styles' ) )
 		);
 	}
 
 	/**
-	 * @dataProvider data_get_layout_definitions
-	 *
 	 * @ticket 56467
-	 *
-	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 * @ticket 58550
 	 */
-	public function test_get_stylesheet_generates_fallback_gap_layout_styles( $layout_definitions ) {
+	public function test_get_stylesheet_generates_fallback_gap_layout_styles() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'layout'  => array(
-						'definitions' => $layout_definitions,
-					),
 					'spacing' => array(
 						'blockGap' => null,
 					),
@@ -3396,26 +3414,20 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 		// Results also include root site blocks styles.
 		$this->assertSame(
-			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}',
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}',
 			$stylesheet
 		);
 	}
 
 	/**
-	 * @dataProvider data_get_layout_definitions
-	 *
 	 * @ticket 56467
-	 *
-	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 * @ticket 58550
 	 */
-	public function test_get_stylesheet_generates_base_fallback_gap_layout_styles( $layout_definitions ) {
+	public function test_get_stylesheet_generates_base_fallback_gap_layout_styles() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'layout'  => array(
-						'definitions' => $layout_definitions,
-					),
 					'spacing' => array(
 						'blockGap' => null,
 					),
@@ -3427,27 +3439,21 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 		// Note the `base-layout-styles` includes a fallback gap for the Columns block for backwards compatibility.
 		$this->assertSame(
-			':where(.is-layout-flex){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}',
+			':where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}:where(.wp-block-columns.is-layout-grid){gap: 2em;}:where(.wp-block-post-template.is-layout-flex){gap: 1.25em;}:where(.wp-block-post-template.is-layout-grid){gap: 1.25em;}',
 			$stylesheet
 		);
 	}
 
 	/**
-	 * @dataProvider data_get_layout_definitions
-	 *
 	 * @ticket 56467
-	 *
-	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 * @ticket 58550
 	 */
-	public function test_get_stylesheet_skips_layout_styles( $layout_definitions ) {
+	public function test_get_stylesheet_skips_layout_styles() {
 		add_theme_support( 'disable-layout-styles' );
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'layout'  => array(
-						'definitions' => $layout_definitions,
-					),
 					'spacing' => array(
 						'blockGap' => null,
 					),
@@ -3466,20 +3472,14 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_get_layout_definitions
-	 *
 	 * @ticket 56467
-	 *
-	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 * @ticket 58550
 	 */
-	public function test_get_stylesheet_generates_valid_block_gap_values_and_skips_null_or_false_values( $layout_definitions ) {
+	public function test_get_stylesheet_generates_valid_block_gap_values_and_skips_null_or_false_values() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'layout'  => array(
-						'definitions' => $layout_definitions,
-					),
 					'spacing' => array(
 						'blockGap' => true,
 					),
@@ -3516,98 +3516,14 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		);
 
 		$this->assertSame(
-			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: 1rem; }body { --wp--style--block-gap: 1rem; }body .is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}body .is-layout-flow > * + *{margin-block-start: 1rem;margin-block-end: 0;}body .is-layout-flex{gap: 1rem;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}.wp-block-post-content{color: gray;}.wp-block-social-links.is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-social-links.is-layout-flow > * + *{margin-block-start: 0;margin-block-end: 0;}.wp-block-social-links.is-layout-flex{gap: 0;}.wp-block-buttons.is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-buttons.is-layout-flow > * + *{margin-block-start: 0;margin-block-end: 0;}.wp-block-buttons.is-layout-flex{gap: 0;}',
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.wp-site-blocks) > * { margin-block-start: 1rem; margin-block-end: 0; }:where(.wp-site-blocks) > :first-child:first-child { margin-block-start: 0; }:where(.wp-site-blocks) > :last-child:last-child { margin-block-end: 0; }body { --wp--style--block-gap: 1rem; }:where(body .is-layout-flow)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-flow)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-flow)  > *{margin-block-start: 1rem;margin-block-end: 0;}:where(body .is-layout-constrained)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-constrained)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-constrained)  > *{margin-block-start: 1rem;margin-block-end: 0;}:where(body .is-layout-flex) {gap: 1rem;}:where(body .is-layout-grid) {gap: 1rem;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-post-content{color: gray;}.wp-block-social-links-is-layout-flow > :first-child:first-child{margin-block-start: 0;}.wp-block-social-links-is-layout-flow > :last-child:last-child{margin-block-end: 0;}.wp-block-social-links-is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-social-links-is-layout-constrained > :first-child:first-child{margin-block-start: 0;}.wp-block-social-links-is-layout-constrained > :last-child:last-child{margin-block-end: 0;}.wp-block-social-links-is-layout-constrained > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-social-links-is-layout-flex{gap: 0;}.wp-block-social-links-is-layout-grid{gap: 0;}.wp-block-buttons-is-layout-flow > :first-child:first-child{margin-block-start: 0;}.wp-block-buttons-is-layout-flow > :last-child:last-child{margin-block-end: 0;}.wp-block-buttons-is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-buttons-is-layout-constrained > :first-child:first-child{margin-block-start: 0;}.wp-block-buttons-is-layout-constrained > :last-child:last-child{margin-block-end: 0;}.wp-block-buttons-is-layout-constrained > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-buttons-is-layout-flex{gap: 0;}.wp-block-buttons-is-layout-grid{gap: 0;}',
 			$theme_json->get_stylesheet()
 		);
 	}
 
-	/**
-	 * Data provider for layout tests.
-	 *
-	 * @ticket 56467
-	 *
-	 * @return array
-	 */
-	public function data_get_layout_definitions() {
-		return array(
-			'layout definitions' => array(
-				array(
-					'default' => array(
-						'name'          => 'default',
-						'slug'          => 'flow',
-						'className'     => 'is-layout-flow',
-						'baseStyles'    => array(
-							array(
-								'selector' => ' > .alignleft',
-								'rules'    => array(
-									'float'               => 'left',
-									'margin-inline-start' => '0',
-									'margin-inline-end'   => '2em',
-								),
-							),
-							array(
-								'selector' => ' > .alignright',
-								'rules'    => array(
-									'float'               => 'right',
-									'margin-inline-start' => '2em',
-									'margin-inline-end'   => '0',
-								),
-							),
-							array(
-								'selector' => ' > .aligncenter',
-								'rules'    => array(
-									'margin-left'  => 'auto !important',
-									'margin-right' => 'auto !important',
-								),
-							),
-						),
-						'spacingStyles' => array(
-							array(
-								'selector' => ' > *',
-								'rules'    => array(
-									'margin-block-start' => '0',
-									'margin-block-end'   => '0',
-								),
-							),
-							array(
-								'selector' => ' > * + *',
-								'rules'    => array(
-									'margin-block-start' => null,
-									'margin-block-end'   => '0',
-								),
-							),
-						),
-					),
-					'flex'    => array(
-						'name'          => 'flex',
-						'slug'          => 'flex',
-						'className'     => 'is-layout-flex',
-						'displayMode'   => 'flex',
-						'baseStyles'    => array(
-							array(
-								'selector' => '',
-								'rules'    => array(
-									'flex-wrap'   => 'wrap',
-									'align-items' => 'center',
-								),
-							),
-						),
-						'spacingStyles' => array(
-							array(
-								'selector' => '',
-								'rules'    => array(
-									'gap' => null,
-								),
-							),
-						),
-					),
-				),
-			),
-		);
-	}
-
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_styles_for_block_with_padding_aware_alignments() {
 		$theme_json = new WP_Theme_JSON(
@@ -3634,7 +3550,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'selector' => 'body',
 		);
 
-		$expected    = 'body { margin: 0; }.wp-site-blocks { padding-top: var(--wp--style--root--padding-top); padding-bottom: var(--wp--style--root--padding-bottom); }.has-global-padding { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding :where(.has-global-padding) { padding-right: 0; padding-left: 0; }.has-global-padding > .alignfull { margin-right: calc(var(--wp--style--root--padding-right) * -1); margin-left: calc(var(--wp--style--root--padding-left) * -1); }.has-global-padding :where(.has-global-padding) > .alignfull { margin-right: 0; margin-left: 0; }.has-global-padding > .alignfull:where(:not(.has-global-padding)) > :where([class*="wp-block-"]:not(.alignfull):not([class*="__"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding :where(.has-global-padding) > .alignfull:where(:not(.has-global-padding)) > :where([class*="wp-block-"]:not(.alignfull):not([class*="__"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: 0; padding-left: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{--wp--style--root--padding-top: 10px;--wp--style--root--padding-right: 12px;--wp--style--root--padding-bottom: 10px;--wp--style--root--padding-left: 12px;}';
+		$expected    = 'body { margin: 0; }.wp-site-blocks { padding-top: var(--wp--style--root--padding-top); padding-bottom: var(--wp--style--root--padding-bottom); }.has-global-padding { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding :where(.has-global-padding:not(.wp-block-block)) { padding-right: 0; padding-left: 0; }.has-global-padding > .alignfull { margin-right: calc(var(--wp--style--root--padding-right) * -1); margin-left: calc(var(--wp--style--root--padding-left) * -1); }.has-global-padding :where(.has-global-padding:not(.wp-block-block)) > .alignfull { margin-right: 0; margin-left: 0; }.has-global-padding > .alignfull:where(:not(.has-global-padding):not(.is-layout-flex):not(.is-layout-grid)) > :where([class*="wp-block-"]:not(.alignfull):not([class*="__"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding :where(.has-global-padding) > .alignfull:where(:not(.has-global-padding)) > :where([class*="wp-block-"]:not(.alignfull):not([class*="__"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: 0; padding-left: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{--wp--style--root--padding-top: 10px;--wp--style--root--padding-right: 12px;--wp--style--root--padding-bottom: 10px;--wp--style--root--padding-left: 12px;}';
 		$root_rules  = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
 		$style_rules = $theme_json->get_styles_for_block( $metadata );
 		$this->assertSame( $expected, $root_rules . $style_rules );
@@ -3642,6 +3558,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_styles_for_block_without_padding_aware_alignments() {
 		$theme_json = new WP_Theme_JSON(
@@ -3665,7 +3582,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'selector' => 'body',
 		);
 
-		$expected    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{padding-top: 10px;padding-right: 12px;padding-bottom: 10px;padding-left: 12px;}';
+		$expected    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}body{padding-top: 10px;padding-right: 12px;padding-bottom: 10px;padding-left: 12px;}';
 		$root_rules  = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
 		$style_rules = $theme_json->get_styles_for_block( $metadata );
 		$this->assertSame( $expected, $root_rules . $style_rules );
@@ -3673,6 +3590,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 56467
+	 * @ticket 58550
 	 */
 	public function test_get_styles_for_block_with_content_width() {
 		$theme_json = new WP_Theme_JSON(
@@ -3692,12 +3610,60 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'selector' => 'body',
 		);
 
-		$expected    = 'body { margin: 0;--wp--style--global--content-size: 800px;--wp--style--global--wide-size: 1000px; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$expected    = 'body { margin: 0;--wp--style--global--content-size: 800px;--wp--style--global--wide-size: 1000px; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 		$root_rules  = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
 		$style_rules = $theme_json->get_styles_for_block( $metadata );
 		$this->assertSame( $expected, $root_rules . $style_rules );
 	}
 
+	/*
+	 * @ticket 58462
+	 */
+	public function test_sanitize_for_unregistered_style_variations() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'blocks' => array(
+						'core/quote' => array(
+							'variations' => array(
+								'unregisteredVariation' => array(
+									'color' => array(
+										'background' => 'hotpink',
+									),
+								),
+								'plain'                 => array(
+									'color' => array(
+										'background' => 'hotpink',
+									),
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$sanitized_theme_json = $theme_json->get_raw_data();
+		$expected             = array(
+			'version' => 2,
+			'styles'  => array(
+				'blocks' => array(
+					'core/quote' => array(
+						'variations' => array(
+							'plain' => array(
+								'color' => array(
+									'background' => 'hotpink',
+								),
+							),
+						),
+					),
+				),
+			),
+		);
+		$this->assertSameSetsWithIndex( $expected, $sanitized_theme_json, 'Sanitized theme.json styles does not match' );
+	}
+
 	/**
 	 * @ticket 57583
 	 *
@@ -3732,7 +3698,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 */
 	public function data_sanitize_for_block_with_style_variations() {
 		return array(
-			'1 variation with 1 invalid property'   => array(
+			'1 variation with 1 valid property'     => array(
 				'theme_json_variations' => array(
 					'variations' => array(
 						'plain' => array(
@@ -3782,44 +3748,6 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 					),
 				),
 			),
-			'2 variations with 1 invalid property'  => array(
-				'theme_json_variations' => array(
-					'variations' => array(
-						'plain' => array(
-							'color'            => array(
-								'background' => 'hotpink',
-							),
-							'invalidProperty1' => 'value1',
-						),
-						'basic' => array(
-							'color' => array(
-								'background' => '#ffffff',
-								'text'       => '#000000',
-							),
-							'foo'   => 'bar',
-						),
-					),
-				),
-				'expected_sanitized'    => array(
-					'blocks' => array(
-						'core/quote' => array(
-							'variations' => array(
-								'plain' => array(
-									'color' => array(
-										'background' => 'hotpink',
-									),
-								),
-								'basic' => array(
-									'color' => array(
-										'background' => '#ffffff',
-										'text'       => '#000000',
-									),
-								),
-							),
-						),
-					),
-				),
-			),
 		);
 	}
 
@@ -3846,7 +3774,6 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$sanitized_theme_json = $theme_json->get_raw_data();
 		$this->assertIsArray( $sanitized_theme_json, 'Sanitized theme.json is not an array data type' );
 		$this->assertArrayNotHasKey( 'styles', $sanitized_theme_json, 'Sanitized theme.json should not have a "styles" key' );
-
 	}
 
 	/**
@@ -3913,13 +3840,6 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			),
 			'styles'   => '.is-style-plain.is-style-plain.wp-block-quote{background-color: hotpink;}',
 		);
-		$basic = array(
-			'metadata' => array(
-				'path'     => array( 'styles', 'blocks', 'core/quote', 'variations', 'basic' ),
-				'selector' => '.is-style-basic.is-style-basic.wp-block-quote',
-			),
-			'styles'   => '.is-style-basic.is-style-basic.wp-block-quote{background-color: #ffffff;color: #000000;}',
-		);
 
 		return array(
 			'1 variation with 1 invalid property'   => array(
@@ -3950,56 +3870,92 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 				'metadata_variation'    => array( $plain['metadata'] ),
 				'expected'              => $plain['styles'],
 			),
-			'2 variations with 1 invalid property'  => array(
-				'theme_json_variations' => array(
-					'variations' => array(
-						'plain' => array(
-							'color'            => array(
-								'background' => 'hotpink',
-							),
-							'invalidProperty1' => 'value1',
+		);
+	}
+
+	public function test_block_style_variations() {
+		wp_set_current_user( static::$administrator_id );
+
+		$expected = array(
+			'version' => WP_Theme_JSON::LATEST_SCHEMA,
+			'styles'  => array(
+				'blocks' => array(
+					'core/button' => array(
+						'color'      => array(
+							'background' => 'blue',
 						),
-						'basic' => array(
-							'color' => array(
-								'background' => '#ffffff',
-								'text'       => '#000000',
+						'variations' => array(
+							'outline' => array(
+								'color' => array(
+									'background' => 'purple',
+								),
 							),
-							'foo'   => 'bar',
 						),
 					),
 				),
-				'metadata_variation'    => array( $plain['metadata'], $basic['metadata'] ),
-				'expected_styles'       => $plain['styles'] . $basic['styles'],
 			),
-			'2 variations with multiple invalid properties' => array(
-				'theme_json_variations' => array(
-					'variations' => array(
-						'plain' => array(
-							'color'            => array(
-								'background' => 'hotpink',
+		);
+
+		$actual = WP_Theme_JSON::remove_insecure_properties( $expected );
+
+		$this->assertSameSetsWithIndex( $expected, $actual );
+	}
+
+	public function test_block_style_variations_with_invalid_properties() {
+		wp_set_current_user( static::$administrator_id );
+
+		$partially_invalid_variation = array(
+			'version' => WP_Theme_JSON::LATEST_SCHEMA,
+			'styles'  => array(
+				'blocks' => array(
+					'core/button' => array(
+						'color'      => array(
+							'background' => 'blue',
+						),
+						'variations' => array(
+							'outline' => array(
+								'color'   => array(
+									'background' => 'purple',
+								),
+								'invalid' => array(
+									'value' => 'should be stripped',
+								),
 							),
-							'invalidProperty1' => 'value1',
-							'invalidProperty2' => 'value2',
 						),
-						'basic' => array(
-							'foo'   => 'foo',
-							'color' => array(
-								'background' => '#ffffff',
-								'text'       => '#000000',
+					),
+				),
+			),
+		);
+
+		$expected = array(
+			'version' => WP_Theme_JSON::LATEST_SCHEMA,
+			'styles'  => array(
+				'blocks' => array(
+					'core/button' => array(
+						'color'      => array(
+							'background' => 'blue',
+						),
+						'variations' => array(
+							'outline' => array(
+								'color' => array(
+									'background' => 'purple',
+								),
 							),
-							'bar'   => 'bar',
-							'baz'   => 'baz',
 						),
 					),
 				),
-				'metadata_variation'    => array( $plain['metadata'], $basic['metadata'] ),
-				'expected_styles'       => $plain['styles'] . $basic['styles'],
 			),
 		);
+
+		$actual = WP_Theme_JSON::remove_insecure_properties( $partially_invalid_variation );
+
+		$this->assertSameSetsWithIndex( $expected, $actual );
 	}
 
 	/**
 	 * @ticket 56611
+	 * @ticket 58548
+	 * @ticket 58550
 	 */
 	public function test_get_styles_with_appearance_tools() {
 		$theme_json = new WP_Theme_JSON(
@@ -4016,7 +3972,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'selector' => 'body',
 		);
 
-		$expected   = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: ; }body { --wp--style--block-gap: ; }';
+		$expected   = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.wp-site-blocks) > * { margin-block-start: ; margin-block-end: 0; }:where(.wp-site-blocks) > :first-child:first-child { margin-block-start: 0; }:where(.wp-site-blocks) > :last-child:last-child { margin-block-end: 0; }body { --wp--style--block-gap: ; }:where(body .is-layout-flow)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-flow)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-flow)  > *{margin-block-start: 1;margin-block-end: 0;}:where(body .is-layout-constrained)  > :first-child:first-child{margin-block-start: 0;}:where(body .is-layout-constrained)  > :last-child:last-child{margin-block-end: 0;}:where(body .is-layout-constrained)  > *{margin-block-start: 1;margin-block-end: 0;}:where(body .is-layout-flex) {gap: 1;}:where(body .is-layout-grid) {gap: 1;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 		$root_rules = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
 		$this->assertSame( $expected, $root_rules );
 	}
@@ -4406,6 +4362,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 * Tests the core separator block outbut based on various provided settings.
 	 *
 	 * @ticket 56903
+	 * @ticket 58550
 	 *
 	 * @dataProvider data_update_separator_declarations
 	 *
@@ -4445,7 +4402,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'background' => 'blue',
 					),
 				),
-				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-separator{background-color: blue;color: blue;}',
+				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-separator{background-color: blue;color: blue;}',
 			),
 			// If background and text are defined, do not include border-color, as text color is enough.
 			'background and text, no border-color' => array(
@@ -4455,7 +4412,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'text'       => 'red',
 					),
 				),
-				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-separator{background-color: blue;color: red;}',
+				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-separator{background-color: blue;color: red;}',
 			),
 			// If only text is defined, do not include border-color, as by itself is enough.
 			'only text'                            => array(
@@ -4464,9 +4421,9 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'text' => 'red',
 					),
 				),
-				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-separator{color: red;}',
+				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-separator{color: red;}',
 			),
-			// If background, text, and border-color are defined, include everything, CSS specifity will decide which to apply.
+			// If background, text, and border-color are defined, include everything, CSS specificity will decide which to apply.
 			'background, text, and border-color'   => array(
 				array(
 					'color'  => array(
@@ -4477,10 +4434,10 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'color' => 'pink',
 					),
 				),
-				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-separator{background-color: blue;border-color: pink;color: red;}',
+				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-separator{background-color: blue;border-color: pink;color: red;}',
 			),
-			// If background and border color are defined, include everything, CSS specifity will decide which to apply.
-			'background, text, and border-color'   => array(
+			// If background and border color are defined, include everything, CSS specificity will decide which to apply.
+			'background, and border-color'         => array(
 				array(
 					'color'  => array(
 						'background' => 'blue',
@@ -4489,13 +4446,14 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'color' => 'pink',
 					),
 				),
-				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-separator{background-color: blue;border-color: pink;}',
+				'expected_output' => 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}.wp-block-separator{background-color: blue;border-color: pink;}',
 			),
 		);
 	}
 
 	/**
 	 * @ticket 57354
+	 * @ticket 58550
 	 */
 	public function test_get_stylesheet_returns_outline_styles() {
 		$theme_json = new WP_Theme_JSON(
@@ -4524,7 +4482,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 
 		$element_styles = '.wp-element-button, .wp-block-button__link{outline-color: red;outline-offset: 3px;outline-style: dashed;outline-width: 3px;}.wp-element-button:hover, .wp-block-button__link:hover{outline-color: blue;outline-offset: 3px;outline-style: solid;outline-width: 3px;}';
 
@@ -4563,6 +4521,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 57559
+	 * @ticket 58550
 	 */
 	public function test_get_shadow_styles_for_blocks() {
 		$theme_json = new WP_Theme_JSON(
@@ -4596,7 +4555,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$global_styles   = 'body{--wp--preset--shadow--natural: 5px 5px 0 0 black;}body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$global_styles   = 'body{--wp--preset--shadow--natural: 5px 5px 0 0 black;}body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}:where(.is-layout-grid){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-constrained > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-constrained > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > :where(:not(.alignleft):not(.alignright):not(.alignfull)){max-width: var(--wp--style--global--content-size);margin-left: auto !important;margin-right: auto !important;}body .is-layout-constrained > .alignwide{max-width: var(--wp--style--global--wide-size);}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}body .is-layout-flex > *{margin: 0;}body .is-layout-grid{display: grid;}body .is-layout-grid > *{margin: 0;}';
 		$element_styles  = 'a:where(:not(.wp-element-button)){box-shadow: var(--wp--preset--shadow--natural);}.wp-element-button, .wp-block-button__link{box-shadow: var(--wp--preset--shadow--natural);}p{box-shadow: var(--wp--preset--shadow--natural);}';
 		$expected_styles = $global_styles . $element_styles;
 
@@ -4744,4 +4703,221 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	public function test_internal_syntax_is_converted_to_css_variables() {
+		$result = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'color'    => array(
+						'background' => 'var:preset|color|primary',
+						'text'       => 'var(--wp--preset--color--secondary)',
+					),
+					'elements' => array(
+						'link' => array(
+							'color' => array(
+								'background' => 'var:preset|color|pri',
+								'text'       => 'var(--wp--preset--color--sec)',
+							),
+						),
+					),
+					'blocks'   => array(
+						'core/post-terms' => array(
+							'typography' => array( 'fontSize' => 'var(--wp--preset--font-size--small)' ),
+							'color'      => array( 'background' => 'var:preset|color|secondary' ),
+						),
+						'core/navigation' => array(
+							'elements' => array(
+								'link' => array(
+									'color' => array(
+										'background' => 'var:preset|color|p',
+										'text'       => 'var(--wp--preset--color--s)',
+									),
+								),
+							),
+						),
+						'core/quote'      => array(
+							'typography' => array( 'fontSize' => 'var(--wp--preset--font-size--d)' ),
+							'color'      => array( 'background' => 'var:preset|color|d' ),
+							'variations' => array(
+								'plain' => array(
+									'typography' => array( 'fontSize' => 'var(--wp--preset--font-size--s)' ),
+									'color'      => array( 'background' => 'var:preset|color|s' ),
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+		$styles = $result->get_raw_data()['styles'];
+
+		$this->assertEquals( 'var(--wp--preset--color--primary)', $styles['color']['background'], 'Top level: Assert the originally correct values are still correct.' );
+		$this->assertEquals( 'var(--wp--preset--color--secondary)', $styles['color']['text'], 'Top level: Assert the originally correct values are still correct.' );
+
+		$this->assertEquals( 'var(--wp--preset--color--pri)', $styles['elements']['link']['color']['background'], 'Element top level: Assert the originally correct values are still correct.' );
+		$this->assertEquals( 'var(--wp--preset--color--sec)', $styles['elements']['link']['color']['text'], 'Element top level: Assert the originally correct values are still correct.' );
+
+		$this->assertEquals( 'var(--wp--preset--font-size--small)', $styles['blocks']['core/post-terms']['typography']['fontSize'], 'Top block level: Assert the originally correct values are still correct.' );
+		$this->assertEquals( 'var(--wp--preset--color--secondary)', $styles['blocks']['core/post-terms']['color']['background'], 'Top block level: Assert the internal variables are convert to CSS custom variables.' );
+
+		$this->assertEquals( 'var(--wp--preset--color--p)', $styles['blocks']['core/navigation']['elements']['link']['color']['background'], 'Elements block level: Assert the originally correct values are still correct.' );
+		$this->assertEquals( 'var(--wp--preset--color--s)', $styles['blocks']['core/navigation']['elements']['link']['color']['text'], 'Elements block level: Assert the originally correct values are still correct.' );
+
+		$this->assertEquals( 'var(--wp--preset--font-size--s)', $styles['blocks']['core/quote']['variations']['plain']['typography']['fontSize'], 'Style variations: Assert the originally correct values are still correct.' );
+		$this->assertEquals( 'var(--wp--preset--color--s)', $styles['blocks']['core/quote']['variations']['plain']['color']['background'], 'Style variations: Assert the internal variables are convert to CSS custom variables.' );
+	}
+
+	public function test_resolve_variables() {
+		$primary_color   = '#9DFF20';
+		$secondary_color = '#9DFF21';
+		$contrast_color  = '#000';
+		$raw_color_value = '#efefef';
+		$large_font      = '18px';
+		$small_font      = '12px';
+		$theme_json      = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'color'      => array(
+						'palette' => array(
+							'theme' => array(
+								array(
+									'color' => $primary_color,
+									'name'  => 'Primary',
+									'slug'  => 'primary',
+								),
+								array(
+									'color' => $secondary_color,
+									'name'  => 'Secondary',
+									'slug'  => 'secondary',
+								),
+								array(
+									'color' => $contrast_color,
+									'name'  => 'Contrast',
+									'slug'  => 'contrast',
+								),
+							),
+						),
+					),
+					'typography' => array(
+						'fontSizes' => array(
+							array(
+								'size' => $small_font,
+								'name' => 'Font size small',
+								'slug' => 'small',
+							),
+							array(
+								'size' => $large_font,
+								'name' => 'Font size large',
+								'slug' => 'large',
+							),
+						),
+					),
+				),
+				'styles'   => array(
+					'color'    => array(
+						'background' => 'var(--wp--preset--color--primary)',
+						'text'       => $raw_color_value,
+					),
+					'elements' => array(
+						'button' => array(
+							'color'      => array(
+								'text' => 'var(--wp--preset--color--contrast)',
+							),
+							'typography' => array(
+								'fontSize' => 'var(--wp--preset--font-size--small)',
+							),
+						),
+					),
+					'blocks'   => array(
+						'core/post-terms'      => array(
+							'typography' => array( 'fontSize' => 'var(--wp--preset--font-size--small)' ),
+							'color'      => array( 'background' => $raw_color_value ),
+						),
+						'core/more'            => array(
+							'typography' => array( 'fontSize' => 'var(--undefined--font-size--small)' ),
+							'color'      => array( 'background' => 'linear-gradient(90deg, var(--wp--preset--color--primary) 0%, var(--wp--preset--color--secondary) 35%, var(--wp--undefined--color--secondary) 100%)' ),
+						),
+						'core/comment-content' => array(
+							'typography' => array( 'fontSize' => 'calc(var(--wp--preset--font-size--small, 12px) + 20px)' ),
+							'color'      => array(
+								'text'       => 'var(--wp--preset--color--primary, red)',
+								'background' => 'var(--wp--preset--color--primary, var(--wp--preset--font-size--secondary))',
+								'link'       => 'var(--undefined--color--primary, var(--wp--preset--font-size--secondary))',
+							),
+						),
+						'core/comments'        => array(
+							'color' => array(
+								'text'       => 'var(--undefined--color--primary, var(--wp--preset--font-size--small))',
+								'background' => 'var(--wp--preset--color--primary, var(--undefined--color--primary))',
+							),
+						),
+						'core/navigation'      => array(
+							'elements' => array(
+								'link' => array(
+									'color'      => array(
+										'background' => 'var(--wp--preset--color--primary)',
+										'text'       => 'var(--wp--preset--color--secondary)',
+									),
+									'typography' => array(
+										'fontSize' => 'var(--wp--preset--font-size--large)',
+									),
+								),
+							),
+						),
+						'core/quote'           => array(
+							'typography' => array( 'fontSize' => 'var(--wp--preset--font-size--large)' ),
+							'color'      => array( 'background' => 'var(--wp--preset--color--primary)' ),
+							'variations' => array(
+								'plain' => array(
+									'typography' => array( 'fontSize' => 'var(--wp--preset--font-size--small)' ),
+									'color'      => array( 'background' => 'var(--wp--preset--color--secondary)' ),
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$styles = $theme_json::resolve_variables( $theme_json )->get_raw_data()['styles'];
+
+		$this->assertEquals( $primary_color, $styles['color']['background'], 'Top level: Assert values are converted' );
+		$this->assertEquals( $raw_color_value, $styles['color']['text'], 'Top level: Assert raw values stay intact' );
+
+		$this->assertEquals( $contrast_color, $styles['elements']['button']['color']['text'], 'Elements: color' );
+		$this->assertEquals( $small_font, $styles['elements']['button']['typography']['fontSize'], 'Elements: font-size' );
+
+		$this->assertEquals( $large_font, $styles['blocks']['core/quote']['typography']['fontSize'], 'Blocks: font-size' );
+		$this->assertEquals( $primary_color, $styles['blocks']['core/quote']['color']['background'], 'Blocks: color' );
+		$this->assertEquals( $raw_color_value, $styles['blocks']['core/post-terms']['color']['background'], 'Blocks: Raw color value stays intact' );
+		$this->assertEquals( $small_font, $styles['blocks']['core/post-terms']['typography']['fontSize'], 'Block core/post-terms: font-size' );
+		$this->assertEquals(
+			"linear-gradient(90deg, $primary_color 0%, $secondary_color 35%, var(--wp--undefined--color--secondary) 100%)",
+			$styles['blocks']['core/more']['color']['background'],
+			'Blocks: multiple colors and undefined color'
+		);
+		$this->assertEquals( 'var(--undefined--font-size--small)', $styles['blocks']['core/more']['typography']['fontSize'], 'Blocks: undefined font-size ' );
+		$this->assertEquals( "calc($small_font + 20px)", $styles['blocks']['core/comment-content']['typography']['fontSize'], 'Blocks: font-size in random place' );
+		$this->assertEquals( $primary_color, $styles['blocks']['core/comment-content']['color']['text'], 'Blocks: text color with fallback' );
+		$this->assertEquals( $primary_color, $styles['blocks']['core/comment-content']['color']['background'], 'Blocks: background color with var as fallback' );
+		$this->assertEquals( $primary_color, $styles['blocks']['core/navigation']['elements']['link']['color']['background'], 'Block element: background color' );
+		$this->assertEquals( $secondary_color, $styles['blocks']['core/navigation']['elements']['link']['color']['text'], 'Block element: text color' );
+		$this->assertEquals( $large_font, $styles['blocks']['core/navigation']['elements']['link']['typography']['fontSize'], 'Block element: font-size' );
+
+		$this->assertEquals(
+			"var(--undefined--color--primary, $small_font)",
+			$styles['blocks']['core/comments']['color']['text'],
+			'Blocks: text color with undefined var and fallback'
+		);
+		$this->assertEquals(
+			$primary_color,
+			$styles['blocks']['core/comments']['color']['background'],
+			'Blocks: background color with variable and undefined fallback'
+		);
+
+		$this->assertEquals( $small_font, $styles['blocks']['core/quote']['variations']['plain']['typography']['fontSize'], 'Block variations: font-size' );
+		$this->assertEquals( $secondary_color, $styles['blocks']['core/quote']['variations']['plain']['color']['background'], 'Block variations: color' );
+	}
 }
diff --git a/tests/theme/wpThemeJsonResolver.php b/tests/theme/wpThemeJsonResolver.php
index f013542e2e..cc7cfa2f65 100644
--- a/tests/theme/wpThemeJsonResolver.php
+++ b/tests/theme/wpThemeJsonResolver.php
@@ -81,8 +81,8 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 	}
 
 	public static function tear_down_after_class() {
-		static::$property_blocks_cache->setValue( WP_Theme_JSON_Resolver::class, static::$property_blocks_cache_orig_value );
-		static::$property_core->setValue( WP_Theme_JSON_Resolver::class, static::$property_core_orig_value );
+		static::$property_blocks_cache->setValue( null, static::$property_blocks_cache_orig_value );
+		static::$property_core->setValue( null, static::$property_core_orig_value );
 		parent::tear_down_after_class();
 	}
 
@@ -393,7 +393,7 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		$expected_filter_count = did_filter( 'wp_theme_json_data_default' );
 		$actual                = WP_Theme_JSON_Resolver::get_core_data();
 		if ( $should_fire_filter ) {
-			$expected_filter_count++;
+			++$expected_filter_count;
 		}
 
 		$this->assertSame( $expected_filter_count, did_filter( 'wp_theme_json_data_default' ), 'The filter "wp_theme_json_data_default" should fire the given number of times' );
@@ -600,7 +600,7 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		$global_styles_query_count = 0;
 		add_filter(
 			'query',
-			function( $query ) use ( &$global_styles_query_count ) {
+			static function ( $query ) use ( &$global_styles_query_count ) {
 				if ( preg_match( '#post_type = \'wp_global_styles\'#', $query ) ) {
 					$global_styles_query_count++;
 				}
@@ -759,7 +759,7 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		// Force-unset $i18n_schema property to "unload" translation schema.
 		$property = new ReflectionProperty( $theme_json_resolver, 'i18n_schema' );
 		$property->setAccessible( true );
-		$property->setValue( null );
+		$property->setValue( null, null );
 
 		// A completely empty theme.json data set still has the 'version' key when parsed.
 		$empty_theme_json = array( 'version' => WP_Theme_JSON::LATEST_SCHEMA );
@@ -836,7 +836,7 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		$styles     = $theme_json->get_styles_block_nodes();
 		$styles     = array_filter(
 			$styles,
-			static function( $element ) {
+			static function ( $element ) {
 				return isset( $element['name'] ) && 'my/block-with-styles' === $element['name'];
 			}
 		);
@@ -846,7 +846,6 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		$this->assertSame( $block_styles, count( $styles ) === 1, $block_styles_text );
 		$this->assertSame( $theme_palette, isset( $settings['color']['palette']['theme'] ), $theme_palette_text );
 		$this->assertSame( $user_palette, isset( $settings['color']['palette']['custom'] ), $user_palette_text );
-
 	}
 
 	/**
@@ -953,7 +952,7 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 	 * @ticket 57545
 	 *
 	 * @covers WP_Theme_JSON_Resolver::get_style_variations
-	 **/
+	 */
 	public function test_get_style_variations_returns_all_variations() {
 		// Switch to a child theme.
 		switch_theme( 'block-theme-child' );
diff --git a/tests/upload.php b/tests/upload.php
index 4640439313..46fcea7099 100644
--- a/tests/upload.php
+++ b/tests/upload.php
@@ -105,5 +105,4 @@ class Tests_Upload extends WP_UnitTestCase {
 		$this->assertSame( $subdir, $info['subdir'] );
 		$this->assertFalse( $info['error'] );
 	}
-
 }
diff --git a/tests/url.php b/tests/url.php
index 1561d3a03c..4768e25b77 100644
--- a/tests/url.php
+++ b/tests/url.php
@@ -339,7 +339,7 @@ class Tests_URL extends WP_UnitTestCase {
 			$this->assertSame( $http_links[ $i ], set_url_scheme( $link, 'login' ) );
 			$this->assertSame( $http_links[ $i ], set_url_scheme( $link, 'rpc' ) );
 
-			$i++;
+			++$i;
 		}
 
 		force_ssl_admin( $forced_admin );
diff --git a/tests/user.php b/tests/user.php
index 7157a00cfa..9a3f0084b8 100644
--- a/tests/user.php
+++ b/tests/user.php
@@ -140,7 +140,6 @@ class Tests_User extends WP_UnitTestCase {
 		// Correct key: deleted.
 		delete_user_meta( self::$author_id, $key, $val );
 		$this->assertSame( '', get_user_meta( self::$author_id, $key, true ) );
-
 	}
 
 	/**
@@ -1940,7 +1939,6 @@ class Tests_User extends WP_UnitTestCase {
 		// Contains location longitude.
 		$this->assertSame( 'Longitude', $actual['data'][1]['data'][3]['name'] );
 		$this->assertSame( '-84.5143900', $actual['data'][1]['data'][3]['value'] );
-
 	}
 
 	/**
@@ -2085,15 +2083,13 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertCount( 12, $actual['data'][0]['data'] );
 
 		// Check that the item added by the filter was retained.
-		$this->assertSame(
+		$this->assertCount(
 			1,
-			count(
-				wp_list_filter(
-					$actual['data'][0]['data'],
-					array(
-						'name'  => 'Test Additional Data Name',
-						'value' => 'Test Additional Data Value',
-					)
+			wp_list_filter(
+				$actual['data'][0]['data'],
+				array(
+					'name'  => 'Test Additional Data Name',
+					'value' => 'Test Additional Data Value',
 				)
 			)
 		);
@@ -2117,28 +2113,24 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertCount( 12, $actual['data'][0]['data'] );
 
 		// Check that the duplicate 'name' => 'User ID' was stripped.
-		$this->assertSame(
+		$this->assertCount(
 			1,
-			count(
-				wp_list_filter(
-					$actual['data'][0]['data'],
-					array(
-						'name' => 'User ID',
-					)
+			wp_list_filter(
+				$actual['data'][0]['data'],
+				array(
+					'name' => 'User ID',
 				)
 			)
 		);
 
 		// Check that the item added by the filter was retained.
-		$this->assertSame(
+		$this->assertCount(
 			1,
-			count(
-				wp_list_filter(
-					$actual['data'][0]['data'],
-					array(
-						'name'  => 'Test Additional Data Name',
-						'value' => 'Test Additional Data Value',
-					)
+			wp_list_filter(
+				$actual['data'][0]['data'],
+				array(
+					'name'  => 'Test Additional Data Name',
+					'value' => 'Test Additional Data Value',
 				)
 			)
 		);
diff --git a/tests/user/author.php b/tests/user/author.php
deleted file mode 100644
index 311bbcd6f2..0000000000
--- a/tests/user/author.php
+++ /dev/null
@@ -1,178 +0,0 @@
-<?php
-
-/**
- * Test functions in wp-includes/author-template.php
- *
- * @group author
- * @group user
- */
-class Tests_User_Author_Template extends WP_UnitTestCase {
-	protected static $author_id = 0;
-	protected static $post_id   = 0;
-
-	private $permalink_structure;
-
-	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
-		self::$author_id = $factory->user->create(
-			array(
-				'role'         => 'author',
-				'user_login'   => 'test_author',
-				'display_name' => 'Test Author',
-				'description'  => 'test_author',
-				'user_url'     => 'http://example.com',
-			)
-		);
-
-		self::$post_id = $factory->post->create(
-			array(
-				'post_author'  => self::$author_id,
-				'post_status'  => 'publish',
-				'post_content' => 'content',
-				'post_title'   => 'title',
-				'post_type'    => 'post',
-			)
-		);
-	}
-
-	public function set_up() {
-		parent::set_up();
-
-		setup_postdata( get_post( self::$post_id ) );
-	}
-
-	public function test_get_the_author() {
-		$author_name = get_the_author();
-		$user        = new WP_User( self::$author_id );
-
-		$this->assertSame( $user->display_name, $author_name );
-		$this->assertSame( 'Test Author', $author_name );
-	}
-
-	public function test_get_the_author_meta() {
-		$this->assertSame( 'test_author', get_the_author_meta( 'login' ) );
-		$this->assertSame( 'test_author', get_the_author_meta( 'user_login' ) );
-		$this->assertSame( 'Test Author', get_the_author_meta( 'display_name' ) );
-
-		$this->assertSame( 'test_author', trim( get_the_author_meta( 'description' ) ) );
-		$this->assertSame( 'test_author', get_the_author_meta( 'user_description' ) );
-		add_user_meta( self::$author_id, 'user_description', 'user description' );
-		$this->assertSame( 'user description', get_user_meta( self::$author_id, 'user_description', true ) );
-		// user_description in meta is ignored. The content of description is returned instead.
-		// See #20285.
-		$this->assertSame( 'test_author', get_the_author_meta( 'user_description' ) );
-		$this->assertSame( 'test_author', trim( get_the_author_meta( 'description' ) ) );
-		update_user_meta( self::$author_id, 'user_description', '' );
-		$this->assertSame( '', get_user_meta( self::$author_id, 'user_description', true ) );
-		$this->assertSame( 'test_author', get_the_author_meta( 'user_description' ) );
-		$this->assertSame( 'test_author', trim( get_the_author_meta( 'description' ) ) );
-
-		$this->assertSame( '', get_the_author_meta( 'does_not_exist' ) );
-	}
-
-	public function test_get_the_author_meta_no_authordata() {
-		unset( $GLOBALS['authordata'] );
-		$this->assertSame( '', get_the_author_meta( 'id' ) );
-		$this->assertSame( '', get_the_author_meta( 'user_login' ) );
-		$this->assertSame( '', get_the_author_meta( 'does_not_exist' ) );
-	}
-
-	public function test_get_the_author_posts() {
-		// Test with no global post, result should be 0 because no author is found.
-		$this->assertSame( 0, get_the_author_posts() );
-		$GLOBALS['post'] = self::$post_id;
-		$this->assertEquals( 1, get_the_author_posts() );
-	}
-
-	/**
-	 * @ticket 30904
-	 */
-	public function test_get_the_author_posts_with_custom_post_type() {
-		register_post_type( 'wptests_pt' );
-
-		$cpt_ids         = self::factory()->post->create_many(
-			2,
-			array(
-				'post_author' => self::$author_id,
-				'post_type'   => 'wptests_pt',
-			)
-		);
-		$GLOBALS['post'] = $cpt_ids[0];
-
-		$this->assertEquals( 2, get_the_author_posts() );
-
-		_unregister_post_type( 'wptests_pt' );
-	}
-
-	/**
-	 * @ticket 30355
-	 */
-	public function test_get_the_author_posts_link_no_permalinks() {
-		$author = get_userdata( self::$author_id );
-
-		$GLOBALS['authordata'] = $author->data;
-
-		$link = get_the_author_posts_link();
-
-		$url = sprintf( 'http://%1$s/?author=%2$s', WP_TESTS_DOMAIN, $author->ID );
-
-		$this->assertStringContainsString( $url, $link );
-		$this->assertStringContainsString( 'Posts by Test Author', $link );
-		$this->assertStringContainsString( '>Test Author</a>', $link );
-
-		unset( $GLOBALS['authordata'] );
-	}
-
-	/**
-	 * @ticket 30355
-	 */
-	public function test_get_the_author_posts_link_with_permalinks() {
-		$this->set_permalink_structure( '/%postname%/' );
-
-		$author = get_userdata( self::$author_id );
-
-		$GLOBALS['authordata'] = $author;
-
-		$link = get_the_author_posts_link();
-
-		$url = sprintf( 'http://%1$s/author/%2$s/', WP_TESTS_DOMAIN, $author->user_nicename );
-
-		$this->set_permalink_structure( '' );
-
-		$this->assertStringContainsString( $url, $link );
-		$this->assertStringContainsString( 'Posts by Test Author', $link );
-		$this->assertStringContainsString( '>Test Author</a>', $link );
-
-		unset( $GLOBALS['authordata'] );
-	}
-
-	/**
-	 * @ticket 51859
-	 *
-	 * @covers ::get_the_author_link
-	 */
-	public function test_get_the_author_link() {
-		$author_url          = get_the_author_meta( 'url' );
-		$author_display_name = get_the_author();
-
-		$link = get_the_author_link();
-
-		$this->assertStringContainsString( $author_url, $link, 'The link does not contain the author URL' );
-		$this->assertStringContainsString( $author_display_name, $link, 'The link does not contain the author display name' );
-	}
-
-	/**
-	 * @ticket 51859
-	 *
-	 * @covers ::get_the_author_link
-	 */
-	public function test_filtered_get_the_author_link() {
-		$filter = new MockAction();
-
-		add_filter( 'the_author_link', array( &$filter, 'filter' ) );
-
-		get_the_author_link();
-
-		$this->assertSame( 1, $filter->get_call_count() );
-		$this->assertSame( array( 'the_author_link' ), $filter->get_hook_names() );
-	}
-}
diff --git a/tests/user/capabilities.php b/tests/user/capabilities.php
index beecfd3b85..27bd085aff 100644
--- a/tests/user/capabilities.php
+++ b/tests/user/capabilities.php
@@ -66,7 +66,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		parent::set_up();
 		// Keep track of users we create.
 		$this->flush_roles();
-
 	}
 
 	/**
@@ -182,7 +181,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 			'subscriber'              => array( 'subscriber' ),
 
 		);
-
 	}
 
 	private function _getMultiSitePrimitiveCaps() {
@@ -265,7 +263,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 			'subscriber'              => array( 'subscriber' ),
 
 		);
-
 	}
 
 	private function _getSingleSiteMetaCaps() {
@@ -453,7 +450,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 			$this->assertSame( array(), $diff, "User with {$role} role has capabilities that aren't being tested" );
 
 		}
-
 	}
 
 	/**
@@ -747,7 +743,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 		update_option( 'link_manager_enabled', '0' );
 		$this->assertSame( '0', get_option( 'link_manager_enabled' ) );
-
 	}
 
 	/**
@@ -761,7 +756,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 			$this->assertFalse( $user->has_cap( 'unfiltered_upload' ), "User with the {$role} role should not have the unfiltered_upload capability" );
 			$this->assertFalse( user_can( $user, 'unfiltered_upload' ), "User with the {$role} role should not have the unfiltered_upload capability" );
 		}
-
 	}
 
 	/**
@@ -917,7 +911,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$user->remove_role( 'contributor' );
 		// User should have one role now.
 		$this->assertSame( array( 'subscriber' ), $user->roles );
-
 	}
 
 	/**
@@ -1037,7 +1030,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		remove_role( $role_name );
 		$this->flush_roles();
 		$this->assertFalse( $wp_roles->is_role( $role_name ) );
-
 	}
 
 	/**
@@ -1082,7 +1074,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		remove_role( $role_name );
 		$this->flush_roles();
 		$this->assertFalse( $wp_roles->is_role( $role_name ) );
-
 	}
 
 	/**
@@ -1121,7 +1112,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 				$this->assertFalse( $user_1->has_cap( $cap ), "User should not have the {$cap} capability" );
 			}
 		}
-
 	}
 
 	/**
@@ -1153,7 +1143,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		// Check the removed cap on both users.
 		$this->assertFalse( $user_1->has_cap( 'publish_posts' ) );
 		$this->assertFalse( $user_2->has_cap( 'publish_posts' ) );
-
 	}
 
 	/**
@@ -1217,7 +1206,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 		// User level should be empty.
 		$this->assertEmpty( $user->user_level );
-
 	}
 
 	/**
@@ -1547,7 +1535,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 				"Role: {$role}"
 			);
 		}
-
 	}
 
 	public function dataTaxonomies() {
@@ -1850,7 +1837,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		// Ensure contributor can't edit, un-trash, or delete the post.
 		$this->assertFalse( user_can( $contributor->ID, 'edit_post', $post->ID ) );
 		$this->assertFalse( user_can( $contributor->ID, 'delete_post', $post->ID ) );
-
 	}
 
 	/**
@@ -1981,7 +1967,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$this->assertFalse( user_can( $contributor->ID, 'edit_post', $author_post->ID ) );
 
 		_unregister_post_type( 'page_capability' );
-
 	}
 
 	public function test_non_logged_in_users_have_no_capabilities() {
@@ -2011,7 +1996,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		wp_logout();
 
 		$this->assertSame( 0, get_current_user_id() );
-
 	}
 
 	/**
diff --git a/tests/user/countUsers.php b/tests/user/countUsers.php
index b09cd85784..901ba88f89 100644
--- a/tests/user/countUsers.php
+++ b/tests/user/countUsers.php
@@ -64,7 +64,6 @@ class Tests_User_CountUsers extends WP_UnitTestCase {
 			),
 			$count['avail_roles']
 		);
-
 	}
 
 	/**
@@ -174,7 +173,6 @@ class Tests_User_CountUsers extends WP_UnitTestCase {
 			),
 			$count['avail_roles']
 		);
-
 	}
 
 	/**
@@ -248,7 +246,6 @@ class Tests_User_CountUsers extends WP_UnitTestCase {
 			),
 			$count['avail_roles']
 		);
-
 	}
 
 	/**
@@ -291,5 +288,4 @@ class Tests_User_CountUsers extends WP_UnitTestCase {
 			),
 		);
 	}
-
 }
diff --git a/tests/user/getTheAuthor.php b/tests/user/getTheAuthor.php
new file mode 100644
index 0000000000..ebddcb3d5a
--- /dev/null
+++ b/tests/user/getTheAuthor.php
@@ -0,0 +1,57 @@
+<?php
+
+/**
+ * @group author
+ * @group user
+ *
+ * @covers ::get_the_author
+ */
+class Tests_User_GetTheAuthor extends WP_UnitTestCase {
+	protected static $author_id = 0;
+	protected static $post_id   = 0;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_id = $factory->user->create(
+			array(
+				'role'         => 'author',
+				'user_login'   => 'test_author',
+				'display_name' => 'Test Author',
+				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
+			)
+		);
+
+		self::$post_id = $factory->post->create(
+			array(
+				'post_author'  => self::$author_id,
+				'post_status'  => 'publish',
+				'post_content' => 'content',
+				'post_title'   => 'title',
+				'post_type'    => 'post',
+			)
+		);
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		setup_postdata( get_post( self::$post_id ) );
+	}
+
+	public function test_get_the_author() {
+		$author_name = get_the_author();
+		$user        = new WP_User( self::$author_id );
+
+		$this->assertSame( $user->display_name, $author_name );
+		$this->assertSame( 'Test Author', $author_name );
+	}
+
+	/**
+	 * @ticket 58157
+	 */
+	public function test_get_the_author_should_return_empty_string_if_authordata_is_not_set() {
+		unset( $GLOBALS['authordata'] );
+
+		$this->assertSame( '', get_the_author() );
+	}
+}
diff --git a/tests/user/getTheAuthorLink.php b/tests/user/getTheAuthorLink.php
new file mode 100644
index 0000000000..ce44774f1c
--- /dev/null
+++ b/tests/user/getTheAuthorLink.php
@@ -0,0 +1,71 @@
+<?php
+
+/**
+ * @group author
+ * @group user
+ *
+ * @covers ::get_the_author_link
+ */
+class Tests_User_GetTheAuthorLink extends WP_UnitTestCase {
+	protected static $author_id = 0;
+	protected static $post_id   = 0;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_id = $factory->user->create(
+			array(
+				'role'         => 'author',
+				'user_login'   => 'test_author',
+				'display_name' => 'Test Author',
+				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
+			)
+		);
+
+		self::$post_id = $factory->post->create(
+			array(
+				'post_author'  => self::$author_id,
+				'post_status'  => 'publish',
+				'post_content' => 'content',
+				'post_title'   => 'title',
+				'post_type'    => 'post',
+			)
+		);
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		setup_postdata( get_post( self::$post_id ) );
+	}
+
+	/**
+	 * @ticket 51859
+	 *
+	 * @covers ::get_the_author_link
+	 */
+	public function test_get_the_author_link() {
+		$author_url          = get_the_author_meta( 'url' );
+		$author_display_name = get_the_author();
+
+		$link = get_the_author_link();
+
+		$this->assertStringContainsString( $author_url, $link, 'The link does not contain the author URL' );
+		$this->assertStringContainsString( $author_display_name, $link, 'The link does not contain the author display name' );
+	}
+
+	/**
+	 * @ticket 51859
+	 *
+	 * @covers ::get_the_author_link
+	 */
+	public function test_filtered_get_the_author_link() {
+		$filter = new MockAction();
+
+		add_filter( 'the_author_link', array( &$filter, 'filter' ) );
+
+		get_the_author_link();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+		$this->assertSame( array( 'the_author_link' ), $filter->get_hook_names() );
+	}
+}
diff --git a/tests/user/getTheAuthorMeta.php b/tests/user/getTheAuthorMeta.php
new file mode 100644
index 0000000000..d9d225812b
--- /dev/null
+++ b/tests/user/getTheAuthorMeta.php
@@ -0,0 +1,75 @@
+<?php
+
+/**
+ * @group author
+ * @group user
+ *
+ * @covers ::get_the_author_meta
+ */
+class Tests_User_GetTheAuthorMeta extends WP_UnitTestCase {
+	protected static $author_id = 0;
+	protected static $post_id   = 0;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_id = $factory->user->create(
+			array(
+				'role'         => 'author',
+				'user_login'   => 'test_author',
+				'display_name' => 'Test Author',
+				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
+			)
+		);
+
+		self::$post_id = $factory->post->create(
+			array(
+				'post_author'  => self::$author_id,
+				'post_status'  => 'publish',
+				'post_content' => 'content',
+				'post_title'   => 'title',
+				'post_type'    => 'post',
+			)
+		);
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		setup_postdata( get_post( self::$post_id ) );
+	}
+
+	public function test_get_the_author_meta() {
+		$this->assertSame( 'test_author', get_the_author_meta( 'login' ) );
+		$this->assertSame( 'test_author', get_the_author_meta( 'user_login' ) );
+		$this->assertSame( 'Test Author', get_the_author_meta( 'display_name' ) );
+
+		$this->assertSame( 'test_author', trim( get_the_author_meta( 'description' ) ) );
+		$this->assertSame( 'test_author', get_the_author_meta( 'user_description' ) );
+
+		add_user_meta( self::$author_id, 'user_description', 'user description' );
+		$this->assertSame( 'user description', get_user_meta( self::$author_id, 'user_description', true ) );
+		// user_description in meta is ignored. The content of description is returned instead.
+		// See #20285.
+		$this->assertSame( 'test_author', get_the_author_meta( 'user_description' ) );
+		$this->assertSame( 'test_author', trim( get_the_author_meta( 'description' ) ) );
+
+		update_user_meta( self::$author_id, 'user_description', '' );
+		$this->assertSame( '', get_user_meta( self::$author_id, 'user_description', true ) );
+		$this->assertSame( 'test_author', get_the_author_meta( 'user_description' ) );
+		$this->assertSame( 'test_author', trim( get_the_author_meta( 'description' ) ) );
+
+		$this->assertSame( '', get_the_author_meta( 'does_not_exist' ) );
+	}
+
+	/**
+	 * @ticket 20529
+	 * @ticket 58157
+	 */
+	public function test_get_the_author_meta_should_return_empty_string_if_authordata_is_not_set() {
+		unset( $GLOBALS['authordata'] );
+
+		$this->assertSame( '', get_the_author_meta( 'id' ) );
+		$this->assertSame( '', get_the_author_meta( 'user_login' ) );
+		$this->assertSame( '', get_the_author_meta( 'does_not_exist' ) );
+	}
+}
diff --git a/tests/user/getTheAuthorPosts.php b/tests/user/getTheAuthorPosts.php
new file mode 100644
index 0000000000..5cd87bc79b
--- /dev/null
+++ b/tests/user/getTheAuthorPosts.php
@@ -0,0 +1,67 @@
+<?php
+
+/**
+ * @group author
+ * @group user
+ *
+ * @covers ::get_the_author_posts
+ */
+class Tests_User_GetTheAuthorPosts extends WP_UnitTestCase {
+	protected static $author_id = 0;
+	protected static $post_id   = 0;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_id = $factory->user->create(
+			array(
+				'role'         => 'author',
+				'user_login'   => 'test_author',
+				'display_name' => 'Test Author',
+				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
+			)
+		);
+
+		self::$post_id = $factory->post->create(
+			array(
+				'post_author'  => self::$author_id,
+				'post_status'  => 'publish',
+				'post_content' => 'content',
+				'post_title'   => 'title',
+				'post_type'    => 'post',
+			)
+		);
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		setup_postdata( get_post( self::$post_id ) );
+	}
+
+	public function test_get_the_author_posts() {
+		// Test with no global post, result should be 0 because no author is found.
+		$this->assertSame( 0, get_the_author_posts() );
+		$GLOBALS['post'] = self::$post_id;
+		$this->assertEquals( 1, get_the_author_posts() );
+	}
+
+	/**
+	 * @ticket 30904
+	 */
+	public function test_get_the_author_posts_with_custom_post_type() {
+		register_post_type( 'wptests_pt' );
+
+		$cpt_ids         = self::factory()->post->create_many(
+			2,
+			array(
+				'post_author' => self::$author_id,
+				'post_type'   => 'wptests_pt',
+			)
+		);
+		$GLOBALS['post'] = $cpt_ids[0];
+
+		$this->assertEquals( 2, get_the_author_posts() );
+
+		_unregister_post_type( 'wptests_pt' );
+	}
+}
diff --git a/tests/user/getTheAuthorPostsLink.php b/tests/user/getTheAuthorPostsLink.php
new file mode 100644
index 0000000000..3fd96774df
--- /dev/null
+++ b/tests/user/getTheAuthorPostsLink.php
@@ -0,0 +1,91 @@
+<?php
+
+/**
+ * @group author
+ * @group user
+ *
+ * @covers ::get_the_author_posts_link
+ */
+class Tests_User_GetTheAuthorPostsLink extends WP_UnitTestCase {
+	protected static $author_id = 0;
+	protected static $post_id   = 0;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_id = $factory->user->create(
+			array(
+				'role'         => 'author',
+				'user_login'   => 'test_author',
+				'display_name' => 'Test Author',
+				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
+			)
+		);
+
+		self::$post_id = $factory->post->create(
+			array(
+				'post_author'  => self::$author_id,
+				'post_status'  => 'publish',
+				'post_content' => 'content',
+				'post_title'   => 'title',
+				'post_type'    => 'post',
+			)
+		);
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		setup_postdata( get_post( self::$post_id ) );
+	}
+
+	/**
+	 * @ticket 30355
+	 */
+	public function test_get_the_author_posts_link_no_permalinks() {
+		$author = get_userdata( self::$author_id );
+
+		$GLOBALS['authordata'] = $author->data;
+
+		$link = get_the_author_posts_link();
+
+		$url = sprintf( 'http://%1$s/?author=%2$s', WP_TESTS_DOMAIN, $author->ID );
+
+		$this->assertStringContainsString( $url, $link );
+		$this->assertStringContainsString( 'Posts by Test Author', $link );
+		$this->assertStringContainsString( '>Test Author</a>', $link );
+
+		unset( $GLOBALS['authordata'] );
+	}
+
+	/**
+	 * @ticket 30355
+	 */
+	public function test_get_the_author_posts_link_with_permalinks() {
+		$this->set_permalink_structure( '/%postname%/' );
+
+		$author = get_userdata( self::$author_id );
+
+		$GLOBALS['authordata'] = $author;
+
+		$link = get_the_author_posts_link();
+
+		$url = sprintf( 'http://%1$s/author/%2$s/', WP_TESTS_DOMAIN, $author->user_nicename );
+
+		$this->set_permalink_structure( '' );
+
+		$this->assertStringContainsString( $url, $link );
+		$this->assertStringContainsString( 'Posts by Test Author', $link );
+		$this->assertStringContainsString( '>Test Author</a>', $link );
+
+		unset( $GLOBALS['authordata'] );
+	}
+
+	/**
+	 * @ticket 58157
+	 */
+	public function test_get_the_author_posts_link_should_return_empty_string_if_authordata_is_not_set() {
+		unset( $GLOBALS['authordata'] );
+
+		$this->assertSame( '', get_the_author_posts_link() );
+	}
+}
diff --git a/tests/user/getTheModifiedAuthor.php b/tests/user/getTheModifiedAuthor.php
new file mode 100644
index 0000000000..4a797bcbc6
--- /dev/null
+++ b/tests/user/getTheModifiedAuthor.php
@@ -0,0 +1,59 @@
+<?php
+
+/**
+ * @group author
+ * @group user
+ *
+ * @covers ::get_the_modified_author
+ */
+class Tests_User_GetTheModifiedAuthor extends WP_UnitTestCase {
+	protected static $author_id = 0;
+	protected static $post_id   = 0;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_id = $factory->user->create(
+			array(
+				'role'         => 'author',
+				'user_login'   => 'test_author',
+				'display_name' => 'Test Author',
+				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
+			)
+		);
+
+		self::$post_id = $factory->post->create(
+			array(
+				'post_author'  => self::$author_id,
+				'post_status'  => 'publish',
+				'post_content' => 'content',
+				'post_title'   => 'title',
+				'post_type'    => 'post',
+			)
+		);
+
+		add_post_meta( self::$post_id, '_edit_last', self::$author_id );
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		$GLOBALS['post'] = self::$post_id;
+	}
+
+	public function test_get_the_modified_author() {
+		$author_name = get_the_modified_author();
+		$user        = new WP_User( self::$author_id );
+
+		$this->assertSame( $user->display_name, $author_name );
+		$this->assertSame( 'Test Author', $author_name );
+	}
+
+	/**
+	 * @ticket 58157
+	 */
+	public function test_get_the_modified_author_should_return_empty_string_if_user_id_does_not_exist() {
+		update_post_meta( self::$post_id, '_edit_last', -1 );
+
+		$this->assertSame( '', get_the_modified_author() );
+	}
+}
diff --git a/tests/user/getUserCount.php b/tests/user/getUserCount.php
index 4aee753288..5ec6e481a9 100644
--- a/tests/user/getUserCount.php
+++ b/tests/user/getUserCount.php
@@ -81,7 +81,6 @@ class Tests_User_GetUserCount extends WP_UnitTestCase {
 
 		$count = get_user_count();
 		$this->assertSame( $start_count + 1, $count );
-
 	}
 
 	/**
diff --git a/tests/user/mapMetaCap.php b/tests/user/mapMetaCap.php
index fb26eca8b5..f8929f0d88 100644
--- a/tests/user/mapMetaCap.php
+++ b/tests/user/mapMetaCap.php
@@ -369,7 +369,6 @@ class Tests_User_MapMetaCap extends WP_UnitTestCase {
 
 		$this->assertSame( array( 'edit_others_posts', 'edit_published_posts' ), map_meta_cap( 'edit_post', $editor, $post_id ) );
 		$this->assertSame( array( 'delete_others_posts', 'delete_published_posts' ), map_meta_cap( 'delete_post', $editor, $post_id ) );
-
 	}
 
 	/**
diff --git a/tests/user/multisite.php b/tests/user/multisite.php
index 23079f4799..08d08bbe75 100644
--- a/tests/user/multisite.php
+++ b/tests/user/multisite.php
@@ -59,15 +59,15 @@ if ( is_multisite() ) :
 			// Each site retrieved should match the expected structure.
 			foreach ( $blogs_of_user as $blog_id => $blog ) {
 				$this->assertSame( $blog_id, $blog->userblog_id );
-				$this->assertObjectHasAttribute( 'userblog_id', $blog );
-				$this->assertObjectHasAttribute( 'blogname', $blog );
-				$this->assertObjectHasAttribute( 'domain', $blog );
-				$this->assertObjectHasAttribute( 'path', $blog );
-				$this->assertObjectHasAttribute( 'site_id', $blog );
-				$this->assertObjectHasAttribute( 'siteurl', $blog );
-				$this->assertObjectHasAttribute( 'archived', $blog );
-				$this->assertObjectHasAttribute( 'spam', $blog );
-				$this->assertObjectHasAttribute( 'deleted', $blog );
+				$this->assertObjectHasProperty( 'userblog_id', $blog );
+				$this->assertObjectHasProperty( 'blogname', $blog );
+				$this->assertObjectHasProperty( 'domain', $blog );
+				$this->assertObjectHasProperty( 'path', $blog );
+				$this->assertObjectHasProperty( 'site_id', $blog );
+				$this->assertObjectHasProperty( 'siteurl', $blog );
+				$this->assertObjectHasProperty( 'archived', $blog );
+				$this->assertObjectHasProperty( 'spam', $blog );
+				$this->assertObjectHasProperty( 'deleted', $blog );
 			}
 
 			// Mark each remaining site as spam, archived, and deleted.
@@ -448,7 +448,6 @@ if ( is_multisite() ) :
 
 			$wp_roles->remove_role( $role );
 		}
-
 	}
 
 endif;
diff --git a/tests/user/passwordHash.php b/tests/user/passwordHash.php
index 1179ba25b2..db34969c71 100644
--- a/tests/user/passwordHash.php
+++ b/tests/user/passwordHash.php
@@ -30,5 +30,4 @@ class Tests_User_PasswordHash extends WP_UnitTestCase {
 		$hasher = new PasswordHash( 8, true );
 		$hasher->gensalt_blowfish( 'a password string' );
 	}
-
 }
diff --git a/tests/user/query.php b/tests/user/query.php
index 85170997d3..21275738e7 100644
--- a/tests/user/query.php
+++ b/tests/user/query.php
@@ -1321,7 +1321,6 @@ class Tests_User_Query extends WP_UnitTestCase {
 		foreach ( $query_vars as $query_var ) {
 			$this->assertArrayHasKey( $query_var, $q->query_vars, "$query_var does not exist." );
 		}
-
 	}
 
 	public function filter_pre_get_users_args( $q ) {
@@ -1720,11 +1719,9 @@ class Tests_User_Query extends WP_UnitTestCase {
 	 * @ticket 44169
 	 */
 	public function test_users_pre_query_filter_should_bypass_database_query() {
-		global $wpdb;
-
 		add_filter( 'users_pre_query', array( __CLASS__, 'filter_users_pre_query' ), 10, 2 );
 
-		$num_queries = $wpdb->num_queries;
+		$num_queries = get_num_queries();
 		$q           = new WP_User_Query(
 			array(
 				'fields' => 'ID',
@@ -1734,7 +1731,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 		remove_filter( 'users_pre_query', array( __CLASS__, 'filter_users_pre_query' ), 10, 2 );
 
 		// Make sure no queries were executed.
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		$this->assertSame( $num_queries, get_num_queries() );
 
 		// We manually inserted a non-existing user and overrode the results with it.
 		$this->assertSame( array( 555 ), $q->results );
@@ -2229,4 +2226,156 @@ class Tests_User_Query extends WP_UnitTestCase {
 		$results = $q->get_results();
 		$this->assertNotFalse( DateTime::createFromFormat( 'Y-m-d H:i:s', $results[0] ) );
 	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__get()
+	 *
+	 * @param string $property_name Property name to get.
+	 * @param mixed $expected       Expected value.
+	 */
+	public function test_should_get_compat_fields( $property_name, $expected ) {
+		$user_query = new WP_User_Query();
+
+		$this->assertSame( $expected, $user_query->$property_name );
+	}
+
+	/**
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__get()
+	 */
+	public function test_should_throw_deprecation_when_getting_dynamic_property() {
+		$user_query = new WP_User_Query();
+
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_User_Query::__get(): ' .
+			'The property `undefined_property` is not declared. Getting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->assertNull( $user_query->undefined_property, 'Getting a dynamic property should return null from WP_User_Query::__get()' );
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__set()
+	 *
+	 * @param string $property_name Property name to set.
+	 */
+	public function test_should_set_compat_fields( $property_name ) {
+		$user_query = new WP_User_Query();
+		$value      = uniqid();
+
+		$user_query->$property_name = $value;
+		$this->assertSame( $value, $user_query->$property_name );
+	}
+
+	/**
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__set()
+	 */
+	public function test_should_throw_deprecation_when_setting_dynamic_property() {
+		$user_query = new WP_User_Query();
+
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_User_Query::__set(): ' .
+			'The property `undefined_property` is not declared. Setting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$user_query->undefined_property = 'some value';
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__isset()
+	 *
+	 * @param string $property_name Property name to check.
+	 * @param mixed $expected       Expected value.
+	 */
+	public function test_should_isset_compat_fields( $property_name, $expected ) {
+		$user_query = new WP_User_Query();
+
+		$actual = isset( $user_query->$property_name );
+		if ( is_null( $expected ) ) {
+			$this->assertFalse( $actual );
+		} else {
+			$this->assertTrue( $actual );
+		}
+	}
+
+	/**
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__isset()
+	 */
+	public function test_should_throw_deprecation_when_isset_of_dynamic_property() {
+		$user_query = new WP_User_Query();
+
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_User_Query::__isset(): ' .
+			'The property `undefined_property` is not declared. Checking `isset()` on a dynamic property ' .
+			'is deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		$this->assertFalse( isset( $user_query->undefined_property ), 'Checking a dynamic property should return false from WP_User_Query::__isset()' );
+	}
+
+	/**
+	 * @dataProvider data_compat_fields
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__unset()
+	 *
+	 * @param string $property_name Property name to unset.
+	 */
+	public function test_should_unset_compat_fields( $property_name ) {
+		$user_query = new WP_User_Query();
+
+		unset( $user_query->$property_name );
+		$this->assertFalse( isset( $user_query->$property_name ) );
+	}
+
+	/**
+	 * @ticket 58897
+	 *
+	 * @covers WP_User_Query::__unset()
+	 */
+	public function test_should_throw_deprecation_when_unset_of_dynamic_property() {
+		$user_query = new WP_User_Query();
+
+		$this->expectDeprecation();
+		$this->expectDeprecationMessage(
+			'WP_User_Query::__unset(): ' .
+			'A property `undefined_property` is not declared. Unsetting a dynamic property is ' .
+			'deprecated since version 6.4.0! Instead, declare the property on the class.'
+		);
+		unset( $user_query->undefined_property );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_compat_fields() {
+		return array(
+			'results'     => array(
+				'property_name' => 'results',
+				'expected'      => null,
+			),
+			'total_users' => array(
+				'property_name' => 'total_users',
+				'expected'      => 0,
+			),
+		);
+	}
 }
diff --git a/tests/user/queryCache.php b/tests/user/queryCache.php
new file mode 100644
index 0000000000..7e63907f74
--- /dev/null
+++ b/tests/user/queryCache.php
@@ -0,0 +1,803 @@
+<?php
+/**
+ * Test WP_User Query, in wp-includes/user.php
+ *
+ * @group user
+ *
+ * @coversDefaultClass WP_User_Query
+ */
+class Tests_User_Query_Cache extends WP_UnitTestCase {
+	/**
+	 * @var int[]
+	 */
+	protected static $author_ids;
+
+	/**
+	 * @var int[]
+	 */
+	protected static $sub_ids;
+
+	/**
+	 * @var int[]
+	 */
+	protected static $editor_ids;
+
+	/**
+	 * @var int[]
+	 */
+	protected static $contrib_id;
+
+	/**
+	 * @var int[]
+	 */
+	protected static $admin_ids;
+
+	/**
+	 * @var int[]
+	 */
+	protected $user_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$author_ids = $factory->user->create_many(
+			4,
+			array(
+				'role' => 'author',
+			)
+		);
+
+		self::$sub_ids = $factory->user->create_many(
+			2,
+			array(
+				'role' => 'subscriber',
+			)
+		);
+
+		self::$editor_ids = $factory->user->create_many(
+			3,
+			array(
+				'role' => 'editor',
+			)
+		);
+
+		self::$contrib_id = $factory->user->create(
+			array(
+				'role' => 'contributor',
+			)
+		);
+
+		self::$admin_ids = $factory->user->create_many(
+			2,
+			array(
+				'role' => 'administrator',
+			)
+		);
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_different_count() {
+		$args = array(
+			'count_total' => true,
+		);
+
+		$query1       = new WP_User_Query( $args );
+		$users1       = wp_list_pluck( $query1->get_results(), 'ID' );
+		$users_total1 = $query1->get_total();
+
+		$queries_before = get_num_queries();
+
+		$args = array(
+			'count_total' => false,
+		);
+
+		$query2        = new WP_User_Query( $args );
+		$users2        = wp_list_pluck( $query2->get_results(), 'ID' );
+		$users_total2  = $query2->get_total();
+		$queries_after = get_num_queries();
+
+		$this->assertNotSame( $queries_before, $queries_after, 'Assert that the number of queries is not equal' );
+		$this->assertNotSame( $users_total1, $users_total2, 'Assert that totals do not match' );
+		$this->assertSameSets( $users1, $users2, 'Results of the query are expected to match.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_results() {
+		$args = array(
+			'cache_results' => true,
+		);
+
+		$query1 = new WP_User_Query( $args );
+		$users1 = wp_list_pluck( $query1->get_results(), 'ID' );
+
+		$queries_before = get_num_queries();
+
+		$args = array(
+			'cache_results' => false,
+		);
+
+		$query2        = new WP_User_Query( $args );
+		$users2        = wp_list_pluck( $query2->get_results(), 'ID' );
+		$queries_after = get_num_queries();
+
+		$this->assertNotSame( $queries_before, $queries_after, 'Assert that queries are run' );
+		$this->assertSameSets( $users1, $users2, 'Results of the query are expected to match.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 * @expectedDeprecated WP_User_Query
+	 */
+	public function test_query_cache_who() {
+		$args = array(
+			'who'    => 'authors',
+			'fields' => array( 'ID' ),
+		);
+
+		$query1       = new WP_User_Query( $args );
+		$users1       = $query1->get_results();
+		$users_total1 = $query1->get_total();
+
+		$queries_before = get_num_queries();
+		$query2         = new WP_User_Query( $args );
+		$users2         = $query2->get_results();
+		$users_total2   = $query2->get_total();
+		$queries_after  = get_num_queries();
+
+		$this->assertSame( $queries_before, $queries_after, 'No queries are expected run.' );
+		$this->assertSame( $users_total1, $users_total2, 'Number of users returned us expected to match.' );
+		$this->assertSameSets( $users1, $users2, 'Results of the query are expected to match.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 * @dataProvider data_query_cache
+	 * @param array $args Optional. See WP_User_Query::prepare_query()
+	 */
+	public function test_query_cache( array $args ) {
+		$query1       = new WP_User_Query( $args );
+		$users1       = $query1->get_results();
+		$users_total1 = $query1->get_total();
+
+		$queries_before = get_num_queries();
+		$query2         = new WP_User_Query( $args );
+		$users2         = $query2->get_results();
+		$users_total2   = $query2->get_total();
+		$queries_after  = get_num_queries();
+
+		$this->assertSame( 0, $queries_after - $queries_before, 'Assert that no queries are run' );
+		$this->assertSame( $users_total1, $users_total2, 'Assert that totals do match' );
+		$this->assertSameSets( $users1, $users2, 'Asset that results of query match' );
+	}
+
+	/**
+	 * Data provider
+	 *
+	 * @return array
+	 */
+	public function data_query_cache() {
+		$data = array(
+			'id'                    => array(
+				'args' => array( 'fields' => array( 'id' ) ),
+
+			),
+			'ID'                    => array(
+				'args' => array( 'fields' => array( 'ID' ) ),
+			),
+			'user_login'            => array(
+				'args' => array( 'fields' => array( 'user_login' ) ),
+			),
+			'user_nicename'         => array(
+				'args' => array( 'fields' => array( 'user_nicename' ) ),
+			),
+			'user_email'            => array(
+				'args' => array( 'fields' => array( 'user_email' ) ),
+			),
+			'user_url'              => array(
+				'args' => array( 'fields' => array( 'user_url' ) ),
+			),
+			'user_status'           => array(
+				'args' => array( 'fields' => array( 'user_status' ) ),
+			),
+			'display_name'          => array(
+				'args' => array( 'fields' => array( 'display_name' ) ),
+			),
+			'invalid_field'         => array(
+				'args' => array( 'fields' => array( 'invalid_field' ) ),
+			),
+			'valid array inc id'    => array(
+				'args' => array( 'fields' => array( 'display_name', 'user_email', 'id' ) ),
+			),
+			'valid array inc ID'    => array(
+				'args' => array( 'fields' => array( 'display_name', 'user_email', 'ID' ) ),
+			),
+			'partly valid array'    => array(
+				'args' => array( 'fields' => array( 'display_name', 'invalid_field' ) ),
+			),
+			'orderby'               => array(
+				'args' => array(
+					'fields'  => array( 'ID' ),
+					'orderby' => array( 'login', 'nicename' ),
+				),
+			),
+			'meta query'            => array(
+				'args' => array(
+					'fields'     => array( 'ID' ),
+					'meta_query' => array(
+						'foo_key' => array(
+							'key'     => 'foo',
+							'compare' => 'EXISTS',
+						),
+					),
+					'orderby'    => 'foo_key',
+					'order'      => 'DESC',
+				),
+			),
+			'meta query LIKE'       => array(
+				'args' => array(
+					'fields'     => array( 'ID' ),
+					'meta_query' => array(
+						array(
+							'key'     => 'foo',
+							'value'   => '00',
+							'compare' => 'LIKE',
+						),
+					),
+					'orderby'    => 'foo_key',
+					'order'      => 'DESC',
+				),
+			),
+			'published posts'       => array(
+				'args' => array(
+					'has_published_posts' => true,
+					'fields'              => array( 'ID' ),
+				),
+			),
+			'published posts order' => array(
+				'args' => array(
+					'orderby' => 'post_count',
+					'fields'  => array( 'ID' ),
+				),
+			),
+			'published count_total' => array(
+				'args' => array(
+
+					'count_total' => false,
+					'fields'      => array( 'ID' ),
+				),
+			),
+			'capability'            => array(
+				'args' => array(
+					'capability' => 'install_plugins',
+					'fields'     => array( 'ID' ),
+				),
+			),
+			'include'               => array(
+				'args' => array(
+					'includes' => self::$author_ids,
+					'fields'   => array( 'ID' ),
+				),
+			),
+			'exclude'               => array(
+				'args' => array(
+					'exclude' => self::$author_ids,
+					'fields'  => array( 'ID' ),
+				),
+			),
+			'search'                => array(
+				'args' => array(
+					'search' => 'User',
+					'fields' => array( 'ID' ),
+				),
+			),
+		);
+
+		if ( is_multisite() ) {
+			$data['spam']    = array(
+				'args' => array( 'fields' => array( 'spam' ) ),
+			);
+			$data['deleted'] = array(
+				'args' => array( 'fields' => array( 'deleted' ) ),
+			);
+		}
+
+		return $data;
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_remove_user_role() {
+		$user_id = self::factory()->user->create( array( 'role' => 'author' ) );
+
+		$q1 = new WP_User_Query(
+			array(
+				'role' => 'author',
+			)
+		);
+
+		$found = wp_list_pluck( $q1->get_results(), 'ID' );
+
+		$this->assertContains( $user_id, $found, 'Expected to find author in returned values.' );
+
+		$user = get_user_by( 'id', $user_id );
+		$user->remove_role( 'author' );
+
+		$q2 = new WP_User_Query(
+			array(
+				'role' => 'author',
+			)
+		);
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertNotContains( $user_id, $found, 'Expected not to find author in returned values.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_set_user_role() {
+		$user_id = self::factory()->user->create( array( 'role' => 'author' ) );
+
+		$q1 = new WP_User_Query(
+			array(
+				'role' => 'author',
+			)
+		);
+
+		$found = wp_list_pluck( $q1->get_results(), 'ID' );
+
+		$this->assertContains( $user_id, $found, 'Expected to find author in returned values.' );
+
+		$user = get_user_by( 'id', $user_id );
+		$user->set_role( 'editor' );
+
+		$q2 = new WP_User_Query(
+			array(
+				'role' => 'author',
+			)
+		);
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertNotContains( $user_id, $found, 'Expected not to find author in returned values.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_delete_user() {
+		$user_id = self::factory()->user->create();
+
+		$q1 = new WP_User_Query(
+			array(
+				'include' => array( $user_id ),
+			)
+		);
+
+		$found    = wp_list_pluck( $q1->get_results(), 'ID' );
+		$expected = array( $user_id );
+
+		$this->assertSameSets( $expected, $found, 'Find author in returned values' );
+
+		wp_delete_user( $user_id );
+
+		$q2 = new WP_User_Query(
+			array(
+				'include' => array( $user_id ),
+			)
+		);
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertNotContains( $user_id, $found, 'Expected not to find author in returned values.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_do_not_cache() {
+		$user_id = self::factory()->user->create();
+
+		$args = array(
+			'fields'  => array(
+				'user_login',
+				'user_nicename',
+				'user_email',
+				'user_url',
+				'user_status',
+				'display_name',
+			),
+			'include' => array( $user_id ),
+		);
+
+		$q1       = new WP_User_Query( $args );
+		$found1   = $q1->get_results();
+		$callback = static function ( $user ) {
+			return (array) $user;
+		};
+
+		$found1 = array_map( $callback, $found1 );
+
+		$queries_before = get_num_queries();
+		$q2             = new WP_User_Query( $args );
+		$found2         = $q2->get_results();
+		$found2         = array_map( $callback, $found2 );
+		$queries_after  = get_num_queries();
+
+		$this->assertSame( $queries_after - $queries_before, 2, 'Ensure that query is not cached' );
+		$this->assertSameSets( $found1, $found2, 'Expected results to match.', 'Ensure that to results match' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_update_user() {
+		$user_id = end( self::$admin_ids );
+
+		wp_update_user(
+			array(
+				'ID'            => $user_id,
+				'user_nicename' => 'paul',
+			)
+		);
+
+		$args = array(
+			'nicename__in' => array( 'paul' ),
+		);
+
+		$q1 = new WP_User_Query( $args );
+
+		$found    = wp_list_pluck( $q1->get_results(), 'ID' );
+		$expected = array( $user_id );
+
+		$this->assertSameSets( $expected, $found, 'Find author in returned values' );
+
+		wp_update_user(
+			array(
+				'ID'            => $user_id,
+				'user_nicename' => 'linda',
+			)
+		);
+
+		$q2 = new WP_User_Query( $args );
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertNotContains( $user_id, $found, 'Expected not to find author in returned values.' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_query_cache_create_user() {
+		$user_id = end( self::$admin_ids );
+
+		$args = array( 'blog_id' => get_current_blog_id() );
+
+		$q1 = new WP_User_Query( $args );
+
+		$found = wp_list_pluck( $q1->get_results(), 'ID' );
+
+		$this->assertContains( $user_id, $found, 'Expected to find author in returned values.' );
+
+		$user_id_2 = self::factory()->user->create();
+
+		$q2 = new WP_User_Query( $args );
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertContains( $user_id_2, $found, 'Find author in returned values' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_has_published_posts_delete_post() {
+		register_post_type( 'wptests_pt_public', array( 'public' => true ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_author' => self::$author_ids[2],
+				'post_status' => 'publish',
+				'post_type'   => 'wptests_pt_public',
+			)
+		);
+
+		$q1 = new WP_User_Query(
+			array(
+				'has_published_posts' => true,
+			)
+		);
+
+		$found    = wp_list_pluck( $q1->get_results(), 'ID' );
+		$expected = array( self::$author_ids[2] );
+
+		$this->assertSameSets( $expected, $found, 'Find author in returned values' );
+
+		wp_delete_post( $post_id, true );
+
+		$q2 = new WP_User_Query(
+			array(
+				'has_published_posts' => true,
+			)
+		);
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertSameSets( array(), $found, 'Not to find author in returned values' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_has_published_posts_delete_post_order() {
+		register_post_type( 'wptests_pt_public', array( 'public' => true ) );
+
+		$user_id = self::factory()->user->create();
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_author' => $user_id,
+				'post_status' => 'publish',
+				'post_type'   => 'wptests_pt_public',
+			)
+		);
+
+		$q1 = new WP_User_Query(
+			array(
+				'orderby' => 'post_count',
+			)
+		);
+
+		$found1 = wp_list_pluck( $q1->get_results(), 'ID' );
+		$this->assertContains( $user_id, $found1, 'Find author in returned values in first run of WP_User_Query' );
+
+		wp_delete_post( $post_id, true );
+
+		$q2 = new WP_User_Query(
+			array(
+				'orderby' => 'post_count',
+			)
+		);
+
+		$found2 = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertContains( $user_id, $found1, 'Find author in returned values in second run of WP_User_Query' );
+		$this->assertSameSets( $found1, $found2, 'Not same order' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @covers ::query
+	 */
+	public function test_meta_query_cache_invalidation() {
+		add_user_meta( self::$author_ids[0], 'foo', 'bar' );
+		add_user_meta( self::$author_ids[1], 'foo', 'bar' );
+
+		$q1 = new WP_User_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'key'   => 'foo',
+						'value' => 'bar',
+					),
+				),
+			)
+		);
+
+		$found    = wp_list_pluck( $q1->get_results(), 'ID' );
+		$expected = array( self::$author_ids[0], self::$author_ids[1] );
+
+		$this->assertSameSets( $expected, $found, 'Asset that results contain authors' );
+
+		delete_user_meta( self::$author_ids[1], 'foo' );
+
+		$q2 = new WP_User_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'key'   => 'foo',
+						'value' => 'bar',
+					),
+				),
+			)
+		);
+
+		$found    = wp_list_pluck( $q2->get_results(), 'ID' );
+		$expected = array( self::$author_ids[0] );
+
+		$this->assertSameSets( $expected, $found, 'Asset that results do not contain author without meta' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @group ms-required
+	 * @covers ::query
+	 */
+	public function test_get_single_capability_multisite_blog_id() {
+		$blog_id = self::factory()->blog->create();
+
+		add_user_to_blog( $blog_id, self::$author_ids[0], 'subscriber' );
+		add_user_to_blog( $blog_id, self::$author_ids[1], 'author' );
+		add_user_to_blog( $blog_id, self::$author_ids[2], 'editor' );
+
+		$q1 = new WP_User_Query(
+			array(
+				'capability' => 'publish_posts',
+				'blog_id'    => $blog_id,
+			)
+		);
+
+		$found = wp_list_pluck( $q1->get_results(), 'ID' );
+
+		$this->assertNotContains( self::$author_ids[0], $found, 'Asset that results do not contain author 0 without capability on site on first run' );
+		$this->assertContains( self::$author_ids[1], $found, 'Asset that results do contain author with capability on site on first run' );
+		$this->assertContains( self::$author_ids[2], $found, 'Asset that results do contain author with capability on site on first run' );
+
+		remove_user_from_blog( self::$author_ids[2], $blog_id );
+
+		$q2 = new WP_User_Query(
+			array(
+				'capability' => 'publish_posts',
+				'blog_id'    => $blog_id,
+			)
+		);
+
+		$found = wp_list_pluck( $q2->get_results(), 'ID' );
+		$this->assertNotContains( self::$author_ids[0], $found, 'Asset that results do not contain author 0 without capability on site on second run' );
+		$this->assertContains( self::$author_ids[1], $found, 'Asset that results do contain author with capability on site on second run' );
+		$this->assertNotContains( self::$author_ids[2], $found, 'Asset that results do not contain author 1 without capability on site on second run' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @group ms-required
+	 * @covers ::query
+	 */
+	public function test_query_should_respect_blog_id() {
+		$blogs = self::factory()->blog->create_many( 2 );
+
+		add_user_to_blog( $blogs[0], self::$author_ids[0], 'author' );
+		add_user_to_blog( $blogs[0], self::$author_ids[1], 'author' );
+		add_user_to_blog( $blogs[1], self::$author_ids[0], 'author' );
+		add_user_to_blog( $blogs[1], self::$author_ids[1], 'author' );
+		add_user_to_blog( $blogs[1], self::$author_ids[2], 'author' );
+
+		$q = new WP_User_Query(
+			array(
+				'fields'  => 'ids',
+				'blog_id' => $blogs[0],
+			)
+		);
+
+		$expected = array( (string) self::$author_ids[0], (string) self::$author_ids[1] );
+
+		$this->assertSameSets( $expected, $q->get_results(), 'Asset that expected users return' );
+
+		$q = new WP_User_Query(
+			array(
+				'fields'  => 'ids',
+				'blog_id' => $blogs[1],
+			)
+		);
+
+		$expected = array( (string) self::$author_ids[0], (string) self::$author_ids[1], (string) self::$author_ids[2] );
+
+		$this->assertSameSets( $expected, $q->get_results(), 'Asset that expected users return from different blog' );
+	}
+
+	/**
+	 * @ticket 40613
+	 * @group ms-required
+	 * @covers ::query
+	 */
+	public function test_has_published_posts_should_respect_blog_id() {
+		$blogs = self::factory()->blog->create_many( 2 );
+
+		add_user_to_blog( $blogs[0], self::$author_ids[0], 'author' );
+		add_user_to_blog( $blogs[0], self::$author_ids[1], 'author' );
+		add_user_to_blog( $blogs[1], self::$author_ids[0], 'author' );
+		add_user_to_blog( $blogs[1], self::$author_ids[1], 'author' );
+
+		switch_to_blog( $blogs[0] );
+		self::factory()->post->create(
+			array(
+				'post_author' => self::$author_ids[0],
+				'post_status' => 'publish',
+				'post_type'   => 'post',
+			)
+		);
+		restore_current_blog();
+
+		switch_to_blog( $blogs[1] );
+		$post_id = self::factory()->post->create(
+			array(
+				'post_author' => self::$author_ids[1],
+				'post_status' => 'publish',
+				'post_type'   => 'post',
+			)
+		);
+		restore_current_blog();
+
+		$q = new WP_User_Query(
+			array(
+				'has_published_posts' => array( 'post' ),
+				'blog_id'             => $blogs[1],
+			)
+		);
+
+		$found    = wp_list_pluck( $q->get_results(), 'ID' );
+		$expected = array( self::$author_ids[1] );
+
+		$this->assertSameSets( $expected, $found, 'Asset that expected users returned with posts on this site' );
+		switch_to_blog( $blogs[1] );
+		wp_delete_post( $post_id, true );
+		restore_current_blog();
+
+		$q = new WP_User_Query(
+			array(
+				'has_published_posts' => array( 'post' ),
+				'blog_id'             => $blogs[1],
+			)
+		);
+
+		$found = wp_list_pluck( $q->get_results(), 'ID' );
+
+		$this->assertSameSets( array(), $found, 'Asset that no users returned with posts on this site as posts have been deleted' );
+	}
+
+	/**
+	 * Ensure cache keys are generated without WPDB placeholders.
+	 *
+	 * @ticket 40613
+	 *
+	 * @covers ::generate_cache_key
+	 */
+	public function test_generate_cache_key_placeholder() {
+		global $wpdb;
+		$query1 = new WP_User_Query( array( 'capability' => 'edit_posts' ) );
+
+		$query_vars                  = $query1->query_vars;
+		$request_with_placeholder    = $query1->request;
+		$request_without_placeholder = $wpdb->remove_placeholder_escape( $query1->request );
+
+		$reflection = new ReflectionMethod( $query1, 'generate_cache_key' );
+		$reflection->setAccessible( true );
+
+		$cache_key_1 = $reflection->invoke( $query1, $query_vars, $request_with_placeholder );
+		$cache_key_2 = $reflection->invoke( $query1, $query_vars, $request_without_placeholder );
+
+		$this->assertSame( $cache_key_1, $cache_key_2, 'Cache key differs when using wpdb placeholder.' );
+	}
+
+	/**
+	 * Verifies that generate_cache_key() does not throw a fatal error for switch_to_blog()
+	 * with 'orderby' => 'post_count' and the deprecated 'who' => 'authors' parameter.
+	 *
+	 * @ticket 59011
+	 * @covers ::generate_cache_key
+	 *
+	 * @expectedDeprecated WP_User_Query
+	 */
+	public function test_generate_cache_key_with_orderby_post_count_and_deprecated_who_parameter() {
+		$query = new WP_User_Query(
+			array(
+				'fields'  => 'ID',
+				'orderby' => 'post_count',
+				'order'   => 'DESC',
+				'who'     => 'authors',
+			)
+		);
+
+		$this->assertNotEmpty( $query->get_results() );
+	}
+}
diff --git a/tests/user/retrievePassword.php b/tests/user/retrievePassword.php
index 861a2d9e96..c0f6f28c30 100644
--- a/tests/user/retrievePassword.php
+++ b/tests/user/retrievePassword.php
@@ -52,7 +52,7 @@ class Tests_User_RetrievePassword extends WP_UnitTestCase {
 	public function test_retrieve_password_should_return_wp_error_on_failed_email() {
 		add_filter(
 			'retrieve_password_notification_email',
-			static function() {
+			static function () {
 				return array( 'message' => '' );
 			}
 		);
diff --git a/tests/user/slashes.php b/tests/user/slashes.php
index 40eb2b176b..e8c414ddec 100644
--- a/tests/user/slashes.php
+++ b/tests/user/slashes.php
@@ -230,5 +230,4 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		$this->assertSame( wp_unslash( self::SLASH_2 ), $user->display_name );
 		$this->assertSame( wp_unslash( self::SLASH_4 ), $user->description );
 	}
-
 }
diff --git a/tests/user/wpGetUsersWithNoRole.php b/tests/user/wpGetUsersWithNoRole.php
index f853e0e78b..affe25e72f 100644
--- a/tests/user/wpGetUsersWithNoRole.php
+++ b/tests/user/wpGetUsersWithNoRole.php
@@ -42,7 +42,6 @@ class Tests_User_wpGetUsersWithNoRole extends WP_UnitTestCase {
 			),
 			$users
 		);
-
 	}
 
 	/**
@@ -149,5 +148,4 @@ class Tests_User_wpGetUsersWithNoRole extends WP_UnitTestCase {
 
 		$this->assertEmpty( $users );
 	}
-
 }
diff --git a/tests/user/wpRegisterPersistedPreferencesMeta.php b/tests/user/wpRegisterPersistedPreferencesMeta.php
index c3c4bd7a09..8af6ae9b81 100644
--- a/tests/user/wpRegisterPersistedPreferencesMeta.php
+++ b/tests/user/wpRegisterPersistedPreferencesMeta.php
@@ -52,10 +52,10 @@ class Tests_User_WpRegisterPersistedPreferencesMeta extends WP_UnitTestCase {
 						'additionalProperties' => true,
 					),
 				),
+				'revisions_enabled' => false,
 			),
 			$wp_meta_keys['user'][''][ $meta_key ],
 			'The registered metadata did not have the expected structure'
 		);
 	}
-
 }
diff --git a/tests/user/wpSetCurrentUser.php b/tests/user/wpSetCurrentUser.php
index 559aa2fbf4..bebee961ec 100644
--- a/tests/user/wpSetCurrentUser.php
+++ b/tests/user/wpSetCurrentUser.php
@@ -58,4 +58,3 @@ class Tests_User_wpSetCurrentUser extends WP_UnitTestCase {
 		$this->assertSame( self::$user_id2, get_current_user_id() );
 	}
 }
-
diff --git a/tests/utils.php b/tests/utils.php
index 3146f645c4..6a4f0d45f6 100644
--- a/tests/utils.php
+++ b/tests/utils.php
@@ -34,7 +34,6 @@ class Tests_Utils extends WP_UnitTestCase {
 		$expected .= 'foo';
 
 		$this->assertSame( $expected, strip_ws( $in ) );
-
 	}
 
 	/**
diff --git a/tests/vars.php b/tests/vars.php
new file mode 100644
index 0000000000..698f61a0e9
--- /dev/null
+++ b/tests/vars.php
@@ -0,0 +1,145 @@
+<?php
+/**
+ * Test functions in wp-includes/vars.php
+ *
+ * @group vars.php
+ */
+class Tests_Vars extends WP_UnitTestCase {
+
+	/**
+	 * Backup of $_SERVER.
+	 *
+	 * @var array
+	 */
+	protected $server_vars = array();
+
+	/**
+	 * Set up.
+	 */
+	public function set_up() {
+		$this->server_vars = $_SERVER;
+		parent::set_up();
+	}
+
+	/**
+	 * Tear down.
+	 */
+	public function tear_down() {
+		$_SERVER = $this->server_vars;
+		parent::tear_down();
+	}
+
+	/**
+	 * Data provider to test wp_is_mobile().
+	 *
+	 * @return array
+	 */
+	public function get_data_to_test_wp_is_mobile(): array {
+		return array(
+			'mobile client hint'  => array(
+				'headers'  => array(
+					'HTTP_SEC_CH_UA_MOBILE' => '?1',
+				),
+				'expected' => true,
+			),
+			'desktop client hint' => array(
+				'headers'  => array(
+					'HTTP_SEC_CH_UA_MOBILE' => '?0',
+				),
+				'expected' => false,
+			),
+			'no user agent'       => array(
+				'headers'  => array(),
+				'expected' => false,
+			),
+			'desktop safari'      => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Mozilla/5.0 (Macintosh; Intel Mac OS X 13_5_2) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Safari/605.1.15',
+				),
+				'expected' => false,
+			),
+			'mobile safari'       => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Mozilla/5.0 (iPhone; CPU iPhone OS 16_6_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.5 Mobile/15E148 Safari/604.1',
+				),
+				'expected' => true,
+			),
+			'mobile android'      => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Mozilla/5.0 (Linux; Android 10) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.60 Mobile Safari/537.36',
+				),
+				'expected' => true,
+			),
+			'silk'                => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Mozilla/5.0 (Linux; U; Android 4.4.3; KFTHWI Build/KTU84M) AppleWebKit/537.36 (KHTML, like Gecko) Silk/44.1.54 like Chrome/44.0.2403.63 Mobile Safari/537.36',
+				),
+				'expected' => true,
+			),
+			'kindle'              => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Mozilla/4.0 (compatible; Linux 2.6.10) NetFront/3.3 Kindle/1.0 (screen 600x800)',
+				),
+				'expected' => true,
+			),
+			'blackberry'          => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Mozilla/5.0 (Linux; Android 8.1.0; BlackBerry BBB100-4 Build/OPM1.171019.026) IPTV Pro/7.0.6',
+				),
+				'expected' => true,
+			),
+			'opera mini'          => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Opera/9.80 (Android; Opera Mini/69.0.2254/191.303; U; en) Presto/2.12.423 Version/12.16',
+				),
+				'expected' => true,
+			),
+			'opera mobi'          => array(
+				'headers'  => array(
+					'HTTP_USER_AGENT' => 'Opera/9.80 (Linux i686; Opera Mobi/1038; U; en) Presto/2.5.24 Version/10.00',
+				),
+				'expected' => true,
+			),
+		);
+	}
+
+	/**
+	 * @ticket 59370
+	 *
+	 * @covers ::wp_is_mobile
+	 *
+	 * @dataProvider get_data_to_test_wp_is_mobile
+	 *
+	 * @param array $headers  Headers in $_SERVER.
+	 * @param bool  $expected Whether expected.
+	 */
+	public function test_wp_is_mobile( array $headers, bool $expected ) {
+		foreach ( $headers as $key => $value ) {
+			$_SERVER[ $key ] = $value;
+		}
+		$this->assertSame( $expected, wp_is_mobile() );
+	}
+
+	/**
+	 * Tests that filter can override output of wp_is_mobile() to be true.
+	 *
+	 * @covers ::wp_is_mobile
+	 */
+	public function test_wp_is_mobile_is_true_with_filter() {
+		$this->assertFalse( wp_is_mobile() );
+		add_filter( 'wp_is_mobile', '__return_true' );
+		$this->assertTrue( wp_is_mobile() );
+	}
+
+	/**
+	 * Tests that filter can override output of wp_is_mobile() to be false.
+	 *
+	 * @covers ::wp_is_mobile
+	 */
+	public function test_wp_is_mobile_is_false_with_filter() {
+		$_SERVER['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Linux; Android 10) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.60 Mobile Safari/537.36';
+		$this->assertTrue( wp_is_mobile() );
+		add_filter( 'wp_is_mobile', '__return_false' );
+		$this->assertFalse( wp_is_mobile() );
+	}
+}
diff --git a/tests/walker.php b/tests/walker.php
index e2e9e1aba2..20e0b669c9 100644
--- a/tests/walker.php
+++ b/tests/walker.php
@@ -31,7 +31,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li>', $output );
-
 	}
 
 	public function test_single_item_flat() {
@@ -46,7 +45,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li>', $output );
-
 	}
 
 	public function test_single_item_depth_1() {
@@ -61,7 +59,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li>', $output );
-
 	}
 
 	public function test_multiple_items_single_level() {
@@ -81,7 +78,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 2, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li><li>2</li>', $output );
-
 	}
 
 	public function test_multiple_items_multiple_levels() {
@@ -101,7 +97,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1<ul><li>2</li></ul></li>', $output );
-
 	}
 
 	public function test_multiple_items_multiple_levels_flat() {
@@ -121,7 +116,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li><li>2</li>', $output );
-
 	}
 
 	public function test_multiple_items_multiple_levels_depth_1() {
@@ -141,7 +135,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li>', $output );
-
 	}
 
 	public function test_multiple_items_multiple_levels_depth_2() {
@@ -165,7 +158,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 1, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1<ul><li>2</li></ul></li>', $output );
-
 	}
 
 	public function test_multiple_items_recursive() {
@@ -185,7 +177,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 0, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1<ul><li>2</li></ul></li>', $output );
-
 	}
 
 	public function test_single_item_child() {
@@ -201,7 +192,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 0, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>1</li>', $output );
-
 	}
 
 	public function test_single_item_missing_parent_depth_1() {
@@ -224,7 +214,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		// But as we've only asked for the first depth maybe nothing should be returned?
 		// $this->assertSame( '', $output );
-
 	}
 
 	public function test_multiple_items_missing_parents() {
@@ -248,7 +237,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		$this->assertSame( 0, $this->walker->get_number_of_root_elements( $items ) );
 		$this->assertSame( '<li>4</li><li>5</li><li>6</li>', $output );
-
 	}
 
 	public function test_multiple_items_missing_parents_depth_1() {
@@ -282,7 +270,6 @@ class Tests_Walker extends WP_UnitTestCase {
 
 		// Or maybe all items which are missing parents should simply be treat top level?
 		// $this->assertSame( '<li>4</li><li>5</li><li>6</li>', $output );
-
 	}
 
 	/**
@@ -312,9 +299,7 @@ class Tests_Walker extends WP_UnitTestCase {
 		$output = $this->walker->paged_walk( $items, 0, 2, 1 );
 
 		$this->assertSame( '<li>2</li>', $output );
-
 	}
-
 }
 
 class Walker_Test extends Walker {
@@ -340,5 +325,4 @@ class Walker_Test extends Walker {
 	public function end_el( &$output, $page, $depth = 0, $args = array() ) {
 		$output .= '</li>';
 	}
-
 }
diff --git a/tests/webfonts/wpThemeJsonWebfontsHandler.php b/tests/webfonts/wpThemeJsonWebfontsHandler.php
deleted file mode 100644
index 7202417dde..0000000000
--- a/tests/webfonts/wpThemeJsonWebfontsHandler.php
+++ /dev/null
@@ -1,138 +0,0 @@
-<?php
-/**
- * Enqueue only webfonts listed in theme.json
- *
- * @package WordPress
- */
-
-/**
- * Integration tests for the theme.json webfonts handler.
- *
- * @group webfonts
- * @group themes
- * @covers _wp_theme_json_webfonts_handler
- */
-class Tests_Webfonts_wpThemeJsonWebfontsHandler extends WP_UnitTestCase {
-
-	/**
-	 * WP_Styles instance reference
-	 *
-	 * @var WP_Styles
-	 */
-	private $orig_wp_styles;
-
-	/**
-	 * Theme root path.
-	 *
-	 * @var string
-	 */
-	private $theme_root;
-
-	/**
-	 * The old theme root path.
-	 *
-	 * @var string
-	 */
-	private $orig_theme_dir;
-
-	public function set_up() {
-		parent::set_up();
-
-		global $wp_styles;
-		$this->orig_wp_styles = $wp_styles;
-		$wp_styles            = null;
-
-		$this->theme_root     = realpath( DIR_TESTDATA . '/themedir1' );
-		$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
-
-		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
-		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
-
-		$theme_root_callback = function () {
-			return $this->theme_root;
-		};
-
-		add_filter( 'theme_root', $theme_root_callback );
-		add_filter( 'stylesheet_root', $theme_root_callback );
-		add_filter( 'template_root', $theme_root_callback );
-
-		// Clear caches.
-		wp_clean_themes_cache();
-		unset( $GLOBALS['wp_themes'] );
-	}
-
-	public function tear_down() {
-		global $wp_styles;
-		$wp_styles = $this->orig_wp_styles;
-
-		// Restore the original theme directory setup.
-		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
-		wp_clean_themes_cache();
-		unset( $GLOBALS['wp_themes'] );
-
-		parent::tear_down();
-	}
-
-	/**
-	 * @ticket 55567
-	 * @ticket 46370
-	 * @ticket 57430
-	 */
-	public function test_font_face_generated_from_themejson() {
-		$this->setup_theme_and_test( 'webfonts-theme' );
-
-		$expected = <<<EOF
-<style id='wp-webfonts-inline-css' type='text/css'>
-@font-face{font-family:"Source Serif Pro";font-style:normal;font-weight:200 900;font-display:fallback;src:url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Roman.ttf.woff2') format('woff2');font-stretch:normal;}@font-face{font-family:"Source Serif Pro";font-style:italic;font-weight:200 900;font-display:fallback;src:url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Italic.ttf.woff2') format('woff2');font-stretch:normal;}
-</style>
-EOF;
-		$expected = str_replace( 'THEME_ROOT_URL', get_stylesheet_directory_uri(), $expected );
-		$expected = str_replace( "\r\n", "\n", $expected );
-
-		$this->assertStringContainsString(
-			$expected,
-			get_echo( 'wp_print_styles' )
-		);
-	}
-
-	/**
-	 * @dataProvider data_font_face_not_generated
-	 *
-	 * @ticket 55567
-	 * @ticket 46370
-	 */
-	public function test_font_face_not_generated( $theme_name ) {
-		$this->setup_theme_and_test( $theme_name );
-
-		$actual = get_echo( 'wp_print_styles' );
-		$this->assertStringNotContainsString( "<style id='wp-webfonts-inline-css", $actual );
-		$this->assertStringNotContainsString( '@font-face', $actual );
-	}
-
-	/**
-	 * Data provider for unhappy paths.
-	 *
-	 * @return string[][]
-	 */
-	public function data_font_face_not_generated() {
-		return array(
-			'classic theme with no theme.json' => array( 'default' ),
-			'no "fontFace" in theme.json'      => array( 'block-theme' ),
-			'empty "fontFace" in theme.json'   => array( 'empty-fontface-theme' ),
-		);
-	}
-
-	/**
-	 * Sets up the theme and test.
-	 *
-	 * @param string $theme_name Name of the theme to switch to for the test.
-	 */
-	private function setup_theme_and_test( $theme_name ) {
-		switch_theme( $theme_name );
-		do_action( 'after_setup_theme' );
-		wp_clean_theme_json_cache();
-		do_action( 'plugins_loaded' );
-		do_action( 'wp_loaded' );
-		do_action( 'wp_enqueue_scripts' );
-	}
-}
diff --git a/tests/widgets.php b/tests/widgets.php
index 8f64669c29..ab4115cff2 100644
--- a/tests/widgets.php
+++ b/tests/widgets.php
@@ -135,7 +135,6 @@ class Tests_Widgets extends WP_UnitTestCase {
 		register_sidebars( 1, array( 'id' => 'wp-unit-test' ) );
 
 		$this->assertArrayHasKey( 'wp-unit-test', $wp_registered_sidebars );
-
 	}
 
 	/**
@@ -157,7 +156,6 @@ class Tests_Widgets extends WP_UnitTestCase {
 		}
 
 		$this->assertCount( $num, $result );
-
 	}
 
 	/**
@@ -266,7 +264,6 @@ class Tests_Widgets extends WP_UnitTestCase {
 		$this->assertArrayHasKey( $sidebar_id, $wp_registered_sidebars );
 		$this->assertStringContainsString( '<div id="%1$s" class="before-sidebar %2$s">', $wp_registered_sidebars[ $sidebar_id ]['before_sidebar'] );
 		$this->assertStringContainsString( '</div> <!-- .before-sidebar -->', $wp_registered_sidebars[ $sidebar_id ]['after_sidebar'] );
-
 	}
 
 	/**
@@ -286,7 +283,6 @@ class Tests_Widgets extends WP_UnitTestCase {
 		$this->assertArrayHasKey( $sidebar_id, $wp_registered_sidebars );
 		$this->assertEmpty( $wp_registered_sidebars[ $sidebar_id ]['before_sidebar'] );
 		$this->assertEmpty( $wp_registered_sidebars[ $sidebar_id ]['after_sidebar'] );
-
 	}
 
 	/**
@@ -600,7 +596,7 @@ class Tests_Widgets extends WP_UnitTestCase {
 
 		add_filter(
 			"pre_option_{$widget->option_name}",
-			static function() {
+			static function () {
 				return new ArrayObject(
 					array(
 						2              => array( 'title' => 'Test Title' ),
@@ -890,7 +886,6 @@ class Tests_Widgets extends WP_UnitTestCase {
 		unregister_widget( 'WP_Widget_Text' );
 
 		$this->assertMatchesRegularExpression( '/<span class="special widget_text">/', $actual );
-
 	}
 
 	/**
diff --git a/tests/widgets/wpWidgetCustomHtml.php b/tests/widgets/wpWidgetCustomHtml.php
index c7dc3c3c7d..f1d1f45a06 100644
--- a/tests/widgets/wpWidgetCustomHtml.php
+++ b/tests/widgets/wpWidgetCustomHtml.php
@@ -353,5 +353,4 @@ class Tests_Widgets_wpWidgetCustomHtml extends WP_UnitTestCase {
 		$output = get_echo( array( $widget, 'widget' ), array( $args, $instance ) );
 		$this->assertStringNotContainsString( 'rel="noopener"', $output );
 	}
-
 }
diff --git a/tests/widgets/wpWidgetMedia.php b/tests/widgets/wpWidgetMedia.php
index d138c41583..a29636a138 100644
--- a/tests/widgets/wpWidgetMedia.php
+++ b/tests/widgets/wpWidgetMedia.php
@@ -76,7 +76,7 @@ class Tests_Widgets_wpWidgetMedia extends WP_UnitTestCase {
 			),
 			array_keys( $widget->l10n )
 		);
-		$this->assertSame( count( $widget->l10n ), count( array_filter( $widget->l10n ) ), 'Expected all translation strings to be defined.' );
+		$this->assertCount( count( $widget->l10n ), array_filter( $widget->l10n ), 'Expected all translation strings to be defined.' );
 		$this->assertSame( 10, has_action( 'admin_print_scripts-widgets.php', array( $widget, 'enqueue_admin_scripts' ) ) );
 		$this->assertFalse( has_action( 'wp_enqueue_scripts', array( $widget, 'enqueue_preview_scripts' ) ), 'Did not expect preview scripts to be enqueued when not in customize preview context.' );
 		$this->assertSame( 10, has_action( 'admin_footer-widgets.php', array( $widget, 'render_control_template_scripts' ) ) );
diff --git a/tests/widgets/wpWidgetMediaImage.php b/tests/widgets/wpWidgetMediaImage.php
index 57ffc9a6aa..3f96cf34eb 100644
--- a/tests/widgets/wpWidgetMediaImage.php
+++ b/tests/widgets/wpWidgetMediaImage.php
@@ -494,6 +494,8 @@ class Tests_Widgets_wpWidgetMediaImage extends WP_UnitTestCase {
 
 		// Custom image class.
 		$this->assertStringContainsString( 'src="http://example.org/url/to/image.jpg"', $output );
+		$this->assertStringContainsString( 'decoding="async"', $output );
+		$this->assertStringContainsString( 'loading="lazy"', $output );
 
 		// Link settings.
 		ob_start();
diff --git a/tests/widgets/wpWidgetText.php b/tests/widgets/wpWidgetText.php
index cccdcbe957..a1570da63a 100644
--- a/tests/widgets/wpWidgetText.php
+++ b/tests/widgets/wpWidgetText.php
@@ -303,7 +303,7 @@ class Tests_Widgets_wpWidgetText extends WP_UnitTestCase {
 	 */
 	public function do_example_shortcode() {
 		$this->post_during_shortcode = get_post();
-		$this->shortcode_render_count++;
+		++$this->shortcode_render_count;
 		return $this->example_shortcode_content;
 	}
 
diff --git a/tests/xmlrpc/basic.php b/tests/xmlrpc/basic.php
index a754fdbb63..a56a721a07 100644
--- a/tests/xmlrpc/basic.php
+++ b/tests/xmlrpc/basic.php
@@ -93,7 +93,6 @@ class Tests_XMLRPC_Basic extends WP_XMLRPC_UnitTestCase {
 		$this->assertArrayNotHasKey( 'faultCode', $result[0] );
 		$this->assertArrayHasKey( 'faultCode', $result[1] );
 		$this->assertArrayHasKey( 'faultCode', $result[2] );
-
 	}
 
 	/**
diff --git a/tests/xmlrpc/client.php b/tests/xmlrpc/client.php
index b08d98949f..a13980c17d 100644
--- a/tests/xmlrpc/client.php
+++ b/tests/xmlrpc/client.php
@@ -27,4 +27,3 @@ class Tests_XMLRPC_Client extends WP_XMLRPC_UnitTestCase {
 		$this->assertSame( '/server.php?this-is-needed=true', $client->path );
 	}
 }
-
diff --git a/tests/xmlrpc/message.php b/tests/xmlrpc/message.php
index ac68552902..b316567f32 100644
--- a/tests/xmlrpc/message.php
+++ b/tests/xmlrpc/message.php
@@ -30,5 +30,4 @@ class Tests_XMLRPC_Message extends WP_UnitTestCase {
 		$this->assertSame( 'methodResponse', $message->messageType ); // phpcs:ignore WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
 		$this->assertSame( array( '1' ), $message->params );
 	}
-
 }
diff --git a/tests/xmlrpc/wp/getMediaItem.php b/tests/xmlrpc/wp/getMediaItem.php
index fe1cd13f20..16eec13284 100644
--- a/tests/xmlrpc/wp/getMediaItem.php
+++ b/tests/xmlrpc/wp/getMediaItem.php
@@ -25,6 +25,7 @@ class Tests_XMLRPC_wp_getMediaItem extends WP_XMLRPC_UnitTestCase {
 
 		$this->attachment_id   = $this->_make_attachment( $upload, self::$post_id );
 		$this->attachment_data = get_post( $this->attachment_id, ARRAY_A );
+		update_post_meta( $this->attachment_id, '_wp_attachment_image_alt', 'Waffle has alt text' );
 
 		set_post_thumbnail( self::$post_id, $this->attachment_id );
 	}
@@ -60,6 +61,7 @@ class Tests_XMLRPC_wp_getMediaItem extends WP_XMLRPC_UnitTestCase {
 		$this->assertIsString( $result['link'] );
 		$this->assertIsString( $result['thumbnail'] );
 		$this->assertIsArray( $result['metadata'] );
+		$this->assertIsString( $result['alt'] );
 
 		// Check expected values.
 		$this->assertStringMatchesFormat( '%d', $result['attachment_id'] );
diff --git a/tests/xmlrpc/wp/getPages.php b/tests/xmlrpc/wp/getPages.php
index 9615c5a30d..eb99caf5c1 100644
--- a/tests/xmlrpc/wp/getPages.php
+++ b/tests/xmlrpc/wp/getPages.php
@@ -87,5 +87,4 @@ class Tests_XMLRPC_wp_getPages extends WP_XMLRPC_UnitTestCase {
 
 		remove_filter( 'map_meta_cap', array( $this, 'remove_editor_edit_page_cap' ), 10, 4 );
 	}
-
 }
diff --git a/tests/xmlrpc/wp/getPosts.php b/tests/xmlrpc/wp/getPosts.php
index b019c2bb26..814f0c1018 100644
--- a/tests/xmlrpc/wp/getPosts.php
+++ b/tests/xmlrpc/wp/getPosts.php
@@ -167,5 +167,4 @@ class Tests_XMLRPC_wp_getPosts extends WP_XMLRPC_UnitTestCase {
 		$this->assertNotIXRError( $results );
 		$this->assertCount( 1, $results );
 	}
-
 }
diff --git a/tests/xmlrpc/wp/getRevisions.php b/tests/xmlrpc/wp/getRevisions.php
index b7a4667165..893a7a06da 100644
--- a/tests/xmlrpc/wp/getRevisions.php
+++ b/tests/xmlrpc/wp/getRevisions.php
@@ -77,5 +77,4 @@ class Tests_XMLRPC_wp_getRevisions extends WP_XMLRPC_UnitTestCase {
 		$result = $this->myxmlrpcserver->wp_getRevisions( array( 1, 'editor', 'editor', $post_id ) );
 		$this->assertCount( 1, $result );
 	}
-
 }
diff --git a/tests/xmlrpc/wp/newPost.php b/tests/xmlrpc/wp/newPost.php
index c9b160cf19..91e256ff5c 100644
--- a/tests/xmlrpc/wp/newPost.php
+++ b/tests/xmlrpc/wp/newPost.php
@@ -445,5 +445,4 @@ class Tests_XMLRPC_wp_newPost extends WP_XMLRPC_UnitTestCase {
 		$this->assertStringMatchesFormat( '%d', $result );
 		$this->assertSame( $date_string, $fetched_post->post_date_gmt );
 	}
-
 }
diff --git a/wp-mail-real-test.php b/wp-mail-real-test.php
index 243efde046..6c089e4ffb 100644
--- a/wp-mail-real-test.php
+++ b/wp-mail-real-test.php
@@ -82,4 +82,3 @@ $to        = 'To <wp.mail.testing+to@gmail.com>';
 $headers[] = "BCC: {$bcc}";
 wp_mail( '', $subject, $message, $headers );
 echo "Test emails sent!\n";
-
