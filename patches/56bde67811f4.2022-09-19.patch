diff --git a/README.txt b/README.txt
index a15c091793..bb1a3ec323 100644
--- a/README.txt
+++ b/README.txt
@@ -1,6 +1,6 @@
 The short version:
 
-1. Create a clean MySQL database and user.  DO NOT USE AN EXISTING DATABASE or you will lose data, guaranteed.
+1. Create a clean MySQL database and user. DO NOT USE AN EXISTING DATABASE or you will lose data, guaranteed.
 
 2. Copy wp-tests-config-sample.php to wp-tests-config.php, edit it and include your database name/user/password.
 
@@ -14,9 +14,9 @@ The short version:
 
 Notes:
 
-Test cases live in the 'tests' subdirectory.  All files in that directory will be included by default.  Extend the WP_UnitTestCase class to ensure your test is run.
+Test cases live in the 'tests' subdirectory. All files in that directory will be included by default. Extend the WP_UnitTestCase class to ensure your test is run.
 
-phpunit will initialize and install a (more or less) complete running copy of WordPress each time it is run.  This makes it possible to run functional interface and module tests against a fully working database and codebase, as opposed to pure unit tests with mock objects and stubs.  Pure unit tests may be used also, of course.
+phpunit will initialize and install a (more or less) complete running copy of WordPress each time it is run. This makes it possible to run functional interface and module tests against a fully working database and codebase, as opposed to pure unit tests with mock objects and stubs. Pure unit tests may be used also, of course.
 
 Changes to the test database will be rolled back as tests are finished, to ensure a clean start next time the tests are run.
 
diff --git a/build.xml b/build.xml
deleted file mode 100644
index ff8234bc50..0000000000
--- a/build.xml
+++ /dev/null
@@ -1,15 +0,0 @@
-<?xml version="1.0" encoding="utf-8"?>
-<project name="WordPress Unit Tests" default="build" basedir=".">
-	<target name="clean">
-		<delete dir="build" />
-	</target>
-	<target name="prepare">
-		<mkdir dir="build/logs" />
-		<mkdir dir="build/phpunitreport" />
-	</target>
-	<target name="phpunit">
-		<exec command="phpunit" passthru="true"></exec>
-		<phpunitreport infile="build/logs/junit.xml" format="frames" todir="build/phpunitreport" usesorttable="true" />
-	</target>
-	<target name="build" depends="clean,prepare,phpunit" />
-</project>
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__column.server.html b/data/blocks/fixtures/core__column.server.html
index b40bed22d1..cdc525068b 100644
--- a/data/blocks/fixtures/core__column.server.html
+++ b/data/blocks/fixtures/core__column.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-column">
+<div class="wp-container-1 wp-block-column">
 	
 	<p>Column One, Paragraph One</p>
 	
diff --git a/data/blocks/fixtures/core__columns.server.html b/data/blocks/fixtures/core__columns.server.html
index a3d2fd1438..1999742228 100644
--- a/data/blocks/fixtures/core__columns.server.html
+++ b/data/blocks/fixtures/core__columns.server.html
@@ -1,7 +1,7 @@
 
-<div class="wp-block-columns has-3-columns">
+<div class="wp-container-1 wp-block-columns has-3-columns">
 	
-	<div class="wp-block-column">
+	<div class="wp-container-1 wp-block-column">
 		
 		<p>Column One, Paragraph One</p>
 		
@@ -11,7 +11,7 @@
 	</div>
 	
 	
-	<div class="wp-block-column">
+	<div class="wp-container-1 wp-block-column">
 		
 		<p>Column Two, Paragraph One</p>
 		
diff --git a/data/blocks/fixtures/core__columns__deprecated.server.html b/data/blocks/fixtures/core__columns__deprecated.server.html
index 7c774d7bd7..8aa88433d6 100644
--- a/data/blocks/fixtures/core__columns__deprecated.server.html
+++ b/data/blocks/fixtures/core__columns__deprecated.server.html
@@ -1,5 +1,5 @@
 
-<div class="wp-block-columns has-3-columns">
+<div class="wp-container-1 wp-block-columns has-3-columns">
 	
 	<p class="layout-column-1">Column One, Paragraph One</p>
 	
diff --git a/data/blocks/fixtures/core__gallery.html b/data/blocks/fixtures/core__gallery.html
index 5e48c7e663..54f9991f88 100644
--- a/data/blocks/fixtures/core__gallery.html
+++ b/data/blocks/fixtures/core__gallery.html
@@ -1,14 +1,15 @@
-<!-- wp:core/gallery -->
-<ul class="wp-block-gallery columns-2 is-cropped">
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="title" />
-		</figure>
-	</li>
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="http://google.com/hi.png" alt="title" />
-		</figure>
-	</li>
-</ul>
-<!-- /wp:core/gallery -->
+<!-- wp:gallery {"linkTo":"none","className":"columns-2"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped columns-2">
+	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+	<figure class="wp-block-image size-large">
+		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+	</figure>
+	<!-- /wp:image -->
+
+	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+	<figure class="wp-block-image size-large">
+		<img src="http://google.com/hi.png" alt="Image gallery image" />
+	</figure>
+	<!-- /wp:image -->
+</figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery.json b/data/blocks/fixtures/core__gallery.json
index 8cfcc26d3b..0225422123 100644
--- a/data/blocks/fixtures/core__gallery.json
+++ b/data/blocks/fixtures/core__gallery.json
@@ -1,25 +1,44 @@
 [
-    {
-        "clientId": "_clientId_0",
-        "name": "core/gallery",
-        "isValid": true,
-        "attributes": {
-            "images": [
-                {
-                    "url": "https://cldup.com/uuUqE_dXzy.jpg",
-                    "alt": "title",
-                    "caption": ""
-                },
-                {
-                    "url": "http://google.com/hi.png",
-                    "alt": "title",
-                    "caption": ""
-                }
-            ],
-            "imageCrop": true,
-            "linkTo": "none"
-        },
-        "innerBlocks": [],
-        "originalContent": "<ul class=\"wp-block-gallery columns-2 is-cropped\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"http://google.com/hi.png\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>"
-    }
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"images": [],
+			"ids": [],
+			"shortCodeTransforms": [],
+			"caption": "",
+			"imageCrop": true,
+			"fixedHeight": true,
+			"linkTo": "none",
+			"sizeSlug": "large",
+			"allowResize": false,
+			"className": "columns-2"
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://cldup.com/uuUqE_dXzy.jpg",
+					"alt": "Image gallery image",
+					"caption": "",
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://google.com/hi.png",
+					"alt": "Image gallery image",
+					"caption": "",
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
 ]
diff --git a/data/blocks/fixtures/core__gallery.parsed.json b/data/blocks/fixtures/core__gallery.parsed.json
index fc5c9e17d6..00a75f5f13 100644
--- a/data/blocks/fixtures/core__gallery.parsed.json
+++ b/data/blocks/fixtures/core__gallery.parsed.json
@@ -1,13 +1,45 @@
 [
-    {
-        "blockName": "core/gallery",
-        "attrs": {},
-        "innerBlocks": [],
-        "innerHTML": "\n<ul class=\"wp-block-gallery columns-2 is-cropped\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"http://google.com/hi.png\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>\n",
-        "innerContent": [
-            "\n<ul class=\"wp-block-gallery columns-2 is-cropped\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"http://google.com/hi.png\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>\n"
-        ]
-    },
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"linkTo": "none",
+			"className": "columns-2"
+		},
+		"innerBlocks": [
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+				]
+			}
+		],
+		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\">\n\t\n\n\t\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\">\n\t",
+			null,
+			"\n\n\t",
+			null,
+			"\n</figure>\n"
+		]
+	},
     {
         "blockName": null,
         "attrs": {},
@@ -17,4 +49,4 @@
             "\n"
         ]
     }
-]
+]
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__gallery.serialized.html b/data/blocks/fixtures/core__gallery.serialized.html
index 5bf6ce819f..bc5d6be414 100644
--- a/data/blocks/fixtures/core__gallery.serialized.html
+++ b/data/blocks/fixtures/core__gallery.serialized.html
@@ -1,3 +1,3 @@
-<!-- wp:gallery -->
-<ul class="wp-block-gallery columns-2 is-cropped"><li class="blocks-gallery-item"><figure><img src="https://cldup.com/uuUqE_dXzy.jpg" alt="title"/></figure></li><li class="blocks-gallery-item"><figure><img src="http://google.com/hi.png" alt="title"/></figure></li></ul>
-<!-- /wp:gallery -->
+<!-- wp:gallery {"linkTo":"none","className":"columns-2"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" /></figure><!-- /wp:image --><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="http://google.com/hi.png" alt="Image gallery image" /></figure><!-- /wp:image --></figure>
+<!-- /wp:gallery -->
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__gallery.server.html b/data/blocks/fixtures/core__gallery.server.html
index da1d17deab..a185c67cd7 100644
--- a/data/blocks/fixtures/core__gallery.server.html
+++ b/data/blocks/fixtures/core__gallery.server.html
@@ -1,14 +1,15 @@
 
-<ul class="wp-block-gallery columns-2 is-cropped">
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="title" />
-		</figure>
-	</li>
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="http://google.com/hi.png" alt="title" />
-		</figure>
-	</li>
-</ul>
+<figure class="wp-container-1 wp-block-gallery-1 wp-block-gallery has-nested-images columns-default is-cropped columns-2">
+	
+	<figure class="wp-block-image size-large">
+		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+	</figure>
+	
+
+	
+	<figure class="wp-block-image size-large">
+		<img src="http://google.com/hi.png" alt="Image gallery image" />
+	</figure>
+	
+</figure>
 
diff --git a/data/blocks/fixtures/core__gallery__columns.html b/data/blocks/fixtures/core__gallery__columns.html
index cf1f1bb43f..4f34167c17 100644
--- a/data/blocks/fixtures/core__gallery__columns.html
+++ b/data/blocks/fixtures/core__gallery__columns.html
@@ -1,14 +1,15 @@
-<!-- wp:core/gallery {"columns":1} -->
-<ul class="wp-block-gallery columns-1 is-cropped">
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="title" />
-		</figure>
-	</li>
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="http://google.com/hi.png" alt="title" />
-		</figure>
-	</li>
-</ul>
-<!-- /wp:core/gallery -->
+<!-- wp:gallery {"linkTo":"none","className":"columns-1"} -->
+<figure class="wp-block-gallery has-nested-images is-cropped columns-1" >
+	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+	<figure class="wp-block-image size-large">
+		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+	</figure>
+	<!-- /wp:image -->
+
+	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+	<figure class="wp-block-image size-large">
+		<img src="http://google.com/hi.png" alt="Image gallery image" />
+	</figure>
+	<!-- /wp:image -->
+</figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__columns.json b/data/blocks/fixtures/core__gallery__columns.json
index b3daaa05f6..4523d16b20 100644
--- a/data/blocks/fixtures/core__gallery__columns.json
+++ b/data/blocks/fixtures/core__gallery__columns.json
@@ -1,26 +1,45 @@
 [
-    {
-        "clientId": "_clientId_0",
-        "name": "core/gallery",
-        "isValid": true,
-        "attributes": {
-            "images": [
-                {
-                    "url": "https://cldup.com/uuUqE_dXzy.jpg",
-                    "alt": "title",
-                    "caption": ""
-                },
-                {
-                    "url": "http://google.com/hi.png",
-                    "alt": "title",
-                    "caption": ""
-                }
-            ],
-            "columns": 1,
-            "imageCrop": true,
-            "linkTo": "none"
-        },
-        "innerBlocks": [],
-        "originalContent": "<ul class=\"wp-block-gallery columns-1 is-cropped\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"http://google.com/hi.png\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>"
-    }
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"images": [],
+			"ids": [],
+			"shortCodeTransforms": [],
+			"caption": "",
+			"imageCrop": true,
+			"fixedHeight": true,
+			"linkTo": "none",
+			"sizeSlug": "large",
+			"allowResize": false,
+			"className": "columns-1",
+            "columns": 1
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://cldup.com/uuUqE_dXzy.jpg",
+					"alt": "Image gallery image",
+					"caption": "",
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://google.com/hi.png",
+					"alt": "Image gallery image",
+					"caption": "",
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
 ]
diff --git a/data/blocks/fixtures/core__gallery__columns.parsed.json b/data/blocks/fixtures/core__gallery__columns.parsed.json
index 6f6e4b856d..d3d7c23893 100644
--- a/data/blocks/fixtures/core__gallery__columns.parsed.json
+++ b/data/blocks/fixtures/core__gallery__columns.parsed.json
@@ -1,15 +1,45 @@
 [
-    {
-        "blockName": "core/gallery",
-        "attrs": {
-            "columns": 1
-        },
-        "innerBlocks": [],
-        "innerHTML": "\n<ul class=\"wp-block-gallery columns-1 is-cropped\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"http://google.com/hi.png\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>\n",
-        "innerContent": [
-            "\n<ul class=\"wp-block-gallery columns-1 is-cropped\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"http://google.com/hi.png\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>\n"
-        ]
-    },
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"linkTo": "none",
+			"className": "columns-1"
+		},
+		"innerBlocks": [
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+				]
+			}
+		],
+		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images is-cropped columns-1\" >\n\t\n\n\t\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery has-nested-images is-cropped columns-1\" >\n\t",
+			null,
+			"\n\n\t",
+			null,
+			"\n</figure>\n"
+		]
+	},
     {
         "blockName": null,
         "attrs": {},
@@ -19,4 +49,4 @@
             "\n"
         ]
     }
-]
+]
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__gallery__columns.serialized.html b/data/blocks/fixtures/core__gallery__columns.serialized.html
index 183e484ec4..88464bedce 100644
--- a/data/blocks/fixtures/core__gallery__columns.serialized.html
+++ b/data/blocks/fixtures/core__gallery__columns.serialized.html
@@ -1,3 +1,3 @@
-<!-- wp:gallery {"columns":1} -->
-<ul class="wp-block-gallery columns-1 is-cropped"><li class="blocks-gallery-item"><figure><img src="https://cldup.com/uuUqE_dXzy.jpg" alt="title"/></figure></li><li class="blocks-gallery-item"><figure><img src="http://google.com/hi.png" alt="title"/></figure></li></ul>
-<!-- /wp:gallery -->
+<!-- wp:gallery {"linkTo":"none","className":"columns-1"} -->
+<figure class="wp-block-gallery has-nested-images is-cropped columns-1"><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" /></figure><!-- /wp:image --><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="http://google.com/hi.png" alt="Image gallery image" /></figure><!-- /wp:image --></figure>
+<!-- /wp:gallery -->
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__gallery__columns.server.html b/data/blocks/fixtures/core__gallery__columns.server.html
index f801a97371..4056203589 100644
--- a/data/blocks/fixtures/core__gallery__columns.server.html
+++ b/data/blocks/fixtures/core__gallery__columns.server.html
@@ -1,14 +1,15 @@
 
-<ul class="wp-block-gallery columns-1 is-cropped">
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="title" />
-		</figure>
-	</li>
-	<li class="blocks-gallery-item">
-		<figure>
-			<img src="http://google.com/hi.png" alt="title" />
-		</figure>
-	</li>
-</ul>
+<figure class="wp-container-1 wp-block-gallery-1 wp-block-gallery has-nested-images is-cropped columns-1" >
+	
+	<figure class="wp-block-image size-large">
+		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+	</figure>
+	
+
+	
+	<figure class="wp-block-image size-large">
+		<img src="http://google.com/hi.png" alt="Image gallery image" />
+	</figure>
+	
+</figure>
 
diff --git a/data/blocks/notice/block.json b/data/blocks/notice/block.json
index d448a49c5c..9d2fadfb5d 100644
--- a/data/blocks/notice/block.json
+++ b/data/blocks/notice/block.json
@@ -4,7 +4,10 @@
 	"title": "Notice",
 	"category": "common",
 	"parent": [
-		"core/group"
+		"tests/group"
+	],
+	"ancestor": [
+		"tests/section"
 	],
 	"providesContext": {
 		"tests/message": "message"
@@ -21,9 +24,7 @@
 	"textdomain": "notice",
 	"attributes": {
 		"message": {
-			"type": "string",
-			"source": "html",
-			"selector": ".message"
+			"type": "string"
 		}
 	},
 	"supports": {
@@ -56,7 +57,8 @@
 	},
 	"editorScript": "tests-notice-editor-script",
 	"script": "tests-notice-script",
-	"viewScript": "tests-notice-view-script",
+	"viewScript": [ "tests-notice-view-script", "tests-notice-view-script-2" ],
 	"editorStyle": "tests-notice-editor-style",
-	"style": "tests-notice-style"
+	"style": [ "tests-notice-style", "tests-notice-style-2" ],
+	"render": "file:./render.php"
 }
diff --git a/data/blocks/notice/render.php b/data/blocks/notice/render.php
new file mode 100644
index 0000000000..12a49c1a59
--- /dev/null
+++ b/data/blocks/notice/render.php
@@ -0,0 +1 @@
+<p <?php echo get_block_wrapper_attributes(); ?>><?php echo esc_html( $attributes['message'] ); ?></p>
diff --git a/data/blocks/pattern-directory/browse-all.json b/data/blocks/pattern-directory/browse-all.json
index 26131e33bb..8d0d2d4ba3 100644
--- a/data/blocks/pattern-directory/browse-all.json
+++ b/data/blocks/pattern-directory/browse-all.json
@@ -9,6 +9,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A heading preceded by a chapter number, and followed by a paragraph.",
+			"wpop_keywords": "blog post",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "text" ],
@@ -25,6 +26,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A large hero section with an example background image and a heading in the center.",
+			"wpop_keywords": "header, hero",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "header" ],
@@ -41,6 +43,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A large hero section with a bright gradient background, a big heading and a filled button.",
+			"wpop_keywords": "call to action, hero section",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "header" ],
diff --git a/data/blocks/pattern-directory/browse-category-2.json b/data/blocks/pattern-directory/browse-category-2.json
index 947da16bfd..1fce1a0f80 100644
--- a/data/blocks/pattern-directory/browse-category-2.json
+++ b/data/blocks/pattern-directory/browse-category-2.json
@@ -9,6 +9,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "Three filled buttons with rounded corners, side by side.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 600
 		},
 		"category_slugs": [ "buttons" ],
@@ -25,6 +26,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "Two buttons, one filled and one outlined, side by side.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 500
 		},
 		"category_slugs": [ "buttons" ],
diff --git a/data/blocks/pattern-directory/browse-keyword-11.json b/data/blocks/pattern-directory/browse-keyword-11.json
index 26131e33bb..383d7eff61 100644
--- a/data/blocks/pattern-directory/browse-keyword-11.json
+++ b/data/blocks/pattern-directory/browse-keyword-11.json
@@ -9,6 +9,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A heading preceded by a chapter number, and followed by a paragraph.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "text" ],
@@ -25,6 +26,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A large hero section with an example background image and a heading in the center.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "header" ],
@@ -41,6 +43,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A large hero section with a bright gradient background, a big heading and a filled button.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "header" ],
diff --git a/data/blocks/pattern-directory/search-button.json b/data/blocks/pattern-directory/search-button.json
index b135e0ac5a..10e5c6036f 100644
--- a/data/blocks/pattern-directory/search-button.json
+++ b/data/blocks/pattern-directory/search-button.json
@@ -9,6 +9,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "A large hero section with a bright gradient background, a big heading and a filled button.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "header" ],
@@ -25,6 +26,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "Three small columns of text, each with an outlined button with rounded corners at the bottom.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 1000
 		},
 		"category_slugs": [ "columns" ],
@@ -41,6 +43,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "Three filled buttons with rounded corners, side by side.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 600
 		},
 		"category_slugs": [ "buttons" ],
@@ -57,6 +60,7 @@
 		"meta": {
 			"spay_email": "",
 			"wpop_description": "Two buttons, one filled and one outlined, side by side.",
+			"wpop_keywords": "",
 			"wpop_viewport_width": 500
 		},
 		"category_slugs": [ "buttons" ],
diff --git a/data/feed/wordpress-org-news.xml b/data/feed/wordpress-org-news.xml
index f18fa21882..1173c71bd7 100644
--- a/data/feed/wordpress-org-news.xml
+++ b/data/feed/wordpress-org-news.xml
@@ -365,7 +365,7 @@
 
 
 
-<p>A Question and Answer period with pre-recorded videos will follow State of the Word. To take part, record a video of you asking your question to Matt on your computer or phone (landscape format, please). Don&#8217;t forget to include your name and how you use WordPress! Try to keep your video to under a minute so Matt can answer as many questions as possible.</p>
+<p>A Question and Answer period with pre-recorded videos will follow State of the Word. To take part, record a video of you asking your question to Matt on your computer or phone (landscape format, please). Do not forget to include your name and how you use WordPress! Try to keep your video to under a minute so Matt can answer as many questions as possible.</p>
 
 
 
@@ -528,7 +528,7 @@
 
 
 
-<p><em><strong>Think you found a bug?</strong> Post it to the <a href="https://wordpress.org/support/forum/alphabeta">Alpha/Beta area</a> in the support forums. We would love to hear from you! If you’re comfortable writing a reproducible bug report you can <a href="https://make.wordpress.org/core/reports/">file one on WordPress Trac</a>. Don&#8217;t forget to check <a href="https://core.trac.wordpress.org/tickets/major">the list of known bugs</a></em>!</p>
+<p><em><strong>Think you found a bug?</strong> Post it to the <a href="https://wordpress.org/support/forum/alphabeta">Alpha/Beta area</a> in the support forums. We would love to hear from you! If you’re comfortable writing a reproducible bug report you can <a href="https://make.wordpress.org/core/reports/">file one on WordPress Trac</a>. Do not forget to check <a href="https://core.trac.wordpress.org/tickets/major">the list of known bugs</a></em>!</p>
 ]]></content:encoded>
 
 
diff --git a/data/images/test-image-rotated-90ccw.jpg b/data/images/test-image-rotated-90ccw.jpg
new file mode 100644
index 0000000000..b579b7f9ab
Binary files /dev/null and b/data/images/test-image-rotated-90ccw.jpg differ
diff --git a/data/images/test-image-rotated-90cw.webp b/data/images/test-image-rotated-90cw.webp
new file mode 100644
index 0000000000..82e77bed08
Binary files /dev/null and b/data/images/test-image-rotated-90cw.webp differ
diff --git a/data/images/test-image.jpeg b/data/images/test-image.jpeg
new file mode 100644
index 0000000000..534aac1d6b
Binary files /dev/null and b/data/images/test-image.jpeg differ
diff --git a/data/languages/plugins/internationalized-plugin-de_DE.mo b/data/languages/plugins/internationalized-plugin-de_DE.mo
index 96bf7ad890..08ee966a8a 100644
Binary files a/data/languages/plugins/internationalized-plugin-de_DE.mo and b/data/languages/plugins/internationalized-plugin-de_DE.mo differ
diff --git a/data/languages/plugins/internationalized-plugin-de_DE.po b/data/languages/plugins/internationalized-plugin-de_DE.po
index bfb7d8ca39..b784913576 100644
--- a/data/languages/plugins/internationalized-plugin-de_DE.po
+++ b/data/languages/plugins/internationalized-plugin-de_DE.po
@@ -2,18 +2,20 @@ msgid ""
 msgstr ""
 "Project-Id-Version: \n"
 "POT-Creation-Date: 2015-12-31 16:31+0100\n"
-"PO-Revision-Date: 2016-10-26 00:02+0200\n"
+"PO-Revision-Date: 2020-10-20 17:11+0200\n"
 "Language: de_DE\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Generator: Poedit 1.8.10\n"
+"X-Generator: Poedit 2.4.1\n"
 "X-Poedit-Basepath: .\n"
 "Plural-Forms: nplurals=2; plural=(n != 1);\n"
 "X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
 "_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
 "esc_html_x:1,2c\n"
 "X-Textdomain-Support: yes\n"
+"Language-Team: \n"
+"Last-Translator: \n"
 "X-Poedit-SearchPath-0: .\n"
 
 #: internationalized-plugin.php:11
diff --git a/data/languages/plugins/internationalized-plugin-es_ES.mo b/data/languages/plugins/internationalized-plugin-es_ES.mo
new file mode 100644
index 0000000000..026af5850e
Binary files /dev/null and b/data/languages/plugins/internationalized-plugin-es_ES.mo differ
diff --git a/data/languages/plugins/internationalized-plugin-es_ES.po b/data/languages/plugins/internationalized-plugin-es_ES.po
new file mode 100644
index 0000000000..788036ab12
--- /dev/null
+++ b/data/languages/plugins/internationalized-plugin-es_ES.po
@@ -0,0 +1,23 @@
+msgid ""
+msgstr ""
+"Project-Id-Version: \n"
+"POT-Creation-Date: 2015-12-31 16:31+0100\n"
+"PO-Revision-Date: 2020-10-20 17:12+0200\n"
+"Language: de_DE\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"X-Generator: Poedit 2.4.1\n"
+"X-Poedit-Basepath: .\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
+"_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
+"esc_html_x:1,2c\n"
+"X-Textdomain-Support: yes\n"
+"Language-Team: \n"
+"Last-Translator: \n"
+"X-Poedit-SearchPath-0: .\n"
+
+#: internationalized-plugin.php:11
+msgid "This is a dummy plugin"
+msgstr "Este es un plugin dummy"
diff --git a/data/languages/themes/block-theme-pl_PL.mo b/data/languages/themes/block-theme-pl_PL.mo
index ff89f87f12..d819be9b57 100644
Binary files a/data/languages/themes/block-theme-pl_PL.mo and b/data/languages/themes/block-theme-pl_PL.mo differ
diff --git a/data/languages/themes/block-theme-pl_PL.po b/data/languages/themes/block-theme-pl_PL.po
index 0aa4bbd52d..6ac5a6967e 100644
--- a/data/languages/themes/block-theme-pl_PL.po
+++ b/data/languages/themes/block-theme-pl_PL.po
@@ -2,22 +2,30 @@ msgid ""
 msgstr ""
 "Project-Id-Version: \n"
 "POT-Creation-Date: 2015-12-31 16:31+0100\n"
-"PO-Revision-Date: 2021-03-15 13:10+0100\n"
+"PO-Revision-Date: 2022-08-31 11:08+0200\n"
+"Last-Translator: \n"
+"Language-Team: \n"
 "Language: pl_PL\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Generator: Poedit 2.4.2\n"
-"X-Poedit-Basepath: .\n"
 "Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Poedit 3.1.1\n"
+"X-Poedit-Basepath: .\n"
 "X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
 "_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
 "esc_html_x:1,2c\n"
 "X-Textdomain-Support: yes\n"
-"Last-Translator: \n"
-"Language-Team: \n"
 "X-Poedit-SearchPath-0: .\n"
 
+msgctxt "Style variation name"
+msgid "Block theme"
+msgstr "Motyw blokowy"
+
+msgctxt "Style variation name"
+msgid "Block theme variation"
+msgstr "Wariant motywu blokowego"
+
 msgctxt "Custom template name"
 msgid "Homepage template"
 msgstr "Szablon strony głównej"
diff --git a/data/languages/themes/internationalized-theme-de_DE.mo b/data/languages/themes/internationalized-theme-de_DE.mo
index 5a95f01bab..a48788607d 100644
Binary files a/data/languages/themes/internationalized-theme-de_DE.mo and b/data/languages/themes/internationalized-theme-de_DE.mo differ
diff --git a/data/languages/themes/internationalized-theme-de_DE.po b/data/languages/themes/internationalized-theme-de_DE.po
index 6d2391756f..03ed5de8c6 100644
--- a/data/languages/themes/internationalized-theme-de_DE.po
+++ b/data/languages/themes/internationalized-theme-de_DE.po
@@ -2,18 +2,20 @@ msgid ""
 msgstr ""
 "Project-Id-Version: \n"
 "POT-Creation-Date: 2015-12-31 16:38+0100\n"
-"PO-Revision-Date: 2016-10-26 00:02+0200\n"
+"PO-Revision-Date: 2020-10-20 17:09+0200\n"
 "Language: de_DE\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
-"X-Generator: Poedit 1.8.10\n"
+"X-Generator: Poedit 2.4.1\n"
 "X-Poedit-Basepath: .\n"
 "Plural-Forms: nplurals=2; plural=(n != 1);\n"
 "X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
 "_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
 "esc_html_x:1,2c\n"
 "X-Textdomain-Support: yes\n"
+"Last-Translator: \n"
+"Language-Team: \n"
 "X-Poedit-SearchPath-0: .\n"
 
 #: functions.php:7
diff --git a/data/plugins/custom-internationalized-plugin/custom-internationalized-plugin.php b/data/plugins/custom-internationalized-plugin/custom-internationalized-plugin.php
new file mode 100644
index 0000000000..41eb593556
--- /dev/null
+++ b/data/plugins/custom-internationalized-plugin/custom-internationalized-plugin.php
@@ -0,0 +1,14 @@
+<?php
+/*
+Plugin Name: Custom Dummy Plugin
+Plugin URI: https://wordpress.org/
+Description: For testing purposes only.
+Version: 1.0.0
+Text Domain: custom-internationalized-plugin
+*/
+
+load_plugin_textdomain( 'custom-internationalized-plugin', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );
+
+function custom_i18n_plugin_test() {
+	return __( 'This is a dummy plugin', 'custom-internationalized-plugin' );
+}
diff --git a/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-de_DE.mo b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-de_DE.mo
new file mode 100644
index 0000000000..6cb889acc4
Binary files /dev/null and b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-de_DE.mo differ
diff --git a/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-de_DE.po b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-de_DE.po
new file mode 100644
index 0000000000..e9e7cc28c1
--- /dev/null
+++ b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-de_DE.po
@@ -0,0 +1,23 @@
+msgid ""
+msgstr ""
+"Project-Id-Version: \n"
+"POT-Creation-Date: 2015-12-31 16:31+0100\n"
+"PO-Revision-Date: 2022-07-04 18:48+0200\n"
+"Last-Translator: Dominik Schilling\n"
+"Language-Team: \n"
+"Language: de_DE\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Poedit 3.1\n"
+"X-Poedit-Basepath: .\n"
+"X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
+"_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
+"esc_html_x:1,2c\n"
+"X-Textdomain-Support: yes\n"
+"X-Poedit-SearchPath-0: .\n"
+
+#: internationalized-plugin.php:11
+msgid "This is a dummy plugin"
+msgstr "Das ist ein Dummy Plugin"
diff --git a/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-es_ES.mo b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-es_ES.mo
new file mode 100644
index 0000000000..077ec03769
Binary files /dev/null and b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-es_ES.mo differ
diff --git a/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-es_ES.po b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-es_ES.po
new file mode 100644
index 0000000000..5ee8db8df0
--- /dev/null
+++ b/data/plugins/custom-internationalized-plugin/languages/custom-internationalized-plugin-es_ES.po
@@ -0,0 +1,23 @@
+msgid ""
+msgstr ""
+"Project-Id-Version: \n"
+"POT-Creation-Date: 2015-12-31 16:31+0100\n"
+"PO-Revision-Date: 2022-07-04 18:48+0200\n"
+"Last-Translator: Dominik Schilling\n"
+"Language-Team: \n"
+"Language: es_ES\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Poedit 3.1\n"
+"X-Poedit-Basepath: .\n"
+"X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
+"_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
+"esc_html_x:1,2c\n"
+"X-Textdomain-Support: yes\n"
+"X-Poedit-SearchPath-0: .\n"
+
+#: internationalized-plugin.php:11
+msgid "This is a dummy plugin"
+msgstr "Este es un plugin dummy"
diff --git a/data/plugins/hello.php b/data/plugins/hello.php
index 8d6287f77a..2f717ed699 100644
--- a/data/plugins/hello.php
+++ b/data/plugins/hello.php
@@ -4,11 +4,8 @@ Plugin Name: Hello Dolly
 Plugin URI: http://wordpress.org/#
 Description: This is not just a plugin, it symbolizes the hope and enthusiasm of an entire generation summed up in two words sung most famously by Louis Armstrong: Hello, Dolly. When activated you will randomly see a lyric from <cite>Hello, Dolly</cite> in the upper right of your admin screen on every page.
 Author: Matt Mullenweg
-Version: 1.5.1
+Version: 1.7.2
 Author URI: http://ma.tt/
 Text Domain: hello-dolly
 
 */
-
-// Test for 
-?>
diff --git a/data/themedir1/test-block-theme/templates/index.html b/data/themedir1/block-theme-deprecated-path/block-templates/index.html
similarity index 100%
rename from data/themedir1/test-block-theme/templates/index.html
rename to data/themedir1/block-theme-deprecated-path/block-templates/index.html
diff --git a/data/themedir1/test-block-theme/templates/page-home.html b/data/themedir1/block-theme-deprecated-path/block-templates/page-home.html
similarity index 100%
rename from data/themedir1/test-block-theme/templates/page-home.html
rename to data/themedir1/block-theme-deprecated-path/block-templates/page-home.html
diff --git a/data/themedir1/test-block-theme/templates/page.html b/data/themedir1/block-theme-deprecated-path/block-templates/page.html
similarity index 100%
rename from data/themedir1/test-block-theme/templates/page.html
rename to data/themedir1/block-theme-deprecated-path/block-templates/page.html
diff --git a/data/themedir1/block-theme-deprecated-path/parts/small-header.html b/data/themedir1/block-theme-deprecated-path/parts/small-header.html
new file mode 100644
index 0000000000..5c18e98125
--- /dev/null
+++ b/data/themedir1/block-theme-deprecated-path/parts/small-header.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Small Header Template Part</p>
+<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/block-theme-deprecated-path/style.css b/data/themedir1/block-theme-deprecated-path/style.css
new file mode 100644
index 0000000000..5b4beaa4fc
--- /dev/null
+++ b/data/themedir1/block-theme-deprecated-path/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Block Theme Deprecated Path
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Version: 1.0.0
+Text Domain: block-theme-deprecated-path
+*/
diff --git a/data/themedir1/block-theme-deprecated-path/styles/variation.json b/data/themedir1/block-theme-deprecated-path/styles/variation.json
new file mode 100644
index 0000000000..ad3affb115
--- /dev/null
+++ b/data/themedir1/block-theme-deprecated-path/styles/variation.json
@@ -0,0 +1,23 @@
+{
+    "version": 2,
+    "settings": {
+        "color": {
+            "palette": [
+                {
+                    "slug": "foreground",
+                    "color": "#3F67C6",
+                    "name": "Foreground"
+                }
+            ]
+        }
+    },
+    "styles": {
+        "blocks": {
+            "core/post-title": {
+                "typography": {
+                    "fontWeight": "700"
+                }
+            }
+        }
+    }
+}
\ No newline at end of file
diff --git a/data/themedir1/block-theme-deprecated-path/theme.json b/data/themedir1/block-theme-deprecated-path/theme.json
new file mode 100644
index 0000000000..38fcb1d9dd
--- /dev/null
+++ b/data/themedir1/block-theme-deprecated-path/theme.json
@@ -0,0 +1,71 @@
+{
+	"version": 1,
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			],
+			"gradients": [
+				{
+					"name": "Custom gradient",
+					"gradient": "linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%)",
+					"slug": "custom-gradient"
+				}
+			],
+			"custom": false,
+			"customGradient": false
+		},
+		"typography": {
+			"fontSizes": [
+				{
+					"name": "Custom",
+					"slug": "custom",
+					"size": "100px"
+				}
+			],
+			"customFontSize": false,
+			"customLineHeight": true
+		},
+		"spacing": {
+			"units": [
+				"rem"
+			],
+			"customPadding": true
+		},
+		"blocks": {
+			"core/paragraph": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f5f7f9"
+						}
+					]
+				}
+			}
+		}
+	},
+	"customTemplates": [
+		{
+			"name": "page-home",
+			"title": "Homepage template"
+		}
+	],
+	"templateParts": [
+		{
+			"name": "small-header",
+			"title": "Small Header",
+			"area": "header"
+		}
+	]
+}
diff --git a/data/themedir1/block-theme/blocks/example-block/block.json b/data/themedir1/block-theme/blocks/example-block/block.json
new file mode 100644
index 0000000000..419a332b58
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/block.json
@@ -0,0 +1,8 @@
+{
+	"apiVersion": 2,
+	"title": "Example Theme Block",
+	"name": "block-theme/example-block",
+	"description": "Custom block registered from within a theme",
+	"editorScript": "file:./index.js",
+	"style": "file:./style.css"
+}
diff --git a/data/themedir1/block-theme/blocks/example-block/editor-style-rtl.css b/data/themedir1/block-theme/blocks/example-block/editor-style-rtl.css
new file mode 100644
index 0000000000..2572f27aaf
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/editor-style-rtl.css
@@ -0,0 +1 @@
+/* Test CSS file - RTL version */
diff --git a/data/themedir1/block-theme/blocks/example-block/editor-style.css b/data/themedir1/block-theme/blocks/example-block/editor-style.css
new file mode 100644
index 0000000000..5bbe1134f7
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/editor-style.css
@@ -0,0 +1 @@
+/* Test CSS file */
diff --git a/data/themedir1/block-theme/blocks/example-block/index.asset.php b/data/themedir1/block-theme/blocks/example-block/index.asset.php
new file mode 100644
index 0000000000..0314b6de8d
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/index.asset.php
@@ -0,0 +1,6 @@
+<?php
+
+return array(
+	'dependencies' => array( 'wp-element', 'wp-blocks' ),
+	'version'      => 'test',
+);
diff --git a/data/themedir1/block-theme/blocks/example-block/index.js b/data/themedir1/block-theme/blocks/example-block/index.js
new file mode 100644
index 0000000000..0bdf0f5ad9
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/index.js
@@ -0,0 +1 @@
+/* Test JavaScript file. */
diff --git a/data/themedir1/block-theme/blocks/example-block/style-rtl.css b/data/themedir1/block-theme/blocks/example-block/style-rtl.css
new file mode 100644
index 0000000000..2572f27aaf
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/style-rtl.css
@@ -0,0 +1 @@
+/* Test CSS file - RTL version */
diff --git a/data/themedir1/block-theme/blocks/example-block/style.css b/data/themedir1/block-theme/blocks/example-block/style.css
new file mode 100644
index 0000000000..5bbe1134f7
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/style.css
@@ -0,0 +1 @@
+/* Test CSS file */
diff --git a/data/themedir1/block-theme/blocks/example-block/view.asset.php b/data/themedir1/block-theme/blocks/example-block/view.asset.php
new file mode 100644
index 0000000000..0314b6de8d
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/view.asset.php
@@ -0,0 +1,6 @@
+<?php
+
+return array(
+	'dependencies' => array( 'wp-element', 'wp-blocks' ),
+	'version'      => 'test',
+);
diff --git a/data/themedir1/block-theme/blocks/example-block/view.js b/data/themedir1/block-theme/blocks/example-block/view.js
new file mode 100644
index 0000000000..0bdf0f5ad9
--- /dev/null
+++ b/data/themedir1/block-theme/blocks/example-block/view.js
@@ -0,0 +1 @@
+/* Test JavaScript file. */
diff --git a/data/themedir1/block-theme/functions.php b/data/themedir1/block-theme/functions.php
new file mode 100644
index 0000000000..1a378da4b3
--- /dev/null
+++ b/data/themedir1/block-theme/functions.php
@@ -0,0 +1,7 @@
+<?php
+
+add_action( 'init', 'register_theme_blocks' );
+
+function register_theme_blocks() {
+	register_block_type( __DIR__ . 'blocks/example-block' );
+}
diff --git a/data/themedir1/block-theme/styles/variation.json b/data/themedir1/block-theme/styles/variation.json
new file mode 100644
index 0000000000..d0f316cb45
--- /dev/null
+++ b/data/themedir1/block-theme/styles/variation.json
@@ -0,0 +1,24 @@
+{
+	"version": 2,
+	"title": "Block theme variation",
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "foreground",
+					"color": "#3F67C6",
+					"name": "Foreground"
+				}
+			]
+		}
+	},
+	"styles": {
+		"blocks": {
+			"core/post-title": {
+				"typography": {
+					"fontWeight": "700"
+				}
+			}
+		}
+	}
+}
diff --git a/data/themedir1/block-theme/templates/custom-single-post-template.html b/data/themedir1/block-theme/templates/custom-single-post-template.html
new file mode 100644
index 0000000000..799062788c
--- /dev/null
+++ b/data/themedir1/block-theme/templates/custom-single-post-template.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Custom Single Post template</p>
+<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/block-theme/theme.json b/data/themedir1/block-theme/theme.json
index 38fcb1d9dd..4961a620a2 100644
--- a/data/themedir1/block-theme/theme.json
+++ b/data/themedir1/block-theme/theme.json
@@ -1,5 +1,6 @@
 {
 	"version": 1,
+	"title": "Block theme",
 	"settings": {
 		"color": {
 			"palette": [
@@ -36,9 +37,7 @@
 			"customLineHeight": true
 		},
 		"spacing": {
-			"units": [
-				"rem"
-			],
+			"units": ["rem"],
 			"customPadding": true
 		},
 		"blocks": {
@@ -59,6 +58,11 @@
 		{
 			"name": "page-home",
 			"title": "Homepage template"
+		},
+		{
+			"name": "custom-single-post-template",
+			"title": "Custom Single Post template",
+			"postTypes": ["post"]
 		}
 	],
 	"templateParts": [
diff --git a/data/themedir1/block_theme-[0.4.0]/index.php b/data/themedir1/block_theme-[0.4.0]/index.php
new file mode 100644
index 0000000000..589adcefcd
--- /dev/null
+++ b/data/themedir1/block_theme-[0.4.0]/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * Block theme.
+ */
diff --git a/data/themedir1/test-block-theme/page-1.php b/data/themedir1/block_theme-[0.4.0]/page-1.php
similarity index 100%
rename from data/themedir1/test-block-theme/page-1.php
rename to data/themedir1/block_theme-[0.4.0]/page-1.php
diff --git a/data/themedir1/block_theme-[0.4.0]/parts/large-header.html b/data/themedir1/block_theme-[0.4.0]/parts/large-header.html
new file mode 100644
index 0000000000..a006f0f494
--- /dev/null
+++ b/data/themedir1/block_theme-[0.4.0]/parts/large-header.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Large Héader Témplaté Part</p>
+<!-- /wp:paragraph -->
diff --git a/data/themedir1/block_theme-[0.4.0]/style.css b/data/themedir1/block_theme-[0.4.0]/style.css
new file mode 100644
index 0000000000..fe3ff14ba9
--- /dev/null
+++ b/data/themedir1/block_theme-[0.4.0]/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Block Theme [0.4.0]
+Theme URI: https://wordpress.org/
+Description: Has different characters in theme directory name for testing purposes.
+Version: 0.4.0
+Text Domain: block-theme
+*/
diff --git a/data/themedir1/block_theme-[0.4.0]/templates/page-large-header.html b/data/themedir1/block_theme-[0.4.0]/templates/page-large-header.html
new file mode 100644
index 0000000000..c5218f8739
--- /dev/null
+++ b/data/themedir1/block_theme-[0.4.0]/templates/page-large-header.html
@@ -0,0 +1,9 @@
+<!-- wp:template-part {"slug":"header-large-dark","tagName":"header"} /-->
+
+<!-- wp:group {"tagName":"main"} -->
+<main class="wp-block-group">
+<!-- wp:post-content {"layout":{"inherit":true}} /-->
+</main>
+<!-- /wp:group -->
+
+<!-- wp:template-part {"slug":"footer","tagName":"footer"} /-->
diff --git a/data/themedir1/block_theme-[0.4.0]/theme.json b/data/themedir1/block_theme-[0.4.0]/theme.json
new file mode 100644
index 0000000000..38fcb1d9dd
--- /dev/null
+++ b/data/themedir1/block_theme-[0.4.0]/theme.json
@@ -0,0 +1,71 @@
+{
+	"version": 1,
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			],
+			"gradients": [
+				{
+					"name": "Custom gradient",
+					"gradient": "linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%)",
+					"slug": "custom-gradient"
+				}
+			],
+			"custom": false,
+			"customGradient": false
+		},
+		"typography": {
+			"fontSizes": [
+				{
+					"name": "Custom",
+					"slug": "custom",
+					"size": "100px"
+				}
+			],
+			"customFontSize": false,
+			"customLineHeight": true
+		},
+		"spacing": {
+			"units": [
+				"rem"
+			],
+			"customPadding": true
+		},
+		"blocks": {
+			"core/paragraph": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f5f7f9"
+						}
+					]
+				}
+			}
+		}
+	},
+	"customTemplates": [
+		{
+			"name": "page-home",
+			"title": "Homepage template"
+		}
+	],
+	"templateParts": [
+		{
+			"name": "small-header",
+			"title": "Small Header",
+			"area": "header"
+		}
+	]
+}
diff --git a/data/themedir1/custom-internationalized-theme/functions.php b/data/themedir1/custom-internationalized-theme/functions.php
new file mode 100644
index 0000000000..272deed498
--- /dev/null
+++ b/data/themedir1/custom-internationalized-theme/functions.php
@@ -0,0 +1,10 @@
+<?php
+/**
+ * Dummy theme.
+ */
+
+load_theme_textdomain( 'custom-internationalized-theme', get_template_directory() . '/languages' );
+
+function custom_i18n_theme_test() {
+	return __( 'This is a dummy theme', 'custom-internationalized-theme' );
+}
diff --git a/data/themedir1/custom-internationalized-theme/index.php b/data/themedir1/custom-internationalized-theme/index.php
new file mode 100644
index 0000000000..c674182076
--- /dev/null
+++ b/data/themedir1/custom-internationalized-theme/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * Dummy theme.
+ */
diff --git a/data/themedir1/custom-internationalized-theme/languages/de_DE.mo b/data/themedir1/custom-internationalized-theme/languages/de_DE.mo
new file mode 100644
index 0000000000..0033867804
Binary files /dev/null and b/data/themedir1/custom-internationalized-theme/languages/de_DE.mo differ
diff --git a/data/themedir1/custom-internationalized-theme/languages/de_DE.po b/data/themedir1/custom-internationalized-theme/languages/de_DE.po
new file mode 100644
index 0000000000..f562f9b936
--- /dev/null
+++ b/data/themedir1/custom-internationalized-theme/languages/de_DE.po
@@ -0,0 +1,23 @@
+msgid ""
+msgstr ""
+"Project-Id-Version: \n"
+"POT-Creation-Date: 2015-12-31 16:38+0100\n"
+"PO-Revision-Date: 2022-07-04 18:47+0200\n"
+"Last-Translator: \n"
+"Language-Team: \n"
+"Language: de_DE\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Poedit 3.1\n"
+"X-Poedit-Basepath: .\n"
+"X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
+"_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
+"esc_html_x:1,2c\n"
+"X-Textdomain-Support: yes\n"
+"X-Poedit-SearchPath-0: .\n"
+
+#: functions.php:7
+msgid "This is a dummy theme"
+msgstr "Das ist ein Dummy Theme"
diff --git a/data/themedir1/custom-internationalized-theme/languages/es_ES.mo b/data/themedir1/custom-internationalized-theme/languages/es_ES.mo
new file mode 100644
index 0000000000..2b5581ab6c
Binary files /dev/null and b/data/themedir1/custom-internationalized-theme/languages/es_ES.mo differ
diff --git a/data/themedir1/custom-internationalized-theme/languages/es_ES.po b/data/themedir1/custom-internationalized-theme/languages/es_ES.po
new file mode 100644
index 0000000000..954feb5f38
--- /dev/null
+++ b/data/themedir1/custom-internationalized-theme/languages/es_ES.po
@@ -0,0 +1,23 @@
+msgid ""
+msgstr ""
+"Project-Id-Version: \n"
+"POT-Creation-Date: 2015-12-31 16:38+0100\n"
+"PO-Revision-Date: 2022-07-04 18:47+0200\n"
+"Last-Translator: \n"
+"Language-Team: \n"
+"Language: es_ES\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Poedit 3.1\n"
+"X-Poedit-Basepath: .\n"
+"X-Poedit-KeywordsList: __;_e;_x:1,2c;_ex:1,2c;_n:1,2;_nx:1,2,4c;_n_noop:1,2;"
+"_nx_noop:1,2,3c;esc_attr__;esc_html__;esc_attr_e;esc_html_e;esc_attr_x:1,2c;"
+"esc_html_x:1,2c\n"
+"X-Textdomain-Support: yes\n"
+"X-Poedit-SearchPath-0: .\n"
+
+#: functions.php:7
+msgid "This is a dummy theme"
+msgstr "Este es un tema dummy"
diff --git a/data/themedir1/custom-internationalized-theme/style.css b/data/themedir1/custom-internationalized-theme/style.css
new file mode 100644
index 0000000000..dec57eb4da
--- /dev/null
+++ b/data/themedir1/custom-internationalized-theme/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Custom Internationalized Theme
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Version: 1.0.0
+Text Domain: custom-internationalized-theme
+*/
diff --git a/data/themedir1/empty-fontface-theme/functions.php b/data/themedir1/empty-fontface-theme/functions.php
new file mode 100644
index 0000000000..b3d9bbc7f3
--- /dev/null
+++ b/data/themedir1/empty-fontface-theme/functions.php
@@ -0,0 +1 @@
+<?php
diff --git a/data/themedir1/empty-fontface-theme/index.php b/data/themedir1/empty-fontface-theme/index.php
new file mode 100644
index 0000000000..589adcefcd
--- /dev/null
+++ b/data/themedir1/empty-fontface-theme/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * Block theme.
+ */
diff --git a/data/themedir1/empty-fontface-theme/style.css b/data/themedir1/empty-fontface-theme/style.css
new file mode 100644
index 0000000000..2c884028a9
--- /dev/null
+++ b/data/themedir1/empty-fontface-theme/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Empty `fontFace` in theme.json - no webfonts defined
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Version: 1.0.0
+Text Domain: empty-fontface-theme
+*/
diff --git a/data/themedir1/empty-fontface-theme/templates/index.html b/data/themedir1/empty-fontface-theme/templates/index.html
new file mode 100644
index 0000000000..451c2c1a5c
--- /dev/null
+++ b/data/themedir1/empty-fontface-theme/templates/index.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Index Template</p>
+<!-- /wp:paragraph -->
diff --git a/data/themedir1/empty-fontface-theme/theme.json b/data/themedir1/empty-fontface-theme/theme.json
new file mode 100644
index 0000000000..a9f1cb5080
--- /dev/null
+++ b/data/themedir1/empty-fontface-theme/theme.json
@@ -0,0 +1,88 @@
+{
+  "version": 2,
+  "customTemplates": [
+	{
+	  "name": "blank",
+	  "title": "Blank",
+	  "postTypes": [
+		"page",
+		"post"
+	  ]
+	}
+  ],
+  "settings": {
+	"appearanceTools": true,
+	"color": {
+	  "duotone": [],
+	  "gradients": [],
+	  "palette": []
+	},
+	"custom": {},
+	"spacing": {
+	  "units": [
+		"%",
+		"px",
+		"em",
+		"rem",
+		"vh",
+		"vw"
+	  ]
+	},
+	"typography": {
+	  "dropCap": false,
+	  "fontFamilies": [
+		{
+		  "fontFamily": "Roboto",
+		  "name": "Roboto",
+		  "slug": "roboto",
+		  "fontFace": []
+		}
+	  ],
+	  "fontSizes": [
+		{
+		  "size": "1rem",
+		  "slug": "small"
+		},
+		{
+		  "size": "1.125rem",
+		  "slug": "medium"
+		},
+		{
+		  "size": "1.75rem",
+		  "slug": "large"
+		},
+		{
+		  "size": "clamp(1.75rem, 3vw, 2.25rem)",
+		  "slug": "x-large"
+		}
+	  ]
+	},
+	"layout": {
+	  "contentSize": "650px",
+	  "wideSize": "1000px"
+	}
+  },
+  "styles": {
+	"blocks": {},
+	"color": {
+	  "background": "var(--wp--preset--color--background)",
+	  "text": "var(--wp--preset--color--foreground)"
+	},
+	"elements": {},
+	"spacing": {
+	  "blockGap": "1.5rem"
+	},
+	"typography": {
+	  "fontFamily": "var(--wp--preset--font-family--system-font)",
+	  "lineHeight": "var(--wp--custom--typography--line-height--normal)",
+	  "fontSize": "var(--wp--preset--font-size--medium)"
+	}
+  },
+  "templateParts": [
+	{
+	  "name": "header",
+	  "title": "Header",
+	  "area": "header"
+	}
+  ]
+}
diff --git a/data/themedir1/subdir/block_theme-[1.0.0]/index.php b/data/themedir1/subdir/block_theme-[1.0.0]/index.php
new file mode 100644
index 0000000000..589adcefcd
--- /dev/null
+++ b/data/themedir1/subdir/block_theme-[1.0.0]/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * Block theme.
+ */
diff --git a/data/themedir1/subdir/block_theme-[1.0.0]/style.css b/data/themedir1/subdir/block_theme-[1.0.0]/style.css
new file mode 100644
index 0000000000..1e9c38f409
--- /dev/null
+++ b/data/themedir1/subdir/block_theme-[1.0.0]/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Block Theme [1.0.0] in subdirectory
+Theme URI: https://wordpress.org/
+Description: Has different characters in theme directory name for testing purposes.
+Version: 0.4.0
+Text Domain: block-theme
+*/
diff --git a/data/themedir1/subdir/block_theme-[1.0.0]/theme.json b/data/themedir1/subdir/block_theme-[1.0.0]/theme.json
new file mode 100644
index 0000000000..38fcb1d9dd
--- /dev/null
+++ b/data/themedir1/subdir/block_theme-[1.0.0]/theme.json
@@ -0,0 +1,71 @@
+{
+	"version": 1,
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			],
+			"gradients": [
+				{
+					"name": "Custom gradient",
+					"gradient": "linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%)",
+					"slug": "custom-gradient"
+				}
+			],
+			"custom": false,
+			"customGradient": false
+		},
+		"typography": {
+			"fontSizes": [
+				{
+					"name": "Custom",
+					"slug": "custom",
+					"size": "100px"
+				}
+			],
+			"customFontSize": false,
+			"customLineHeight": true
+		},
+		"spacing": {
+			"units": [
+				"rem"
+			],
+			"customPadding": true
+		},
+		"blocks": {
+			"core/paragraph": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f5f7f9"
+						}
+					]
+				}
+			}
+		}
+	},
+	"customTemplates": [
+		{
+			"name": "page-home",
+			"title": "Homepage template"
+		}
+	],
+	"templateParts": [
+		{
+			"name": "small-header",
+			"title": "Small Header",
+			"area": "header"
+		}
+	]
+}
diff --git a/data/themedir1/test-block-child-theme/page-home.php b/data/themedir1/test-block-child-theme/page-home.php
deleted file mode 100644
index 86efe80db6..0000000000
--- a/data/themedir1/test-block-child-theme/page-home.php
+++ /dev/null
@@ -1,3 +0,0 @@
-<?php
-
-echo 'PHP template for page with slug "home"';
diff --git a/data/themedir1/test-block-child-theme/style.css b/data/themedir1/test-block-child-theme/style.css
deleted file mode 100644
index 069ce2d03f..0000000000
--- a/data/themedir1/test-block-child-theme/style.css
+++ /dev/null
@@ -1,4 +0,0 @@
-/*
-Theme Name: Test Block Child Theme
-Template: test-block-theme
-*/
diff --git a/data/themedir1/test-block-child-theme/templates/page-1.html b/data/themedir1/test-block-child-theme/templates/page-1.html
deleted file mode 100644
index c3e788b393..0000000000
--- a/data/themedir1/test-block-child-theme/templates/page-1.html
+++ /dev/null
@@ -1,3 +0,0 @@
-<!-- wp:paragraph -->
-<p>Page (ID 1) Template</p>
-<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/test-block-theme/index.php b/data/themedir1/test-block-theme/index.php
deleted file mode 100644
index 634710b208..0000000000
--- a/data/themedir1/test-block-theme/index.php
+++ /dev/null
@@ -1,2 +0,0 @@
-<?php
-// This file is for test purposes only.
diff --git a/data/themedir1/test-block-theme/style.css b/data/themedir1/test-block-theme/style.css
deleted file mode 100644
index ed6c348660..0000000000
--- a/data/themedir1/test-block-theme/style.css
+++ /dev/null
@@ -1,3 +0,0 @@
-/*
-Theme Name: Test Block Theme
-*/
diff --git a/data/themedir1/update-uri-theme/index.php b/data/themedir1/update-uri-theme/index.php
new file mode 100644
index 0000000000..81f55f2fda
--- /dev/null
+++ b/data/themedir1/update-uri-theme/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * A theme with the Update URI header.
+ */
diff --git a/data/themedir1/update-uri-theme/style.css b/data/themedir1/update-uri-theme/style.css
new file mode 100644
index 0000000000..5c053ae1a1
--- /dev/null
+++ b/data/themedir1/update-uri-theme/style.css
@@ -0,0 +1,9 @@
+/*
+Theme Name:  A theme with the Update URI header
+Theme URI:   http://example.com/
+Description: This theme has the Update URI header.
+Version:     6.1
+Author:      WordPress Contributors
+Author URI:  http://example.net/
+Update URI:  http://example.org/update-uri-theme/
+*/
diff --git a/data/themedir1/webfonts-theme/functions.php b/data/themedir1/webfonts-theme/functions.php
new file mode 100644
index 0000000000..b3d9bbc7f3
--- /dev/null
+++ b/data/themedir1/webfonts-theme/functions.php
@@ -0,0 +1 @@
+<?php
diff --git a/data/themedir1/webfonts-theme/index.php b/data/themedir1/webfonts-theme/index.php
new file mode 100644
index 0000000000..589adcefcd
--- /dev/null
+++ b/data/themedir1/webfonts-theme/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * Block theme.
+ */
diff --git a/data/themedir1/webfonts-theme/style.css b/data/themedir1/webfonts-theme/style.css
new file mode 100644
index 0000000000..677a9db2a0
--- /dev/null
+++ b/data/themedir1/webfonts-theme/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Webfonts theme
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Version: 1.0.0
+Text Domain: webfonts-theme
+*/
diff --git a/data/themedir1/webfonts-theme/templates/index.html b/data/themedir1/webfonts-theme/templates/index.html
new file mode 100644
index 0000000000..451c2c1a5c
--- /dev/null
+++ b/data/themedir1/webfonts-theme/templates/index.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Index Template</p>
+<!-- /wp:paragraph -->
diff --git a/data/themedir1/webfonts-theme/theme.json b/data/themedir1/webfonts-theme/theme.json
new file mode 100644
index 0000000000..0606b9b780
--- /dev/null
+++ b/data/themedir1/webfonts-theme/theme.json
@@ -0,0 +1,103 @@
+{
+  "version": 2,
+  "customTemplates": [
+	{
+	  "name": "blank",
+	  "title": "Blank",
+	  "postTypes": [
+		"page",
+		"post"
+	  ]
+	}
+  ],
+  "settings": {
+	"appearanceTools": true,
+	"color": {
+	  "duotone": [],
+	  "gradients": [],
+	  "palette": []
+	},
+	"custom": {},
+	"spacing": {
+	  "units": [
+		"%",
+		"px",
+		"em",
+		"rem",
+		"vh",
+		"vw"
+	  ]
+	},
+	"typography": {
+	  "dropCap": false,
+	  "fontFamilies": [
+		{
+		  "fontFamily": "\"Source Serif Pro\", serif",
+		  "name": "Source Serif Pro",
+		  "slug": "source-serif-pro",
+		  "fontFace": [
+			{
+			  "fontFamily": "Source Serif Pro",
+			  "fontWeight": "200 900",
+			  "fontStyle": "normal",
+			  "fontStretch": "normal",
+			  "src": [ "file:./assets/fonts/SourceSerif4Variable-Roman.ttf.woff2" ]
+			},
+			{
+			  "fontFamily": "Source Serif Pro",
+			  "fontWeight": "200 900",
+			  "fontStyle": "italic",
+			  "fontStretch": "normal",
+			  "src": [ "file:./assets/fonts/SourceSerif4Variable-Italic.ttf.woff2" ]
+			}
+		  ]
+		}
+	  ],
+	  "fontSizes": [
+		{
+		  "size": "1rem",
+		  "slug": "small"
+		},
+		{
+		  "size": "1.125rem",
+		  "slug": "medium"
+		},
+		{
+		  "size": "1.75rem",
+		  "slug": "large"
+		},
+		{
+		  "size": "clamp(1.75rem, 3vw, 2.25rem)",
+		  "slug": "x-large"
+		}
+	  ]
+	},
+	"layout": {
+	  "contentSize": "650px",
+	  "wideSize": "1000px"
+	}
+  },
+  "styles": {
+	"blocks": {},
+	"color": {
+	  "background": "var(--wp--preset--color--background)",
+	  "text": "var(--wp--preset--color--foreground)"
+	},
+	"elements": {},
+	"spacing": {
+	  "blockGap": "1.5rem"
+	},
+	"typography": {
+	  "fontFamily": "var(--wp--preset--font-family--system-font)",
+	  "lineHeight": "var(--wp--custom--typography--line-height--normal)",
+	  "fontSize": "var(--wp--preset--font-size--medium)"
+	}
+  },
+  "templateParts": [
+	{
+	  "name": "header",
+	  "title": "Header",
+	  "area": "header"
+	}
+  ]
+}
diff --git a/data/widgets/custom-widget-classes.php b/data/widgets/custom-widget-classes.php
index 8d079f3693..f8d4d88573 100644
--- a/data/widgets/custom-widget-classes.php
+++ b/data/widgets/custom-widget-classes.php
@@ -1,14 +1,12 @@
 <?php
 namespace Test\Sub\Sub {
 
-	class Namespaced_Widget extends \WP_Widget {
-	}
+	class Namespaced_Widget extends \WP_Widget {}
 
 }
 
 namespace {
 
-	class Non_Namespaced_Widget extends \WP_Widget {
-	}
+	class Non_Namespaced_Widget extends \WP_Widget {}
 
 }
diff --git a/includes/abstract-testcase.php b/includes/abstract-testcase.php
index 765b514aa9..c20f450f7c 100644
--- a/includes/abstract-testcase.php
+++ b/includes/abstract-testcase.php
@@ -23,15 +23,14 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	protected static $hooks_saved = array();
 	protected static $ignore_files;
 
-	public function __isset( $name ) {
-		return 'factory' === $name;
-	}
-
-	public function __get( $name ) {
-		if ( 'factory' === $name ) {
-			return self::factory();
-		}
-	}
+	/**
+	 * Fixture factory.
+	 *
+	 * @deprecated 6.1.0 Use the WP_UnitTestCase_Base::factory() method instead.
+	 *
+	 * @var WP_UnitTest_Factory
+	 */
+	protected $factory;
 
 	/**
 	 * Fetches the factory object for generating WordPress fixtures.
@@ -103,6 +102,8 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	public function set_up() {
 		set_time_limit( 0 );
 
+		$this->factory = self::factory();
+
 		if ( ! self::$ignore_files ) {
 			self::$ignore_files = $this->scan_user_uploads();
 		}
@@ -174,6 +175,12 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 			$GLOBALS[ $global ] = null;
 		}
 
+		// Reset comment globals.
+		$comment_globals = array( 'comment_alt', 'comment_depth', 'comment_thread_alt' );
+		foreach ( $comment_globals as $global ) {
+			$GLOBALS[ $global ] = null;
+		}
+
 		/*
 		 * Reset $wp_sitemap global so that sitemap-related dynamic $wp->public_query_vars
 		 * are added when the next test runs.
@@ -202,20 +209,20 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	/**
 	 * Allows tests to be skipped on some automated runs.
 	 *
-	 * For test runs on GitHub Actions for something other than trunk/master,
-	 * we want to skip tests that only need to run for master.
+	 * For test runs on GitHub Actions for something other than trunk,
+	 * we want to skip tests that only need to run for trunk.
 	 */
 	public function skipOnAutomatedBranches() {
-		// https://docs.github.com/en/free-pro-team@latest/actions/reference/environment-variables#default-environment-variables
+		// https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables
 		$github_event_name = getenv( 'GITHUB_EVENT_NAME' );
 		$github_ref        = getenv( 'GITHUB_REF' );
 
-		if ( $github_event_name && 'false' !== $github_event_name ) {
+		if ( $github_event_name ) {
 			// We're on GitHub Actions.
 			$skipped = array( 'pull_request', 'pull_request_target' );
 
-			if ( in_array( $github_event_name, $skipped, true ) || 'refs/heads/master' !== $github_ref ) {
-				$this->markTestSkipped( 'For automated test runs, this test is only run on trunk/master' );
+			if ( in_array( $github_event_name, $skipped, true ) || 'refs/heads/trunk' !== $github_ref ) {
+				$this->markTestSkipped( 'For automated test runs, this test is only run on trunk' );
 			}
 		}
 	}
@@ -360,16 +367,41 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 */
 	public static function flush_cache() {
 		global $wp_object_cache;
+
 		$wp_object_cache->group_ops      = array();
 		$wp_object_cache->stats          = array();
 		$wp_object_cache->memcache_debug = array();
 		$wp_object_cache->cache          = array();
+
 		if ( method_exists( $wp_object_cache, '__remoteset' ) ) {
 			$wp_object_cache->__remoteset();
 		}
+
 		wp_cache_flush();
-		wp_cache_add_global_groups( array( 'users', 'userlogins', 'usermeta', 'user_meta', 'useremail', 'userslugs', 'site-transient', 'site-options', 'blog-lookup', 'blog-details', 'rss', 'global-posts', 'blog-id-cache', 'networks', 'sites', 'site-details', 'blog_meta' ) );
-		wp_cache_add_non_persistent_groups( array( 'comment', 'counts', 'plugins' ) );
+
+		wp_cache_add_global_groups(
+			array(
+				'blog-details',
+				'blog-id-cache',
+				'blog-lookup',
+				'blog_meta',
+				'global-posts',
+				'networks',
+				'sites',
+				'site-details',
+				'site-options',
+				'site-transient',
+				'rss',
+				'users',
+				'useremail',
+				'userlogins',
+				'usermeta',
+				'user_meta',
+				'userslugs',
+			)
+		);
+
+		wp_cache_add_non_persistent_groups( array( 'counts', 'plugins' ) );
 	}
 
 	/**
@@ -481,6 +513,8 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 
 	/**
 	 * Sets up the expectations for testing a deprecated call.
+	 *
+	 * @since 3.7.0
 	 */
 	public function expectDeprecated() {
 		if ( method_exists( $this, 'getAnnotations' ) ) {
@@ -496,17 +530,26 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 
 		foreach ( array( 'class', 'method' ) as $depth ) {
 			if ( ! empty( $annotations[ $depth ]['expectedDeprecated'] ) ) {
-				$this->expected_deprecated = array_merge( $this->expected_deprecated, $annotations[ $depth ]['expectedDeprecated'] );
+				$this->expected_deprecated = array_merge(
+					$this->expected_deprecated,
+					$annotations[ $depth ]['expectedDeprecated']
+				);
 			}
+
 			if ( ! empty( $annotations[ $depth ]['expectedIncorrectUsage'] ) ) {
-				$this->expected_doing_it_wrong = array_merge( $this->expected_doing_it_wrong, $annotations[ $depth ]['expectedIncorrectUsage'] );
+				$this->expected_doing_it_wrong = array_merge(
+					$this->expected_doing_it_wrong,
+					$annotations[ $depth ]['expectedIncorrectUsage']
+				);
 			}
 		}
-		add_action( 'deprecated_function_run', array( $this, 'deprecated_function_run' ) );
-		add_action( 'deprecated_argument_run', array( $this, 'deprecated_function_run' ) );
-		add_action( 'deprecated_file_included', array( $this, 'deprecated_function_run' ) );
-		add_action( 'deprecated_hook_run', array( $this, 'deprecated_function_run' ) );
-		add_action( 'doing_it_wrong_run', array( $this, 'doing_it_wrong_run' ) );
+
+		add_action( 'deprecated_function_run', array( $this, 'deprecated_function_run' ), 10, 3 );
+		add_action( 'deprecated_argument_run', array( $this, 'deprecated_function_run' ), 10, 3 );
+		add_action( 'deprecated_file_included', array( $this, 'deprecated_function_run' ), 10, 4 );
+		add_action( 'deprecated_hook_run', array( $this, 'deprecated_function_run' ), 10, 4 );
+		add_action( 'doing_it_wrong_run', array( $this, 'doing_it_wrong_run' ), 10, 3 );
+
 		add_action( 'deprecated_function_trigger_error', '__return_false' );
 		add_action( 'deprecated_argument_trigger_error', '__return_false' );
 		add_action( 'deprecated_file_trigger_error', '__return_false' );
@@ -518,28 +561,50 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 * Handles a deprecated expectation.
 	 *
 	 * The DocBlock should contain `@expectedDeprecated` to trigger this.
+	 *
+	 * @since 3.7.0
+	 * @since 6.1.0 Includes the actual unexpected `_doing_it_wrong()` message
+	 *              or deprecation notice in the output if one is encountered.
 	 */
 	public function expectedDeprecated() {
 		$errors = array();
 
-		$not_caught_deprecated = array_diff( $this->expected_deprecated, $this->caught_deprecated );
+		$not_caught_deprecated = array_diff(
+			$this->expected_deprecated,
+			array_keys( $this->caught_deprecated )
+		);
+
 		foreach ( $not_caught_deprecated as $not_caught ) {
-			$errors[] = "Failed to assert that $not_caught triggered a deprecated notice";
+			$errors[] = "Failed to assert that $not_caught triggered a deprecation notice.";
 		}
 
-		$unexpected_deprecated = array_diff( $this->caught_deprecated, $this->expected_deprecated );
+		$unexpected_deprecated = array_diff(
+			array_keys( $this->caught_deprecated ),
+			$this->expected_deprecated
+		);
+
 		foreach ( $unexpected_deprecated as $unexpected ) {
-			$errors[] = "Unexpected deprecated notice for $unexpected";
+			$errors[] = "Unexpected deprecation notice for $unexpected.";
+			$errors[] = $this->caught_deprecated[ $unexpected ];
 		}
 
-		$not_caught_doing_it_wrong = array_diff( $this->expected_doing_it_wrong, $this->caught_doing_it_wrong );
+		$not_caught_doing_it_wrong = array_diff(
+			$this->expected_doing_it_wrong,
+			array_keys( $this->caught_doing_it_wrong )
+		);
+
 		foreach ( $not_caught_doing_it_wrong as $not_caught ) {
-			$errors[] = "Failed to assert that $not_caught triggered an incorrect usage notice";
+			$errors[] = "Failed to assert that $not_caught triggered an incorrect usage notice.";
 		}
 
-		$unexpected_doing_it_wrong = array_diff( $this->caught_doing_it_wrong, $this->expected_doing_it_wrong );
+		$unexpected_doing_it_wrong = array_diff(
+			array_keys( $this->caught_doing_it_wrong ),
+			$this->expected_doing_it_wrong
+		);
+
 		foreach ( $unexpected_doing_it_wrong as $unexpected ) {
-			$errors[] = "Unexpected incorrect usage notice for $unexpected";
+			$errors[] = "Unexpected incorrect usage notice for $unexpected.";
+			$errors[] = $this->caught_doing_it_wrong[ $unexpected ];
 		}
 
 		// Perform an assertion, but only if there are expected or unexpected deprecated calls or wrongdoings.
@@ -567,8 +632,9 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 *
 	 * @since 4.2.0
 	 *
-	 * @param string $deprecated Name of the function, method, class, or argument that is deprecated. Must match
-	 *                           the first parameter of the `_deprecated_function()` or `_deprecated_argument()` call.
+	 * @param string $deprecated Name of the function, method, class, or argument that is deprecated.
+	 *                           Must match the first parameter of the `_deprecated_function()`
+	 *                           or `_deprecated_argument()` call.
 	 */
 	public function setExpectedDeprecated( $deprecated ) {
 		$this->expected_deprecated[] = $deprecated;
@@ -579,8 +645,8 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 *
 	 * @since 4.2.0
 	 *
-	 * @param string $doing_it_wrong Name of the function, method, or class that appears in the first argument
-	 *                               of the source `_doing_it_wrong()` call.
+	 * @param string $doing_it_wrong Name of the function, method, or class that appears in
+	 *                               the first argument of the source `_doing_it_wrong()` call.
 	 */
 	public function setExpectedIncorrectUsage( $doing_it_wrong ) {
 		$this->expected_doing_it_wrong[] = $doing_it_wrong;
@@ -591,6 +657,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 *
 	 * This method is only left in place for backward compatibility reasons.
 	 *
+	 * @since 4.8.0
 	 * @deprecated 5.9.0 Use the PHPUnit native expectException*() methods directly.
 	 *
 	 * @param mixed      $exception
@@ -612,22 +679,107 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	/**
 	 * Adds a deprecated function to the list of caught deprecated calls.
 	 *
-	 * @param string $function The deprecated function.
-	 */
-	public function deprecated_function_run( $function ) {
-		if ( ! in_array( $function, $this->caught_deprecated, true ) ) {
-			$this->caught_deprecated[] = $function;
+	 * @since 3.7.0
+	 * @since 6.1.0 Added the `$replacement`, `$version`, and `$message` parameters.
+	 *
+	 * @param string $function    The deprecated function.
+	 * @param string $replacement The function that should have been called.
+	 * @param string $version     The version of WordPress that deprecated the function.
+	 * @param string $message     Optional. A message regarding the change.
+	 */
+	public function deprecated_function_run( $function, $replacement, $version, $message = '' ) {
+		if ( ! isset( $this->caught_deprecated[ $function ] ) ) {
+			switch ( current_action() ) {
+				case 'deprecated_function_run':
+					if ( $replacement ) {
+						$message = sprintf(
+							'Function %1$s is deprecated since version %2$s! Use %3$s instead.',
+							$function,
+							$version,
+							$replacement
+						);
+					} else {
+						$message = sprintf(
+							'Function %1$s is deprecated since version %2$s with no alternative available.',
+							$function,
+							$version
+						);
+					}
+					break;
+
+				case 'deprecated_argument_run':
+					if ( $replacement ) {
+						$message = sprintf(
+							'Function %1$s was called with an argument that is deprecated since version %2$s! %3$s',
+							$function,
+							$version,
+							$replacement
+						);
+					} else {
+						$message = sprintf(
+							'Function %1$s was called with an argument that is deprecated since version %2$s with no alternative available.',
+							$function,
+							$version
+						);
+					}
+					break;
+
+				case 'deprecated_file_included':
+					if ( $replacement ) {
+						$message = sprintf(
+							'File %1$s is deprecated since version %2$s! Use %3$s instead.',
+							$function,
+							$version,
+							$replacement
+						) . ' ' . $message;
+					} else {
+						$message = sprintf(
+							'File %1$s is deprecated since version %2$s with no alternative available.',
+							$function,
+							$version
+						) . ' ' . $message;
+					}
+					break;
+
+				case 'deprecated_hook_run':
+					if ( $replacement ) {
+						$message = sprintf(
+							'Hook %1$s is deprecated since version %2$s! Use %3$s instead.',
+							$function,
+							$version,
+							$replacement
+						) . ' ' . $message;
+					} else {
+						$message = sprintf(
+							'Hook %1$s is deprecated since version %2$s with no alternative available.',
+							$function,
+							$version
+						) . ' ' . $message;
+					}
+					break;
+			}
+
+			$this->caught_deprecated[ $function ] = $message;
 		}
 	}
 
 	/**
 	 * Adds a function called in a wrong way to the list of `_doing_it_wrong()` calls.
 	 *
+	 * @since 3.7.0
+	 * @since 6.1.0 Added the `$message` and `$version` parameters.
+	 *
 	 * @param string $function The function to add.
+	 * @param string $message  A message explaining what has been done incorrectly.
+	 * @param string $version  The version of WordPress where the message was added.
 	 */
-	public function doing_it_wrong_run( $function ) {
-		if ( ! in_array( $function, $this->caught_doing_it_wrong, true ) ) {
-			$this->caught_doing_it_wrong[] = $function;
+	public function doing_it_wrong_run( $function, $message, $version ) {
+		if ( ! isset( $this->caught_doing_it_wrong[ $function ] ) ) {
+			if ( $version ) {
+				$message .= ' ' . sprintf( '(This message was added in version %s.)', $version );
+			}
+
+			$this->caught_doing_it_wrong[ $function ] = $message;
 		}
 	}
 
@@ -648,9 +800,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 * @param string $message Optional. Message to display when the assertion fails.
 	 */
 	public function assertNotWPError( $actual, $message = '' ) {
-		if ( '' === $message && is_wp_error( $actual ) ) {
-			$message = $actual->get_error_message();
+		if ( is_wp_error( $actual ) ) {
+			$message .= ' ' . $actual->get_error_message();
 		}
+
 		$this->assertNotInstanceOf( 'WP_Error', $actual, $message );
 	}
 
@@ -671,9 +824,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 * @param string $message Optional. Message to display when the assertion fails.
 	 */
 	public function assertNotIXRError( $actual, $message = '' ) {
-		if ( '' === $message && $actual instanceof IXR_Error ) {
-			$message = $actual->message;
+		if ( $actual instanceof IXR_Error ) {
+			$message .= ' ' . $actual->message;
 		}
+
 		$this->assertNotInstanceOf( 'IXR_Error', $actual, $message );
 	}
 
@@ -871,6 +1025,132 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 		}
 	}
 
+	/**
+	 * Checks each of the WP_Query is_* functions/properties against expected boolean value.
+	 *
+	 * Any properties that are listed by name as parameters will be expected to be true; all others are
+	 * expected to be false. For example, assertQueryTrue( 'is_single', 'is_feed' ) means is_single()
+	 * and is_feed() must be true and everything else must be false to pass.
+	 *
+	 * @since 2.5.0
+	 * @since 3.8.0 Moved from `Tests_Query_Conditionals` to `WP_UnitTestCase`.
+	 * @since 5.3.0 Formalized the existing `...$prop` parameter by adding it
+	 *              to the function signature.
+	 *
+	 * @param string ...$prop Any number of WP_Query properties that are expected to be true for the current request.
+	 */
+	public function assertQueryTrue( ...$prop ) {
+		global $wp_query;
+
+		$all = array(
+			'is_404',
+			'is_admin',
+			'is_archive',
+			'is_attachment',
+			'is_author',
+			'is_category',
+			'is_comment_feed',
+			'is_date',
+			'is_day',
+			'is_embed',
+			'is_feed',
+			'is_front_page',
+			'is_home',
+			'is_privacy_policy',
+			'is_month',
+			'is_page',
+			'is_paged',
+			'is_post_type_archive',
+			'is_posts_page',
+			'is_preview',
+			'is_robots',
+			'is_favicon',
+			'is_search',
+			'is_single',
+			'is_singular',
+			'is_tag',
+			'is_tax',
+			'is_time',
+			'is_trackback',
+			'is_year',
+		);
+
+		foreach ( $prop as $true_thing ) {
+			$this->assertContains( $true_thing, $all, "Unknown conditional: {$true_thing}." );
+		}
+
+		$passed  = true;
+		$message = '';
+
+		foreach ( $all as $query_thing ) {
+			$result = is_callable( $query_thing ) ? call_user_func( $query_thing ) : $wp_query->$query_thing;
+
+			if ( in_array( $query_thing, $prop, true ) ) {
+				if ( ! $result ) {
+					$message .= $query_thing . ' is false but is expected to be true. ' . PHP_EOL;
+					$passed   = false;
+				}
+			} elseif ( $result ) {
+				$message .= $query_thing . ' is true but is expected to be false. ' . PHP_EOL;
+				$passed   = false;
+			}
+		}
+
+		if ( ! $passed ) {
+			$this->fail( $message );
+		}
+	}
+
+	/**
+	 * Helper function to convert a single-level array containing text strings to a named data provider.
+	 *
+	 * The value of the data set will also be used as the name of the data set.
+	 *
+	 * Typical usage of this method:
+	 *
+	 *     public function data_provider_for_test_name() {
+	 *         $array = array(
+	 *             'value1',
+	 *             'value2',
+	 *         );
+	 *
+	 *         return $this->text_array_to_dataprovider( $array );
+	 *     }
+	 *
+	 * The returned result will look like:
+	 *
+	 *     array(
+	 *         'value1' => array( 'value1' ),
+	 *         'value2' => array( 'value2' ),
+	 *     )
+	 *
+	 * @since 6.1.0
+	 *
+	 * @param array $input Input array.
+	 * @return array Array which is usable as a test data provider with named data sets.
+	 */
+	public static function text_array_to_dataprovider( $input ) {
+		$data = array();
+
+		foreach ( $input as $value ) {
+			if ( ! is_string( $value ) ) {
+				throw new Exception(
+					'All values in the input array should be text strings. Fix the input data.'
+				);
+			}
+
+			if ( isset( $data[ $value ] ) ) {
+				throw new Exception(
+					"Attempting to add a duplicate data set for value $value to the data provider. Fix the input data."
+				);
+			}
+
+			$data[ $value ] = array( $value );
+		}
+
+		return $data;
+	}
+
 	/**
 	 * Sets the global state to as if a given URL has been requested.
 	 *
@@ -1047,82 +1327,6 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 		return tempnam( $tmp_dir, 'wpunit' );
 	}
 
-	/**
-	 * Checks each of the WP_Query is_* functions/properties against expected boolean value.
-	 *
-	 * Any properties that are listed by name as parameters will be expected to be true; all others are
-	 * expected to be false. For example, assertQueryTrue( 'is_single', 'is_feed' ) means is_single()
-	 * and is_feed() must be true and everything else must be false to pass.
-	 *
-	 * @since 2.5.0
-	 * @since 3.8.0 Moved from `Tests_Query_Conditionals` to `WP_UnitTestCase`.
-	 * @since 5.3.0 Formalized the existing `...$prop` parameter by adding it
-	 *              to the function signature.
-	 *
-	 * @param string ...$prop Any number of WP_Query properties that are expected to be true for the current request.
-	 */
-	public function assertQueryTrue( ...$prop ) {
-		global $wp_query;
-
-		$all = array(
-			'is_404',
-			'is_admin',
-			'is_archive',
-			'is_attachment',
-			'is_author',
-			'is_category',
-			'is_comment_feed',
-			'is_date',
-			'is_day',
-			'is_embed',
-			'is_feed',
-			'is_front_page',
-			'is_home',
-			'is_privacy_policy',
-			'is_month',
-			'is_page',
-			'is_paged',
-			'is_post_type_archive',
-			'is_posts_page',
-			'is_preview',
-			'is_robots',
-			'is_favicon',
-			'is_search',
-			'is_single',
-			'is_singular',
-			'is_tag',
-			'is_tax',
-			'is_time',
-			'is_trackback',
-			'is_year',
-		);
-
-		foreach ( $prop as $true_thing ) {
-			$this->assertContains( $true_thing, $all, "Unknown conditional: {$true_thing}." );
-		}
-
-		$passed  = true;
-		$message = '';
-
-		foreach ( $all as $query_thing ) {
-			$result = is_callable( $query_thing ) ? call_user_func( $query_thing ) : $wp_query->$query_thing;
-
-			if ( in_array( $query_thing, $prop, true ) ) {
-				if ( ! $result ) {
-					$message .= $query_thing . ' is false but is expected to be true. ' . PHP_EOL;
-					$passed   = false;
-				}
-			} elseif ( $result ) {
-				$message .= $query_thing . ' is true but is expected to be false. ' . PHP_EOL;
-				$passed   = false;
-			}
-		}
-
-		if ( ! $passed ) {
-			$this->fail( $message );
-		}
-	}
-
 	/**
 	 * Selectively deletes a file.
 	 *
@@ -1218,35 +1422,51 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	 * @param string $path Path to the directory to scan.
 	 */
 	public function delete_folders( $path ) {
-		$this->matched_dirs = array();
 		if ( ! is_dir( $path ) ) {
 			return;
 		}
 
-		$this->scandir( $path );
-		foreach ( array_reverse( $this->matched_dirs ) as $dir ) {
+		$matched_dirs = $this->scandir( $path );
+
+		foreach ( array_reverse( $matched_dirs ) as $dir ) {
 			rmdir( $dir );
 		}
+
 		rmdir( $path );
 	}
 
 	/**
-	 * Retrieves all directories contained inside a directory and stores them in the `$matched_dirs` property.
+	 * Retrieves all directories contained inside a directory.
 	 * Hidden directories are ignored.
 	 *
 	 * This is a helper for the `delete_folders()` method.
 	 *
 	 * @since 4.1.0
+	 * @since 6.1.0 No longer sets a (dynamic) property to keep track of the directories,
+	 *              but returns an array of the directories instead.
 	 *
 	 * @param string $dir Path to the directory to scan.
+	 * @return string[] List of directories.
 	 */
 	public function scandir( $dir ) {
+		$matched_dirs = array();
+
 		foreach ( scandir( $dir ) as $path ) {
 			if ( 0 !== strpos( $path, '.' ) && is_dir( $dir . '/' . $path ) ) {
-				$this->matched_dirs[] = $dir . '/' . $path;
-				$this->scandir( $dir . '/' . $path );
+				$matched_dirs[] = array( $dir . '/' . $path );
+				$matched_dirs[] = $this->scandir( $dir . '/' . $path );
 			}
 		}
+
+		/*
+		 * Compatibility check for PHP < 7.4, where array_merge() expects at least one array.
+		 * See: https://3v4l.org/BIQMA
+		 */
+		if ( array() === $matched_dirs ) {
+			return array();
+		}
+
+		return array_merge( ...$matched_dirs );
 	}
 
 	/**
diff --git a/includes/bootstrap.php b/includes/bootstrap.php
index a8a18a1ac3..9a1b234b71 100644
--- a/includes/bootstrap.php
+++ b/includes/bootstrap.php
@@ -215,7 +215,11 @@ define( 'WP_TESTS_TABLE_PREFIX', $table_prefix );
 define( 'DIR_TESTDATA', __DIR__ . '/../data' );
 define( 'DIR_TESTROOT', realpath( dirname( __DIR__ ) ) );
 
-define( 'WP_LANG_DIR', DIR_TESTDATA . '/languages' );
+define( 'WP_LANG_DIR', realpath( DIR_TESTDATA . '/languages' ) );
+
+if ( defined( 'WP_RUN_CORE_TESTS' ) && WP_RUN_CORE_TESTS ) {
+	define( 'WP_PLUGIN_DIR', realpath( DIR_TESTDATA . '/plugins' ) );
+}
 
 if ( ! defined( 'WP_TESTS_FORCE_KNOWN_BUGS' ) ) {
 	define( 'WP_TESTS_FORCE_KNOWN_BUGS', false );
diff --git a/includes/class-basic-object.php b/includes/class-basic-object.php
index 6165344bde..3054225713 100644
--- a/includes/class-basic-object.php
+++ b/includes/class-basic-object.php
@@ -13,22 +13,29 @@
  * @since 4.0.0
  */
 class Basic_Object {
-	private $foo = 'bar';
+
+	private $arbitrary_props = array(
+		'foo' => 'bar',
+	);
 
 	public function __get( $name ) {
-		return $this->$name;
+		if ( array_key_exists( $name, $this->arbitrary_props ) ) {
+			return $this->arbitrary_props[ $name ];
+		}
+
+		return null;
 	}
 
 	public function __set( $name, $value ) {
-		return $this->$name = $value;
+		$this->arbitrary_props[ $name ] = $value;
 	}
 
 	public function __isset( $name ) {
-		return isset( $this->$name );
+		return isset( $this->arbitrary_props[ $name ] );
 	}
 
 	public function __unset( $name ) {
-		unset( $this->$name );
+		unset( $this->arbitrary_props[ $name ] );
 	}
 
 	public function __call( $name, $arguments ) {
diff --git a/includes/class-wp-test-stream.php b/includes/class-wp-test-stream.php
index f489b2bdcc..78ce816f69 100644
--- a/includes/class-wp-test-stream.php
+++ b/includes/class-wp-test-stream.php
@@ -30,6 +30,15 @@ class WP_Test_Stream {
 	public $bucket;
 	public $data_ref;
 
+	/**
+	 * The current context.
+	 *
+	 * @link https://www.php.net/manual/en/class.streamwrapper.php
+	 *
+	 * @var resource|null
+	 */
+	public $context;
+
 	/**
 	 * Initializes internal state for reading the given URL.
 	 *
diff --git a/includes/functions.php b/includes/functions.php
index 323043dfba..3845f930a5 100644
--- a/includes/functions.php
+++ b/includes/functions.php
@@ -152,9 +152,12 @@ function _delete_all_posts() {
 /**
  * Handles the WP die handler by outputting the given values as text.
  *
- * @param string $message The message.
- * @param string $title   The title.
- * @param array  $args    Array with arguments.
+ * @since UT (3.7.0)
+ * @since 6.1.0 The `$message` parameter can accept a `WP_Error` object.
+ *
+ * @param string|WP_Error $message Error message or WP_Error object.
+ * @param string          $title   Error title.
+ * @param array           $args    Arguments passed to wp_die().
  */
 function _wp_die_handler( $message, $title = '', $args = array() ) {
 	if ( ! $GLOBALS['_wp_die_disabled'] ) {
@@ -166,6 +169,8 @@ function _wp_die_handler( $message, $title = '', $args = array() ) {
 
 /**
  * Disables the WP die handler.
+ *
+ * @since UT (3.7.0)
  */
 function _disable_wp_die() {
 	$GLOBALS['_wp_die_disabled'] = true;
@@ -173,6 +178,8 @@ function _disable_wp_die() {
 
 /**
  * Enables the WP die handler.
+ *
+ * @since UT (3.7.0)
  */
 function _enable_wp_die() {
 	$GLOBALS['_wp_die_disabled'] = false;
@@ -181,6 +188,8 @@ function _enable_wp_die() {
 /**
  * Returns the die handler.
  *
+ * @since UT (3.7.0)
+ *
  * @return string The die handler.
  */
 function _wp_die_handler_filter() {
@@ -190,6 +199,8 @@ function _wp_die_handler_filter() {
 /**
  * Returns the die handler.
  *
+ * @since 4.9.0
+ *
  * @return string The die handler.
  */
 function _wp_die_handler_filter_exit() {
@@ -199,12 +210,17 @@ function _wp_die_handler_filter_exit() {
 /**
  * Dies without an exit.
  *
- * @param string $message The message.
- * @param string $title   The title.
- * @param array  $args    Array with arguments.
+ * @since 4.0.0
+ * @since 6.1.0 The `$message` parameter can accept a `WP_Error` object.
+ *
+ * @param string|WP_Error $message Error message or WP_Error object.
+ * @param string          $title   Error title.
+ * @param array           $args    Arguments passed to wp_die().
  */
 function _wp_die_handler_txt( $message, $title, $args ) {
-	echo "\nwp_die called\n";
+	list( $message, $title, $args ) = _wp_die_process_input( $message, $title, $args );
+
+	echo "\nwp_die() called\n";
 	echo "Message: $message\n";
 
 	if ( ! empty( $title ) ) {
@@ -212,9 +228,13 @@ function _wp_die_handler_txt( $message, $title, $args ) {
 	}
 
 	if ( ! empty( $args ) ) {
-		echo "Args: \n";
-		foreach ( $args as $k => $v ) {
-			echo "\t $k : $v\n";
+		echo "Args:\n";
+		foreach ( $args as $key => $value ) {
+			if ( ! is_scalar( $value ) ) {
+				$value = var_export( $value, true );
+			}
+
+			echo "\t$key: $value\n";
 		}
 	}
 }
@@ -222,12 +242,17 @@ function _wp_die_handler_txt( $message, $title, $args ) {
 /**
  * Dies with an exit.
  *
- * @param string $message The message.
- * @param string $title   The title.
- * @param array  $args    Array with arguments.
+ * @since 4.9.0
+ * @since 6.1.0 The `$message` parameter can accept a `WP_Error` object.
+ *
+ * @param string|WP_Error $message Error message or WP_Error object.
+ * @param string          $title   Error title.
+ * @param array           $args    Arguments passed to wp_die().
  */
 function _wp_die_handler_exit( $message, $title, $args ) {
-	echo "\nwp_die called\n";
+	list( $message, $title, $args ) = _wp_die_process_input( $message, $title, $args );
+
+	echo "\nwp_die() called\n";
 	echo "Message: $message\n";
 
 	if ( ! empty( $title ) ) {
@@ -235,11 +260,16 @@ function _wp_die_handler_exit( $message, $title, $args ) {
 	}
 
 	if ( ! empty( $args ) ) {
-		echo "Args: \n";
-		foreach ( $args as $k => $v ) {
-			echo "\t $k : $v\n";
+		echo "Args:\n";
+		foreach ( $args as $key => $value ) {
+			if ( ! is_scalar( $value ) ) {
+				$value = var_export( $value, true );
+			}
+
+			echo "\t$key: $value\n";
 		}
 	}
+
 	exit( 1 );
 }
 
@@ -302,47 +332,10 @@ tests_add_filter( 'send_auth_cookies', '__return_false' );
  * @since 5.0.0
  */
 function _unhook_block_registration() {
-	remove_action( 'init', 'register_block_core_archives' );
-	remove_action( 'init', 'register_block_core_block' );
-	remove_action( 'init', 'register_block_core_calendar' );
-	remove_action( 'init', 'register_block_core_categories' );
-	remove_action( 'init', 'register_block_core_file' );
-	remove_action( 'init', 'register_block_core_latest_comments' );
-	remove_action( 'init', 'register_block_core_latest_posts' );
+	require __DIR__ . '/unregister-blocks-hooks.php';
+	remove_action( 'init', 'register_core_block_types_from_metadata' );
 	remove_action( 'init', 'register_block_core_legacy_widget' );
-	remove_action( 'init', 'register_block_core_loginout' );
-	remove_action( 'init', 'register_block_core_navigation' );
-	remove_action( 'init', 'register_block_core_navigation_link' );
-	remove_action( 'init', 'register_block_core_navigation_submenu' );
-	remove_action( 'init', 'register_block_core_page_list' );
-	remove_action( 'init', 'register_block_core_pattern' );
-	remove_action( 'init', 'register_block_core_post_author' );
-	remove_action( 'init', 'register_block_core_post_comments' );
-	remove_action( 'init', 'register_block_core_post_content' );
-	remove_action( 'init', 'register_block_core_post_date' );
-	remove_action( 'init', 'register_block_core_post_excerpt' );
-	remove_action( 'init', 'register_block_core_post_featured_image' );
-	remove_action( 'init', 'register_block_core_post_navigation_link' );
-	remove_action( 'init', 'register_block_core_post_template' );
-	remove_action( 'init', 'register_block_core_post_terms' );
-	remove_action( 'init', 'register_block_core_post_title' );
-	remove_action( 'init', 'register_block_core_query' );
-	remove_action( 'init', 'register_block_core_query_pagination' );
-	remove_action( 'init', 'register_block_core_query_pagination_next' );
-	remove_action( 'init', 'register_block_core_query_pagination_numbers' );
-	remove_action( 'init', 'register_block_core_query_pagination_previous' );
-	remove_action( 'init', 'register_block_core_query_title' );
-	remove_action( 'init', 'register_block_core_rss' );
-	remove_action( 'init', 'register_block_core_search' );
-	remove_action( 'init', 'register_block_core_shortcode' );
-	remove_action( 'init', 'register_block_core_site_logo' );
-	remove_action( 'init', 'register_block_core_site_tagline' );
-	remove_action( 'init', 'register_block_core_site_title' );
-	remove_action( 'init', 'register_block_core_social_link' );
-	remove_action( 'init', 'register_block_core_social_link' );
-	remove_action( 'init', 'register_block_core_tag_cloud' );
-	remove_action( 'init', 'register_block_core_template_part' );
-	remove_action( 'init', 'register_block_core_term_description' );
+	remove_action( 'init', 'register_block_core_widget_group' );
 	remove_action( 'init', 'register_core_block_types_from_metadata' );
 }
 tests_add_filter( 'init', '_unhook_block_registration', 1000 );
diff --git a/includes/install.php b/includes/install.php
index 8ce307818d..1357b4d5fe 100644
--- a/includes/install.php
+++ b/includes/install.php
@@ -14,6 +14,13 @@ if ( ! defined( 'WP_RUN_CORE_TESTS' ) && in_array( 'run_core_tests', $argv, true
 }
 
 define( 'WP_INSTALLING', true );
+
+/*
+ * Cron tries to make an HTTP request to the site, which always fails,
+ * because tests are run in CLI mode only.
+ */
+define( 'DISABLE_WP_CRON', true );
+
 require_once $config_file_path;
 require_once __DIR__ . '/functions.php';
 
@@ -33,7 +40,7 @@ tests_add_filter( 'wp_die_handler', '_wp_die_handler_filter_exit' );
 require_once ABSPATH . '/wp-settings.php';
 
 require_once ABSPATH . '/wp-admin/includes/upgrade.php';
-require_once ABSPATH . '/wp-includes/wp-db.php';
+require_once ABSPATH . '/wp-includes/class-wpdb.php';
 
 // Override the PHPMailer.
 global $phpmailer;
diff --git a/includes/object-cache.php b/includes/object-cache.php
index c747a7a824..f07460c24f 100644
--- a/includes/object-cache.php
+++ b/includes/object-cache.php
@@ -284,6 +284,17 @@ function wp_cache_flush( $delay = 0 ) {
 	return $wp_object_cache->flush( $delay );
 }
 
+/**
+ * Whether the object cache implementation supports flushing individual cache groups.
+ *
+ * @since 6.1.0
+ *
+ * @return bool True if group flushing is supported, false otherwise.
+ */
+function wp_cache_supports_group_flush() {
+	return false;
+}
+
 /**
  * Retrieves object from cache.
  *
@@ -796,14 +807,14 @@ class WP_Object_Cache {
 	 *
 	 * @var array
 	 */
-	public $global_groups = array( 'users', 'userlogins', 'usermeta', 'site-options', 'site-lookup', 'blog-lookup', 'blog-details', 'rss' );
+	public $global_groups = array();
 
 	/**
 	 * List of groups not saved to Memcached.
 	 *
 	 * @var array
 	 */
-	public $no_mc_groups = array( 'comment', 'counts' );
+	public $no_mc_groups = array();
 
 	/**
 	 * Prefix used for global groups.
diff --git a/includes/testcase-rest-controller.php b/includes/testcase-rest-controller.php
index a0b96545bf..67a7970b66 100644
--- a/includes/testcase-rest-controller.php
+++ b/includes/testcase-rest-controller.php
@@ -45,7 +45,14 @@ abstract class WP_Test_REST_Controller_Testcase extends WP_Test_REST_TestCase {
 		}
 
 		// Make sure path for rest_url has a leading slash for proper resolution.
-		$this->assertTrue( 0 === strpos( $path, '/' ), 'REST API URL should have a leading slash.' );
+		if ( 0 !== strpos( $path, '/' ) ) {
+			$this->fail(
+				sprintf(
+					'REST API URL "%s" should have a leading slash.',
+					$path
+				)
+			);
+		}
 
 		return $url;
 	}
diff --git a/includes/trac.php b/includes/trac.php
index 84617fa661..b8f9b79256 100644
--- a/includes/trac.php
+++ b/includes/trac.php
@@ -9,9 +9,9 @@ class TracTickets {
 	protected static $trac_ticket_cache = array();
 
 	/**
-	 * Checks if track ticket #$ticket_id is resolved
+	 * Checks if Trac ticket #$ticket_id is resolved.
 	 *
-	 * @return bool|null true if the ticket is resolved, false if not resolved, null on error
+	 * @return bool|null True if the ticket is resolved, false if not resolved, null on error.
 	 */
 	public static function isTracTicketClosed( $trac_url, $ticket_id ) { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
 		if ( ! extension_loaded( 'openssl' ) ) {
@@ -22,6 +22,7 @@ class TracTickets {
 			// In case you're running the tests offline, keep track of open tickets.
 			$file    = DIR_TESTDATA . '/.trac-ticket-cache.' . str_replace( array( 'http://', 'https://', '/' ), array( '', '', '-' ), rtrim( $trac_url, '/' ) );
 			$tickets = @file_get_contents( $trac_url . '/query?status=%21closed&format=csv&col=id' );
+
 			// Check if our HTTP request failed.
 			if ( false === $tickets ) {
 				if ( file_exists( $file ) ) {
@@ -37,7 +38,9 @@ class TracTickets {
 				$tickets = trim( $tickets );
 				file_put_contents( $file, $tickets );
 			}
-			$tickets                              = explode( "\r\n", $tickets );
+
+			$tickets = explode( "\r\n", $tickets );
+
 			self::$trac_ticket_cache[ $trac_url ] = $tickets;
 		}
 
diff --git a/includes/unregister-blocks-hooks.php b/includes/unregister-blocks-hooks.php
new file mode 100644
index 0000000000..6cde091330
--- /dev/null
+++ b/includes/unregister-blocks-hooks.php
@@ -0,0 +1,62 @@
+<?php
+
+// This file was autogenerated by tools/release/sync-stable-blocks.js, do not change manually!
+remove_action( 'init', 'register_block_core_archives' );
+remove_action( 'init', 'register_block_core_avatar' );
+remove_action( 'init', 'register_block_core_block' );
+remove_action( 'init', 'register_block_core_calendar' );
+remove_action( 'init', 'register_block_core_categories' );
+remove_action( 'init', 'register_block_core_comment_author_name' );
+remove_action( 'init', 'register_block_core_comment_content' );
+remove_action( 'init', 'register_block_core_comment_date' );
+remove_action( 'init', 'register_block_core_comment_edit_link' );
+remove_action( 'init', 'register_block_core_comment_reply_link' );
+remove_action( 'init', 'register_block_core_comment_template' );
+remove_action( 'init', 'register_block_core_comments_pagination' );
+remove_action( 'init', 'register_block_core_comments_pagination_next' );
+remove_action( 'init', 'register_block_core_comments_pagination_numbers' );
+remove_action( 'init', 'register_block_core_comments_pagination_previous' );
+remove_action( 'init', 'register_block_core_comments_title' );
+remove_action( 'init', 'register_block_core_cover' );
+remove_action( 'init', 'register_block_core_file' );
+remove_action( 'init', 'register_block_core_gallery' );
+remove_action( 'init', 'register_block_core_home_link' );
+remove_action( 'init', 'register_block_core_image' );
+remove_action( 'init', 'register_block_core_latest_comments' );
+remove_action( 'init', 'register_block_core_latest_posts' );
+remove_action( 'init', 'register_block_core_loginout' );
+remove_action( 'init', 'register_block_core_navigation' );
+remove_action( 'init', 'register_block_core_navigation_link' );
+remove_action( 'init', 'register_block_core_navigation_submenu' );
+remove_action( 'init', 'register_block_core_page_list' );
+remove_action( 'init', 'register_block_core_pattern' );
+remove_action( 'init', 'register_block_core_post_author' );
+remove_action( 'init', 'register_block_core_post_author_biography' );
+remove_action( 'init', 'register_block_core_post_comments' );
+remove_action( 'init', 'register_block_core_post_comments_form' );
+remove_action( 'init', 'register_block_core_post_content' );
+remove_action( 'init', 'register_block_core_post_date' );
+remove_action( 'init', 'register_block_core_post_excerpt' );
+remove_action( 'init', 'register_block_core_post_featured_image' );
+remove_action( 'init', 'register_block_core_post_navigation_link' );
+remove_action( 'init', 'register_block_core_post_template' );
+remove_action( 'init', 'register_block_core_post_terms' );
+remove_action( 'init', 'register_block_core_post_title' );
+remove_action( 'init', 'register_block_core_query' );
+remove_action( 'init', 'register_block_core_query_no_results' );
+remove_action( 'init', 'register_block_core_query_pagination' );
+remove_action( 'init', 'register_block_core_query_pagination_next' );
+remove_action( 'init', 'register_block_core_query_pagination_numbers' );
+remove_action( 'init', 'register_block_core_query_pagination_previous' );
+remove_action( 'init', 'register_block_core_query_title' );
+remove_action( 'init', 'register_block_core_read_more' );
+remove_action( 'init', 'register_block_core_rss' );
+remove_action( 'init', 'register_block_core_search' );
+remove_action( 'init', 'register_block_core_shortcode' );
+remove_action( 'init', 'register_block_core_site_logo' );
+remove_action( 'init', 'register_block_core_site_tagline' );
+remove_action( 'init', 'register_block_core_site_title' );
+remove_action( 'init', 'register_block_core_social_link' );
+remove_action( 'init', 'register_block_core_tag_cloud' );
+remove_action( 'init', 'register_block_core_template_part' );
+remove_action( 'init', 'register_block_core_term_description' );
diff --git a/includes/utils.php b/includes/utils.php
index 5673eb99dd..16b331b6a6 100644
--- a/includes/utils.php
+++ b/includes/utils.php
@@ -56,6 +56,8 @@ function strip_ws( $txt ) {
  *
  *     $ma = new MockAction();
  *     add_action( 'foo', array( &$ma, 'action' ) );
+ *
+ * @since UT (3.7.0)
  */
 class MockAction {
 	public $events;
@@ -63,140 +65,221 @@ class MockAction {
 
 	/**
 	 * PHP5 constructor.
+	 *
+	 * @since UT (3.7.0)
 	 */
 	public function __construct( $debug = 0 ) {
 		$this->reset();
 		$this->debug = $debug;
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function reset() {
 		$this->events = array();
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function current_filter() {
+		global $wp_actions;
+
 		if ( is_callable( 'current_filter' ) ) {
 			return current_filter();
 		}
-		global $wp_actions;
+
 		return end( $wp_actions );
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function action( $arg ) {
+		$current_filter = $this->current_filter();
+
 		if ( $this->debug ) {
-			dmp( __FUNCTION__, $this->current_filter() );
+			dmp( __FUNCTION__, $current_filter );
 		}
-		$args           = func_get_args();
+
 		$this->events[] = array(
-			'action' => __FUNCTION__,
-			'tag'    => $this->current_filter(),
-			'args'   => $args,
+			'action'    => __FUNCTION__,
+			'hook_name' => $current_filter,
+			'tag'       => $current_filter, // Back compat.
+			'args'      => func_get_args(),
 		);
+
 		return $arg;
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function action2( $arg ) {
+		$current_filter = $this->current_filter();
+
 		if ( $this->debug ) {
-			dmp( __FUNCTION__, $this->current_filter() );
+			dmp( __FUNCTION__, $current_filter );
 		}
 
-		$args           = func_get_args();
 		$this->events[] = array(
-			'action' => __FUNCTION__,
-			'tag'    => $this->current_filter(),
-			'args'   => $args,
+			'action'    => __FUNCTION__,
+			'hook_name' => $current_filter,
+			'tag'       => $current_filter, // Back compat.
+			'args'      => func_get_args(),
 		);
+
 		return $arg;
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function filter( $arg ) {
+		$current_filter = $this->current_filter();
+
 		if ( $this->debug ) {
-			dmp( __FUNCTION__, $this->current_filter() );
+			dmp( __FUNCTION__, $current_filter );
 		}
 
-		$args           = func_get_args();
 		$this->events[] = array(
-			'filter' => __FUNCTION__,
-			'tag'    => $this->current_filter(),
-			'args'   => $args,
+			'filter'    => __FUNCTION__,
+			'hook_name' => $current_filter,
+			'tag'       => $current_filter, // Back compat.
+			'args'      => func_get_args(),
 		);
+
 		return $arg;
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function filter2( $arg ) {
+		$current_filter = $this->current_filter();
+
 		if ( $this->debug ) {
-			dmp( __FUNCTION__, $this->current_filter() );
+			dmp( __FUNCTION__, $current_filter );
 		}
 
-		$args           = func_get_args();
 		$this->events[] = array(
-			'filter' => __FUNCTION__,
-			'tag'    => $this->current_filter(),
-			'args'   => $args,
+			'filter'    => __FUNCTION__,
+			'hook_name' => $current_filter,
+			'tag'       => $current_filter, // Back compat.
+			'args'      => func_get_args(),
 		);
+
 		return $arg;
 	}
 
+	/**
+	 * @since UT (3.7.0)
+	 */
 	public function filter_append( $arg ) {
+		$current_filter = $this->current_filter();
+
 		if ( $this->debug ) {
-			dmp( __FUNCTION__, $this->current_filter() );
+			dmp( __FUNCTION__, $current_filter );
 		}
 
-		$args           = func_get_args();
 		$this->events[] = array(
-			'filter' => __FUNCTION__,
-			'tag'    => $this->current_filter(),
-			'args'   => $args,
+			'filter'    => __FUNCTION__,
+			'hook_name' => $current_filter,
+			'tag'       => $current_filter, // Back compat.
+			'args'      => func_get_args(),
 		);
+
 		return $arg . '_append';
 	}
 
-	public function filterall( $tag, ...$args ) {
-		// This one doesn't return the result, so it's safe to use with the new 'all' filter.
+	/**
+	 * Does not return the result, so it's safe to use with the 'all' filter.
+	 *
+	 * @since UT (3.7.0)
+	 */
+	public function filterall( $hook_name, ...$args ) {
+		$current_filter = $this->current_filter();
+
 		if ( $this->debug ) {
-			dmp( __FUNCTION__, $this->current_filter() );
+			dmp( __FUNCTION__, $current_filter );
 		}
 
 		$this->events[] = array(
-			'filter' => __FUNCTION__,
-			'tag'    => $tag,
-			'args'   => $args,
+			'filter'    => __FUNCTION__,
+			'hook_name' => $hook_name,
+			'tag'       => $hook_name, // Back compat.
+			'args'      => $args,
 		);
 	}
 
-	// Return a list of all the actions, tags and args.
+	/**
+	 * Returns a list of all the actions, hook names and args.
+	 *
+	 * @since UT (3.7.0)
+	 */
 	public function get_events() {
 		return $this->events;
 	}
 
-	// Return a count of the number of times the action was called since the last reset.
-	public function get_call_count( $tag = '' ) {
-		if ( $tag ) {
+	/**
+	 * Returns a count of the number of times the action was called since the last reset.
+	 *
+	 * @since UT (3.7.0)
+	 */
+	public function get_call_count( $hook_name = '' ) {
+		if ( $hook_name ) {
 			$count = 0;
+
 			foreach ( $this->events as $e ) {
-				if ( $e['action'] === $tag ) {
+				if ( $e['action'] === $hook_name ) {
 					++$count;
 				}
 			}
+
 			return $count;
 		}
+
 		return count( $this->events );
 	}
 
-	// Return an array of the tags that triggered calls to this action.
-	public function get_tags() {
+	/**
+	 * Returns an array of the hook names that triggered calls to this action.
+	 *
+	 * @since 6.1.0
+	 */
+	public function get_hook_names() {
 		$out = array();
+
 		foreach ( $this->events as $e ) {
-			$out[] = $e['tag'];
+			$out[] = $e['hook_name'];
 		}
+
 		return $out;
 	}
 
-	// Return an array of args passed in calls to this action.
+	/**
+	 * Returns an array of the hook names that triggered calls to this action.
+	 *
+	 * @since UT (3.7.0)
+	 * @since 6.1.0 Turned into an alias for ::get_hook_names().
+	 */
+	public function get_tags() {
+		return $this->get_hook_names();
+	}
+
+	/**
+	 * Returns an array of args passed in calls to this action.
+	 *
+	 * @since UT (3.7.0)
+	 */
 	public function get_args() {
 		$out = array();
+
 		foreach ( $this->events as $e ) {
 			$out[] = $e['args'];
 		}
+
 		return $out;
 	}
 }
@@ -378,7 +461,7 @@ function gen_tests_array( $name, $array ) {
 /**
  * Use to create objects by yourself
  */
-class MockClass {}
+class MockClass extends stdClass {}
 
 /**
  * Drops all tables from the WordPress database
diff --git a/tests/actions.php b/tests/actions.php
index 51225f12dd..67222c0819 100644
--- a/tests/actions.php
+++ b/tests/actions.php
@@ -7,20 +7,49 @@
  */
 class Tests_Actions extends WP_UnitTestCase {
 
+	/**
+	 * Flag to keep track whether a certain filter has been applied.
+	 *
+	 * Used in the `test_doing_filter_real()` test method.
+	 *
+	 * @var bool
+	 */
+	private $apply_testing_filter = false;
+
+	/**
+	 * Flag to keep track whether a certain filter has been applied.
+	 *
+	 * Used in the `test_doing_filter_real()` test method.
+	 *
+	 * @var bool
+	 */
+	private $apply_testing_nested_filter = false;
+
+	/**
+	 * Clean up after each test.
+	 */
+	public function tear_down() {
+		// Make sure potentially changed properties are reverted to their default value.
+		$this->apply_testing_filter        = false;
+		$this->apply_testing_nested_filter = false;
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @covers ::do_action
 	 */
 	public function test_simple_action() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( &$a, 'action' ) );
-		do_action( $tag );
+		add_action( $hook_name, array( &$a, 'action' ) );
+		do_action( $hook_name );
 
 		// Only one event occurred for the hook, with empty args.
 		$this->assertSame( 1, $a->get_call_count() );
 		// Only our hook was called.
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 		$argsvar = $a->get_args();
 		$args    = array_pop( $argsvar );
@@ -31,21 +60,21 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::remove_action
 	 */
 	public function test_remove_action() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( &$a, 'action' ) );
-		do_action( $tag );
+		add_action( $hook_name, array( &$a, 'action' ) );
+		do_action( $hook_name );
 
 		// Make sure our hook was called correctly.
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 		// Now remove the action, do it again, and make sure it's not called this time.
-		remove_action( $tag, array( &$a, 'action' ) );
-		do_action( $tag );
+		remove_action( $hook_name, array( &$a, 'action' ) );
+		do_action( $hook_name );
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 	}
 
@@ -53,17 +82,19 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::has_action
 	 */
 	public function test_has_action() {
-		$tag  = __FUNCTION__;
-		$func = __FUNCTION__ . '_func';
+		$hook_name = __FUNCTION__;
+		$callback  = __FUNCTION__ . '_func';
 
-		$this->assertFalse( has_action( $tag, $func ) );
-		$this->assertFalse( has_action( $tag ) );
-		add_action( $tag, $func );
-		$this->assertSame( 10, has_action( $tag, $func ) );
-		$this->assertTrue( has_action( $tag ) );
-		remove_action( $tag, $func );
-		$this->assertFalse( has_action( $tag, $func ) );
-		$this->assertFalse( has_action( $tag ) );
+		$this->assertFalse( has_action( $hook_name, $callback ) );
+		$this->assertFalse( has_action( $hook_name ) );
+
+		add_action( $hook_name, $callback );
+		$this->assertSame( 10, has_action( $hook_name, $callback ) );
+		$this->assertTrue( has_action( $hook_name ) );
+
+		remove_action( $hook_name, $callback );
+		$this->assertFalse( has_action( $hook_name, $callback ) );
+		$this->assertFalse( has_action( $hook_name ) );
 	}
 
 	/**
@@ -72,15 +103,15 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_multiple_actions() {
-		$a1  = new MockAction();
-		$a2  = new MockAction();
-		$tag = __FUNCTION__;
+		$a1        = new MockAction();
+		$a2        = new MockAction();
+		$hook_name = __FUNCTION__;
 
 		// Add both actions to the hook.
-		add_action( $tag, array( &$a1, 'action' ) );
-		add_action( $tag, array( &$a2, 'action' ) );
+		add_action( $hook_name, array( &$a1, 'action' ) );
+		add_action( $hook_name, array( &$a2, 'action' ) );
 
-		do_action( $tag );
+		do_action( $hook_name );
 
 		// Both actions called once each.
 		$this->assertSame( 1, $a1->get_call_count() );
@@ -93,13 +124,13 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_action_args_1() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
 
-		add_action( $tag, array( &$a, 'action' ) );
+		add_action( $hook_name, array( &$a, 'action' ) );
 		// Call the action with a single argument.
-		do_action( $tag, $val );
+		do_action( $hook_name, $val );
 
 		$call_count = $a->get_call_count();
 		$this->assertSame( 1, $call_count );
@@ -113,17 +144,17 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_action_args_2() {
-		$a1   = new MockAction();
-		$a2   = new MockAction();
-		$tag  = __FUNCTION__;
-		$val1 = __FUNCTION__ . '_val1';
-		$val2 = __FUNCTION__ . '_val2';
+		$a1        = new MockAction();
+		$a2        = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val1      = __FUNCTION__ . '_val1';
+		$val2      = __FUNCTION__ . '_val2';
 
 		// $a1 accepts two arguments, $a2 doesn't.
-		add_action( $tag, array( &$a1, 'action' ), 10, 2 );
-		add_action( $tag, array( &$a2, 'action' ) );
+		add_action( $hook_name, array( &$a1, 'action' ), 10, 2 );
+		add_action( $hook_name, array( &$a2, 'action' ) );
 		// Call the action with two arguments.
-		do_action( $tag, $val1, $val2 );
+		do_action( $hook_name, $val1, $val2 );
 
 		$call_count = $a1->get_call_count();
 		// $a1 should be called with both args.
@@ -147,19 +178,19 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_action_args_3() {
-		$a1   = new MockAction();
-		$a2   = new MockAction();
-		$a3   = new MockAction();
-		$tag  = __FUNCTION__;
-		$val1 = __FUNCTION__ . '_val1';
-		$val2 = __FUNCTION__ . '_val2';
+		$a1        = new MockAction();
+		$a2        = new MockAction();
+		$a3        = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val1      = __FUNCTION__ . '_val1';
+		$val2      = __FUNCTION__ . '_val2';
 
 		// $a1 accepts two arguments, $a2 doesn't, $a3 accepts two arguments.
-		add_action( $tag, array( &$a1, 'action' ), 10, 2 );
-		add_action( $tag, array( &$a2, 'action' ) );
-		add_action( $tag, array( &$a3, 'action' ), 10, 2 );
+		add_action( $hook_name, array( &$a1, 'action' ), 10, 2 );
+		add_action( $hook_name, array( &$a2, 'action' ) );
+		add_action( $hook_name, array( &$a3, 'action' ), 10, 2 );
 		// Call the action with two arguments.
-		do_action( $tag, $val1, $val2 );
+		do_action( $hook_name, $val1, $val2 );
 
 		$call_count = $a1->get_call_count();
 		// $a1 should be called with both args.
@@ -186,13 +217,13 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_action_args_with_php4_syntax() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = new stdClass();
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = new stdClass();
 
-		add_action( $tag, array( &$a, 'action' ) );
+		add_action( $hook_name, array( &$a, 'action' ) );
 		// Call the action with PHP 4 notation for passing object by reference.
-		do_action( $tag, array( &$val ) );
+		do_action( $hook_name, array( &$val ) );
 
 		$call_count = $a->get_call_count();
 		$argsvar    = $a->get_args();
@@ -200,12 +231,12 @@ class Tests_Actions extends WP_UnitTestCase {
 	}
 
 	public function test_action_priority() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( &$a, 'action' ), 10 );
-		add_action( $tag, array( &$a, 'action2' ), 9 );
-		do_action( $tag );
+		add_action( $hook_name, array( &$a, 'action' ), 10 );
+		add_action( $hook_name, array( &$a, 'action2' ), 9 );
+		do_action( $hook_name );
 
 		// Two events, one per action.
 		$this->assertSame( 2, $a->get_call_count() );
@@ -213,15 +244,17 @@ class Tests_Actions extends WP_UnitTestCase {
 		$expected = array(
 			// 'action2' is called first because it has priority 9.
 			array(
-				'action' => 'action2',
-				'tag'    => $tag,
-				'args'   => array( '' ),
+				'action'    => 'action2',
+				'hook_name' => $hook_name,
+				'tag'       => $hook_name, // Back compat.
+				'args'      => array( '' ),
 			),
 			// 'action' is called second.
 			array(
-				'action' => 'action',
-				'tag'    => $tag,
-				'args'   => array( '' ),
+				'action'    => 'action',
+				'hook_name' => $hook_name,
+				'tag'       => $hook_name, // Back compat.
+				'args'      => array( '' ),
 			),
 		);
 
@@ -232,23 +265,23 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::did_action
 	 */
 	public function test_did_action() {
-		$tag1 = 'action1';
-		$tag2 = 'action2';
+		$hook_name1 = 'action1';
+		$hook_name2 = 'action2';
 
-		// Do action $tag1 but not $tag2.
-		do_action( $tag1 );
-		$this->assertSame( 1, did_action( $tag1 ) );
-		$this->assertSame( 0, did_action( $tag2 ) );
+		// Do action $hook_name1 but not $hook_name2.
+		do_action( $hook_name1 );
+		$this->assertSame( 1, did_action( $hook_name1 ) );
+		$this->assertSame( 0, did_action( $hook_name2 ) );
 
-		// Do action $tag2 a random number of times.
-		$count = rand( 0, 10 );
+		// Do action $hook_name2 10 times.
+		$count = 10;
 		for ( $i = 0; $i < $count; $i++ ) {
-			do_action( $tag2 );
+			do_action( $hook_name2 );
 		}
 
-		// $tag1's count hasn't changed, $tag2 should be correct.
-		$this->assertSame( 1, did_action( $tag1 ) );
-		$this->assertSame( $count, did_action( $tag2 ) );
+		// $hook_name1's count hasn't changed, $hook_name2 should be correct.
+		$this->assertSame( 1, did_action( $hook_name1 ) );
+		$this->assertSame( $count, did_action( $hook_name2 ) );
 
 	}
 
@@ -256,23 +289,23 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_all_action() {
-		$a    = new MockAction();
-		$tag1 = __FUNCTION__ . '_1';
-		$tag2 = __FUNCTION__ . '_2';
+		$a          = new MockAction();
+		$hook_name1 = __FUNCTION__ . '_1';
+		$hook_name2 = __FUNCTION__ . '_2';
 
 		// Add an 'all' action.
 		add_action( 'all', array( &$a, 'action' ) );
 		$this->assertSame( 10, has_filter( 'all', array( &$a, 'action' ) ) );
 		// Do some actions.
-		do_action( $tag1 );
-		do_action( $tag2 );
-		do_action( $tag1 );
-		do_action( $tag1 );
+		do_action( $hook_name1 );
+		do_action( $hook_name2 );
+		do_action( $hook_name1 );
+		do_action( $hook_name1 );
 
 		// Our action should have been called once for each tag.
 		$this->assertSame( 4, $a->get_call_count() );
 		// Only our hook was called.
-		$this->assertSame( array( $tag1, $tag2, $tag1, $tag1 ), $a->get_tags() );
+		$this->assertSame( array( $hook_name1, $hook_name2, $hook_name1, $hook_name1 ), $a->get_hook_names() );
 
 		remove_action( 'all', array( &$a, 'action' ) );
 		$this->assertFalse( has_filter( 'all', array( &$a, 'action' ) ) );
@@ -283,36 +316,36 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::remove_action
 	 */
 	public function test_remove_all_action() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
 		add_action( 'all', array( &$a, 'action' ) );
 		$this->assertSame( 10, has_filter( 'all', array( &$a, 'action' ) ) );
-		do_action( $tag );
+		do_action( $hook_name );
 
 		// Make sure our hook was called correctly.
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 		// Now remove the action, do it again, and make sure it's not called this time.
 		remove_action( 'all', array( &$a, 'action' ) );
 		$this->assertFalse( has_filter( 'all', array( &$a, 'action' ) ) );
-		do_action( $tag );
+		do_action( $hook_name );
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 	}
 
 	/**
 	 * @covers ::do_action_ref_array
 	 */
 	public function test_action_ref_array() {
-		$obj = new stdClass();
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
+		$obj       = new stdClass();
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( &$a, 'action' ) );
+		add_action( $hook_name, array( &$a, 'action' ) );
 
-		do_action_ref_array( $tag, array( &$obj ) );
+		do_action_ref_array( $hook_name, array( &$obj ) );
 
 		$args = $a->get_args();
 		$this->assertSame( $args[0][0], $obj );
@@ -327,14 +360,13 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_action_keyed_array() {
-		$a = new MockAction();
-
-		$tag = __FUNCTION__;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( &$a, 'action' ) );
+		add_action( $hook_name, array( &$a, 'action' ) );
 
 		$context = array( 'key1' => 'val1' );
-		do_action( $tag, $context );
+		do_action( $hook_name, $context );
 
 		$args = $a->get_args();
 		$this->assertSame( $args[0][0], $context );
@@ -343,11 +375,64 @@ class Tests_Actions extends WP_UnitTestCase {
 			'key2' => 'val2',
 			'key3' => 'val3',
 		);
-		do_action( $tag, $context2 );
+		do_action( $hook_name, $context2 );
 
 		$args = $a->get_args();
 		$this->assertSame( $args[1][0], $context2 );
+	}
 
+	/**
+	 * @ticket 10493
+	 *
+	 * @covers ::add_action
+	 * @covers ::has_action
+	 * @covers ::do_action
+	 */
+	public function test_action_closure() {
+		$hook_name = __FUNCTION__;
+		$closure   = static function( $a, $b ) {
+			$GLOBALS[ $a ] = $b;
+		};
+		add_action( $hook_name, $closure, 10, 2 );
+
+		$this->assertSame( 10, has_action( $hook_name, $closure ) );
+
+		$context = array( 'val1', 'val2' );
+		do_action( $hook_name, $context[0], $context[1] );
+
+		$this->assertSame( $GLOBALS[ $context[0] ], $context[1] );
+
+		$hook_name2 = __FUNCTION__ . '_2';
+		$closure2   = static function() {
+			$GLOBALS['closure_no_args'] = true;
+		};
+		add_action( $hook_name2, $closure2 );
+
+		$this->assertSame( 10, has_action( $hook_name2, $closure2 ) );
+
+		do_action( $hook_name2 );
+
+		$this->assertTrue( $GLOBALS['closure_no_args'] );
+
+		remove_action( $hook_name, $closure );
+		remove_action( $hook_name2, $closure2 );
+	}
+
+	/**
+	 * @ticket 23265
+	 *
+	 * @covers ::add_action
+	 */
+	public function test_action_callback_representations() {
+		$hook_name = __FUNCTION__;
+
+		$this->assertFalse( has_action( $hook_name ) );
+
+		add_action( $hook_name, array( 'Class', 'method' ) );
+
+		$this->assertSame( 10, has_action( $hook_name, array( 'Class', 'method' ) ) );
+
+		$this->assertSame( 10, has_action( $hook_name, 'Class::method' ) );
 	}
 
 	/**
@@ -369,14 +454,14 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::do_action
 	 */
 	public function test_action_recursion() {
-		$tag = __FUNCTION__;
-		$a   = new MockAction();
-		$b   = new MockAction();
+		$hook_name = __FUNCTION__;
+		$a         = new MockAction();
+		$b         = new MockAction();
 
-		add_action( $tag, array( $a, 'action' ), 11, 1 );
-		add_action( $tag, array( $b, 'action' ), 13, 1 );
-		add_action( $tag, array( $this, 'action_that_causes_recursion' ), 12, 1 );
-		do_action( $tag, $tag );
+		add_action( $hook_name, array( $a, 'action' ), 11, 1 );
+		add_action( $hook_name, array( $b, 'action' ), 13, 1 );
+		add_action( $hook_name, array( $this, 'action_that_causes_recursion' ), 12, 1 );
+		do_action( $hook_name, $hook_name );
 
 		$this->assertSame( 2, $a->get_call_count(), 'recursive actions should call all callbacks with earlier priority' );
 		$this->assertSame( 2, $b->get_call_count(), 'recursive actions should call callbacks with later priority' );
@@ -385,11 +470,11 @@ class Tests_Actions extends WP_UnitTestCase {
 	/**
 	 * @covers ::do_action
 	 */
-	public function action_that_causes_recursion( $tag ) {
+	public function action_that_causes_recursion( $hook_name ) {
 		static $recursing = false;
 		if ( ! $recursing ) {
 			$recursing = true;
-			do_action( $tag, $tag );
+			do_action( $hook_name, $hook_name );
 		}
 		$recursing = false;
 	}
@@ -402,19 +487,19 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::add_action
 	 */
 	public function test_action_callback_manipulation_while_running() {
-		$tag = __FUNCTION__;
-		$a   = new MockAction();
-		$b   = new MockAction();
-		$c   = new MockAction();
-		$d   = new MockAction();
-		$e   = new MockAction();
+		$hook_name = __FUNCTION__;
+		$a         = new MockAction();
+		$b         = new MockAction();
+		$c         = new MockAction();
+		$d         = new MockAction();
+		$e         = new MockAction();
 
-		add_action( $tag, array( $a, 'action' ), 11, 2 );
-		add_action( $tag, array( $this, 'action_that_manipulates_a_running_hook' ), 12, 2 );
-		add_action( $tag, array( $b, 'action' ), 12, 2 );
+		add_action( $hook_name, array( $a, 'action' ), 11, 2 );
+		add_action( $hook_name, array( $this, 'action_that_manipulates_a_running_hook' ), 12, 2 );
+		add_action( $hook_name, array( $b, 'action' ), 12, 2 );
 
-		do_action( $tag, $tag, array( $a, $b, $c, $d, $e ) );
-		do_action( $tag, $tag, array( $a, $b, $c, $d, $e ) );
+		do_action( $hook_name, $hook_name, array( $a, $b, $c, $d, $e ) );
+		do_action( $hook_name, $hook_name, array( $a, $b, $c, $d, $e ) );
 
 		$this->assertSame( 2, $a->get_call_count(), 'callbacks should run unless otherwise instructed' );
 		$this->assertSame( 1, $b->get_call_count(), 'callback removed by same priority callback should still get called' );
@@ -423,11 +508,11 @@ class Tests_Actions extends WP_UnitTestCase {
 		$this->assertSame( 1, $e->get_call_count(), 'callback added by later priority callback should not get called' );
 	}
 
-	public function action_that_manipulates_a_running_hook( $tag, $mocks ) {
-		remove_action( $tag, array( $mocks[1], 'action' ), 12, 2 );
-		add_action( $tag, array( $mocks[2], 'action' ), 12, 2 );
-		add_action( $tag, array( $mocks[3], 'action' ), 13, 2 );
-		add_action( $tag, array( $mocks[4], 'action' ), 10, 2 );
+	public function action_that_manipulates_a_running_hook( $hook_name, $mocks ) {
+		remove_action( $hook_name, array( $mocks[1], 'action' ), 12, 2 );
+		add_action( $hook_name, array( $mocks[2], 'action' ), 12, 2 );
+		add_action( $hook_name, array( $mocks[3], 'action' ), 13, 2 );
+		add_action( $hook_name, array( $mocks[4], 'action' ), 10, 2 );
 	}
 
 	/**
@@ -439,12 +524,12 @@ class Tests_Actions extends WP_UnitTestCase {
 	 * @covers ::remove_filter
 	 */
 	public function test_remove_anonymous_callback() {
-		$tag = __FUNCTION__;
-		$a   = new MockAction();
-		add_action( $tag, array( $a, 'action' ), 12, 1 );
-		$this->assertTrue( has_action( $tag ) );
+		$hook_name = __FUNCTION__;
+		$a         = new MockAction();
+		add_action( $hook_name, array( $a, 'action' ), 12, 1 );
+		$this->assertTrue( has_action( $hook_name ) );
 
-		$hook = $GLOBALS['wp_filter'][ $tag ];
+		$hook = $GLOBALS['wp_filter'][ $hook_name ];
 
 		// From http://wordpress.stackexchange.com/a/57088/6445
 		foreach ( $hook as $priority => $filter ) {
@@ -454,7 +539,7 @@ class Tests_Actions extends WP_UnitTestCase {
 					&& 'action' === $function['function'][1]
 				) {
 					remove_filter(
-						$tag,
+						$hook_name,
 						array( $function['function'][0], 'action' ),
 						$priority
 					);
@@ -462,7 +547,7 @@ class Tests_Actions extends WP_UnitTestCase {
 			}
 		}
 
-		$this->assertFalse( has_action( $tag ) );
+		$this->assertFalse( has_action( $hook_name ) );
 	}
 
 
@@ -477,23 +562,24 @@ class Tests_Actions extends WP_UnitTestCase {
 	 */
 	public function test_array_access_of_wp_filter_global() {
 		global $wp_filter;
-		$tag = __FUNCTION__;
 
-		add_action( $tag, '__return_null', 11, 1 );
+		$hook_name = __FUNCTION__;
+
+		add_action( $hook_name, '__return_null', 11, 1 );
 
-		$this->assertArrayHasKey( 11, $wp_filter[ $tag ] );
-		$this->assertArrayHasKey( '__return_null', $wp_filter[ $tag ][11] );
+		$this->assertArrayHasKey( 11, $wp_filter[ $hook_name ] );
+		$this->assertArrayHasKey( '__return_null', $wp_filter[ $hook_name ][11] );
 
-		unset( $wp_filter[ $tag ][11] );
-		$this->assertFalse( has_action( $tag, '__return_null' ) );
+		unset( $wp_filter[ $hook_name ][11] );
+		$this->assertFalse( has_action( $hook_name, '__return_null' ) );
 
-		$wp_filter[ $tag ][11] = array(
+		$wp_filter[ $hook_name ][11] = array(
 			'__return_null' => array(
 				'function'      => '__return_null',
 				'accepted_args' => 1,
 			),
 		);
-		$this->assertSame( 11, has_action( $tag, '__return_null' ) );
+		$this->assertSame( 11, has_action( $hook_name, '__return_null' ) );
 	}
 
 	/**
@@ -505,6 +591,7 @@ class Tests_Actions extends WP_UnitTestCase {
 	 */
 	public function test_current_action() {
 		global $wp_current_filter;
+
 		$wp_current_filter[] = 'first';
 		$wp_current_filter[] = 'second'; // Let's say a second action was invoked.
 
@@ -518,6 +605,7 @@ class Tests_Actions extends WP_UnitTestCase {
 	 */
 	public function test_doing_filter() {
 		global $wp_current_filter;
+
 		$wp_current_filter = array(); // Set to an empty array first.
 
 		$this->assertFalse( doing_filter() );            // No filter is passed in, and no filter is being processed.
@@ -539,6 +627,7 @@ class Tests_Actions extends WP_UnitTestCase {
 	 */
 	public function test_doing_action() {
 		global $wp_current_filter;
+
 		$wp_current_filter = array(); // Set to an empty array first.
 
 		$this->assertFalse( doing_action() );            // No action is passed in, and no filter is being processed.
diff --git a/tests/actions/callbacks.php b/tests/actions/callbacks.php
deleted file mode 100644
index e311044994..0000000000
--- a/tests/actions/callbacks.php
+++ /dev/null
@@ -1,24 +0,0 @@
-<?php
-
-/**
- * @group hooks
- */
-class Tests_Actions_Callbacks extends WP_UnitTestCase {
-
-	/**
-	 * @ticket 23265
-	 *
-	 * @covers ::add_action
-	 */
-	public function test_callback_representations() {
-		$tag = __FUNCTION__;
-
-		$this->assertFalse( has_action( $tag ) );
-
-		add_action( $tag, array( 'Class', 'method' ) );
-
-		$this->assertSame( 10, has_action( $tag, array( 'Class', 'method' ) ) );
-
-		$this->assertSame( 10, has_action( $tag, 'Class::method' ) );
-	}
-}
diff --git a/tests/actions/closures.php b/tests/actions/closures.php
deleted file mode 100644
index b9016e860c..0000000000
--- a/tests/actions/closures.php
+++ /dev/null
@@ -1,46 +0,0 @@
-<?php
-
-/**
- * Test do_action() and related functions
- *
- * @group hooks
- */
-class Tests_Actions_Closures extends WP_UnitTestCase {
-
-	/**
-	 * @ticket 10493
-	 *
-	 * @covers ::add_action
-	 * @covers ::has_action
-	 * @covers ::do_action
-	 */
-	public function test_action_closure() {
-		$tag     = 'test_action_closure';
-		$closure = static function( $a, $b ) {
-			$GLOBALS[ $a ] = $b;
-		};
-		add_action( $tag, $closure, 10, 2 );
-
-		$this->assertSame( 10, has_action( $tag, $closure ) );
-
-		$context = array( 'val1', 'val2' );
-		do_action( $tag, $context[0], $context[1] );
-
-		$this->assertSame( $GLOBALS[ $context[0] ], $context[1] );
-
-		$tag2     = 'test_action_closure_2';
-		$closure2 = static function() {
-			$GLOBALS['closure_no_args'] = true;
-		};
-		add_action( $tag2, $closure2 );
-
-		$this->assertSame( 10, has_action( $tag2, $closure2 ) );
-
-		do_action( $tag2 );
-
-		$this->assertTrue( $GLOBALS['closure_no_args'] );
-
-		remove_action( $tag, $closure );
-		remove_action( $tag2, $closure2 );
-	}
-}
diff --git a/tests/admin/includesFile.php b/tests/admin/includesFile.php
index eb6cc7c826..b598a2d3bd 100644
--- a/tests/admin/includesFile.php
+++ b/tests/admin/includesFile.php
@@ -114,6 +114,35 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 55109
+	 * @dataProvider data_save_to_temp_directory_when_getting_filename_from_content_disposition_header
+	 *
+	 * @covers ::download_url
+	 *
+	 * @param $filter A callback containing a fake Content-Disposition header.
+	 */
+	public function test_save_to_temp_directory_when_getting_filename_from_content_disposition_header( $filter ) {
+		add_filter( 'pre_http_request', array( $this, $filter ), 10, 3 );
+
+		$filename = download_url( 'url_with_content_disposition_header' );
+		$this->assertStringContainsString( get_temp_dir(), $filename );
+		$this->unlink( $filename );
+
+		remove_filter( 'pre_http_request', array( $this, $filter ) );
+	}
+
+	/**
+	 * Data provider for test_save_to_temp_directory_when_getting_filename_from_content_disposition_header.
+	 *
+	 * @return array
+	 */
+	public function data_save_to_temp_directory_when_getting_filename_from_content_disposition_header() {
+		return array(
+			'valid parameters' => array( 'filter_content_disposition_header_with_filename' ),
+		);
+	}
+
 	/**
 	 * Filter callback for data_download_url_should_respect_filename_from_content_disposition_header.
 	 *
@@ -291,6 +320,9 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 	 * @covers ::download_url
 	 */
 	public function test_download_url_no_warning_for_url_without_path() {
+		// Hook a mocked HTTP request response.
+		add_filter( 'pre_http_request', array( $this, 'mock_http_request' ), 10, 3 );
+
 		$result = download_url( 'https://example.com' );
 
 		$this->assertIsString( $result );
@@ -306,6 +338,9 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 	 * @covers ::download_url
 	 */
 	public function test_download_url_no_warning_for_url_without_path_with_signature_verification() {
+		// Hook a mocked HTTP request response.
+		add_filter( 'pre_http_request', array( $this, 'mock_http_request' ), 10, 3 );
+
 		add_filter(
 			'wp_signature_hosts',
 			static function( $urls ) {
@@ -326,4 +361,24 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 		$this->assertWPError( $error );
 		$this->assertSame( 'signature_verification_no_signature', $error->get_error_code() );
 	}
+
+	/**
+	 * Mock the HTTP request response.
+	 *
+	 * @param bool   $false     False.
+	 * @param array  $arguments Request arguments.
+	 * @param string $url       Request URL.
+	 * @return array|bool
+	 */
+	public function mock_http_request( $false, $arguments, $url ) {
+		if ( 'https://example.com' === $url ) {
+			return array(
+				'response' => array(
+					'code' => 200,
+				),
+			);
+		}
+
+		return $false;
+	}
 }
diff --git a/tests/admin/includesPlugin.php b/tests/admin/includesPlugin.php
index 9a3b4e5cd9..0d29b81d02 100644
--- a/tests/admin/includesPlugin.php
+++ b/tests/admin/includesPlugin.php
@@ -22,7 +22,7 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 			'Description' => 'This is not just a plugin, it symbolizes the hope and enthusiasm of an entire generation summed up in two words sung most famously by Louis Armstrong: Hello, Dolly. When activated you will randomly see a lyric from Hello, Dolly in the upper right of your admin screen on every page. <cite>By <a href="http://ma.tt/">Matt Mullenweg</a>.</cite>',
 			'Author'      => '<a href="http://ma.tt/">Matt Mullenweg</a>',
 			'AuthorURI'   => 'http://ma.tt/',
-			'Version'     => '1.5.1',
+			'Version'     => '1.7.2',
 			'TextDomain'  => 'hello-dolly',
 			'DomainPath'  => '',
 		);
@@ -256,8 +256,16 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 			array( 0, 0 ),                     // Insert at the beginning of the menu if 0 is passed.
 			array( -1, 0 ),                    // Negative numbers are treated the same as passing 0.
 			array( -7, 0 ),                    // Negative numbers are treated the same as passing 0.
+			array( '-7', 0 ),                  // Negative numbers are treated the same as passing 0.
 			array( 1, 1 ),                     // Insert as the second item.
+			array( '1', 1 ),                   // Insert as the second item.
+			array( 1.5, 1 ),                   // Insert as the second item.
+			array( '1.5', 1 ),                 // Insert as the second item.
 			array( 3, 3 ),                     // Insert as the 4th item.
+			array( '3', 3 ),                   // Insert as the 4th item.
+			array( '3e0', 3 ),                 // Insert as the 4th item.
+			array( 3.5, 3 ),                   // Insert as the 4th item.
+			array( '3.5', 3 ),                 // Insert as the 4th item.
 			array( $menu_count, $menu_count ), // Numbers equal to the number of items are added at the end.
 			array( 123456, $menu_count ),      // Numbers higher than the number of items are added at the end.
 		);
@@ -296,11 +304,11 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Passing a string as position will fail.
+	 * Passing a string as position will fail in submenu.
 	 *
 	 * @ticket 48599
 	 */
-	public function test_passing_string_as_position_fires_doing_it_wrong() {
+	public function test_passing_string_as_position_fires_doing_it_wrong_submenu() {
 		$this->setExpectedIncorrectUsage( 'add_submenu_page' );
 		global $submenu, $menu;
 
@@ -314,7 +322,7 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 
 		// Setup a menu with some items.
 		add_menu_page( 'Main Menu', 'Main Menu', 'manage_options', 'main_slug', 'main_page_callback' );
-		add_submenu_page( 'main_slug', 'SubMenu 1', 'SubMenu 1', 'manage_options', 'submenu_page_1', 'submenu_callback_1', '2' );
+		add_submenu_page( 'main_slug', 'SubMenu 1', 'SubMenu 1', 'manage_options', 'submenu_page_1', 'submenu_callback_1', 'First' );
 
 		// Clean up the temporary user.
 		wp_set_current_user( $current_user );
@@ -324,6 +332,38 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 		$this->assertSame( 'submenu_page_1', $submenu['main_slug'][1][2] );
 	}
 
+	/**
+	 * Passing a string as position will fail in menu.
+	 *
+	 * @ticket 54798
+	 */
+	public function test_passing_float_as_position_does_not_override_int() {
+		global $submenu, $menu;
+
+		// Reset menus.
+		$submenu      = array();
+		$menu         = array();
+		$current_user = get_current_user_id();
+		$admin_user   = self::factory()->user->create( array( 'role' => 'administrator' ) );
+		wp_set_current_user( $admin_user );
+		set_current_screen( 'dashboard' );
+
+		// Setup a menu with some items.
+		add_menu_page( 'Main Menu 1', 'Main Menu 1', 'manage_options', 'main_slug_1', 'main_page_callback_1', 'icon_url_1', 1 );
+		add_menu_page( 'Main Menu 2', 'Main Menu 2', 'manage_options', 'main_slug_2', 'main_page_callback_2', 'icon_url_2', 2 );
+		add_menu_page( 'Main Menu 1.5', 'Main Menu 1.5', 'manage_options', 'main_slug_15', 'main_page_callback_15', 'icon_url_15', 1.5 );
+
+		// Clean up the temporary user.
+		wp_set_current_user( $current_user );
+		wp_delete_user( $admin_user );
+
+		// Verify the menus were inserted.
+		$this->assertSame( 'main_slug_1', $menu[1][2] );
+		$this->assertSame( 'main_slug_2', $menu[2][2] );
+		// Verify the menu was inserted correctly on passing float as position.
+		$this->assertSame( 'main_slug_15', $menu['1.5'][2] );
+	}
+
 	public function test_is_plugin_active_true() {
 		activate_plugin( 'hello.php' );
 		$test = is_plugin_active( 'hello.php' );
@@ -487,11 +527,12 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 		$p2 = $this->_create_plugin( "<?php\n//Test", 'not-a-dropin.php', WP_CONTENT_DIR );
 
 		$dropins = get_dropins();
-		$this->assertSame( array( 'advanced-cache.php' ), array_keys( $dropins ) );
 
 		unlink( $p1[1] );
 		unlink( $p2[1] );
 
+		$this->assertSame( array( 'advanced-cache.php' ), array_keys( $dropins ) );
+
 		// Clean up.
 		$this->_restore_drop_ins();
 	}
@@ -509,9 +550,11 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 	public function test_is_network_only_plugin() {
 		$p = $this->_create_plugin( "<?php\n/*\nPlugin Name: test\nNetwork: true" );
 
-		$this->assertTrue( is_network_only_plugin( $p[0] ) );
+		$network_only = is_network_only_plugin( $p[0] );
 
 		unlink( $p[1] );
+
+		$this->assertTrue( $network_only );
 	}
 
 	/**
@@ -571,12 +614,14 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 		$uninstallable_plugins[ $plugin[0] ] = true;
 		update_option( 'uninstall_plugins', $uninstallable_plugins );
 
-		$this->assertTrue( is_uninstallable_plugin( $plugin[0] ) );
+		$is_uninstallable = is_uninstallable_plugin( $plugin[0] );
 
 		unset( $uninstallable_plugins[ $plugin[0] ] );
 		update_option( 'uninstall_plugins', $uninstallable_plugins );
 
 		unlink( $plugin[1] );
+
+		$this->assertTrue( $is_uninstallable );
 	}
 
 	/**
@@ -595,14 +640,15 @@ class Tests_Admin_IncludesPlugin extends WP_UnitTestCase {
 	 */
 	private function _create_plugin( $data = "<?php\n/*\nPlugin Name: Test\n*/", $filename = false, $dir_path = false ) {
 		if ( false === $filename ) {
-			$filename = rand_str() . '.php';
+			$filename = __FUNCTION__ . '.php';
 		}
 
 		if ( false === $dir_path ) {
 			$dir_path = WP_PLUGIN_DIR;
 		}
 
-		$full_name = $dir_path . '/' . wp_unique_filename( $dir_path, $filename );
+		$filename  = wp_unique_filename( $dir_path, $filename );
+		$full_name = $dir_path . '/' . $filename;
 
 		$file = fopen( $full_name, 'w' );
 		fwrite( $file, $data );
diff --git a/tests/admin/includesPost.php b/tests/admin/includesPost.php
index 5f3ec7451d..2a41131a92 100644
--- a/tests/admin/includesPost.php
+++ b/tests/admin/includesPost.php
@@ -789,45 +789,13 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 		$this->assertSame( $p, post_exists( $title, $content, $date ) );
 	}
 
-	public function test_use_block_editor_for_post() {
-		$this->assertFalse( use_block_editor_for_post( -1 ) );
-		$bogus_post_id = $this->factory()->post->create(
-			array(
-				'post_type' => 'bogus',
-			)
-		);
-		$this->assertFalse( use_block_editor_for_post( $bogus_post_id ) );
-
-		register_post_type(
-			'restless',
-			array(
-				'show_in_rest' => false,
-			)
-		);
-		$restless_post_id = $this->factory()->post->create(
-			array(
-				'post_type' => 'restless',
-			)
-		);
-		$this->assertFalse( use_block_editor_for_post( $restless_post_id ) );
-
-		$generic_post_id = $this->factory()->post->create();
-
-		add_filter( 'use_block_editor_for_post', '__return_false' );
-		$this->assertFalse( use_block_editor_for_post( $generic_post_id ) );
-		remove_filter( 'use_block_editor_for_post', '__return_false' );
-
-		add_filter( 'use_block_editor_for_post', '__return_true' );
-		$this->assertTrue( use_block_editor_for_post( $restless_post_id ) );
-		remove_filter( 'use_block_editor_for_post', '__return_true' );
-	}
-
 	public function test_get_block_editor_server_block_settings() {
 		$name     = 'core/test';
 		$settings = array(
 			'icon'            => 'text',
 			'category'        => 'common',
 			'render_callback' => 'foo',
+			'ancestor'        => array( 'core/test-ancestor' ),
 		);
 
 		register_block_type( $name, $settings );
@@ -843,9 +811,13 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 				'title'       => '',
 				'description' => '',
 				'icon'        => 'text',
+				'attributes'  => array(
+					'lock' => array( 'type' => 'object' ),
+				),
 				'usesContext' => array(),
 				'category'    => 'common',
 				'styles'      => array(),
+				'ancestor'    => array( 'core/test-ancestor' ),
 				'keywords'    => array(),
 				'variations'  => array(),
 			),
@@ -855,8 +827,10 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 43559
+	 *
+	 * @covers ::add_meta
 	 */
-	public function test_post_add_meta_empty_is_allowed() {
+	public function test_add_meta_allows_empty_values() {
 		$p = self::factory()->post->create();
 
 		$_POST = array(
@@ -1042,4 +1016,42 @@ class Tests_Admin_IncludesPost extends WP_UnitTestCase {
 		$this->assertSame( 0, post_exists( $title, null, null, $post_type, 'draft' ) );
 		$this->assertSame( 0, post_exists( $title, null, null, 'wp_tests', $post_status ) );
 	}
+
+	/**
+	 * Test refreshed nonce for metabox loader.
+	 *
+	 * @return void
+	 */
+	public function test_user_get_refreshed_metabox_nonce() {
+
+		// Create a post by the current user.
+		wp_set_current_user( self::$editor_id );
+
+		$post_data = array(
+			'post_content' => 'Test post content',
+			'post_title'   => 'Test post title',
+			'post_excerpt' => 'Test post excerpt',
+			'post_author'  => self::$editor_id,
+			'post_status'  => 'draft',
+		);
+		$post_id   = wp_insert_post( $post_data );
+
+		// Simulate the $_POST data from the heartbeat.
+		$data = array(
+			'wp-refresh-metabox-loader-nonces' => array(
+				'post_id' => (string) $post_id,
+			),
+			'wp-refresh-post-lock'             => array(
+				'lock'    => '1658203298:1',
+				'post_id' => (string) $post_id,
+			),
+		);
+
+		// Call the function we're testing.
+		$response = wp_refresh_metabox_loader_nonces( array(), $data );
+
+		// Ensure that both nonces were created.
+		$this->assertNotEmpty( $response['wp-refresh-metabox-loader-nonces']['replace']['_wpnonce'] );
+		$this->assertNotEmpty( $response['wp-refresh-metabox-loader-nonces']['replace']['metabox_loader_nonce'] );
+	}
 }
diff --git a/tests/admin/includesScreen.php b/tests/admin/includesScreen.php
index a5750fd5bd..4b4ba86c5c 100644
--- a/tests/admin/includesScreen.php
+++ b/tests/admin/includesScreen.php
@@ -495,7 +495,7 @@ class Tests_Admin_IncludesScreen extends WP_UnitTestCase {
 		$GLOBALS['hook_suffix'] = $hook;
 
 		if ( 'post.php' === $hook ) {
-			$post_id      = $this->factory->post->create(
+			$post_id      = self::factory()->post->create(
 				array(
 					'post_type' => 'type_shows_in_rest',
 				)
diff --git a/tests/admin/includesTemplate.php b/tests/admin/includesTemplate.php
index c5e73d59e3..6b61639c35 100644
--- a/tests/admin/includesTemplate.php
+++ b/tests/admin/includesTemplate.php
@@ -43,6 +43,58 @@ class Tests_Admin_IncludesTemplate extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 49701
+	 *
+	 * @covers ::get_inline_data
+	 */
+	public function test_get_inline_data_contains_term_if_show_ui_is_false_but_show_on_quick_edit_is_true_for_hierarchical_taxonomy() {
+		// Create a post with a term from a hierarchical taxonomy.
+		register_taxonomy(
+			'wptests_tax_1',
+			'post',
+			array(
+				'show_ui'            => false,
+				'show_in_quick_edit' => true,
+				'hierarchical'       => true,
+			)
+		);
+		$term = wp_insert_term( 'Test', 'wptests_tax_1' );
+		$post = self::factory()->post->create_and_get();
+		wp_set_object_terms( $post->ID, $term['term_id'], 'wptests_tax_1' );
+
+		// Test that get_inline_data() has `post_category` div containing the assigned term.
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'editor' ) ) );
+		get_inline_data( $post );
+		$this->expectOutputRegex( '/<div class="post_category" id="wptests_tax_1_' . $post->ID . '">' . $term['term_id'] . '<\/div>/' );
+	}
+
+	/**
+	 * @ticket 49701
+	 *
+	 * @covers ::get_inline_data
+	 */
+	public function test_get_inline_data_contains_term_if_show_ui_is_false_but_show_on_quick_edit_is_true_for_nonhierarchical_taxonomy() {
+		// Create a post with a term from a non-hierarchical taxonomy.
+		register_taxonomy(
+			'wptests_tax_1',
+			'post',
+			array(
+				'show_ui'            => false,
+				'show_in_quick_edit' => true,
+				'hierarchical'       => false,
+			)
+		);
+		$term = wp_insert_term( 'Test', 'wptests_tax_1' );
+		$post = self::factory()->post->create_and_get();
+		wp_set_object_terms( $post->ID, $term['term_id'], 'wptests_tax_1' );
+
+		// Test that get_inline_data() has `tags_input` div containing the assigned term.
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'editor' ) ) );
+		get_inline_data( $post );
+		$this->expectOutputRegex( '/<div class="tags_input" id="wptests_tax_1_' . $post->ID . '">Test<\/div>/' );
+	}
+
 	public function test_add_meta_box() {
 		global $wp_meta_boxes;
 
diff --git a/tests/admin/includesTheme.php b/tests/admin/includesTheme.php
index 8208d3fcfa..9f2fdbc085 100644
--- a/tests/admin/includesTheme.php
+++ b/tests/admin/includesTheme.php
@@ -4,12 +4,25 @@
  */
 class Tests_Admin_IncludesTheme extends WP_UnitTestCase {
 
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	const THEME_ROOT = DIR_TESTDATA . '/themedir1';
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
 	public function set_up() {
 		parent::set_up();
-		$this->theme_root = DIR_TESTDATA . '/themedir1';
 
 		$this->orig_theme_dir            = $GLOBALS['wp_theme_directories'];
-		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', self::THEME_ROOT );
 
 		add_filter( 'theme_root', array( $this, 'filter_theme_root' ) );
 		add_filter( 'stylesheet_root', array( $this, 'filter_theme_root' ) );
@@ -33,7 +46,7 @@ class Tests_Admin_IncludesTheme extends WP_UnitTestCase {
 
 	// Replace the normal theme root directory with our premade test directory.
 	public function filter_theme_root( $dir ) {
-		return $this->theme_root;
+		return self::THEME_ROOT;
 	}
 
 	/**
@@ -217,7 +230,7 @@ class Tests_Admin_IncludesTheme extends WP_UnitTestCase {
 	 * @ticket 28121
 	 */
 	public function test_get_theme_featured_list_api() {
-		wp_set_current_user( $this->factory->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		$featured_list_api = get_theme_feature_list( true );
 		$this->assertNonEmptyMultidimensionalArray( $featured_list_api );
 	}
diff --git a/tests/admin/wpAutomaticUpdater.php b/tests/admin/wpAutomaticUpdater.php
new file mode 100644
index 0000000000..65bb39db2a
--- /dev/null
+++ b/tests/admin/wpAutomaticUpdater.php
@@ -0,0 +1,575 @@
+<?php
+
+/**
+ * @group upgrade
+ *
+ * @covers WP_Automatic_Updater
+ */
+class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
+	/**
+	 * An instance of WP_Automatic_Updater.
+	 *
+	 * @var WP_Automatic_Updater
+	 */
+	private static $updater;
+
+	/**
+	 * WP_Automatic_Updater::send_plugin_theme_email
+	 * made accessible.
+	 *
+	 * @var ReflectionMethod
+	 */
+	private static $send_plugin_theme_email;
+
+	/**
+	 * Sets up shared fixtures.
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		require_once ABSPATH . 'wp-admin/includes/class-wp-automatic-updater.php';
+		self::$updater = new WP_Automatic_Updater();
+
+		self::$send_plugin_theme_email = new ReflectionMethod( self::$updater, 'send_plugin_theme_email' );
+		self::$send_plugin_theme_email->setAccessible( true );
+	}
+
+	public function set_up() {
+		parent::set_up();
+		add_filter( 'pre_wp_mail', '__return_false' );
+	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::send_plugin_theme_email()` appends
+	 * plugin URLs.
+	 *
+	 * @ticket 53049
+	 *
+	 * @covers WP_Automatic_Updater::send_plugin_theme_email
+	 *
+	 * @dataProvider data_send_plugin_theme_email_should_append_plugin_urls
+	 *
+	 * @param string[] $urls       The URL(s) to search for. Must not be empty.
+	 * @param object[] $successful An array of successful plugin update objects.
+	 * @param object[] $failed     An array of failed plugin update objects.
+	 */
+	public function test_send_plugin_theme_email_should_append_plugin_urls( $urls, $successful, $failed ) {
+		add_filter(
+			'wp_mail',
+			function( $args ) use ( $urls ) {
+				foreach ( $urls as $url ) {
+					$this->assertStringContainsString(
+						$url,
+						$args['message'],
+						'The email message should contain ' . $url
+					);
+				}
+			}
+		);
+
+		$has_successful = ! empty( $successful );
+		$has_failed     = ! empty( $failed );
+
+		if ( ! $has_successful && ! $has_failed ) {
+			$this->markTestSkipped( 'This test requires at least one successful or failed plugin update object.' );
+		}
+
+		$type = $has_successful && $has_failed ? 'mixed' : ( ! $has_failed ? 'success' : 'fail' );
+
+		$args = array( $type, array( 'plugin' => $successful ), array( 'plugin' => $failed ) );
+		self::$send_plugin_theme_email->invokeArgs( self::$updater, $args );
+	}
+
+	/**
+	 * Data provider: Provides an array of plugin update objects that should
+	 * have their URLs appended to the email message.
+	 *
+	 * @return array
+	 */
+	public function data_send_plugin_theme_email_should_append_plugin_urls() {
+		return array(
+			'successful updates, the current version and the plugin url'       => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(),
+			),
+			'successful updates, no current version and the plugin url'  => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(),
+			),
+			'failed updates, the current version and the plugin url'       => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'failed updates, no current version and the plugin url'  => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'mixed updates, the current version and a successful plugin url' => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'mixed updates, no current version and a successful plugin url'  => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'mixed updates, the current version and a failed plugin url' => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'mixed updates, no current version and a failed plugin url'  => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'mixed updates, the current version and both successful and failed plugin urls' => array(
+				'urls'       => array(
+					'http://example.org/successful-plugin',
+					'http://example.org/failed-plugin',
+				),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'mixed updates, no current version and both successful and failed plugin urls'  => array(
+				'urls'       => array(
+					'http://example.org/successful-plugin',
+					'http://example.org/failed-plugin',
+				),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+		);
+	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::send_plugin_theme_email()` does not
+	 * append plugin URLs.
+	 *
+	 * @ticket 53049
+	 *
+	 * @covers WP_Automatic_Updater::send_plugin_theme_email
+	 *
+	 * @dataProvider data_send_plugin_theme_email_should_not_append_plugin_urls
+	 *
+	 * @param string[] $urls       The URL(s) to search for. Must not be empty.
+	 * @param object[] $successful An array of successful plugin update objects.
+	 * @param object[] $failed     An array of failed plugin update objects.
+	 */
+	public function test_send_plugin_theme_email_should_not_append_plugin_urls( $urls, $successful, $failed ) {
+		add_filter(
+			'wp_mail',
+			function( $args ) use ( $urls ) {
+				foreach ( $urls as $url ) {
+					$this->assertStringNotContainsString(
+						$url,
+						$args['message'],
+						'The email message should not contain ' . $url
+					);
+				}
+			}
+		);
+
+		$has_successful = ! empty( $successful );
+		$has_failed     = ! empty( $failed );
+
+		if ( ! $has_successful && ! $has_failed ) {
+			$this->markTestSkipped( 'This test requires at least one successful or failed plugin update object.' );
+		}
+
+		$type = $has_successful && $has_failed ? 'mixed' : ( ! $has_failed ? 'success' : 'fail' );
+
+		$args = array( $type, array( 'plugin' => $successful ), array( 'plugin' => $failed ) );
+		self::$send_plugin_theme_email->invokeArgs( self::$updater, $args );
+	}
+
+	/**
+	 * Data provider: Provides an array of plugin update objects that should
+	 * not have their URL appended to the email message.
+	 *
+	 * @return array
+	 */
+	public function data_send_plugin_theme_email_should_not_append_plugin_urls() {
+		return array(
+			'successful updates, the current version, but no plugin url'    => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(),
+			),
+			'successful updates, but no current version or plugin url' => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(),
+			),
+			'failed updates, the current version, but no plugin url'    => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'failed updates, but no current version or plugin url' => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'mixed updates, the current version, but no successful plugin url' => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'mixed updates, but no current version or successful plugin url'  => array(
+				'urls'       => array( 'http://example.org/successful-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => 'http://example.org/failed-plugin',
+						),
+					),
+				),
+			),
+			'mixed updates, the current version, but no failed plugin url' => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'mixed updates, no current version or failed plugin url'  => array(
+				'urls'       => array( 'http://example.org/failed-plugin' ),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => 'http://example.org/successful-plugin',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'mixed updates, the current version and no successful or failed plugin urls' => array(
+				'urls'       => array(
+					'http://example.org/successful-plugin',
+					'http://example.org/failed-plugin',
+				),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '1.0.0',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+			'mixed updates, no current version and no successful or failed plugin urls'  => array(
+				'urls'       => array(
+					'http://example.org/successful-plugin',
+					'http://example.org/failed-plugin',
+				),
+				'successful' => array(
+					(object) array(
+						'name' => 'Successful Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'successful-plugin/successful-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+				'failed'     => array(
+					(object) array(
+						'name' => 'Failed Plugin',
+						'item' => (object) array(
+							'current_version' => '',
+							'new_version'     => '2.0.0',
+							'plugin'          => 'failed-plugin/failed-plugin.php',
+							'url'             => '',
+						),
+					),
+				),
+			),
+		);
+	}
+}
diff --git a/tests/admin/wpCommentsListTable.php b/tests/admin/wpCommentsListTable.php
index b05c5fa5f1..20fcd836e2 100644
--- a/tests/admin/wpCommentsListTable.php
+++ b/tests/admin/wpCommentsListTable.php
@@ -195,4 +195,23 @@ OPTIONS;
 		$this->assertStringContainsString( 'column-date sorted desc', $output, 'Mismatch of CSS classes for the comment date column.' );
 	}
 
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Comments_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		$this->table->prepare_items();
+
+		$expected = array(
+			'all'       => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=all" class="current" aria-current="page">All <span class="count">(<span class="all-count">0</span>)</span></a>',
+			'mine'      => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=mine&#038;user_id=0">Mine <span class="count">(<span class="mine-count">0</span>)</span></a>',
+			'moderated' => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=moderated">Pending <span class="count">(<span class="pending-count">0</span>)</span></a>',
+			'approved'  => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=approved">Approved <span class="count">(<span class="approved-count">0</span>)</span></a>',
+			'spam'      => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=spam">Spam <span class="count">(<span class="spam-count">0</span>)</span></a>',
+			'trash'     => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=trash">Trash <span class="count">(<span class="trash-count">0</span>)</span></a>',
+		);
+		$this->assertSame( $expected, $this->table->get_views() );
+	}
+
 }
diff --git a/tests/admin/wpCommunityEvents.php b/tests/admin/wpCommunityEvents.php
index 631d8fdfeb..6dfd4f044a 100644
--- a/tests/admin/wpCommunityEvents.php
+++ b/tests/admin/wpCommunityEvents.php
@@ -16,10 +16,10 @@
  * @since 4.8.0
  */
 class Tests_Admin_wpCommunityEvents extends WP_UnitTestCase {
+
 	/**
 	 * An instance of the class to test.
 	 *
-	 * @access private
 	 * @since 4.8.0
 	 *
 	 * @var WP_Community_Events
diff --git a/tests/admin/wpListTable.php b/tests/admin/wpListTable.php
new file mode 100644
index 0000000000..c28113d99f
--- /dev/null
+++ b/tests/admin/wpListTable.php
@@ -0,0 +1,347 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_List_Table
+ */
+class Tests_Admin_WpListTable extends WP_UnitTestCase {
+
+	/**
+	 * List table.
+	 *
+	 * @var WP_List_Table $list_table
+	 */
+	protected static $list_table;
+
+	public static function set_up_before_class() {
+		global $hook_suffix;
+
+		parent::set_up_before_class();
+
+		require_once ABSPATH . 'wp-admin/includes/class-wp-list-table.php';
+
+		$hook_suffix      = '_wp_tests';
+		self::$list_table = new WP_List_Table();
+	}
+
+	/**
+	 * Tests that `WP_List_Table::get_column_info()` only adds the primary
+	 * column header when necessary.
+	 *
+	 * @ticket 34564
+	 *
+	 * @dataProvider data_should_only_add_primary_column_when_needed
+	 *
+	 * @covers WP_List_Table::get_column_info
+	 *
+	 * @param string $list_class          The name of the WP_List_Table child class.
+	 * @param array  $headers             A list of column headers.
+	 * @param array  $expected            The expected column headers.
+	 * @param int    $expected_hook_count The expected number of times the hook is called.
+	 */
+	public function test_should_only_add_primary_column_when_needed( $list_class, $headers, $expected, $expected_hook_count ) {
+		$hook = new MockAction();
+		add_filter( 'list_table_primary_column', array( $hook, 'filter' ) );
+
+		/*
+		 * Set a dummy value for the current screen in the admin to prevent
+		 * `_get_list_table()` throwing.
+		 */
+		$GLOBALS['hook_suffix'] = 'my-hook';
+
+		$list_table = _get_list_table( $list_class );
+
+		$column_headers = new ReflectionProperty( $list_table, '_column_headers' );
+		$column_headers->setAccessible( true );
+		$column_headers->setValue( $list_table, $headers );
+
+		$column_info = new ReflectionMethod( $list_table, 'get_column_info' );
+		$column_info->setAccessible( true );
+
+		$this->assertSame( $expected, $column_info->invoke( $list_table ), 'The actual columns did not match the expected columns' );
+		$this->assertSame( $expected_hook_count, $hook->get_call_count(), 'The hook was not called the expected number of times' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_only_add_primary_column_when_needed() {
+		/*
+		 * `WP_Post_Comments_List_Table` overrides `get_column_info()` rather than
+		 * use the default `WP_List_Table::get_column_info()`. Therefore it is
+		 * untested.
+		 */
+		$list_primary_columns = array(
+			'WP_Application_Passwords_List_Table'         => 'name',
+			'WP_Comments_List_Table'                      => 'author',
+			'WP_Links_List_Table'                         => 'name',
+			'WP_Media_List_Table'                         => 'title',
+			'WP_MS_Sites_List_Table'                      => 'blogname',
+			'WP_MS_Themes_List_Table'                     => 'name',
+			'WP_MS_Users_List_Table'                      => 'username',
+			'WP_Plugin_Install_List_Table'                => '',
+			'WP_Plugins_List_Table'                       => 'name',
+			'WP_Posts_List_Table'                         => 'title',
+			'WP_Privacy_Data_Export_Requests_List_Table'  => 'email',
+			'WP_Privacy_Data_Removal_Requests_List_Table' => 'email',
+			'WP_Terms_List_Table'                         => 'name',
+			'WP_Theme_Install_List_Table'                 => '',
+			'WP_Themes_List_Table'                        => '',
+			'WP_Users_List_Table'                         => 'username',
+		);
+
+		$datasets = array();
+
+		foreach ( $list_primary_columns as $list_class => $primary_column ) {
+			$datasets[ $list_class . ' - three columns' ] = array(
+				'list_class'          => $list_class,
+				'headers'             => array( 'First', 'Second', 'Third' ),
+				'expected'            => array( 'First', 'Second', 'Third', $primary_column ),
+				'expected_hook_count' => 1,
+			);
+
+			$datasets[ $list_class . ' - four columns' ] = array(
+				'list_class'          => $list_class,
+				'headers'             => array( 'First', 'Second', 'Third', 'Fourth' ),
+				'expected'            => array( 'First', 'Second', 'Third', 'Fourth' ),
+				'expected_hook_count' => 0,
+			);
+		}
+
+		/*
+		 * `WP_MS_Themes_List_Table` and `WP_Plugins_List_Table` override the
+		 * `get_primary_column_name()` method rather than use the default
+		 * `WP_List_Table::get_primary_column_name()`. Neither include the
+		 * `list_table_primary_column` hook.
+		 */
+		$datasets['WP_MS_Themes_List_Table - three columns']['expected_hook_count'] = 0;
+		$datasets['WP_Plugins_List_Table - three columns']['expected_hook_count']   = 0;
+
+		return $datasets;
+	}
+
+	/**
+	 * Tests the "get_views_links()" method.
+	 *
+	 * @ticket 42066
+	 *
+	 * @covers WP_List_Table::get_views_links
+	 *
+	 * @dataProvider data_get_views_links
+	 *
+	 * @param array $link_data {
+	 *     An array of link data.
+	 *
+	 *     @type string $url     The link URL.
+	 *     @type string $label   The link label.
+	 *     @type bool   $current Optional. Whether this is the currently selected view.
+	 * }
+	 * @param array $expected
+	 */
+	public function test_get_views_links( $link_data, $expected ) {
+		$get_views_links = new ReflectionMethod( self::$list_table, 'get_views_links' );
+		$get_views_links->setAccessible( true );
+
+		$actual = $get_views_links->invokeArgs( self::$list_table, array( $link_data ) );
+
+		$this->assertSameSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_views_links() {
+		return array(
+			'one "current" link'                           => array(
+				'link_data' => array(
+					'all'       => array(
+						'url'     => 'https://example.org/',
+						'label'   => 'All',
+						'current' => true,
+					),
+					'activated' => array(
+						'url'     => add_query_arg( 'status', 'activated', 'https://example.org/' ),
+						'label'   => 'Activated',
+						'current' => false,
+					),
+				),
+				'expected'  => array(
+					'all'       => '<a href="https://example.org/" class="current" aria-current="page">All</a>',
+					'activated' => '<a href="https://example.org/?status=activated">Activated</a>',
+				),
+			),
+			'two "current" links'                          => array(
+				'link_data' => array(
+					'all'       => array(
+						'url'     => 'https://example.org/',
+						'label'   => 'All',
+						'current' => true,
+					),
+					'activated' => array(
+						'url'     => add_query_arg( 'status', 'activated', 'https://example.org/' ),
+						'label'   => 'Activated',
+						'current' => true,
+					),
+				),
+				'expected'  => array(
+					'all'       => '<a href="https://example.org/" class="current" aria-current="page">All</a>',
+					'activated' => '<a href="https://example.org/?status=activated" class="current" aria-current="page">Activated</a>',
+				),
+			),
+			'one "current" link and one without "current" key' => array(
+				'link_data' => array(
+					'all'       => array(
+						'url'     => 'https://example.org/',
+						'label'   => 'All',
+						'current' => true,
+					),
+					'activated' => array(
+						'url'   => add_query_arg( 'status', 'activated', 'https://example.org/' ),
+						'label' => 'Activated',
+					),
+				),
+				'expected'  => array(
+					'all'       => '<a href="https://example.org/" class="current" aria-current="page">All</a>',
+					'activated' => '<a href="https://example.org/?status=activated">Activated</a>',
+				),
+			),
+			'one "current" link with escapable characters' => array(
+				'link_data' => array(
+					'all'       => array(
+						'url'     => 'https://example.org/',
+						'label'   => 'All',
+						'current' => true,
+					),
+					'activated' => array(
+						'url'     => add_query_arg(
+							array(
+								'status' => 'activated',
+								'sort'   => 'desc',
+							),
+							'https://example.org/'
+						),
+						'label'   => 'Activated',
+						'current' => false,
+					),
+				),
+				'expected'  => array(
+					'all'       => '<a href="https://example.org/" class="current" aria-current="page">All</a>',
+					'activated' => '<a href="https://example.org/?status=activated&#038;sort=desc">Activated</a>',
+				),
+			),
+		);
+	}
+
+	/**
+	 * Tests that "get_views_links()" throws a _doing_it_wrong().
+	 *
+	 * @ticket 42066
+	 *
+	 * @covers WP_List_Table::get_views_links
+	 *
+	 * @expectedIncorrectUsage WP_List_Table::get_views_links
+	 *
+	 * @dataProvider data_get_views_links_doing_it_wrong
+	 *
+	 * @param array $link_data {
+	 *     An array of link data.
+	 *
+	 *     @type string $url     The link URL.
+	 *     @type string $label   The link label.
+	 *     @type bool   $current Optional. Whether this is the currently selected view.
+	 * }
+	 */
+	public function test_get_views_links_doing_it_wrong( $link_data ) {
+		$get_views_links = new ReflectionMethod( self::$list_table, 'get_views_links' );
+		$get_views_links->setAccessible( true );
+		$get_views_links->invokeArgs( self::$list_table, array( $link_data ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_views_links_doing_it_wrong() {
+		return array(
+			'non-array $link_data'               => array(
+				'link_data' => 'https://example.org, All, class="current" aria-current="page"',
+			),
+			'a link with no URL'                 => array(
+				'link_data' => array(
+					'all' => array(
+						'label'   => 'All',
+						'current' => true,
+					),
+				),
+			),
+			'a link with an empty URL'           => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => '',
+						'label'   => 'All',
+						'current' => true,
+					),
+				),
+			),
+			'a link with a URL of only spaces'   => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => '  ',
+						'label'   => 'All',
+						'current' => true,
+					),
+				),
+			),
+			'a link with a non-string URL'       => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => array(),
+						'label'   => 'All',
+						'current' => true,
+					),
+				),
+			),
+			'a link with no label'               => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => 'https://example.org/',
+						'current' => true,
+					),
+				),
+			),
+			'a link with an empty label'         => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => 'https://example.org/',
+						'label'   => '',
+						'current' => true,
+					),
+				),
+			),
+			'a link with a label of only spaces' => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => 'https://example.org/',
+						'label'   => '  ',
+						'current' => true,
+					),
+				),
+			),
+			'a link with a non-string label'     => array(
+				'link_data' => array(
+					'all' => array(
+						'url'     => 'https://example.org/',
+						'label'   => array(),
+						'current' => true,
+					),
+				),
+			),
+		);
+	}
+}
diff --git a/tests/admin/wpMediaListTable.php b/tests/admin/wpMediaListTable.php
index 6a2b2d64fa..a130a32506 100644
--- a/tests/admin/wpMediaListTable.php
+++ b/tests/admin/wpMediaListTable.php
@@ -24,6 +24,7 @@ class Tests_Admin_wpMediaListTable extends WP_UnitTestCase {
 	 *
 	 * @ticket 53949
 	 * @covers WP_Media_List_Table::prepare_items
+	 * @group cron
 	 */
 	public function test_prepare_items_without_cron_option_does_not_throw_warning() {
 		global $wp_query;
@@ -42,7 +43,8 @@ class Tests_Admin_wpMediaListTable extends WP_UnitTestCase {
 		delete_option( 'cron' );
 
 		// Verify that the cause of the error is in place.
-		$this->assertFalse( _get_cron_array(), '_get_cron_array() does not return false' );
+		$this->assertIsArray( _get_cron_array(), '_get_cron_array() does not return an array.' );
+		$this->assertEmpty( _get_cron_array(), '_get_cron_array() does not return an empty array.' );
 
 		// If this test does not error out due to the PHP warning, we're good.
 		$mock->prepare_items();
diff --git a/tests/admin/wpPluginInstallListTable.php b/tests/admin/wpPluginInstallListTable.php
new file mode 100644
index 0000000000..406c740a44
--- /dev/null
+++ b/tests/admin/wpPluginInstallListTable.php
@@ -0,0 +1,27 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_Plugin_Install_List_Table
+ */
+class Tests_Admin_wpPluginInstallListTable extends WP_UnitTestCase {
+	/**
+	 * @var WP_Plugin_Install_List_Table
+	 */
+	public $table = false;
+
+	public function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_Plugin_Install_List_Table', array( 'screen' => 'plugin-install' ) );
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Plugin_Install_List_Table::get_views
+	 */
+	public function test_get_views_should_return_no_views_by_default() {
+		$this->assertSame( array(), $this->table->get_views() );
+	}
+}
diff --git a/tests/admin/wpPluginsListTable.php b/tests/admin/wpPluginsListTable.php
new file mode 100644
index 0000000000..f97059d475
--- /dev/null
+++ b/tests/admin/wpPluginsListTable.php
@@ -0,0 +1,59 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_Plugins_List_Table
+ */
+class Tests_Admin_wpPluginsListTable extends WP_UnitTestCase {
+	/**
+	 * @var WP_Plugins_List_Table
+	 */
+	public $table = false;
+
+	public function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_Plugins_List_Table', array( 'screen' => 'plugins' ) );
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Plugins_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		global $totals;
+
+		$totals_backup = $totals;
+		$totals        = array(
+			'all'                  => 45,
+			'active'               => 1,
+			'recently_activated'   => 2,
+			'inactive'             => 3,
+			'mustuse'              => 4,
+			'dropins'              => 5,
+			'paused'               => 6,
+			'upgrade'              => 7,
+			'auto-update-enabled'  => 8,
+			'auto-update-disabled' => 9,
+		);
+
+		$expected = array(
+			'all'                  => '<a href="plugins.php?plugin_status=all" class="current" aria-current="page">All <span class="count">(45)</span></a>',
+			'active'               => '<a href="plugins.php?plugin_status=active">Active <span class="count">(1)</span></a>',
+			'recently_activated'   => '<a href="plugins.php?plugin_status=recently_activated">Recently Active <span class="count">(2)</span></a>',
+			'inactive'             => '<a href="plugins.php?plugin_status=inactive">Inactive <span class="count">(3)</span></a>',
+			'mustuse'              => '<a href="plugins.php?plugin_status=mustuse">Must-Use <span class="count">(4)</span></a>',
+			'dropins'              => '<a href="plugins.php?plugin_status=dropins">Drop-ins <span class="count">(5)</span></a>',
+			'paused'               => '<a href="plugins.php?plugin_status=paused">Paused <span class="count">(6)</span></a>',
+			'upgrade'              => '<a href="plugins.php?plugin_status=upgrade">Update Available <span class="count">(7)</span></a>',
+			'auto-update-enabled'  => '<a href="plugins.php?plugin_status=auto-update-enabled">Auto-updates Enabled <span class="count">(8)</span></a>',
+			'auto-update-disabled' => '<a href="plugins.php?plugin_status=auto-update-disabled">Auto-updates Disabled <span class="count">(9)</span></a>',
+		);
+
+		$actual = $this->table->get_views();
+		$totals = $totals_backup;
+
+		$this->assertSame( $expected, $actual );
+	}
+}
diff --git a/tests/admin/wpPostCommentsListTable.php b/tests/admin/wpPostCommentsListTable.php
new file mode 100644
index 0000000000..98cb834bff
--- /dev/null
+++ b/tests/admin/wpPostCommentsListTable.php
@@ -0,0 +1,39 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_Post_Comments_List_Table
+ */
+class Tests_Admin_wpPostCommentsListTable extends WP_UnitTestCase {
+
+	/**
+	 * @var WP_Post_Comments_List_Table
+	 */
+	protected $table;
+
+	function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_Post_Comments_List_Table', array( 'screen' => 'edit-post-comments' ) );
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Post_Comments_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		$this->table->prepare_items();
+
+		$expected = array(
+			'all'       => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=all" class="current" aria-current="page">All <span class="count">(<span class="all-count">0</span>)</span></a>',
+			'mine'      => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=mine&#038;user_id=0">Mine <span class="count">(<span class="mine-count">0</span>)</span></a>',
+			'moderated' => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=moderated">Pending <span class="count">(<span class="pending-count">0</span>)</span></a>',
+			'approved'  => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=approved">Approved <span class="count">(<span class="approved-count">0</span>)</span></a>',
+			'spam'      => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=spam">Spam <span class="count">(<span class="spam-count">0</span>)</span></a>',
+			'trash'     => '<a href="http://example.org/wp-admin/edit-comments.php?comment_status=trash">Trash <span class="count">(<span class="trash-count">0</span>)</span></a>',
+		);
+		$this->assertSame( $expected, $this->table->get_views() );
+	}
+
+}
diff --git a/tests/admin/wpPostsListTable.php b/tests/admin/wpPostsListTable.php
index 306fddb65d..c209179870 100644
--- a/tests/admin/wpPostsListTable.php
+++ b/tests/admin/wpPostsListTable.php
@@ -319,4 +319,26 @@ class Tests_Admin_wpPostsListTable extends WP_UnitTestCase {
 		$this->assertStringNotContainsString( 'id="delete_all"', $output );
 	}
 
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Posts_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		global $avail_post_stati;
+
+		$avail_post_stati_backup = $avail_post_stati;
+		$avail_post_stati        = get_available_post_statuses();
+
+		$actual           = $this->table->get_views();
+		$avail_post_stati = $avail_post_stati_backup;
+
+		$expected = array(
+			'all'     => '<a href="edit.php?post_type=page">All <span class="count">(38)</span></a>',
+			'publish' => '<a href="edit.php?post_status=publish&#038;post_type=page">Published <span class="count">(38)</span></a>',
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
 }
diff --git a/tests/admin/wpPrivacyRequestsTable.php b/tests/admin/wpPrivacyRequestsTable.php
index 1b7eeca526..7f555c4d25 100644
--- a/tests/admin/wpPrivacyRequestsTable.php
+++ b/tests/admin/wpPrivacyRequestsTable.php
@@ -16,6 +16,25 @@
  * @since 5.1.0
  */
 class Tests_Admin_wpPrivacyRequestsTable extends WP_UnitTestCase {
+
+	/**
+	 * Temporary storage for SQL to allow a filter to access it.
+	 *
+	 * Used in the `test_columns_should_be_sortable()` test method.
+	 *
+	 * @var string
+	 */
+	private $sql;
+
+	/**
+	 * Clean up after each test.
+	 */
+	public function tear_down() {
+		unset( $this->sql );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * Get instance for mocked class.
 	 *
@@ -179,4 +198,17 @@ class Tests_Admin_wpPrivacyRequestsTable extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Privacy_Requests_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		$expected = array(
+			'all' => '<a href="http://example.org/wp-admin/export-personal-data.php" class="current" aria-current="page">All <span class="count">(0)</span></a>',
+		);
+
+		$this->assertSame( $expected, $this->get_mocked_class_instance()->get_views() );
+	}
 }
diff --git a/tests/admin/wpSiteHealth.php b/tests/admin/wpSiteHealth.php
new file mode 100644
index 0000000000..8339821791
--- /dev/null
+++ b/tests/admin/wpSiteHealth.php
@@ -0,0 +1,501 @@
+<?php
+
+/**
+ * @group site-health
+ *
+ * @coversDefaultClass WP_Site_Health
+ */
+class Tests_Admin_wpSiteHealth extends WP_UnitTestCase {
+
+	/**
+	 * An instance of the class to test.
+	 *
+	 * @since 6.1.0
+	 *
+	 * @var WP_Site_Health
+	 */
+	private $instance;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		// Include the `WP_Site_Health` file.
+		require_once ABSPATH . 'wp-admin/includes/class-wp-site-health.php';
+	}
+
+	/**
+	 * Performs setup tasks for every test.
+	 *
+	 * @since 6.1.0
+	 */
+	public function set_up() {
+		parent::set_up();
+
+		$this->instance = new WP_Site_Health();
+	}
+
+	/**
+	 * @ticket 55791
+	 * @covers ::__construct()
+	 */
+	public function test_mysql_recommended_version_matches_readme_html() {
+		// This test is designed to only run on trunk.
+		$this->skipOnAutomatedBranches();
+
+		$reflection          = new ReflectionClass( $this->instance );
+		$reflection_property = $reflection->getProperty( 'mysql_recommended_version' );
+		$reflection_property->setAccessible( true );
+
+		$readme = file_get_contents( ABSPATH . 'readme.html' );
+
+		preg_match( '#Recommendations.*MySQL</a> version <strong>([0-9.]*)#s', $readme, $matches );
+
+		$this->assertSame( $matches[1], $reflection_property->getValue( $this->instance ) );
+	}
+
+	/**
+	 * @ticket 55791
+	 * @covers ::__construct()
+	 */
+	public function test_mariadb_recommended_version_matches_readme_html() {
+		// This test is designed to only run on trunk.
+		$this->skipOnAutomatedBranches();
+
+		$reflection          = new ReflectionClass( $this->instance );
+		$reflection_property = $reflection->getProperty( 'mariadb_recommended_version' );
+		$reflection_property->setAccessible( true );
+
+		$readme = file_get_contents( ABSPATH . 'readme.html' );
+
+		preg_match( '#Recommendations.*MariaDB</a> version <strong>([0-9.]*)#s', $readme, $matches );
+
+		$this->assertSame( $matches[1], $reflection_property->getValue( $this->instance ) );
+	}
+
+	/**
+	 * Ensure Site Health reports correctly cron job reports.
+	 *
+	 * @ticket 47223
+	 */
+	public function test_cron_health_checks_critical() {
+		// Clear the cron array.
+		_set_cron_array( array() );
+
+		$cron_health = $this->instance->get_test_scheduled_events();
+
+		$this->assertSame( 'critical', $cron_health['status'] );
+		$this->assertSame( __( 'It was not possible to check your scheduled events' ), $cron_health['label'] );
+		$this->assertWPError( $this->instance->has_late_cron() );
+		$this->assertWPError( $this->instance->has_missed_cron() );
+	}
+
+	/**
+	 * Ensure Site Health reports correctly cron job reports.
+	 *
+	 * @dataProvider data_cron_health_checks
+	 * @ticket 47223
+	 */
+	public function test_cron_health_checks( $times, $expected_status, $expected_label, $expected_late, $expected_missed ) {
+		/*
+		 * Clear the cron array.
+		 *
+		 * The core jobs may register as late/missed in the test suite as they
+		 * are not run. Clearing the array ensures the site health tests are only
+		 * reported based on the jobs set in the test.
+		 */
+		_set_cron_array( array() );
+
+		$times = (array) $times;
+		foreach ( $times as $job => $time ) {
+			$timestamp = strtotime( $time );
+			wp_schedule_event( $timestamp, 'daily', __FUNCTION__ . "_{$job}" );
+		}
+
+		$cron_health = $this->instance->get_test_scheduled_events();
+
+		$this->assertSame( $expected_status, $cron_health['status'] );
+		$this->assertSame( $expected_label, $cron_health['label'] );
+		$this->assertSame( $expected_late, $this->instance->has_late_cron() );
+		$this->assertSame( $expected_missed, $this->instance->has_missed_cron() );
+	}
+
+	/**
+	 * Data provider for Site Health cron reports.
+	 *
+	 * The test suite runs with `DISABLE_WP_CRON === true` so the
+	 * missed and late tests need to account for the extended periods
+	 * allowed for with this flag enabled.
+	 *
+	 * 1. string|array Times to schedule (run through strtotime())
+	 * 2. string       Expected status
+	 * 3. string       Expected label
+	 * 4. bool         Expected outcome has_late_cron()
+	 * 5. bool         Expected outcome has_missed_cron()
+	 */
+	public function data_cron_health_checks() {
+		return array(
+			array(
+				'+5 minutes',
+				'good',
+				__( 'Scheduled events are running' ),
+				false,
+				false,
+			),
+			array(
+				'-50 minutes',
+				'recommended',
+				__( 'A scheduled event is late' ),
+				true,
+				false,
+			),
+			array(
+				'-500 minutes',
+				'recommended',
+				__( 'A scheduled event has failed' ),
+				false,
+				true,
+			),
+			array(
+				array(
+					'-50 minutes',
+					'-500 minutes',
+				),
+				'recommended',
+				__( 'A scheduled event has failed' ),
+				true,
+				true,
+			),
+		);
+	}
+
+	/**
+	 * @ticket 56041
+	 * @dataProvider data_get_page_cache
+	 * @covers ::get_test_page_cache()
+	 * @covers ::get_page_cache_detail()
+	 * @covers ::get_page_cache_headers()
+	 * @covers ::check_for_page_caching()
+	 */
+	public function test_get_page_cache( $responses, $expected_status, $expected_label, $good_basic_auth = null, $delay_the_response = false ) {
+		$expected_props = array(
+			'badge'  => array(
+				'label' => __( 'Performance' ),
+				'color' => 'blue',
+			),
+			'test'   => 'page_cache',
+			'status' => $expected_status,
+			'label'  => $expected_label,
+		);
+
+		if ( null !== $good_basic_auth ) {
+			$_SERVER['PHP_AUTH_USER'] = 'admin';
+			$_SERVER['PHP_AUTH_PW']   = 'password';
+		}
+
+		$threshold = 10;
+		if ( $delay_the_response ) {
+			add_filter(
+				'site_status_good_response_time_threshold',
+				static function () use ( $threshold ) {
+					return $threshold;
+				}
+			);
+		}
+
+		add_filter(
+			'pre_http_request',
+			function ( $r, $parsed_args ) use ( &$responses, &$is_unauthorized, $good_basic_auth, $delay_the_response, $threshold ) {
+
+				$expected_response = array_shift( $responses );
+
+				if ( $delay_the_response ) {
+					usleep( $threshold * 1000 + 1 );
+				}
+
+				if ( 'unauthorized' === $expected_response ) {
+					$is_unauthorized = true;
+
+					return array(
+						'response' => array(
+							'code'    => 401,
+							'message' => 'Unauthorized',
+						),
+					);
+				}
+
+				if ( null !== $good_basic_auth ) {
+					$this->assertArrayHasKey(
+						'Authorization',
+						$parsed_args['headers']
+					);
+				}
+
+				$this->assertIsArray( $expected_response );
+
+				return array(
+					'headers'  => $expected_response,
+					'response' => array(
+						'code'    => 200,
+						'message' => 'OK',
+					),
+				);
+			},
+			20,
+			2
+		);
+
+		$actual = $this->instance->get_test_page_cache();
+		$this->assertArrayHasKey( 'description', $actual );
+		$this->assertArrayHasKey( 'actions', $actual );
+
+		if ( $is_unauthorized ) {
+			$this->assertStringContainsString( 'Unauthorized', $actual['description'] );
+		} else {
+			$this->assertStringNotContainsString( 'Unauthorized', $actual['description'] );
+		}
+
+		$this->assertSame(
+			$expected_props,
+			wp_array_slice_assoc( $actual, array_keys( $expected_props ) )
+		);
+	}
+
+	/**
+	 * Data provider for test_get_page_cache().
+	 *
+	 * Gets response data for WP_Site_Health::get_test_page_cache().
+	 *
+	 * @ticket 56041
+	 *
+	 * @return array[]
+	 */
+	public function data_get_page_cache() {
+		$recommended_label = 'Page cache is not detected but the server response time is OK';
+		$good_label        = 'Page cache is detected and the server response time is good';
+		$critical_label    = 'Page cache is not detected and the server response time is slow';
+		$error_label       = 'Unable to detect the presence of page cache';
+
+		return array(
+			'basic-auth-fail'                        => array(
+				'responses'       => array(
+					'unauthorized',
+				),
+				'expected_status' => 'recommended',
+				'expected_label'  => $error_label,
+				'good_basic_auth' => false,
+			),
+			'no-cache-control'                       => array(
+				'responses'          => array_fill( 0, 3, array() ),
+				'expected_status'    => 'critical',
+				'expected_label'     => $critical_label,
+				'good_basic_auth'    => null,
+				'delay_the_response' => true,
+			),
+			'no-cache'                               => array(
+				'responses'       => array_fill( 0, 3, array( 'cache-control' => 'no-cache' ) ),
+				'expected_status' => 'recommended',
+				'expected_label'  => $recommended_label,
+			),
+			'no-cache-arrays'                        => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array(
+						'cache-control' => array(
+							'no-cache',
+							'no-store',
+						),
+					)
+				),
+				'expected_status' => 'recommended',
+				'expected_label'  => $recommended_label,
+			),
+			'no-cache-with-delayed-response'         => array(
+				'responses'          => array_fill( 0, 3, array( 'cache-control' => 'no-cache' ) ),
+				'expected_status'    => 'critical',
+				'expected_label'     => $critical_label,
+				'good_basic_auth'    => null,
+				'delay_the_response' => true,
+			),
+			'age'                                    => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'age' => '1345' )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+			'cache-control-max-age'                  => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'cache-control' => 'public; max-age=600' )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+			'etag'                                   => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'etag' => '"1234567890"' )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+			'cache-control-max-age-after-2-requests' => array(
+				'responses'       => array(
+					array(),
+					array(),
+					array( 'cache-control' => 'public; max-age=600' ),
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+			'cache-control-with-future-expires'      => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'expires' => gmdate( 'r', time() + HOUR_IN_SECONDS ) )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+			'cache-control-with-past-expires'        => array(
+				'responses'          => array_fill(
+					0,
+					3,
+					array( 'expires' => gmdate( 'r', time() - HOUR_IN_SECONDS ) )
+				),
+				'expected_status'    => 'critical',
+				'expected_label'     => $critical_label,
+				'good_basic_auth'    => null,
+				'delay_the_response' => true,
+			),
+			'cache-control-with-basic-auth'          => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'cache-control' => 'public; max-age=600' )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+				'good_basic_auth' => true,
+			),
+			'x-cache-enabled'                        => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'x-cache-enabled' => 'true' )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+			'x-cache-enabled-with-delay'             => array(
+				'responses'          => array_fill(
+					0,
+					3,
+					array( 'x-cache-enabled' => 'false' )
+				),
+				'expected_status'    => 'critical',
+				'expected_label'     => $critical_label,
+				'good_basic_auth'    => null,
+				'delay_the_response' => true,
+			),
+			'x-cache-disabled'                       => array(
+				'responses'       => array_fill(
+					0,
+					3,
+					array( 'x-cache-disabled' => 'off' )
+				),
+				'expected_status' => 'good',
+				'expected_label'  => $good_label,
+			),
+		);
+	}
+
+	/**
+	 * @group ms-excluded
+	 * @ticket 56040
+	 */
+	public function test_object_cache_default_thresholds_non_multisite() {
+		// Set thresholds so high they should never be exceeded.
+		add_filter(
+			'site_status_persistent_object_cache_thresholds',
+			function() {
+				return array(
+					'alloptions_count' => PHP_INT_MAX,
+					'alloptions_bytes' => PHP_INT_MAX,
+					'comments_count'   => PHP_INT_MAX,
+					'options_count'    => PHP_INT_MAX,
+					'posts_count'      => PHP_INT_MAX,
+					'terms_count'      => PHP_INT_MAX,
+					'users_count'      => PHP_INT_MAX,
+				);
+			}
+		);
+
+		$this->assertFalse(
+			$this->instance->should_suggest_persistent_object_cache()
+		);
+	}
+
+
+	/**
+	 * @group ms-required
+	 * @ticket 56040
+	 */
+	public function test_object_cache_default_thresholds_on_multisite() {
+		$this->assertTrue(
+			$this->instance->should_suggest_persistent_object_cache()
+		);
+	}
+
+	/**
+	 * @ticket 56040
+	 */
+	public function test_object_cache_thresholds_check_can_be_bypassed() {
+		add_filter( 'site_status_should_suggest_persistent_object_cache', '__return_true' );
+		$this->assertTrue(
+			$this->instance->should_suggest_persistent_object_cache()
+		);
+
+		add_filter( 'site_status_should_suggest_persistent_object_cache', '__return_false', 11 );
+		$this->assertFalse(
+			$this->instance->should_suggest_persistent_object_cache()
+		);
+	}
+
+	/**
+	 * @dataProvider data_object_cache_thresholds
+	 * @ticket 56040
+	 */
+	public function test_object_cache_thresholds( $threshold, $count ) {
+		add_filter(
+			'site_status_persistent_object_cache_thresholds',
+			function ( $thresholds ) use ( $threshold, $count ) {
+				return array_merge( $thresholds, array( $threshold => $count ) );
+			}
+		);
+
+		$this->assertTrue(
+			$this->instance->should_suggest_persistent_object_cache()
+		);
+	}
+
+	/**
+	 * Data provider for test_object_cache_thresholds().
+	 *
+	 * @ticket 56040
+	 */
+	public function data_object_cache_thresholds() {
+		return array(
+			array( 'comments_count', 0 ),
+			array( 'posts_count', 0 ),
+			array( 'terms_count', 1 ),
+			array( 'options_count', 100 ),
+			array( 'users_count', 0 ),
+			array( 'alloptions_count', 100 ),
+			array( 'alloptions_bytes', 1000 ),
+		);
+	}
+}
diff --git a/tests/admin/wpThemeInstallListTable.php b/tests/admin/wpThemeInstallListTable.php
new file mode 100644
index 0000000000..2c1c157c0f
--- /dev/null
+++ b/tests/admin/wpThemeInstallListTable.php
@@ -0,0 +1,27 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_Theme_Install_List_Table
+ */
+class Tests_Admin_wpThemeInstallListTable extends WP_UnitTestCase {
+	/**
+	 * @var WP_Theme_Install_List_Table
+	 */
+	public $table = false;
+
+	public function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_Theme_Install_List_Table', array( 'screen' => 'theme-install' ) );
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Theme_Install_List_Table::get_views
+	 */
+	public function test_get_views_should_return_no_views_by_default() {
+		$this->assertSame( array(), $this->table->get_views() );
+	}
+}
diff --git a/tests/admin/wpUsersListTable.php b/tests/admin/wpUsersListTable.php
new file mode 100644
index 0000000000..bdf765fbfe
--- /dev/null
+++ b/tests/admin/wpUsersListTable.php
@@ -0,0 +1,32 @@
+<?php
+
+/**
+ * @group admin
+ *
+ * @covers WP_Users_List_Table
+ */
+class Tests_Admin_wpUsersListTable extends WP_UnitTestCase {
+	/**
+	 * @var WP_Users_List_Table
+	 */
+	public $table = false;
+
+	public function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_Users_List_Table', array( 'screen' => 'users' ) );
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_Users_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		$expected = array(
+			'all'           => '<a href="users.php" class="current" aria-current="page">All <span class="count">(1)</span></a>',
+			'administrator' => '<a href="users.php?role=administrator">Administrator <span class="count">(1)</span></a>',
+		);
+
+		$this->assertSame( $expected, $this->table->get_views() );
+	}
+}
diff --git a/tests/adminbar.php b/tests/adminbar.php
index 24ace35da4..228063e911 100644
--- a/tests/adminbar.php
+++ b/tests/adminbar.php
@@ -656,7 +656,7 @@ class Tests_AdminBar extends WP_UnitTestCase {
 		$this->go_to( home_url( "/?customize_changeset_uuid=$uuid" ) );
 		wp_set_current_user( self::$admin_id );
 
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type'   => 'customize_changeset',
 				'post_status' => 'auto-draft',
diff --git a/tests/ajax/AddMeta.php b/tests/ajax/AddMeta.php
index 12ec710a0d..e34adc9c1f 100644
--- a/tests/ajax/AddMeta.php
+++ b/tests/ajax/AddMeta.php
@@ -13,15 +13,18 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
 class Tests_Ajax_AddMeta extends WP_Ajax_UnitTestCase {
 	/**
 	 * @ticket 43559
+	 *
+	 * @covers ::wp_ajax_add_meta
+	 * @covers ::add_post_meta
 	 */
-	public function test_post_add_meta_empty_is_allowed_ajax() {
-		$p = self::factory()->post->create();
+	public function test_wp_ajax_add_meta_allows_empty_values_on_adding() {
+		$post = self::factory()->post->create();
 
 		// Become an administrator.
 		$this->_setRole( 'administrator' );
 
 		$_POST = array(
-			'post_id'              => $p,
+			'post_id'              => $post,
 			'metakeyinput'         => 'testkey',
 			'metavalue'            => '',
 			'_ajax_nonce-add-meta' => wp_create_nonce( 'add-meta' ),
@@ -34,25 +37,28 @@ class Tests_Ajax_AddMeta extends WP_Ajax_UnitTestCase {
 			unset( $e );
 		}
 
-		$this->assertSame( '', get_post_meta( $p, 'testkey', true ) );
+		$this->assertSame( '', get_post_meta( $post, 'testkey', true ) );
 	}
 
 	/**
 	 * @ticket 43559
+	 *
+	 * @covers ::wp_ajax_add_meta
+	 * @covers ::update_metadata_by_mid
 	 */
-	public function test_post_update_meta_empty_is_allowed_ajax() {
-		$p = self::factory()->post->create();
+	public function test_wp_ajax_add_meta_allows_empty_values_on_updating() {
+		$post = self::factory()->post->create();
 
-		$m = add_post_meta( $p, 'testkey', 'hello' );
+		$meta_id = add_post_meta( $post, 'testkey', 'hello' );
 
 		// Become an administrator.
 		$this->_setRole( 'administrator' );
 
 		$_POST = array(
 			'_ajax_nonce-add-meta' => wp_create_nonce( 'add-meta' ),
-			'post_id'              => $p,
+			'post_id'              => $post,
 			'meta'                 => array(
-				$m => array(
+				$meta_id => array(
 					'key'   => 'testkey',
 					'value' => '',
 				),
@@ -66,6 +72,6 @@ class Tests_Ajax_AddMeta extends WP_Ajax_UnitTestCase {
 			unset( $e );
 		}
 
-		$this->assertSame( '', get_post_meta( $p, 'testkey', true ) );
+		$this->assertSame( '', get_post_meta( $post, 'testkey', true ) );
 	}
 }
diff --git a/tests/ajax/AddTag.php b/tests/ajax/AddTag.php
index 48b5fc5f24..cf10110d91 100755
--- a/tests/ajax/AddTag.php
+++ b/tests/ajax/AddTag.php
@@ -17,6 +17,9 @@ class Tests_Ajax_AddTag extends WP_Ajax_UnitTestCase {
 	 *
 	 * @ticket 42937
 	 *
+	 * @covers ::wp_ajax_add_tag
+	 * @covers ::wp_insert_term
+	 *
 	 * @param array                 $post_data Data to populate $_POST.
 	 * @param string                $expected  Expected response.
 	 * @param array|string|callable $callback  Optional. Callback to register to 'term_updated_messages'
@@ -38,7 +41,10 @@ class Tests_Ajax_AddTag extends WP_Ajax_UnitTestCase {
 			unset( $e );
 		}
 
+		// The response message is in the `data` property in WP 5.9.
 		$this->assertSame( $expected, (string) $this->get_xml_response_taxonomy()->response_data );
+		// The response message is in the `supplemental->notice` property in WP 6.0+.
+		$this->assertSame( $expected, (string) $this->get_xml_response_taxonomy()->supplemental->notice );
 	}
 
 	/**
@@ -87,6 +93,8 @@ class Tests_Ajax_AddTag extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * @ticket 42937
+	 *
+	 * @covers ::wp_ajax_add_tag
 	 */
 	public function test_adding_category_without_capability_should_error() {
 		$this->_setRole( 'subscriber' );
@@ -105,6 +113,9 @@ class Tests_Ajax_AddTag extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * @ticket 42937
+	 *
+	 * @covers ::wp_ajax_add_tag
+	 * @covers ::wp_insert_term
 	 */
 	public function test_adding_existing_category_should_error() {
 		$this->_setRole( 'administrator' );
diff --git a/tests/ajax/Attachments.php b/tests/ajax/Attachments.php
index 657213d278..91d6943c99 100644
--- a/tests/ajax/Attachments.php
+++ b/tests/ajax/Attachments.php
@@ -12,19 +12,13 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
 class Tests_Ajax_Attachments extends WP_Ajax_UnitTestCase {
 	/**
 	 * @ticket 36578
+	 *
+	 * @covers ::wp_ajax_send_attachment_to_editor
+	 * @covers ::get_image_send_to_editor
 	 */
 	public function test_wp_ajax_send_attachment_to_editor_should_return_an_image() {
 		// Become an administrator.
-		$post    = $_POST;
-		$user_id = self::factory()->user->create(
-			array(
-				'role'       => 'administrator',
-				'user_login' => 'user_36578_administrator',
-				'user_email' => 'user_36578_administrator@example.com',
-			)
-		);
-		wp_set_current_user( $user_id );
-		$_POST = array_merge( $_POST, $post );
+		$this->_setRole( 'administrator' );
 
 		$filename = DIR_TESTDATA . '/images/canola.jpg';
 		$contents = file_get_contents( $filename );
@@ -64,19 +58,14 @@ class Tests_Ajax_Attachments extends WP_Ajax_UnitTestCase {
 	/**
 	 * @ticket 36578
 	 * @group ms-excluded
+	 *
+	 * @covers ::wp_ajax_send_attachment_to_editor
 	 */
 	public function test_wp_ajax_send_attachment_to_editor_should_return_a_link() {
+		$this->skipWithMultisite();
+
 		// Become an administrator.
-		$post    = $_POST;
-		$user_id = self::factory()->user->create(
-			array(
-				'role'       => 'administrator',
-				'user_login' => 'user_36578_administrator',
-				'user_email' => 'user_36578_administrator@example.com',
-			)
-		);
-		wp_set_current_user( $user_id );
-		$_POST = array_merge( $_POST, $post );
+		$this->_setRole( 'administrator' );
 
 		$filename = DIR_TESTDATA . '/formatting/entities.txt';
 		$contents = file_get_contents( $filename );
diff --git a/tests/ajax/Autosave.php b/tests/ajax/Autosave.php
index 4966f392dc..a3c57070ef 100644
--- a/tests/ajax/Autosave.php
+++ b/tests/ajax/Autosave.php
@@ -43,6 +43,8 @@ class Tests_Ajax_Autosave extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Tests autosaving a post.
+	 *
+	 * @covers ::wp_ajax_heartbeat
 	 */
 	public function test_autosave_post() {
 		// The original post_author.
@@ -84,6 +86,8 @@ class Tests_Ajax_Autosave extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Tests autosaving a locked post.
+	 *
+	 * @covers ::wp_ajax_heartbeat
 	 */
 	public function test_autosave_locked_post() {
 		// Lock the post to another user.
@@ -135,6 +139,8 @@ class Tests_Ajax_Autosave extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Tests with an invalid nonce.
+	 *
+	 * @covers ::wp_ajax_heartbeat
 	 */
 	public function test_with_invalid_nonce() {
 
diff --git a/tests/ajax/Compression.php b/tests/ajax/Compression.php
index e900b85375..9c4b369ebb 100644
--- a/tests/ajax/Compression.php
+++ b/tests/ajax/Compression.php
@@ -17,6 +17,8 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Test as a logged out user
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_logged_out() {
 		$this->logout();
@@ -32,6 +34,8 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Fetch the test text
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_text() {
 
@@ -56,6 +60,8 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 	 * Fetch the test text (gzdeflate)
 	 *
 	 * @requires function gzdeflate
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_gzdeflate() {
 
@@ -81,6 +87,8 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 	 * Fetch the test text (gzencode)
 	 *
 	 * @requires function gzencode
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_gzencode() {
 
@@ -104,6 +112,8 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Fetch the test text (unknown encoding)
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_unknown_encoding() {
 
@@ -122,6 +132,8 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Set the 'can_compress_scripts' site option to true
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_set_yes() {
 
@@ -142,7 +154,7 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 		}
 
 		// Check the site option is not changed due to lack of nonce.
-		$this->assertSame( 0, get_site_option( 'can_compress_scripts' ) );
+		$this->assertSame( 0, (int) get_site_option( 'can_compress_scripts' ) );
 
 		// Add a nonce.
 		$_GET['_ajax_nonce'] = wp_create_nonce( 'update_can_compress_scripts' );
@@ -155,11 +167,13 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 		}
 
 		// Check the site option is changed.
-		$this->assertSame( 1, get_site_option( 'can_compress_scripts' ) );
+		$this->assertSame( 1, (int) get_site_option( 'can_compress_scripts' ) );
 	}
 
 	/**
 	 * Set the 'can_compress_scripts' site option to false
+	 *
+	 * @covers ::wp_ajax_wp_compression_test
 	 */
 	public function test_set_no() {
 
@@ -180,7 +194,7 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 		}
 
 		// Check the site option is not changed due to lack of nonce.
-		$this->assertSame( 1, get_site_option( 'can_compress_scripts' ) );
+		$this->assertSame( 1, (int) get_site_option( 'can_compress_scripts' ) );
 
 		// Add a nonce.
 		$_GET['_ajax_nonce'] = wp_create_nonce( 'update_can_compress_scripts' );
@@ -193,7 +207,7 @@ class Tests_Ajax_CompressionTest extends WP_Ajax_UnitTestCase {
 		}
 
 		// Check the site option is changed.
-		$this->assertSame( 0, get_site_option( 'can_compress_scripts' ) );
+		$this->assertSame( 0, (int) get_site_option( 'can_compress_scripts' ) );
 	}
 
 	/**
diff --git a/tests/ajax/CustomizeManager.php b/tests/ajax/CustomizeManager.php
index 16a029c4f4..6116aea2c4 100644
--- a/tests/ajax/CustomizeManager.php
+++ b/tests/ajax/CustomizeManager.php
@@ -103,6 +103,7 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 	 * Test WP_Customize_Manager::save().
 	 *
 	 * @ticket 30937
+	 *
 	 * @covers WP_Customize_Manager::save
 	 */
 	public function test_save_failures() {
@@ -270,6 +271,7 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 	 * Test WP_Customize_Manager::save().
 	 *
 	 * @ticket 30937
+	 *
 	 * @covers WP_Customize_Manager::save
 	 */
 	public function test_save_success_publish_create() {
@@ -299,12 +301,13 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 	 * Test WP_Customize_Manager::save().
 	 *
 	 * @ticket 30937
+	 *
 	 * @covers WP_Customize_Manager::save
 	 */
 	public function test_save_success_publish_edit() {
 		$uuid = wp_generate_uuid4();
 
-		$post_id      = $this->factory()->post->create(
+		$post_id      = self::factory()->post->create(
 			array(
 				'post_name'    => $uuid,
 				'post_title'   => 'Original',
@@ -338,11 +341,12 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 	 * Test WP_Customize_Manager::save().
 	 *
 	 * @ticket 38943
+	 *
 	 * @covers WP_Customize_Manager::save
 	 */
 	public function test_success_save_post_date() {
 		$uuid         = wp_generate_uuid4();
-		$post_id      = $this->factory()->post->create(
+		$post_id      = self::factory()->post->create(
 			array(
 				'post_name'    => $uuid,
 				'post_title'   => 'Original',
@@ -436,12 +440,13 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 	 * Test WP_Customize_Manager::save().
 	 *
 	 * @ticket 39896
+	 *
 	 * @covers WP_Customize_Manager::save
 	 */
 	public function test_save_autosave() {
 		$uuid = wp_generate_uuid4();
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_name'    => $uuid,
 				'post_type'    => 'customize_changeset',
@@ -482,6 +487,7 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 	 * Test request for trashing a changeset.
 	 *
 	 * @ticket 39896
+	 *
 	 * @covers WP_Customize_Manager::handle_changeset_trash_request
 	 */
 	public function test_handle_changeset_trash_request() {
@@ -608,12 +614,12 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertSame( 'no_auto_draft_to_delete', $this->_last_response_parsed['data'] );
 
-		$other_user_id = $this->factory()->user->create();
+		$other_user_id = self::factory()->user->create();
 
 		// Create auto-drafts.
 		$user_auto_draft_ids = array();
 		for ( $i = 0; $i < 3; $i++ ) {
-			$user_auto_draft_ids[] = $this->factory()->post->create(
+			$user_auto_draft_ids[] = self::factory()->post->create(
 				array(
 					'post_name'    => wp_generate_uuid4(),
 					'post_type'    => 'customize_changeset',
@@ -625,7 +631,7 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 		}
 		$other_user_auto_draft_ids = array();
 		for ( $i = 0; $i < 3; $i++ ) {
-			$other_user_auto_draft_ids[] = $this->factory()->post->create(
+			$other_user_auto_draft_ids[] = self::factory()->post->create(
 				array(
 					'post_name'    => wp_generate_uuid4(),
 					'post_type'    => 'customize_changeset',
@@ -714,4 +720,49 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertSame( 'no_autosave_revision_to_delete', $this->_last_response_parsed['data'] );
 	}
+
+	/**
+	 * Test request for retrieving installed themes.
+	 *
+	 * @ticket 54549
+	 * @covers WP_Customize_Manager::handle_load_themes_request
+	 */
+	public function test_wp_ajax_customize_load_themes_action() {
+		$arguments = array(
+			'changeset_uuid'     => false,
+			'settings_previewed' => true,
+			'branching'          => false,
+		);
+		new WP_Customize_Manager( $arguments );
+		wp_set_current_user( self::$admin_user_id );
+		$nonce                 = wp_create_nonce( 'switch_themes' );
+		$_POST['nonce']        = $nonce;
+		$_GET['nonce']         = $nonce;
+		$_REQUEST['nonce']     = $nonce;
+		$_POST['theme_action'] = 'installed';
+		$this->make_ajax_call( 'customize_load_themes' );
+		$response = $this->_last_response_parsed;
+		$this->assertIsArray( $response, 'Response is not an array' );
+
+		$this->assertArrayHasKey( 'success', $response, 'Response must have a "success" key' );
+		$this->assertTrue( $response['success'], 'Response was not "success"' );
+
+		$this->assertArrayHasKey( 'data', $response, 'Response must have a "data" key' );
+		$this->assertIsArray( $response['data'], 'The response "data" is not an array' );
+		$this->assertArrayHasKey( 'themes', $response['data'], 'The response data must have a "themes" key' );
+		$this->assertIsArray( $response['data']['themes'], 'Themes data is not an array' );
+		$this->assertNotEmpty( $response['data']['themes'], 'Themes data must not be empty' );
+
+		foreach ( $response['data']['themes'] as $theme ) {
+			$this->assertIsArray( $theme, 'Theme is not an array' );
+			$this->assertNotEmpty( $theme, 'Theme data must not be empty' );
+			$this->assertArrayHasKey( 'id', $theme, 'Theme data must have an "id" key' );
+			$this->assertNotEmpty( $theme['id'], 'Theme id cannot be empty' );
+
+			$this->assertArrayHasKey( 'name', $theme, 'Theme data must have a "name" key' );
+			$this->assertNotEmpty( $theme['name'], 'Theme name cannot be empty' );
+
+			$this->assertArrayHasKey( 'blockTheme', $theme, 'Themes data must include information about blocks support' );
+		}
+	}
 }
diff --git a/tests/ajax/CustomizeMenus.php b/tests/ajax/CustomizeMenus.php
index 7acc29ae80..92a1263919 100644
--- a/tests/ajax/CustomizeMenus.php
+++ b/tests/ajax/CustomizeMenus.php
@@ -77,6 +77,8 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 *
 	 * @dataProvider data_ajax_load_available_items_cap_check
 	 *
+	 * @covers WP_Customize_Nav_Menus::ajax_load_available_items
+	 *
 	 * @param string $role              The role we're checking caps against.
 	 * @param array  $expected_results  Expected results.
 	 */
@@ -155,6 +157,8 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 *
 	 * @dataProvider data_ajax_load_available_items_error_messages
 	 *
+	 * @covers WP_Customize_Nav_Menus::ajax_load_available_items
+	 *
 	 * @param array $post_args POST args.
 	 * @param mixed $expected_results Expected results.
 	 */
@@ -265,6 +269,8 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 *
 	 * @dataProvider data_ajax_load_available_items_success_status
 	 *
+	 * @covers WP_Customize_Nav_Menus::ajax_load_available_items
+	 *
 	 * @param array $post_args       POST args.
 	 * @param array $success_status  Success status.
 	 */
@@ -356,6 +362,8 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 *
 	 * @dataProvider data_ajax_load_available_items_structure
 	 *
+	 * @covers WP_Customize_Nav_Menus::ajax_load_available_items
+	 *
 	 * @param array $post_args POST args.
 	 */
 	public function test2_ajax_load_available_items_structure( $post_args ) {
@@ -464,6 +472,9 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 *
 	 * @dataProvider data_ajax_search_available_items_caps_check
 	 *
+	 * @covers WP_Customize_Nav_Menus::ajax_search_available_items
+	 * @covers WP_Customize_Nav_Menus::search_available_items_query
+	 *
 	 * @param string $role             Role.
 	 * @param array  $expected_results Expected results.
 	 */
@@ -543,6 +554,9 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 *
 	 * @dataProvider data_ajax_search_available_items_results
 	 *
+	 * @covers WP_Customize_Nav_Menus::ajax_search_available_items
+	 * @covers WP_Customize_Nav_Menus::search_available_items_query
+	 *
 	 * @param array $post_args        POST args.
 	 * @param array $expected_results Expected results.
 	 */
@@ -638,6 +652,7 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 * Testing successful ajax_insert_auto_draft_post() call.
 	 *
 	 * @covers WP_Customize_Nav_Menus::ajax_insert_auto_draft_post
+	 * @covers WP_Customize_Nav_Menus::insert_auto_draft_post
 	 */
 	public function test_ajax_insert_auto_draft_post_success() {
 		$_POST                = wp_slash(
@@ -691,7 +706,7 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 		$this->assertSame( 'bad_nonce', $response['data'] );
 
 		// Bad nonce.
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'subscriber' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'subscriber' ) ) );
 		$_POST                = wp_slash(
 			array(
 				'customize-menus-nonce' => wp_create_nonce( 'customize-menus' ),
@@ -704,7 +719,7 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 		$this->assertSame( 'customize_not_allowed', $response['data'] );
 
 		// Missing params.
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		$_POST                = wp_slash(
 			array(
 				'customize-menus-nonce' => wp_create_nonce( 'customize-menus' ),
diff --git a/tests/ajax/DeleteComment.php b/tests/ajax/DeleteComment.php
index bd38671b0d..84dd82fc8e 100644
--- a/tests/ajax/DeleteComment.php
+++ b/tests/ajax/DeleteComment.php
@@ -57,6 +57,9 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 	 *
 	 * Expects test to pass.
 	 *
+	 * @covers ::wp_ajax_delete_comment
+	 * @covers ::_wp_ajax_delete_comment_response
+	 *
 	 * @param WP_Comment $comment Comment object.
 	 * @param string     $action  Action: 'trash', 'untrash', etc.
 	 */
@@ -116,6 +119,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 	 *
 	 * Expects test to fail.
 	 *
+	 * @covers ::wp_ajax_delete_comment
+	 *
 	 * @param WP_Comment $comment Comment object.
 	 * @param string     $action  Action: 'trash', 'untrash', etc.
 	 */
@@ -148,6 +153,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 	 *
 	 * Expects test to fail.
 	 *
+	 * @covers ::wp_ajax_delete_comment
+	 *
 	 * @param WP_Comment $comment Comment object.
 	 * @param string     $action  Action: 'trash', 'untrash', etc.
 	 */
@@ -179,6 +186,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 	 *
 	 * Expects test to fail.
 	 *
+	 * @covers ::wp_ajax_delete_comment
+	 *
 	 * @param WP_Comment $comment Comment object.
 	 * @param string     $action  Action: 'trash', 'untrash', etc.
 	 */
@@ -216,6 +225,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 	 *
 	 * Expects test to fail.
 	 *
+	 * @covers ::wp_ajax_delete_comment
+	 *
 	 * @param WP_Comment $comment Comment object.
 	 * @param string     $action  Action: 'trash', 'untrash', etc.
 	 */
@@ -263,6 +274,9 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Deletes a comment as an administrator (expects success).
+	 *
+	 * @covers ::wp_ajax_delete_comment
+	 * @covers ::_wp_ajax_delete_comment_response
 	 */
 	public function test_ajax_comment_trash_actions_as_administrator() {
 		// Test trash/untrash.
@@ -279,6 +293,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Deletes a comment as a subscriber (expects permission denied).
+	 *
+	 * @covers ::wp_ajax_delete_comment
 	 */
 	public function test_ajax_comment_trash_actions_as_subscriber() {
 		// Test trash/untrash.
@@ -295,6 +311,9 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Deletes a comment with no ID.
+	 *
+	 * @covers ::wp_ajax_delete_comment
+	 * @covers ::_wp_ajax_delete_comment_response
 	 */
 	public function test_ajax_trash_comment_no_id() {
 		// Test trash/untrash.
@@ -311,6 +330,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Deletes a comment with a bad nonce.
+	 *
+	 * @covers ::wp_ajax_delete_comment
 	 */
 	public function test_ajax_trash_comment_bad_nonce() {
 		// Test trash/untrash.
@@ -327,6 +348,8 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * Tests trashing an already trashed comment, etc.
+	 *
+	 * @covers ::wp_ajax_delete_comment
 	 */
 	public function test_ajax_trash_double_action() {
 		// Test trash/untrash.
diff --git a/tests/ajax/DeletePlugin.php b/tests/ajax/DeletePlugin.php
index c42e238499..57a66a0dbf 100644
--- a/tests/ajax/DeletePlugin.php
+++ b/tests/ajax/DeletePlugin.php
@@ -8,6 +8,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * Testing Ajax handler for deleting a plugin.
  *
  * @group ajax
+ *
+ * @covers ::wp_ajax_delete_plugin
  */
 class Tests_Ajax_Delete_Plugin extends WP_Ajax_UnitTestCase {
 
@@ -127,6 +129,9 @@ class Tests_Ajax_Delete_Plugin extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * @group ms-excluded
+	 *
+	 * @covers ::wp_ajax_delete_plugin
+	 * @covers ::delete_plugins
 	 */
 	public function test_delete_plugin() {
 		$this->_setRole( 'administrator' );
diff --git a/tests/ajax/DimComment.php b/tests/ajax/DimComment.php
index 05e6808bfc..6881279e07 100644
--- a/tests/ajax/DimComment.php
+++ b/tests/ajax/DimComment.php
@@ -12,6 +12,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * @subpackage UnitTests
  * @since      3.4.0
  * @group      ajax
+ *
+ * @covers ::wp_ajax_dim_comment
  */
 class Tests_Ajax_DimComment extends WP_Ajax_UnitTestCase {
 
diff --git a/tests/ajax/EditComment.php b/tests/ajax/EditComment.php
index d5b569d388..fba7bd46a3 100644
--- a/tests/ajax/EditComment.php
+++ b/tests/ajax/EditComment.php
@@ -12,6 +12,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * @subpackage UnitTests
  * @since      3.4.0
  * @group      ajax
+ *
+ * @covers ::wp_ajax_edit_comment
  */
 class Tests_Ajax_EditComment extends WP_Ajax_UnitTestCase {
 
diff --git a/tests/ajax/GetComments.php b/tests/ajax/GetComments.php
index 6649e30dab..a828aa3df6 100644
--- a/tests/ajax/GetComments.php
+++ b/tests/ajax/GetComments.php
@@ -12,6 +12,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * @subpackage UnitTests
  * @since      3.4.0
  * @group      ajax
+ *
+ * @covers ::wp_ajax_get_comments
  */
 class Tests_Ajax_GetComments extends WP_Ajax_UnitTestCase {
 
diff --git a/tests/ajax/ManageThemes.php b/tests/ajax/ManageThemes.php
index 015c140d83..f689515fe3 100644
--- a/tests/ajax/ManageThemes.php
+++ b/tests/ajax/ManageThemes.php
@@ -8,6 +8,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * Testing Ajax handler for instlaling, updating, and deleting themes.
  *
  * @group ajax
+ *
+ * @covers ::wp_ajax_update_theme
  */
 class Tests_Ajax_Manage_Themes extends WP_Ajax_UnitTestCase {
 	private $orig_theme_dir;
diff --git a/tests/ajax/MediaEdit.php b/tests/ajax/MediaEdit.php
index d42ef09203..83c478c83b 100644
--- a/tests/ajax/MediaEdit.php
+++ b/tests/ajax/MediaEdit.php
@@ -27,6 +27,10 @@ class Tests_Ajax_MediaEdit extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * @ticket 22985
+	 * @requires function imagejpeg
+	 *
+	 * @covers ::wp_insert_attachment
+	 * @covers ::wp_save_image
 	 */
 	public function testCropImageThumbnail() {
 		require_once ABSPATH . 'wp-admin/includes/image-edit.php';
@@ -56,6 +60,10 @@ class Tests_Ajax_MediaEdit extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * @ticket 32171
+	 * @requires function imagejpeg
+	 *
+	 * @covers ::wp_insert_attachment
+	 * @covers ::wp_save_image
 	 */
 	public function testImageEditOverwriteConstant() {
 		define( 'IMAGE_EDIT_OVERWRITE', true );
@@ -89,14 +97,24 @@ class Tests_Ajax_MediaEdit extends WP_Ajax_UnitTestCase {
 
 		$file_path = dirname( get_attached_file( $id ) );
 
+		$files_that_should_not_exist = array();
+
 		foreach ( $sizes1 as $key => $size ) {
 			if ( $sizes2[ $key ]['file'] !== $size['file'] ) {
-				$files_that_shouldnt_exist[] = $file_path . '/' . $size['file'];
+				$files_that_should_not_exist[] = $file_path . '/' . $size['file'];
 			}
 		}
 
-		foreach ( $files_that_shouldnt_exist as $file ) {
-			$this->assertFileDoesNotExist( $file, 'IMAGE_EDIT_OVERWRITE is leaving garbage image files behind.' );
+		if ( ! empty( $files_that_should_not_exist ) ) {
+			foreach ( $files_that_should_not_exist as $file ) {
+				$this->assertFileDoesNotExist( $file, 'IMAGE_EDIT_OVERWRITE is leaving garbage image files behind.' );
+			}
+		} else {
+			/*
+			 * This assertion will always pass due to the "if" condition, but prevents this test
+			 * from being marked as "risky" due to the test not performing any assertions.
+			 */
+			$this->assertSame( array(), $files_that_should_not_exist );
 		}
 	}
 }
diff --git a/tests/ajax/QuickEdit.php b/tests/ajax/QuickEdit.php
index 2369930cfb..d94f3d6cb2 100644
--- a/tests/ajax/QuickEdit.php
+++ b/tests/ajax/QuickEdit.php
@@ -14,6 +14,9 @@ class Tests_Ajax_QuickEdit extends WP_Ajax_UnitTestCase {
 
 	/**
 	 * @ticket 26948
+	 *
+	 * @covers ::wp_ajax_inline_save
+	 * @covers ::edit_post
 	 */
 	public function test_dont_process_terms_if_taxonomy_does_not_allow_show_on_quick_edit() {
 		register_taxonomy(
diff --git a/tests/ajax/ReplytoComment.php b/tests/ajax/ReplytoComment.php
index 0d98a98a39..6a150ca12b 100644
--- a/tests/ajax/ReplytoComment.php
+++ b/tests/ajax/ReplytoComment.php
@@ -12,6 +12,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * @subpackage UnitTests
  * @since      3.4.0
  * @group      ajax
+ *
+ * @covers ::wp_ajax_replyto_comment
  */
 class Tests_Ajax_ReplytoComment extends WP_Ajax_UnitTestCase {
 
@@ -186,7 +188,7 @@ class Tests_Ajax_ReplytoComment extends WP_Ajax_UnitTestCase {
 
 		// Make the request.
 		$this->expectException( 'WPAjaxDieStopException' );
-		$this->expectExceptionMessage( 'Error: You can&#8217;t reply to a comment on a draft post.' );
+		$this->expectExceptionMessage( 'You cannot reply to a comment on a draft post.' );
 		$this->_handleAjax( 'replyto-comment' );
 	}
 
diff --git a/tests/ajax/Response.php b/tests/ajax/Response.php
index 986c0971da..bf3335ad98 100644
--- a/tests/ajax/Response.php
+++ b/tests/ajax/Response.php
@@ -6,6 +6,8 @@
  * @subpackage UnitTests
  * @since      3.5.0
  * @group      ajax
+ *
+ * @covers WP_Ajax_Response::send
  */
 class Tests_Ajax_Response extends WP_UnitTestCase {
 
diff --git a/tests/ajax/TagSearch.php b/tests/ajax/TagSearch.php
index 971c8cb995..3374033092 100644
--- a/tests/ajax/TagSearch.php
+++ b/tests/ajax/TagSearch.php
@@ -12,6 +12,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * @subpackage UnitTests
  * @since      3.4.0
  * @group      ajax
+ *
+ * @covers ::wp_ajax_ajax_tag_search
  */
 class Tests_Ajax_TagSearch extends WP_Ajax_UnitTestCase {
 
@@ -156,4 +158,38 @@ class Tests_Ajax_TagSearch extends WP_Ajax_UnitTestCase {
 		$this->_handleAjax( 'ajax-tag-search' );
 	}
 
+	/**
+	 * Test the ajax_term_search_results filter
+	 *
+	 * @ticket 55606
+	 */
+	public function test_ajax_term_search_results_filter() {
+
+		// Become an administrator.
+		$this->_setRole( 'administrator' );
+
+		// Set up a default request.
+		$_GET['tax'] = 'post_tag';
+		$_GET['q']   = 'chat';
+
+		// Add the ajax_term_search_results filter.
+		add_filter(
+			'ajax_term_search_results',
+			static function( $results, $tax, $s ) {
+				return array( 'ajax_term_search_results was applied' );
+			},
+			10,
+			3
+		);
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'ajax-tag-search', $_GET['tax'], $_GET['q'] );
+		} catch ( WPAjaxDieContinueException $e ) {
+			unset( $e );
+		}
+
+		// Ensure we found the right match.
+		$this->assertSame( 'ajax_term_search_results was applied', $this->_last_response );
+	}
 }
diff --git a/tests/ajax/UpdatePlugin.php b/tests/ajax/UpdatePlugin.php
index 44ce630633..07ab868ea3 100644
--- a/tests/ajax/UpdatePlugin.php
+++ b/tests/ajax/UpdatePlugin.php
@@ -8,6 +8,8 @@ require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
  * Testing Ajax handler for updating a plugin.
  *
  * @group ajax
+ *
+ * @covers ::wp_ajax_update_plugin
  */
 class Tests_Ajax_Update_Plugin extends WP_Ajax_UnitTestCase {
 
diff --git a/tests/ajax/wpAjaxCropImage.php b/tests/ajax/wpAjaxCropImage.php
new file mode 100644
index 0000000000..008cfa7d1b
--- /dev/null
+++ b/tests/ajax/wpAjaxCropImage.php
@@ -0,0 +1,222 @@
+<?php
+
+/**
+ * Admin Ajax functions to be tested.
+ */
+require_once ABSPATH . 'wp-admin/includes/ajax-actions.php';
+require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-base.php';
+require_once ABSPATH . 'wp-admin/includes/class-wp-filesystem-direct.php';
+
+/**
+ * Class for testing ajax crop image functionality.
+ *
+ * @group ajax
+ * @covers ::wp_ajax_crop_image
+ */
+class Tests_Ajax_WpAjaxCropImage extends WP_Ajax_UnitTestCase {
+
+	/**
+	 * @var WP_Post|null
+	 */
+	private $attachment;
+
+	/**
+	 * @var WP_Post|null
+	 */
+	private $cropped_attachment;
+
+	public function set_up() {
+		parent::set_up();
+
+		// Become an administrator.
+		$this->_setRole( 'administrator' );
+	}
+
+	public function tear_down() {
+		if ( $this->attachment instanceof WP_Post ) {
+			wp_delete_attachment( $this->attachment->ID, true );
+		}
+
+		if ( $this->cropped_attachment instanceof WP_Post ) {
+			wp_delete_attachment( $this->cropped_attachment->ID, true );
+		}
+		$this->attachment         = null;
+		$this->cropped_attachment = null;
+
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests that attachment properties are copied over to the cropped image.
+	 *
+	 * @ticket 37750
+	 */
+	public function test_it_copies_metadata_from_original_image() {
+		$this->attachment = $this->make_attachment( true );
+		$this->prepare_post( $this->attachment );
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'crop-image' );
+		} catch ( WPAjaxDieContinueException $e ) {
+		}
+
+		$response = json_decode( $this->_last_response, true );
+		$this->validate_response( $response );
+
+		$this->cropped_attachment = get_post( $response['data']['id'] );
+		$this->assertInstanceOf( WP_Post::class, $this->cropped_attachment, 'get_post function must return an instance of WP_Post class' );
+		$this->assertNotEmpty( $this->attachment->post_title, 'post_title value must not be empty for testing purposes' );
+		$this->assertNotEmpty( $this->cropped_attachment->post_title, 'post_title value must not be empty for testing purposes' );
+		$this->assertSame( $this->attachment->post_title, $this->cropped_attachment->post_title, 'post_title value should be copied over to the cropped attachment' );
+		$this->assertSame( $this->attachment->post_content, $this->cropped_attachment->post_content, 'post_content value should be copied over to the cropped attachment' );
+		$this->assertSame( $this->attachment->post_excerpt, $this->cropped_attachment->post_excerpt, 'post_excerpt value should be copied over to the cropped attachment' );
+		$this->assertSame( $this->attachment->_wp_attachment_image_alt, $this->cropped_attachment->_wp_attachment_image_alt, '_wp_attachment_image_alt value should be copied over to the cropped attachment' );
+	}
+
+	/**
+	 * Tests that post_title gets populated if it wasn't modified.
+	 *
+	 * @ticket 37750
+	 */
+	public function test_it_populates_title_if_title_was_not_modified() {
+
+		$this->attachment = $this->make_attachment( true );
+		$filename         = $this->get_attachment_filename( $this->attachment );
+		$this->attachment = get_post(
+			wp_update_post(
+				array(
+					'ID'         => $this->attachment->ID,
+					'post_title' => $filename,
+				)
+			)
+		);
+
+		$this->prepare_post( $this->attachment );
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'crop-image' );
+		} catch ( WPAjaxDieContinueException $e ) {
+		}
+
+		$response = json_decode( $this->_last_response, true );
+		$this->validate_response( $response );
+
+		$this->cropped_attachment = get_post( $response['data']['id'] );
+		$this->assertInstanceOf( WP_Post::class, $this->cropped_attachment, 'get_post function must return an instance of WP_Post class' );
+		$this->assertStringStartsWith( 'cropped-', $this->cropped_attachment->post_title, 'post_title attribute should start with "cropped-" prefix, i.e. it has to be populated' );
+	}
+
+	/**
+	 * Tests that attachment properties get populated if they are not defined (but specific logic depends on the actual property).
+	 *
+	 * @ticket 37750
+	 */
+	public function test_it_doesnt_generate_new_metadata_if_metadata_is_empty() {
+		$this->attachment = $this->make_attachment( false );
+		$this->prepare_post( $this->attachment );
+
+		// Make the request.
+		try {
+			$this->_handleAjax( 'crop-image' );
+		} catch ( WPAjaxDieContinueException $e ) {
+		}
+
+		$response = json_decode( $this->_last_response, true );
+		$this->validate_response( $response );
+
+		$this->cropped_attachment = get_post( $response['data']['id'] );
+		$this->assertInstanceOf( WP_Post::class, $this->cropped_attachment, 'get_post function must return an instance of WP_Post class' );
+		$this->assertEmpty( $this->attachment->post_title, 'post_title value must be empty for testing purposes' );
+		$this->assertNotEmpty( $this->cropped_attachment->post_title, 'post_title value must be auto-generated if it\'s empty in the original attachment' );
+		$this->assertSame( $this->get_attachment_filename( $this->cropped_attachment ), $this->cropped_attachment->post_title, 'post_title attribute should contain filename of the cropped image' );
+		$this->assertStringStartsWith( 'cropped-', $this->cropped_attachment->post_title, 'post_title attribute should start with "cropped-" prefix, i.e. it has to be populated' );
+		$this->assertStringStartsWith( 'http', $this->cropped_attachment->post_content, 'post_content value should contain an URL if it\'s empty in the original attachment' );
+		$this->assertEmpty( $this->cropped_attachment->post_excerpt, 'post_excerpt value must be empty if it\'s empty in the original attachment' );
+		$this->assertEmpty( $this->cropped_attachment->_wp_attachment_image_alt, '_wp_attachment_image_alt value must be empty if it\'s empty in the original attachment' );
+	}
+
+	/**
+	 * Creates an attachment.
+	 *
+	 * @return WP_Post
+	 */
+	private function make_attachment( $with_metadata = true ) {
+		$uniq_id = uniqid( 'crop-image-ajax-action-test-' );
+
+		$test_file        = DIR_TESTDATA . '/images/test-image.jpg';
+		$upload_directory = wp_upload_dir();
+		$uploaded_file    = $upload_directory['path'] . '/' . $uniq_id . '.jpg';
+		$filesystem       = new WP_Filesystem_Direct( true );
+		$filesystem->copy( $test_file, $uploaded_file );
+
+		$attachment_data = array(
+			'file' => $uploaded_file,
+			'type' => 'image/jpg',
+			'url'  => 'http://localhost/foo.jpg',
+		);
+
+		$attachment_id = $this->_make_attachment( $attachment_data );
+		$post_data     = array(
+			'ID'           => $attachment_id,
+			'post_title'   => $with_metadata ? 'Title ' . $uniq_id : '',
+			'post_content' => $with_metadata ? 'Description ' . $uniq_id : '',
+			'context'      => 'custom-logo',
+			'post_excerpt' => $with_metadata ? 'Caption ' . $uniq_id : '',
+		);
+
+		// Update the post because _make_attachment method doesn't support these arguments.
+		wp_update_post( $post_data );
+
+		if ( $with_metadata ) {
+			update_post_meta( $attachment_id, '_wp_attachment_image_alt', wp_slash( 'Alt ' . $uniq_id ) );
+		}
+
+		return get_post( $attachment_id );
+	}
+
+	/**
+	 * @param array $response Response to validate.
+	 */
+	private function validate_response( $response ) {
+		$this->assertArrayHasKey( 'success', $response, 'Response array must contain "success" key.' );
+		$this->assertArrayHasKey( 'data', $response, 'Response array must contain "data" key.' );
+		$this->assertNotEmpty( $response['data']['id'], 'Response array must contain "ID" value of the post entity.' );
+	}
+
+	/**
+	 * Prepares $_POST for crop-image ajax action.
+	 *
+	 * @param WP_Post $attachment
+	 */
+	private function prepare_post( WP_Post $attachment ) {
+		$_POST = array(
+			'wp_customize' => 'on',
+			'nonce'        => wp_create_nonce( 'image_editor-' . $attachment->ID ),
+			'id'           => $attachment->ID,
+			'context'      => 'custom_logo',
+			'cropDetails'  =>
+				array(
+					'x1'         => '0',
+					'y1'         => '0',
+					'x2'         => '100',
+					'y2'         => '100',
+					'width'      => '100',
+					'height'     => '100',
+					'dst_width'  => '100',
+					'dst_height' => '100',
+				),
+			'action'       => 'crop-image',
+		);
+	}
+
+	/**
+	 * @param WP_Post $attachment
+	 *
+	 * @return string
+	 */
+	private function get_attachment_filename( WP_Post $attachment ) {
+		return wp_basename( wp_get_attachment_url( $attachment->ID ) );
+	}
+}
diff --git a/tests/attachment/slashes.php b/tests/attachment/slashes.php
index 8cb7c48487..b6c009957c 100644
--- a/tests/attachment/slashes.php
+++ b/tests/attachment/slashes.php
@@ -4,8 +4,24 @@
  * @group attachment
  * @group slashes
  * @ticket 21767
+ *
+ * @covers ::wp_insert_attachment
  */
 class Tests_Attachment_Slashes extends WP_UnitTestCase {
+
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
+
 	protected static $author_id;
 
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
@@ -16,16 +32,6 @@ class Tests_Attachment_Slashes extends WP_UnitTestCase {
 		parent::set_up();
 
 		wp_set_current_user( self::$author_id );
-
-		// It is important to test with both even and odd numbered slashes,
-		// as KSES does a strip-then-add slashes in some of its function calls.
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 	}
 
 	/**
@@ -35,32 +41,32 @@ class Tests_Attachment_Slashes extends WP_UnitTestCase {
 		$post_id = wp_insert_attachment(
 			array(
 				'post_status'           => 'publish',
-				'post_title'            => $this->slash_1,
-				'post_content_filtered' => $this->slash_3,
-				'post_excerpt'          => $this->slash_5,
+				'post_title'            => self::SLASH_1,
+				'post_content_filtered' => self::SLASH_3,
+				'post_excerpt'          => self::SLASH_5,
 				'post_type'             => 'post',
 			)
 		);
 		$post    = get_post( $post_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $post->post_title );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $post->post_content_filtered );
-		$this->assertSame( wp_unslash( $this->slash_5 ), $post->post_excerpt );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $post->post_title );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $post->post_content_filtered );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), $post->post_excerpt );
 
 		$post_id = wp_insert_attachment(
 			array(
 				'post_status'           => 'publish',
-				'post_title'            => $this->slash_2,
-				'post_content_filtered' => $this->slash_4,
-				'post_excerpt'          => $this->slash_6,
+				'post_title'            => self::SLASH_2,
+				'post_content_filtered' => self::SLASH_4,
+				'post_excerpt'          => self::SLASH_6,
 				'post_type'             => 'post',
 			)
 		);
 		$post    = get_post( $post_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $post->post_title );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $post->post_content_filtered );
-		$this->assertSame( wp_unslash( $this->slash_6 ), $post->post_excerpt );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $post->post_title );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $post->post_content_filtered );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), $post->post_excerpt );
 	}
 
 }
diff --git a/tests/auth.php b/tests/auth.php
index 3936f0772d..2198fadcd0 100644
--- a/tests/auth.php
+++ b/tests/auth.php
@@ -407,7 +407,7 @@ class Tests_Auth extends WP_UnitTestCase {
 			'user_email' => 'mail@example.com',
 			'user_pass'  => 'password',
 		);
-		$this->factory->user->create( $user_args );
+		self::factory()->user->create( $user_args );
 
 		$this->assertInstanceOf( 'WP_User', wp_authenticate( $user_args['user_email'], $user_args['user_pass'] ) );
 		$this->assertInstanceOf( 'WP_User', wp_authenticate( $user_args['user_login'], $user_args['user_pass'] ) );
@@ -421,7 +421,7 @@ class Tests_Auth extends WP_UnitTestCase {
 			'user_email' => "mail\'@example.com",
 			'user_pass'  => 'password',
 		);
-		$this->factory()->user->create( $user_args );
+		self::factory()->user->create( $user_args );
 
 		$_POST['log'] = $user_args['user_email'];
 		$_POST['pwd'] = $user_args['user_pass'];
@@ -436,7 +436,7 @@ class Tests_Auth extends WP_UnitTestCase {
 	 * @covers ::wp_validate_application_password
 	 */
 	public function test_application_password_authentication() {
-		$user_id = $this->factory()->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'user_login' => 'http_auth_login',
 				'user_pass'  => 'http_auth_pass', // Shouldn't be allowed for API login.
diff --git a/tests/avatar.php b/tests/avatar.php
index 336ab611e2..026809b4a1 100644
--- a/tests/avatar.php
+++ b/tests/avatar.php
@@ -169,7 +169,7 @@ class Tests_Avatar extends WP_UnitTestCase {
 
 	public function test_get_avatar() {
 		$img = get_avatar( 1 );
-		$this->assertSame( preg_match( "|^<img alt='[^']*' src='[^']*' srcset='[^']*' class='[^']*' height='[^']*' width='[^']*' loading='lazy'/>$|", $img ), 1 );
+		$this->assertSame( preg_match( "|^<img alt='[^']*' src='[^']*' srcset='[^']*' class='[^']*' height='[^']*' width='[^']*' loading='lazy' decoding='async'/>$|", $img ), 1 );
 	}
 
 	public function test_get_avatar_size() {
diff --git a/tests/basic.php b/tests/basic.php
index 5ffd6b2470..954751d99e 100644
--- a/tests/basic.php
+++ b/tests/basic.php
@@ -1,96 +1,68 @@
 <?php
 
 /**
- * just make sure the test framework is working
+ * Test the content in some root directory files.
  *
- * @group testsuite
+ * @group basic
  */
 class Tests_Basic extends WP_UnitTestCase {
 
+	/**
+	 * @coversNothing
+	 */
 	public function test_license() {
-		// This test is designed to only run on trunk/master.
+		// This test is designed to only run on trunk.
 		$this->skipOnAutomatedBranches();
 
 		$license = file_get_contents( ABSPATH . 'license.txt' );
 		preg_match( '#Copyright 2011-(\d+) by the contributors#', $license, $matches );
-		$this_year = gmdate( 'Y' );
-		$this->assertSame( $this_year, trim( $matches[1] ), "license.txt's year needs to be updated to $this_year." );
+		$license_year = trim( $matches[1] );
+		$this_year    = gmdate( 'Y' );
+
+		$this->assertSame( $this_year, $license_year, "license.txt's year needs to be updated to $this_year." );
 	}
 
+	/**
+	 * @coversNothing
+	 */
 	public function test_security_md() {
-		// This test is designed to only run on trunk/master.
+		// This test is designed to only run on trunk.
 		$this->skipOnAutomatedBranches();
 
 		$security = file_get_contents( dirname( ABSPATH ) . '/SECURITY.md' );
-		preg_match( '#\d.\d.x#', $security, $matches );
-		$current_version = substr( $GLOBALS['wp_version'], 0, 3 );
-		$latest_stable   = sprintf( '%s.x', (float) $current_version - 0.1 );
-		$this->assertSame( $latest_stable, trim( $matches[0] ), "SECURITY.md's version needs to be updated to $latest_stable." );
+		preg_match_all( '#\d.\d.x#', $security, $matches );
+		$supported_versions = $matches[0];
+		$current_version    = substr( $GLOBALS['wp_version'], 0, 3 );
+		$latest_stable      = number_format( (float) $current_version - 0.1, 1 ) . '.x';
+
+		$this->assertContains( $latest_stable, $supported_versions, "SECURITY.md's version needs to be updated to $latest_stable." );
 	}
 
+	/**
+	 * @coversNothing
+	 */
 	public function test_package_json() {
 		$package_json    = file_get_contents( dirname( ABSPATH ) . '/package.json' );
 		$package_json    = json_decode( $package_json, true );
 		list( $version ) = explode( '-', $GLOBALS['wp_version'] );
+
 		// package.json uses x.y.z, so fill cleaned $wp_version for .0 releases.
 		if ( 1 === substr_count( $version, '.' ) ) {
 			$version .= '.0';
 		}
+
 		$this->assertSame( $version, $package_json['version'], "package.json's version needs to be updated to $version." );
+
 		return $package_json;
 	}
 
 	/**
 	 * @depends test_package_json
+	 *
+	 * @coversNothing
 	 */
 	public function test_package_json_node_engine( $package_json ) {
 		$this->assertArrayHasKey( 'engines', $package_json );
 		$this->assertArrayHasKey( 'node', $package_json['engines'] );
 	}
-
-	// Test some helper utility functions.
-
-	public function test_strip_ws() {
-		$this->assertSame( '', strip_ws( '' ) );
-		$this->assertSame( 'foo', strip_ws( 'foo' ) );
-		$this->assertSame( '', strip_ws( "\r\n\t  \n\r\t" ) );
-
-		$in  = "asdf\n";
-		$in .= "asdf asdf\n";
-		$in .= "asdf     asdf\n";
-		$in .= "\tasdf\n";
-		$in .= "\tasdf\t\n";
-		$in .= "\t\tasdf\n";
-		$in .= "foo bar\n\r\n";
-		$in .= "foo\n";
-
-		$expected  = "asdf\n";
-		$expected .= "asdf asdf\n";
-		$expected .= "asdf     asdf\n";
-		$expected .= "asdf\n";
-		$expected .= "asdf\n";
-		$expected .= "asdf\n";
-		$expected .= "foo bar\n";
-		$expected .= 'foo';
-
-		$this->assertSame( $expected, strip_ws( $in ) );
-
-	}
-
-	public function test_mask_input_value() {
-		$in = <<<EOF
-<h2>Assign Authors</h2>
-<p>To make it easier for you to edit and save the imported posts and drafts, you may want to change the name of the author of the posts. For example, you may want to import all the entries as <code>admin</code>s entries.</p>
-<p>If a new user is created by WordPress, the password will be set, by default, to "changeme". Quite suggestive, eh? ;)</p>
-        <ol id="authors"><form action="?import=wordpress&amp;step=2&amp;id=" method="post"><input type="hidden" name="_wpnonce" value="855ae98911" /><input type="hidden" name="_wp_http_referer" value="wp-test.php" /><li>Current author: <strong>Alex Shiels</strong><br />Create user  <input type="text" value="Alex Shiels" name="user[]" maxlength="30"> <br /> or map to existing<select name="userselect[0]">
-EOF;
-		// _wpnonce value should be replaced with 'xxx'.
-		$expected = <<<EOF
-<h2>Assign Authors</h2>
-<p>To make it easier for you to edit and save the imported posts and drafts, you may want to change the name of the author of the posts. For example, you may want to import all the entries as <code>admin</code>s entries.</p>
-<p>If a new user is created by WordPress, the password will be set, by default, to "changeme". Quite suggestive, eh? ;)</p>
-        <ol id="authors"><form action="?import=wordpress&amp;step=2&amp;id=" method="post"><input type="hidden" name="_wpnonce" value="***" /><input type="hidden" name="_wp_http_referer" value="wp-test.php" /><li>Current author: <strong>Alex Shiels</strong><br />Create user  <input type="text" value="Alex Shiels" name="user[]" maxlength="30"> <br /> or map to existing<select name="userselect[0]">
-EOF;
-		$this->assertSame( $expected, mask_input_value( $in ) );
-	}
 }
diff --git a/tests/block-supports/border.php b/tests/block-supports/border.php
new file mode 100644
index 0000000000..204c8e43a0
--- /dev/null
+++ b/tests/block-supports/border.php
@@ -0,0 +1,162 @@
+<?php
+/**
+ * @group block-supports
+ *
+ * @covers ::wp_apply_border_support
+ */
+class Test_Block_Supports_Border extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
+
+	function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+	}
+
+	function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::set_up();
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_border_color_slug_with_numbers_is_kebab_cased_properly() {
+		$this->test_block_name = 'test/border-color-slug-with-numbers-is-kebab-cased-properly';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'borderColor' => array(
+						'type' => 'string',
+					),
+					'style'       => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'__experimentalBorder' => array(
+						'color'  => true,
+						'radius' => true,
+						'width'  => true,
+						'style'  => true,
+					),
+				),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'borderColor' => 'red',
+			'style'       => array(
+				'border' => array(
+					'radius' => '10px',
+					'width'  => '1px',
+					'style'  => 'dashed',
+				),
+			),
+		);
+
+		$actual   = wp_apply_border_support( $block_type, $block_atts );
+		$expected = array(
+			'class' => 'has-border-color has-red-border-color',
+			'style' => 'border-radius:10px;border-style:dashed;border-width:1px;',
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_border_with_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/border-with-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'__experimentalBorder' => array(
+						'color'                           => true,
+						'radius'                          => true,
+						'width'                           => true,
+						'style'                           => true,
+						'__experimentalSkipSerialization' => true,
+					),
+				),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'border' => array(
+					'color'  => '#eeeeee',
+					'width'  => '1px',
+					'style'  => 'dotted',
+					'radius' => '10px',
+				),
+			),
+		);
+
+		$actual   = wp_apply_border_support( $block_type, $block_atts );
+		$expected = array();
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_radius_with_individual_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/radius-with-individual-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'__experimentalBorder' => array(
+						'color'                           => true,
+						'radius'                          => true,
+						'width'                           => true,
+						'style'                           => true,
+						'__experimentalSkipSerialization' => array( 'radius', 'color' ),
+					),
+				),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'border' => array(
+					'color'  => '#eeeeee',
+					'width'  => '1px',
+					'style'  => 'dotted',
+					'radius' => '10px',
+				),
+			),
+		);
+
+		$actual   = wp_apply_border_support( $block_type, $block_atts );
+		$expected = array(
+			'style' => 'border-style:dotted;border-width:1px;',
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+}
diff --git a/tests/block-supports/colors.php b/tests/block-supports/colors.php
index f9afa76d3d..109709e3d7 100644
--- a/tests/block-supports/colors.php
+++ b/tests/block-supports/colors.php
@@ -1,12 +1,33 @@
 <?php
 /**
  * @group block-supports
+ *
+ * @covers ::wp_apply_colors_support
  */
 class Tests_Block_Supports_Colors extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
 
+	function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+	}
+
+	function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::set_up();
+	}
+
+	/**
+	 * @ticket 54337
+	 */
 	function test_color_slugs_with_numbers_are_kebab_cased_properly() {
+		$this->test_block_name = 'test/color-slug-with-numbers';
 		register_block_type(
-			'test/color-slug-with-numbers',
+			$this->test_block_name,
 			array(
 				'api_version' => 2,
 				'attributes'  => array(
@@ -30,7 +51,7 @@ class Tests_Block_Supports_Colors extends WP_UnitTestCase {
 			)
 		);
 		$registry   = WP_Block_Type_Registry::get_instance();
-		$block_type = $registry->get_registered( 'test/color-slug-with-numbers' );
+		$block_type = $registry->get_registered( $this->test_block_name );
 
 		$block_atts = array(
 			'textColor'       => 'fg1',
@@ -39,9 +60,92 @@ class Tests_Block_Supports_Colors extends WP_UnitTestCase {
 		);
 
 		$actual   = wp_apply_colors_support( $block_type, $block_atts );
-		$expected = array( 'class' => 'has-text-color has-fg-1-color has-background has-bg-2-background-color has-background has-gr-3-gradient-background' );
+		$expected = array( 'class' => 'has-text-color has-fg-1-color has-background has-bg-2-background-color has-gr-3-gradient-background' );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_color_with_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/color-with-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'color' => array(
+						'text'                            => true,
+						'gradients'                       => true,
+						'__experimentalSkipSerialization' => true,
+					),
+				),
+			)
+		);
+
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'color' => array(
+					'text'     => '#d92828',
+					'gradient' => 'linear-gradient(135deg,rgb(6,147,227) 0%,rgb(223,13,13) 46%,rgb(155,81,224) 100%)',
+				),
+			),
+		);
+
+		$actual   = wp_apply_colors_support( $block_type, $block_atts );
+		$expected = array();
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_gradient_with_individual_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/gradient-with-individual-skipped-serialization-block-support';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'color' => array(
+						'text'                            => true,
+						'gradients'                       => true,
+						'__experimentalSkipSerialization' => array( 'gradients' ),
+					),
+				),
+			)
+		);
+
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'color' => array(
+					'text' => '#d92828',
+				),
+			),
+		);
+
+		$actual   = wp_apply_colors_support( $block_type, $block_atts );
+		$expected = array(
+			'class' => 'has-text-color',
+			'style' => 'color:#d92828;',
+		);
 
 		$this->assertSame( $expected, $actual );
-		unregister_block_type( 'test/color-slug-with-numbers' );
 	}
 }
diff --git a/tests/block-supports/elements.php b/tests/block-supports/elements.php
index 84e7446f14..97026f8092 100644
--- a/tests/block-supports/elements.php
+++ b/tests/block-supports/elements.php
@@ -1,6 +1,8 @@
 <?php
 /**
  * @group block-supports
+ *
+ * @covers ::wp_render_elements_support
  */
 class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 	/**
@@ -11,11 +13,12 @@ class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 	 * @return string                String where the unique id classes were replaced with "wp-elements-1".
 	 */
 	private static function make_unique_id_one( $string ) {
-		return preg_replace( '/wp-elements-.{13}/', 'wp-elements-1', $string );
+		return preg_replace( '/wp-elements-[a-zA-Z0-9]+/', 'wp-elements-1', $string );
 	}
 
 	/**
 	 * Test wp_render_elements_support() with a simple paragraph and link color preset.
+	 * @ticket 54337
 	 */
 	public function test_simple_paragraph_link_color() {
 		$result = self::make_unique_id_one(
@@ -45,6 +48,7 @@ class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 
 	/**
 	 * Test wp_render_elements_support() with a paragraph containing a class.
+	 * @ticket 54337
 	 */
 	public function test_class_paragraph_link_color() {
 		$result = self::make_unique_id_one(
@@ -75,6 +79,7 @@ class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 
 	/**
 	 * Test wp_render_elements_support() with a paragraph containing a anchor.
+	 * @ticket 54337
 	 */
 	public function test_anchor_paragraph_link_color() {
 		$result = self::make_unique_id_one(
diff --git a/tests/block-supports/layout.php b/tests/block-supports/layout.php
new file mode 100644
index 0000000000..3611c28efa
--- /dev/null
+++ b/tests/block-supports/layout.php
@@ -0,0 +1,176 @@
+<?php
+/**
+ * Block supports tests for the layout.
+ *
+ * @package WordPress
+ * @subpackage Block Supports
+ * @since 6.0.0
+ */
+
+/**
+ * Tests for block supports related to layout.
+ *
+ * @since 6.0.0
+ *
+ * @group block-supports
+ *
+ * @covers ::wp_restore_image_outer_container
+ */
+class Test_Block_Supports_Layout extends WP_UnitTestCase {
+
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
+	function set_up() {
+		parent::set_up();
+		$this->theme_root     = realpath( DIR_TESTDATA . '/themedir1' );
+		$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
+
+		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+
+		// Set up the new root.
+		add_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		// Clear caches.
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+	}
+
+	function tear_down() {
+		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
+
+		// Clear up the filters to modify the theme root.
+		remove_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+		parent::tear_down();
+	}
+
+	function filter_set_theme_root() {
+		return $this->theme_root;
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_outer_container_not_restored_for_non_aligned_image_block_with_non_themejson_theme() {
+		// The "default" theme doesn't have theme.json support.
+		switch_theme( 'default' );
+		$block         = array(
+			'blockName' => 'core/image',
+			'attrs'     => array(),
+		);
+		$block_content = '<figure class="wp-block-image size-full"><img src="/my-image.jpg"/></figure>';
+		$expected      = '<figure class="wp-block-image size-full"><img src="/my-image.jpg"/></figure>';
+
+		$this->assertSame( $expected, wp_restore_image_outer_container( $block_content, $block ) );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_outer_container_restored_for_aligned_image_block_with_non_themejson_theme() {
+		// The "default" theme doesn't have theme.json support.
+		switch_theme( 'default' );
+		$block         = array(
+			'blockName' => 'core/image',
+			'attrs'     => array(),
+		);
+		$block_content = '<figure class="wp-block-image alignright size-full"><img src="/my-image.jpg"/></figure>';
+		$expected      = '<div class="wp-block-image"><figure class="alignright size-full"><img src="/my-image.jpg"/></figure></div>';
+
+		$this->assertSame( $expected, wp_restore_image_outer_container( $block_content, $block ) );
+	}
+
+	/**
+	 * @ticket 55505
+	 *
+	 * @dataProvider data_block_image_html_restored_outer_container
+	 *
+	 * @param string $block_image_html The block image HTML passed to `wp_restore_image_outer_container`.
+	 * @param string $expected         The expected block image HTML.
+	 */
+	function test_additional_styles_moved_to_restored_outer_container_for_aligned_image_block_with_non_themejson_theme( $block_image_html, $expected ) {
+		// The "default" theme doesn't have theme.json support.
+		switch_theme( 'default' );
+		$block = array(
+			'blockName' => 'core/image',
+			'attrs'     => array(
+				'className' => 'is-style-round my-custom-classname',
+			),
+		);
+
+		$this->assertSame( $expected, wp_restore_image_outer_container( $block_image_html, $block ) );
+	}
+
+	/**
+	 * Data provider for test_additional_styles_moved_to_restored_outer_container_for_aligned_image_block_with_non_themejson_theme().
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $block_image_html The block image HTML passed to `wp_restore_image_outer_container`.
+	 *         @type string $expected         The expected block image HTML.
+	 *     }
+	 * }
+	 */
+	public function data_block_image_html_restored_outer_container() {
+		$expected = '<div class="wp-block-image is-style-round my-custom-classname"><figure class="alignright size-full"><img src="/my-image.jpg"/></figure></div>';
+
+		return array(
+			array(
+				'<figure class="wp-block-image alignright size-full is-style-round my-custom-classname"><img src="/my-image.jpg"/></figure>',
+				$expected,
+			),
+			array(
+				'<figure class="is-style-round my-custom-classname wp-block-image alignright size-full"><img src="/my-image.jpg"/></figure>',
+				$expected,
+			),
+			array(
+				'<figure class="wp-block-image is-style-round my-custom-classname alignright size-full"><img src="/my-image.jpg"/></figure>',
+				$expected,
+			),
+			array(
+				'<figure class="is-style-round wp-block-image alignright my-custom-classname size-full"><img src="/my-image.jpg"/></figure>',
+				$expected,
+			),
+			array(
+				'<figure style="color: red" class=\'is-style-round wp-block-image alignright my-custom-classname size-full\' data-random-tag=">"><img src="/my-image.jpg"/></figure>',
+				'<div class="wp-block-image is-style-round my-custom-classname"><figure style="color: red" class=\'alignright size-full\' data-random-tag=">"><img src="/my-image.jpg"/></figure></div>',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_outer_container_not_restored_for_aligned_image_block_with_themejson_theme() {
+		switch_theme( 'block-theme' );
+		$block         = array(
+			'blockName' => 'core/image',
+			'attrs'     => array(
+				'className' => 'is-style-round my-custom-classname',
+			),
+		);
+		$block_content = '<figure class="wp-block-image alignright size-full is-style-round my-custom-classname"><img src="/my-image.jpg"/></figure>';
+		$expected      = '<figure class="wp-block-image alignright size-full is-style-round my-custom-classname"><img src="/my-image.jpg"/></figure>';
+
+		$this->assertSame( $expected, wp_restore_image_outer_container( $block_content, $block ) );
+	}
+}
diff --git a/tests/block-supports/spacing.php b/tests/block-supports/spacing.php
index 9215716708..e0a849cf6b 100644
--- a/tests/block-supports/spacing.php
+++ b/tests/block-supports/spacing.php
@@ -1,138 +1,167 @@
 <?php
 /**
  * @group block-supports
+ *
+ * @covers ::wp_apply_spacing_support
  */
-class Tests_Block_Supports_Spacing extends WP_UnitTestCase {
-	private $sample_block_content = '<div class="wp-block-test-block">Test</div>';
-	private $test_gap_block_value = array();
-	private $test_gap_block_args  = array();
+class Test_Block_Supports_Spacing extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
 
 	function set_up() {
 		parent::set_up();
+		$this->test_block_name = null;
+	}
 
-		$this->test_gap_block_value = array(
-			'blockName' => 'test/test-block',
-			'attrs'     => array(
-				'style' => array(
+	function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::set_up();
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_spacing_style_is_applied() {
+		$this->test_block_name = 'test/spacing-style-is-applied';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
 					'spacing' => array(
-						'blockGap' => '3em',
+						'margin'   => true,
+						'padding'  => true,
+						'blockGap' => true,
 					),
 				),
-			),
+			)
 		);
-
-		$this->test_gap_block_args = array(
-			'api_version' => 2,
-			'supports'    => array(
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
 				'spacing' => array(
-					'blockGap' => true,
+					'margin'   => array(
+						'top'    => '1px',
+						'right'  => '2px',
+						'bottom' => '3px',
+						'left'   => '4px',
+					),
+					'padding'  => '111px',
+					'blockGap' => '2em',
 				),
 			),
 		);
-	}
 
-	function tear_down() {
-		unregister_block_type( 'test/test-block' );
-
-		parent::tear_down();
-	}
-
-	function test_spacing_gap_block_support_renders_block_inline_style() {
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			$this->sample_block_content,
-			$this->test_gap_block_value
-		);
-
-		$this->assertSame(
-			'<div style="--wp--style--block-gap: 3em" class="wp-block-test-block">Test</div>',
-			$render_output
+		$actual   = wp_apply_spacing_support( $block_type, $block_atts );
+		$expected = array(
+			'style' => 'padding:111px;margin-top:1px;margin-right:2px;margin-bottom:3px;margin-left:4px;',
 		);
-	}
 
-	function test_spacing_gap_block_support_renders_block_inline_style_with_inner_tag() {
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			'<div class="wp-test-block"><p style="color: red;">Test</p></div>',
-			$this->test_gap_block_value
-		);
-
-		$this->assertSame(
-			'<div style="--wp--style--block-gap: 3em" class="wp-test-block"><p style="color: red;">Test</p></div>',
-			$render_output
-		);
+		$this->assertSame( $expected, $actual );
 	}
 
-	function test_spacing_gap_block_support_renders_block_inline_style_with_no_other_attributes() {
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			'<div><p>Test</p></div>',
-			$this->test_gap_block_value
-		);
-
-		$this->assertSame(
-			'<div style="--wp--style--block-gap: 3em"><p>Test</p></div>',
-			$render_output
-		);
-	}
-
-	function test_spacing_gap_block_support_renders_appended_block_inline_style() {
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			'<div class="wp-test-block" style="background: green;"><p style="color: red;">Test</p></div>',
-			$this->test_gap_block_value
+	/**
+	 * @ticket 55505
+	 */
+	function test_spacing_with_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/spacing-with-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'spacing' => array(
+						'margin'                          => true,
+						'padding'                         => true,
+						'blockGap'                        => true,
+						'__experimentalSkipSerialization' => true,
+					),
+				),
+			)
 		);
-
-		$this->assertSame(
-			'<div class="wp-test-block" style="--wp--style--block-gap: 3em; background: green;"><p style="color: red;">Test</p></div>',
-			$render_output
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'spacing' => array(
+					'margin'   => array(
+						'top'    => '1px',
+						'right'  => '2px',
+						'bottom' => '3px',
+						'left'   => '4px',
+					),
+					'padding'  => '111px',
+					'blockGap' => '2em',
+				),
+			),
 		);
-	}
 
-	function test_spacing_gap_block_support_does_not_render_style_when_support_is_false() {
-		$this->test_gap_block_args['supports']['spacing']['blockGap'] = false;
+		$actual   = wp_apply_spacing_support( $block_type, $block_atts );
+		$expected = array();
 
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			$this->sample_block_content,
-			$this->test_gap_block_value
-		);
-
-		$this->assertEquals(
-			$this->sample_block_content,
-			$render_output
-		);
+		$this->assertSame( $expected, $actual );
 	}
 
-	function test_spacing_gap_block_support_does_not_render_style_when_gap_is_null() {
-		$this->test_gap_block_value['attrs']['style']['spacing']['blockGap'] = null;
-		$this->test_gap_block_args['supports']['spacing']['blockGap']        = true;
-
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			$this->sample_block_content,
-			$this->test_gap_block_value
+	/**
+	 * @ticket 55505
+	 */
+	function test_margin_with_individual_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/margin-with-individual-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'spacing' => array(
+						'margin'                          => true,
+						'padding'                         => true,
+						'blockGap'                        => true,
+						'__experimentalSkipSerialization' => array( 'margin' ),
+					),
+				),
+			)
 		);
-
-		$this->assertEquals(
-			$this->sample_block_content,
-			$render_output
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'spacing' => array(
+					'padding'  => array(
+						'top'    => '1px',
+						'right'  => '2px',
+						'bottom' => '3px',
+						'left'   => '4px',
+					),
+					'margin'   => '111px',
+					'blockGap' => '2em',
+				),
+			),
 		);
-	}
-
-	function test_spacing_gap_block_support_does_not_render_style_when_gap_is_illegal_value() {
-		$this->test_gap_block_value['attrs']['style']['spacing']['blockGap'] = '" javascript="alert("hello");';
-		$this->test_gap_block_args['supports']['spacing']['blockGap']        = true;
 
-		register_block_type( 'test/test-block', $this->test_gap_block_args );
-		$render_output = wp_render_spacing_gap_support(
-			$this->sample_block_content,
-			$this->test_gap_block_value
+		$actual   = wp_apply_spacing_support( $block_type, $block_atts );
+		$expected = array(
+			'style' => 'padding-top:1px;padding-right:2px;padding-bottom:3px;padding-left:4px;',
 		);
 
-		$this->assertEquals(
-			$this->sample_block_content,
-			$render_output
-		);
+		$this->assertSame( $expected, $actual );
 	}
 }
diff --git a/tests/block-supports/typography.php b/tests/block-supports/typography.php
index 38d618f980..859f11c557 100644
--- a/tests/block-supports/typography.php
+++ b/tests/block-supports/typography.php
@@ -1,12 +1,33 @@
 <?php
 /**
  * @group block-supports
+ *
+ * @covers ::wp_apply_typography_support
  */
 class Tests_Block_Supports_Typography extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
 
+	function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+	}
+
+	function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::set_up();
+	}
+
+	/**
+	 * @ticket 54337
+	 */
 	function test_font_size_slug_with_numbers_is_kebab_cased_properly() {
+		$this->test_block_name = 'test/font-size-slug-with-numbers';
 		register_block_type(
-			'test/font-size-slug-with-numbers',
+			$this->test_block_name,
 			array(
 				'api_version' => 2,
 				'attributes'  => array(
@@ -22,7 +43,7 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			)
 		);
 		$registry   = WP_Block_Type_Registry::get_instance();
-		$block_type = $registry->get_registered( 'test/font-size-slug-with-numbers' );
+		$block_type = $registry->get_registered( $this->test_block_name );
 
 		$block_atts = array( 'fontSize' => 'h1' );
 
@@ -30,13 +51,14 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 		$expected = array( 'class' => 'has-h-1-font-size' );
 
 		$this->assertSame( $expected, $actual );
-		unregister_block_type( 'test/font-size-slug-with-numbers' );
 	}
-
+	/**
+	 * @ticket 54337
+	 */
 	function test_font_family_with_legacy_inline_styles_using_a_value() {
-		$block_name = 'test/font-family-with-inline-styles-using-value';
+		$this->test_block_name = 'test/font-family-with-inline-styles-using-value';
 		register_block_type(
-			$block_name,
+			$this->test_block_name,
 			array(
 				'api_version' => 2,
 				'attributes'  => array(
@@ -52,20 +74,99 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			)
 		);
 		$registry   = WP_Block_Type_Registry::get_instance();
-		$block_type = $registry->get_registered( $block_name );
+		$block_type = $registry->get_registered( $this->test_block_name );
 		$block_atts = array( 'style' => array( 'typography' => array( 'fontFamily' => 'serif' ) ) );
 
 		$actual   = wp_apply_typography_support( $block_type, $block_atts );
 		$expected = array( 'style' => 'font-family: serif;' );
 
 		$this->assertSame( $expected, $actual );
-		unregister_block_type( $block_name );
 	}
 
+	/**
+	 * @ticket 55505
+	 */
+	function test_typography_with_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/typography-with-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'typography' => array(
+						'fontSize'                        => true,
+						'lineHeight'                      => true,
+						'__experimentalFontFamily'        => true,
+						'__experimentalLetterSpacing'     => true,
+						'__experimentalSkipSerialization' => true,
+					),
+				),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array(
+			'style' => array(
+				'typography' => array(
+					'fontSize'      => 'serif',
+					'lineHeight'    => 'serif',
+					'fontFamily'    => '22px',
+					'letterSpacing' => '22px',
+				),
+			),
+		);
+
+		$actual   = wp_apply_typography_support( $block_type, $block_atts );
+		$expected = array();
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_letter_spacing_with_individual_skipped_serialization_block_supports() {
+		$this->test_block_name = 'test/letter-spacing-with-individua-skipped-serialization-block-supports';
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'typography' => array(
+						'__experimentalLetterSpacing'     => true,
+						'__experimentalSkipSerialization' => array(
+							'letterSpacing',
+						),
+					),
+				),
+			)
+		);
+		$registry   = WP_Block_Type_Registry::get_instance();
+		$block_type = $registry->get_registered( $this->test_block_name );
+		$block_atts = array( 'style' => array( 'typography' => array( 'letterSpacing' => '22px' ) ) );
+
+		$actual   = wp_apply_typography_support( $block_type, $block_atts );
+		$expected = array();
+
+		$this->assertSame( $expected, $actual );
+	}
+	/**
+	 * @ticket 54337
+	 */
 	function test_font_family_with_legacy_inline_styles_using_a_css_var() {
-		$block_name = 'test/font-family-with-inline-styles-using-css-var';
+		$this->test_block_name = 'test/font-family-with-inline-styles-using-css-var';
 		register_block_type(
-			$block_name,
+			$this->test_block_name,
 			array(
 				'api_version' => 2,
 				'attributes'  => array(
@@ -81,20 +182,21 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			)
 		);
 		$registry   = WP_Block_Type_Registry::get_instance();
-		$block_type = $registry->get_registered( $block_name );
+		$block_type = $registry->get_registered( $this->test_block_name );
 		$block_atts = array( 'style' => array( 'typography' => array( 'fontFamily' => 'var:preset|font-family|h1' ) ) );
 
 		$actual   = wp_apply_typography_support( $block_type, $block_atts );
 		$expected = array( 'style' => 'font-family: var(--wp--preset--font-family--h-1);' );
 
 		$this->assertSame( $expected, $actual );
-		unregister_block_type( $block_name );
 	}
-
+	/**
+	 * @ticket 54337
+	 */
 	function test_font_family_with_class() {
-		$block_name = 'test/font-family-with-class';
+		$this->test_block_name = 'test/font-family-with-class';
 		register_block_type(
-			$block_name,
+			$this->test_block_name,
 			array(
 				'api_version' => 2,
 				'attributes'  => array(
@@ -110,14 +212,13 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 			)
 		);
 		$registry   = WP_Block_Type_Registry::get_instance();
-		$block_type = $registry->get_registered( $block_name );
+		$block_type = $registry->get_registered( $this->test_block_name );
 		$block_atts = array( 'fontFamily' => 'h1' );
 
 		$actual   = wp_apply_typography_support( $block_type, $block_atts );
 		$expected = array( 'class' => 'has-h-1-font-family' );
 
 		$this->assertSame( $expected, $actual );
-		unregister_block_type( $block_name );
 	}
 
 }
diff --git a/tests/block-template-utils.php b/tests/block-template-utils.php
index c7745eaa82..7410dcaed3 100644
--- a/tests/block-template-utils.php
+++ b/tests/block-template-utils.php
@@ -11,78 +11,88 @@
  * @group block-templates
  */
 class Tests_Block_Template_Utils extends WP_UnitTestCase {
-	private static $post;
+
+	const TEST_THEME = 'block-theme';
+
+	private static $template_post;
 	private static $template_part_post;
-	private static $test_theme = 'block-theme';
-
-	public static function wpSetUpBeforeClass() {
-		// Set up a template post corresponding to a different theme.
-		// We do this to ensure resolution and slug creation works as expected,
-		// even with another post of that same name present for another theme.
-		$args       = array(
-			'post_type'    => 'wp_template',
-			'post_name'    => 'my_template',
-			'post_title'   => 'My Template',
-			'post_content' => 'Content',
-			'post_excerpt' => 'Description of my template',
-			'tax_input'    => array(
-				'wp_theme' => array(
-					'this-theme-should-not-resolve',
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		/*
+		 * Set up a template post corresponding to a different theme.
+		 * We do this to ensure resolution and slug creation works as expected,
+		 * even with another post of that same name present for another theme.
+		 */
+		self::$template_post = $factory->post->create_and_get(
+			array(
+				'post_type'    => 'wp_template',
+				'post_name'    => 'my_template',
+				'post_title'   => 'My Template',
+				'post_content' => 'Content',
+				'post_excerpt' => 'Description of my template',
+				'tax_input'    => array(
+					'wp_theme' => array(
+						'this-theme-should-not-resolve',
+					),
 				),
-			),
+			)
 		);
-		self::$post = self::factory()->post->create_and_get( $args );
-		wp_set_post_terms( self::$post->ID, 'this-theme-should-not-resolve', 'wp_theme' );
+
+		wp_set_post_terms( self::$template_post->ID, 'this-theme-should-not-resolve', 'wp_theme' );
 
 		// Set up template post.
-		$args       = array(
-			'post_type'    => 'wp_template',
-			'post_name'    => 'my_template',
-			'post_title'   => 'My Template',
-			'post_content' => 'Content',
-			'post_excerpt' => 'Description of my template',
-			'tax_input'    => array(
-				'wp_theme' => array(
-					self::$test_theme,
+		self::$template_post = $factory->post->create_and_get(
+			array(
+				'post_type'    => 'wp_template',
+				'post_name'    => 'my_template',
+				'post_title'   => 'My Template',
+				'post_content' => 'Content',
+				'post_excerpt' => 'Description of my template',
+				'tax_input'    => array(
+					'wp_theme' => array(
+						self::TEST_THEME,
+					),
 				),
-			),
+			)
 		);
-		self::$post = self::factory()->post->create_and_get( $args );
-		wp_set_post_terms( self::$post->ID, self::$test_theme, 'wp_theme' );
+
+		wp_set_post_terms( self::$template_post->ID, self::TEST_THEME, 'wp_theme' );
 
 		// Set up template part post.
-		$template_part_args       = array(
-			'post_type'    => 'wp_template_part',
-			'post_name'    => 'my_template_part',
-			'post_title'   => 'My Template Part',
-			'post_content' => 'Content',
-			'post_excerpt' => 'Description of my template part',
-			'tax_input'    => array(
-				'wp_theme'              => array(
-					self::$test_theme,
-				),
-				'wp_template_part_area' => array(
-					WP_TEMPLATE_PART_AREA_HEADER,
+		self::$template_part_post = $factory->post->create_and_get(
+			array(
+				'post_type'    => 'wp_template_part',
+				'post_name'    => 'my_template_part',
+				'post_title'   => 'My Template Part',
+				'post_content' => 'Content',
+				'post_excerpt' => 'Description of my template part',
+				'tax_input'    => array(
+					'wp_theme'              => array(
+						self::TEST_THEME,
+					),
+					'wp_template_part_area' => array(
+						WP_TEMPLATE_PART_AREA_HEADER,
+					),
 				),
-			),
+			)
 		);
-		self::$template_part_post = self::factory()->post->create_and_get( $template_part_args );
+
 		wp_set_post_terms( self::$template_part_post->ID, WP_TEMPLATE_PART_AREA_HEADER, 'wp_template_part_area' );
-		wp_set_post_terms( self::$template_part_post->ID, self::$test_theme, 'wp_theme' );
+		wp_set_post_terms( self::$template_part_post->ID, self::TEST_THEME, 'wp_theme' );
 	}
 
-	public function set_up() {
-		parent::set_up();
-		switch_theme( self::$test_theme );
+	public static function wpTearDownAfterClass() {
+		wp_delete_post( self::$template_post->ID );
 	}
 
-	public static function wpTearDownAfterClass() {
-		wp_delete_post( self::$post->ID );
+	public function set_up() {
+		parent::set_up();
+		switch_theme( self::TEST_THEME );
 	}
 
 	public function test_build_block_template_result_from_post() {
 		$template = _build_block_template_result_from_post(
-			self::$post,
+			self::$template_post,
 			'wp_template'
 		);
 
@@ -127,8 +137,8 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( 'single', $template->slug );
 		$this->assertSame( 'publish', $template->status );
 		$this->assertSame( 'theme', $template->source );
-		$this->assertSame( 'Single Post', $template->title );
-		$this->assertSame( 'Displays a single post.', $template->description );
+		$this->assertSame( 'Single', $template->title );
+		$this->assertSame( 'The default template for displaying any single post or attachment.', $template->description );
 		$this->assertSame( 'wp_template', $template->type );
 
 		// Test template parts.
@@ -274,53 +284,6 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( WP_TEMPLATE_PART_AREA_HEADER, $template->area );
 	}
 
-	/**
-	 * Should retrieve block templates (file and CPT)
-	 */
-	public function test_get_block_templates() {
-		function get_template_ids( $templates ) {
-			return array_map(
-				static function( $template ) {
-					return $template->id;
-				},
-				$templates
-			);
-		}
-
-		// All results.
-		$templates    = get_block_templates( array(), 'wp_template' );
-		$template_ids = get_template_ids( $templates );
-
-		// Avoid testing the entire array because the theme might add/remove templates.
-		$this->assertContains( get_stylesheet() . '//' . 'my_template', $template_ids );
-
-		// The result might change in a block theme.
-		// $this->assertContains( get_stylesheet() . '//' . 'index', $template_ids );
-
-		// Filter by slug.
-		$templates    = get_block_templates( array( 'slug__in' => array( 'my_template' ) ), 'wp_template' );
-		$template_ids = get_template_ids( $templates );
-		$this->assertSame( array( get_stylesheet() . '//' . 'my_template' ), $template_ids );
-
-		// Filter by CPT ID.
-		$templates    = get_block_templates( array( 'wp_id' => self::$post->ID ), 'wp_template' );
-		$template_ids = get_template_ids( $templates );
-		$this->assertSame( array( get_stylesheet() . '//' . 'my_template' ), $template_ids );
-
-		// Filter template part by area.
-		// Requires a block theme.
-		/*$templates    = get_block_templates( array( 'area' => WP_TEMPLATE_PART_AREA_HEADER ), 'wp_template_part' );
-		$template_ids = get_template_ids( $templates );
-		$this->assertSame(
-			array(
-				get_stylesheet() . '//' . 'my_template_part',
-				get_stylesheet() . '//' . 'header',
-			),
-			$template_ids
-		);
-		*/
-	}
-
 	/**
 	 * Should flatten nested blocks
 	 */
@@ -348,6 +311,7 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 	 * Should generate block templates export file.
 	 *
 	 * @ticket 54448
+	 * @requires extension zip
 	 */
 	function test_wp_generate_block_templates_export_file() {
 		$filename = wp_generate_block_templates_export_file();
@@ -357,10 +321,10 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		// Open ZIP file and make sure the directories exist.
 		$zip = new ZipArchive();
 		$zip->open( $filename );
-		$has_theme_dir                = $zip->locateName( 'theme/' ) !== false;
-		$has_block_templates_dir      = $zip->locateName( 'theme/templates/' ) !== false;
-		$has_block_template_parts_dir = $zip->locateName( 'theme/parts/' ) !== false;
-		$this->assertTrue( $has_theme_dir, 'theme directory exists' );
+		$has_theme_json               = $zip->locateName( 'theme.json' ) !== false;
+		$has_block_templates_dir      = $zip->locateName( 'templates/' ) !== false;
+		$has_block_template_parts_dir = $zip->locateName( 'parts/' ) !== false;
+		$this->assertTrue( $has_theme_json, 'theme.json exists' );
 		$this->assertTrue( $has_block_templates_dir, 'theme/templates directory exists' );
 		$this->assertTrue( $has_block_template_parts_dir, 'theme/parts directory exists' );
 
diff --git a/tests/block-template.php b/tests/block-template.php
index 95dab825b9..b53aa496b0 100644
--- a/tests/block-template.php
+++ b/tests/block-template.php
@@ -18,6 +18,7 @@ class Tests_Block_Template extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 		switch_theme( 'block-theme' );
+		do_action( 'setup_theme' );
 	}
 
 	public function tear_down() {
@@ -187,4 +188,42 @@ class Tests_Block_Template extends WP_UnitTestCase {
 		$resolved_template_path = locate_block_template( '', 'search', array() );
 		$this->assertSame( '', $resolved_template_path );
 	}
+
+	/**
+	 * Covers: https://github.com/WordPress/gutenberg/pull/38817.
+	 *
+	 * @ticket 55505
+	 */
+	public function test_resolve_home_block_template_default_hierarchy() {
+		$template = _resolve_home_block_template();
+
+		$this->assertSame( 'wp_template', $template['postType'] );
+		$this->assertSame( get_stylesheet() . '//index', $template['postId'] );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	public function test_resolve_home_block_template_static_homepage() {
+		$post_id = self::factory()->post->create( array( 'post_type' => 'page' ) );
+		update_option( 'show_on_front', 'page' );
+		update_option( 'page_on_front', $post_id );
+
+		$template = _resolve_home_block_template();
+
+		$this->assertSame( 'page', $template['postType'] );
+		$this->assertSame( $post_id, $template['postId'] );
+
+		delete_option( 'show_on_front', 'page' );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	public function test_resolve_home_block_template_no_resolution() {
+		switch_theme( 'stylesheetonly' );
+		$template = _resolve_home_block_template();
+
+		$this->assertNull( $template );
+	}
 }
diff --git a/tests/blocks/context.php b/tests/blocks/context.php
index d1b321ab51..04f9a88176 100644
--- a/tests/blocks/context.php
+++ b/tests/blocks/context.php
@@ -36,7 +36,7 @@ class Tests_Blocks_Context extends WP_UnitTestCase {
 			'post_excerpt' => '',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 		setup_postdata( $post );
 	}
 
diff --git a/tests/blocks/editor.php b/tests/blocks/editor.php
index 1f872bf909..53b8d96956 100644
--- a/tests/blocks/editor.php
+++ b/tests/blocks/editor.php
@@ -28,7 +28,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 			'post_title' => 'Example',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 
 		global $wp_rest_server;
 		$wp_rest_server = new Spy_REST_Server;
@@ -80,6 +80,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 	public function test_block_editor_context_no_settings() {
 		$context = new WP_Block_Editor_Context();
 
+		$this->assertSame( 'core/edit-post', $context->name );
 		$this->assertNull( $context->post );
 	}
 
@@ -89,9 +90,40 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 	public function test_block_editor_context_post() {
 		$context = new WP_Block_Editor_Context( array( 'post' => get_post() ) );
 
+		$this->assertSame( 'core/edit-post', $context->name );
 		$this->assertSame( get_post(), $context->post );
 	}
 
+	/**
+	 * @ticket 55301
+	 */
+	public function test_block_editor_context_widgets() {
+		$context = new WP_Block_Editor_Context( array( 'name' => 'core/edit-widgets' ) );
+
+		$this->assertSame( 'core/edit-widgets', $context->name );
+		$this->assertNull( $context->post );
+	}
+
+	/**
+	 * @ticket 55301
+	 */
+	public function test_block_editor_context_widgets_customizer() {
+		$context = new WP_Block_Editor_Context( array( 'name' => 'core/customize-widgets' ) );
+
+		$this->assertSame( 'core/customize-widgets', $context->name );
+		$this->assertNull( $context->post );
+	}
+
+	/**
+	 * @ticket 55301
+	 */
+	public function test_block_editor_context_site() {
+		$context = new WP_Block_Editor_Context( array( 'name' => 'core/edit-site' ) );
+
+		$this->assertSame( 'core/edit-site', $context->name );
+		$this->assertNull( $context->post );
+	}
+
 	/**
 	 * @ticket 52920
 	 * @expectedDeprecated block_categories
@@ -170,7 +202,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 	public function test_get_default_block_editor_settings() {
 		$settings = get_default_block_editor_settings();
 
-		$this->assertCount( 17, $settings );
+		$this->assertCount( 19, $settings );
 		$this->assertFalse( $settings['alignWide'] );
 		$this->assertIsArray( $settings['allowedMimeTypes'] );
 		$this->assertTrue( $settings['allowedBlockTypes'] );
@@ -217,6 +249,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 		$this->assertFalse( $settings['disableCustomColors'] );
 		$this->assertFalse( $settings['disableCustomFontSizes'] );
 		$this->assertFalse( $settings['disableCustomGradients'] );
+		$this->assertFalse( $settings['disableLayoutStyles'] );
 		$this->assertFalse( $settings['enableCustomLineHeight'] );
 		$this->assertFalse( $settings['enableCustomSpacing'] );
 		$this->assertFalse( $settings['enableCustomUnits'] );
@@ -265,6 +298,7 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 			$settings['imageSizes']
 		);
 		$this->assertIsInt( $settings['maxUploadFileSize'] );
+		$this->assertTrue( $settings['__unstableGalleryWithImageBlocks'] );
 	}
 
 	/**
diff --git a/tests/blocks/getBlockTemplates.php b/tests/blocks/getBlockTemplates.php
new file mode 100644
index 0000000000..50554479d0
--- /dev/null
+++ b/tests/blocks/getBlockTemplates.php
@@ -0,0 +1,224 @@
+<?php
+/**
+ * @group block-templates
+ *
+ * @covers ::get_block_templates
+ */
+class Tests_Blocks_GetBlockTemplates extends WP_UnitTestCase {
+
+	const TEST_THEME = 'block-theme';
+
+	/**
+	 * @var WP_Post
+	 */
+	private static $index_template;
+
+	/**
+	 * @var WP_Post
+	 */
+	private static $custom_single_post_template;
+
+	/**
+	 * @var WP_Post
+	 */
+	private static $small_header_template_part;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		/*
+		 * This template has to have the same ID ("block-theme/index") as the template
+		 * that is shipped with the "block-theme" theme. This is needed for testing purposes.
+		 */
+		self::$index_template = $factory->post->create_and_get(
+			array(
+				'post_type' => 'wp_template',
+				'post_name' => 'index',
+				'tax_input' => array(
+					'wp_theme' => array(
+						self::TEST_THEME,
+					),
+				),
+			)
+		);
+
+		wp_set_post_terms( self::$index_template->ID, self::TEST_THEME, 'wp_theme' );
+
+		self::$custom_single_post_template = $factory->post->create_and_get(
+			array(
+				'post_type'    => 'wp_template',
+				'post_name'    => 'custom-single-post-template',
+				'post_title'   => 'Custom Single Post template (modified)',
+				'post_content' => 'Content',
+				'post_excerpt' => 'Description of custom single post template',
+				'tax_input'    => array(
+					'wp_theme' => array(
+						self::TEST_THEME,
+					),
+				),
+			)
+		);
+
+		wp_set_post_terms( self::$custom_single_post_template->ID, self::TEST_THEME, 'wp_theme' );
+
+		/*
+		 * This template part has to have the same ID ("block-theme/small-header") as the template part
+		 * that is shipped with the "block-theme" theme. This is needed for testing purposes.
+		 */
+		self::$small_header_template_part = $factory->post->create_and_get(
+			array(
+				'post_type' => 'wp_template_part',
+				'post_name' => 'small-header',
+				'tax_input' => array(
+					'wp_theme'              => array(
+						self::TEST_THEME,
+					),
+					'wp_template_part_area' => array(
+						WP_TEMPLATE_PART_AREA_HEADER,
+					),
+				),
+			)
+		);
+
+		wp_set_post_terms( self::$small_header_template_part->ID, WP_TEMPLATE_PART_AREA_HEADER, 'wp_template_part_area' );
+		wp_set_post_terms( self::$small_header_template_part->ID, self::TEST_THEME, 'wp_theme' );
+	}
+
+	public static function wpTearDownAfterClass() {
+		wp_delete_post( self::$index_template->ID );
+		wp_delete_post( self::$custom_single_post_template->ID );
+		wp_delete_post( self::$small_header_template_part->ID );
+	}
+
+	public function set_up() {
+		parent::set_up();
+		switch_theme( self::TEST_THEME );
+	}
+
+	/**
+	 * Gets the template IDs from the given array.
+	 *
+	 * @param object[] $templates Array of template objects to parse.
+	 * @return string[] The template IDs.
+	 */
+	private function get_template_ids( $templates ) {
+		return array_map(
+			static function( $template ) {
+				return $template->id;
+			},
+			$templates
+		);
+	}
+
+	/**
+	 * Should retrieve block templates (file and CPT)
+	 */
+	public function test_get_block_templates() {
+		// All results.
+		$templates    = get_block_templates( array(), 'wp_template' );
+		$template_ids = $this->get_template_ids( $templates );
+
+		// Avoid testing the entire array because the theme might add/remove templates.
+		$this->assertContains( get_stylesheet() . '//' . 'custom-single-post-template', $template_ids );
+
+		// The result might change in a block theme.
+		$this->assertContains( get_stylesheet() . '//' . 'index', $template_ids );
+
+		// Filter by slug.
+		$templates    = get_block_templates( array( 'slug__in' => array( 'custom-single-post-template' ) ), 'wp_template' );
+		$template_ids = $this->get_template_ids( $templates );
+		$this->assertSame( array( get_stylesheet() . '//' . 'custom-single-post-template' ), $template_ids );
+
+		// Filter by CPT ID.
+		$templates    = get_block_templates( array( 'wp_id' => self::$custom_single_post_template->ID ), 'wp_template' );
+		$template_ids = $this->get_template_ids( $templates );
+		$this->assertSame( array( get_stylesheet() . '//' . 'custom-single-post-template' ), $template_ids );
+
+		// Filter template part by area.
+		// Requires a block theme.
+		$templates    = get_block_templates( array( 'area' => WP_TEMPLATE_PART_AREA_HEADER ), 'wp_template_part' );
+		$template_ids = $this->get_template_ids( $templates );
+		$this->assertSame(
+			array(
+				get_stylesheet() . '//' . 'small-header',
+			),
+			$template_ids
+		);
+	}
+
+	/**
+	 * @ticket 56271
+	 *
+	 * @dataProvider data_get_block_templates_returns_unique_entities
+	 *
+	 * @param string $template_type        The template type.
+	 * @param string $original_template_id ID (slug) of the default entity.
+	 * @param string $error_message        An error message to display if the test fails.
+	 */
+	public function test_get_block_templates_returns_unique_entities( $template_type, $original_template_id, $error_message ) {
+		$original_template = _get_block_template_file( $template_type, $original_template_id );
+		$this->assertNotEmpty( $original_template, 'An original (non-duplicate) template must exist for this test to work correctly.' );
+
+		$block_templates = get_block_templates( array(), $template_type );
+		$this->assertNotEmpty( $block_templates, 'get_block_templates() must return a non-empty value.' );
+
+		$block_template_ids = wp_list_pluck( $block_templates, 'id' );
+		$this->assertSame( count( array_unique( $block_template_ids ) ), count( $block_template_ids ), $error_message );
+	}
+
+	/**
+	 * Data provider for test_get_block_templates_returns_unique_entities().
+	 *
+	 * @return array
+	 */
+	public function data_get_block_templates_returns_unique_entities() {
+		return array(
+			'wp_template template type'      => array(
+				'template_type'        => 'wp_template',
+				'original_template_id' => 'index',
+				'error_message'        => 'get_block_templates() must return unique templates.',
+			),
+			'wp_template_part template type' => array(
+				'template_type'        => 'wp_template_part',
+				'original_template_id' => 'small-header',
+				'error_message'        => 'get_block_templates() must return unique template parts.',
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_block_templates_should_respect_posttypes_property
+	 * @ticket 55881
+	 *
+	 * @param string $post_type Post type for query.
+	 * @param array  $expected  Expected template IDs.
+	 */
+	public function test_get_block_templates_should_respect_posttypes_property( $post_type, $expected ) {
+		$templates = get_block_templates( array( 'post_type' => $post_type ) );
+
+		$this->assertSameSets(
+			$expected,
+			$this->get_template_ids( $templates )
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_block_templates_should_respect_posttypes_property() {
+		return array(
+			'post' => array(
+				'post_type' => 'post',
+				'expected'  => array(
+					'block-theme//custom-single-post-template',
+				),
+			),
+			'page' => array(
+				'post_type' => 'page',
+				'expected'  => array(
+					'block-theme//page-home',
+				),
+			),
+		);
+	}
+}
diff --git a/tests/blocks/register.php b/tests/blocks/register.php
index b9efb5ee68..6cec0d8158 100644
--- a/tests/blocks/register.php
+++ b/tests/blocks/register.php
@@ -8,7 +8,7 @@
  */
 
 /**
- * Tests for register_block_type(), unregister_block_type(), get_dynamic_block_names() and register_block_style().
+ * Tests for register_block_type(), unregister_block_type(), get_dynamic_block_names(), and register_block_style().
  *
  * @since 5.0.0
  *
@@ -122,9 +122,18 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 * @ticket 50263
 	 */
 	public function test_removes_block_asset_path_prefix() {
+		$result = remove_block_asset_path_prefix( 'file:block.js' );
+
+		$this->assertSame( 'block.js', $result );
+	}
+
+	/**
+	 * @ticket 54797
+	 */
+	public function test_removes_block_asset_path_prefix_and_current_directory() {
 		$result = remove_block_asset_path_prefix( 'file:./block.js' );
 
-		$this->assertSame( './block.js', $result );
+		$this->assertSame( 'block.js', $result );
 	}
 
 	/**
@@ -139,15 +148,15 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		);
 		$this->assertSame(
 			'unit-tests-my-block-script',
-			generate_block_asset_handle( $block_name, 'script' )
+			generate_block_asset_handle( $block_name, 'script', 0 )
 		);
 		$this->assertSame(
-			'unit-tests-my-block-view-script',
-			generate_block_asset_handle( $block_name, 'viewScript' )
+			'unit-tests-my-block-view-script-100',
+			generate_block_asset_handle( $block_name, 'viewScript', 99 )
 		);
 		$this->assertSame(
-			'unit-tests-my-block-editor-style',
-			generate_block_asset_handle( $block_name, 'editorStyle' )
+			'unit-tests-my-block-editor-style-2',
+			generate_block_asset_handle( $block_name, 'editorStyle', 1 )
 		);
 		$this->assertSame(
 			'unit-tests-my-block-style',
@@ -167,15 +176,15 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		);
 		$this->assertSame(
 			'wp-block-paragraph',
-			generate_block_asset_handle( $block_name, 'script' )
+			generate_block_asset_handle( $block_name, 'script', 0 )
 		);
 		$this->assertSame(
-			'wp-block-paragraph-view',
-			generate_block_asset_handle( $block_name, 'viewScript' )
+			'wp-block-paragraph-view-100',
+			generate_block_asset_handle( $block_name, 'viewScript', 99 )
 		);
 		$this->assertSame(
-			'wp-block-paragraph-editor',
-			generate_block_asset_handle( $block_name, 'editorStyle' )
+			'wp-block-paragraph-editor-2',
+			generate_block_asset_handle( $block_name, 'editorStyle', 1 )
 		);
 		$this->assertSame(
 			'wp-block-paragraph',
@@ -195,13 +204,27 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	/**
 	 * @ticket 50263
 	 */
-	public function test_empty_value_register_block_script_handle() {
+	public function test_empty_string_value_do_not_register_block_script_handle() {
 		$metadata = array( 'script' => '' );
 		$result   = register_block_script_handle( $metadata, 'script' );
 
 		$this->assertFalse( $result );
 	}
 
+	public function test_empty_array_value_do_not_register_block_script_handle() {
+		$metadata = array( 'script' => array() );
+		$result   = register_block_script_handle( $metadata, 'script' );
+
+		$this->assertFalse( $result );
+	}
+
+	public function test_wrong_array_index_do_not_register_block_script_handle() {
+		$metadata = array( 'script' => array( 'test-script-handle' ) );
+		$result   = register_block_script_handle( $metadata, 'script', 1 );
+
+		$this->assertFalse( $result );
+	}
+
 	/**
 	 * @expectedIncorrectUsage register_block_script_handle
 	 * @ticket 50263
@@ -222,11 +245,23 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 */
 	public function test_handle_passed_register_block_script_handle() {
 		$metadata = array(
-			'editorScript' => 'test-script-handle',
+			'script' => 'test-script-handle',
+		);
+		$result   = register_block_script_handle( $metadata, 'script' );
+
+		$this->assertSame( 'test-script-handle', $result );
+	}
+
+	public function test_handles_passed_register_block_script_handles() {
+		$metadata = array(
+			'script' => array( 'test-script-handle', 'test-script-handle-2' ),
 		);
-		$result   = register_block_script_handle( $metadata, 'editorScript' );
 
+		$result = register_block_script_handle( $metadata, 'script' );
 		$this->assertSame( 'test-script-handle', $result );
+
+		$result = register_block_script_handle( $metadata, 'script', 1 );
+		$this->assertSame( 'test-script-handle-2', $result, 1 );
 	}
 
 	/**
@@ -243,6 +278,23 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$this->assertSame( 'unit-tests-test-block-script', $result );
 	}
 
+	/**
+	 * @ticket 55513
+	 */
+	public function test_success_register_block_script_handle_in_theme() {
+		switch_theme( 'block-theme' );
+
+		$metadata = array(
+			'file'       => wp_normalize_path( get_theme_file_path( 'blocks/example-block/block.json' ) ),
+			'name'       => 'block-theme/example-block',
+			'viewScript' => 'file:./view.js',
+		);
+		$result   = register_block_script_handle( $metadata, 'viewScript' );
+
+		$expected_script_handle = 'block-theme-example-block-view-script';
+		$this->assertSame( $expected_script_handle, $result );
+	}
+
 	/**
 	 * @ticket 50263
 	 */
@@ -255,13 +307,27 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	/**
 	 * @ticket 50263
 	 */
-	public function test_empty_value_found_register_block_style_handle() {
+	public function test_empty_string_value_do_not_register_block_style_handle() {
 		$metadata = array( 'style' => '' );
 		$result   = register_block_style_handle( $metadata, 'style' );
 
 		$this->assertFalse( $result );
 	}
 
+	public function test_empty_array_value_do_not_register_block_style_handle() {
+		$metadata = array( 'style' => array() );
+		$result   = register_block_style_handle( $metadata, 'style' );
+
+		$this->assertFalse( $result );
+	}
+
+	public function test_wrong_array_index_do_not_register_block_style_handle() {
+		$metadata = array( 'style' => array( 'test-style-handle' ) );
+		$result   = register_block_style_handle( $metadata, 'style', 1 );
+
+		$this->assertFalse( $result );
+	}
+
 	/**
 	 * @ticket 50263
 	 */
@@ -274,6 +340,18 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$this->assertSame( 'test-style-handle', $result );
 	}
 
+	public function test_handles_passed_register_block_style_handles() {
+		$metadata = array(
+			'style' => array( 'test-style-handle', 'test-style-handle-2' ),
+		);
+
+		$result = register_block_style_handle( $metadata, 'style' );
+		$this->assertSame( 'test-style-handle', $result );
+
+		$result = register_block_style_handle( $metadata, 'style', 1 );
+		$this->assertSame( 'test-style-handle-2', $result, 1 );
+	}
+
 	/**
 	 * @ticket 50263
 	 * @ticket 50328
@@ -296,6 +374,24 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 55513
+	 */
+	public function test_success_register_block_style_handle_in_theme() {
+		switch_theme( 'block-theme' );
+
+		$metadata = array(
+			'file'        => wp_normalize_path( get_theme_file_path( 'blocks/example-block/block.json' ) ),
+			'name'        => 'block-theme/example-block',
+			'editorStyle' => 'file:./editor-style.css',
+		);
+		$result   = register_block_style_handle( $metadata, 'editorStyle' );
+
+		$expected_style_handle = 'block-theme-example-block-editor-style';
+		$this->assertSame( $expected_style_handle, $result );
+		$this->assertSame( 'replace', wp_styles()->get_data( $expected_style_handle, 'rtl' ) );
+	}
+
 	/**
 	 * Tests that the function returns false when the `block.json` is not found
 	 * in the WordPress core.
@@ -337,17 +433,17 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$this->assertSame( 'tests/notice', $result->name );
 		$this->assertSame( 'Notice', $result->title );
 		$this->assertSame( 'common', $result->category );
-		$this->assertSameSets( array( 'core/group' ), $result->parent );
+		$this->assertSameSets( array( 'tests/group' ), $result->parent );
+		$this->assertSameSets( array( 'tests/section' ), $result->ancestor );
 		$this->assertSame( 'star', $result->icon );
 		$this->assertSame( 'Shows warning, error or success notices…', $result->description );
 		$this->assertSameSets( array( 'alert', 'message' ), $result->keywords );
 		$this->assertSame(
 			array(
 				'message' => array(
-					'type'     => 'string',
-					'source'   => 'html',
-					'selector' => '.message',
+					'type' => 'string',
 				),
+				'lock'    => array( 'type' => 'object' ),
 			),
 			$result->attributes
 		);
@@ -398,17 +494,35 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 			),
 			$result->example
 		);
-		$this->assertSame( 'tests-notice-editor-script', $result->editor_script );
-		$this->assertSame( 'tests-notice-script', $result->script );
-		$this->assertSame( 'tests-notice-view-script', $result->view_script );
-		$this->assertSame( 'tests-notice-editor-style', $result->editor_style );
-		$this->assertSame( 'tests-notice-style', $result->style );
+		$this->assertSameSets(
+			array( 'tests-notice-editor-script' ),
+			$result->editor_script_handles
+		);
+		$this->assertSameSets(
+			array( 'tests-notice-script' ),
+			$result->script_handles
+		);
+		$this->assertSameSets(
+			array( 'tests-notice-view-script', 'tests-notice-view-script-2' ),
+			$result->view_script_handles
+		);
+		$this->assertSameSets(
+			array( 'tests-notice-editor-style' ),
+			$result->editor_style_handles
+		);
+		$this->assertSameSets(
+			array( 'tests-notice-style', 'tests-notice-style-2' ),
+			$result->style_handles
+		);
 
 		// @ticket 50328
 		$this->assertSame(
 			wp_normalize_path( realpath( DIR_TESTDATA . '/blocks/notice/block.css' ) ),
 			wp_normalize_path( wp_styles()->get_data( 'unit-tests-test-block-style', 'path' ) )
 		);
+
+		// @ticket 53148
+		$this->assertIsCallable( $result->render_callback );
 	}
 
 	/**
@@ -506,6 +620,21 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		$this->assertFalse( has_blocks( $content ) );
 	}
 
+	/**
+	 * Tests that `has_blocks()` returns `false` with an invalid post.
+	 *
+	 * @ticket 55705
+	 *
+	 * @covers ::has_blocks
+	 */
+	public function test_has_blocks_with_invalid_post() {
+		$a_post = (object) array(
+			'ID'     => 55705,
+			'filter' => 'display',
+		);
+		$this->assertFalse( has_blocks( $a_post ) );
+	}
+
 	/**
 	 * @ticket 49615
 	 */
@@ -564,7 +693,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 * Test case to validate `_doing_it_wrong()` when block style name attribute
 	 * contains one or more spaces.
 	 *
-	 * @dataProvider data_register_block_style_name_contain_spaces
+	 * @dataProvider data_register_block_style_name_contains_spaces
 	 *
 	 * @ticket 54296
 	 *
@@ -573,7 +702,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 * @expectedIncorrectUsage WP_Block_Styles_Registry::register
 	 * @param array $block_styles Array of block styles to test.
 	 */
-	public function test_register_block_style_name_contain_spaces( array $block_styles ) {
+	public function test_register_block_style_name_contains_spaces( array $block_styles ) {
 		register_block_style( 'core/query', $block_styles );
 	}
 
@@ -582,7 +711,7 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function data_register_block_style_name_contain_spaces() {
+	public function data_register_block_style_name_contains_spaces() {
 		return array(
 			'multiple spaces' => array(
 				array(
diff --git a/tests/blocks/render.php b/tests/blocks/render.php
index 373217bd74..e119517d4e 100644
--- a/tests/blocks/render.php
+++ b/tests/blocks/render.php
@@ -47,6 +47,9 @@ class Tests_Blocks_Render extends WP_UnitTestCase {
 		if ( $registry->is_registered( 'core/dynamic' ) ) {
 			$registry->unregister( 'core/dynamic' );
 		}
+		if ( $registry->is_registered( 'tests/notice' ) ) {
+			$registry->unregister( 'tests/notice' );
+		}
 
 		parent::tear_down();
 	}
@@ -219,16 +222,37 @@ class Tests_Blocks_Render extends WP_UnitTestCase {
 			}
 		}
 
-		$html          = do_blocks( self::strip_r( file_get_contents( $html_path ) ) );
-		$expected_html = self::strip_r( file_get_contents( $server_html_path ) );
+		$html = do_blocks( self::strip_r( file_get_contents( $html_path ) ) );
+		// If blocks opt into Gutenberg's layout implementation
+		// the container will receive an added classname of `wp_unique_id( 'wp-container-' )`
+		// so we need to normalize the random id.
+		$normalized_html = preg_replace( '/wp-container-\d+/', 'wp-container-1', $html );
+
+		// The gallery block uses a unique class name of `wp_unique_id( 'wp-block-gallery-' )`
+		// so we need to normalize the random id.
+		$normalized_html = preg_replace( '/wp-block-gallery-\d+/', 'wp-block-gallery-1', $normalized_html );
+		$expected_html   = self::strip_r( file_get_contents( $server_html_path ) );
 
 		$this->assertSame(
 			$expected_html,
-			$html,
+			$normalized_html,
 			"File '$html_path' does not match expected value"
 		);
 	}
 
+	/**
+	 * @ticket 53148
+	 */
+	public function test_render_field_in_block_json() {
+		$result = register_block_type(
+			DIR_TESTDATA . '/blocks/notice'
+		);
+
+		$actual_content = do_blocks( '<!-- wp:tests/notice {"message":"Hello from the test"} --><!-- /wp:tests/notice -->' );
+		$this->assertSame( '<p class="wp-block-tests-notice">Hello from the test</p>', trim( $actual_content ) );
+	}
+
+
 	/**
 	 * @ticket 45109
 	 */
diff --git a/tests/blocks/renderCommentTemplate.php b/tests/blocks/renderCommentTemplate.php
new file mode 100644
index 0000000000..848b2caf38
--- /dev/null
+++ b/tests/blocks/renderCommentTemplate.php
@@ -0,0 +1,521 @@
+<?php
+/**
+ * Comment Template block rendering tests.
+ *
+ * @package WordPress
+ * @subpackage Blocks
+ * @since 6.0.0
+ */
+
+/**
+ * Tests for the Comment Template block.
+ *
+ * @since 6.0.0
+ *
+ * @group blocks
+ */
+class Tests_Blocks_RenderReusableCommentTemplate extends WP_UnitTestCase {
+
+	private static $custom_post;
+	private static $comment_ids;
+	private static $per_page = 5;
+
+	/**
+	 * Array of the comments options and their original values.
+	 * Used to reset the options after each test.
+	 *
+	 * @var array
+	 */
+	private static $original_options;
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		// Store the original option values.
+		$options = array(
+			'comment_order',
+			'comments_per_page',
+			'default_comments_page',
+			'page_comments',
+			'previous_default_page',
+			'thread_comments_depth',
+		);
+		foreach ( $options as $option ) {
+			static::$original_options[ $option ] = get_option( $option );
+		}
+	}
+
+	public function tear_down() {
+		// Reset the comment options to their original values.
+		foreach ( static::$original_options as $option => $original_value ) {
+			update_option( $option, $original_value );
+		}
+
+		parent::tear_down();
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		update_option( 'page_comments', true );
+		update_option( 'comments_per_page', self::$per_page );
+
+		self::$custom_post = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'dogs',
+				'post_status'  => 'publish',
+				'post_name'    => 'metaldog',
+				'post_title'   => 'Metal Dog',
+				'post_content' => 'Metal Dog content',
+				'post_excerpt' => 'Metal Dog',
+			)
+		);
+
+		self::$comment_ids = self::factory()->comment->create_post_comments(
+			self::$custom_post->ID,
+			1,
+			array(
+				'comment_author'       => 'Test',
+				'comment_author_email' => 'test@example.org',
+				'comment_author_url'   => 'http://example.com/author-url/',
+				'comment_content'      => 'Hello world',
+			)
+		);
+	}
+
+	/**
+	 * @ticket 55505
+	 * @covers ::build_comment_query_vars_from_block
+	 */
+	function test_build_comment_query_vars_from_block_with_context() {
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'orderby'       => 'comment_date_gmt',
+				'order'         => 'ASC',
+				'status'        => 'approve',
+				'no_found_rows' => false,
+				'post_id'       => self::$custom_post->ID,
+				'hierarchical'  => 'threaded',
+				'number'        => 5,
+				'paged'         => 1,
+			),
+			build_comment_query_vars_from_block( $block )
+		);
+	}
+
+	/**
+	 * @ticket 55567
+	 * @covers ::build_comment_query_vars_from_block
+	 */
+	function test_build_comment_query_vars_from_block_with_context_no_pagination() {
+		update_option( 'page_comments', false );
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'orderby'       => 'comment_date_gmt',
+				'order'         => 'ASC',
+				'status'        => 'approve',
+				'no_found_rows' => false,
+				'post_id'       => self::$custom_post->ID,
+				'hierarchical'  => 'threaded',
+			),
+			build_comment_query_vars_from_block( $block )
+		);
+	}
+
+	/**
+	 * @ticket 55505
+	 * @covers ::build_comment_query_vars_from_block
+	 */
+	function test_build_comment_query_vars_from_block_no_context() {
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block( $parsed_blocks[0] );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'orderby'       => 'comment_date_gmt',
+				'order'         => 'ASC',
+				'status'        => 'approve',
+				'no_found_rows' => false,
+				'hierarchical'  => 'threaded',
+				'number'        => 5,
+				'paged'         => 1,
+			),
+			build_comment_query_vars_from_block( $block )
+		);
+	}
+
+	/**
+	 * Test that if pagination is set to display the last page by default (i.e. newest comments),
+	 * the query is set to look for page 1 (rather than page 0, which would cause an error).
+	 *
+	 * Regression: https://github.com/WordPress/gutenberg/issues/40758.
+	 *
+	 * @ticket 55658
+	 * @covers ::build_comment_query_vars_from_block
+	 */
+	function test_build_comment_query_vars_from_block_pagination_with_no_comments() {
+		$comments_per_page     = get_option( 'comments_per_page' );
+		$default_comments_page = get_option( 'default_comments_page' );
+
+		update_option( 'comments_per_page', 50 );
+		update_option( 'previous_default_page', 'newest' );
+
+		$post_without_comments = self::factory()->post->create_and_get(
+			array(
+				'post_type'    => 'post',
+				'post_status'  => 'publish',
+				'post_name'    => 'fluffycat',
+				'post_title'   => 'Fluffy Cat',
+				'post_content' => 'Fluffy Cat content',
+				'post_excerpt' => 'Fluffy Cat',
+			)
+		);
+
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => $post_without_comments->ID,
+			)
+		);
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'orderby'       => 'comment_date_gmt',
+				'order'         => 'ASC',
+				'status'        => 'approve',
+				'no_found_rows' => false,
+				'post_id'       => $post_without_comments->ID,
+				'hierarchical'  => 'threaded',
+				'number'        => 50,
+			),
+			build_comment_query_vars_from_block( $block )
+		);
+	}
+
+
+	/**
+	 * Test that both "Older Comments" and "Newer Comments" are displayed in the correct order
+	 * inside the Comment Query Loop when we enable pagination on Discussion Settings.
+	 * In order to do that, it should exist a query var 'cpage' set with the $comment_args['paged'] value.
+	 *
+	 * @ticket 55505
+	 * @covers ::build_comment_query_vars_from_block
+	 */
+	function test_build_comment_query_vars_from_block_sets_cpage_var() {
+
+		// This could be any number, we set a fixed one instead of a random for better performance.
+		$comment_query_max_num_pages = 5;
+		// We subtract 1 because we created 1 comment at the beginning.
+		$post_comments_numbers = ( self::$per_page * $comment_query_max_num_pages ) - 1;
+		self::factory()->comment->create_post_comments(
+			self::$custom_post->ID,
+			$post_comments_numbers,
+			array(
+				'comment_author'       => 'Test',
+				'comment_author_email' => 'test@example.org',
+				'comment_author_url'   => 'http://example.com/author-url/',
+				'comment_content'      => 'Hello world',
+			)
+		);
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block  = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId'           => self::$custom_post->ID,
+				'comments/inherit' => true,
+			)
+		);
+		$actual = build_comment_query_vars_from_block( $block );
+		$this->assertSame( $comment_query_max_num_pages, $actual['paged'] );
+		$this->assertSame( $comment_query_max_num_pages, get_query_var( 'cpage' ) );
+	}
+
+	/**
+	 * Test rendering a single comment
+	 *
+	 * @ticket 55567
+	 */
+	function test_rendering_comment_template() {
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+
+		$this->assertSame(
+			str_replace( array( "\n", "\t" ), '', '<ol class="wp-block-comment-template"><li id="comment-' . self::$comment_ids[0] . '" class="comment even thread-even depth-1"><div class="wp-block-comment-author-name"><a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >Test</a></div><div class="wp-block-comment-content"><p>Hello world</p></div></li></ol>' ),
+			str_replace( array( "\n", "\t" ), '', $block->render() )
+		);
+	}
+
+	/**
+	 * Test rendering nested comments:
+	 *
+	 * └─ comment 1
+	 *    └─ comment 2
+	 *       └─ comment 4
+	 *    └─ comment 3
+	 *
+	 * @ticket 55567
+	 */
+	function test_rendering_comment_template_nested() {
+		$first_level_ids = self::factory()->comment->create_post_comments(
+			self::$custom_post->ID,
+			2,
+			array(
+				'comment_parent'       => self::$comment_ids[0],
+				'comment_author'       => 'Test',
+				'comment_author_email' => 'test@example.org',
+				'comment_author_url'   => 'http://example.com/author-url/',
+				'comment_content'      => 'Hello world',
+			)
+		);
+
+		$second_level_ids = self::factory()->comment->create_post_comments(
+			self::$custom_post->ID,
+			1,
+			array(
+				'comment_parent'       => $first_level_ids[0],
+				'comment_author'       => 'Test',
+				'comment_author_email' => 'test@example.org',
+				'comment_author_url'   => 'http://example.com/author-url/',
+				'comment_content'      => 'Hello world',
+			)
+		);
+
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+
+		$top_level_ids = self::$comment_ids;
+		$expected      = str_replace(
+			array( "\n", "\t" ),
+			'',
+			<<<END
+				<ol class="wp-block-comment-template">
+					<li id="comment-{$top_level_ids[0]}" class="comment even thread-even depth-1">
+						<div class="wp-block-comment-author-name">
+							<a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >
+								Test
+							</a>
+						</div>
+						<div class="wp-block-comment-content">
+							<p>Hello world</p>
+						</div>
+						<ol>
+							<li id="comment-{$first_level_ids[0]}" class="comment odd alt depth-2">
+								<div class="wp-block-comment-author-name">
+									<a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >
+										Test
+									</a>
+								</div>
+								<div class="wp-block-comment-content">
+									<p>Hello world</p>
+								</div>
+								<ol>
+									<li id="comment-{$second_level_ids[0]}" class="comment even depth-3">
+										<div class="wp-block-comment-author-name">
+											<a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >
+												Test
+											</a>
+										</div>
+										<div class="wp-block-comment-content">
+											<p>Hello world</p>
+										</div>
+									</li>
+								</ol>
+							</li>
+							<li id="comment-{$first_level_ids[1]}" class="comment odd alt depth-2">
+								<div class="wp-block-comment-author-name">
+									<a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >
+										Test
+									</a>
+								</div>
+								<div class="wp-block-comment-content">
+									<p>Hello world</p>
+								</div>
+							</li>
+						</ol>
+					</li>
+				</ol>
+END
+		);
+
+		$this->assertSame(
+			$expected,
+			str_replace( array( "\n", "\t" ), '', $block->render() )
+		);
+	}
+
+	/**
+	 * Test that line and paragraph breaks are converted to HTML tags in a comment.
+	 *
+	 * @ticket 55643
+	 */
+	function test_render_block_core_comment_content_converts_to_html() {
+		$comment_id  = self::$comment_ids[0];
+		$new_content = "Paragraph One\n\nP2L1\nP2L2\n\nhttps://example.com/";
+		self::factory()->comment->update_object(
+			$comment_id,
+			array( 'comment_content' => $new_content )
+		);
+
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId'           => self::$custom_post->ID,
+				'comments/inherit' => true,
+			)
+		);
+
+		$expected_content = "<p>Paragraph One</p>\n<p>P2L1<br />\nP2L2</p>\n<p><a href=\"https://example.com/\" rel=\"nofollow ugc\">https://example.com/</a></p>\n";
+
+		$this->assertSame(
+			'<ol class="wp-block-comment-template"><li id="comment-' . self::$comment_ids[0] . '" class="comment even thread-even depth-1"><div class="wp-block-comment-content">' . $expected_content . '</div></li></ol>',
+			$block->render()
+		);
+	}
+
+	/**
+	 * Test that unapproved comments are included if it is a preview.
+	 *
+	 * @ticket 55634
+	 * @covers ::build_comment_query_vars_from_block
+	 */
+	function test_build_comment_query_vars_from_block_with_comment_preview() {
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+
+		$commenter_filter = function () {
+			return array(
+				'comment_author_email' => 'unapproved@example.org',
+			);
+		};
+
+		add_filter( 'wp_get_current_commenter', $commenter_filter );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'orderby'            => 'comment_date_gmt',
+				'order'              => 'ASC',
+				'status'             => 'approve',
+				'no_found_rows'      => false,
+				'include_unapproved' => array( 'unapproved@example.org' ),
+				'post_id'            => self::$custom_post->ID,
+				'hierarchical'       => 'threaded',
+				'number'             => 5,
+				'paged'              => 1,
+			),
+			build_comment_query_vars_from_block( $block )
+		);
+	}
+
+	/**
+	 * Test rendering an unapproved comment preview.
+	 *
+	 * @ticket 55643
+	 */
+	function test_rendering_comment_template_unmoderated_preview() {
+		$parsed_blocks = parse_blocks(
+			'<!-- wp:comment-template --><!-- wp:comment-author-name /--><!-- wp:comment-content /--><!-- /wp:comment-template -->'
+		);
+
+		$unapproved_comment = self::factory()->comment->create_post_comments(
+			self::$custom_post->ID,
+			1,
+			array(
+				'comment_author'       => 'Visitor',
+				'comment_author_email' => 'unapproved@example.org',
+				'comment_author_url'   => 'http://example.com/unapproved/',
+				'comment_content'      => 'Hi there! My comment needs moderation.',
+				'comment_approved'     => 0,
+			)
+		);
+
+		$block = new WP_Block(
+			$parsed_blocks[0],
+			array(
+				'postId' => self::$custom_post->ID,
+			)
+		);
+
+		$commenter_filter = static function () {
+			return array(
+				'comment_author_email' => 'unapproved@example.org',
+			);
+		};
+
+		add_filter( 'wp_get_current_commenter', $commenter_filter );
+
+		$this->assertSame(
+			'<ol class="wp-block-comment-template"><li id="comment-' . self::$comment_ids[0] . '" class="comment even thread-even depth-1"><div class="wp-block-comment-author-name"><a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >Test</a></div><div class="wp-block-comment-content"><p>Hello world</p></div></li><li id="comment-' . $unapproved_comment[0] . '" class="comment odd alt thread-odd thread-alt depth-1"><div class="wp-block-comment-author-name">Visitor</div><div class="wp-block-comment-content"><p><em class="comment-awaiting-moderation">Your comment is awaiting moderation.</em></p>Hi there! My comment needs moderation.</div></li></ol>',
+			str_replace( array( "\n", "\t" ), '', $block->render() ),
+			'Should include unapproved comments when filter applied'
+		);
+
+		remove_filter( 'wp_get_current_commenter', $commenter_filter );
+
+		// Test it again and ensure the unmoderated comment doesn't leak out.
+		$this->assertSame(
+			'<ol class="wp-block-comment-template"><li id="comment-' . self::$comment_ids[0] . '" class="comment even thread-even depth-1"><div class="wp-block-comment-author-name"><a rel="external nofollow ugc" href="http://example.com/author-url/" target="_self" >Test</a></div><div class="wp-block-comment-content"><p>Hello world</p></div></li></ol>',
+			str_replace( array( "\n", "\t" ), '', $block->render() ),
+			'Should not include any unapproved comments after removing filter'
+		);
+	}
+}
diff --git a/tests/blocks/supportedStyles.php b/tests/blocks/supportedStyles.php
index bdbf91aa2e..0722e995d6 100644
--- a/tests/blocks/supportedStyles.php
+++ b/tests/blocks/supportedStyles.php
@@ -220,7 +220,7 @@ class Tests_Blocks_SupportedStyles extends WP_UnitTestCase {
 			'innerHTML'    => array(),
 		);
 
-		$expected_styles  = 'test: style; color: #000; background-color: #fff;';
+		$expected_styles  = 'test: style;color:#000;background-color:#fff;';
 		$expected_classes = 'foo-bar-class wp-block-example has-text-color has-background';
 
 		$this->assert_content_and_styles_and_classes_match( $block, $expected_classes, $expected_styles );
@@ -283,7 +283,7 @@ class Tests_Blocks_SupportedStyles extends WP_UnitTestCase {
 		);
 
 		$expected_classes = 'foo-bar-class wp-block-example has-background';
-		$expected_styles  = 'test: style; background: some-gradient-style;';
+		$expected_styles  = 'test: style; background:some-gradient-style;';
 
 		$this->assert_content_and_styles_and_classes_match( $block, $expected_classes, $expected_styles );
 	}
@@ -563,7 +563,7 @@ class Tests_Blocks_SupportedStyles extends WP_UnitTestCase {
 		);
 
 		$expected_classes = 'foo-bar-class wp-block-example has-text-color has-background alignwide';
-		$expected_styles  = 'test: style; color: #000; background-color: #fff; font-size: 10px; line-height: 20;';
+		$expected_styles  = 'test: style; color:#000; background-color:#fff; font-size: 10px; line-height: 20;';
 
 		$this->assert_content_and_styles_and_classes_match( $block, $expected_classes, $expected_styles );
 	}
diff --git a/tests/blocks/wpBlock.php b/tests/blocks/wpBlock.php
index eb3fd1b769..c67a30df9d 100644
--- a/tests/blocks/wpBlock.php
+++ b/tests/blocks/wpBlock.php
@@ -82,8 +82,14 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$block        = new WP_Block( $parsed_block, $context, $this->registry );
 
 		$this->assertInstanceOf( WP_Block_Type::class, $block->block_type );
-		$this->assertSame(
-			$block_type_settings['attributes'],
+		$this->assertSameSetsWithIndex(
+			array(
+				'defaulted' => array(
+					'type'    => 'number',
+					'default' => 10,
+				),
+				'lock'      => array( 'type' => 'object' ),
+			),
 			$block->block_type->attributes
 		);
 	}
@@ -431,6 +437,7 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 				'categoryIds' => array( 56 ),
 				'orderBy'     => 'title',
 				'tagIds'      => array( 3, 11, 10 ),
+				'parents'     => array( 1, 2 ),
 			),
 		);
 		$block         = new WP_Block( $parsed_block, $context, $this->registry );
@@ -439,12 +446,23 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		$this->assertSame(
 			$query,
 			array(
-				'post_type'    => 'page',
-				'order'        => 'DESC',
-				'orderby'      => 'title',
-				'post__not_in' => array( 1, 2 ),
-				'category__in' => array( 56 ),
-				'tag__in'      => array( 3, 11, 10 ),
+				'post_type'       => 'page',
+				'order'           => 'DESC',
+				'orderby'         => 'title',
+				'post__not_in'    => array( 1, 2 ),
+				'tax_query'       => array(
+					array(
+						'taxonomy'         => 'category',
+						'terms'            => array( 56 ),
+						'include_children' => false,
+					),
+					array(
+						'taxonomy'         => 'post_tag',
+						'terms'            => array( 3, 11, 10 ),
+						'include_children' => false,
+					),
+				),
+				'post_parent__in' => array( 1, 2 ),
 			)
 		);
 	}
@@ -568,6 +586,42 @@ class Tests_Blocks_wpBlock extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 56467
+	 */
+	public function test_query_loop_block_query_vars_filter() {
+		$this->registry->register(
+			'core/example',
+			array( 'uses_context' => array( 'query' ) )
+		);
+
+		$parsed_blocks = parse_blocks( '<!-- wp:example {"ok":true} -->a<!-- wp:example /-->b<!-- /wp:example -->' );
+		$parsed_block  = $parsed_blocks[0];
+		$context       = array(
+			'query' => array(
+				'postType' => 'page',
+				'orderBy'  => 'title',
+			),
+		);
+		$block         = new WP_Block( $parsed_block, $context, $this->registry );
+		function filterQuery( $query, $block, $page ) {
+			$query['post_type'] = 'book';
+			return $query;
+		}
+		add_filter( 'query_loop_block_query_vars', 'filterQuery', 10, 3 );
+		$query = build_query_vars_from_query_block( $block, 1 );
+		remove_filter( 'query_loop_block_query_vars', 'filterQuery' );
+		$this->assertSame(
+			$query,
+			array(
+				'post_type'    => 'book',
+				'order'        => 'DESC',
+				'orderby'      => 'title',
+				'post__not_in' => array(),
+			)
+		);
+	}
+
 	/**
 	 * @ticket 52991
 	 */
diff --git a/tests/blocks/wpBlockType.php b/tests/blocks/wpBlockType.php
index a6d83be565..28eb8f1edf 100644
--- a/tests/blocks/wpBlockType.php
+++ b/tests/blocks/wpBlockType.php
@@ -84,6 +84,46 @@ class Tests_Blocks_wpBlockType extends WP_UnitTestCase {
 		$this->assertSame( $args['foo'], $block_type->foo );
 	}
 
+	/*
+	 * @ticket 55567
+	 * @covers WP_Block_Type::set_props
+	 */
+	public function test_core_attributes() {
+		$block_type = new WP_Block_Type( 'core/fake', array() );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'lock' => array( 'type' => 'object' ),
+			),
+			$block_type->attributes
+		);
+	}
+
+	/*
+	 * @ticket 55567
+	 * @covers WP_Block_Type::set_props
+	 */
+	public function test_core_attributes_matches_custom() {
+		$block_type = new WP_Block_Type(
+			'core/fake',
+			array(
+				'attributes' => array(
+					'lock' => array(
+						'type' => 'string',
+					),
+				),
+			)
+		);
+
+		// Backward compatibility: Don't override attributes with the same name.
+		$this->assertSameSetsWithIndex(
+			array(
+				'lock' => array( 'type' => 'string' ),
+			),
+			$block_type->attributes
+		);
+	}
+
 	/**
 	 * @ticket 45097
 	 */
diff --git a/tests/bookmark/wpListBookmarks.php b/tests/bookmark/wpListBookmarks.php
index 02305e9565..ba0121fd00 100644
--- a/tests/bookmark/wpListBookmarks.php
+++ b/tests/bookmark/wpListBookmarks.php
@@ -15,11 +15,12 @@ class Tests_Functions_wpListBookmarks extends WP_UnitTestCase {
 	 *
 	 * @ticket 53839
 	 *
-	 * @param array $args The arguments to create the bookmark.
+	 * @param array $args      The arguments to create the bookmark.
+	 * @param string $expected Expected string to test.
 	 */
-	public function test_wp_list_bookmarks_adds_noopener( $args ) {
-		$bookmark = self::factory()->bookmark->create( $args );
-		$this->assertStringContainsString( 'noopener', wp_list_bookmarks( 'echo=0' ) );
+	public function test_wp_list_bookmarks_adds_noopener( $args, $expected ) {
+		self::factory()->bookmark->create( $args );
+		$this->assertStringContainsString( $expected, wp_list_bookmarks( 'echo=0' ) );
 	}
 
 	/**
@@ -30,34 +31,38 @@ class Tests_Functions_wpListBookmarks extends WP_UnitTestCase {
 	public function data_wp_list_bookmarks_adds_noopener() {
 		return array(
 			'target as "_blank"'                         => array(
-				'args' => array(
+				'args'     => array(
 					'link_name'   => 'With _blank',
 					'link_url'    => 'https://www.wordpress.org',
 					'link_target' => '_blank',
 				),
+				'expected' => 'rel="noopener"',
 			),
 			'target as "_blank" and a link relationship' => array(
-				'args' => array(
+				'args'     => array(
 					'link_name'   => 'With _blank and a link relationship',
 					'link_url'    => 'https://www.wordpress.org',
 					'link_target' => '_blank',
-					'rel'         => 'me',
+					'link_rel'    => 'me',
 				),
+				'expected' => 'rel="me noopener"',
 			),
 			'target as "_top"'                           => array(
-				'args' => array(
+				'args'     => array(
 					'link_name'   => 'With _top',
 					'link_url'    => 'https://www.wordpress.org',
 					'link_target' => '_top',
 				),
+				'expected' => 'rel="noopener"',
 			),
 			'target as "_top" and a link relationship'   => array(
-				'args' => array(
+				'args'     => array(
 					'link_name'   => 'With _top and a link relationship',
 					'link_url'    => 'https://www.wordpress.org',
 					'link_target' => '_top',
-					'rel'         => 'me',
+					'link_rel'    => 'me',
 				),
+				'expected' => 'rel="me noopener"',
 			),
 		);
 	}
@@ -72,7 +77,7 @@ class Tests_Functions_wpListBookmarks extends WP_UnitTestCase {
 	 * @param array $args The arguments to create the bookmark.
 	 */
 	public function test_wp_list_bookmarks_does_not_add_noopener( $args ) {
-		$bookmark = self::factory()->bookmark->create( $args );
+		self::factory()->bookmark->create( $args );
 		$this->assertStringNotContainsString( 'noopener', wp_list_bookmarks( 'echo=0' ) );
 	}
 
@@ -95,7 +100,7 @@ class Tests_Functions_wpListBookmarks extends WP_UnitTestCase {
 					'link_name'   => 'With _blank and a link relationship',
 					'link_url'    => 'https://www.wordpress.org',
 					'link_target' => '_none',
-					'rel'         => 'me',
+					'link_rel'    => 'me',
 				),
 			),
 		);
diff --git a/tests/cache.php b/tests/cache.php
index 26f1264242..f65096c597 100644
--- a/tests/cache.php
+++ b/tests/cache.php
@@ -8,8 +8,6 @@ class Tests_Cache extends WP_UnitTestCase {
 
 	public function set_up() {
 		parent::set_up();
-		// Create two cache objects with a shared cache directory.
-		// This simulates a typical cache situation, two separate requests interacting.
 		$this->cache =& $this->init_cache();
 	}
 
@@ -20,12 +18,62 @@ class Tests_Cache extends WP_UnitTestCase {
 
 	private function &init_cache() {
 		global $wp_object_cache;
+
 		$cache_class = get_class( $wp_object_cache );
 		$cache       = new $cache_class();
-		$cache->add_global_groups( array( 'global-cache-test', 'users', 'userlogins', 'usermeta', 'user_meta', 'useremail', 'userslugs', 'site-transient', 'site-options', 'blog-lookup', 'blog-details', 'rss', 'global-posts', 'blog-id-cache', 'networks', 'sites', 'site-details' ) );
+
+		$cache->add_global_groups( array( 'global-cache-test' ) );
+
 		return $cache;
 	}
 
+	/**
+	 * @ticket 56198
+	 *
+	 * @covers WP_Object_Cache::is_valid_key
+	 * @dataProvider data_is_valid_key
+	 */
+	public function test_is_valid_key( $key, $valid ) {
+		if ( wp_using_ext_object_cache() ) {
+			$this->markTestSkipped( 'This test requires that an external object cache is not in use.' );
+		}
+
+		$val = 'val';
+
+		if ( $valid ) {
+			$this->assertTrue( $this->cache->add( $key, $val ), 'WP_Object_Cache:add() should return true for valid keys.' );
+			$this->assertSame( $val, $this->cache->get( $key ), 'The retrieved value should match the added value.' );
+		} else {
+			$this->setExpectedIncorrectUsage( 'WP_Object_Cache::add' );
+			$this->assertFalse( $this->cache->add( $key, $val ), 'WP_Object_Cache:add() should return false for invalid keys.' );
+		}
+	}
+
+	/**
+	 * Data provider for test_is_valid_key().
+	 *
+	 * @return array[] Test parameters {
+	 *     @type mixed $key   Cache key value.
+	 *     @type bool  $valid Whether the key should be considered valid.
+	 * }
+	 */
+	public function data_is_valid_key() {
+		return array(
+			'false'          => array( false, false ),
+			'null'           => array( null, false ),
+			'line break'     => array( "\n", false ),
+			'null character' => array( "\0", false ),
+			'empty string'   => array( '', false ),
+			'single space'   => array( ' ', false ),
+			'two spaces'     => array( '  ', false ),
+			'float 0'        => array( 0.0, false ),
+			'int 0'          => array( 0, true ),
+			'int 1'          => array( 1, true ),
+			'string 0'       => array( '0', true ),
+			'string'         => array( 'key', true ),
+		);
+	}
+
 	public function test_miss() {
 		$this->assertFalse( $this->cache->get( 'test_miss' ) );
 	}
@@ -98,6 +146,28 @@ class Tests_Cache extends WP_UnitTestCase {
 		$this->assertSame( $val2, $this->cache->get( $key ) );
 	}
 
+	public function test_wp_cache_replace() {
+		$key  = 'my-key';
+		$val1 = 'first-val';
+		$val2 = 'second-val';
+
+		$fake_key = 'my-fake-key';
+
+		// Save the first value to cache and verify.
+		wp_cache_set( $key, $val1 );
+		$this->assertSame( $val1, wp_cache_get( $key ) );
+
+		// Replace the value and verify.
+		wp_cache_replace( $key, $val2 );
+		$this->assertSame( $val2, wp_cache_get( $key ) );
+
+		// Non-existent key should fail.
+		$this->assertFalse( wp_cache_replace( $fake_key, $val1 ) );
+
+		// Make sure $fake_key is not stored.
+		$this->assertFalse( wp_cache_get( $fake_key ) );
+	}
+
 	public function test_set() {
 		$key  = __FUNCTION__;
 		$val1 = 'val1';
@@ -112,9 +182,7 @@ class Tests_Cache extends WP_UnitTestCase {
 	}
 
 	public function test_flush() {
-		global $_wp_using_ext_object_cache;
-
-		if ( $_wp_using_ext_object_cache ) {
+		if ( wp_using_ext_object_cache() ) {
 			$this->markTestSkipped( 'This test requires that an external object cache is not in use.' );
 		}
 
@@ -129,6 +197,36 @@ class Tests_Cache extends WP_UnitTestCase {
 		$this->assertFalse( $this->cache->get( $key ) );
 	}
 
+	/**
+	 * @ticket 4476
+	 * @ticket 9773
+	 *
+	 * @covers ::wp_cache_flush_group
+	 */
+	public function test_wp_cache_flush_group() {
+		$key = 'my-key';
+		$val = 'my-val';
+
+		wp_cache_set( $key, $val, 'group-test' );
+		wp_cache_set( $key, $val, 'group-kept' );
+
+		$this->assertSame( $val, wp_cache_get( $key, 'group-test' ), 'group-test should contain my-val' );
+
+		if ( wp_using_ext_object_cache() ) {
+			$this->setExpectedIncorrectUsage( 'wp_cache_flush_group' );
+		}
+
+		$results = wp_cache_flush_group( 'group-test' );
+
+		if ( wp_using_ext_object_cache() ) {
+			$this->assertFalse( $results );
+		} else {
+			$this->assertTrue( $results );
+			$this->assertFalse( wp_cache_get( $key, 'group-test' ), 'group-test should return false' );
+			$this->assertSame( $val, wp_cache_get( $key, 'group-kept' ), 'group-kept should still contain my-val' );
+		}
+	}
+
 	// Make sure objects are cloned going to and from the cache.
 	public function test_object_refs() {
 		$key           = __FUNCTION__ . '_1';
@@ -309,32 +407,54 @@ class Tests_Cache extends WP_UnitTestCase {
 		}
 	}
 
-	public function test_wp_cache_replace() {
-		$key  = 'my-key';
-		$val1 = 'first-val';
-		$val2 = 'second-val';
+	/**
+	 * @ticket 54574
+	 */
+	public function test_wp_cache_add_multiple() {
+		$found = wp_cache_add_multiple(
+			array(
+				'foo1' => 'bar',
+				'foo2' => 'bar',
+				'foo3' => 'bar',
+			),
+			'group1'
+		);
 
-		$fake_key = 'my-fake-key';
+		$expected = array(
+			'foo1' => true,
+			'foo2' => true,
+			'foo3' => true,
+		);
 
-		// Save the first value to cache and verify.
-		wp_cache_set( $key, $val1 );
-		$this->assertSame( $val1, wp_cache_get( $key ) );
+		$this->assertSame( $expected, $found );
+	}
 
-		// Replace the value and verify.
-		wp_cache_replace( $key, $val2 );
-		$this->assertSame( $val2, wp_cache_get( $key ) );
+	/**
+	 * @ticket 54574
+	 */
+	public function test_wp_cache_set_multiple() {
+		$found = wp_cache_set_multiple(
+			array(
+				'foo1' => 'bar',
+				'foo2' => 'bar',
+				'foo3' => 'bar',
+			),
+			'group1'
+		);
 
-		// Non-existent key should fail.
-		$this->assertFalse( wp_cache_replace( $fake_key, $val1 ) );
+		$expected = array(
+			'foo1' => true,
+			'foo2' => true,
+			'foo3' => true,
+		);
 
-		// Make sure $fake_key is not stored.
-		$this->assertFalse( wp_cache_get( $fake_key ) );
+		$this->assertSame( $expected, $found );
 	}
 
 	/**
 	 * @ticket 20875
 	 */
-	public function test_get_multiple() {
+	public function test_wp_cache_get_multiple() {
 		wp_cache_set( 'foo1', 'bar', 'group1' );
 		wp_cache_set( 'foo2', 'bar', 'group1' );
 		wp_cache_set( 'foo1', 'bar', 'group2' );
@@ -349,4 +469,26 @@ class Tests_Cache extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, $found );
 	}
+
+	/**
+	 * @ticket 54574
+	 */
+	public function test_wp_cache_delete_multiple() {
+		wp_cache_set( 'foo1', 'bar', 'group1' );
+		wp_cache_set( 'foo2', 'bar', 'group1' );
+		wp_cache_set( 'foo3', 'bar', 'group2' );
+
+		$found = wp_cache_delete_multiple(
+			array( 'foo1', 'foo2', 'foo3' ),
+			'group1'
+		);
+
+		$expected = array(
+			'foo1' => true,
+			'foo2' => true,
+			'foo3' => false,
+		);
+
+		$this->assertSame( $expected, $found );
+	}
 }
diff --git a/tests/canonical.php b/tests/canonical.php
index 93eed462fc..63e5c4078b 100644
--- a/tests/canonical.php
+++ b/tests/canonical.php
@@ -275,6 +275,67 @@ class Tests_Canonical extends WP_Canonical_UnitTestCase {
 		$this->assertFalse( redirect_guess_404_permalink() );
 	}
 
+	/**
+	 * Ensure public posts with custom public statuses are guessed.
+	 *
+	 * @ticket 47911
+	 * @dataProvider data_redirect_guess_404_permalink_with_custom_statuses
+	 *
+	 * @covers ::redirect_guess_404_permalink
+	 */
+	public function test_redirect_guess_404_permalink_with_custom_statuses( $status_args, $redirects ) {
+		register_post_status( 'custom', $status_args );
+
+		$post = self::factory()->post->create(
+			array(
+				'post_title'  => 'custom-status-public-guess-404-permalink',
+				'post_status' => 'custom',
+			)
+		);
+
+		$this->go_to( 'custom-status-public-guess-404-permalink' );
+
+		$expected = $redirects ? get_permalink( $post ) : false;
+
+		$this->assertSame( $expected, redirect_guess_404_permalink() );
+	}
+
+	/**
+	 * Data provider for test_redirect_guess_404_permalink_with_custom_statuses().
+	 *
+	 * return array[] {
+	 *    array Arguments used to register custom status
+	 *    bool  Whether the 404 link is expected to redirect
+	 * }
+	 */
+	public function data_redirect_guess_404_permalink_with_custom_statuses() {
+		return array(
+			'public status'                      => array(
+				'status_args' => array( 'public' => true ),
+				'redirects'   => true,
+			),
+			'private status'                     => array(
+				'status_args' => array( 'public' => false ),
+				'redirects'   => false,
+			),
+			'internal status'                    => array(
+				'status_args' => array( 'internal' => true ),
+				'redirects'   => false,
+			),
+			'protected status'                   => array(
+				'status_args' => array( 'protected' => true ),
+				'redirects'   => false,
+			),
+			'protected status flagged as public' => array(
+				'status_args' => array(
+					'protected' => true,
+					'public'    => true,
+				),
+				'redirects'   => false,
+			),
+		);
+	}
+
 	/**
 	 * Ensure multiple post types do not throw a notice.
 	 *
diff --git a/tests/canonical/https.php b/tests/canonical/https.php
index 257ee5cdb2..fe6eeaed5e 100644
--- a/tests/canonical/https.php
+++ b/tests/canonical/https.php
@@ -6,6 +6,21 @@
  * @group query
  */
 class Tests_Canonical_HTTPS extends WP_Canonical_UnitTestCase {
+
+	/**
+	 * Dummy HTTP URL.
+	 *
+	 * @var string
+	 */
+	private $http = '';
+
+	/**
+	 * Dummy HTTPS URL.
+	 *
+	 * @var string
+	 */
+	private $https = '';
+
 	public function set_up() {
 		parent::set_up();
 
diff --git a/tests/canonical/stripFragmentFromUrl.php b/tests/canonical/stripFragmentFromUrl.php
new file mode 100644
index 0000000000..053ad88528
--- /dev/null
+++ b/tests/canonical/stripFragmentFromUrl.php
@@ -0,0 +1,40 @@
+<?php
+
+/**
+ * @group canonical
+ * @group rewrite
+ * @group query
+ * @covers ::strip_fragment_from_url
+ */
+class Tests_Canonical_StripFragmentFromUrl extends WP_UnitTestCase {
+
+	/**
+	 * @dataProvider data_strip_fragment_from_url
+	 * @ticket 55333
+	 */
+	public function test_strip_fragment_from_url( $test_url, $expected ) {
+		$this->assertSame( $expected, strip_fragment_from_url( $test_url ) );
+	}
+
+	/**
+	 * Data provider for test_strip_fragment_from_url().
+	 *
+	 * @return array[] {
+	 *     Data to test with.
+	 *
+	 *     @type string $0 The test URL.
+	 *     @type string $1 The expected canonical URL.
+	 * }
+	 */
+	public function data_strip_fragment_from_url() {
+		return array(
+			array( '//example.com', '//example.com' ),
+			array( 'http://example.com', 'http://example.com' ),
+			array( 'https://example.com', 'https://example.com' ),
+			array( 'https://example.com/', 'https://example.com/' ),
+			array( 'https://example.com/?test', 'https://example.com/?test' ),
+			array( 'https://example.com/?#test', 'https://example.com/' ),
+			array( 'https://example.com/?#test#', 'https://example.com/' ),
+		);
+	}
+}
diff --git a/tests/category.php b/tests/category.php
index 934c543876..1eb4f3d419 100644
--- a/tests/category.php
+++ b/tests/category.php
@@ -18,6 +18,8 @@ class Tests_Category extends WP_UnitTestCase {
 	 * Validate get_all_category_ids
 	 *
 	 * @expectedDeprecated get_all_category_ids
+	 *
+	 * @covers ::get_all_category_ids
 	 */
 	public function test_get_all_category_ids() {
 		// Ccreate categories.
@@ -34,6 +36,8 @@ class Tests_Category extends WP_UnitTestCase {
 
 	/**
 	 * Validate get_category_by_slug function
+	 *
+	 * @covers ::get_category_by_slug
 	 */
 	public function test_get_category_by_slug() {
 
@@ -64,6 +68,8 @@ class Tests_Category extends WP_UnitTestCase {
 
 	/**
 	 * Validate _make_cat_compat function
+	 *
+	 * @covers ::_make_cat_compat
 	 */
 	public function test__make_cat_compat() {
 
@@ -141,6 +147,8 @@ class Tests_Category extends WP_UnitTestCase {
 
 	/**
 	 * Validate get_cat_name function
+	 *
+	 * @covers ::get_cat_name
 	 */
 	public function test_get_cat_name() {
 
@@ -161,6 +169,8 @@ class Tests_Category extends WP_UnitTestCase {
 
 	/**
 	 * Validate get_cat_name function
+	 *
+	 * @covers ::get_cat_ID
 	 */
 	public function test_get_cat_ID() {
 
@@ -181,6 +191,8 @@ class Tests_Category extends WP_UnitTestCase {
 
 	/**
 	 * Validate get_category_by_path function
+	 *
+	 * @covers ::get_category_by_path
 	 */
 	public function test_get_category_by_path() {
 
diff --git a/tests/category/categoryDescription.php b/tests/category/categoryDescription.php
index 1af1af0c7b..a6442cb4b1 100644
--- a/tests/category/categoryDescription.php
+++ b/tests/category/categoryDescription.php
@@ -2,6 +2,7 @@
 
 /**
  * @group taxonomy
+ *
  * @covers ::category_description
  */
 class Tests_Category_CategoryDescription extends WP_UnitTestCase {
diff --git a/tests/category/getCategories.php b/tests/category/getCategories.php
index 3f2140dd24..6beb0f97a3 100644
--- a/tests/category/getCategories.php
+++ b/tests/category/getCategories.php
@@ -3,6 +3,8 @@
 /**
  * @group taxonomy
  * @group category.php
+ *
+ * @covers ::get_categories
  */
 class Tests_Category_GetCategories extends WP_UnitTestCase {
 	/**
diff --git a/tests/category/getCategoryLink.php b/tests/category/getCategoryLink.php
index 5c529d4ff8..268e7c5738 100644
--- a/tests/category/getCategoryLink.php
+++ b/tests/category/getCategoryLink.php
@@ -2,6 +2,7 @@
 
 /**
  * @group taxonomy
+ *
  * @covers ::get_category_link
  */
 class Tests_Category_GetCategoryLink extends WP_UnitTestCase {
diff --git a/tests/category/getCategoryParents.php b/tests/category/getCategoryParents.php
index ed218e9f4a..faf6630e14 100644
--- a/tests/category/getCategoryParents.php
+++ b/tests/category/getCategoryParents.php
@@ -2,6 +2,8 @@
 
 /**
  * @group taxonomy
+ *
+ * @covers ::get_category_parents
  */
 class Tests_Category_GetCategoryParents extends WP_UnitTestCase {
 	protected $c1;
diff --git a/tests/category/getTheCategoryById.php b/tests/category/getTheCategoryById.php
index 74e7388778..f927c796d8 100644
--- a/tests/category/getTheCategoryById.php
+++ b/tests/category/getTheCategoryById.php
@@ -2,6 +2,7 @@
 
 /**
  * @group taxonomy
+ *
  * @covers ::get_the_category_by_ID
  */
 class Tests_Category_GetTheCategoryById extends WP_UnitTestCase {
diff --git a/tests/category/walkerCategory.php b/tests/category/walkerCategory.php
index 92d5c3f309..2728b11131 100644
--- a/tests/category/walkerCategory.php
+++ b/tests/category/walkerCategory.php
@@ -2,6 +2,8 @@
 /**
  * @group taxonomy
  * @group walker
+ *
+ * @covers Walker_Category::start_el
  */
 class Tests_Category_Walker_Category extends WP_UnitTestCase {
 
@@ -28,7 +30,7 @@ class Tests_Category_Walker_Category extends WP_UnitTestCase {
 	 */
 	public function test_start_el_with_empty_attributes( $value, $expected ) {
 		$output   = '';
-		$category = $this->factory->category->create_and_get();
+		$category = self::factory()->category->create_and_get();
 		$link     = get_term_link( $category );
 
 		$args = array(
diff --git a/tests/category/wpDropdownCategories.php b/tests/category/wpDropdownCategories.php
index c40bd3b490..19fa298486 100644
--- a/tests/category/wpDropdownCategories.php
+++ b/tests/category/wpDropdownCategories.php
@@ -2,6 +2,8 @@
 /**
  * @group taxonomy
  * @group category.php
+ *
+ * @covers ::wp_dropdown_categories
  */
 class Tests_Category_WpDropdownCategories extends WP_UnitTestCase {
 	/**
diff --git a/tests/category/wpListCategories.php b/tests/category/wpListCategories.php
index eb21fbd484..ab76c09fc9 100644
--- a/tests/category/wpListCategories.php
+++ b/tests/category/wpListCategories.php
@@ -2,6 +2,8 @@
 
 /**
  * @group taxonomy
+ *
+ * @covers ::wp_list_categories
  */
 class Tests_Category_WpListCategories extends WP_UnitTestCase {
 	public function test_class() {
diff --git a/tests/comment-submission.php b/tests/comment-submission.php
index 26c4889926..14275494db 100644
--- a/tests/comment-submission.php
+++ b/tests/comment-submission.php
@@ -39,6 +39,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 		require_once ABSPATH . WPINC . '/class-phpass.php';
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_invalid_post_returns_error() {
 		$error = 'comment_id_not_found';
 
@@ -55,6 +58,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_post_with_closed_comments_returns_error() {
 
 		$error = 'comment_closed';
@@ -78,6 +84,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_trashed_post_returns_error() {
 
 		$error = 'comment_on_trash';
@@ -99,6 +108,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_draft_post_returns_error() {
 		$error = 'comment_on_draft';
 
@@ -124,6 +136,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 39650
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_to_draft_post_returns_error_message_for_user_with_correct_caps() {
 		$error = 'comment_on_draft';
@@ -150,6 +164,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 		$this->assertNotEmpty( $comment->get_error_message() );
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_scheduled_post_returns_error() {
 
 		// Same error as commenting on a draft.
@@ -176,6 +193,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_password_required_post_returns_error() {
 
 		$error = 'comment_on_password_protected';
@@ -199,6 +219,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_password_protected_post_succeeds() {
 		if ( PHP_VERSION_ID >= 80100 ) {
 			/*
@@ -236,6 +259,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_valid_comment_as_logged_in_user_succeeds() {
 
 		$user = self::factory()->user->create_and_get(
@@ -263,6 +289,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_valid_comment_anonymously_succeeds() {
 
 		$data    = array(
@@ -289,6 +318,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 	 * wp_handle_comment_submission() expects un-slashed data.
 	 *
 	 * @group slashes
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_handles_slashes_correctly_handles_slashes() {
 		if ( PHP_VERSION_ID >= 80100 ) {
@@ -318,6 +349,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_anonymously_to_private_post_returns_error() {
 
 		$error = 'comment_id_not_found';
@@ -339,6 +373,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_as_logged_in_user_to_inaccessible_private_post_returns_error() {
 
 		$error = 'comment_id_not_found';
@@ -369,6 +406,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_private_post_with_closed_comments_returns_correct_error() {
 
 		$error = 'comment_id_not_found';
@@ -400,6 +440,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_own_private_post_succeeds() {
 
 		wp_set_current_user( self::$author_id );
@@ -423,6 +466,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_to_accessible_private_post_succeeds() {
 
 		wp_set_current_user( self::$editor_id );
@@ -446,6 +492,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_anonymous_user_cannot_comment_unfiltered_html() {
 		if ( PHP_VERSION_ID >= 80100 ) {
 			/*
@@ -471,6 +520,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_unprivileged_user_cannot_comment_unfiltered_html() {
 
 		wp_set_current_user( self::$author_id );
@@ -489,6 +541,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_unprivileged_user_cannot_comment_unfiltered_html_even_with_valid_nonce() {
 
 		wp_set_current_user( self::$author_id );
@@ -513,6 +568,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_privileged_user_can_comment_unfiltered_html_with_valid_nonce() {
 
 		$this->assertFalse( defined( 'DISALLOW_UNFILTERED_HTML' ) );
@@ -545,6 +603,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_privileged_user_cannot_comment_unfiltered_html_without_valid_nonce() {
 
 		if ( is_multisite() ) {
@@ -569,6 +630,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_as_anonymous_user_when_registration_required_returns_error() {
 
 		$error = 'not_logged_in';
@@ -588,6 +652,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_with_no_name_when_name_email_required_returns_error() {
 
 		$error = 'require_name_email';
@@ -609,6 +676,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_with_no_email_when_name_email_required_returns_error() {
 
 		$error = 'require_name_email';
@@ -630,6 +700,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_with_invalid_email_when_name_email_required_returns_error() {
 
 		$error = 'require_valid_email';
@@ -652,6 +725,9 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_handle_comment_submission
+	 */
 	public function test_submitting_comment_with_no_comment_content_returns_error() {
 
 		$error = 'require_valid_comment';
@@ -671,6 +747,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 10377
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_with_content_too_long_returns_error() {
 		$error = 'comment_content_column_length';
@@ -689,6 +767,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 10377
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_with_author_too_long_returns_error() {
 		$error = 'comment_author_column_length';
@@ -707,6 +787,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 10377
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_with_email_too_long_returns_error() {
 		$error = 'comment_author_email_column_length';
@@ -725,6 +807,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 10377
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_with_url_too_long_returns_error() {
 		$error = 'comment_author_url_column_length';
@@ -744,6 +828,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49236
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_comment_with_empty_type_results_in_correct_type() {
 		if ( PHP_VERSION_ID >= 80100 ) {
@@ -773,6 +859,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49236
+	 *
+	 * @covers ::wp_insert_comment
 	 */
 	public function test_inserting_comment_with_empty_type_results_in_correct_type() {
 		$data       = array(
@@ -793,6 +881,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34997
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_comment_submission_sends_all_expected_parameters_to_preprocess_comment_filter() {
 
@@ -811,7 +901,7 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 		remove_filter( 'preprocess_comment', array( $this, 'filter_preprocess_comment' ) );
 
 		$this->assertNotWPError( $comment );
-		$this->assertSame(
+		$this->assertSameSetsWithIndex(
 			array(
 				'comment_post_ID'      => self::$post->ID,
 				'comment_author'       => $user->display_name,
@@ -837,6 +927,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36901
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_submitting_duplicate_comments() {
 		if ( PHP_VERSION_ID >= 80100 ) {
@@ -863,6 +955,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36901
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_comments_flood() {
 		if ( PHP_VERSION_ID >= 80100 ) {
@@ -892,6 +986,8 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36901
+	 *
+	 * @covers ::wp_handle_comment_submission
 	 */
 	public function test_comments_flood_user_is_admin() {
 		$user = self::factory()->user->create_and_get(
diff --git a/tests/comment.php b/tests/comment.php
index db21e79f10..9683110030 100644
--- a/tests/comment.php
+++ b/tests/comment.php
@@ -30,6 +30,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @covers ::wp_update_comment
+	 */
 	public function test_wp_update_comment() {
 		$post  = self::factory()->post->create_and_get(
 			array(
@@ -78,6 +81,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30627
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_updates_comment_type() {
 		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -95,6 +100,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36784
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_updates_comment_meta() {
 		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -114,6 +121,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30307
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_updates_user_id() {
 		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -131,6 +140,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34954
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_with_no_post_id() {
 		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => 0 ) );
@@ -152,6 +163,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 39732
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_returns_false_for_invalid_comment_or_post_id() {
 		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -175,6 +188,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 39732
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_is_wp_error() {
 		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -201,6 +216,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		return new WP_Error( 'comment_wrong', 'wp_update_comment_data filter fails for this comment.', 500 );
 	}
 
+	/**
+	 * @covers ::get_approved_comments
+	 */
 	public function test_get_approved_comments() {
 		$ca1 = self::factory()->comment->create(
 			array(
@@ -257,6 +275,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30412
+	 *
+	 * @covers ::get_approved_comments
 	 */
 	public function test_get_approved_comments_with_post_id_0_should_return_empty_array() {
 		$ca1 = self::factory()->comment->create(
@@ -273,6 +293,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 14279
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment_respects_dates() {
 		$data = array(
@@ -296,6 +318,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 14601
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment_respects_author_ip() {
 		$data = array(
@@ -317,6 +341,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 14601
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment_respects_author_ip_empty_string() {
 		$data = array(
@@ -338,6 +364,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 14601
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment_respects_comment_agent() {
 		$data = array(
@@ -360,6 +388,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 14601
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment_should_trim_provided_comment_agent_to_254_chars() {
 		$data = array(
@@ -382,6 +412,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 14601
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment_respects_comment_agent_empty_string() {
 		$data = array(
@@ -402,7 +434,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( $data['comment_agent'], $comment->comment_agent );
 	}
 
-
+	/**
+	 * @covers ::wp_new_comment
+	 */
 	public function test_comment_field_lengths() {
 		$data = array(
 			'comment_post_ID'      => self::$post_id,
@@ -424,6 +458,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 32566
+	 *
+	 * @covers ::wp_notify_moderator
 	 */
 	public function test_wp_notify_moderator_should_not_throw_notice_when_post_author_is_0() {
 		$p = self::factory()->post->create(
@@ -441,6 +477,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertTrue( wp_notify_moderator( $c ) );
 	}
 
+	/**
+	 * @covers ::wp_new_comment_notify_postauthor
+	 */
 	public function test_wp_new_comment_notify_postauthor_should_send_email_when_comment_is_approved() {
 		$c = self::factory()->comment->create(
 			array(
@@ -452,6 +491,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertTrue( $sent );
 	}
 
+	/**
+	 * @covers ::wp_new_comment_notify_postauthor
+	 */
 	public function test_wp_new_comment_notify_postauthor_should_not_send_email_when_comment_is_unapproved() {
 		$c = self::factory()->comment->create(
 			array(
@@ -466,6 +508,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33587
+	 *
+	 * @covers ::wp_new_comment_notify_postauthor
 	 */
 	public function test_wp_new_comment_notify_postauthor_should_not_send_email_when_comment_has_been_marked_as_spam() {
 		$c = self::factory()->comment->create(
@@ -481,6 +525,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35006
+	 *
+	 * @covers ::wp_new_comment_notify_postauthor
 	 */
 	public function test_wp_new_comment_notify_postauthor_should_not_send_email_when_comment_has_been_trashed() {
 		$c = self::factory()->comment->create(
@@ -496,6 +542,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 43805
+	 *
+	 * @covers ::wp_new_comment_notify_postauthor
 	 */
 	public function test_wp_new_comment_notify_postauthor_content_should_include_link_to_parent() {
 		$c1 = self::factory()->comment->create(
@@ -520,6 +568,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 43805
+	 *
+	 * @covers ::wp_new_comment_notify_moderator
 	 */
 	public function test_wp_new_comment_notify_moderator_content_should_include_link_to_parent() {
 		$c1 = self::factory()->comment->create(
@@ -556,6 +606,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12431
+	 *
+	 * @covers ::get_comment_meta
 	 */
 	public function test_wp_new_comment_with_meta() {
 		$c = self::factory()->comment->create(
@@ -573,6 +625,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment::get_children
 	 */
 	public function test_wp_comment_get_children_should_fill_children() {
 		$c1 = self::factory()->comment->create(
@@ -633,6 +687,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 27571
+	 *
+	 * @covers ::get_comment
 	 */
 	public function test_post_properties_should_be_lazyloaded() {
 		$c = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -664,13 +720,13 @@ class Tests_Comment extends WP_UnitTestCase {
 		/**
 		 * Set up a comment for testing.
 		 */
-		$post = $this->factory->post->create(
+		$post = self::factory()->post->create(
 			array(
 				'post_author' => self::$user_id,
 			)
 		);
 
-		$comment = $this->factory->comment->create(
+		$comment = self::factory()->comment->create(
 			array(
 				'comment_post_ID' => $post,
 			)
@@ -684,6 +740,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 761
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_notify_moderator_filter_moderation_notify_option_true_filter_false() {
 		$comment_data = $this->setup_notify_comment();
@@ -705,6 +763,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 761
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_notify_moderator_filter_moderation_notify_option_false_filter_true() {
 		$comment_data = $this->setup_notify_comment();
@@ -726,6 +786,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 761
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_notify_post_author_filter_comments_notify_option_true_filter_false() {
 
@@ -748,6 +810,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 761
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_notify_post_author_filter_comments_notify_option_false_filter_true() {
 		$comment_data = $this->setup_notify_comment();
@@ -852,6 +916,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		return $email_sent_when_comment_approved || $email_sent_when_comment_added;
 	}
 
+	/**
+	 * @covers ::_close_comments_for_old_post
+	 */
 	public function test_close_comments_for_old_post() {
 		update_option( 'close_comments_for_old_posts', true );
 		// Close comments more than one day old.
@@ -867,6 +934,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertTrue( $new_post_comment_status );
 	}
 
+	/**
+	 * @covers ::_close_comments_for_old_post
+	 */
 	public function test_close_comments_for_old_post_undated_draft() {
 		$draft_id             = self::factory()->post->create(
 			array(
@@ -881,6 +951,8 @@ class Tests_Comment extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35276
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment_author_id_and_agent() {
 
@@ -917,6 +989,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( 'SHIELD_AGENT', $updated->comment_agent );
 	}
 
+	/**
+	 * @covers ::wp_get_comment_fields_max_lengths
+	 */
 	public function test_wp_get_comment_fields_max_lengths() {
 		$expected = array(
 			'comment_author'       => 245,
@@ -937,6 +1012,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43442
+	 *
+	 * @covers ::wp_comments_personal_data_eraser
 	 */
 	public function test_wp_comments_personal_data_eraser() {
 
@@ -994,6 +1071,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43442
+	 *
+	 * @covers ::wp_comments_personal_data_eraser
 	 */
 	public function test_wp_comments_personal_data_eraser_empty_first_page_output() {
 
@@ -1013,6 +1092,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43442
+	 *
+	 * @covers ::wp_comments_personal_data_eraser
 	 */
 	public function test_wp_comments_personal_data_eraser_non_empty_first_page_output() {
 
@@ -1045,6 +1126,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43442
+	 *
+	 * @covers ::wp_comments_personal_data_eraser
 	 */
 	public function test_wp_comments_personal_data_eraser_empty_second_page_output() {
 
@@ -1077,6 +1160,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43442
+	 *
+	 * @covers ::wp_comments_personal_data_eraser
 	 */
 	public function test_wp_anonymize_comment_filter_to_prevent_comment_anonymization() {
 
@@ -1114,6 +1199,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43442
+	 *
+	 * @covers ::wp_comments_personal_data_eraser
 	 */
 	public function test_wp_anonymize_comment_filter_to_prevent_comment_anonymization_with_custom_message() {
 
@@ -1179,6 +1266,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( 'Bar', $comment->comment_author );
 	}
 
+	/**
+	 * @covers ::wp_trash_comment
+	 */
 	public function test_trash_should_invalidate_comment_cache() {
 		global $wpdb;
 
@@ -1193,6 +1283,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( 'trash', $comment->comment_approved );
 	}
 
+	/**
+	 * @covers ::wp_untrash_comment
+	 */
 	public function test_untrash_should_invalidate_comment_cache() {
 		global $wpdb;
 
@@ -1209,6 +1302,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( '1', $comment->comment_approved );
 	}
 
+	/**
+	 * @covers ::wp_spam_comment
+	 */
 	public function test_spam_should_invalidate_comment_cache() {
 		global $wpdb;
 
@@ -1223,6 +1319,9 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( 'spam', $comment->comment_approved );
 	}
 
+	/**
+	 * @covers ::wp_unspam_comment
+	 */
 	public function test_unspam_should_invalidate_comment_cache() {
 		global $wpdb;
 
@@ -1244,6 +1343,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43440
+	 *
+	 * @covers ::wp_comments_personal_data_exporter
 	 */
 	public function test_wp_comments_personal_data_exporter() {
 		$args = array(
@@ -1290,6 +1391,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43440
+	 *
+	 * @covers ::wp_comments_personal_data_exporter
 	 */
 	public function test_wp_comments_personal_data_exporter_no_comments_found() {
 
@@ -1308,6 +1411,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43440
+	 *
+	 * @covers ::wp_comments_personal_data_exporter
 	 */
 	public function test_wp_comments_personal_data_exporter_empty_comment_prop() {
 		$args = array(
@@ -1339,6 +1444,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	 *
 	 * @group privacy
 	 * @ticket 43440
+	 *
+	 * @covers ::wp_comments_personal_data_exporter
 	 */
 	public function test_wp_comments_personal_data_exporter_empty_second_page() {
 		$args = array(
diff --git a/tests/comment/checkComment.php b/tests/comment/checkComment.php
index fc4cfa9e83..5efcf9acce 100644
--- a/tests/comment/checkComment.php
+++ b/tests/comment/checkComment.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::check_comment
  */
 class Tests_Comment_CheckComment extends WP_UnitTestCase {
 	public function test_should_return_true_when_comment_previously_approved_is_disabled() {
@@ -136,7 +138,7 @@ class Tests_Comment_CheckComment extends WP_UnitTestCase {
 	 * @ticket 28603
 	 */
 	public function test_should_return_true_when_comment_previously_approved_is_enabled_and_user_has_previously_approved_comments_with_different_email() {
-		$subscriber_id = $this->factory()->user->create(
+		$subscriber_id = self::factory()->user->create(
 			array(
 				'role'  => 'subscriber',
 				'email' => 'sub@example.com',
@@ -144,7 +146,7 @@ class Tests_Comment_CheckComment extends WP_UnitTestCase {
 		);
 
 		// Make sure comment author has an approved comment.
-		$this->factory->comment->create(
+		self::factory()->comment->create(
 			array(
 				'user_id'              => $subscriber_id,
 				'comment_approved'     => '1',
@@ -168,7 +170,7 @@ class Tests_Comment_CheckComment extends WP_UnitTestCase {
 	 * @ticket 28603
 	 */
 	public function test_should_return_false_when_comment_previously_approved_is_enabled_and_user_does_not_have_a_previously_approved_comment_with_any_email() {
-		$subscriber_id = $this->factory()->user->create(
+		$subscriber_id = self::factory()->user->create(
 			array(
 				'role'  => 'subscriber',
 				'email' => 'zig@example.com',
diff --git a/tests/comment/commentForm.php b/tests/comment/commentForm.php
index eef2e9ac7c..e9e6d99e73 100644
--- a/tests/comment/commentForm.php
+++ b/tests/comment/commentForm.php
@@ -2,6 +2,7 @@
 
 /**
  * @group  comment
+ *
  * @covers ::comment_form
  */
 class Tests_Comment_CommentForm extends WP_UnitTestCase {
diff --git a/tests/comment/commentsOpen.php b/tests/comment/commentsOpen.php
index 54e08ea8ed..7549498e90 100644
--- a/tests/comment/commentsOpen.php
+++ b/tests/comment/commentsOpen.php
@@ -17,7 +17,7 @@ class Tests_Comment_CommentsOpen extends WP_UnitTestCase {
 	 * @ticket 54159
 	 */
 	public function test_post_exist_status_open() {
-		$post = $this->factory->post->create_and_get();
+		$post = self::factory()->post->create_and_get();
 		$this->assertTrue( comments_open( $post ) );
 	}
 
@@ -25,7 +25,7 @@ class Tests_Comment_CommentsOpen extends WP_UnitTestCase {
 	 * @ticket 54159
 	 */
 	public function test_post_exist_status_closed() {
-		$post                 = $this->factory->post->create_and_get();
+		$post                 = self::factory()->post->create_and_get();
 		$post->comment_status = 'closed';
 
 		$this->assertFalse( comments_open( $post ) );
diff --git a/tests/comment/commentsTemplate.php b/tests/comment/commentsTemplate.php
index 7135118485..7c27bf1d43 100644
--- a/tests/comment/commentsTemplate.php
+++ b/tests/comment/commentsTemplate.php
@@ -4,6 +4,8 @@
  * @group comment
  *
  * Testing items that are only testable by grabbing the markup of `comments_template()` from the output buffer.
+ *
+ * @covers ::comments_template
  */
 class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 
diff --git a/tests/comment/dateQuery.php b/tests/comment/dateQuery.php
index c59497a835..473c2a6c26 100644
--- a/tests/comment/dateQuery.php
+++ b/tests/comment/dateQuery.php
@@ -12,6 +12,8 @@
  * @group comment
  * @group date
  * @group datequery
+ *
+ * @covers ::get_comments
  */
 class Tests_Comment_DateQuery extends WP_UnitTestCase {
 
diff --git a/tests/comment/getCommentAuthorEmailLink.php b/tests/comment/getCommentAuthorEmailLink.php
index a5ed6aef6b..a203d38122 100644
--- a/tests/comment/getCommentAuthorEmailLink.php
+++ b/tests/comment/getCommentAuthorEmailLink.php
@@ -1,6 +1,8 @@
 <?php
 /**
  * @group comment
+ *
+ * @covers ::get_comment_author_email_link
  */
 class Tests_Comment_GetCommentAuthorEmailLink extends WP_UnitTestCase {
 	public static $comment;
diff --git a/tests/comment/getCommentAuthorUrl.php b/tests/comment/getCommentAuthorUrl.php
index c0538e7bd8..c796b4f072 100644
--- a/tests/comment/getCommentAuthorUrl.php
+++ b/tests/comment/getCommentAuthorUrl.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ *@covers ::get_comment_author_url
  */
 class Tests_Comment_GetCommentAuthorUrl extends WP_UnitTestCase {
 	public function get_comment_author_url_filter( $url, $id, $comment ) {
diff --git a/tests/comment/getCommentAuthorUrlLink.php b/tests/comment/getCommentAuthorUrlLink.php
index 6fd82cb796..c9acc6732d 100644
--- a/tests/comment/getCommentAuthorUrlLink.php
+++ b/tests/comment/getCommentAuthorUrlLink.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::get_comment_author_url_link
  */
 class Tests_Comment_GetCommentAuthorUrlLink extends WP_UnitTestCase {
 	protected static $comments = array();
diff --git a/tests/comment/getCommentClass.php b/tests/comment/getCommentClass.php
index a4518a226f..b30fc0c218 100644
--- a/tests/comment/getCommentClass.php
+++ b/tests/comment/getCommentClass.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::get_comment_class
  */
 class Tests_Comment_GetCommentClass extends WP_UnitTestCase {
 	public function test_should_accept_comment_id() {
diff --git a/tests/comment/getCommentCount.php b/tests/comment/getCommentCount.php
index 7b3ede5f35..1f26459dfa 100644
--- a/tests/comment/getCommentCount.php
+++ b/tests/comment/getCommentCount.php
@@ -1,5 +1,12 @@
 <?php
 
+/**
+ * @group comment
+ *
+ * Class Tests_Get_Comment_Count
+ *
+ * @covers ::get_comment_count
+ */
 class Tests_Get_Comment_Count extends WP_UnitTestCase {
 
 	public function test_get_comment_count() {
@@ -11,6 +18,7 @@ class Tests_Get_Comment_Count extends WP_UnitTestCase {
 		$this->assertSame( 0, $count['trash'] );
 		$this->assertSame( 0, $count['post-trashed'] );
 		$this->assertSame( 0, $count['total_comments'] );
+		$this->assertSame( 0, $count['all'] );
 	}
 
 	public function test_get_comment_count_approved() {
@@ -97,4 +105,73 @@ class Tests_Get_Comment_Count extends WP_UnitTestCase {
 		$this->assertSame( 1, $count['post-trashed'] );
 		$this->assertSame( 0, $count['total_comments'] );
 	}
+
+	/**
+	 * @ticket 19901
+	 *
+	 * @covers ::get_comment_count
+	 */
+	public function test_get_comment_count_validate_cache_comment_deleted() {
+
+		$comment_id = self::factory()->comment->create();
+
+		$count = get_comment_count();
+
+		$this->assertSame( 1, $count['total_comments'] );
+
+		wp_delete_comment( $comment_id, true );
+
+		$count = get_comment_count();
+
+		$this->assertSame( 0, $count['total_comments'] );
+	}
+
+	/**
+	 * @ticket 19901
+	 *
+	 * @covers ::get_comment_count
+	 */
+	public function test_get_comment_count_validate_cache_post_deleted() {
+
+		$post_id = self::factory()->post->create();
+
+		$comment_id = self::factory()->comment->create(
+			array(
+				'comment_post_ID' => $post_id,
+			)
+		);
+
+		$count = get_comment_count( $post_id );
+
+		$this->assertSame( 1, $count['total_comments'] );
+
+		wp_delete_post( $post_id, true );
+
+		$count = get_comment_count( $post_id );
+
+		$this->assertSame( 0, $count['total_comments'] );
+	}
+
+	/**
+	 * @ticket 19901
+	 *
+	 * @covers ::get_comment_count
+	 */
+	public function test_get_comment_count_validate_cache_comment_status() {
+		$comment_id = self::factory()->comment->create();
+
+		$count = get_comment_count();
+
+		$this->assertSame( 1, $count['approved'] );
+		$this->assertSame( 0, $count['trash'] );
+		$this->assertSame( 1, $count['total_comments'] );
+
+		wp_set_comment_status( $comment_id, 'trash' );
+
+		$count = get_comment_count();
+
+		$this->assertSame( 0, $count['approved'] );
+		$this->assertSame( 1, $count['trash'] );
+		$this->assertSame( 0, $count['total_comments'] );
+	}
 }
diff --git a/tests/comment/getCommentExcerpt.php b/tests/comment/getCommentExcerpt.php
index 3338a859bf..009fa747cb 100644
--- a/tests/comment/getCommentExcerpt.php
+++ b/tests/comment/getCommentExcerpt.php
@@ -1,5 +1,12 @@
 <?php
 
+/**
+ * @group comment
+ *
+ * Class Tests_Get_Comment_Excerpt
+ *
+ * @covers ::get_comment_excerpt
+ */
 class Tests_Get_Comment_Excerpt extends WP_UnitTestCase {
 	protected static $bacon_comment = 'Bacon ipsum dolor amet porchetta capicola sirloin prosciutto brisket shankle jerky. Ham hock filet mignon boudin ground round, prosciutto alcatra spare ribs meatball turducken pork beef ribs ham beef. Bacon pastrami short loin, venison tri-tip ham short ribs doner swine. Tenderloin pig tongue pork jowl doner. Pork loin rump t-bone, beef strip steak flank drumstick tri-tip short loin capicola jowl. Cow filet mignon hamburger doner rump. Short loin jowl drumstick, tongue tail beef ribs pancetta flank brisket landjaeger chuck venison frankfurter turkey.
 
diff --git a/tests/comment/getCommentLink.php b/tests/comment/getCommentLink.php
index fcb51c2c5b..3f2f2ff504 100644
--- a/tests/comment/getCommentLink.php
+++ b/tests/comment/getCommentLink.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::get_comment_link
  */
 class Tests_Comment_GetCommentLink extends WP_UnitTestCase {
 	protected static $p;
diff --git a/tests/comment/getCommentReplyLink.php b/tests/comment/getCommentReplyLink.php
index 76332a5742..0377a5c0f5 100644
--- a/tests/comment/getCommentReplyLink.php
+++ b/tests/comment/getCommentReplyLink.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::get_comment_reply_link
  */
 class Tests_Comment_GetCommentReplyLink extends WP_UnitTestCase {
 	/**
diff --git a/tests/comment/getCommentsPagesCount.php b/tests/comment/getCommentsPagesCount.php
index eb03cfb3f0..00a5244f3a 100644
--- a/tests/comment/getCommentsPagesCount.php
+++ b/tests/comment/getCommentsPagesCount.php
@@ -3,6 +3,8 @@
  * Validate the logic of get_comments_pages_count
  *
  * @group comment
+ *
+ * @covers ::get_comment_pages_count
  */
 class Tests_Comment_GetCommentsPagesCount extends WP_UnitTestCase {
 	protected $option_page_comments;
diff --git a/tests/comment/getPageOfComment.php b/tests/comment/getPageOfComment.php
index 7cdf85ba41..e1f19ae345 100644
--- a/tests/comment/getPageOfComment.php
+++ b/tests/comment/getPageOfComment.php
@@ -2,6 +2,7 @@
 
 /**
  * @group comment
+ *
  * @covers ::get_page_of_comment
  */
 class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
diff --git a/tests/comment/isAvatarCommentType.php b/tests/comment/isAvatarCommentType.php
index fe7e7482d3..57ed593b1b 100644
--- a/tests/comment/isAvatarCommentType.php
+++ b/tests/comment/isAvatarCommentType.php
@@ -11,9 +11,10 @@
  * Tests_Comment_IsAvatarCommentType class.
  *
  * @group comment
- * @covers ::is_avatar_comment_type
  *
  * @since 5.1.0
+ *
+ * @covers ::is_avatar_comment_type
  */
 class Tests_Comment_IsAvatarCommentType extends WP_UnitTestCase {
 	/**
diff --git a/tests/comment/lastCommentModified.php b/tests/comment/lastCommentModified.php
index 4369743cbb..3de37b0980 100644
--- a/tests/comment/lastCommentModified.php
+++ b/tests/comment/lastCommentModified.php
@@ -3,6 +3,8 @@
 /**
  * @group comment
  * @ticket 38027
+ *
+ * @covers ::get_lastcommentmodified
  */
 class Tests_Comment_Last_Modified extends WP_UnitTestCase {
 	public function test_no_comments() {
diff --git a/tests/comment/metaCache.php b/tests/comment/metaCache.php
index bcfd6b5fdb..cfbf2b32fc 100644
--- a/tests/comment/metaCache.php
+++ b/tests/comment/metaCache.php
@@ -1,11 +1,15 @@
 <?php
-
+/**
+ * @group comment
+ */
 class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 	protected $i       = 0;
 	protected $queries = 0;
 
 	/**
 	 * @ticket 16894
+	 *
+	 * @covers ::update_comment_meta
 	 */
 	public function test_update_comment_meta_cache_should_default_to_true() {
 		global $wpdb;
@@ -36,6 +40,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 16894
+	 *
+	 * @covers ::update_comment_meta
 	 */
 	public function test_update_comment_meta_cache_true() {
 		global $wpdb;
@@ -67,6 +73,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 16894
+	 *
+	 * @covers ::update_comment_meta
 	 */
 	public function test_update_comment_meta_cache_false() {
 		global $wpdb;
@@ -95,6 +103,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 16894
+	 *
+	 * @covers ::get_comment_meta
 	 */
 	public function test_comment_meta_should_be_lazy_loaded_for_all_comments_in_comments_template() {
 		global $wpdb;
@@ -130,6 +140,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34047
+	 *
+	 * @covers ::get_comment_meta
 	 */
 	public function test_comment_meta_should_be_lazy_loaded_in_comment_feed_queries() {
 		global $wpdb;
@@ -178,6 +190,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34047
+	 *
+	 * @covers ::get_comment_meta
 	 */
 	public function test_comment_meta_should_be_lazy_loaded_in_single_post_comment_feed_queries() {
 		global $wpdb;
@@ -227,6 +241,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44467
+	 *
+	 * @covers ::add_metadata
 	 */
 	public function test_add_metadata_sets_comments_last_changed() {
 		$comment_id = self::factory()->comment->create();
@@ -239,6 +255,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44467
+	 *
+	 * @covers ::update_metadata
 	 */
 	public function test_update_metadata_sets_comments_last_changed() {
 		$comment_id = self::factory()->comment->create();
@@ -251,6 +269,8 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44467
+	 *
+	 * @covers ::delete_metadata
 	 */
 	public function test_delete_metadata_sets_comments_last_changed() {
 		$comment_id = self::factory()->comment->create();
diff --git a/tests/comment/pingsOpen.php b/tests/comment/pingsOpen.php
index 2ef7029804..93a25d5a73 100644
--- a/tests/comment/pingsOpen.php
+++ b/tests/comment/pingsOpen.php
@@ -17,7 +17,7 @@ class Tests_Comment_PingsOpen extends WP_UnitTestCase {
 	 * @ticket 54159
 	 */
 	public function test_post_exist_status_open() {
-		$post = $this->factory->post->create_and_get();
+		$post = self::factory()->post->create_and_get();
 		$this->assertTrue( pings_open( $post ) );
 	}
 
@@ -25,7 +25,7 @@ class Tests_Comment_PingsOpen extends WP_UnitTestCase {
 	 * @ticket 54159
 	 */
 	public function test_post_exist_status_closed() {
-		$post              = $this->factory->post->create_and_get();
+		$post              = self::factory()->post->create_and_get();
 		$post->ping_status = 'closed';
 
 		$this->assertFalse( pings_open( $post ) );
diff --git a/tests/comment/query.php b/tests/comment/query.php
index 68265dfdac..94b13192d5 100644
--- a/tests/comment/query.php
+++ b/tests/comment/query.php
@@ -9,10 +9,29 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 	protected static $post_id;
 	protected $comment_id;
 
+	/**
+	 * Temporary storage for comment exclusions to allow a filter to access these.
+	 *
+	 * Used in the following tests:
+	 * - `test_comment_clauses_prepend_callback_should_be_respected_when_filling_descendants()`
+	 * - `test_comment_clauses_append_callback_should_be_respected_when_filling_descendants()`
+	 *
+	 * @var array
+	 */
+	private $to_exclude;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$post_id = $factory->post->create();
 	}
 
+	public function tear_down() {
+		unset( $this->to_exclude );
+		parent::tear_down();
+	}
+
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_query() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -59,6 +78,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c1, $c2, $c3, $c4, $c5 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_query_post_id_0() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -80,6 +102,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_query_type_empty_string() {
 		$c1 = self::factory()->comment->create(
@@ -130,6 +154,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_query_type_comment() {
 		$c1 = self::factory()->comment->create(
@@ -178,6 +204,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c1 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_query_type_pingback() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -219,6 +248,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_query_type_trackback() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -262,6 +294,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * 'pings' is an alias for 'trackback' + 'pingback'.
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_query_type_pings() {
 		$c1 = self::factory()->comment->create(
@@ -314,6 +348,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 	 * Comments and custom
 	 *
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_comments_and_custom() {
 		$c1 = self::factory()->comment->create(
@@ -371,6 +407,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_not__in_array_custom() {
 		$c1 = self::factory()->comment->create(
@@ -428,6 +466,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type__in_array_and_not_type_array_custom() {
 		$c1 = self::factory()->comment->create(
@@ -486,6 +526,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_and_type__not_in_array_custom() {
 		$c1 = self::factory()->comment->create(
@@ -544,6 +586,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type__not_in_custom() {
 		$c1 = self::factory()->comment->create(
@@ -601,6 +645,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_comments_and_pings() {
 		$c1 = self::factory()->comment->create(
@@ -651,6 +697,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_comment_pings() {
 		$c1 = self::factory()->comment->create(
@@ -687,6 +735,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_pingback() {
 		$c1 = self::factory()->comment->create(
@@ -723,6 +773,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_custom_pingpack() {
 		$c1 = self::factory()->comment->create(
@@ -759,6 +811,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_pings() {
 		$c1 = self::factory()->comment->create(
@@ -795,6 +849,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_status_approved_array_comment_pings() {
 		$c1 = self::factory()->comment->create(
@@ -839,6 +895,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_trackback() {
 		$c1 = self::factory()->comment->create(
@@ -875,6 +933,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_custom_trackback() {
 		$c1 = self::factory()->comment->create(
@@ -911,6 +971,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 12668
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_type_array_pings_approved() {
 		$c1 = self::factory()->comment->create(
@@ -955,6 +1017,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29612
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_status_empty_string() {
 		$c1 = self::factory()->comment->create(
@@ -989,6 +1053,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21101
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_status_hold() {
 		$c1 = self::factory()->comment->create(
@@ -1017,6 +1083,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21101
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_status_approve() {
 		$c1 = self::factory()->comment->create(
@@ -1043,6 +1111,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSame( array( $c1 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_status_custom() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -1074,6 +1145,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSame( array( $c2 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_status_all() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -1105,6 +1179,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c1, $c3 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_status_default_to_all() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -1137,6 +1214,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29612
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_status_comma_any() {
 		$c1 = self::factory()->comment->create(
@@ -1171,6 +1250,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29612
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_status_comma_separated() {
 		$c1 = self::factory()->comment->create(
@@ -1205,6 +1286,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29612
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_status_array() {
 		$c1 = self::factory()->comment->create(
@@ -1239,6 +1322,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35478
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_multiple_post_fields_should_all_be_respected() {
 		$posts = array();
@@ -1284,6 +1369,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSame( array( $comments[2] ), $q->comments );
 	}
 
+	/**
+	 * @covers ::get_comments
+	 */
 	public function test_get_comments_for_post() {
 		$limit = 5;
 
@@ -1343,6 +1431,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21003
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_orderby_meta() {
 		$comment_id  = self::factory()->comment->create( array( 'comment_post_ID' => self::$post_id ) );
@@ -1435,6 +1525,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_clause_key() {
 		$comments = self::factory()->comment->create_many( 3 );
@@ -1462,6 +1554,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_clause_key_as_secondary_sort() {
 		$c1 = self::factory()->comment->create(
@@ -1506,6 +1600,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_more_than_one_clause_key() {
 		$comments = self::factory()->comment->create_many( 3 );
@@ -1543,6 +1639,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 32081
+	 *
+	 * @covers WP_Comment_Query::__construct
+	 * @covers WP_Comment_Query::get_comments
 	 */
 	public function test_meta_query_should_work_with_comment__in() {
 		$comments = self::factory()->comment->create_many( 3 );
@@ -1569,6 +1668,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 32081
+	 *
+	 * @covers WP_Comment_Query::__construct
+	 * @covers WP_Comment_Query::get_comments
 	 */
 	public function test_meta_query_should_work_with_comment__not_in() {
 		$comments = self::factory()->comment->create_many( 3 );
@@ -1595,6 +1697,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 27064
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_by_user() {
 		$users = self::factory()->user->create_many( 2 );
@@ -1649,6 +1753,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35377
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_by_author_url() {
 		$c1 = self::factory()->comment->create(
@@ -1688,6 +1794,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 28434
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_ids_query() {
 		$comment_1 = self::factory()->comment->create(
@@ -1724,6 +1832,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29189
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_comment__in() {
 		$comment_1 = self::factory()->comment->create(
@@ -1760,6 +1870,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29189
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_comment__not_in() {
 		$comment_1 = self::factory()->comment->create(
@@ -1796,6 +1908,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29189
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_post__in() {
 		$p1 = self::factory()->post->create();
@@ -1836,6 +1950,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29189
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_post__not_in() {
 		$p1 = self::factory()->post->create();
@@ -1876,6 +1992,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29885
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_post_author__in() {
 		$author_id1 = 105;
@@ -1919,6 +2037,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29885
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_fields_post_author__not_in() {
 		$author_id1 = 111;
@@ -1962,6 +2082,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		/**
 		 * @ticket 29885
+		 *
+		 * @covers ::get_comments
 		 */
 	public function test_fields_author__in() {
 		$p1 = self::factory()->post->create();
@@ -2010,6 +2132,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		/**
 		 * @ticket 29885
+		 *
+		 * @covers ::get_comments
 		 */
 	public function test_fields_author__not_in() {
 		$p1 = self::factory()->post->create();
@@ -2058,6 +2182,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_status_all() {
 		$comment_1           = self::factory()->comment->create(
@@ -2089,6 +2215,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_include_unapproved_user_id() {
 		$c1 = self::factory()->comment->create(
@@ -2133,6 +2261,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_include_unapproved_user_id_array() {
 		$c1 = self::factory()->comment->create(
@@ -2184,6 +2314,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_include_unapproved_user_id_comma_separated() {
 		$c1 = self::factory()->comment->create(
@@ -2235,6 +2367,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_include_unapproved_author_email() {
 		$c1 = self::factory()->comment->create(
@@ -2285,6 +2419,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_include_unapproved_mixed_array() {
 		$c1 = self::factory()->comment->create(
@@ -2344,6 +2480,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 19623
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_get_comments_with_include_unapproved_mixed_comma_separated() {
 		$c1 = self::factory()->comment->create(
@@ -2401,6 +2539,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c1, $c2, $c3, $c5 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_search() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -2476,6 +2617,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35513
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_search_false_should_be_ignored() {
 		$q = new WP_Comment_Query();
@@ -2489,6 +2632,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35513
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_search_null_should_be_ignored() {
 		$q = new WP_Comment_Query();
@@ -2502,6 +2647,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35513
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_search_empty_string_should_be_ignored() {
 		$q = new WP_Comment_Query();
@@ -2515,6 +2662,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35513
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_search_int_0_should_not_be_ignored() {
 		global $wpdb;
@@ -2529,6 +2678,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35513
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_search_string_0_should_not_be_ignored() {
 		global $wpdb;
@@ -2541,6 +2692,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "comment_author LIKE '%0%'", $wpdb->remove_placeholder_escape( $q->request ) );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_default() {
 		global $wpdb;
 
@@ -2550,6 +2704,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_date_gmt", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_single() {
 		global $wpdb;
 
@@ -2563,6 +2720,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_agent", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_single_invalid() {
 		global $wpdb;
 
@@ -2576,6 +2736,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_date_gmt", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_space_separated() {
 		global $wpdb;
 
@@ -2589,6 +2752,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_agent DESC, $wpdb->comments.comment_approved DESC", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_comma_separated() {
 		global $wpdb;
 
@@ -2602,6 +2768,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_agent DESC, $wpdb->comments.comment_approved DESC", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_flat_array() {
 		global $wpdb;
 
@@ -2615,6 +2784,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_agent DESC, $wpdb->comments.comment_approved DESC", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_array_contains_invalid_item() {
 		global $wpdb;
 
@@ -2628,6 +2800,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $wpdb->comments.comment_agent DESC, $wpdb->comments.comment_approved DESC", $q->request );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_orderby_array_contains_all_invalid_items() {
 		global $wpdb;
 
@@ -2643,6 +2818,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29902
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_none() {
 		$q = new WP_Comment_Query();
@@ -2657,6 +2834,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29902
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_empty_array() {
 		$q = new WP_Comment_Query();
@@ -2671,6 +2850,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 29902
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_false() {
 		$q = new WP_Comment_Query();
@@ -2685,6 +2866,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_array() {
 		global $wpdb;
@@ -2706,6 +2889,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_array_should_discard_invalid_columns() {
 		global $wpdb;
@@ -2727,6 +2912,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_array_should_convert_invalid_order_to_DESC() {
 		global $wpdb;
@@ -2748,6 +2935,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_array_should_sort_by_comment_ID_as_fallback_and_should_inherit_order_from_comment_date_gmt() {
 		global $wpdb;
@@ -2768,6 +2957,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_array_should_sort_by_comment_ID_as_fallback_and_should_inherit_order_from_comment_date() {
 		global $wpdb;
@@ -2788,6 +2979,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_array_should_sort_by_comment_ID_DESC_as_fallback_when_not_sorted_by_date() {
 		global $wpdb;
@@ -2807,6 +3000,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_date_modified_gmt_should_order_by_comment_ID_in_case_of_tie_ASC() {
 		$now      = current_time( 'mysql', 1 );
@@ -2832,6 +3027,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30478
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_orderby_date_modified_gmt_should_order_by_comment_ID_in_case_of_tie_DESC() {
 		$now      = current_time( 'mysql', 1 );
@@ -2857,6 +3054,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertEquals( $comments, wp_list_pluck( $found, 'comment_ID' ) );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_meta_vars_should_be_converted_to_meta_query() {
 		$q = new WP_Comment_Query();
 		$q->query(
@@ -2874,6 +3074,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSame( 'SIGNED', $q->meta_query->queries[0]['type'] );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_count() {
 		$c1 = self::factory()->comment->create(
 			array(
@@ -2900,6 +3103,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 23369
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_count_with_meta_query() {
 		$c1 = self::factory()->comment->create(
@@ -2941,6 +3146,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38268
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_paged() {
 		$now = time();
@@ -2987,6 +3194,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38268
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_offset_should_take_precedence_over_paged() {
 		$now = time();
@@ -3033,6 +3242,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSame( $expected, $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_post_type_single_value() {
 		register_post_type( 'post-type-1' );
 		register_post_type( 'post-type-2' );
@@ -3059,6 +3271,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20006
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_type_singleton_array() {
 		register_post_type( 'post-type-1' );
@@ -3086,6 +3300,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20006
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_type_array() {
 		register_post_type( 'post-type-1' );
@@ -3111,6 +3327,10 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array_merge( $c1, $c3 ), $found );
 	}
 
+	/**
+	 *
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_post_name_single_value() {
 		$p1 = self::factory()->post->create( array( 'post_name' => 'foo' ) );
 		$p2 = self::factory()->post->create( array( 'post_name' => 'bar' ) );
@@ -3131,6 +3351,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20006
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_name_singleton_array() {
 		$p1 = self::factory()->post->create( array( 'post_name' => 'foo' ) );
@@ -3152,6 +3374,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20006
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_name_array() {
 		$p1 = self::factory()->post->create( array( 'post_name' => 'foo' ) );
@@ -3173,6 +3397,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array_merge( $c1, $c3 ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::query
+	 */
 	public function test_post_status_single_value() {
 		$p1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$p2 = self::factory()->post->create( array( 'post_status' => 'draft' ) );
@@ -3193,6 +3420,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20006
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_status_singleton_array() {
 		$p1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
@@ -3214,6 +3443,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20006
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_status_array() {
 		$p1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
@@ -3237,6 +3468,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35512
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_type_any_should_override_other_post_types() {
 		register_post_type( 'post-type-1', array( 'exclude_from_search' => false ) );
@@ -3260,6 +3493,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35512
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_type_any_as_part_of_an_array_of_post_types() {
 		register_post_type( 'post-type-1', array( 'exclude_from_search' => false ) );
@@ -3283,6 +3518,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35512
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_status_any_should_override_other_post_statuses() {
 		$p1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
@@ -3303,6 +3540,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35512
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_post_status_any_as_part_of_an_array_of_post_statuses() {
 		$p1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
@@ -3323,6 +3562,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 24826
+	 *
+	 * @covers WP_Comment_Query::__construct
+	 * @covers WP_Comment_Query::get_comments
 	 */
 	public function test_comment_query_object() {
 		$comment_id = self::factory()->comment->create();
@@ -3343,6 +3585,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22400
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_comment_cache_key_should_ignore_custom_params() {
 		global $wpdb;
@@ -3374,6 +3618,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35677
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_cache_should_be_sensitive_to_parent__in() {
 		global $wpdb;
@@ -3397,6 +3643,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35677
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_cache_should_be_sensitive_to_parent__not_in() {
 		global $wpdb;
@@ -3420,6 +3668,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 32762
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_it_should_be_possible_to_modify_meta_query_using_pre_get_comments_action() {
 		$comments = self::factory()->comment->create_many(
@@ -3458,6 +3708,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 32762
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_it_should_be_possible_to_modify_meta_params_using_pre_get_comments_action() {
 		$comments = self::factory()->comment->create_many(
@@ -3490,6 +3742,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33882
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_parent__in() {
 		$c1 = self::factory()->comment->create(
@@ -3519,6 +3773,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33882
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_parent__in_commas() {
 		$c1 = self::factory()->comment->create(
@@ -3561,6 +3817,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33882
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_parent__not_in() {
 		$c1 = self::factory()->comment->create(
@@ -3591,6 +3849,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33882
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_parent__not_in_commas() {
 		$c1 = self::factory()->comment->create(
@@ -3634,6 +3894,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33883
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_orderby_comment__in() {
 		self::factory()->comment->create(
@@ -3677,6 +3939,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_no_found_rows_should_default_to_true() {
 		$comments = self::factory()->comment->create_many( 3, array( 'comment_post_ID' => self::$post_id ) );
@@ -3694,6 +3958,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_should_respect_no_found_rows_true() {
 		$comments = self::factory()->comment->create_many( 3, array( 'comment_post_ID' => self::$post_id ) );
@@ -3712,6 +3978,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_should_respect_no_found_rows_false() {
 		$comments = self::factory()->comment->create_many( 3, array( 'comment_post_ID' => self::$post_id ) );
@@ -3730,6 +3998,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 37184
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_found_rows_should_be_fetched_from_the_cache() {
 		$comments = self::factory()->comment->create_many( 3, array( 'comment_post_ID' => self::$post_id ) );
@@ -3757,6 +4027,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_hierarchical_should_skip_child_comments_in_offset() {
 		$top_level_0 = self::factory()->comment->create(
@@ -3799,6 +4071,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_hierarchical_should_not_include_child_comments_in_number() {
 		$top_level_0 = self::factory()->comment->create(
@@ -3839,6 +4113,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_hierarchical_threaded() {
 		$c1 = self::factory()->comment->create(
@@ -3917,6 +4193,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8071
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_hierarchical_threaded_approved() {
 		$c1 = self::factory()->comment->create(
@@ -3993,6 +4271,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35192
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_comment_clauses_prepend_callback_should_be_respected_when_filling_descendants() {
 		$top_level_0 = self::factory()->comment->create(
@@ -4037,8 +4317,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		);
 		remove_filter( 'comments_clauses', array( $this, 'prepend_exclusions' ) );
 
-		unset( $this->to_exclude );
-
 		$this->assertEqualSets( array( $top_level_0, $child1_of_0, $top_level_comments[0], $top_level_comments[2] ), wp_list_pluck( $q->comments, 'comment_ID' ) );
 	}
 
@@ -4050,6 +4328,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35192
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_comment_clauses_append_callback_should_be_respected_when_filling_descendants() {
 		$top_level_0 = self::factory()->comment->create(
@@ -4094,8 +4374,6 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		);
 		remove_filter( 'comments_clauses', array( $this, 'append_exclusions' ) );
 
-		unset( $this->to_exclude );
-
 		$this->assertEqualSets( array( $top_level_0, $child1_of_0, $top_level_comments[0], $top_level_comments[2] ), wp_list_pluck( $q->comments, 'comment_ID' ) );
 	}
 
@@ -4107,6 +4385,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36487
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_cache_should_be_hit_when_querying_descendants() {
 		global $wpdb;
@@ -4163,6 +4443,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 37696
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_hierarchy_should_be_filled_when_cache_is_incomplete() {
 		global $wpdb;
@@ -4225,6 +4507,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 	/**
 	 * @ticket 37966
 	 * @ticket 37696
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_fill_hierarchy_should_disregard_offset_and_number() {
 		$c0 = self::factory()->comment->create(
@@ -4292,6 +4576,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 27571
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_update_comment_post_cache_should_be_disabled_by_default() {
 		global $wpdb;
@@ -4312,6 +4598,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 27571
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_should_respect_update_comment_post_cache_true() {
 		global $wpdb;
@@ -4333,6 +4621,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34138
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_comment_objects_should_be_filled_from_cache() {
 		global $wpdb;
@@ -4361,6 +4651,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34138
+	 *
+	 * @covers WP_Comment_Query::__construct
 	 */
 	public function test_comment_objects_should_be_fetched_from_database_when_suspend_cache_addition() {
 		$suspend = wp_suspend_cache_addition();
@@ -4380,6 +4672,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertEqualSets( array( $c ), $found );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_comment_query_should_be_cached() {
 		global $wpdb;
 
@@ -4410,6 +4705,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_created_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4440,6 +4738,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_updated_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4480,6 +4781,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_deleted_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4513,6 +4817,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array(), $q->comments );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_trashed_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4546,6 +4853,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array(), $q->comments );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_untrashed_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4581,6 +4891,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array( $c ), $q->comments );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_spammed_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4614,6 +4927,9 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$this->assertSameSets( array(), $q->comments );
 	}
 
+	/**
+	 * @covers WP_Comment_Query::__construct
+	 */
 	public function test_unspammed_comment_should_invalidate_query_cache() {
 		global $wpdb;
 
@@ -4651,6 +4967,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 41348
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_count_query_should_miss_noncount_cache() {
 		global $wpdb;
@@ -4680,6 +4998,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 41348
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_count_query_should_hit_count_cache() {
 		global $wpdb;
@@ -4709,6 +5029,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 41348
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_different_values_of_fields_should_share_cached_values() {
 		global $wpdb;
@@ -4737,6 +5059,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 40669
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_add_comment_meta_should_invalidate_query_cache() {
 		global $wpdb;
@@ -4786,6 +5110,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 40669
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_update_comment_meta_should_invalidate_query_cache() {
 		global $wpdb;
@@ -4835,6 +5161,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 40669
+	 *
+	 * @covers ::get_comments
 	 */
 	public function test_delete_comment_meta_should_invalidate_query_cache() {
 		global $wpdb;
@@ -4884,6 +5212,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 45800
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_comments_pre_query_filter_should_bypass_database_query() {
 		global $wpdb;
@@ -4915,6 +5245,8 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 50521
+	 *
+	 * @covers WP_Comment_Query::query
 	 */
 	public function test_comments_pre_query_filter_should_set_comments_property() {
 		add_filter( 'comments_pre_query', array( __CLASS__, 'filter_comments_pre_query_and_set_comments' ), 10, 2 );
@@ -4941,4 +5273,86 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		return array( get_comment( $c ) );
 	}
+
+	/**
+	 * @ticket 55460
+	 *
+	 * @covers WP_Comment_Query::__construct
+	 */
+	public function test_comment_cache_key_should_ignore_unset_params() {
+		$p = self::factory()->post->create();
+		$c = self::factory()->comment->create( array( 'comment_post_ID' => $p ) );
+
+		$_args = array(
+			'post_id'                   => $p,
+			'fields'                    => 'ids',
+			'update_comment_meta_cache' => true,
+			'update_comment_post_cache' => false,
+		);
+
+		$q1 = new WP_Comment_Query();
+		$q1->query( $_args );
+
+		$num_queries_all_args = get_num_queries();
+
+		// Ignore 'fields', 'update_comment_meta_cache', 'update_comment_post_cache'.
+		unset( $_args['fields'], $_args['update_comment_meta_cache'], $_args['update_comment_post_cache'] );
+		$q2 = new WP_Comment_Query();
+		$q2->query( $_args );
+
+		$this->assertSame( $num_queries_all_args, get_num_queries() );
+	}
+
+	/**
+	 * @ticket 55218
+	 *
+	 * @covers WP_Comment_Query::__construct
+	 */
+	public function test_unapproved_comment_with_meta_query_does_not_trigger_ambiguous_identifier_error() {
+		$p       = self::$post_id;
+		$c       = self::factory()->comment->create(
+			array(
+				'comment_post_ID'      => $p,
+				'comment_content'      => '1',
+				'comment_approved'     => '0',
+				'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', time() ),
+				'comment_author_email' => 'foo@bar.mail',
+				'comment_meta'         => array( 'foo' => 'bar' ),
+			)
+		);
+		$comment = get_comment( $c );
+
+		/*
+		 * This is used to get a bunch of globals set up prior to making the
+		 * database query. This helps with prepping for the moderation hash.
+		 */
+		$this->go_to(
+			add_query_arg(
+				array(
+					'unapproved'      => $comment->comment_ID,
+					'moderation-hash' => wp_hash( $comment->comment_date_gmt ),
+				),
+				get_comment_link( $comment )
+			)
+		);
+
+		/*
+		 * The result of the query is not needed so it's not assigned to variable.
+		 *
+		 * Returning the ID only limits the database query to only the one that was
+		 * causing the error reported in ticket 55218.
+		 */
+		new WP_Comment_Query(
+			array(
+				'include_unapproved' => array( 'foo@bar.mail' ),
+				'meta_query'         => array( array( 'key' => 'foo' ) ),
+				'post_id'            => $p,
+				'fields'             => 'ids',
+			)
+		);
+
+		global $wpdb;
+		$this->assertNotSame( "Column 'comment_ID' in where clause is ambiguous", $wpdb->last_error );
+		$this->assertStringNotContainsString( ' comment_ID ', $wpdb->last_query );
+	}
 }
diff --git a/tests/comment/slashes.php b/tests/comment/slashes.php
index 5b0f061b07..e58776d8f8 100644
--- a/tests/comment/slashes.php
+++ b/tests/comment/slashes.php
@@ -6,6 +6,20 @@
  * @ticket 21767
  */
 class Tests_Comment_Slashes extends WP_UnitTestCase {
+
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
+
 	protected static $author_id;
 	protected static $post_id;
 
@@ -19,20 +33,12 @@ class Tests_Comment_Slashes extends WP_UnitTestCase {
 		parent::set_up();
 
 		wp_set_current_user( self::$author_id );
-
-		// It is important to test with both even and odd numbered slashes,
-		// as KSES does a strip-then-add slashes in some of its function calls.
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 	}
 
 	/**
 	 * Tests the extended model function that expects slashed data.
+	 *
+	 * @covers ::wp_new_comment
 	 */
 	public function test_wp_new_comment() {
 		$post_id = self::$post_id;
@@ -41,37 +47,39 @@ class Tests_Comment_Slashes extends WP_UnitTestCase {
 		// as slashes are not permitted in that data.
 		$data       = array(
 			'comment_post_ID'      => $post_id,
-			'comment_author'       => $this->slash_1,
+			'comment_author'       => self::SLASH_1,
 			'comment_author_url'   => '',
 			'comment_author_email' => '',
 			'comment_type'         => '',
-			'comment_content'      => $this->slash_7,
+			'comment_content'      => self::SLASH_7,
 		);
 		$comment_id = wp_new_comment( $data );
 
 		$comment = get_comment( $comment_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $comment->comment_author );
-		$this->assertSame( wp_unslash( $this->slash_7 ), $comment->comment_content );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $comment->comment_author );
+		$this->assertSame( wp_unslash( self::SLASH_7 ), $comment->comment_content );
 
 		$data       = array(
 			'comment_post_ID'      => $post_id,
-			'comment_author'       => $this->slash_2,
+			'comment_author'       => self::SLASH_2,
 			'comment_author_url'   => '',
 			'comment_author_email' => '',
 			'comment_type'         => '',
-			'comment_content'      => $this->slash_4,
+			'comment_content'      => self::SLASH_4,
 		);
 		$comment_id = wp_new_comment( $data );
 
 		$comment = get_comment( $comment_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $comment->comment_author );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $comment->comment_content );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $comment->comment_author );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $comment->comment_content );
 	}
 
 	/**
 	 * Tests the controller function that expects slashed data.
+	 *
+	 * @covers ::edit_comment
 	 */
 	public function test_edit_comment() {
 		$post_id    = self::$post_id;
@@ -86,38 +94,40 @@ class Tests_Comment_Slashes extends WP_UnitTestCase {
 		$_POST                            = array();
 		$_POST['comment_ID']              = $comment_id;
 		$_POST['comment_status']          = '';
-		$_POST['newcomment_author']       = $this->slash_1;
+		$_POST['newcomment_author']       = self::SLASH_1;
 		$_POST['newcomment_author_url']   = '';
 		$_POST['newcomment_author_email'] = '';
-		$_POST['content']                 = $this->slash_7;
+		$_POST['content']                 = self::SLASH_7;
 
 		$_POST = add_magic_quotes( $_POST ); // The edit_comment() function will strip slashes.
 
 		edit_comment();
 		$comment = get_comment( $comment_id );
 
-		$this->assertSame( $this->slash_1, $comment->comment_author );
-		$this->assertSame( $this->slash_7, $comment->comment_content );
+		$this->assertSame( self::SLASH_1, $comment->comment_author );
+		$this->assertSame( self::SLASH_7, $comment->comment_content );
 
 		$_POST                            = array();
 		$_POST['comment_ID']              = $comment_id;
 		$_POST['comment_status']          = '';
-		$_POST['newcomment_author']       = $this->slash_2;
+		$_POST['newcomment_author']       = self::SLASH_2;
 		$_POST['newcomment_author_url']   = '';
 		$_POST['newcomment_author_email'] = '';
-		$_POST['content']                 = $this->slash_4;
+		$_POST['content']                 = self::SLASH_4;
 
 		$_POST = add_magic_quotes( $_POST ); // The edit_comment() function will strip slashes.
 
 		edit_comment();
 		$comment = get_comment( $comment_id );
 
-		$this->assertSame( $this->slash_2, $comment->comment_author );
-		$this->assertSame( $this->slash_4, $comment->comment_content );
+		$this->assertSame( self::SLASH_2, $comment->comment_author );
+		$this->assertSame( self::SLASH_4, $comment->comment_content );
 	}
 
 	/**
 	 * Tests the model function that expects slashed data.
+	 *
+	 * @covers ::wp_insert_comment
 	 */
 	public function test_wp_insert_comment() {
 		$post_id = self::$post_id;
@@ -125,30 +135,32 @@ class Tests_Comment_Slashes extends WP_UnitTestCase {
 		$comment_id = wp_insert_comment(
 			array(
 				'comment_post_ID' => $post_id,
-				'comment_author'  => $this->slash_1,
-				'comment_content' => $this->slash_7,
+				'comment_author'  => self::SLASH_1,
+				'comment_content' => self::SLASH_7,
 			)
 		);
 		$comment    = get_comment( $comment_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $comment->comment_author );
-		$this->assertSame( wp_unslash( $this->slash_7 ), $comment->comment_content );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $comment->comment_author );
+		$this->assertSame( wp_unslash( self::SLASH_7 ), $comment->comment_content );
 
 		$comment_id = wp_insert_comment(
 			array(
 				'comment_post_ID' => $post_id,
-				'comment_author'  => $this->slash_2,
-				'comment_content' => $this->slash_4,
+				'comment_author'  => self::SLASH_2,
+				'comment_content' => self::SLASH_4,
 			)
 		);
 		$comment    = get_comment( $comment_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $comment->comment_author );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $comment->comment_content );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $comment->comment_author );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $comment->comment_content );
 	}
 
 	/**
 	 * Tests the model function that expects slashed data.
+	 *
+	 * @covers ::wp_update_comment
 	 */
 	public function test_wp_update_comment() {
 		$post_id    = self::$post_id;
@@ -161,26 +173,26 @@ class Tests_Comment_Slashes extends WP_UnitTestCase {
 		wp_update_comment(
 			array(
 				'comment_ID'      => $comment_id,
-				'comment_author'  => $this->slash_1,
-				'comment_content' => $this->slash_7,
+				'comment_author'  => self::SLASH_1,
+				'comment_content' => self::SLASH_7,
 			)
 		);
 		$comment = get_comment( $comment_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $comment->comment_author );
-		$this->assertSame( wp_unslash( $this->slash_7 ), $comment->comment_content );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $comment->comment_author );
+		$this->assertSame( wp_unslash( self::SLASH_7 ), $comment->comment_content );
 
 		wp_update_comment(
 			array(
 				'comment_ID'      => $comment_id,
-				'comment_author'  => $this->slash_2,
-				'comment_content' => $this->slash_4,
+				'comment_author'  => self::SLASH_2,
+				'comment_content' => self::SLASH_4,
 			)
 		);
 		$comment = get_comment( $comment_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $comment->comment_author );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $comment->comment_content );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $comment->comment_author );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $comment->comment_content );
 	}
 
 }
diff --git a/tests/comment/template.php b/tests/comment/template.php
index 93e88ca107..0632a22863 100644
--- a/tests/comment/template.php
+++ b/tests/comment/template.php
@@ -19,6 +19,9 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 		self::$post_id = self::factory()->post->create();
 	}
 
+	/**
+	 * @covers ::get_comments_number
+	 */
 	public function test_get_comments_number() {
 		$post_id = self::$post_id;
 
@@ -32,6 +35,9 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 		$this->assertSame( '12', get_comments_number( get_post( $post_id ) ) );
 	}
 
+	/**
+	 * @covers ::get_comments_number
+	 */
 	public function test_get_comments_number_without_arg() {
 		$post_id   = self::$post_id;
 		$permalink = get_permalink( $post_id );
@@ -47,10 +53,12 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 48772
+	 *
+	 * @covers ::get_comments_number_text
 	 */
 	public function test_get_comments_number_text_with_post_id() {
 		$post_id = self::$post_id;
-		$this->factory->comment->create_post_comments( $post_id, 6 );
+		self::factory()->comment->create_post_comments( $post_id, 6 );
 
 		$comments_number_text = get_comments_number_text( false, false, false, $post_id );
 
@@ -66,6 +74,8 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 13651
+	 *
+	 * @covers ::get_comments_number_text
 	 */
 	public function test_get_comments_number_text_declension_with_default_args() {
 		$post_id   = self::$post_id;
@@ -74,12 +84,12 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 
 		$this->assertSame( __( 'No Comments' ), get_comments_number_text() );
 
-		$this->factory->comment->create_post_comments( $post_id, 1 );
+		self::factory()->comment->create_post_comments( $post_id, 1 );
 		$this->go_to( $permalink );
 
 		$this->assertSame( __( '1 Comment' ), get_comments_number_text() );
 
-		$this->factory->comment->create_post_comments( $post_id, 1 );
+		self::factory()->comment->create_post_comments( $post_id, 1 );
 		$this->go_to( $permalink );
 
 		$this->assertSame( sprintf( _n( '%s Comment', '%s Comments', 2 ), '2' ), get_comments_number_text() );
@@ -89,12 +99,14 @@ class Tests_Comment_Template extends WP_UnitTestCase {
 	/**
 	 * @ticket 13651
 	 * @dataProvider data_get_comments_number_text_declension
+	 *
+	 * @covers ::get_comments_number_text
 	 */
 	public function test_get_comments_number_text_declension_with_custom_args( $number, $input, $output ) {
 		$post_id   = self::$post_id;
 		$permalink = get_permalink( $post_id );
 
-		$this->factory->comment->create_post_comments( $post_id, $number );
+		self::factory()->comment->create_post_comments( $post_id, $number );
 		$this->go_to( $permalink );
 
 		add_filter( 'gettext_with_context', array( $this, 'enable_comment_number_declension' ), 10, 4 );
diff --git a/tests/comment/walker.php b/tests/comment/walker.php
index 1027a96d14..504c5e3b0f 100644
--- a/tests/comment/walker.php
+++ b/tests/comment/walker.php
@@ -2,9 +2,18 @@
 
 /**
  * @group comment
+ *
+ * @covers ::wp_list_comments
  */
 class Tests_Comment_Walker extends WP_UnitTestCase {
 
+	/**
+	 * Comment post ID.
+	 *
+	 * @var int
+	 */
+	private $post_id;
+
 	public function set_up() {
 		parent::set_up();
 
@@ -26,7 +35,7 @@ class Tests_Comment_Walker extends WP_UnitTestCase {
 		$comment_child  = get_comment( $comment_child );
 
 		$comment_walker   = new Walker_Comment();
-		$comment_callback = new Comment_Callback_Test( $this, $comment_walker );
+		$comment_callback = new Comment_Callback_Test_Helper( $this, $comment_walker );
 
 		wp_list_comments(
 			array(
@@ -47,7 +56,10 @@ class Tests_Comment_Walker extends WP_UnitTestCase {
 	}
 }
 
-class Comment_Callback_Test {
+class Comment_Callback_Test_Helper {
+	private $test_walker;
+	private $walker;
+
 	public function __construct( Tests_Comment_Walker $test_walker, Walker_Comment $walker ) {
 		$this->test_walker = $test_walker;
 		$this->walker      = $walker;
diff --git a/tests/comment/wpAllowComment.php b/tests/comment/wpAllowComment.php
index c7c32758b6..8b3de23fc1 100644
--- a/tests/comment/wpAllowComment.php
+++ b/tests/comment/wpAllowComment.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::wp_allow_comment
  */
 class Tests_Comment_WpAllowComment extends WP_UnitTestCase {
 	protected static $post_id;
diff --git a/tests/comment/wpBatchUpdateCommentType.php b/tests/comment/wpBatchUpdateCommentType.php
index c900e0aaf4..85a89e4cfc 100644
--- a/tests/comment/wpBatchUpdateCommentType.php
+++ b/tests/comment/wpBatchUpdateCommentType.php
@@ -2,6 +2,7 @@
 
 /**
  * @group comment
+ *
  * @covers ::_wp_batch_update_comment_type
  */
 class Tests_Batch_Update_Comment_Type extends WP_UnitTestCase {
diff --git a/tests/comment/wpComment.php b/tests/comment/wpComment.php
index 9e0dec75e4..d5a7119deb 100644
--- a/tests/comment/wpComment.php
+++ b/tests/comment/wpComment.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers WP_Comment::get_instance
  */
 class Tests_Term_WpComment extends WP_UnitTestCase {
 	protected static $comment_id;
diff --git a/tests/comment/wpCountComments.php b/tests/comment/wpCountComments.php
index 5586889ba2..ef3e337261 100644
--- a/tests/comment/wpCountComments.php
+++ b/tests/comment/wpCountComments.php
@@ -1,5 +1,12 @@
 <?php
 
+/**
+ * @group comment
+ *
+ * Class Tests_WP_Count_Comments
+ *
+ * @covers ::wp_count_comments
+ */
 class Tests_WP_Count_Comments extends WP_UnitTestCase {
 
 	public function test_wp_count_comments() {
diff --git a/tests/comment/wpListComments.php b/tests/comment/wpListComments.php
index 238c6b796e..f49ef84561 100644
--- a/tests/comment/wpListComments.php
+++ b/tests/comment/wpListComments.php
@@ -2,6 +2,8 @@
 
 /**
  * @group comment
+ *
+ * @covers ::wp_list_comments
  */
 class Tests_Comment_WpListComments extends WP_UnitTestCase {
 	/**
diff --git a/tests/comment/wpUpdateCommentCountNow.php b/tests/comment/wpUpdateCommentCountNow.php
index 2d055ca9ca..58b6b0d03b 100644
--- a/tests/comment/wpUpdateCommentCountNow.php
+++ b/tests/comment/wpUpdateCommentCountNow.php
@@ -2,6 +2,7 @@
 
 /**
  * @group  comment
+ *
  * @covers ::wp_update_comment_count_now
  */
 class Tests_Update_Comment_Count_Now extends WP_UnitTestCase {
diff --git a/tests/cron.php b/tests/cron.php
index 36d5edd7dd..ebb709fec9 100644
--- a/tests/cron.php
+++ b/tests/cron.php
@@ -30,12 +30,18 @@ class Tests_Cron extends WP_UnitTestCase {
 		parent::tear_down();
 	}
 
+	/**
+	 * @covers ::wp_get_schedule
+	 */
 	public function test_wp_get_schedule_empty() {
 		// Nothing scheduled.
 		$hook = __FUNCTION__;
 		$this->assertFalse( wp_get_schedule( $hook ) );
 	}
 
+	/**
+	 * @covers ::wp_schedule_single_event
+	 */
 	public function test_schedule_event_single() {
 		// Schedule an event and make sure it's returned by wp_next_scheduled().
 		$hook      = __FUNCTION__;
@@ -50,6 +56,9 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * @covers ::wp_schedule_single_event
+	 */
 	public function test_schedule_event_single_args() {
 		// Schedule an event with arguments and make sure it's returned by wp_next_scheduled().
 		$hook      = 'event';
@@ -68,6 +77,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertFalse( wp_get_schedule( $hook, $args ) );
 	}
 
+	/**
+	 * @covers ::wp_schedule_event
+	 */
 	public function test_schedule_event() {
 		// Schedule an event and make sure it's returned by wp_next_scheduled().
 		$hook      = __FUNCTION__;
@@ -82,6 +94,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertSame( $recur, wp_get_schedule( $hook ) );
 	}
 
+	/**
+	 * @covers ::wp_schedule_event
+	 */
 	public function test_schedule_event_args() {
 		// Schedule an event and make sure it's returned by wp_next_scheduled().
 		$hook      = 'event';
@@ -102,20 +117,21 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * Tests that a call to wp_schedule_event() on a site without any scheduled events
-	 * does not result in a PHP deprecation warning on PHP 8.1 or higher.
+	 * does not result in a PHP deprecation notice on PHP 8.1 or higher.
 	 *
-	 * The warning that we should not see:
+	 * The notice that we should not see:
 	 * `Deprecated: Automatic conversion of false to array is deprecated`.
 	 *
 	 * @ticket 53635
 	 *
 	 * @covers ::wp_schedule_event
 	 */
-	public function test_wp_schedule_event_without_cron_option_does_not_throw_warning() {
+	public function test_wp_schedule_event_without_cron_option_does_not_throw_deprecation_notice() {
 		delete_option( 'cron' );
 
 		// Verify that the cause of the error is in place.
-		$this->assertFalse( _get_cron_array(), '_get_cron_array() does not return false' );
+		$this->assertIsArray( _get_cron_array(), '_get_cron_array() does not return an array.' );
+		$this->assertEmpty( _get_cron_array(), '_get_cron_array() does not return an empty array.' );
 
 		$hook      = __FUNCTION__;
 		$timestamp = strtotime( '+10 minutes' );
@@ -136,7 +152,8 @@ class Tests_Cron extends WP_UnitTestCase {
 		delete_option( 'cron' );
 
 		// Verify that the cause of the error is in place.
-		$this->assertFalse( _get_cron_array(), '_get_cron_array() does not return false' );
+		$this->assertIsArray( _get_cron_array(), '_get_cron_array() does not return an array.' );
+		$this->assertEmpty( _get_cron_array(), '_get_cron_array() does not return an empty array.' );
 
 		$hook      = __FUNCTION__;
 		$timestamp = strtotime( '+10 minutes' );
@@ -148,6 +165,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertNotContains( false, get_option( 'cron' ), 'Resulting cron array contains the value "false"' );
 	}
 
+	/**
+	 * @covers ::wp_unschedule_event
+	 */
 	public function test_unschedule_event() {
 		// Schedule an event and make sure it's returned by wp_next_scheduled().
 		$hook      = __FUNCTION__;
@@ -162,6 +182,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertFalse( wp_next_scheduled( $hook ) );
 	}
 
+	/**
+	 * @covers ::wp_clear_scheduled_hook
+	 */
 	public function test_clear_schedule() {
 		$hook = __FUNCTION__;
 		$args = array( 'arg1' );
@@ -189,6 +212,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertFalse( wp_next_scheduled( $hook, $args ) );
 	}
 
+	/**
+	 * @covers ::wp_clear_scheduled_hook
+	 */
 	public function test_clear_undefined_schedule() {
 		$hook = __FUNCTION__;
 		$args = array( 'arg1' );
@@ -201,6 +227,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertSame( 0, $hook_unscheduled );
 	}
 
+	/**
+	 * @covers ::wp_clear_scheduled_hook
+	 */
 	public function test_clear_schedule_multiple_args() {
 		$hook = __FUNCTION__;
 		$args = array( 'arg1', 'arg2' );
@@ -229,6 +258,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 10468
+	 *
+	 * @covers ::wp_clear_scheduled_hook
 	 */
 	public function test_clear_schedule_new_args() {
 		$hook       = __FUNCTION__;
@@ -267,10 +298,12 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 18997
+	 *
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_hook() {
 		$hook = __FUNCTION__;
-		$args = array( rand_str() );
+		$args = array( 'foo' );
 
 		// Schedule several events with and without arguments.
 		wp_schedule_single_event( strtotime( '+1 hour' ), $hook );
@@ -288,6 +321,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertFalse( wp_next_scheduled( $hook ) );
 	}
 
+	/**
+	 * @covers ::wp_unschedule_hook
+	 */
 	public function test_unschedule_undefined_hook() {
 		$hook           = __FUNCTION__;
 		$unrelated_hook = __FUNCTION__ . '_two';
@@ -308,6 +344,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 6966
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_duplicate_event() {
 		// Duplicate events close together should be skipped.
@@ -331,6 +369,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 6966
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_not_duplicate_event() {
 		// Duplicate events far apart should work normally.
@@ -351,6 +391,9 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertSame( $ts1, wp_next_scheduled( $hook, $args ) );
 	}
 
+	/**
+	 * @covers ::wp_schedule_single_event
+	 */
 	public function test_not_duplicate_event_reversed() {
 		// Duplicate events far apart should work normally regardless of order.
 		$hook = __FUNCTION__;
@@ -375,6 +418,9 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * modification of the cron_array_option.
 	 *
 	 * @ticket 32656
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
 	 */
 	public function test_pre_schedule_event_filter() {
 		$hook = __FUNCTION__;
@@ -427,6 +473,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * modification of the cron_array_option.
 	 *
 	 * @ticket 32656
+	 *
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_pre_reschedule_event_filter() {
 		$hook = __FUNCTION__;
@@ -451,6 +499,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * modification of the cron_array_option.
 	 *
 	 * @ticket 32656
+	 *
+	 * @covers ::wp_unschedule_event
 	 */
 	public function test_pre_unschedule_event_filter() {
 		$hook = __FUNCTION__;
@@ -475,6 +525,9 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * modification of the cron_array_option.
 	 *
 	 * @ticket 32656
+	 *
+	 * @covers ::wp_clear_scheduled_hook
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_pre_clear_scheduled_hook_filters() {
 		$hook = __FUNCTION__;
@@ -506,6 +559,9 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * return a filtered value as expected.
 	 *
 	 * @ticket 32656
+	 *
+	 * @covers ::wp_get_scheduled_event
+	 * @covers ::wp_next_scheduled
 	 */
 	public function test_pre_scheduled_event_hooks() {
 		add_filter( 'pre_get_scheduled_event', array( $this, 'filter_pre_scheduled_event_hooks' ) );
@@ -540,6 +596,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * When a timestamp is specified, a particular event should be returned.
 	 *
 	 * @ticket 45976.
+	 *
+	 * @covers ::wp_get_scheduled_event
 	 */
 	public function test_get_scheduled_event_singles() {
 		$hook    = __FUNCTION__;
@@ -583,6 +641,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * When a timestamp is specified, a particular event should be returned.
 	 *
 	 * @ticket 45976.
+	 *
+	 * @covers ::wp_get_scheduled_event
 	 */
 	public function test_get_scheduled_event_recurring() {
 		$hook     = __FUNCTION__;
@@ -627,6 +687,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * Ensure wp_get_scheduled_event() returns false when expected.
 	 *
 	 * @ticket 45976.
+	 *
+	 * @covers ::wp_get_scheduled_event
 	 */
 	public function test_get_scheduled_event_false() {
 		$hook = __FUNCTION__;
@@ -652,6 +714,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * Ensure any past event counts as a duplicate.
 	 *
 	 * @ticket 44818
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_duplicate_past_event() {
 		$hook = __FUNCTION__;
@@ -679,6 +743,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * Ensure any near future event counts as a duplicate.
 	 *
 	 * @ticket 44818
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_duplicate_near_future_event() {
 		$hook = __FUNCTION__;
@@ -707,6 +773,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * Duplicate future events are disallowed.
 	 *
 	 * @ticket 44818
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_duplicate_future_event() {
 		$hook = __FUNCTION__;
@@ -731,6 +799,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	 * Future events are allowed.
 	 *
 	 * @ticket 44818
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_not_duplicate_future_event() {
 		$hook = __FUNCTION__;
@@ -749,6 +819,11 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
+	 * @covers ::wp_unschedule_event
 	 */
 	public function test_invalid_timestamp_for_event_returns_error() {
 		$single_event      = wp_schedule_single_event( -50, 'hook', array(), true );
@@ -771,6 +846,9 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_invalid_recurrence_for_event_returns_error() {
 		$event             = wp_schedule_event( time(), 'invalid', 'hook', array(), true );
@@ -785,6 +863,10 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_disallowed_event_returns_false_when_wp_error_is_set_to_false() {
 		add_filter( 'schedule_event', '__return_false' );
@@ -800,6 +882,10 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_disallowed_event_returns_error_when_wp_error_is_set_to_true() {
 		add_filter( 'schedule_event', '__return_false' );
@@ -820,6 +906,10 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_schedule_short_circuit_with_error_returns_false_when_wp_error_is_set_to_false() {
 		$return_error = function( $pre, $event, $wp_error ) {
@@ -848,6 +938,10 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_schedule_short_circuit_with_error_returns_error_when_wp_error_is_set_to_true() {
 		$return_error = function( $pre, $event, $wp_error ) {
@@ -881,6 +975,10 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_schedule_short_circuit_with_false_returns_false_when_wp_error_is_set_to_false() {
 		// Add filters which return false:
@@ -900,6 +998,10 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
+	 * @covers ::wp_schedule_event
+	 * @covers ::wp_reschedule_event
 	 */
 	public function test_schedule_short_circuit_with_false_returns_error_when_wp_error_is_set_to_true() {
 		// Add filters which return false:
@@ -925,6 +1027,8 @@ class Tests_Cron extends WP_UnitTestCase {
 	/**
 	 * @ticket 49961
 	 * @expectedDeprecated wp_clear_scheduled_hook
+	 *
+	 * @covers ::wp_clear_scheduled_hook
 	 */
 	public function test_deprecated_argument_usage_of_wp_clear_scheduled_hook() {
 		$return_pre = function( $pre, $hook, $args, $wp_error ) {
@@ -943,6 +1047,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_clear_scheduled_hook
 	 */
 	public function test_clear_scheduled_hook_returns_default_pre_filter_error_when_wp_error_is_set_to_true() {
 		add_filter( 'pre_unschedule_event', '__return_false' );
@@ -964,6 +1070,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_clear_scheduled_hook
 	 */
 	public function test_clear_scheduled_hook_returns_custom_pre_filter_error_when_wp_error_is_set_to_true() {
 		$return_error = function( $pre, $timestamp, $hook, $args, $wp_error ) {
@@ -997,6 +1105,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_short_circuit_with_error_returns_false_when_wp_error_is_set_to_false() {
 		$return_error = function( $pre, $hook, $wp_error ) {
@@ -1020,6 +1130,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_short_circuit_with_error_returns_error_when_wp_error_is_set_to_true() {
 		$return_error = function( $pre, $hook, $wp_error ) {
@@ -1044,6 +1156,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_short_circuit_with_false_returns_false_when_wp_error_is_set_to_false() {
 		// Add a filter which returns false:
@@ -1058,6 +1172,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_unschedule_short_circuit_with_false_returns_error_when_wp_error_is_set_to_true() {
 		// Add a filter which returns false:
@@ -1073,6 +1189,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_single_event
 	 */
 	public function test_cron_array_error_is_returned_when_scheduling_single_event() {
 		// Force update_option() to fail by setting the new value to match the existing:
@@ -1093,6 +1211,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_schedule_event
 	 */
 	public function test_cron_array_error_is_returned_when_scheduling_event() {
 		// Force update_option() to fail by setting the new value to match the existing:
@@ -1113,6 +1233,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_unschedule_hook
 	 */
 	public function test_cron_array_error_is_returned_when_unscheduling_hook() {
 		// Schedule a valid event:
@@ -1137,6 +1259,8 @@ class Tests_Cron extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49961
+	 *
+	 * @covers ::wp_unschedule_event
 	 */
 	public function test_cron_array_error_is_returned_when_unscheduling_event() {
 		// Schedule a valid event:
diff --git a/tests/cron/getCronArray.php b/tests/cron/getCronArray.php
new file mode 100644
index 0000000000..24ec1c4724
--- /dev/null
+++ b/tests/cron/getCronArray.php
@@ -0,0 +1,120 @@
+<?php
+
+/**
+ * Test the `_get_cron_array()` function.
+ *
+ * @group cron
+ * @covers ::_get_cron_array
+ */
+class Tests_Cron_getCronArray extends WP_UnitTestCase {
+
+	public function set_up() {
+		parent::set_up();
+		// Make sure the schedule is clear.
+		_set_cron_array( array() );
+	}
+
+	public function tear_down() {
+		// Make sure the schedule is clear.
+		_set_cron_array( array() );
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests the output validation for the `_get_cron_array()` function when the option is unset.
+	 *
+	 * @ticket 53940
+	 */
+	public function test_get_cron_array_output_validation_with_no_option() {
+		delete_option( 'cron' );
+
+		$crons = _get_cron_array();
+		$this->assertIsArray( $crons, 'Cron jobs is not an array.' );
+		$this->assertCount( 0, $crons, 'Cron job does not contain the expected number of entries.' );
+	}
+
+	/**
+	 * Tests the output validation for the `_get_cron_array()` function.
+	 *
+	 * @ticket 53940
+	 *
+	 * @dataProvider data_get_cron_array_output_validation
+	 *
+	 * @param mixed $input    Cron "array".
+	 * @param int   $expected Expected array entry count of the cron option after update.
+	 */
+	public function test_get_cron_array_output_validation( $input, $expected ) {
+		update_option( 'cron', $input );
+
+		$crons = _get_cron_array();
+		$this->assertIsArray( $crons, 'Cron jobs is not an array.' );
+		$this->assertCount( $expected, $crons, 'Cron job does not contain the expected number of entries.' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_cron_array_output_validation() {
+		return array(
+			'stdClass'    => array(
+				'input'    => new stdClass(),
+				'expected' => 0,
+			),
+			'null'        => array(
+				'input'    => null,
+				'expected' => 0,
+			),
+			'false'       => array(
+				'input'    => false,
+				'expected' => 0,
+			),
+			'true'        => array(
+				'input'    => true,
+				'expected' => 0,
+			),
+			'integer'     => array(
+				'input'    => 53940,
+				'expected' => 0,
+			),
+			'float'       => array(
+				'input'    => 539.40,
+				'expected' => 0,
+			),
+			'string'      => array(
+				'input'    => 'ticket 53940',
+				'expected' => 0,
+			),
+			'empty array' => array(
+				'input'    => array(),
+				'expected' => 0,
+			),
+			'cron array'  => array(
+				'input'    => array(
+					'version' => 2,
+					time()    => array(
+						'hookname' => array(
+							'event key' => array(
+								'schedule' => 'schedule',
+								'args'     => 'args',
+								'interval' => 'interval',
+							),
+						),
+					),
+				),
+				'expected' => 1,
+			),
+			'cron v1'     => array(
+				'input'    => array(
+					time() => array(
+						'hookname' => array(
+							'args' => 'args',
+						),
+					),
+				),
+				'expected' => 1,
+			),
+		);
+	}
+}
diff --git a/tests/cron/setCronArray.php b/tests/cron/setCronArray.php
index 30e7eddec3..028d403f23 100644
--- a/tests/cron/setCronArray.php
+++ b/tests/cron/setCronArray.php
@@ -24,9 +24,9 @@ class Tests_Cron_setCronArray extends WP_UnitTestCase {
 	 * Tests the input validation for the `_set_cron_array()` function.
 	 *
 	 * Includes verifying that invalid input - typically `false` - does not result in a PHP
-	 * deprecation warning on PHP 8.1 or higher.
+	 * deprecation notice on PHP 8.1 or higher.
 	 *
-	 * The warning that we should not see:
+	 * The notice that we should not see:
 	 * `Deprecated: Automatic conversion of false to array is deprecated`.
 	 *
 	 * @ticket 53635
diff --git a/tests/customize/control.php b/tests/customize/control.php
index c83418c301..2131bdc844 100644
--- a/tests/customize/control.php
+++ b/tests/customize/control.php
@@ -26,7 +26,7 @@ class Test_WP_Customize_Control extends WP_UnitTestCase {
 	 */
 	public function set_up() {
 		parent::set_up();
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		require_once ABSPATH . WPINC . '/class-wp-customize-manager.php';
 		$GLOBALS['wp_customize'] = new WP_Customize_Manager();
 		$this->wp_customize      = $GLOBALS['wp_customize'];
@@ -138,21 +138,21 @@ class Test_WP_Customize_Control extends WP_UnitTestCase {
 		$this->assertStringContainsString( '<option value="0">', $content, 'Dropdown-pages renders select even without any pages published.' );
 
 		// Ensure that auto-draft pages are included if they are among the nav_menus_created_posts.
-		$auto_draft_page_id = $this->factory()->post->create(
+		$auto_draft_page_id = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_status' => 'auto-draft',
 				'post_title'  => 'Auto Draft Page',
 			)
 		);
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_status' => 'auto-draft',
 				'post_title'  => 'Orphan Auto Draft Page',
 			)
 		);
-		$auto_draft_post_id = $this->factory()->post->create(
+		$auto_draft_post_id = self::factory()->post->create(
 			array(
 				'post_type'   => 'post',
 				'post_status' => 'auto-draft',
diff --git a/tests/customize/custom-css-setting.php b/tests/customize/custom-css-setting.php
index e23418ea61..f651b509a8 100644
--- a/tests/customize/custom-css-setting.php
+++ b/tests/customize/custom-css-setting.php
@@ -120,7 +120,7 @@ class Test_WP_Customize_Custom_CSS_Setting extends WP_UnitTestCase {
 		$this->assertNull( wp_get_custom_css_post( 'twentyten' ) );
 
 		$original_css      = 'body { color: black; }';
-		$post_id           = $this->factory()->post->create(
+		$post_id           = self::factory()->post->create(
 			array(
 				'post_title'   => $this->setting->stylesheet,
 				'post_name'    => $this->setting->stylesheet,
@@ -130,7 +130,7 @@ class Test_WP_Customize_Custom_CSS_Setting extends WP_UnitTestCase {
 			)
 		);
 		$twentyten_css     = 'body { color: red; }';
-		$twentyten_post_id = $this->factory()->post->create(
+		$twentyten_post_id = self::factory()->post->create(
 			array(
 				'post_title'   => 'twentyten',
 				'post_name'    => 'twentyten',
@@ -273,7 +273,7 @@ class Test_WP_Customize_Custom_CSS_Setting extends WP_UnitTestCase {
 		$this->setting->default = '/*default*/';
 		$this->assertSame( '/*default*//*filtered*/', $this->setting->value() );
 
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'   => $this->setting->stylesheet,
 				'post_name'    => $this->setting->stylesheet,
@@ -310,7 +310,7 @@ class Test_WP_Customize_Custom_CSS_Setting extends WP_UnitTestCase {
 	 */
 	public function test_update_filter() {
 		$original_css = 'body { color:red; }';
-		$post_id      = $this->factory()->post->create(
+		$post_id      = self::factory()->post->create(
 			array(
 				'post_title'   => $this->setting->stylesheet,
 				'post_name'    => $this->setting->stylesheet,
diff --git a/tests/customize/manager.php b/tests/customize/manager.php
index e3fd37059b..df6679ebc7 100644
--- a/tests/customize/manager.php
+++ b/tests/customize/manager.php
@@ -19,13 +19,6 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 */
 	public $manager;
 
-	/**
-	 * Symbol.
-	 *
-	 * @var stdClass
-	 */
-	public $undefined;
-
 	/**
 	 * Admin user ID.
 	 *
@@ -40,6 +33,20 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 */
 	protected static $subscriber_user_id;
 
+	/**
+	 * Path to test file 1.
+	 *
+	 * @var string
+	 */
+	private $test_file;
+
+	/**
+	 * Path to test file 2.
+	 *
+	 * @var string
+	 */
+	private $test_file2;
+
 	/**
 	 * Set up before class.
 	 *
@@ -56,8 +63,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 		require_once ABSPATH . WPINC . '/class-wp-customize-manager.php';
-		$this->manager   = $this->instantiate();
-		$this->undefined = new stdClass();
+		$this->manager = $this->instantiate();
 
 		$orig_file       = DIR_TESTDATA . '/images/canola.jpg';
 		$this->test_file = get_temp_dir() . 'canola.jpg';
@@ -156,7 +162,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 */
 	public function test_constructor_deferred_changeset_uuid() {
 		wp_set_current_user( self::$admin_user_id );
-		$other_admin_user_id = $this->factory()->user->create( array( 'role' => 'admin' ) );
+		$other_admin_user_id = self::factory()->user->create( array( 'role' => 'admin' ) );
 
 		$data = array(
 			'blogname' => array(
@@ -165,7 +171,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		);
 
 		$uuid1 = wp_generate_uuid4();
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type'     => 'customize_changeset',
 				'post_name'     => $uuid1,
@@ -181,7 +187,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		 * as in non-branching mode there should only be one pending changeset at a time.
 		 */
 		$uuid2   = wp_generate_uuid4();
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_type'     => 'customize_changeset',
 				'post_name'     => $uuid2,
@@ -418,7 +424,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 */
 	public function test_find_changeset_post_id() {
 		$uuid    = wp_generate_uuid4();
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_name'    => $uuid,
 				'post_type'    => 'customize_changeset',
@@ -448,7 +454,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 
 		$uuid         = wp_generate_uuid4();
 		$wp_customize = new WP_Customize_Manager( array( 'changeset_uuid' => $uuid ) );
-		$post_id      = $this->factory()->post->create(
+		$post_id      = self::factory()->post->create(
 			array(
 				'post_name'    => $uuid,
 				'post_type'    => 'customize_changeset',
@@ -476,7 +482,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 			'blogname'        => array( 'value' => 'Hello World' ),
 			'blogdescription' => array( 'value' => 'Greet the world' ),
 		);
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_name'    => $uuid,
 				'post_type'    => 'customize_changeset',
@@ -559,14 +565,14 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 				'post_name'      => 'canola',
 			)
 		);
-		$existing_published_home_page_id   = $this->factory()->post->create(
+		$existing_published_home_page_id   = self::factory()->post->create(
 			array(
 				'post_name'   => 'home',
 				'post_type'   => 'page',
 				'post_status' => 'publish',
 			)
 		);
-		$existing_auto_draft_about_page_id = $this->factory()->post->create(
+		$existing_auto_draft_about_page_id = self::factory()->post->create(
 			array(
 				'post_name'   => 'about',
 				'post_type'   => 'page',
@@ -814,7 +820,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	public function test_import_theme_starter_content_with_nested_arrays() {
 		wp_set_current_user( self::$admin_user_id );
 
-		$existing_published_home_page_id = $this->factory()->post->create(
+		$existing_published_home_page_id = self::factory()->post->create(
 			array(
 				'post_name'   => 'home',
 				'post_type'   => 'page',
@@ -1872,7 +1878,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$r = $wp_customize->save_changeset_post(
 			array(
 				'autosave' => true,
-				'user_id'  => $this->factory()->user->create( array( 'role' => 'administrator' ) ),
+				'user_id'  => self::factory()->user->create( array( 'role' => 'administrator' ) ),
 			)
 		);
 		$this->assertSame( 'illegal_autosave_with_non_current_user', $r->get_error_code() );
@@ -2025,7 +2031,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$this->assertGreaterThan( 2, count( $new_sidebars_widgets['sidebar-1'] ) );
 		$new_sidebar_1 = array_reverse( $new_sidebars_widgets['sidebar-1'] );
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_type'    => 'customize_changeset',
 				'post_status'  => 'draft',
@@ -2329,7 +2335,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 				'value' => 'Changeset Tagline',
 			),
 		);
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type'    => 'customize_changeset',
 				'post_status'  => 'auto-draft',
@@ -2824,7 +2830,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		}
 		$this->assertFalse( $this->manager->has_published_pages() );
 
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_status' => 'private',
@@ -2832,7 +2838,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		);
 		$this->assertFalse( $this->manager->has_published_pages() );
 
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_status' => 'publish',
@@ -2858,7 +2864,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$setting_id = 'nav_menus_created_posts';
 		$setting    = $this->manager->get_setting( $setting_id );
 		$this->assertInstanceOf( 'WP_Customize_Filter_Setting', $setting );
-		$auto_draft_page = $this->factory()->post->create(
+		$auto_draft_page = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_status' => 'auto-draft',
diff --git a/tests/customize/nav-menus.php b/tests/customize/nav-menus.php
index e786e15183..5785558103 100644
--- a/tests/customize/nav-menus.php
+++ b/tests/customize/nav-menus.php
@@ -417,7 +417,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 			)
 		);
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'taxonomy' => 'wptests_tax',
 				'name'     => 'foobar',
@@ -851,11 +851,11 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 	 */
 	public function test_sanitize_nav_menus_created_posts() {
 		$menus                 = new WP_Customize_Nav_Menus( $this->wp_customize );
-		$contributor_user_id   = $this->factory()->user->create( array( 'role' => 'contributor' ) );
-		$author_user_id        = $this->factory()->user->create( array( 'role' => 'author' ) );
-		$administrator_user_id = $this->factory()->user->create( array( 'role' => 'administrator' ) );
+		$contributor_user_id   = self::factory()->user->create( array( 'role' => 'contributor' ) );
+		$author_user_id        = self::factory()->user->create( array( 'role' => 'author' ) );
+		$administrator_user_id = self::factory()->user->create( array( 'role' => 'administrator' ) );
 
-		$contributor_post_id   = $this->factory()->post->create(
+		$contributor_post_id   = self::factory()->post->create(
 			array(
 				'post_status' => 'auto-draft',
 				'post_title'  => 'Contributor Post',
@@ -863,7 +863,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 				'post_author' => $contributor_user_id,
 			)
 		);
-		$author_post_id        = $this->factory()->post->create(
+		$author_post_id        = self::factory()->post->create(
 			array(
 				'post_status' => 'auto-draft',
 				'post_title'  => 'Author Post',
@@ -871,7 +871,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 				'post_author' => $author_user_id,
 			)
 		);
-		$administrator_post_id = $this->factory()->post->create(
+		$administrator_post_id = self::factory()->post->create(
 			array(
 				'post_status' => 'auto-draft',
 				'post_title'  => 'Admin Post',
@@ -880,7 +880,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 			)
 		);
 
-		$draft_post_id = $this->factory()->post->create(
+		$draft_post_id = self::factory()->post->create(
 			array(
 				'post_status' => 'draft',
 				'post_title'  => 'Draft',
@@ -888,7 +888,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 			)
 		);
 
-		$private_post_id = $this->factory()->post->create(
+		$private_post_id = self::factory()->post->create(
 			array(
 				'post_status' => 'private',
 				'post_title'  => 'Private',
@@ -990,7 +990,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 		$post_ids[]      = $r->ID;
 		$trashed_post_id = $r->ID;
 
-		$pre_published_post_id = $this->factory()->post->create( array( 'post_status' => 'publish' ) );
+		$pre_published_post_id = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$setting_id = 'nav_menus_created_posts';
 		$this->wp_customize->set_post_value( $setting_id, array_merge( $post_ids, array( $pre_published_post_id ) ) );
diff --git a/tests/customize/panel.php b/tests/customize/panel.php
index 5aeaa6cb0b..ab7859499e 100644
--- a/tests/customize/panel.php
+++ b/tests/customize/panel.php
@@ -17,7 +17,6 @@ class Tests_WP_Customize_Panel extends WP_UnitTestCase {
 		require_once ABSPATH . WPINC . '/class-wp-customize-manager.php';
 		$GLOBALS['wp_customize'] = new WP_Customize_Manager();
 		$this->manager           = $GLOBALS['wp_customize'];
-		$this->undefined         = new stdClass();
 	}
 
 	public function tear_down() {
diff --git a/tests/customize/section.php b/tests/customize/section.php
index 50d58091b3..da35a54eaa 100644
--- a/tests/customize/section.php
+++ b/tests/customize/section.php
@@ -24,7 +24,6 @@ class Tests_WP_Customize_Section extends WP_UnitTestCase {
 		require_once ABSPATH . WPINC . '/class-wp-customize-manager.php';
 		$GLOBALS['wp_customize'] = new WP_Customize_Manager();
 		$this->manager           = $GLOBALS['wp_customize'];
-		$this->undefined         = new stdClass();
 	}
 
 	public function tear_down() {
diff --git a/tests/customize/setting.php b/tests/customize/setting.php
index 3e9fb1db9b..7645ec4c6a 100644
--- a/tests/customize/setting.php
+++ b/tests/customize/setting.php
@@ -137,7 +137,7 @@ class Tests_WP_Customize_Setting extends WP_UnitTestCase {
 	 * @see WP_Customize_Setting::value()
 	 */
 	public function test_preview_standard_types_non_multidimensional() {
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		$_POST['customized'] = wp_slash( wp_json_encode( $this->post_data_overrides ) );
 
 		// Try non-multidimensional settings.
@@ -216,7 +216,7 @@ class Tests_WP_Customize_Setting extends WP_UnitTestCase {
 	 * @see WP_Customize_Setting::value()
 	 */
 	public function test_preview_standard_types_multidimensional() {
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		$_POST['customized'] = wp_slash( wp_json_encode( $this->post_data_overrides ) );
 
 		foreach ( $this->standard_type_configs as $type => $type_options ) {
@@ -362,7 +362,7 @@ class Tests_WP_Customize_Setting extends WP_UnitTestCase {
 	 * @see WP_Customize_Setting::preview()
 	 */
 	public function test_preview_custom_type() {
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		$type                = 'custom_type';
 		$post_data_overrides = array(
 			"unset_{$type}_with_post_value" => "unset_{$type}_without_post_value\\o/",
@@ -551,7 +551,7 @@ class Tests_WP_Customize_Setting extends WP_UnitTestCase {
 	 * @ticket 31428
 	 */
 	public function test_is_current_blog_previewed() {
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		$type       = 'option';
 		$name       = 'blogname';
 		$post_value = __FUNCTION__;
@@ -743,7 +743,7 @@ class Tests_WP_Customize_Setting extends WP_UnitTestCase {
 	 * @ticket 37294
 	 */
 	public function test_multidimensional_value_when_previewed() {
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 		WP_Customize_Setting::reset_aggregated_multidimensionals();
 
 		$initial_value = 456;
diff --git a/tests/date/currentDatetime.php b/tests/date/currentDatetime.php
new file mode 100644
index 0000000000..21ef037897
--- /dev/null
+++ b/tests/date/currentDatetime.php
@@ -0,0 +1,16 @@
+<?php
+
+/**
+ * @group date
+ * @group datetime
+ * @covers ::current_datetime
+ */
+class Tests_Date_CurrentDatetime extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 53484
+	 */
+	public function test_current_datetime_return_type() {
+		$this->assertInstanceOf( 'DateTimeImmutable', current_datetime() );
+	}
+}
diff --git a/tests/date/currentTime.php b/tests/date/currentTime.php
index c98292ef0d..72d50abfba 100644
--- a/tests/date/currentTime.php
+++ b/tests/date/currentTime.php
@@ -7,6 +7,17 @@
  */
 class Tests_Date_CurrentTime extends WP_UnitTestCase {
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset changed options to their default value.
+		update_option( 'gmt_offset', 0 );
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 34378
 	 */
diff --git a/tests/date/dateI18n.php b/tests/date/dateI18n.php
index 9279aca4eb..5bd340b91d 100644
--- a/tests/date/dateI18n.php
+++ b/tests/date/dateI18n.php
@@ -7,6 +7,17 @@
  */
 class Tests_Date_DateI18n extends WP_UnitTestCase {
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset changed options to their default value.
+		update_option( 'gmt_offset', 0 );
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 28636
 	 */
diff --git a/tests/date/getFeedBuildDate.php b/tests/date/getFeedBuildDate.php
index 23d97aa473..5f0416ce53 100644
--- a/tests/date/getFeedBuildDate.php
+++ b/tests/date/getFeedBuildDate.php
@@ -11,7 +11,7 @@ class Tests_Date_GetFeedBuildDate extends WP_UnitTestCase {
 	public function tear_down() {
 		global $wp_query;
 
-		update_option( 'timezone_string', 'UTC' );
+		update_option( 'timezone_string', '' );
 
 		unset( $wp_query );
 
@@ -55,7 +55,7 @@ class Tests_Date_GetFeedBuildDate extends WP_UnitTestCase {
 
 		$this->assertFalse( get_feed_build_date( DATE_RFC3339 ), 'False when unable to determine valid time' );
 
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_date' => $datetime->format( 'Y-m-d H:i:s' ),
 			)
@@ -68,7 +68,7 @@ class Tests_Date_GetFeedBuildDate extends WP_UnitTestCase {
 			'Fall back to time of last post modified with no posts'
 		);
 
-		$post_id_broken = $this->factory->post->create();
+		$post_id_broken = self::factory()->post->create();
 		$post_broken    = get_post( $post_id_broken );
 
 		$post_broken->post_modified_gmt = 0;
diff --git a/tests/date/getPermalink.php b/tests/date/getPermalink.php
index 41977c7734..195717dbd8 100644
--- a/tests/date/getPermalink.php
+++ b/tests/date/getPermalink.php
@@ -10,7 +10,7 @@ class Tests_Date_GetPermalink extends WP_UnitTestCase {
 
 	public function tear_down() {
 		delete_option( 'permalink_structure' );
-		update_option( 'timezone_string', 'UTC' );
+		update_option( 'timezone_string', '' );
 		// phpcs:ignore WordPress.DateTime.RestrictedFunctions.timezone_change_date_default_timezone_set
 		date_default_timezone_set( 'UTC' );
 
diff --git a/tests/date/getPostTime.php b/tests/date/getPostTime.php
index ad9eb0cf31..21b9c8675b 100644
--- a/tests/date/getPostTime.php
+++ b/tests/date/getPostTime.php
@@ -9,6 +9,16 @@
  */
 class Tests_Date_GetPostTime extends WP_UnitTestCase {
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset the timezone option to the default value.
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 28310
 	 */
diff --git a/tests/date/getTheModifiedDate.php b/tests/date/getTheModifiedDate.php
index 9b0dad77cf..7189a7282c 100644
--- a/tests/date/getTheModifiedDate.php
+++ b/tests/date/getTheModifiedDate.php
@@ -20,7 +20,7 @@ class Tests_Date_GetTheModifiedDate extends WP_UnitTestCase {
 			'post_date'     => '2016-01-21 15:34:36',
 			'post_date_gmt' => '2016-01-21 15:34:36',
 		);
-		$post_id  = $this->factory->post->create( $details );
+		$post_id  = self::factory()->post->create( $details );
 		$format   = 'Y-m-d';
 		$expected = '2016-01-21';
 		$actual   = get_the_modified_date( $format, $post_id );
@@ -39,7 +39,7 @@ class Tests_Date_GetTheModifiedDate extends WP_UnitTestCase {
 			'post_date'     => '2016-01-21 15:34:36',
 			'post_date_gmt' => '2016-01-21 15:34:36',
 		);
-		$post_id = $this->factory->post->create( $details );
+		$post_id = self::factory()->post->create( $details );
 		$post    = get_post( $post_id );
 
 		$GLOBALS['post'] = $post;
@@ -111,7 +111,7 @@ class Tests_Date_GetTheModifiedDate extends WP_UnitTestCase {
 			'post_date'     => '2016-01-21 15:34:36',
 			'post_date_gmt' => '2016-01-21 15:34:36',
 		);
-		$post_id  = $this->factory->post->create( $details );
+		$post_id  = self::factory()->post->create( $details );
 		$format   = 'G';
 		$expected = 1453390476;
 		$actual   = get_the_modified_time( $format, $post_id );
@@ -130,7 +130,7 @@ class Tests_Date_GetTheModifiedDate extends WP_UnitTestCase {
 			'post_date'     => '2016-01-21 15:34:36',
 			'post_date_gmt' => '2016-01-21 15:34:36',
 		);
-		$post_id = $this->factory->post->create( $details );
+		$post_id = self::factory()->post->create( $details );
 		$post    = get_post( $post_id );
 
 		$GLOBALS['post'] = $post;
diff --git a/tests/date/mysql2date.php b/tests/date/mysql2date.php
index 7c83446b00..b53a57cfac 100644
--- a/tests/date/mysql2date.php
+++ b/tests/date/mysql2date.php
@@ -11,6 +11,9 @@ class Tests_Date_mysql2date extends WP_UnitTestCase {
 		// phpcs:ignore WordPress.DateTime.RestrictedFunctions.timezone_change_date_default_timezone_set
 		date_default_timezone_set( 'UTC' );
 
+		// Reset the timezone option to the default value.
+		update_option( 'timezone_string', '' );
+
 		parent::tear_down();
 	}
 
diff --git a/tests/date/query.php b/tests/date/query.php
index e3f4ba0f6f..7e3cd73392 100644
--- a/tests/date/query.php
+++ b/tests/date/query.php
@@ -21,6 +21,16 @@ class Tests_Date_Query extends WP_UnitTestCase {
 		$this->q = new WP_Date_Query( array( 'm' => 2 ) );
 	}
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset the timezone option to the default value.
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	public function test_construct_date_query_empty() {
 		$q = new WP_Date_Query( array() );
 		$this->assertSame( 'AND', $q->relation );
diff --git a/tests/date/wpDate.php b/tests/date/wpDate.php
index be0ba80135..341e590a74 100644
--- a/tests/date/wpDate.php
+++ b/tests/date/wpDate.php
@@ -61,4 +61,116 @@ class Tests_Date_wpDate extends WP_UnitTestCase {
 
 		$this->assertSame( $string, wp_date( 'F', $datetime->getTimestamp(), $utc ) );
 	}
+
+	/**
+	 * Tests that the date is formatted with no timestamp provided.
+	 *
+	 * @ticket 53485
+	 */
+	public function test_should_format_date_with_no_timestamp() {
+		$utc = new DateTimeZone( 'UTC' );
+		$this->assertSame( (string) time(), wp_date( 'U', null, $utc ) );
+	}
+
+	/**
+	 * Tests that the date is formatted with no timezone provided.
+	 *
+	 * @ticket 53485
+	 */
+	public function test_should_format_date_with_no_timezone() {
+		$utc      = new DateTimeZone( 'UTC' );
+		$datetime = new DateTimeImmutable( '2019-10-17', $utc );
+		$this->assertSame( 'October', wp_date( 'F', $datetime->getTimestamp() ) );
+	}
+
+	/**
+	 * Tests that the format is set correctly.
+	 *
+	 * @ticket 53485
+	 *
+	 * @dataProvider data_should_format_date
+	 *
+	 * @param string $expected The expected result.
+	 * @param string $format   The date format.
+	 */
+	public function test_should_format_date( $expected, $format ) {
+		$utc      = new DateTimeZone( 'UTC' );
+		$datetime = new DateTimeImmutable( '2019-10-17', $utc );
+
+		$this->assertSame( $expected, wp_date( $format, $datetime->getTimestamp(), $utc ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_format_date() {
+		return array(
+			'Swatch Internet Time'                        => array(
+				'expected' => '041',
+				'format'   => 'B',
+			),
+			'Ante meridiem and Post meridiem (uppercase)' => array(
+				'expected' => 'AM',
+				'format'   => 'A',
+			),
+			'Ante meridiem and Post meridiem (uppercase) and escaped "A"' => array(
+				'expected' => 'A AM',
+				'format'   => '\\A A',
+			),
+			'Ante meridiem and Post meridiem (lowercase)' => array(
+				'expected' => 'am',
+				'format'   => 'a',
+			),
+			'Month'                                       => array(
+				'expected' => 'October',
+				'format'   => 'F',
+			),
+			'Month (abbreviated'                          => array(
+				'expected' => 'Oct',
+				'format'   => 'M',
+			),
+			'Weekday'                                     => array(
+				'expected' => 'Thursday',
+				'format'   => 'l',
+			),
+			'Weekday (abbreviated)'                       => array(
+				'expected' => 'Thu',
+				'format'   => 'D',
+			),
+		);
+	}
+
+	/**
+	 * Tests that the date is formatted when
+	 * `$wp_locale->month` and `$wp_locale->weekday` are empty.
+	 *
+	 * @ticket 53485
+	 */
+	public function test_should_format_date_with_empty_wp_locale_month_and_weekday() {
+		global $wp_locale;
+
+		$utc      = new DateTimeZone( 'UTC' );
+		$datetime = new DateTimeImmutable( '2019-10-17', $utc );
+
+		$wp_locale->month   = array();
+		$wp_locale->weekday = array();
+		$actual             = wp_date( 'F', $datetime->getTimestamp(), $utc );
+
+		$this->assertSame( 'October', $actual );
+	}
+
+	/**
+	 * Tests the wp_date filter.
+	 *
+	 * @ticket 53485
+	 */
+	public function test_should_apply_filters_for_wp_date() {
+		$ma = new MockAction();
+		add_filter( 'wp_date', array( &$ma, 'filter' ) );
+		wp_date( '' );
+
+		$this->assertSame( 1, $ma->get_call_count() );
+	}
 }
diff --git a/tests/date/wpTimezone.php b/tests/date/wpTimezone.php
index 8b1f09e4d1..3b60462163 100644
--- a/tests/date/wpTimezone.php
+++ b/tests/date/wpTimezone.php
@@ -8,6 +8,17 @@
  */
 class Tests_Date_wpTimezone extends WP_UnitTestCase {
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset changed options to their default value.
+		update_option( 'gmt_offset', 0 );
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 24730
 	 *
diff --git a/tests/date/xmlrpc.php b/tests/date/xmlrpc.php
index 8f8fb2859d..26285aa403 100644
--- a/tests/date/xmlrpc.php
+++ b/tests/date/xmlrpc.php
@@ -8,6 +8,16 @@
  */
 class Tests_Date_XMLRPC extends WP_XMLRPC_UnitTestCase {
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset the timezone option to the default value.
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 30429
 	 *
@@ -221,14 +231,14 @@ class Tests_Date_XMLRPC extends WP_XMLRPC_UnitTestCase {
 		$datetimeutc = $datetime->setTimezone( new DateTimeZone( 'UTC' ) );
 
 		$this->make_user_by_role( 'administrator' );
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		$comment_data = array(
 			'comment_post_ID'      => $post_id,
 			'comment_author'       => 'Test commenter',
 			'comment_author_url'   => 'http://example.com/',
 			'comment_author_email' => 'example@example.com',
-			'comment_content'      => rand_str( 100 ),
+			'comment_content'      => 'Hello, world!',
 			'comment_approved'     => '1',
 		);
 		$comment_id   = wp_insert_comment( $comment_data );
diff --git a/tests/db.php b/tests/db.php
index 25c674510c..b39e31eeb8 100644
--- a/tests/db.php
+++ b/tests/db.php
@@ -424,6 +424,8 @@ class Tests_DB extends WP_UnitTestCase {
 	public function data_prepare_incorrect_arg_count() {
 		global $wpdb;
 
+		$placeholder_escape = $wpdb->placeholder_escape();
+
 		return array(
 			array(
 				"SELECT * FROM $wpdb->users WHERE id = %d AND user_login = %s",     // Query.
@@ -443,12 +445,12 @@ class Tests_DB extends WP_UnitTestCase {
 			array(
 				"SELECT * FROM $wpdb->users WHERE id = %d AND %% AND user_login = %s",
 				array( 1, 'admin', 'extra-arg' ),
-				"SELECT * FROM $wpdb->users WHERE id = 1 AND {$wpdb->placeholder_escape()} AND user_login = 'admin'",
+				"SELECT * FROM $wpdb->users WHERE id = 1 AND {$placeholder_escape} AND user_login = 'admin'",
 			),
 			array(
 				"SELECT * FROM $wpdb->users WHERE id = %%%d AND %F AND %f AND user_login = %s",
 				array( 1, 2.3, '4.5', 'admin', 'extra-arg' ),
-				"SELECT * FROM $wpdb->users WHERE id = {$wpdb->placeholder_escape()}1 AND 2.300000 AND 4.500000 AND user_login = 'admin'",
+				"SELECT * FROM $wpdb->users WHERE id = {$placeholder_escape}1 AND 2.300000 AND 4.500000 AND user_login = 'admin'",
 			),
 			array(
 				"SELECT * FROM $wpdb->users WHERE id = %d AND user_login = %s",
@@ -492,9 +494,11 @@ class Tests_DB extends WP_UnitTestCase {
 		$this->assertTrue( $wpdb->has_cap( 'collation' ) );
 		$this->assertTrue( $wpdb->has_cap( 'group_concat' ) );
 		$this->assertTrue( $wpdb->has_cap( 'subqueries' ) );
+		$this->assertTrue( $wpdb->has_cap( 'identifier_placeholders' ) );
 		$this->assertTrue( $wpdb->has_cap( 'COLLATION' ) );
 		$this->assertTrue( $wpdb->has_cap( 'GROUP_CONCAT' ) );
 		$this->assertTrue( $wpdb->has_cap( 'SUBQUERIES' ) );
+		$this->assertTrue( $wpdb->has_cap( 'IDENTIFIER_PLACEHOLDERS' ) );
 		$this->assertSame(
 			version_compare( $wpdb->db_version(), '5.0.7', '>=' ),
 			$wpdb->has_cap( 'set_charset' )
@@ -1548,6 +1552,8 @@ class Tests_DB extends WP_UnitTestCase {
 	public function data_prepare_with_placeholders() {
 		global $wpdb;
 
+		$placeholder_escape = $wpdb->placeholder_escape();
+
 		return array(
 			array(
 				'%5s',   // SQL to prepare.
@@ -1559,7 +1565,7 @@ class Tests_DB extends WP_UnitTestCase {
 				'%1$d %%% % %%1$d%% %%%1$d%%',
 				1,
 				true,
-				"1 {$wpdb->placeholder_escape()}{$wpdb->placeholder_escape()} {$wpdb->placeholder_escape()} {$wpdb->placeholder_escape()}1\$d{$wpdb->placeholder_escape()} {$wpdb->placeholder_escape()}1{$wpdb->placeholder_escape()}",
+				"1 {$placeholder_escape}{$placeholder_escape} {$placeholder_escape} {$placeholder_escape}1\$d{$placeholder_escape} {$placeholder_escape}1{$placeholder_escape}",
 			),
 			array(
 				'%-5s',
@@ -1601,25 +1607,25 @@ class Tests_DB extends WP_UnitTestCase {
 				'%s',
 				' %s ',
 				false,
-				"' {$wpdb->placeholder_escape()}s '",
+				"' {$placeholder_escape}s '",
 			),
 			array(
 				'%1$s',
 				' %s ',
 				false,
-				" {$wpdb->placeholder_escape()}s ",
+				" {$placeholder_escape}s ",
 			),
 			array(
 				'%1$s',
 				' %1$s ',
 				false,
-				" {$wpdb->placeholder_escape()}1\$s ",
+				" {$placeholder_escape}1\$s ",
 			),
 			array(
 				'%d %1$d %%% %',
 				1,
 				true,
-				"1 1 {$wpdb->placeholder_escape()}{$wpdb->placeholder_escape()} {$wpdb->placeholder_escape()}",
+				"1 1 {$placeholder_escape}{$placeholder_escape} {$placeholder_escape}",
 			),
 			array(
 				'%d %2$s',
@@ -1661,25 +1667,25 @@ class Tests_DB extends WP_UnitTestCase {
 				"%%s %%'%1\$s'",
 				'hello',
 				false,
-				"{$wpdb->placeholder_escape()}s {$wpdb->placeholder_escape()}'hello'",
+				"{$placeholder_escape}s {$placeholder_escape}'hello'",
 			),
 			array(
 				'%%s %%"%1$s"',
 				'hello',
 				false,
-				"{$wpdb->placeholder_escape()}s {$wpdb->placeholder_escape()}\"hello\"",
+				"{$placeholder_escape}s {$placeholder_escape}\"hello\"",
 			),
 			array(
 				'%s',
 				' %  s ',
 				false,
-				"' {$wpdb->placeholder_escape()}  s '",
+				"' {$placeholder_escape}  s '",
 			),
 			array(
 				'%%f %%"%1$f"',
 				3,
 				false,
-				"{$wpdb->placeholder_escape()}f {$wpdb->placeholder_escape()}\"3.000000\"",
+				"{$placeholder_escape}f {$placeholder_escape}\"3.000000\"",
 			),
 			array(
 				'WHERE second=\'%2$s\' AND first=\'%1$s\'',
@@ -1697,19 +1703,19 @@ class Tests_DB extends WP_UnitTestCase {
 				"'%'%%s",
 				'hello',
 				true,
-				"'{$wpdb->placeholder_escape()}'{$wpdb->placeholder_escape()}s",
+				"'{$placeholder_escape}'{$placeholder_escape}s",
 			),
 			array(
 				"'%'%%s%s",
 				'hello',
 				false,
-				"'{$wpdb->placeholder_escape()}'{$wpdb->placeholder_escape()}s'hello'",
+				"'{$placeholder_escape}'{$placeholder_escape}s'hello'",
 			),
 			array(
 				"'%'%%s %s",
 				'hello',
 				false,
-				"'{$wpdb->placeholder_escape()}'{$wpdb->placeholder_escape()}s 'hello'",
+				"'{$placeholder_escape}'{$placeholder_escape}s 'hello'",
 			),
 			array(
 				"'%-'#5s' '%'#-+-5s'",
@@ -1717,9 +1723,129 @@ class Tests_DB extends WP_UnitTestCase {
 				false,
 				"'hello' 'foo##'",
 			),
+			array(
+				'SELECT * FROM %i WHERE %i = %d;',
+				array( 'my_table', 'my_field', 321 ),
+				false,
+				'SELECT * FROM `my_table` WHERE `my_field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_`_field', 321 ),
+				false,
+				'WHERE `evil_``_field` = 321;', // To quote the identifier itself, then you need to double the character, e.g. `a``b`.
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_````````_field', 321 ),
+				false,
+				'WHERE `evil_````````````````_field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( '``evil_field``', 321 ),
+				false,
+				'WHERE `````evil_field````` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil\'field', 321 ),
+				false,
+				'WHERE `evil\'field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_\``_field', 321 ),
+				false,
+				'WHERE `evil_\````_field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_%s_field', 321 ),
+				false,
+				"WHERE `evil_{$placeholder_escape}s_field` = 321;",
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'value`', 321 ),
+				false,
+				'WHERE `value``` = 321;',
+			),
+			array(
+				'WHERE `%i = %d;',
+				array( ' AND evil_value', 321 ),
+				false,
+				'WHERE `` AND evil_value` = 321;', // Won't run (SQL parse error: "Unclosed quote").
+			),
+			array(
+				'WHERE %i` = %d;',
+				array( 'evil_value -- ', 321 ),
+				false,
+				'WHERE `evil_value -- `` = 321;', // Won't run (SQL parse error: "Unclosed quote").
+			),
+			array(
+				'WHERE `%i`` = %d;',
+				array( ' AND true -- ', 321 ),
+				false,
+				'WHERE `` AND true -- ``` = 321;', // Won't run (Unknown column '').
+			),
+			array(
+				'WHERE ``%i` = %d;',
+				array( ' AND true -- ', 321 ),
+				false,
+				'WHERE ``` AND true -- `` = 321;', // Won't run (SQL parse error: "Unclosed quote").
+			),
+			array(
+				'WHERE %2$i = %1$d;',
+				array( '1', 'two' ),
+				false,
+				'WHERE `two` = 1;',
+			),
+			array(
+				'WHERE \'%i\' = 1 AND "%i" = 2 AND `%i` = 3 AND ``%i`` = 4 AND %15i = 5',
+				array( 'my_field1', 'my_field2', 'my_field3', 'my_field4', 'my_field5' ),
+				false,
+				'WHERE \'`my_field1`\' = 1 AND "`my_field2`" = 2 AND ``my_field3`` = 3 AND ```my_field4``` = 4 AND `      my_field5` = 5', // Does not remove any existing quotes, always adds it's own (safer).
+			),
+			array(
+				'WHERE id = %d AND %i LIKE %2$s LIMIT 1',
+				array( 123, 'field -- ', false ),
+				true, // Incorrect usage.
+				null, // Should be rejected, otherwise the `%1$s` could use Identifier escaping, e.g. 'WHERE `field -- ` LIKE field --  LIMIT 1' (thanks @vortfu).
+			),
+			array(
+				'WHERE %i LIKE %s LIMIT 1',
+				array( "field' -- ", "field' -- " ),
+				false,
+				"WHERE `field' -- ` LIKE 'field\' -- ' LIMIT 1", // In contrast to the above, Identifier vs String escaping is used.
+			),
 		);
 	}
 
+	public function test_allow_unsafe_unquoted_parameters() {
+		global $wpdb;
+
+		$sql    = 'WHERE (%i = %s) OR (%10i = %10s) OR (%5$i = %6$s)';
+		$values = array( 'field_a', 'string_a', 'field_b', 'string_b', 'field_c', 'string_c' );
+
+		$default = $wpdb->allow_unsafe_unquoted_parameters;
+
+		$wpdb->allow_unsafe_unquoted_parameters = true;
+
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
+		$part = $wpdb->prepare( $sql, $values );
+		$this->assertSame( 'WHERE (`field_a` = \'string_a\') OR (`   field_b` =   string_b) OR (`field_c` = string_c)', $part ); // Unsafe, unquoted parameters.
+
+		$wpdb->allow_unsafe_unquoted_parameters = false;
+
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
+		$part = $wpdb->prepare( $sql, $values );
+		$this->assertSame( 'WHERE (`field_a` = \'string_a\') OR (`   field_b` = \'  string_b\') OR (`field_c` = \'string_c\')', $part );
+
+		$wpdb->allow_unsafe_unquoted_parameters = $default;
+
+	}
+
 	/**
 	 * @dataProvider data_escape_and_prepare
 	 */
@@ -1742,13 +1868,16 @@ class Tests_DB extends WP_UnitTestCase {
 
 	public function data_escape_and_prepare() {
 		global $wpdb;
+
+		$placeholder_escape = $wpdb->placeholder_escape();
+
 		return array(
 			array(
 				'%s',                                  // String to pass through esc_url().
 				' {ESCAPE} ',                          // Query to insert the output of esc_url() into, replacing "{ESCAPE}".
 				'foo',                                 // Data to send to prepare().
 				true,                                  // Whether to expect an incorrect usage error or not.
-				" {$wpdb->placeholder_escape()}s ",    // Expected output.
+				" {$placeholder_escape}s ",    // Expected output.
 			),
 			array(
 				'foo%sbar',
@@ -1762,7 +1891,7 @@ class Tests_DB extends WP_UnitTestCase {
 				' %s {ESCAPE} ',
 				'foo',
 				false,
-				" 'foo' {$wpdb->placeholder_escape()}s ",
+				" 'foo' {$placeholder_escape}s ",
 			),
 		);
 	}
@@ -1841,6 +1970,7 @@ class Tests_DB extends WP_UnitTestCase {
 	/**
 	 * @dataProvider parse_db_host_data_provider
 	 * @ticket 41722
+	 * @ticket 54877
 	 */
 	public function test_parse_db_host( $host_string, $expect_bail, $host, $port, $socket, $is_ipv6 ) {
 		global $wpdb;
@@ -1873,7 +2003,7 @@ class Tests_DB extends WP_UnitTestCase {
 				':3306',
 				false,
 				'',
-				'3306',
+				3306,
 				null,
 				false,
 			),
@@ -1901,11 +2031,19 @@ class Tests_DB extends WP_UnitTestCase {
 				null,
 				false,
 			),
+			array(
+				'127.0.0.1:port_as_string',
+				false,
+				'127.0.0.1',
+				null,
+				null,
+				false,
+			),
 			array(
 				'127.0.0.1:3306',
 				false,
 				'127.0.0.1',
-				'3306',
+				3306,
 				null,
 				false,
 			),
@@ -1913,7 +2051,7 @@ class Tests_DB extends WP_UnitTestCase {
 				'127.0.0.1:3306:/tmp/mysql:with_colon.sock',
 				false,
 				'127.0.0.1',
-				'3306',
+				3306,
 				'/tmp/mysql:with_colon.sock',
 				false,
 			),
@@ -1925,11 +2063,19 @@ class Tests_DB extends WP_UnitTestCase {
 				null,
 				false,
 			),
+			array(
+				'example.com:port_as_string',
+				false,
+				'example.com',
+				null,
+				null,
+				false,
+			),
 			array(
 				'example.com:3306',
 				false,
 				'example.com',
-				'3306',
+				3306,
 				null,
 				false,
 			),
@@ -1941,6 +2087,14 @@ class Tests_DB extends WP_UnitTestCase {
 				null,
 				false,
 			),
+			array(
+				'localhost:port_as_string',
+				false,
+				'localhost',
+				null,
+				null,
+				false,
+			),
 			array(
 				'localhost:/tmp/mysql.sock',
 				false,
@@ -1957,6 +2111,14 @@ class Tests_DB extends WP_UnitTestCase {
 				'/tmp/mysql:with_colon.sock',
 				false,
 			),
+			array(
+				'localhost:port_as_string:/tmp/mysql:with_colon.sock',
+				false,
+				'localhost',
+				null,
+				'/tmp/mysql:with_colon.sock',
+				false,
+			),
 			array(
 				'0000:0000:0000:0000:0000:0000:0000:0001',
 				false,
@@ -1985,7 +2147,15 @@ class Tests_DB extends WP_UnitTestCase {
 				'[::1]:3306',
 				false,
 				'::1',
-				'3306',
+				3306,
+				null,
+				true,
+			),
+			array(
+				'[::1]:port_as_string',
+				false,
+				'::1',
+				null,
 				null,
 				true,
 			),
@@ -1993,7 +2163,7 @@ class Tests_DB extends WP_UnitTestCase {
 				'[::1]:3306:/tmp/mysql:with_colon.sock',
 				false,
 				'::1',
-				'3306',
+				3306,
 				'/tmp/mysql:with_colon.sock',
 				true,
 			),
diff --git a/tests/db/charset.php b/tests/db/charset.php
index 1ccdf183ce..6fc2162526 100644
--- a/tests/db/charset.php
+++ b/tests/db/charset.php
@@ -9,18 +9,32 @@
 class Tests_DB_Charset extends WP_UnitTestCase {
 
 	/**
-	 * Our special WPDB
+	 * Our special WPDB.
 	 *
 	 * @var resource
 	 */
 	protected static $_wpdb;
 
 	/**
-	 * The version of the MySQL server.
+	 * Whether to expect utf8mb3 instead of utf8 in various commands output.
+	 *
+	 * @var bool
+	 */
+	private static $utf8_is_utf8mb3 = false;
+
+	/**
+	 * The database server version.
+	 *
+	 * @var string
+	 */
+	private static $db_version;
+
+	/**
+	 * Full database server information.
 	 *
 	 * @var string
 	 */
-	private static $server_info;
+	private static $db_server_info;
 
 	public static function set_up_before_class() {
 		parent::set_up_before_class();
@@ -29,7 +43,27 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 
 		self::$_wpdb = new WpdbExposedMethodsForTesting();
 
-		self::$server_info = self::$_wpdb->db_server_info();
+		self::$db_version     = self::$_wpdb->db_version();
+		self::$db_server_info = self::$_wpdb->db_server_info();
+
+		// Account for MariaDB version being prefixed with '5.5.5-' on older PHP versions.
+		if ( str_contains( self::$db_server_info, 'MariaDB' ) && '5.5.5' === self::$db_version
+			&& PHP_VERSION_ID < 80016 // PHP 8.0.15 or older.
+		) {
+			// Strip the '5.5.5-' prefix and set the version to the correct value.
+			self::$db_server_info = preg_replace( '/^5\.5\.5-(.*)/', '$1', self::$db_server_info );
+			self::$db_version     = preg_replace( '/[^0-9.].*/', '', self::$db_server_info );
+		}
+
+		/*
+		 * MariaDB 10.6.1 or later and MySQL 8.0.30 or later
+		 * use utf8mb3 instead of utf8 in various commands output.
+		 */
+		if ( str_contains( self::$db_server_info, 'MariaDB' ) && version_compare( self::$db_version, '10.6.1', '>=' )
+			|| ! str_contains( self::$db_server_info, 'MariaDB' ) && version_compare( self::$db_version, '8.0.30', '>=' )
+		) {
+			self::$utf8_is_utf8mb3 = true;
+		}
 	}
 
 	/**
@@ -492,7 +526,9 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 			$this->markTestSkipped( "The current MySQL server doesn't support the utf8mb4 character set." );
 		}
 
-		if ( 'big5' === $new_charset && 'byte' === $data[0]['length']['type'] && false !== strpos( self::$server_info, 'MariaDB' ) ) {
+		if ( 'big5' === $new_charset && 'byte' === $data[0]['length']['type']
+			&& str_contains( self::$db_server_info, 'MariaDB' )
+		) {
 			$this->markTestSkipped( "MariaDB doesn't support this data set. See https://core.trac.wordpress.org/ticket/33171." );
 		}
 
@@ -808,6 +844,10 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 		self::$_wpdb->query( $create );
 
 		foreach ( $expected_charset as $column => $charset ) {
+			if ( self::$utf8_is_utf8mb3 && 'utf8' === $charset ) {
+				$charset = 'utf8mb3';
+			}
+
 			$this->assertSame( $charset, self::$_wpdb->get_col_charset( $table, $column ) );
 			$this->assertSame( $charset, self::$_wpdb->get_col_charset( strtoupper( $table ), strtoupper( $column ) ) );
 		}
@@ -875,27 +915,29 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	public function data_strip_invalid_text_from_query() {
 		$table_name = 'strip_invalid_text_from_query_table';
 		$data       = array(
-			array(
+			'utf8 + binary'  => array(
 				// Binary tables don't get stripped.
-				'( a VARCHAR(50) CHARACTER SET utf8, b BINARY )', // Create.
-				"('foo\xf0\x9f\x98\x88bar', 'foo')",              // Query.
-				"('foo\xf0\x9f\x98\x88bar', 'foo')",              // Expected result.
+				'create'   => '( a VARCHAR(50) CHARACTER SET utf8, b BINARY )',
+				'query'    => "('foo\xf0\x9f\x98\x88bar', 'foo')",
+				'expected' => "('foo\xf0\x9f\x98\x88bar', 'foo')",
 			),
-			array(
+			'utf8 + utf8mb4' => array(
 				// utf8/utf8mb4 tables default to utf8.
-				'( a VARCHAR(50) CHARACTER SET utf8, b VARCHAR(50) CHARACTER SET utf8mb4 )',
-				"('foo\xf0\x9f\x98\x88bar', 'foo')",
-				"('foobar', 'foo')",
+				'create'   => '( a VARCHAR(50) CHARACTER SET utf8, b VARCHAR(50) CHARACTER SET utf8mb4 )',
+				'query'    => "('foo\xf0\x9f\x98\x88bar', 'foo')",
+				'expected' => "('foobar', 'foo')",
 			),
 		);
 
-		foreach ( $data as $i => &$value ) {
-			$this_table_name = $table_name . '_' . $i;
+		$i = 0;
+
+		foreach ( $data as &$value ) {
+			$this_table_name = $table_name . '_' . $i++;
 
-			$value[0] = "CREATE TABLE $this_table_name {$value[0]}";
-			$value[1] = "INSERT INTO $this_table_name VALUES {$value[1]}";
-			$value[2] = "INSERT INTO $this_table_name VALUES {$value[2]}";
-			$value[3] = "DROP TABLE IF EXISTS $this_table_name";
+			$value['create']   = "CREATE TABLE $this_table_name {$value['create']}";
+			$value['query']    = "INSERT INTO $this_table_name VALUES {$value['query']}";
+			$value['expected'] = "INSERT INTO $this_table_name VALUES {$value['expected']}";
+			$value['drop']     = "DROP TABLE IF EXISTS $this_table_name";
 		}
 		unset( $value );
 
@@ -979,42 +1021,44 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	public function data_table_collation_check() {
 		$table_name = 'table_collation_check';
 		$data       = array(
-			array(
+			'utf8_bin'                   => array(
 				// utf8_bin tables don't need extra sanity checking.
-				'( a VARCHAR(50) COLLATE utf8_bin )', // Create.
-				true,                                 // Expected result.
+				'create'   => '( a VARCHAR(50) COLLATE utf8_bin )',
+				'expected' => true,
 			),
-			array(
+			'utf8_general_ci'            => array(
 				// Neither do utf8_general_ci tables.
-				'( a VARCHAR(50) COLLATE utf8_general_ci )',
-				true,
+				'create'   => '( a VARCHAR(50) COLLATE utf8_general_ci )',
+				'expected' => true,
 			),
-			array(
+			'utf8_unicode_ci'            => array(
 				// utf8_unicode_ci tables do.
-				'( a VARCHAR(50) COLLATE utf8_unicode_ci )',
-				false,
+				'create'   => '( a VARCHAR(50) COLLATE utf8_unicode_ci )',
+				'expected' => false,
 			),
-			array(
+			'utf8_bin + big5_chinese_ci' => array(
 				// utf8_bin tables don't need extra sanity checking,
 				// except for when they're not just utf8_bin.
-				'( a VARCHAR(50) COLLATE utf8_bin, b VARCHAR(50) COLLATE big5_chinese_ci )',
-				false,
+				'create'   => '( a VARCHAR(50) COLLATE utf8_bin, b VARCHAR(50) COLLATE big5_chinese_ci )',
+				'expected' => false,
 			),
-			array(
+			'utf8_bin + int'             => array(
 				// utf8_bin tables don't need extra sanity checking
 				// when the other columns aren't strings.
-				'( a VARCHAR(50) COLLATE utf8_bin, b INT )',
-				true,
+				'create'   => '( a VARCHAR(50) COLLATE utf8_bin, b INT )',
+				'expected' => true,
 			),
 		);
 
-		foreach ( $data as $i => &$value ) {
-			$this_table_name = $table_name . '_' . $i;
+		$i = 0;
 
-			$value[0] = "CREATE TABLE $this_table_name {$value[0]}";
-			$value[2] = "SELECT * FROM $this_table_name WHERE a='\xf0\x9f\x98\x88'";
-			$value[3] = "DROP TABLE IF EXISTS $this_table_name";
-			$value[4] = array(
+		foreach ( $data as &$value ) {
+			$this_table_name = $table_name . '_' . $i++;
+
+			$value['create']      = "CREATE TABLE $this_table_name {$value['create']}";
+			$value['query']       = "SELECT * FROM $this_table_name WHERE a='\xf0\x9f\x98\x88'";
+			$value['drop']        = "DROP TABLE IF EXISTS $this_table_name";
+			$value['always_true'] = array(
 				"SELECT * FROM $this_table_name WHERE a='foo'",
 				"SHOW FULL TABLES LIKE $this_table_name",
 				"DESCRIBE $this_table_name",
@@ -1040,11 +1084,31 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 		self::$_wpdb->query( $create );
 
 		$return = self::$_wpdb->check_safe_collation( $query );
-		$this->assertSame( $expected, $return );
+		$this->assertSame(
+			$expected,
+			$return,
+			sprintf(
+				"wpdb::check_safe_collation() should return %s for this query.\n" .
+				"Table: %s\n" .
+				'Query: %s',
+				$expected ? 'true' : 'false',
+				$create,
+				$query
+			)
+		);
 
 		foreach ( $always_true as $true_query ) {
 			$return = self::$_wpdb->check_safe_collation( $true_query );
-			$this->assertTrue( $return );
+			$this->assertTrue(
+				$return,
+				sprintf(
+					"wpdb::check_safe_collation() should return true for this query.\n" .
+					"Table: %s\n" .
+					'Query: %s',
+					$create,
+					$true_query
+				)
+			);
 		}
 
 		self::$_wpdb->query( $drop );
@@ -1115,12 +1179,13 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	 */
 	public function test_set_charset_changes_the_connection_collation() {
 		self::$_wpdb->set_charset( self::$_wpdb->dbh, 'utf8', 'utf8_general_ci' );
-		$results = self::$_wpdb->get_results( "SHOW VARIABLES WHERE Variable_name='collation_connection'" );
-		$this->assertSame( 'utf8_general_ci', $results[0]->Value );
+		$results  = self::$_wpdb->get_results( "SHOW VARIABLES WHERE Variable_name='collation_connection'" );
+		$expected = self::$utf8_is_utf8mb3 ? 'utf8mb3_general_ci' : 'utf8_general_ci';
+		$this->assertSame( $expected, $results[0]->Value, "Collation should be set to $expected." );
 
 		self::$_wpdb->set_charset( self::$_wpdb->dbh, 'utf8mb4', 'utf8mb4_unicode_ci' );
 		$results = self::$_wpdb->get_results( "SHOW VARIABLES WHERE Variable_name='collation_connection'" );
-		$this->assertSame( 'utf8mb4_unicode_ci', $results[0]->Value );
+		$this->assertSame( 'utf8mb4_unicode_ci', $results[0]->Value, 'Collation should be set to utf8mb4_unicode_ci.' );
 
 		self::$_wpdb->set_charset( self::$_wpdb->dbh );
 	}
diff --git a/tests/dbdelta.php b/tests/dbdelta.php
index f717eb436d..c9e20d966b 100644
--- a/tests/dbdelta.php
+++ b/tests/dbdelta.php
@@ -22,21 +22,32 @@ class Tests_dbDelta extends WP_UnitTestCase {
 	protected $db_engine = '';
 
 	/**
-	 * Display width for BIGINT data type.
+	 * The database server version.
 	 *
-	 * Prior to MySQL 8.0.17, default width of 20 digits was used: BIGINT(20).
-	 * Since MySQL 8.0.17, display width for integer data types is no longer supported.
+	 * @var string
 	 */
-	protected $bigint_display_width = '';
+	private static $db_version;
+
+	/**
+	 * Full database server information.
+	 *
+	 * @var string
+	 */
+	private static $db_server_info;
 
 	/**
 	 * Make sure the upgrade code is loaded before the tests are run.
 	 */
 	public static function set_up_before_class() {
 
+		global $wpdb;
+
 		parent::set_up_before_class();
 
 		require_once ABSPATH . 'wp-admin/includes/upgrade.php';
+
+		self::$db_version     = $wpdb->db_version();
+		self::$db_server_info = $wpdb->db_server_info();
 	}
 
 	/**
@@ -46,31 +57,24 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		global $wpdb;
 
-		$db_version = $wpdb->db_version();
-
-		if ( version_compare( $db_version, '5.7', '<' ) ) {
+		if ( version_compare( self::$db_version, '5.7', '<' ) ) {
 			// Prior to MySQL 5.7, InnoDB did not support FULLTEXT indexes, so MyISAM is used instead.
 			$this->db_engine = 'ENGINE=MyISAM';
 		}
 
-		if ( version_compare( $db_version, '8.0.17', '<' ) ) {
-			// Prior to MySQL 8.0.17, default width of 20 digits was used: BIGINT(20).
-			$this->bigint_display_width = '(20)';
-		}
-
 		$wpdb->query(
 			$wpdb->prepare(
 				"
 				CREATE TABLE {$wpdb->prefix}dbdelta_test (" .
 					// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
-					"id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+					'id bigint(20) NOT NULL AUTO_INCREMENT,
 					column_1 varchar(255) NOT NULL,
 					column_2 text,
 					column_3 blob,
 					PRIMARY KEY  (id),
 					KEY key_1 (column_1(%d)),
 					KEY compound_key (id,column_1(%d)),
-					FULLTEXT KEY fulltext_key (column_1)" .
+					FULLTEXT KEY fulltext_key (column_1)' .
 					// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 				") {$this->db_engine}
 				",
@@ -109,7 +113,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		$updates = dbDelta(
 			"CREATE TABLE {$wpdb->prefix}dbdelta_create_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				PRIMARY KEY  (id)
 			);"
@@ -144,7 +148,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				PRIMARY KEY  (id),
 				KEY key_1 (column_1($this->max_index_length)),
@@ -163,7 +167,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		global $wpdb;
 
-		// id: bigint => int(11)
+		// id: bigint(20) => int(11)
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
@@ -176,10 +180,23 @@ class Tests_dbDelta extends WP_UnitTestCase {
 			"
 		);
 
+		$bigint_display_width = '(20)';
+
+		/*
+		 * MySQL 8.0.17 or later does not support display width for integer data types,
+		 * so if display width is the only difference, it can be safely ignored.
+		 * Note: This is specific to MySQL and does not affect MariaDB.
+		 */
+		if ( version_compare( self::$db_version, '8.0.17', '>=' )
+			&& ! str_contains( self::$db_server_info, 'MariaDB' )
+		) {
+			$bigint_display_width = '';
+		}
+
 		$this->assertSame(
 			array(
 				"{$wpdb->prefix}dbdelta_test.id"
-					=> "Changed type of {$wpdb->prefix}dbdelta_test.id from bigint{$this->bigint_display_width} to int(11)",
+					=> "Changed type of {$wpdb->prefix}dbdelta_test.id from bigint{$bigint_display_width} to int(11)",
 			),
 			$updates
 		);
@@ -195,7 +212,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				extra_col longtext,
 				PRIMARY KEY  (id),
@@ -230,7 +247,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				PRIMARY KEY  (id),
 				KEY key_1 (column_1($this->max_index_length)),
 				KEY compound_key (id,column_1($this->max_index_length))
@@ -254,7 +271,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				extra_col longtext,
 				PRIMARY KEY  (id),
@@ -306,7 +323,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				PRIMARY KEY  (id),
 				KEY key_1 (column_1($this->max_index_length)),
@@ -451,7 +468,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$result = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 tinytext,
 				column_3 blob,
@@ -476,7 +493,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$result = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 tinyblob,
@@ -501,7 +518,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$result = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 bigtext,
 				column_3 blob,
@@ -532,7 +549,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$result = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 mediumblob,
@@ -562,7 +579,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		$schema = "
 			CREATE TABLE {$wpdb->prefix}dbdelta_test2 (
-				`id` bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				`id` bigint(20) NOT NULL AUTO_INCREMENT,
 				`column_1` varchar(255) NOT NULL,
 				PRIMARY KEY  (id),
 				KEY compound_key (id,column_1($this->max_index_length))
@@ -585,24 +602,28 @@ class Tests_dbDelta extends WP_UnitTestCase {
 	public function test_spatial_indices() {
 		global $wpdb;
 
-		$db_version = $wpdb->db_version();
-
-		if ( version_compare( $db_version, '5.4', '<' ) ) {
+		if ( version_compare( self::$db_version, '5.4', '<' ) ) {
 			$this->markTestSkipped( 'Spatial indices require MySQL 5.4 and above.' );
 		}
 
-		$geomcollection_name = 'geomcollection';
-
-		if ( version_compare( $db_version, '8.0.11', '<' ) ) {
-			// Prior to MySQL 8.0.11, GeometryCollection data type name was used.
-			$geomcollection_name = 'geometrycollection';
+		$geometrycollection_name = 'geometrycollection';
+
+		if ( version_compare( self::$db_version, '8.0.11', '>=' )
+			&& ! str_contains( self::$db_server_info, 'MariaDB' )
+		) {
+			/*
+			 * MySQL 8.0.11 or later uses GeomCollection data type name
+			 * as the preferred synonym for GeometryCollection.
+			 * Note: This is specific to MySQL and does not affect MariaDB.
+			 */
+			$geometrycollection_name = 'geomcollection';
 		}
 
 		$schema =
 			"
 			CREATE TABLE {$wpdb->prefix}spatial_index_test (
-				non_spatial bigint{$this->bigint_display_width} unsigned NOT NULL,
-				spatial_value {$geomcollection_name} NOT NULL,
+				non_spatial bigint(20) unsigned NOT NULL,
+				spatial_value {$geometrycollection_name} NOT NULL,
 				KEY non_spatial (non_spatial),
 				SPATIAL KEY spatial_key (spatial_value)
 			) {$this->db_engine};
@@ -618,9 +639,9 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$schema =
 			"
 			CREATE TABLE {$wpdb->prefix}spatial_index_test (
-				non_spatial bigint{$this->bigint_display_width} unsigned NOT NULL,
-				spatial_value {$geomcollection_name} NOT NULL,
-				spatial_value2 {$geomcollection_name} NOT NULL,
+				non_spatial bigint(20) unsigned NOT NULL,
+				spatial_value {$geometrycollection_name} NOT NULL,
+				spatial_value2 {$geometrycollection_name} NOT NULL,
 				KEY non_spatial (non_spatial),
 				SPATIAL KEY spatial_key (spatial_value)
 				SPATIAL KEY spatial_key2 (spatial_value2)
@@ -648,7 +669,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		$schema = "
 			CREATE TABLE {$wpdb->prefix}dbdelta_test2 (
-				`id` bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				`id` bigint(20) NOT NULL AUTO_INCREMENT,
 				`references` varchar(255) NOT NULL,
 				PRIMARY KEY  (`id`),
 				KEY `compound_key` (`id`,`references`($this->max_index_length))
@@ -678,7 +699,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -708,7 +729,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 	/**
 	 * @ticket 20263
 	 */
-	public function test_wp_get_db_schema_does_no_alter_queries_on_existing_install() {
+	public function test_wp_get_db_schema_does_not_alter_queries_on_existing_install() {
 		$updates = dbDelta( wp_get_db_schema() );
 
 		$this->assertEmpty( $updates );
@@ -722,7 +743,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		$schema = "
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -761,7 +782,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -784,7 +805,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		$schema = "
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -819,7 +840,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -843,7 +864,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -867,7 +888,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -891,7 +912,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -915,7 +936,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -940,7 +961,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -965,7 +986,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -988,7 +1009,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -1006,7 +1027,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
@@ -1024,7 +1045,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 		$updates = dbDelta(
 			"
 			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint{$this->bigint_display_width} NOT NULL AUTO_INCREMENT,
+				id bigint(20) NOT NULL AUTO_INCREMENT,
 				column_1 varchar(255) NOT NULL,
 				column_2 text,
 				column_3 blob,
diff --git a/tests/dependencies/scripts.php b/tests/dependencies/scripts.php
index 9dcb1e9b63..9a85ee34f0 100644
--- a/tests/dependencies/scripts.php
+++ b/tests/dependencies/scripts.php
@@ -740,13 +740,6 @@ JS;
 		$expected .= "<script type='text/javascript' id='wp-i18n-js-after'>\n";
 		$expected .= "wp.i18n.setLocaleData( { 'text direction\u0004ltr': [ 'ltr' ] } );\n";
 		$expected .= "</script>\n";
-		$expected .= "<script type='text/javascript' id='wp-a11y-js-translations'>\n";
-		$expected .= "( function( domain, translations ) {\n";
-		$expected .= "	var localeData = translations.locale_data[ domain ] || translations.locale_data.messages;\n";
-		$expected .= "	localeData[\"\"].domain = domain;\n";
-		$expected .= "	wp.i18n.setLocaleData( localeData, domain );\n";
-		$expected .= "} )( \"default\", { \"locale_data\": { \"messages\": { \"\": {} } } } );\n";
-		$expected .= "</script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/dist/a11y{$suffix}.js' id='wp-a11y-js'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example2.com' id='test-example2-js'></script>\n";
 		$expected .= "<script type='text/javascript' id='test-example2-js-after'>\nconsole.log(\"after\");\n</script>\n";
@@ -994,6 +987,7 @@ JS;
 
 	/**
 	 * @ticket 45103
+	 * @ticket 55250
 	 */
 	public function test_wp_set_script_translations_when_translation_file_does_not_exist() {
 		wp_register_script( 'wp-i18n', '/wp-includes/js/dist/wp-i18n.js', array(), null );
@@ -1001,19 +995,6 @@ JS;
 		wp_set_script_translations( 'test-example', 'admin', DIR_TESTDATA . '/languages/' );
 
 		$expected  = "<script type='text/javascript' src='/wp-includes/js/dist/wp-i18n.js' id='wp-i18n-js'></script>\n";
-		$expected .= str_replace(
-			array(
-				'__DOMAIN__',
-				'__HANDLE__',
-				'__JSON_TRANSLATIONS__',
-			),
-			array(
-				'admin',
-				'test-example',
-				'{ "locale_data": { "messages": { "": {} } } }',
-			),
-			$this->wp_scripts_print_translations_output
-		);
 		$expected .= "<script type='text/javascript' src='/wp-admin/js/script.js' id='test-example-js'></script>\n";
 
 		$this->assertSameIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
@@ -1447,17 +1428,8 @@ JS;
 	 *
 	 * @param mixed  $l10n_data Localization data passed to wp_localize_script().
 	 * @param string $expected  Expected transformation of localization data.
-	 * @param string $warning   Optional. Whether a PHP native warning/error is expected. Default false.
 	 */
-	public function test_wp_localize_script_data_formats( $l10n_data, $expected, $warning = false ) {
-		if ( $warning ) {
-			if ( PHP_VERSION_ID < 80000 ) {
-				$this->expectWarning();
-			} else {
-				$this->expectError();
-			}
-		}
-
+	public function test_wp_localize_script_data_formats( $l10n_data, $expected ) {
 		if ( ! is_array( $l10n_data ) ) {
 			$this->setExpectedIncorrectUsage( 'WP_Scripts::localize' );
 		}
@@ -1479,7 +1451,6 @@ JS;
 	 *
 	 *     @type mixed  $l10n_data Localization data passed to wp_localize_script().
 	 *     @type string $expected  Expected transformation of localization data.
-	 *     @type string $warning   Optional. Whether a PHP native warning/error is expected.
 	 * }
 	 */
 	public function data_wp_localize_script_data_formats() {
@@ -1490,14 +1461,50 @@ JS;
 			array( array( 'foo' => array( 'bar' => 'foobar' ) ), '{"foo":{"bar":"foobar"}}' ),
 			array( array( 'foo' => 6.6 ), '{"foo":"6.6"}' ),
 			array( array( 'foo' => 6 ), '{"foo":"6"}' ),
+			array( array(), '[]' ),
 
 			// Unofficially supported format.
 			array( 'string', '"string"' ),
 
 			// Unsupported formats.
-			array( 1.5, '1.5', true ),
-			array( 1, '1', true ),
+			array( 1.5, '1.5' ),
+			array( 1, '1' ),
 			array( false, '[""]' ),
+			array( null, 'null' ),
+		);
+	}
+
+	/**
+	 * @ticket 55628
+	 * @covers ::wp_set_script_translations
+	 */
+	public function test_wp_external_wp_i18n_print_order() {
+		global $wp_scripts;
+
+		$wp_scripts->do_concat    = true;
+		$wp_scripts->default_dirs = array( '/default/' );
+
+		// wp-i18n script in a non-default directory.
+		wp_register_script( 'wp-i18n', '/plugins/wp-i18n.js', array(), null );
+		// Script in default dir that's going to be concatenated.
+		wp_enqueue_script( 'jquery-core', '/default/jquery-core.js', array(), null );
+		// Script in default dir that depends on wp-i18n.
+		wp_enqueue_script( 'common', '/default/common.js', array(), null );
+		wp_set_script_translations( 'common' );
+
+		$print_scripts = get_echo(
+			function() {
+				wp_print_scripts();
+				_print_scripts();
+			}
 		);
+
+		// The non-default script should end concatenation and maintain order.
+		$ver       = get_bloginfo( 'version' );
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core&amp;ver={$ver}'></script>\n";
+		$expected .= "<script type='text/javascript' src='/plugins/wp-i18n.js' id='wp-i18n-js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/default/common.js' id='common-js'></script>\n";
+
+		$this->assertSame( $expected, $print_scripts );
 	}
 }
diff --git a/tests/dependencies/styles.php b/tests/dependencies/styles.php
index bec55ac032..8e7721d1e9 100644
--- a/tests/dependencies/styles.php
+++ b/tests/dependencies/styles.php
@@ -195,6 +195,7 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 	 * @dataProvider data_normalize_relative_css_links
 	 *
 	 * @ticket 54243
+	 * @ticket 54922
 	 *
 	 * @covers ::_wp_normalize_relative_css_links
 	 *
@@ -231,6 +232,14 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 				'css'      => 'p {background-image: url(\'http://foo.com/image2.png\');}',
 				'expected' => 'p {background-image: url(\'http://foo.com/image2.png\');}',
 			),
+			'An HTML ID'                                   => array(
+				'css'      => 'clip-path: url(#image1);',
+				'expected' => 'clip-path: url(#image1);',
+			),
+			'Data URIs, shouldn\'t change'                 => array(
+				'css'      => 'img {mask-image: url(\'data:image/svg+xml;utf8,<svg></svg>\');}',
+				'expected' => 'img {mask-image: url(\'data:image/svg+xml;utf8,<svg></svg>\');}',
+			),
 		);
 	}
 
diff --git a/tests/external-http/basic.php b/tests/external-http/basic.php
index 0b5e8d9593..7ecc8713cc 100644
--- a/tests/external-http/basic.php
+++ b/tests/external-http/basic.php
@@ -9,43 +9,92 @@ class Tests_External_HTTP_Basic extends WP_UnitTestCase {
 	 * @covers ::wp_remote_retrieve_response_code
 	 * @covers ::wp_remote_retrieve_body
 	 */
-	public function test_readme() {
-		// This test is designed to only run on trunk/master.
+	public function test_readme_php_version() {
+		$this->markTestSkipped(
+			'Temporarily disabled. Test should be re-enabled once WordPress is fully compatible with PHP 8.0+.'
+		);
+
+		// This test is designed to only run on trunk.
 		$this->skipOnAutomatedBranches();
 
 		$readme = file_get_contents( ABSPATH . 'readme.html' );
 
 		preg_match( '#Recommendations.*PHP</a> version <strong>([0-9.]*)#s', $readme, $matches );
 
-		$response = wp_remote_get( 'https://www.php.net/supported-versions.php' );
+		$response_body = $this->get_response_body( 'https://www.php.net/supported-versions.php' );
 
-		$this->skipTestOnTimeout( $response );
+		preg_match_all( '#<tr class="stable">\s*<td>\s*<a [^>]*>\s*([0-9.]*)#s', $response_body, $php_matches );
 
-		$response_code = wp_remote_retrieve_response_code( $response );
-		$response_body = wp_remote_retrieve_body( $response );
+		$this->assertContains( $matches[1], $php_matches[1], "readme.html's Recommended PHP version is too old. Remember to update the WordPress.org Requirements page, too." );
+	}
 
-		if ( 200 !== $response_code ) {
-			$error_message = sprintf(
-				'Could not contact PHP.net to check versions. Response code: %s. Response body: %s',
-				$response_code,
-				$response_body
-			);
+	/**
+	 * @covers ::wp_remote_get
+	 * @covers ::wp_remote_retrieve_response_code
+	 * @covers ::wp_remote_retrieve_body
+	 */
+	public function test_readme_mysql_version() {
+		// This test is designed to only run on trunk.
+		$this->skipOnAutomatedBranches();
 
-			if ( 503 === $response_code ) {
-				$this->markTestSkipped( $error_message );
-			}
+		$readme = file_get_contents( ABSPATH . 'readme.html' );
 
-			$this->fail( $error_message );
-		}
+		preg_match( '#Recommendations.*MySQL</a> version <strong>([0-9.]*)#s', $readme, $matches );
 
-		preg_match_all( '#<tr class="stable">\s*<td>\s*<a [^>]*>\s*([0-9.]*)#s', $response_body, $phpmatches );
+		$response_body = $this->get_response_body( "https://dev.mysql.com/doc/relnotes/mysql/{$matches[1]}/en/" );
 
-		// TODO: Enable this check once PHP 8.0 compatibility is achieved.
-		// $this->assertContains( $matches[1], $phpmatches[1], "readme.html's Recommended PHP version is too old. Remember to update the WordPress.org Requirements page, too." );
+		// Retrieve the date of the first GA release for the recommended branch.
+		preg_match( '#.*(\d{4}-\d{2}-\d{2}), General Availability#s', $response_body, $mysql_matches );
 
-		preg_match( '#Recommendations.*MySQL</a> version <strong>([0-9.]*)#s', $readme, $matches );
+		/*
+		 * Per https://www.mysql.com/support/, Oracle actively supports MySQL releases for 5 years from GA release.
+		 *
+		 * The currently recommended MySQL 5.7 branch moved from active support to extended support on 2020-10-21.
+		 * As WordPress core is not fully compatible with MySQL 8.0 at this time, the "supported" period here
+		 * is increased to 8 years to include extended support.
+		 *
+		 * TODO: Reduce this back to 5 years once MySQL 8.0 compatibility is achieved.
+		 */
+		$mysql_eol    = gmdate( 'Y-m-d', strtotime( $mysql_matches[1] . ' +8 years' ) );
+		$current_date = gmdate( 'Y-m-d' );
+
+		$this->assertLessThan( $mysql_eol, $current_date, "readme.html's Recommended MySQL version is too old. Remember to update the WordPress.org Requirements page, too." );
+	}
+
+	/**
+	 * @covers ::wp_remote_get
+	 * @covers ::wp_remote_retrieve_response_code
+	 * @covers ::wp_remote_retrieve_body
+	 */
+	public function test_readme_mariadb_version() {
+		// This test is designed to only run on trunk.
+		$this->skipOnAutomatedBranches();
+
+		$readme = file_get_contents( ABSPATH . 'readme.html' );
 
-		$response = wp_remote_get( "https://dev.mysql.com/doc/relnotes/mysql/{$matches[1]}/en/" );
+		preg_match( '#Recommendations.*MariaDB</a> version <strong>([0-9.]*)#s', $readme, $matches );
+		$matches[1] = str_replace( '.', '', $matches[1] );
+
+		$response_body = $this->get_response_body( "https://mariadb.com/kb/en/release-notes-mariadb-{$matches[1]}-series/" );
+
+		// Retrieve the date of the first stable release for the recommended branch.
+		preg_match( '#.*Stable.*?(\d{2} [A-Za-z]{3} \d{4})#s', $response_body, $mariadb_matches );
+
+		// Per https://mariadb.org/about/#maintenance-policy, MariaDB releases are supported for 5 years.
+		$mariadb_eol  = gmdate( 'Y-m-d', strtotime( $mariadb_matches[1] . ' +5 years' ) );
+		$current_date = gmdate( 'Y-m-d' );
+
+		$this->assertLessThan( $mariadb_eol, $current_date, "readme.html's Recommended MariaDB version is too old. Remember to update the WordPress.org Requirements page, too." );
+	}
+
+	/**
+	 * Helper function to retrieve the response body or skip the test on HTTP timeout.
+	 *
+	 * @param string $url The URL to retrieve the response from.
+	 * @return string The response body.
+	 */
+	public function get_response_body( $url ) {
+		$response = wp_remote_get( $url );
 
 		$this->skipTestOnTimeout( $response );
 
@@ -53,8 +102,11 @@ class Tests_External_HTTP_Basic extends WP_UnitTestCase {
 		$response_body = wp_remote_retrieve_body( $response );
 
 		if ( 200 !== $response_code ) {
+			$parsed_url = parse_url( $url );
+
 			$error_message = sprintf(
-				'Could not contact dev.MySQL.com to check versions. Response code: %s. Response body: %s',
+				'Could not contact %1$s to check versions. Response code: %2$s. Response body: %3$s',
+				$parsed_url['host'],
 				$response_code,
 				$response_body
 			);
@@ -66,11 +118,6 @@ class Tests_External_HTTP_Basic extends WP_UnitTestCase {
 			$this->fail( $error_message );
 		}
 
-		preg_match( '#(\d{4}-\d{2}-\d{2}), General Availability#', $response_body, $mysqlmatches );
-
-		// Per https://www.mysql.com/support/, Oracle actively supports MySQL releases for 5 years from GA release.
-		$mysql_eol = strtotime( $mysqlmatches[1] . ' +5 years' );
-
-		$this->assertLessThan( $mysql_eol, time(), "readme.html's Recommended MySQL version is too old. Remember to update the WordPress.org Requirements page, too." );
+		return $response_body;
 	}
 }
diff --git a/tests/feed/atom.php b/tests/feed/atom.php
index 7b9ca4c405..c88592ec9a 100644
--- a/tests/feed/atom.php
+++ b/tests/feed/atom.php
@@ -13,6 +13,9 @@ class Tests_Feed_Atom extends WP_UnitTestCase {
 	public static $posts;
 	public static $category;
 
+	private $post_count;
+	private $excerpt_only;
+
 	/**
 	 * Setup a new user and attribute some posts.
 	 */
@@ -51,6 +54,9 @@ class Tests_Feed_Atom extends WP_UnitTestCase {
 			wp_set_object_terms( $post, self::$category->slug, 'category' );
 		}
 
+		// Assign a tagline option.
+		update_option( 'blogdescription', 'Just another WordPress site' );
+
 	}
 
 	/**
@@ -63,6 +69,13 @@ class Tests_Feed_Atom extends WP_UnitTestCase {
 		$this->excerpt_only = get_option( 'rss_use_excerpt' );
 	}
 
+	/**
+	 * Tear down.
+	 */
+	public static function wpTearDownAfterClass() {
+		delete_option( 'blogdescription' );
+	}
+
 	/**
 	 * This is a bit of a hack used to buffer feed content.
 	 */
diff --git a/tests/feed/rss2.php b/tests/feed/rss2.php
index 742c78f3d7..356b402def 100644
--- a/tests/feed/rss2.php
+++ b/tests/feed/rss2.php
@@ -14,6 +14,9 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 	public static $category;
 	public static $post_date;
 
+	private $post_count;
+	private $excerpt_only;
+
 	/**
 	 * Setup a new user and attribute some posts.
 	 */
@@ -58,6 +61,10 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 		foreach ( self::$posts as $post ) {
 			wp_set_object_terms( $post, self::$category->slug, 'category' );
 		}
+
+		// Assign a tagline option.
+		update_option( 'blogdescription', 'Just another WordPress site' );
+
 	}
 
 	/**
@@ -75,6 +82,13 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 		create_initial_taxonomies();
 	}
 
+	/**
+	 * Tear down.
+	 */
+	public static function wpTearDownAfterClass() {
+		delete_option( 'blogdescription' );
+	}
+
 	/**
 	 * This is a bit of a hack used to buffer feed content.
 	 */
@@ -494,4 +508,125 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 		);
 
 	}
+
+	/**
+	 * Test that the Last-Modified is a post's date when a more recent comment exists,
+	 * but the "withcomments=1" query var is not passed.
+	 *
+	 * @ticket 47968
+	 *
+	 * @covers WP::send_headers
+	 */
+	public function test_feed_last_modified_should_be_a_post_date_when_withcomments_is_not_passed() {
+		$last_week = gmdate( 'Y-m-d H:i:s', strtotime( '-1 week' ) );
+		$yesterday = gmdate( 'Y-m-d H:i:s', strtotime( '-1 day' ) );
+
+		// Create a post dated last week.
+		$post_id = self::factory()->post->create( array( 'post_date' => $last_week ) );
+
+		// Create a comment dated yesterday.
+		self::factory()->comment->create(
+			array(
+				'comment_post_ID' => $post_id,
+				'comment_date'    => $yesterday,
+			)
+		);
+
+		// The Last-Modified header should have the post's date when "withcomments" is not passed.
+		add_filter(
+			'wp_headers',
+			function( $headers ) use ( $last_week ) {
+				$this->assertSame(
+					strtotime( $headers['Last-Modified'] ),
+					strtotime( $last_week ),
+					'Last-Modified was not the date of the post'
+				);
+				return $headers;
+			}
+		);
+
+		$this->go_to( '/?feed=rss2' );
+	}
+
+	/**
+	 * Test that the Last-Modified is a comment's date when a more recent comment exists,
+	 * and the "withcomments=1" query var is passed.
+	 *
+	 * @ticket 47968
+	 *
+	 * @covers WP::send_headers
+	 */
+	public function test_feed_last_modified_should_be_the_date_of_a_comment_that_is_the_latest_update_when_withcomments_is_passed() {
+		$last_week = gmdate( 'Y-m-d H:i:s', strtotime( '-1 week' ) );
+		$yesterday = gmdate( 'Y-m-d H:i:s', strtotime( '-1 day' ) );
+
+		// Create a post dated last week.
+		$post_id = self::factory()->post->create( array( 'post_date' => $last_week ) );
+
+		// Create a comment dated yesterday.
+		self::factory()->comment->create(
+			array(
+				'comment_post_ID' => $post_id,
+				'comment_date'    => $yesterday,
+			)
+		);
+
+		// The Last-Modified header should have the comment's date when "withcomments=1" is passed.
+		add_filter(
+			'wp_headers',
+			function( $headers ) use ( $yesterday ) {
+				$this->assertSame(
+					strtotime( $headers['Last-Modified'] ),
+					strtotime( $yesterday ),
+					'Last-Modified was not the date of the comment'
+				);
+				return $headers;
+			}
+		);
+
+		$this->go_to( '/?feed=rss2&withcomments=1' );
+	}
+
+	/**
+	 * Test that the Last-Modified is the latest post's date when an earlier post and comment exist,
+	 * and the "withcomments=1" query var is passed.
+	 *
+	 * @ticket 47968
+	 *
+	 * @covers WP::send_headers
+	 */
+	public function test_feed_last_modified_should_be_the_date_of_a_post_that_is_the_latest_update_when_withcomments_is_passed() {
+		$last_week = gmdate( 'Y-m-d H:i:s', strtotime( '-1 week' ) );
+		$yesterday = gmdate( 'Y-m-d H:i:s', strtotime( '-1 day' ) );
+		$today     = gmdate( 'Y-m-d H:i:s' );
+
+		// Create a post dated last week.
+		$post_id = self::factory()->post->create( array( 'post_date' => $last_week ) );
+
+		// Create a comment dated yesterday.
+		self::factory()->comment->create(
+			array(
+				'comment_post_ID' => $post_id,
+				'comment_date'    => $yesterday,
+			)
+		);
+
+		// Create a post dated today.
+		self::factory()->post->create( array( 'post_date' => $today ) );
+
+		// The Last-Modified header should have the date from today's post when it is the latest update.
+		add_filter(
+			'wp_headers',
+			function( $headers ) use ( $today ) {
+				$this->assertSame(
+					strtotime( $headers['Last-Modified'] ),
+					strtotime( $today ),
+					'Last-Modified was not the date of the most recent post'
+				);
+				return $headers;
+			}
+		);
+
+		$this->go_to( '/?feed=rss2&withcomments=1' );
+	}
 }
diff --git a/tests/file.php b/tests/file.php
index eb6168d9af..8e315e33aa 100644
--- a/tests/file.php
+++ b/tests/file.php
@@ -5,12 +5,14 @@
  */
 class Tests_File extends WP_UnitTestCase {
 
+	const BADCHARS = '"\'[]*&?$';
+
+	private $dir;
+
 	public function set_up() {
 		parent::set_up();
 
 		$this->dir = untrailingslashit( get_temp_dir() );
-
-		$this->badchars = '"\'[]*&?$';
 	}
 
 	/**
@@ -96,8 +98,8 @@ class Tests_File extends WP_UnitTestCase {
 			return false;
 		}
 
-		// Write some random contents.
-		$c = rand_str();
+		// Write some contents.
+		$c = 'foo';
 		fwrite( $fp, $c );
 		fclose( $fp );
 
@@ -137,7 +139,7 @@ class Tests_File extends WP_UnitTestCase {
 
 	public function test_unique_filename_is_sanitized() {
 		$name     = __FUNCTION__;
-		$filename = wp_unique_filename( $this->dir, $name . $this->badchars . '.txt' );
+		$filename = wp_unique_filename( $this->dir, $name . self::BADCHARS . '.txt' );
 
 		// Make sure the bad characters were all stripped out.
 		$this->assertSame( $name . '.txt', $filename );
diff --git a/tests/filters.php b/tests/filters.php
index 6bcd437365..fed43735fc 100644
--- a/tests/filters.php
+++ b/tests/filters.php
@@ -8,17 +8,17 @@
 class Tests_Filters extends WP_UnitTestCase {
 
 	public function test_simple_filter() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
 
-		add_filter( $tag, array( $a, 'filter' ) );
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		add_filter( $hook_name, array( $a, 'filter' ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 
 		// Only one event occurred for the hook, with empty args.
 		$this->assertSame( 1, $a->get_call_count() );
 		// Only our hook was called.
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 		$argsvar = $a->get_args();
 		$args    = array_pop( $argsvar );
@@ -26,51 +26,53 @@ class Tests_Filters extends WP_UnitTestCase {
 	}
 
 	public function test_remove_filter() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
 
-		add_filter( $tag, array( $a, 'filter' ) );
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		add_filter( $hook_name, array( $a, 'filter' ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 
 		// Make sure our hook was called correctly.
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 		// Now remove the filter, do it again, and make sure it's not called this time.
-		remove_filter( $tag, array( $a, 'filter' ) );
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		remove_filter( $hook_name, array( $a, 'filter' ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 	}
 
 	public function test_has_filter() {
-			$tag  = __FUNCTION__;
-			$func = __FUNCTION__ . '_func';
-
-			$this->assertFalse( has_filter( $tag, $func ) );
-			$this->assertFalse( has_filter( $tag ) );
-			add_filter( $tag, $func );
-			$this->assertSame( 10, has_filter( $tag, $func ) );
-			$this->assertTrue( has_filter( $tag ) );
-			remove_filter( $tag, $func );
-			$this->assertFalse( has_filter( $tag, $func ) );
-			$this->assertFalse( has_filter( $tag ) );
+		$hook_name = __FUNCTION__;
+		$callback  = __FUNCTION__ . '_func';
+
+		$this->assertFalse( has_filter( $hook_name, $callback ) );
+		$this->assertFalse( has_filter( $hook_name ) );
+
+		add_filter( $hook_name, $callback );
+		$this->assertSame( 10, has_filter( $hook_name, $callback ) );
+		$this->assertTrue( has_filter( $hook_name ) );
+
+		remove_filter( $hook_name, $callback );
+		$this->assertFalse( has_filter( $hook_name, $callback ) );
+		$this->assertFalse( has_filter( $hook_name ) );
 	}
 
 	// One tag with multiple filters.
 	public function test_multiple_filters() {
-		$a1  = new MockAction();
-		$a2  = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a1        = new MockAction();
+		$a2        = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
 
 		// Add both filters to the hook.
-		add_filter( $tag, array( $a1, 'filter' ) );
-		add_filter( $tag, array( $a2, 'filter' ) );
+		add_filter( $hook_name, array( $a1, 'filter' ) );
+		add_filter( $hook_name, array( $a2, 'filter' ) );
 
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 
 		// Both filters called once each.
 		$this->assertSame( 1, $a1->get_call_count() );
@@ -78,14 +80,14 @@ class Tests_Filters extends WP_UnitTestCase {
 	}
 
 	public function test_filter_args_1() {
-		$a    = new MockAction();
-		$tag  = __FUNCTION__;
-		$val  = __FUNCTION__ . '_val';
-		$arg1 = __FUNCTION__ . '_arg1';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
+		$arg1      = __FUNCTION__ . '_arg1';
 
-		add_filter( $tag, array( $a, 'filter' ), 10, 2 );
+		add_filter( $hook_name, array( $a, 'filter' ), 10, 2 );
 		// Call the filter with a single argument.
-		$this->assertSame( $val, apply_filters( $tag, $val, $arg1 ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val, $arg1 ) );
 
 		$this->assertSame( 1, $a->get_call_count() );
 		$argsvar = $a->get_args();
@@ -93,18 +95,18 @@ class Tests_Filters extends WP_UnitTestCase {
 	}
 
 	public function test_filter_args_2() {
-		$a1   = new MockAction();
-		$a2   = new MockAction();
-		$tag  = __FUNCTION__;
-		$val  = __FUNCTION__ . '_val';
-		$arg1 = __FUNCTION__ . '_arg1';
-		$arg2 = __FUNCTION__ . '_arg2';
+		$a1        = new MockAction();
+		$a2        = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
+		$arg1      = __FUNCTION__ . '_arg1';
+		$arg2      = __FUNCTION__ . '_arg2';
 
 		// $a1 accepts two arguments, $a2 doesn't.
-		add_filter( $tag, array( $a1, 'filter' ), 10, 3 );
-		add_filter( $tag, array( $a2, 'filter' ) );
+		add_filter( $hook_name, array( $a1, 'filter' ), 10, 3 );
+		add_filter( $hook_name, array( $a2, 'filter' ) );
 		// Call the filter with two arguments.
-		$this->assertSame( $val, apply_filters( $tag, $val, $arg1, $arg2 ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val, $arg1, $arg2 ) );
 
 		// $a1 should be called with both args.
 		$this->assertSame( 1, $a1->get_call_count() );
@@ -118,14 +120,14 @@ class Tests_Filters extends WP_UnitTestCase {
 	}
 
 	public function test_filter_priority() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
 
 		// Make two filters with different priorities.
-		add_filter( $tag, array( $a, 'filter' ), 10 );
-		add_filter( $tag, array( $a, 'filter2' ), 9 );
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		add_filter( $hook_name, array( $a, 'filter' ), 10 );
+		add_filter( $hook_name, array( $a, 'filter2' ), 9 );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 
 		// There should be two events, one per filter.
 		$this->assertSame( 2, $a->get_call_count() );
@@ -133,39 +135,66 @@ class Tests_Filters extends WP_UnitTestCase {
 		$expected = array(
 			// 'filter2' is called first because it has priority 9.
 			array(
-				'filter' => 'filter2',
-				'tag'    => $tag,
-				'args'   => array( $val ),
+				'filter'    => 'filter2',
+				'hook_name' => $hook_name,
+				'tag'       => $hook_name, // Back compat.
+				'args'      => array( $val ),
 			),
 			// 'filter' is called second.
 			array(
-				'filter' => 'filter',
-				'tag'    => $tag,
-				'args'   => array( $val ),
+				'filter'    => 'filter',
+				'hook_name' => $hook_name,
+				'tag'       => $hook_name, // Back compat.
+				'args'      => array( $val ),
 			),
 		);
 
 		$this->assertSame( $expected, $a->get_events() );
 	}
 
+	/**
+	 * @covers ::did_filter
+	 */
+	public function test_did_filter() {
+		$hook_name1 = 'filter1';
+		$hook_name2 = 'filter2';
+		$val        = __FUNCTION__ . '_val';
+
+		// Apply filter $hook_name1 but not $hook_name2.
+		apply_filters( $hook_name1, $val );
+		$this->assertSame( 1, did_filter( $hook_name1 ) );
+		$this->assertSame( 0, did_filter( $hook_name2 ) );
+
+		// Apply filter $hook_name2 10 times.
+		$count = 10;
+		for ( $i = 0; $i < $count; $i++ ) {
+			apply_filters( $hook_name2, $val );
+		}
+
+		// $hook_name1's count hasn't changed, $hook_name2 should be correct.
+		$this->assertSame( 1, did_filter( $hook_name1 ) );
+		$this->assertSame( $count, did_filter( $hook_name2 ) );
+
+	}
+
 	public function test_all_filter() {
-		$a    = new MockAction();
-		$tag1 = __FUNCTION__ . '_1';
-		$tag2 = __FUNCTION__ . '_2';
-		$val  = __FUNCTION__ . '_val';
+		$a          = new MockAction();
+		$hook_name1 = __FUNCTION__ . '_1';
+		$hook_name2 = __FUNCTION__ . '_2';
+		$val        = __FUNCTION__ . '_val';
 
 		// Add an 'all' filter.
 		add_filter( 'all', array( $a, 'filterall' ) );
 		// Apply some filters.
-		$this->assertSame( $val, apply_filters( $tag1, $val ) );
-		$this->assertSame( $val, apply_filters( $tag2, $val ) );
-		$this->assertSame( $val, apply_filters( $tag1, $val ) );
-		$this->assertSame( $val, apply_filters( $tag1, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name1, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name2, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name1, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name1, $val ) );
 
 		// Our filter should have been called once for each apply_filters call.
 		$this->assertSame( 4, $a->get_call_count() );
 		// The right hooks should have been called in order.
-		$this->assertSame( array( $tag1, $tag2, $tag1, $tag1 ), $a->get_tags() );
+		$this->assertSame( array( $hook_name1, $hook_name2, $hook_name1, $hook_name1 ), $a->get_hook_names() );
 
 		remove_filter( 'all', array( $a, 'filterall' ) );
 		$this->assertFalse( has_filter( 'all', array( $a, 'filterall' ) ) );
@@ -173,59 +202,101 @@ class Tests_Filters extends WP_UnitTestCase {
 	}
 
 	public function test_remove_all_filter() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = __FUNCTION__ . '_val';
 
 		add_filter( 'all', array( $a, 'filterall' ) );
 		$this->assertTrue( has_filter( 'all' ) );
 		$this->assertSame( 10, has_filter( 'all', array( $a, 'filterall' ) ) );
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 
 		// Make sure our hook was called correctly.
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 
 		// Now remove the filter, do it again, and make sure it's not called this time.
 		remove_filter( 'all', array( $a, 'filterall' ) );
 		$this->assertFalse( has_filter( 'all', array( $a, 'filterall' ) ) );
 		$this->assertFalse( has_filter( 'all' ) );
-		$this->assertSame( $val, apply_filters( $tag, $val ) );
+		$this->assertSame( $val, apply_filters( $hook_name, $val ) );
 		// Call cound should remain at 1.
 		$this->assertSame( 1, $a->get_call_count() );
-		$this->assertSame( array( $tag ), $a->get_tags() );
+		$this->assertSame( array( $hook_name ), $a->get_hook_names() );
 	}
 
 	/**
 	 * @ticket 20920
 	 */
 	public function test_remove_all_filters_should_respect_the_priority_argument() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_filter( $tag, array( $a, 'filter' ), 12 );
-		$this->assertTrue( has_filter( $tag ) );
+		add_filter( $hook_name, array( $a, 'filter' ), 12 );
+		$this->assertTrue( has_filter( $hook_name ) );
 
 		// Should not be removed.
-		remove_all_filters( $tag, 11 );
-		$this->assertTrue( has_filter( $tag ) );
+		remove_all_filters( $hook_name, 11 );
+		$this->assertTrue( has_filter( $hook_name ) );
+
+		remove_all_filters( $hook_name, 12 );
+		$this->assertFalse( has_filter( $hook_name ) );
+	}
+
+	/**
+	 * @ticket 53218
+	 */
+	public function test_filter_with_ref_value() {
+		$obj       = new stdClass();
+		$ref       = &$obj;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+
+		add_action( $hook_name, array( $a, 'filter' ) );
+
+		$filtered = apply_filters( $hook_name, $ref );
+
+		$args = $a->get_args();
+		$this->assertSame( $args[0][0], $obj );
+		$this->assertSame( $filtered, $obj );
+		// Just in case we don't trust assertSame().
+		$obj->foo = true;
+		$this->assertNotEmpty( $args[0][0]->foo );
+		$this->assertNotEmpty( $filtered->foo );
+	}
+
+	/**
+	 * @ticket 53218
+	 */
+	public function test_filter_with_ref_argument() {
+		$obj       = new stdClass();
+		$ref       = &$obj;
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
+		$val       = 'Hello';
+
+		add_action( $hook_name, array( $a, 'filter' ), 10, 2 );
 
-		remove_all_filters( $tag, 12 );
-		$this->assertFalse( has_filter( $tag ) );
+		apply_filters( $hook_name, $val, $ref );
+
+		$args = $a->get_args();
+		$this->assertSame( $args[0][1], $obj );
+		// Just in case we don't trust assertSame().
+		$obj->foo = true;
+		$this->assertNotEmpty( $args[0][1]->foo );
 	}
 
 	/**
 	 * @ticket 9886
 	 */
 	public function test_filter_ref_array() {
-		$obj = new stdClass();
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
+		$obj       = new stdClass();
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( $a, 'filter' ) );
+		add_action( $hook_name, array( $a, 'filter' ) );
 
-		apply_filters_ref_array( $tag, array( &$obj ) );
+		apply_filters_ref_array( $hook_name, array( &$obj ) );
 
 		$args = $a->get_args();
 		$this->assertSame( $args[0][0], $obj );
@@ -238,15 +309,15 @@ class Tests_Filters extends WP_UnitTestCase {
 	 * @ticket 12723
 	 */
 	public function test_filter_ref_array_result() {
-		$obj = new stdClass();
-		$a   = new MockAction();
-		$b   = new MockAction();
-		$tag = __FUNCTION__;
+		$obj       = new stdClass();
+		$a         = new MockAction();
+		$b         = new MockAction();
+		$hook_name = __FUNCTION__;
 
-		add_action( $tag, array( $a, 'filter_append' ), 10, 2 );
-		add_action( $tag, array( $b, 'filter_append' ), 10, 2 );
+		add_action( $hook_name, array( $a, 'filter_append' ), 10, 2 );
+		add_action( $hook_name, array( $b, 'filter_append' ), 10, 2 );
 
-		$result = apply_filters_ref_array( $tag, array( 'string', &$obj ) );
+		$result = apply_filters_ref_array( $hook_name, array( 'string', &$obj ) );
 
 		$this->assertSame( $result, 'string_append_append' );
 
@@ -268,26 +339,25 @@ class Tests_Filters extends WP_UnitTestCase {
 	 * @ticket 29070
 	 */
 	public function test_has_filter_after_remove_all_filters() {
-		$a   = new MockAction();
-		$tag = __FUNCTION__;
-		$val = __FUNCTION__ . '_val';
+		$a         = new MockAction();
+		$hook_name = __FUNCTION__;
 
 		// No priority.
-		add_filter( $tag, array( $a, 'filter' ), 11 );
-		add_filter( $tag, array( $a, 'filter' ), 12 );
-		$this->assertTrue( has_filter( $tag ) );
+		add_filter( $hook_name, array( $a, 'filter' ), 11 );
+		add_filter( $hook_name, array( $a, 'filter' ), 12 );
+		$this->assertTrue( has_filter( $hook_name ) );
 
-		remove_all_filters( $tag );
-		$this->assertFalse( has_filter( $tag ) );
+		remove_all_filters( $hook_name );
+		$this->assertFalse( has_filter( $hook_name ) );
 
 		// Remove priorities one at a time.
-		add_filter( $tag, array( $a, 'filter' ), 11 );
-		add_filter( $tag, array( $a, 'filter' ), 12 );
-		$this->assertTrue( has_filter( $tag ) );
+		add_filter( $hook_name, array( $a, 'filter' ), 11 );
+		add_filter( $hook_name, array( $a, 'filter' ), 12 );
+		$this->assertTrue( has_filter( $hook_name ) );
 
-		remove_all_filters( $tag, 11 );
-		remove_all_filters( $tag, 12 );
-		$this->assertFalse( has_filter( $tag ) );
+		remove_all_filters( $hook_name, 11 );
+		remove_all_filters( $hook_name, 12 );
+		$this->assertFalse( has_filter( $hook_name ) );
 	}
 
 	/**
@@ -344,6 +414,7 @@ class Tests_Filters extends WP_UnitTestCase {
 	}
 
 	private $current_priority;
+
 	/**
 	 * @ticket 39007
 	 */
@@ -357,6 +428,7 @@ class Tests_Filters extends WP_UnitTestCase {
 
 	public function current_priority_action() {
 		global $wp_filter;
+
 		$this->current_priority = $wp_filter[ current_filter() ]->current_priority();
 	}
 
diff --git a/tests/formatting/balanceTags.php b/tests/formatting/balanceTags.php
index 11740c98a3..27740878f7 100644
--- a/tests/formatting/balanceTags.php
+++ b/tests/formatting/balanceTags.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::balanceTags
  */
 class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 
diff --git a/tests/formatting/capitalPDangit.php b/tests/formatting/capitalPDangit.php
index 3e78e1a364..5dc741d372 100644
--- a/tests/formatting/capitalPDangit.php
+++ b/tests/formatting/capitalPDangit.php
@@ -3,6 +3,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::capital_P_dangit
  */
 class Tests_Formatting_CapitalPDangit extends WP_UnitTestCase {
 	public function test_esc_attr_quotes() {
diff --git a/tests/formatting/cleanPre.php b/tests/formatting/cleanPre.php
index 8444ae7bd5..49d0ab9e2b 100644
--- a/tests/formatting/cleanPre.php
+++ b/tests/formatting/cleanPre.php
@@ -6,6 +6,8 @@
  *
  * @group formatting
  * @expectedDeprecated clean_pre
+ *
+ * @covers ::clean_pre
  */
 class Tests_Formatting_CleanPre extends WP_UnitTestCase {
 
@@ -22,10 +24,13 @@ class Tests_Formatting_CleanPre extends WP_UnitTestCase {
 		$this->assertSame( $res, clean_pre( $source ) );
 	}
 
-	// I don't think this can ever happen in production;
-	// <br> is changed to <br /> elsewhere. Left in because
-	// that replacement shouldn't happen (what if you want
-	// HTML 4 output?).
+
+	/**
+	 * I don't think this can ever happen in production;
+	 * <br> is changed to <br /> elsewhere. Left in because
+	 * that replacement shouldn't happen (what if you want
+	 * HTML 4 output?).
+	 */
 	public function test_removes_html_br() {
 		$source = 'a b c\n<br>sldfj<br>';
 		$res    = 'a b c\nsldfj';
diff --git a/tests/formatting/convertInvalidEntries.php b/tests/formatting/convertInvalidEntities.php
similarity index 92%
rename from tests/formatting/convertInvalidEntries.php
rename to tests/formatting/convertInvalidEntities.php
index 9b243ee421..6101165191 100644
--- a/tests/formatting/convertInvalidEntries.php
+++ b/tests/formatting/convertInvalidEntities.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::convert_invalid_entities
  */
 class Tests_Formatting_ConvertInvalidEntities extends WP_UnitTestCase {
 	public function test_replaces_windows1252_entities_with_unicode_ones() {
@@ -19,6 +21,9 @@ class Tests_Formatting_ConvertInvalidEntities extends WP_UnitTestCase {
 		$this->assertSame( $output, convert_invalid_entities( $input ) );
 	}
 
+	/**
+	 * @covers ::convert_chars
+	 */
 	public function test_escapes_lone_ampersands() {
 		$this->assertSame( 'at&#038;t', convert_chars( 'at&t' ) );
 	}
diff --git a/tests/formatting/convertSmilies.php b/tests/formatting/convertSmilies.php
index 760625e40a..5031b4b51c 100644
--- a/tests/formatting/convertSmilies.php
+++ b/tests/formatting/convertSmilies.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @group emoji
+ *
+ * @covers ::convert_smilies
  */
 class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 
@@ -17,7 +19,7 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 		return array(
 			array(
 				'Lorem ipsum dolor sit amet mauris ;-) Praesent gravida sodales. :lol: Vivamus nec diam in faucibus eu, bibendum varius nec, imperdiet purus est, at augue at lacus malesuada elit dapibus a, :eek: mauris. Cras mauris viverra elit. Nam laoreet viverra. Pellentesque tortor. Nam libero ante, porta urna ut turpis. Nullam wisi magna, :mrgreen: tincidunt nec, sagittis non, fringilla enim. Nam consectetuer nec, ullamcorper pede eu dui odio consequat vel, vehicula tortor quis pede turpis cursus quis, egestas ipsum ultricies ut, eleifend velit. Mauris vestibulum iaculis. Sed in nunc. Vivamus elit porttitor egestas. Mauris purus :?:',
-				"Lorem ipsum dolor sit amet mauris \xf0\x9f\x98\x89 Praesent gravida sodales. \xf0\x9f\x98\x86 Vivamus nec diam in faucibus eu, bibendum varius nec, imperdiet purus est, at augue at lacus malesuada elit dapibus a, \xf0\x9f\x98\xae mauris. Cras mauris viverra elit. Nam laoreet viverra. Pellentesque tortor. Nam libero ante, porta urna ut turpis. Nullam wisi magna, <img src=\"${includes_path}mrgreen.png\" alt=\":mrgreen:\" class=\"wp-smiley\" style=\"height: 1em; max-height: 1em;\" /> tincidunt nec, sagittis non, fringilla enim. Nam consectetuer nec, ullamcorper pede eu dui odio consequat vel, vehicula tortor quis pede turpis cursus quis, egestas ipsum ultricies ut, eleifend velit. Mauris vestibulum iaculis. Sed in nunc. Vivamus elit porttitor egestas. Mauris purus \xe2\x9d\x93",
+				"Lorem ipsum dolor sit amet mauris \xf0\x9f\x98\x89 Praesent gravida sodales. \xf0\x9f\x98\x86 Vivamus nec diam in faucibus eu, bibendum varius nec, imperdiet purus est, at augue at lacus malesuada elit dapibus a, \xf0\x9f\x98\xae mauris. Cras mauris viverra elit. Nam laoreet viverra. Pellentesque tortor. Nam libero ante, porta urna ut turpis. Nullam wisi magna, <img src=\"{$includes_path}mrgreen.png\" alt=\":mrgreen:\" class=\"wp-smiley\" style=\"height: 1em; max-height: 1em;\" /> tincidunt nec, sagittis non, fringilla enim. Nam consectetuer nec, ullamcorper pede eu dui odio consequat vel, vehicula tortor quis pede turpis cursus quis, egestas ipsum ultricies ut, eleifend velit. Mauris vestibulum iaculis. Sed in nunc. Vivamus elit porttitor egestas. Mauris purus \xe2\x9d\x93",
 			),
 			array(
 				'<strong>Welcome to the jungle!</strong> We got fun n games! :) We got everything you want 8-) <em>Honey we know the names :)</em>',
diff --git a/tests/formatting/date.php b/tests/formatting/date.php
index 9f0f975d4c..c08a94710c 100644
--- a/tests/formatting/date.php
+++ b/tests/formatting/date.php
@@ -6,10 +6,23 @@
  */
 class Tests_Formatting_Date extends WP_UnitTestCase {
 
+	/**
+	 * Cleans up.
+	 */
+	public function tear_down() {
+		// Reset changed options to their default value.
+		update_option( 'gmt_offset', 0 );
+		update_option( 'timezone_string', '' );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * Unpatched, this test passes only when Europe/London is not observing DST.
 	 *
 	 * @ticket 20328
+	 *
+	 * @covers ::get_date_from_gmt
 	 */
 	public function test_get_date_from_gmt_outside_of_dst() {
 		update_option( 'timezone_string', 'Europe/London' );
@@ -22,6 +35,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 * Unpatched, this test passes only when Europe/London is observing DST.
 	 *
 	 * @ticket 20328
+	 *
+	 * @covers ::get_date_from_gmt
 	 */
 	public function test_get_date_from_gmt_during_dst() {
 		update_option( 'timezone_string', 'Europe/London' );
@@ -32,6 +47,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20328
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_get_gmt_from_date_outside_of_dst() {
 		update_option( 'timezone_string', 'Europe/London' );
@@ -42,6 +59,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 20328
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_get_gmt_from_date_during_dst() {
 		update_option( 'timezone_string', 'Europe/London' );
@@ -52,6 +71,9 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34279
+	 *
+	 * @covers ::get_date_from_gmt
+	 *
 	 */
 	public function test_get_date_and_time_from_gmt_no_timezone() {
 		$local = '2012-01-01 12:34:56';
@@ -61,6 +83,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34279
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_get_gmt_from_date_no_timezone() {
 		$gmt  = '2012-12-01 00:00:00';
@@ -70,6 +94,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34279
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_get_gmt_from_date_short_date() {
 		update_option( 'timezone_string', 'Europe/London' );
@@ -80,6 +106,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34279
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_get_gmt_from_date_string_date() {
 		update_option( 'timezone_string', 'Europe/London' );
@@ -90,6 +118,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34279
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_get_gmt_from_date_string_date_no_timezone() {
 		$local = 'now';
@@ -101,6 +131,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 * @ticket 31809
 	 *
 	 * @dataProvider timezone_provider
+	 *
+	 * @covers ::get_gmt_from_date
 	 */
 	public function test_gmt_from_date_correct_time( $timezone_string, $gmt_offset ) {
 		update_option( 'timezone_string', $timezone_string );
@@ -117,6 +149,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 * @ticket 31809
 	 *
 	 * @dataProvider timezone_provider
+	 *
+	 * @covers ::get_date_from_gmt
 	 */
 	public function test_date_from_gmt_correct_time( $timezone_string, $gmt_offset ) {
 		update_option( 'timezone_string', $timezone_string );
@@ -133,6 +167,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 * @ticket 31809
 	 *
 	 * @dataProvider timezone_provider
+	 *
+	 * @covers ::iso8601_to_datetime
 	 */
 	public function test_is8601_to_datetime_correct_time( $timezone_string, $gmt_offset ) {
 		update_option( 'timezone_string', $timezone_string );
diff --git a/tests/formatting/emoji.php b/tests/formatting/emoji.php
index 85951a0726..cff36ccb8a 100644
--- a/tests/formatting/emoji.php
+++ b/tests/formatting/emoji.php
@@ -6,11 +6,13 @@
  */
 class Tests_Formatting_Emoji extends WP_UnitTestCase {
 
-	private $png_cdn = 'https://s.w.org/images/core/emoji/13.1.0/72x72/';
-	private $svn_cdn = 'https://s.w.org/images/core/emoji/13.1.0/svg/';
+	private $png_cdn = 'https://s.w.org/images/core/emoji/14.0.0/72x72/';
+	private $svn_cdn = 'https://s.w.org/images/core/emoji/14.0.0/svg/';
 
 	/**
 	 * @ticket 36525
+	 *
+	 * @covers ::_print_emoji_detection_script
 	 */
 	public function test_unfiltered_emoji_cdns() {
 		// `_print_emoji_detection_script()` assumes `wp-includes/js/wp-emoji-loader.js` is present:
@@ -27,6 +29,8 @@ class Tests_Formatting_Emoji extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36525
+	 *
+	 * @covers ::_print_emoji_detection_script
 	 */
 	public function test_filtered_emoji_svn_cdn() {
 		$filtered_svn_cdn = $this->_filtered_emoji_svn_cdn();
@@ -50,6 +54,8 @@ class Tests_Formatting_Emoji extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36525
+	 *
+	 * @covers ::_print_emoji_detection_script
 	 */
 	public function test_filtered_emoji_png_cdn() {
 		$filtered_png_cdn = $this->_filtered_emoji_png_cdn();
@@ -69,6 +75,8 @@ class Tests_Formatting_Emoji extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 41501
+	 *
+	 * @covers ::_wp_emoji_list
 	 */
 	public function test_wp_emoji_list_returns_data() {
 		$default = _wp_emoji_list();
@@ -113,6 +121,8 @@ class Tests_Formatting_Emoji extends WP_UnitTestCase {
 	/**
 	 * @ticket 35293
 	 * @dataProvider data_wp_encode_emoji
+	 *
+	 * @covers ::wp_encode_emoji
 	 */
 	public function test_wp_encode_emoji( $emoji, $expected ) {
 		$this->assertSame( $expected, wp_encode_emoji( $emoji ) );
@@ -148,6 +158,8 @@ class Tests_Formatting_Emoji extends WP_UnitTestCase {
 	/**
 	 * @ticket 35293
 	 * @dataProvider data_wp_staticize_emoji
+	 *
+	 * @covers ::wp_staticize_emoji
 	 */
 	public function test_wp_staticize_emoji( $emoji, $expected ) {
 		$this->assertSame( $expected, wp_staticize_emoji( $emoji ) );
diff --git a/tests/formatting/ent2ncr.php b/tests/formatting/ent2ncr.php
index f5859974ef..daf7f44b4d 100644
--- a/tests/formatting/ent2ncr.php
+++ b/tests/formatting/ent2ncr.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::ent2ncr
  */
 class Tests_Formatting_Ent2ncr extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/escAttr.php b/tests/formatting/escAttr.php
index e60c5e9552..879b86ed05 100644
--- a/tests/formatting/escAttr.php
+++ b/tests/formatting/escAttr.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::esc_attr
  */
 class Tests_Formatting_EscAttr extends WP_UnitTestCase {
 	public function test_esc_attr_quotes() {
diff --git a/tests/formatting/escHtml.php b/tests/formatting/escHtml.php
index 3c6b918cfc..bcd21043d7 100644
--- a/tests/formatting/escHtml.php
+++ b/tests/formatting/escHtml.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::esc_html
  */
 class Tests_Formatting_EscHtml extends WP_UnitTestCase {
 	public function test_esc_html_basics() {
diff --git a/tests/formatting/escJs.php b/tests/formatting/escJs.php
index ddb5420174..0f4365d1b3 100644
--- a/tests/formatting/escJs.php
+++ b/tests/formatting/escJs.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::esc_js
  */
 class Tests_Formatting_EscJs extends WP_UnitTestCase {
 	public function test_js_escape_simple() {
diff --git a/tests/formatting/escTextarea.php b/tests/formatting/escTextarea.php
index 8582216ec8..f53f5bd313 100644
--- a/tests/formatting/escTextarea.php
+++ b/tests/formatting/escTextarea.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::esc_textarea
  */
 class Tests_Formatting_EscTextarea extends WP_UnitTestCase {
 
diff --git a/tests/formatting/escUrl.php b/tests/formatting/escUrl.php
index 4958c115d3..9c830cb570 100644
--- a/tests/formatting/escUrl.php
+++ b/tests/formatting/escUrl.php
@@ -7,6 +7,8 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 23605
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_spaces() {
 		$this->assertSame( 'http://example.com/Mr%20WordPress', esc_url( 'http://example.com/Mr WordPress' ) );
@@ -19,6 +21,9 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 		$this->assertSame( 'http://example.com/?foo=one%20two%20three&#038;bar=four', esc_url( 'http://example.com/?foo=one%20two%20three&bar=four' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 */
 	public function test_bad_characters() {
 		$this->assertSame( 'http://example.com/watchthelinefeedgo', esc_url( 'http://example.com/watchthelinefeed%0Ago' ) );
 		$this->assertSame( 'http://example.com/watchthelinefeedgo', esc_url( 'http://example.com/watchthelinefeed%0ago' ) );
@@ -33,6 +38,9 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 		$this->assertSame( 'http://example.com/', esc_url( 'http://example.com/%0%0%0ADa' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 */
 	public function test_relative() {
 		$this->assertSame( '/example.php', esc_url( '/example.php' ) );
 		$this->assertSame( 'example.php', esc_url( 'example.php' ) );
@@ -40,6 +48,10 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 		$this->assertSame( '?foo=bar', esc_url( '?foo=bar' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 * @covers ::sanitize_url
+	 */
 	public function test_all_url_parts() {
 		$url = 'https://user:pass@host.example.com:1234/path;p=1?query=2&r[]=3#fragment';
 
@@ -56,10 +68,13 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 			),
 			parse_url( $url )
 		);
-		$this->assertSame( 'https://user:pass@host.example.com:1234/path;p=1?query=2&r%5B%5D=3#fragment', esc_url_raw( $url ) );
+		$this->assertSame( 'https://user:pass@host.example.com:1234/path;p=1?query=2&r%5B%5D=3#fragment', sanitize_url( $url ) );
 		$this->assertSame( 'https://user:pass@host.example.com:1234/path;p=1?query=2&#038;r%5B%5D=3#fragment', esc_url( $url ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 */
 	public function test_bare() {
 		$this->assertSame( 'http://example.com?foo', esc_url( 'example.com?foo' ) );
 		$this->assertSame( 'http://example.com', esc_url( 'example.com' ) );
@@ -68,10 +83,14 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 		$this->assertSame( 'http://баба.org/баба', esc_url( 'баба.org/баба' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 * @covers ::sanitize_url
+	 */
 	public function test_encoding() {
-		$this->assertSame( 'http://example.com?foo=1&bar=2', esc_url_raw( 'http://example.com?foo=1&bar=2' ) );
-		$this->assertSame( 'http://example.com?foo=1&amp;bar=2', esc_url_raw( 'http://example.com?foo=1&amp;bar=2' ) );
-		$this->assertSame( 'http://example.com?foo=1&#038;bar=2', esc_url_raw( 'http://example.com?foo=1&#038;bar=2' ) );
+		$this->assertSame( 'http://example.com?foo=1&bar=2', sanitize_url( 'http://example.com?foo=1&bar=2' ) );
+		$this->assertSame( 'http://example.com?foo=1&amp;bar=2', sanitize_url( 'http://example.com?foo=1&amp;bar=2' ) );
+		$this->assertSame( 'http://example.com?foo=1&#038;bar=2', sanitize_url( 'http://example.com?foo=1&#038;bar=2' ) );
 
 		$this->assertSame( 'http://example.com?foo=1&#038;bar=2', esc_url( 'http://example.com?foo=1&bar=2' ) );
 		$this->assertSame( 'http://example.com?foo=1&#038;bar=2', esc_url( 'http://example.com?foo=1&amp;bar=2' ) );
@@ -81,6 +100,10 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 		$this->assertSame( "http://example.com?url={$param}", esc_url( "http://example.com?url={$param}" ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 * @covers ::wp_allowed_protocols
+	 */
 	public function test_protocol() {
 		$this->assertSame( 'http://example.com', esc_url( 'http://example.com' ) );
 		$this->assertSame( '', esc_url( 'nasty://example.com/' ) );
@@ -145,23 +168,34 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 23187
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_protocol_case() {
 		$this->assertSame( 'http://example.com', esc_url( 'HTTP://example.com' ) );
 		$this->assertSame( 'http://example.com', esc_url( 'Http://example.com' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 */
 	public function test_display_extras() {
 		$this->assertSame( 'http://example.com/&#039;quoted&#039;', esc_url( 'http://example.com/\'quoted\'' ) );
 		$this->assertSame( 'http://example.com/\'quoted\'', esc_url( 'http://example.com/\'quoted\'', null, 'notdisplay' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 */
 	public function test_non_ascii() {
 		$this->assertSame( 'http://example.org/баба', esc_url( 'http://example.org/баба' ) );
 		$this->assertSame( 'http://баба.org/баба', esc_url( 'http://баба.org/баба' ) );
 		$this->assertSame( 'http://müller.com/', esc_url( 'http://müller.com/' ) );
 	}
 
+	/**
+	 * @covers ::esc_url
+	 */
 	public function test_feed() {
 		$this->assertSame( '', esc_url( 'feed:javascript:alert(1)' ) );
 		$this->assertSame( '', esc_url( 'feed:javascript:feed:alert(1)' ) );
@@ -172,6 +206,8 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 16859
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_square_brackets() {
 		$this->assertSame( '/example.php?one%5B%5D=two', esc_url( '/example.php?one[]=two' ) );
@@ -187,14 +223,18 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 
 	/**
 	 * Courtesy of http://blog.lunatech.com/2009/02/03/what-every-web-developer-must-know-about-url-encoding
+	 *
+	 * @covers ::sanitize_url
 	 */
 	public function test_reserved_characters() {
 		$url = "http://example.com/:@-._~!$&'()*+,=;:@-._~!$&'()*+,=:@-._~!$&'()*+,==?/?:@-._~!$%27()*+,;=/?:@-._~!$%27()*+,;==#/?:@-._~!$&'()*+,;=";
-		$this->assertSame( $url, esc_url_raw( $url ) );
+		$this->assertSame( $url, sanitize_url( $url ) );
 	}
 
 	/**
 	 * @ticket 21974
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_protocol_relative_with_colon() {
 		$this->assertSame( '//example.com/foo?foo=abc:def', esc_url( '//example.com/foo?foo=abc:def' ) );
@@ -202,6 +242,8 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 31632
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_mailto_with_newline() {
 		$body       = <<<EOT
@@ -217,6 +259,8 @@ EOT;
 
 	/**
 	 * @ticket 31632
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_mailto_in_http_url_with_newline() {
 		$body       = <<<EOT
@@ -232,6 +276,8 @@ EOT;
 
 	/**
 	 * @ticket 23605
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_mailto_with_spaces() {
 		$body = 'Hi there, I thought you might want to sign up for this newsletter';
@@ -243,13 +289,17 @@ EOT;
 
 	/**
 	 * @ticket 28015
+	 *
+	 * @covers ::sanitize_url
 	 */
 	public function test_invalid_charaters() {
-		$this->assertEmpty( esc_url_raw( '"^<>{}`' ) );
+		$this->assertEmpty( sanitize_url( '"^<>{}`' ) );
 	}
 
 	/**
 	 * @ticket 34202
+	 *
+	 * @covers ::esc_url
 	 */
 	public function test_ipv6_hosts() {
 		$this->assertSame( '//[::127.0.0.1]', esc_url( '//[::127.0.0.1]' ) );
diff --git a/tests/formatting/escXml.php b/tests/formatting/escXml.php
index fa6738dca0..bce29da9df 100644
--- a/tests/formatting/escXml.php
+++ b/tests/formatting/escXml.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::esc_xml
  */
 class Tests_Formatting_EscXml extends WP_UnitTestCase {
 	/**
@@ -42,6 +44,11 @@ class Tests_Formatting_EscXml extends WP_UnitTestCase {
 				"SELECT meta_key, meta_value FROM wp_trunk_sitemeta WHERE meta_key IN ('site_name', 'siteurl', 'active_sitewide_plugins', '_site_transient_timeout_theme_roots', '_site_transient_theme_roots', 'site_admins', 'can_compress_scripts', 'global_terms_enabled') AND site_id = 1",
 				'SELECT meta_key, meta_value FROM wp_trunk_sitemeta WHERE meta_key IN (&apos;site_name&apos;, &apos;siteurl&apos;, &apos;active_sitewide_plugins&apos;, &apos;_site_transient_timeout_theme_roots&apos;, &apos;_site_transient_theme_roots&apos;, &apos;site_admins&apos;, &apos;can_compress_scripts&apos;, &apos;global_terms_enabled&apos;) AND site_id = 1',
 			),
+			// Zero string.
+			array(
+				'0',
+				'0',
+			),
 		);
 	}
 
diff --git a/tests/formatting/excerptRemoveBlocks.php b/tests/formatting/excerptRemoveBlocks.php
index 5657047556..20d08ee8bf 100644
--- a/tests/formatting/excerptRemoveBlocks.php
+++ b/tests/formatting/excerptRemoveBlocks.php
@@ -2,7 +2,6 @@
 
 /**
  * @group formatting
- * @covers ::excerpt_remove_blocks
  * @ticket 46133
  */
 class Tests_Formatting_ExcerptRemoveBlocks extends WP_UnitTestCase {
@@ -61,7 +60,7 @@ class Tests_Formatting_ExcerptRemoveBlocks extends WP_UnitTestCase {
 	 */
 	public function set_up() {
 		parent::set_up();
-		self::$post_id = $this->factory()->post->create(
+		self::$post_id = self::factory()->post->create(
 			array(
 				'post_excerpt' => '', // Empty excerpt, so it has to be generated.
 				'post_content' => '<!-- wp:core/fake /-->',
@@ -91,6 +90,8 @@ class Tests_Formatting_ExcerptRemoveBlocks extends WP_UnitTestCase {
 	 * Tests excerpt_remove_blocks().
 	 *
 	 * @ticket 46133
+	 *
+	 * @covers ::excerpt_remove_blocks
 	 */
 	public function test_excerpt_remove_blocks() {
 		// Simple dynamic block..
@@ -116,6 +117,8 @@ class Tests_Formatting_ExcerptRemoveBlocks extends WP_UnitTestCase {
 	 * `the_content` gets applied, just like shortcodes.
 	 *
 	 * @ticket 46133
+	 *
+	 * @covers ::do_blocks
 	 */
 	public function test_excerpt_infinite_loop() {
 		$query = new WP_Query(
diff --git a/tests/formatting/getBloginfo.php b/tests/formatting/getBloginfo.php
index 2c80cd99b8..2b08f9edc2 100644
--- a/tests/formatting/getBloginfo.php
+++ b/tests/formatting/getBloginfo.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::get_bloginfo
  */
 class Tests_Formatting_GetBloginfo extends WP_UnitTestCase {
 
@@ -35,6 +37,7 @@ class Tests_Formatting_GetBloginfo extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 27942
+	 * @covers ::sanitize_option
 	 */
 	public function test_bloginfo_sanitize_option() {
 		$old_values = array(
diff --git a/tests/formatting/getUrlInContent.php b/tests/formatting/getUrlInContent.php
index 242fe2db9c..dd79769998 100644
--- a/tests/formatting/getUrlInContent.php
+++ b/tests/formatting/getUrlInContent.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::get_url_in_content
  */
 class Tests_Formatting_GetUrlInContent extends WP_UnitTestCase {
 
diff --git a/tests/formatting/humanTimeDiff.php b/tests/formatting/humanTimeDiff.php
index f4eb2e2ad6..829487c370 100644
--- a/tests/formatting/humanTimeDiff.php
+++ b/tests/formatting/humanTimeDiff.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @ticket 38773
+ *
+ * @covers ::human_time_diff
  */
 class Tests_Formatting_HumanTimeDiff extends WP_UnitTestCase {
 
diff --git a/tests/formatting/isEmail.php b/tests/formatting/isEmail.php
index eea7b61926..c3f0a7c45b 100644
--- a/tests/formatting/isEmail.php
+++ b/tests/formatting/isEmail.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::is_email
  */
 class Tests_Formatting_IsEmail extends WP_UnitTestCase {
 	public function test_returns_the_email_address_if_it_is_valid() {
diff --git a/tests/formatting/likeEscape.php b/tests/formatting/likeEscape.php
index d24f4e6675..4902056730 100644
--- a/tests/formatting/likeEscape.php
+++ b/tests/formatting/likeEscape.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::like_escape
  */
 class Tests_Formatting_LikeEscape extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/linksAddTarget.php b/tests/formatting/linksAddTarget.php
index ce8e506440..2bf582824f 100644
--- a/tests/formatting/linksAddTarget.php
+++ b/tests/formatting/linksAddTarget.php
@@ -1,6 +1,8 @@
 <?php
 /**
  * @group formatting
+ *
+ * @covers ::links_add_target
  */
 class Tests_Formatting_LinksAddTarget extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/makeClickable.php b/tests/formatting/makeClickable.php
index a0db986076..18dbe2da0c 100644
--- a/tests/formatting/makeClickable.php
+++ b/tests/formatting/makeClickable.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::make_clickable
  */
 class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 	public function test_mailto_xss() {
diff --git a/tests/formatting/mapDeep.php b/tests/formatting/mapDeep.php
index 0a291c9769..c309805c27 100644
--- a/tests/formatting/mapDeep.php
+++ b/tests/formatting/mapDeep.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @ticket 22300
+ *
+ * @covers ::map_deep
  */
 class Tests_Formatting_MapDeep extends WP_UnitTestCase {
 
diff --git a/tests/formatting/normalizeWhitespace.php b/tests/formatting/normalizeWhitespace.php
index 2e7668698a..cdb9a0062d 100644
--- a/tests/formatting/normalizeWhitespace.php
+++ b/tests/formatting/normalizeWhitespace.php
@@ -1,6 +1,8 @@
 <?php
 /**
  * @group formatting
+ *
+ * @covers ::normalize_whitespace
  */
 class Tests_Formatting_NormalizeWhitespace extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/redirect.php b/tests/formatting/redirect.php
index e1004493bd..213ba36bf5 100644
--- a/tests/formatting/redirect.php
+++ b/tests/formatting/redirect.php
@@ -20,6 +20,8 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 	 *
 	 * @dataProvider get_bad_status_codes
 	 *
+	 * @covers ::wp_redirect
+	 *
 	 * @param string $location The path or URL to redirect to.
 	 * @param int    $status   HTTP response status code to use.
 	 */
@@ -41,6 +43,9 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @covers ::wp_sanitize_redirect
+	 */
 	public function test_wp_sanitize_redirect() {
 		$this->assertSame( 'http://example.com/watchthelinefeedgo', wp_sanitize_redirect( 'http://example.com/watchthelinefeed%0Ago' ) );
 		$this->assertSame( 'http://example.com/watchthelinefeedgo', wp_sanitize_redirect( 'http://example.com/watchthelinefeed%0ago' ) );
@@ -59,6 +64,8 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36998
+	 *
+	 * @covers ::wp_sanitize_redirect
 	 */
 	public function test_wp_sanitize_redirect_should_encode_spaces() {
 		$this->assertSame( 'http://example.com/test%20spaces', wp_sanitize_redirect( 'http://example.com/test%20spaces' ) );
@@ -67,6 +74,8 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider valid_url_provider
+	 *
+	 * @covers ::wp_validate_redirect
 	 */
 	public function test_wp_validate_redirect_valid_url( $url, $expected ) {
 		$this->assertSame( $expected, wp_validate_redirect( $url ) );
@@ -74,6 +83,8 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider invalid_url_provider
+	 *
+	 * @covers ::wp_validate_redirect
 	 */
 	public function test_wp_validate_redirect_invalid_url( $url ) {
 		$this->assertEquals( false, wp_validate_redirect( $url, false ) );
@@ -166,6 +177,8 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 	/**
 	 * @ticket 47980
 	 * @dataProvider relative_url_provider
+	 *
+	 * @covers ::wp_validate_redirect
 	 */
 	public function test_wp_validate_redirect_relative_url( $current_uri, $url, $expected ) {
 		// Backup the global.
diff --git a/tests/formatting/removeAccents.php b/tests/formatting/removeAccents.php
index 19fd50586b..8140d2df9b 100644
--- a/tests/formatting/removeAccents.php
+++ b/tests/formatting/removeAccents.php
@@ -2,12 +2,33 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::remove_accents
  */
 class Tests_Formatting_RemoveAccents extends WP_UnitTestCase {
+
 	public function test_remove_accents_simple() {
 		$this->assertSame( 'abcdefghijkl', remove_accents( 'abcdefghijkl' ) );
 	}
 
+	/**
+	 * @ticket 24661
+	 *
+	 * Tests Unicode sequence normalization from NFD (Normalization Form Decomposed)
+	 * to NFC (Normalization Form [Pre]Composed), the encoding used in `remove_accents()`.
+	 *
+	 * For more information on Unicode normalization, see
+	 * https://unicode.org/faq/normalization.html.
+	 *
+	 * @requires extension intl
+	 */
+	public function test_remove_accents_latin1_supplement_nfd_encoding() {
+		$input  = 'ªºÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûüýþÿ';
+		$output = 'aoAAAAAAAECEEEEIIIIDNOOOOOOUUUUYTHsaaaaaaaeceeeeiiiidnoooooouuuuythy';
+
+		$this->assertSame( $output, remove_accents( $input ), 'remove_accents replaces Latin-1 Supplement with NFD encoding' );
+	}
+
 	/**
 	 * @ticket 9591
 	 */
@@ -80,67 +101,33 @@ class Tests_Formatting_RemoveAccents extends WP_UnitTestCase {
 		$this->assertSame( 'aaeiouuAEIOUU', remove_accents( 'aɑeiouüAEIOUÜ' ) );
 	}
 
-	public function remove_accents_germanic_umlauts_cb() {
-		return 'de_DE';
-	}
-
 	/**
 	 * @ticket 3782
 	 */
 	public function test_remove_accents_germanic_umlauts() {
-		add_filter( 'locale', array( $this, 'remove_accents_germanic_umlauts_cb' ) );
-
-		$this->assertSame( 'AeOeUeaeoeuess', remove_accents( 'ÄÖÜäöüß' ) );
-
-		remove_filter( 'locale', array( $this, 'remove_accents_germanic_umlauts_cb' ) );
-	}
-
-	public function set_locale_to_danish() {
-		return 'da_DK';
+		$this->assertSame( 'AeOeUeaeoeuess', remove_accents( 'ÄÖÜäöüß', 'de_DE' ) );
 	}
 
 	/**
 	 * @ticket 23907
 	 */
 	public function test_remove_danish_accents() {
-		add_filter( 'locale', array( $this, 'set_locale_to_danish' ) );
-
-		$this->assertSame( 'AeOeAaaeoeaa', remove_accents( 'ÆØÅæøå' ) );
-
-		remove_filter( 'locale', array( $this, 'set_locale_to_danish' ) );
-	}
-
-	public function set_locale_to_catalan() {
-		return 'ca';
+		$this->assertSame( 'AeOeAaaeoeaa', remove_accents( 'ÆØÅæøå', 'da_DK' ) );
 	}
 
 	/**
 	 * @ticket 37086
 	 */
 	public function test_remove_catalan_middot() {
-		add_filter( 'locale', array( $this, 'set_locale_to_catalan' ) );
-
-		$this->assertSame( 'allallalla', remove_accents( 'al·lallaŀla' ) );
-
-		remove_filter( 'locale', array( $this, 'set_locale_to_catalan' ) );
-
+		$this->assertSame( 'allallalla', remove_accents( 'al·lallaŀla', 'ca' ) );
 		$this->assertSame( 'al·lallalla', remove_accents( 'al·lallaŀla' ) );
 	}
 
-	public function set_locale_to_serbian() {
-		return 'sr_RS';
-	}
-
 	/**
 	 * @ticket 38078
 	 */
 	public function test_transcribe_serbian_crossed_d() {
-		add_filter( 'locale', array( $this, 'set_locale_to_serbian' ) );
-
-		$this->assertSame( 'DJdj', remove_accents( 'Đđ' ) );
-
-		remove_filter( 'locale', array( $this, 'set_locale_to_serbian' ) );
-
+		$this->assertSame( 'DJdj', remove_accents( 'Đđ', 'sr_RS' ) );
 		$this->assertSame( 'Dd', remove_accents( 'Đđ' ) );
 	}
 }
diff --git a/tests/formatting/sanitizeFileName.php b/tests/formatting/sanitizeFileName.php
index fbec256219..06c2f10976 100644
--- a/tests/formatting/sanitizeFileName.php
+++ b/tests/formatting/sanitizeFileName.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_file_name
  */
 class Tests_Formatting_SanitizeFileName extends WP_UnitTestCase {
 	public function test_munges_extensions() {
diff --git a/tests/formatting/sanitizeKey.php b/tests/formatting/sanitizeKey.php
index 7dea43e004..0fb5d905df 100644
--- a/tests/formatting/sanitizeKey.php
+++ b/tests/formatting/sanitizeKey.php
@@ -7,38 +7,27 @@
 class Tests_Formatting_SanitizeKey extends WP_UnitTestCase {
 
 	/**
-	 * @ticket 54160
+	 * @ticket       54160
 	 * @dataProvider data_sanitize_key
 	 *
-	 * @param mixed $key       The key to sanitize.
-	 * @param mixed $expected  The expected value.
+	 * @param string $key      The key to sanitize.
+	 * @param string $expected The expected value.
 	 */
 	public function test_sanitize_key( $key, $expected ) {
 		$this->assertSame( $expected, sanitize_key( $key ) );
 	}
 
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
 	public function data_sanitize_key() {
 		return array(
 			'an empty string key'            => array(
 				'key'      => '',
 				'expected' => '',
 			),
-			'a null key'                     => array(
-				'key'      => null,
-				'expected' => '',
-			),
-			'an int 0 key'                   => array(
-				'key'      => 0,
-				'expected' => '',
-			),
-			'a true key'                     => array(
-				'key'      => true,
-				'expected' => '',
-			),
-			'an array key'                   => array(
-				'key'      => array( 'Howdy, admin!' ),
-				'expected' => '',
-			),
 			'a lowercase key with commas'    => array(
 				'key'      => 'howdy,admin',
 				'expected' => 'howdyadmin',
@@ -71,20 +60,81 @@ class Tests_Formatting_SanitizeKey extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @ticket 54160
+	 * @ticket       54160
+	 * @dataProvider data_sanitize_key_nonstring_scalar
 	 *
-	 * @covers WP_Hook::sanitize_key
+	 * @param mixed  $key      The key to sanitize.
+	 * @param string $expected The expected value.
 	 */
-	public function test_filter_sanitize_key() {
-		$key = 'Howdy, admin!';
+	public function test_sanitize_key_nonstring_scalar( $key, $expected ) {
+		$this->assertSame( $expected, sanitize_key( $key ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_sanitize_key_nonstring_scalar() {
+		return array(
+			'integer type'  => array(
+				'key'      => 0,
+				'expected' => '0',
+			),
+			'boolean true'  => array(
+				'key'      => true,
+				'expected' => '1',
+			),
+			'boolean false' => array(
+				'key'      => false,
+				'expected' => '',
+			),
+			'float type'    => array(
+				'key'      => 0.123,
+				'expected' => '0123',
+			),
+		);
+	}
 
+	/**
+	 * @ticket       54160
+	 * @dataProvider data_sanitize_key_with_non_scalars
+	 *
+	 * @param mixed $nonscalar_key A non-scalar data type given as a key.
+	 */
+	public function test_sanitize_key_with_non_scalars( $nonscalar_key ) {
 		add_filter(
 			'sanitize_key',
-			static function( $key ) {
-				return 'Howdy, admin!';
-			}
+			function ( $sanitized_key, $key ) use ( $nonscalar_key ) {
+				$this->assertEmpty( $sanitized_key, 'Empty string not passed as first filtered argument' );
+				$this->assertSame( $nonscalar_key, $key, 'Given unsanitized key not passed as second filtered argument' );
+				return $sanitized_key;
+			},
+			10,
+			2
 		);
+		$this->assertEmpty( sanitize_key( $nonscalar_key ), 'Non-scalar key did not return empty string' );
+	}
 
-		$this->assertSame( $key, sanitize_key( $key ) );
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_sanitize_key_with_non_scalars() {
+		return array(
+			'array type' => array(
+				'key'      => array( 'key' ),
+				'expected' => '',
+			),
+			'null'       => array(
+				'key'      => null,
+				'expected' => '',
+			),
+			'object'     => array(
+				'key'      => new stdClass(),
+				'expected' => '',
+			),
+		);
 	}
 }
diff --git a/tests/formatting/sanitizeMimeType.php b/tests/formatting/sanitizeMimeType.php
index 77c8b47205..6d486159a6 100644
--- a/tests/formatting/sanitizeMimeType.php
+++ b/tests/formatting/sanitizeMimeType.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_mime_type
  */
 class Tests_Formatting_SanitizeMimeType extends WP_UnitTestCase {
 
diff --git a/tests/formatting/sanitizeOrderby.php b/tests/formatting/sanitizeOrderby.php
index cede007886..8384f8a4b2 100644
--- a/tests/formatting/sanitizeOrderby.php
+++ b/tests/formatting/sanitizeOrderby.php
@@ -2,11 +2,12 @@
 
 /**
  * @group sanitize_sql_orderby
+ *
+ * @covers ::sanitize_sql_orderby
  */
 class Tests_Formatting_SanitizeOrderby extends WP_UnitTestCase {
 
 	/**
-	 * @covers ::sanitize_sql_orderby
 	 * @dataProvider valid_orderbys
 	 */
 	public function test_valid( $orderby ) {
@@ -33,7 +34,6 @@ class Tests_Formatting_SanitizeOrderby extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @covers ::sanitize_sql_orderby
 	 * @dataProvider invalid_orderbys
 	 */
 	public function test_invalid( $orderby ) {
diff --git a/tests/formatting/sanitizePost.php b/tests/formatting/sanitizePost.php
index 1e69e703c1..642265ba95 100644
--- a/tests/formatting/sanitizePost.php
+++ b/tests/formatting/sanitizePost.php
@@ -2,6 +2,8 @@
 /**
  * @group formatting
  * @group post
+ *
+ * @covers WP_Post::__construct
  */
 class Tests_Formatting_SanitizePost extends WP_UnitTestCase {
 
diff --git a/tests/formatting/sanitizeTextField.php b/tests/formatting/sanitizeTextField.php
index 8d5d0ff0dd..15e903ac95 100644
--- a/tests/formatting/sanitizeTextField.php
+++ b/tests/formatting/sanitizeTextField.php
@@ -2,6 +2,9 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_text_field
+ * @covers ::sanitize_textarea_field
  */
 class Tests_Formatting_SanitizeTextField extends WP_UnitTestCase {
 	public function data_sanitize_text_field() {
diff --git a/tests/formatting/sanitizeTitle.php b/tests/formatting/sanitizeTitle.php
index 7ce850f0fc..faecb8c2c9 100644
--- a/tests/formatting/sanitizeTitle.php
+++ b/tests/formatting/sanitizeTitle.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_title
  */
 class Tests_Formatting_SanitizeTitle extends WP_UnitTestCase {
 	public function test_strips_html() {
diff --git a/tests/formatting/sanitizeTitleWithDashes.php b/tests/formatting/sanitizeTitleWithDashes.php
index 797a36f018..0fc199013a 100644
--- a/tests/formatting/sanitizeTitleWithDashes.php
+++ b/tests/formatting/sanitizeTitleWithDashes.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_title_with_dashes
  */
 class Tests_Formatting_SanitizeTitleWithDashes extends WP_UnitTestCase {
 	public function test_strips_html() {
diff --git a/tests/formatting/sanitizeTrackbackUrls.php b/tests/formatting/sanitizeTrackbackUrls.php
index 8337a2a662..9e9c096a76 100644
--- a/tests/formatting/sanitizeTrackbackUrls.php
+++ b/tests/formatting/sanitizeTrackbackUrls.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_trackback_urls
  */
 class Tests_Formatting_SanitizeTrackbackUrls extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/sanitizeUser.php b/tests/formatting/sanitizeUser.php
index e0ae998f5e..1f1cadd884 100644
--- a/tests/formatting/sanitizeUser.php
+++ b/tests/formatting/sanitizeUser.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::sanitize_user
  */
 class Tests_Formatting_SanitizeUser extends WP_UnitTestCase {
 	public function test_strips_html() {
diff --git a/tests/formatting/seemsUtf8.php b/tests/formatting/seemsUtf8.php
index a5a6157fd2..5e9bb8e8a1 100644
--- a/tests/formatting/seemsUtf8.php
+++ b/tests/formatting/seemsUtf8.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::seems_utf8
  */
 class Tests_Formatting_SeemsUtf8 extends WP_UnitTestCase {
 
diff --git a/tests/formatting/slashit.php b/tests/formatting/slashit.php
index 9c32aa2c64..903cf9f65f 100644
--- a/tests/formatting/slashit.php
+++ b/tests/formatting/slashit.php
@@ -4,18 +4,31 @@
  * @group formatting
  */
 class Tests_Formatting_Slashit extends WP_UnitTestCase {
+
+	/**
+	 * @covers ::backslashit
+	 */
 	public function test_backslashes_middle_numbers() {
 		$this->assertSame( "\\a-!9\\a943\\b\\c", backslashit( 'a-!9a943bc' ) );
 	}
 
+	/**
+	 * @covers ::backslashit
+	 */
 	public function test_backslashes_alphas() {
 		$this->assertSame( "\\a943\\b\\c", backslashit( 'a943bc' ) );
 	}
 
+	/**
+	 * @covers ::backslashit
+	 */
 	public function test_double_backslashes_leading_numbers() {
 		$this->assertSame( '\\\\95', backslashit( '95' ) );
 	}
 
+	/**
+	 * @covers ::untrailingslashit
+	 */
 	public function test_removes_trailing_slashes() {
 		$this->assertSame( 'a', untrailingslashit( 'a/' ) );
 		$this->assertSame( 'a', untrailingslashit( 'a////' ) );
@@ -23,6 +36,8 @@ class Tests_Formatting_Slashit extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22267
+	 *
+	 * @covers ::untrailingslashit
 	 */
 	public function test_removes_trailing_backslashes() {
 		$this->assertSame( 'a', untrailingslashit( 'a\\' ) );
@@ -31,22 +46,32 @@ class Tests_Formatting_Slashit extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22267
+	 *
+	 * @covers ::untrailingslashit
 	 */
 	public function test_removes_trailing_mixed_slashes() {
 		$this->assertSame( 'a', untrailingslashit( 'a/\\' ) );
 		$this->assertSame( 'a', untrailingslashit( 'a\\/\\///\\\\//' ) );
 	}
 
+	/**
+	 * @covers ::trailingslashit
+	 */
 	public function test_adds_trailing_slash() {
 		$this->assertSame( 'a/', trailingslashit( 'a' ) );
 	}
 
+	/**
+	 * @covers ::trailingslashit
+	 */
 	public function test_does_not_add_trailing_slash_if_one_exists() {
 		$this->assertSame( 'a/', trailingslashit( 'a/' ) );
 	}
 
 	/**
 	 * @ticket 22267
+	 *
+	 * @covers ::trailingslashit
 	 */
 	public function test_converts_trailing_backslash_to_slash_if_one_exists() {
 		$this->assertSame( 'a/', trailingslashit( 'a\\' ) );
diff --git a/tests/formatting/stripslashesDeep.php b/tests/formatting/stripslashesDeep.php
index c5ce91b44b..76f9e8b019 100644
--- a/tests/formatting/stripslashesDeep.php
+++ b/tests/formatting/stripslashesDeep.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @group slashes
+ *
+ * @covers ::stripslashes_deep
  */
 class Tests_Formatting_StripslashesDeep extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/urlShorten.php b/tests/formatting/urlShorten.php
index 5900e358e9..4909130dbc 100644
--- a/tests/formatting/urlShorten.php
+++ b/tests/formatting/urlShorten.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::url_shorten
  */
 class Tests_Formatting_UrlShorten extends WP_UnitTestCase {
 	public function test_url_shorten() {
diff --git a/tests/formatting/urlencodeDeep.php b/tests/formatting/urlencodeDeep.php
index 27c0c750bb..a3b461a6ae 100644
--- a/tests/formatting/urlencodeDeep.php
+++ b/tests/formatting/urlencodeDeep.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @ticket 22300
+ *
+ * @covers ::urlencode_deep
  */
 class Tests_Formatting_UrlencodeDeep extends WP_UnitTestCase {
 
diff --git a/tests/formatting/utf8UriEncode.php b/tests/formatting/utf8UriEncode.php
index 310b906104..e82e973e29 100644
--- a/tests/formatting/utf8UriEncode.php
+++ b/tests/formatting/utf8UriEncode.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::utf8_uri_encode
  */
 class Tests_Formatting_Utf8UriEncode extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpAutop.php b/tests/formatting/wpAutop.php
index 35567e8742..315a0c9794 100644
--- a/tests/formatting/wpAutop.php
+++ b/tests/formatting/wpAutop.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wpautop
  */
 class Tests_Formatting_wpAutop extends WP_UnitTestCase {
 
@@ -531,7 +533,7 @@ line 2<br/>
 	/**
 	 * @ticket 4857
 	 */
-	public function test_that_text_before_blocks_is_peed() {
+	public function test_that_text_before_blocks_is_wrapped_in_a_paragraph() {
 		$content  = 'a<div>b</div>';
 		$expected = "<p>a</p>\n<div>b</div>";
 
@@ -541,9 +543,6 @@ line 2<br/>
 	/**
 	 * wpautop() should not add extra </p> before <figcaption>
 	 *
-	 * @covers ::wpautop
-	 * @uses ::trim
-	 *
 	 * @ticket 39307
 	 */
 	public function test_that_wpautop_does_not_add_extra_closing_p_in_figure() {
@@ -565,7 +564,7 @@ line 2<br/>
 	/**
 	 * @ticket 14674
 	 */
-	public function test_the_hr_is_not_peed() {
+	public function test_the_hr_is_not_wrapped_in_a_paragraph() {
 		$content  = 'paragraph1<hr>paragraph2';
 		$expected = "<p>paragraph1</p>\n<hr>\n<p>paragraph2</p>";
 
diff --git a/tests/formatting/wpBasename.php b/tests/formatting/wpBasename.php
index 6bb7d5684b..57a00d872f 100644
--- a/tests/formatting/wpBasename.php
+++ b/tests/formatting/wpBasename.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+
+ * @covers ::wp_basename
  */
 class Tests_Formatting_wpBasename extends WP_UnitTestCase {
 
@@ -38,5 +40,4 @@ class Tests_Formatting_wpBasename extends WP_UnitTestCase {
 			wp_basename( 'C:\test\щипцы.txt' )
 		);
 	}
-
 }
diff --git a/tests/formatting/wpHtmlExcerpt.php b/tests/formatting/wpHtmlExcerpt.php
index 3aff259343..96cd58226d 100644
--- a/tests/formatting/wpHtmlExcerpt.php
+++ b/tests/formatting/wpHtmlExcerpt.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_html_excerpt
  */
 class Tests_Formatting_wpHtmlExcerpt extends WP_UnitTestCase {
 	public function test_simple() {
diff --git a/tests/formatting/wpHtmlSplit.php b/tests/formatting/wpHtmlSplit.php
index befe43abb8..a174c43d00 100644
--- a/tests/formatting/wpHtmlSplit.php
+++ b/tests/formatting/wpHtmlSplit.php
@@ -9,6 +9,8 @@ class Tests_Formatting_wpHtmlSplit extends WP_UnitTestCase {
 	 * Basic functionality goes here.
 	 *
 	 * @dataProvider data_basic_features
+	 *
+	 * @covers ::wp_html_split
 	 */
 	public function test_basic_features( $input, $output ) {
 		return $this->assertSame( $output, wp_html_split( $input ) );
@@ -39,6 +41,8 @@ class Tests_Formatting_wpHtmlSplit extends WP_UnitTestCase {
 	 * Automated performance testing of the main regex.
 	 *
 	 * @dataProvider data_whole_posts
+	 *
+	 * @covers ::get_html_split_regex
 	 */
 	public function test_pcre_performance( $input ) {
 		$regex  = get_html_split_regex();
diff --git a/tests/formatting/wpHtmleditPre.php b/tests/formatting/wpHtmleditPre.php
index 109ea4bdf2..f9eb7dcc3c 100644
--- a/tests/formatting/wpHtmleditPre.php
+++ b/tests/formatting/wpHtmleditPre.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @expectedDeprecated wp_htmledit_pre
+ *
+ * @covers ::wp_htmledit_pre
  */
 class Tests_Formatting_wpHtmleditPre extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpIsoDescrambler.php b/tests/formatting/wpIsoDescrambler.php
index a15cabc4d2..643ebcc836 100644
--- a/tests/formatting/wpIsoDescrambler.php
+++ b/tests/formatting/wpIsoDescrambler.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_iso_descrambler
  */
 class Tests_Formatting_wpIsoDescrambler extends WP_UnitTestCase {
 	/*
diff --git a/tests/formatting/wpMakeLinkRelative.php b/tests/formatting/wpMakeLinkRelative.php
index ee3f78e9a2..0b293c9c89 100644
--- a/tests/formatting/wpMakeLinkRelative.php
+++ b/tests/formatting/wpMakeLinkRelative.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_make_link_relative
  */
 class Tests_Formatting_wpMakeLinkRelative extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpRelNofollow.php b/tests/formatting/wpRelNofollow.php
index d10898d7ea..0b45d22e15 100644
--- a/tests/formatting/wpRelNofollow.php
+++ b/tests/formatting/wpRelNofollow.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_rel_nofollow
  */
 class Tests_Formatting_wpRelNofollow extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpRelUgc.php b/tests/formatting/wpRelUgc.php
index cbd052c71e..4b8b11dafa 100644
--- a/tests/formatting/wpRelUgc.php
+++ b/tests/formatting/wpRelUgc.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_rel_ugc
  */
 class Tests_Formatting_wpRelUgc extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpReplaceInHtmlTags.php b/tests/formatting/wpReplaceInHtmlTags.php
index 9781dfbc1b..b16fd5e7f1 100644
--- a/tests/formatting/wpReplaceInHtmlTags.php
+++ b/tests/formatting/wpReplaceInHtmlTags.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_replace_in_html_tags
  */
 class Tests_Formatting_wpReplaceInHtmlTags extends WP_UnitTestCase {
 	/**
diff --git a/tests/formatting/wpRicheditPre.php b/tests/formatting/wpRicheditPre.php
index be12ddd55f..04f85c6255 100644
--- a/tests/formatting/wpRicheditPre.php
+++ b/tests/formatting/wpRicheditPre.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @expectedDeprecated wp_richedit_pre
+ *
+ * @covers ::wp_richedit_pre
  */
 class Tests_Formatting_wpRicheditPre extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpSlash.php b/tests/formatting/wpSlash.php
index 0431b7602d..39a7c32a01 100644
--- a/tests/formatting/wpSlash.php
+++ b/tests/formatting/wpSlash.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_slash
  */
 class Tests_Formatting_wpSlash extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpSpecialchars.php b/tests/formatting/wpSpecialchars.php
index 07fc2b1ad0..890fb99c94 100644
--- a/tests/formatting/wpSpecialchars.php
+++ b/tests/formatting/wpSpecialchars.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::_wp_specialchars
  */
 class Tests_Formatting_wpSpecialchars extends WP_UnitTestCase {
 	public function test_wp_specialchars_basics() {
diff --git a/tests/formatting/wpStripAllTags.php b/tests/formatting/wpStripAllTags.php
index 1ecc12bda4..2ef332e62e 100644
--- a/tests/formatting/wpStripAllTags.php
+++ b/tests/formatting/wpStripAllTags.php
@@ -3,6 +3,8 @@
  * Test wp_strip_all_tags()
  *
  * @group formatting
+ *
+ * @covers ::wp_strip_all_tags
  */
 class Tests_Formatting_wpStripAllTags extends WP_UnitTestCase {
 
diff --git a/tests/formatting/wpTargetedLinkRel.php b/tests/formatting/wpTargetedLinkRel.php
index b58f4188b5..75a247e212 100644
--- a/tests/formatting/wpTargetedLinkRel.php
+++ b/tests/formatting/wpTargetedLinkRel.php
@@ -3,6 +3,8 @@
 /**
  * @group formatting
  * @ticket 43187
+ *
+ * @covers ::wp_targeted_link_rel
  */
 class Tests_Formatting_wpTargetedLinkRel extends WP_UnitTestCase {
 
@@ -87,7 +89,7 @@ class Tests_Formatting_wpTargetedLinkRel extends WP_UnitTestCase {
 		$content  = '<p>Links: <a href="/" target="_blank">No rel</a></p>';
 		$expected = '<p>Links: <a href="/" target="_blank" rel="noopener">No rel</a></p>';
 
-		$post = $this->factory()->post->create_and_get(
+		$post = self::factory()->post->create_and_get(
 			array(
 				'post_content' => $content,
 			)
diff --git a/tests/formatting/wpTexturize.php b/tests/formatting/wpTexturize.php
index 8ac9bb3784..0650c78181 100644
--- a/tests/formatting/wpTexturize.php
+++ b/tests/formatting/wpTexturize.php
@@ -4,11 +4,18 @@
  * @group formatting
  */
 class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
+
+	/**
+	 * @covers ::wptexturize
+	 */
 	public function test_dashes() {
 		$this->assertSame( 'Hey &#8212; boo?', wptexturize( 'Hey -- boo?' ) );
 		$this->assertSame( '<a href="http://xx--xx">Hey &#8212; boo?</a>', wptexturize( '<a href="http://xx--xx">Hey -- boo?</a>' ) );
 	}
 
+	/**
+	 * @covers ::wptexturize
+	 */
 	public function test_disable() {
 		$this->assertSame( '<pre>---&</pre>', wptexturize( '<pre>---&</pre>' ) );
 		$this->assertSame( '<pre><code></code>--&</pre>', wptexturize( '<pre><code></code>--&</pre>' ) );
@@ -34,6 +41,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 1418
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_bracketed_quotes_1418() {
 		$this->assertSame( '(&#8220;test&#8221;)', wptexturize( '("test")' ) );
@@ -43,6 +52,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 3810
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_bracketed_quotes_3810() {
 		$this->assertSame( 'A dog (&#8220;Hubertus&#8221;) was sent out.', wptexturize( 'A dog ("Hubertus") was sent out.' ) );
@@ -50,6 +61,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 4539
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_basic_quotes() {
 		$this->assertSame( 'test&#8217;s', wptexturize( 'test\'s' ) );
@@ -73,6 +86,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	/**
 	 * @ticket 4539
 	 * @ticket 15241
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_full_sentences_with_unmatched_single_quotes() {
 		$this->assertSame(
@@ -83,6 +98,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 4539
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_quotes() {
 		$this->assertSame( '&#8220;Quoted String&#8221;', wptexturize( '"Quoted String"' ) );
@@ -102,6 +119,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 4539
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_quotes_before_s() {
 		$this->assertSame( 'test&#8217;s', wptexturize( "test's" ) );
@@ -113,6 +132,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 4539
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_quotes_before_numbers() {
 		$this->assertSame( 'Class of &#8217;99', wptexturize( "Class of '99" ) );
@@ -141,6 +162,9 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 		$this->assertSame( '}&#8221;Class of &#8217;99&#8243;{', wptexturize( "}\"Class of '99\"{" ) );
 	}
 
+	/**
+	 * @covers ::wptexturize
+	 */
 	public function test_quotes_after_numbers() {
 		$this->assertSame( 'Class of &#8217;99', wptexturize( "Class of '99" ) );
 	}
@@ -148,6 +172,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	/**
 	 * @ticket 4539
 	 * @ticket 15241
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_other_html() {
 		$this->assertSame( '&#8216;<strong>', wptexturize( "'<strong>" ) );
@@ -155,10 +181,16 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 		// $this->assertSame( '&#8220;<strong>Quoted Text</strong>&#8221;,', wptexturize( '"<strong>Quoted Text</strong>",' ) );
 	}
 
+	/**
+	 * @covers ::wptexturize
+	 */
 	public function test_x() {
 		$this->assertSame( '14&#215;24', wptexturize( '14x24' ) );
 	}
 
+	/**
+	 * @covers ::wptexturize
+	 */
 	public function test_minutes_seconds() {
 		$this->assertSame( '9&#8242;', wptexturize( '9\'' ) );
 		$this->assertSame( '9&#8243;', wptexturize( '9"' ) );
@@ -172,6 +204,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8775
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_wptexturize_quotes_around_numbers() {
 		$this->assertSame( '&#8220;12345&#8221;', wptexturize( '"12345"' ) );
@@ -182,6 +216,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 8912
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_wptexturize_html_comments() {
 		$this->assertSame( '<!--[if !IE]>--><!--<![endif]-->', wptexturize( '<!--[if !IE]>--><!--<![endif]-->' ) );
@@ -192,6 +228,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	/**
 	 * @ticket 4539
 	 * @ticket 15241
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_entity_quote_cuddling() {
 		$this->assertSame( '&nbsp;&#8220;Testing&#8221;', wptexturize( '&nbsp;"Testing"' ) );
@@ -200,6 +238,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22823
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_apostrophes_before_primes() {
 		$this->assertSame( 'WordPress 3.5&#8217;s release date', wptexturize( "WordPress 3.5's release date" ) );
@@ -207,6 +247,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 23185
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_spaces_around_hyphens() {
 		$nbsp = "\xC2\xA0";
@@ -230,6 +272,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 31030
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_hyphens_at_start_and_end() {
 		$this->assertSame( '&#8211; ', wptexturize( '- ' ) );
@@ -247,6 +291,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 * These should never happen, even if the desired output changes some day.
 	 *
 	 * @ticket 22692
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_spaces_around_quotes_never() {
 		$nbsp = "\xC2\xA0";
@@ -264,9 +310,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_spaces_around_quotes
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_spaces_around_quotes( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_spaces_around_quotes() {
@@ -320,9 +368,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_apos_before_digits
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_apos_before_digits( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_apos_before_digits() {
@@ -361,9 +411,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_opening_single_quote
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_opening_single_quote( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_opening_single_quote() {
@@ -490,9 +542,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_double_prime
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_double_prime( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_double_prime() {
@@ -523,9 +577,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_single_prime
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_single_prime( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_single_prime() {
@@ -556,9 +612,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_contractions
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_contractions( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_contractions() {
@@ -597,9 +655,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_opening_quote
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_opening_quote( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_opening_quote() {
@@ -674,9 +734,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_closing_quote
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_closing_quote( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_closing_quote() {
@@ -763,9 +825,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_closing_single_quote
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_closing_single_quote( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_closing_single_quote() {
@@ -853,9 +917,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 * @ticket 22692
 	 * @ticket 30445
 	 * @dataProvider data_multiplication
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_multiplication( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_multiplication() {
@@ -903,9 +969,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_ampersand
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_ampersand( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_ampersand() {
@@ -968,9 +1036,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_cockney
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_cockney( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_cockney() {
@@ -1029,9 +1099,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_smart_dashes
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_smart_dashes( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_smart_dashes() {
@@ -1082,9 +1154,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 22692
 	 * @dataProvider data_misc_static_replacements
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_misc_static_replacements( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_misc_static_replacements() {
@@ -1137,9 +1211,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 8775
 	 * @dataProvider data_quoted_numbers
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_quoted_numbers( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_quoted_numbers() {
@@ -1188,9 +1264,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 20342
 	 * @dataProvider data_quotes_and_dashes
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_quotes_and_dashes( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_quotes_and_dashes() {
@@ -1251,9 +1329,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 12690
 	 * @dataProvider data_tag_avoidance
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_tag_avoidance( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_tag_avoidance() {
@@ -1474,9 +1554,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 26850
 	 * @dataProvider data_year_abbr
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_year_abbr( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_year_abbr() {
@@ -1563,6 +1645,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 27426
 	 * @dataProvider data_translate
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_translate( $input, $output ) {
 		add_filter( 'gettext_with_context', array( $this, 'filter_translate' ), 10, 4 );
@@ -1572,7 +1656,7 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 		remove_filter( 'gettext_with_context', array( $this, 'filter_translate' ), 10, 4 );
 		wptexturize( 'reset', true );
 
-		return $this->assertSame( $output, $result );
+		$this->assertSame( $output, $result );
 	}
 
 	public function filter_translate( $translations, $text, $context, $domain ) {
@@ -1790,9 +1874,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 28483
 	 * @dataProvider data_element_stack
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_element_stack( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_element_stack() {
@@ -1841,6 +1927,8 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 29557
 	 * @dataProvider data_unregistered_shortcodes
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_unregistered_shortcodes( $input, $output ) {
 		add_filter( 'no_texturize_shortcodes', array( $this, 'filter_shortcodes' ), 10, 1 );
@@ -1926,9 +2014,11 @@ class Tests_Formatting_wpTexturize extends WP_UnitTestCase {
 	 *
 	 * @ticket 29256
 	 * @dataProvider data_primes_vs_quotes
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_primes_vs_quotes( $input, $output ) {
-		return $this->assertSame( $output, wptexturize( $input ) );
+		$this->assertSame( $output, wptexturize( $input ) );
 	}
 
 	public function data_primes_vs_quotes() {
@@ -1988,6 +2078,8 @@ String with a number followed by a single quote &#8216;Expendables 3&#8217; vest
 	 *
 	 * @ticket 29256
 	 * @dataProvider data_primes_quotes_translation
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_primes_quotes_translation( $input, $output ) {
 		add_filter( 'gettext_with_context', array( $this, 'filter_translate2' ), 10, 4 );
@@ -1997,7 +2089,7 @@ String with a number followed by a single quote &#8216;Expendables 3&#8217; vest
 		remove_filter( 'gettext_with_context', array( $this, 'filter_translate2' ), 10, 4 );
 		wptexturize( 'reset', true );
 
-		return $this->assertSame( $output, $result );
+		$this->assertSame( $output, $result );
 	}
 
 	public function filter_translate2( $translations, $text, $context, $domain ) {
@@ -2081,6 +2173,9 @@ String with a number followed by a single quote !q1!Expendables 3!q1! vestibulum
 	 * Automated performance testing of the main regex.
 	 *
 	 * @dataProvider data_whole_posts
+	 *
+	 * @covers ::_get_wptexturize_split_regex
+	 * @covers ::_get_wptexturize_shortcode_regex
 	 */
 	public function test_pcre_performance( $input ) {
 		global $shortcode_tags;
@@ -2101,6 +2196,8 @@ String with a number followed by a single quote !q1!Expendables 3!q1! vestibulum
 	 * Ensure that a trailing less-than symbol doesn't cause a PHP warning.
 	 *
 	 * @ticket 35864
+	 *
+	 * @covers ::wptexturize
 	 */
 	public function test_trailing_less_than() {
 		$this->assertSame( 'F&#8211;oo<', wptexturize( 'F--oo<', true ) );
diff --git a/tests/formatting/wpTrimExcerpt.php b/tests/formatting/wpTrimExcerpt.php
index ed5117bb56..c3ab336bf9 100644
--- a/tests/formatting/wpTrimExcerpt.php
+++ b/tests/formatting/wpTrimExcerpt.php
@@ -2,6 +2,7 @@
 
 /**
  * @group formatting
+ *
  * @covers ::wp_trim_excerpt
  */
 class Tests_Formatting_wpTrimExcerpt extends WP_UnitTestCase {
diff --git a/tests/formatting/wpTrimWords.php b/tests/formatting/wpTrimWords.php
index 1becf2b5d2..b918fd1642 100644
--- a/tests/formatting/wpTrimWords.php
+++ b/tests/formatting/wpTrimWords.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::wp_trim_words
  */
 class Tests_Formatting_wpTrimWords extends WP_UnitTestCase {
 
diff --git a/tests/formatting/zeroise.php b/tests/formatting/zeroise.php
index c702fc4eb9..fb8f49897b 100644
--- a/tests/formatting/zeroise.php
+++ b/tests/formatting/zeroise.php
@@ -2,6 +2,8 @@
 
 /**
  * @group formatting
+ *
+ * @covers ::zeroise
  */
 class Tests_Formatting_Zeroise extends WP_UnitTestCase {
 	public function test_pads_with_leading_zeroes() {
diff --git a/tests/functions.php b/tests/functions.php
index 96dee380ec..a7679be7f0 100644
--- a/tests/functions.php
+++ b/tests/functions.php
@@ -105,6 +105,13 @@ class Tests_Functions extends WP_UnitTestCase {
 			'C:\\',
 			'C:\\WINDOWS',
 			'\\\\sambashare\\foo',
+			'c:/',
+			'c://',
+			'//',
+			'c:/FOO',
+			'//FOO',
+			'C:/WWW/Sites/demo/htdocs/wordpress/wp-content/uploads/2016/03/example.jpg',
+			'//ComputerName/ShareName/SubfolderName/example.txt',
 		);
 		foreach ( $absolute_paths as $path ) {
 			$this->assertTrue( path_is_absolute( $path ), "path_is_absolute('$path') should return true" );
@@ -119,16 +126,82 @@ class Tests_Functions extends WP_UnitTestCase {
 			'../foo',
 			'../',
 			'../foo.bar',
+			'foo.bar',
 			'foo/bar',
 			'foo',
 			'FOO',
 			'..\\WINDOWS',
+			'..//WINDOWS',
+			'c:',
+			'C:',
 		);
 		foreach ( $relative_paths as $path ) {
 			$this->assertFalse( path_is_absolute( $path ), "path_is_absolute('$path') should return false" );
 		}
 	}
 
+	/**
+	 * Tests path_join().
+	 *
+	 * @ticket 55897
+	 * @dataProvider path_join_data_provider
+	 */
+	public function test_path_join( $base, $path, $expected ) {
+		$this->assertSame( $expected, path_join( $base, $path ) );
+	}
+
+	/**
+	 * Data provider for test_path_join().
+	 *
+	 * @return string[][]
+	 */
+	public function path_join_data_provider() {
+		return array(
+			// Absolute paths.
+			'absolute path should return path' => array(
+				'base'     => 'base',
+				'path'     => '/path',
+				'expected' => '/path',
+			),
+			'windows path with slashes'        => array(
+				'base'     => 'base',
+				'path'     => '//path',
+				'expected' => '//path',
+			),
+			'windows path with backslashes'    => array(
+				'base'     => 'base',
+				'path'     => '\\\\path',
+				'expected' => '\\\\path',
+			),
+			// Non-absolute paths.
+			'join base and path'               => array(
+				'base'     => 'base',
+				'path'     => 'path',
+				'expected' => 'base/path',
+			),
+			'strip trailing slashes in base'   => array(
+				'base'     => 'base///',
+				'path'     => 'path',
+				'expected' => 'base/path',
+			),
+			'empty path'                       => array(
+				'base'     => 'base',
+				'path'     => '',
+				'expected' => 'base/',
+			),
+			'empty base'                       => array(
+				'base'     => '',
+				'path'     => 'path',
+				'expected' => '/path',
+			),
+			'empty path and base'              => array(
+				'base'     => '',
+				'path'     => '',
+				'expected' => '/',
+			),
+		);
+	}
+
 	/**
 	 * @ticket 33265
 	 * @ticket 35996
@@ -311,152 +384,6 @@ class Tests_Functions extends WP_UnitTestCase {
 		return $formats;
 	}
 
-	/**
-	 * @dataProvider data_is_not_serialized
-	 */
-	public function test_maybe_serialize( $value ) {
-		if ( is_array( $value ) || is_object( $value ) ) {
-			$expected = serialize( $value );
-		} else {
-			$expected = $value;
-		}
-
-		$this->assertSame( $expected, maybe_serialize( $value ) );
-	}
-
-	/**
-	 * @dataProvider data_is_serialized
-	 */
-	public function test_maybe_serialize_with_double_serialization( $value ) {
-		$expected = serialize( $value );
-
-		$this->assertSame( $expected, maybe_serialize( $value ) );
-	}
-
-	/**
-	 * @dataProvider data_is_serialized
-	 * @dataProvider data_is_not_serialized
-	 */
-	public function test_maybe_unserialize( $value, $is_serialized ) {
-		if ( $is_serialized ) {
-			$expected = unserialize( trim( $value ) );
-		} else {
-			$expected = $value;
-		}
-
-		if ( is_object( $expected ) ) {
-			$this->assertEquals( $expected, maybe_unserialize( $value ) );
-		} else {
-			$this->assertSame( $expected, maybe_unserialize( $value ) );
-		}
-	}
-
-	/**
-	 * @dataProvider data_is_serialized
-	 * @dataProvider data_is_not_serialized
-	 */
-	public function test_is_serialized( $value, $expected ) {
-		$this->assertSame( $expected, is_serialized( $value ) );
-	}
-
-	/**
-	 * @dataProvider data_serialize_deserialize_objects
-	 */
-	public function test_deserialize_request_utility_filtered_iterator_objects( $value ) {
-		$serialized = maybe_serialize( $value );
-		if ( get_class( $value ) === 'Requests_Utility_FilteredIterator' ) {
-			$new_value = unserialize( $serialized );
-			$property  = ( new ReflectionClass( 'Requests_Utility_FilteredIterator' ) )->getProperty( 'callback' );
-			$property->setAccessible( true );
-			$callback_value = $property->getValue( $new_value );
-			$this->assertSame( null, $callback_value );
-		} else {
-			$this->assertSame( $value->count(), unserialize( $serialized )->count() );
-		}
-	}
-
-	public function data_serialize_deserialize_objects() {
-		return array(
-			array( new Requests_Utility_FilteredIterator( array( 1 ), 'md5' ) ),
-			array( new Requests_Utility_FilteredIterator( array( 1, 2 ), 'sha1' ) ),
-			array( new ArrayIterator( array( 1, 2, 3 ) ) ),
-		);
-	}
-
-	public function data_is_serialized() {
-		return array(
-			array( serialize( null ), true ),
-			array( serialize( true ), true ),
-			array( serialize( false ), true ),
-			array( serialize( -25 ), true ),
-			array( serialize( 25 ), true ),
-			array( serialize( 1.1 ), true ),
-			array( serialize( 'this string will be serialized' ), true ),
-			array( serialize( "a\nb" ), true ),
-			array( serialize( array() ), true ),
-			array( serialize( array( 1, 1, 2, 3, 5, 8, 13 ) ), true ),
-			array(
-				serialize(
-					(object) array(
-						'test' => true,
-						'3',
-						4,
-					)
-				),
-				true,
-			),
-			array( '   s:25:"this string is serialized";   ', true ),
-		);
-	}
-
-	public function data_is_not_serialized() {
-		return array(
-			array( null, false ),
-			array( true, false ),
-			array( false, false ),
-			array( -25, false ),
-			array( 25, false ),
-			array( 1.1, false ),
-			array( 'this string will be serialized', false ),
-			array( "a\nb", false ),
-			array( array(), false ),
-			array( array( 1, 1, 2, 3, 5, 8, 13 ), false ),
-			array(
-				(object) array(
-					'test' => true,
-					'3',
-					4,
-				),
-				false,
-			),
-			array( 'a string', false ),
-			array( 'garbage:a:0:garbage;', false ),
-			array( 's:4:test;', false ),
-		);
-	}
-
-	/**
-	 * @ticket 46570
-	 * @dataProvider data_is_serialized_should_return_true_for_large_floats
-	 */
-	public function test_is_serialized_should_return_true_for_large_floats( $value ) {
-		$this->assertTrue( is_serialized( $value ) );
-	}
-
-	public function data_is_serialized_should_return_true_for_large_floats() {
-		return array(
-			array( serialize( 1.7976931348623157E+308 ) ),
-			array( serialize( array( 1.7976931348623157E+308, 1.23e50 ) ) ),
-		);
-	}
-
-	/**
-	 * @ticket 17375
-	 */
-	public function test_no_new_serializable_types() {
-		$this->assertFalse( is_serialized( 'C:16:"Serialized_Class":6:{a:0:{}}' ) );
-	}
-
 	/**
 	 * @group add_query_arg
 	 */
@@ -990,6 +917,10 @@ class Tests_Functions extends WP_UnitTestCase {
 			'ftp://127.0.0.1/',
 			'http://www.woo.com/video?v=exvUH2qKLTU',
 			'http://taco.com?burrito=enchilada#guac',
+			'http://example.org/?post_type=post&p=4',
+			'http://example.org/?post_type=post&p=5',
+			'http://example.org/?post_type=post&p=6',
+			'http://typo-in-query.org/?foo=bar&ampbaz=missing_semicolon',
 		);
 
 		$blob = '
@@ -1052,6 +983,12 @@ class Tests_Functions extends WP_UnitTestCase {
 			http://www.woo.com/video?v=exvUH2qKLTU
 
 			http://taco.com?burrito=enchilada#guac
+
+			http://example.org/?post_type=post&amp;p=4
+			http://example.org/?post_type=post&#038;p=5
+			http://example.org/?post_type=post&p=6
+
+			http://typo-in-query.org/?foo=bar&ampbaz=missing_semicolon
 		';
 
 		$urls = wp_extract_urls( $blob );
@@ -1096,6 +1033,28 @@ class Tests_Functions extends WP_UnitTestCase {
 		$this->assertSame( array_slice( $original_urls, 0, 8 ), $urls );
 	}
 
+	/**
+	 * Tests for backward compatibility of `wp_extract_urls` to remove unused semicolons.
+	 *
+	 * @ticket 30580
+	 *
+	 * @covers ::wp_extract_urls
+	 */
+	public function test_wp_extract_urls_remove_semicolon() {
+		$expected = array(
+			'http://typo.com',
+			'http://example.org/?post_type=post&p=8',
+		);
+		$actual   = wp_extract_urls(
+			'
+				http://typo.com;
+				http://example.org/?post_type=;p;o;s;t;&amp;p=8;
+			'
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
 	/**
 	 * @ticket 28786
 	 */
@@ -2106,4 +2065,126 @@ class Tests_Functions extends WP_UnitTestCase {
 		$this->assertFalse( wp_get_default_extension_for_mime_type( 123 ), 'false not returned when int as mime type supplied' );
 		$this->assertFalse( wp_get_default_extension_for_mime_type( null ), 'false not returned when null as mime type supplied' );
 	}
+
+	/**
+	 * @ticket 49412
+	 * @covers ::wp_filesize
+	 */
+	function test_wp_filesize_with_nonexistent_file() {
+		$file = 'nonexistent/file.jpg';
+		$this->assertEquals( 0, wp_filesize( $file ) );
+	}
+
+	/**
+	 * @ticket 49412
+	 * @covers ::wp_filesize
+	 */
+	function test_wp_filesize() {
+		$file = DIR_TESTDATA . '/images/test-image-upside-down.jpg';
+
+		$this->assertEquals( filesize( $file ), wp_filesize( $file ) );
+
+		$filter = function() {
+			return 999;
+		};
+
+		add_filter( 'wp_filesize', $filter );
+
+		$this->assertEquals( 999, wp_filesize( $file ) );
+
+		$pre_filter = function() {
+			return 111;
+		};
+
+		add_filter( 'pre_wp_filesize', $pre_filter );
+
+		$this->assertEquals( 111, wp_filesize( $file ) );
+	}
+
+	/**
+	 * @ticket 55505
+	 * @covers ::wp_recursive_ksort
+	 */
+	function test_wp_recursive_ksort() {
+		// Create an array to test.
+		$theme_json = array(
+			'version'  => 1,
+			'settings' => array(
+				'typography' => array(
+					'fontFamilies' => array(
+						'fontFamily' => 'DM Sans, sans-serif',
+						'slug'       => 'dm-sans',
+						'name'       => 'DM Sans',
+					),
+				),
+				'color'      => array(
+					'palette' => array(
+						array(
+							'slug'  => 'foreground',
+							'color' => '#242321',
+							'name'  => 'Foreground',
+						),
+						array(
+							'slug'  => 'background',
+							'color' => '#FCFBF8',
+							'name'  => 'Background',
+						),
+						array(
+							'slug'  => 'primary',
+							'color' => '#71706E',
+							'name'  => 'Primary',
+						),
+						array(
+							'slug'  => 'tertiary',
+							'color' => '#CFCFCF',
+							'name'  => 'Tertiary',
+						),
+					),
+				),
+			),
+		);
+
+		// Sort the array.
+		wp_recursive_ksort( $theme_json );
+
+		// Expected result.
+		$expected_theme_json = array(
+			'settings' => array(
+				'color'      => array(
+					'palette' => array(
+						array(
+							'color' => '#242321',
+							'name'  => 'Foreground',
+							'slug'  => 'foreground',
+						),
+						array(
+							'color' => '#FCFBF8',
+							'name'  => 'Background',
+							'slug'  => 'background',
+						),
+						array(
+							'color' => '#71706E',
+							'name'  => 'Primary',
+							'slug'  => 'primary',
+						),
+						array(
+							'color' => '#CFCFCF',
+							'name'  => 'Tertiary',
+							'slug'  => 'tertiary',
+						),
+					),
+				),
+				'typography' => array(
+					'fontFamilies' => array(
+						'fontFamily' => 'DM Sans, sans-serif',
+						'name'       => 'DM Sans',
+						'slug'       => 'dm-sans',
+					),
+				),
+			),
+			'version'  => 1,
+		);
+		$this->assertEquals( $theme_json, $expected_theme_json );
+	}
+
 }
diff --git a/tests/functions/anonymization.php b/tests/functions/anonymization.php
index b0dfafa528..3e0cea6fa7 100644
--- a/tests/functions/anonymization.php
+++ b/tests/functions/anonymization.php
@@ -19,7 +19,7 @@
 class Tests_Functions_Anonymization extends WP_UnitTestCase {
 
 	/**
-	 * Test that wp_privacy_anonymize_ip() properly anonymizes all possible IP address formats.
+	 * Tests that wp_privacy_anonymize_ip() properly anonymizes all possible IP address formats.
 	 *
 	 * @dataProvider data_wp_privacy_anonymize_ip
 	 *
@@ -40,7 +40,7 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Provide test cases for `test_wp_privacy_anonymize_ip()`.
+	 * Data provider for `test_wp_privacy_anonymize_ip()`.
 	 *
 	 * @since 4.9.6 Moved from `Test_WP_Community_Events::data_get_unsafe_client_ip_anonymization()`.
 	 *
@@ -175,7 +175,7 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test that wp_privacy_anonymize_ip() properly anonymizes all possible IP address formats.
+	 * Tests that wp_privacy_anonymize_ip() properly anonymizes all possible IP address formats.
 	 *
 	 * @dataProvider data_wp_privacy_anonymize_ip_with_inet_dependency
 	 *
@@ -194,7 +194,7 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Provide test cases for `test_wp_privacy_anonymize_ip()`.
+	 * Data provider for `test_wp_privacy_anonymize_ip()`.
 	 *
 	 * @since 4.9.6 Moved from `Test_WP_Community_Events::data_get_unsafe_client_ip_anonymization()`.
 	 *
@@ -261,28 +261,28 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test email anonymization of `wp_privacy_anonymize_data()`.
+	 * Tests email anonymization of `wp_privacy_anonymize_data()`.
 	 */
 	public function test_anonymize_email() {
 		$this->assertSame( 'deleted@site.invalid', wp_privacy_anonymize_data( 'email', 'bar@example.com' ) );
 	}
 
 	/**
-	 * Test url anonymization of `wp_privacy_anonymize_data()`.
+	 * Tests URL anonymization of `wp_privacy_anonymize_data()`.
 	 */
 	public function test_anonymize_url() {
 		$this->assertSame( 'https://site.invalid', wp_privacy_anonymize_data( 'url', 'https://example.com/author/username' ) );
 	}
 
 	/**
-	 * Test date anonymization of `wp_privacy_anonymize_data()`.
+	 * Tests date anonymization of `wp_privacy_anonymize_data()`.
 	 */
 	public function test_anonymize_date() {
 		$this->assertSame( '0000-00-00 00:00:00', wp_privacy_anonymize_data( 'date', '2003-12-25 12:34:56' ) );
 	}
 
 	/**
-	 * Test text anonymization of `wp_privacy_anonymize_data()`.
+	 * Tests text anonymization of `wp_privacy_anonymize_data()`.
 	 */
 	public function test_anonymize_text() {
 		$text = __( 'Four score and seven years ago' );
@@ -290,7 +290,7 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test long text anonymization of `wp_privacy_anonymize_data()`.
+	 * Tests long text anonymization of `wp_privacy_anonymize_data()`.
 	 */
 	public function test_anonymize_long_text() {
 		$text = __( 'Four score and seven years ago' );
@@ -298,7 +298,7 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test text anonymization when a filter is added.
+	 * Tests text anonymization when a filter is added.
 	 *
 	 * @ticket 44141
 	 */
@@ -311,7 +311,7 @@ class Tests_Functions_Anonymization extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Change the anonymized value for URLs.
+	 * Changes the anonymized value for URLs.
 	 *
 	 * @since 4.9.8
 	 *
diff --git a/tests/functions/cleanDirsizeCache.php b/tests/functions/cleanDirsizeCache.php
index 27aacda62b..e8a247de24 100644
--- a/tests/functions/cleanDirsizeCache.php
+++ b/tests/functions/cleanDirsizeCache.php
@@ -8,7 +8,7 @@
 class Tests_Functions_CleanDirsizeCache extends WP_UnitTestCase {
 
 	/**
-	 * Test the handling of invalid data passed as the $path parameter.
+	 * Tests the handling of invalid data passed as the $path parameter.
 	 *
 	 * @ticket 52241
 	 *
@@ -53,7 +53,7 @@ class Tests_Functions_CleanDirsizeCache extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test the handling of a non-path text string passed as the $path parameter.
+	 * Tests the handling of a non-path text string passed as the $path parameter.
 	 *
 	 * @ticket 52241
 	 *
@@ -105,7 +105,7 @@ class Tests_Functions_CleanDirsizeCache extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test the behaviour of the function when the transient doesn't exist.
+	 * Tests the behaviour of the function when the transient doesn't exist.
 	 *
 	 * @ticket 52241
 	 * @ticket 53635
@@ -121,7 +121,7 @@ class Tests_Functions_CleanDirsizeCache extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test the behaviour of the function when the transient does exist, but is not an array.
+	 * Tests the behaviour of the function when the transient does exist, but is not an array.
 	 *
 	 * In particular, this tests that no PHP TypeErrors are being thrown.
 	 *
diff --git a/tests/functions/cleanupHeaderComment.php b/tests/functions/cleanupHeaderComment.php
index 73fcc1ee78..06af432fd1 100644
--- a/tests/functions/cleanupHeaderComment.php
+++ b/tests/functions/cleanupHeaderComment.php
@@ -11,19 +11,19 @@
 class Tests_Functions_CleanupHeaderComment extends WP_UnitTestCase {
 
 	/**
-	 * Test cleanup header of header comment.
+	 * Tests _cleanup_header_comment().
 	 *
 	 * @dataProvider data_cleanup_header_comment
 	 *
-	 * @param string $test_string
-	 * @param string $expected
+	 * @param string $test_string Test string.
+	 * @param string $expected    Expected return value.
 	 */
 	public function test_cleanup_header_comment( $test_string, $expected ) {
 		$this->assertSameIgnoreEOL( $expected, _cleanup_header_comment( $test_string ) );
 	}
 
 	/**
-	 * Data provider for test_cleanup_header_comment.
+	 * Data provider for test_cleanup_header_comment().
 	 *
 	 * @return array[] Test parameters {
 	 *     @type string $test_string Test string.
diff --git a/tests/functions/doEnclose.php b/tests/functions/doEnclose.php
index 5c8a42089f..6c06f35182 100644
--- a/tests/functions/doEnclose.php
+++ b/tests/functions/doEnclose.php
@@ -25,11 +25,11 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 */
 	public function set_up() {
 		parent::set_up();
-		add_filter( 'pre_http_request', array( $this, 'fake_http_request' ), 10, 3 );
+		add_filter( 'pre_http_request', array( $this, 'mock_http_request' ), 10, 3 );
 	}
 
 	/**
-	 * Test the function with an explicit content input.
+	 * Tests the function with an explicit content input.
 	 *
 	 * @since 5.3.0
 	 *
@@ -45,7 +45,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test the function with an implicit content input.
+	 * Tests the function with an implicit content input.
 	 *
 	 * @since 5.3.0
 	 *
@@ -65,7 +65,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Dataprovider for `test_function_with_explicit_content_input()`
+	 * Data provider for `test_function_with_explicit_content_input()`
 	 * and `test_function_with_implicit_content_input()`.
 	 *
 	 * @since 5.3.0
@@ -250,17 +250,16 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Fake the HTTP request response.
+	 * Mock the HTTP request response.
 	 *
 	 * @since 5.3.0
 	 *
 	 * @param bool   $false     False.
 	 * @param array  $arguments Request arguments.
 	 * @param string $url       Request URL.
-	 *
 	 * @return array            Header.
 	 */
-	public function fake_http_request( $false, $arguments, $url ) {
+	public function mock_http_request( $false, $arguments, $url ) {
 
 		// Video and audio headers.
 		$fake_headers = array(
diff --git a/tests/functions/getStatusHeaderDesc.php b/tests/functions/getStatusHeaderDesc.php
index c8a73ea99d..a7b253fcdd 100644
--- a/tests/functions/getStatusHeaderDesc.php
+++ b/tests/functions/getStatusHeaderDesc.php
@@ -17,7 +17,7 @@ class Tests_Functions_GetStatusHeaderDesc extends WP_UnitTestCase {
 	 * @param string $expected Status description.
 	 */
 	public function test_get_status_header_desc( $code, $expected ) {
-		$this->assertSame( get_status_header_desc( $code ), $expected );
+		$this->assertSame( $expected, get_status_header_desc( $code ) );
 	}
 
 	/**
diff --git a/tests/functions/isPhpVersionCompatible.php b/tests/functions/isPhpVersionCompatible.php
new file mode 100644
index 0000000000..e455cde9ef
--- /dev/null
+++ b/tests/functions/isPhpVersionCompatible.php
@@ -0,0 +1,89 @@
+<?php
+
+/**
+ * Tests the is_php_version_compatible() function.
+ *
+ * @group functions.php
+ * @covers ::is_php_version_compatible
+ */
+class Tests_Functions_IsPhpVersionCompatible extends WP_UnitTestCase {
+	/**
+	 * Tests is_php_version_compatible().
+	 *
+	 * @dataProvider data_is_php_version_compatible
+	 *
+	 * @ticket 54257
+	 *
+	 * @param mixed $required The minimum required PHP version.
+	 * @param bool  $expected The expected result.
+	 */
+	public function test_is_php_version_compatible( $required, $expected ) {
+		$this->assertSame( $expected, is_php_version_compatible( $required ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_is_php_version_compatible() {
+		$php_version = PHP_VERSION;
+
+		$version_parts  = explode( '.', $php_version );
+		$lower_version  = $version_parts;
+		$higher_version = $version_parts;
+
+		// Adjust the major version numbers.
+		--$lower_version[0];
+		++$higher_version[0];
+
+		$lower_version  = implode( '.', $lower_version );
+		$higher_version = implode( '.', $higher_version );
+
+		return array(
+			// Happy paths.
+			'a lower required version'  => array(
+				'required' => $lower_version,
+				'expected' => true,
+			),
+			'the same version'          => array(
+				'required' => $php_version,
+				'expected' => true,
+			),
+			'a higher required version' => array(
+				'required' => $higher_version,
+				'expected' => false,
+			),
+
+			// Falsey values.
+			'false'                     => array(
+				'required' => false,
+				'expected' => true,
+			),
+			'null'                      => array(
+				'required' => null,
+				'expected' => true,
+			),
+			'0 int'                     => array(
+				'required' => 0,
+				'expected' => true,
+			),
+			'0.0 float'                 => array(
+				'required' => 0.0,
+				'expected' => true,
+			),
+			'0 string'                  => array(
+				'required' => '0',
+				'expected' => true,
+			),
+			'empty string'              => array(
+				'required' => '',
+				'expected' => true,
+			),
+			'empty array'               => array(
+				'required' => array(),
+				'expected' => true,
+			),
+		);
+	}
+}
diff --git a/tests/functions/isSerialized.php b/tests/functions/isSerialized.php
new file mode 100644
index 0000000000..8ecbd5273c
--- /dev/null
+++ b/tests/functions/isSerialized.php
@@ -0,0 +1,207 @@
+<?php
+
+/**
+ * Tests for `is_serialized()`.
+ *
+ * @ticket 53299
+ *
+ * @group functions.php
+ * @covers ::is_serialized
+ */
+class Tests_Functions_IsSerialized extends WP_UnitTestCase {
+
+	/**
+	 * @dataProvider data_is_serialized
+	 * @dataProvider data_is_not_serialized
+	 *
+	 * @param mixed $data     Data value to test.
+	 * @param bool  $expected Expected function result.
+	 */
+	public function test_is_serialized( $data, $expected ) {
+		$this->assertSame( $expected, is_serialized( $data ) );
+	}
+
+	/**
+	 * Data provider for `test_is_serialized()`.
+	 *
+	 * @return array
+	 */
+	public function data_is_serialized() {
+		return array(
+			'serialized empty array'            => array(
+				'data'     => serialize( array() ),
+				'expected' => true,
+			),
+			'serialized non-empty array'        => array(
+				'data'     => serialize( array( 1, 1, 2, 3, 5, 8, 13 ) ),
+				'expected' => true,
+			),
+			'serialized empty object'           => array(
+				'data'     => serialize( new stdClass() ),
+				'expected' => true,
+			),
+			'serialized non-empty object'       => array(
+				'data'     => serialize(
+					(object) array(
+						'test' => true,
+						'1',
+						2,
+					)
+				),
+				'expected' => true,
+			),
+			'serialized null'                   => array(
+				'data'     => serialize( null ),
+				'expected' => true,
+			),
+			'serialized boolean true'           => array(
+				'data'     => serialize( true ),
+				'expected' => true,
+			),
+			'serialized boolean false'          => array(
+				'data'     => serialize( false ),
+				'expected' => true,
+			),
+			'serialized integer -1'             => array(
+				'data'     => serialize( -1 ),
+				'expected' => true,
+			),
+			'serialized integer 1'              => array(
+				'data'     => serialize( -1 ),
+				'expected' => true,
+			),
+			'serialized float 1.1'              => array(
+				'data'     => serialize( 1.1 ),
+				'expected' => true,
+			),
+			'serialized string'                 => array(
+				'data'     => serialize( 'this string will be serialized' ),
+				'expected' => true,
+			),
+			'serialized string with line break' => array(
+				'data'     => serialize( "a\nb" ),
+				'expected' => true,
+			),
+			'serialized string with leading and trailing spaces' => array(
+				'data'     => '   s:25:"this string is serialized";   ',
+				'expected' => true,
+			),
+			'serialized enum'                   => array(
+				'data'     => 'E:7:"Foo:bar";',
+				'expected' => true,
+			),
+		);
+	}
+
+	/**
+	 * Data provider for `test_is_serialized()`.
+	 *
+	 * @return array
+	 */
+	public function data_is_not_serialized() {
+		return array(
+			'an empty array'                             => array(
+				'data'     => array(),
+				'expected' => false,
+			),
+			'a non-empty array'                          => array(
+				'data'     => array( 1, 1, 2, 3, 5, 8, 13 ),
+				'expected' => false,
+			),
+			'an empty object'                            => array(
+				'data'     => new stdClass(),
+				'expected' => false,
+			),
+			'a non-empty object'                         => array(
+				'data'     => (object) array(
+					'test' => true,
+					'1',
+					2,
+				),
+				'expected' => false,
+			),
+			'null'                                       => array(
+				'data'     => null,
+				'expected' => false,
+			),
+			'a boolean true'                             => array(
+				'data'     => true,
+				'expected' => false,
+			),
+			'a boolean false'                            => array(
+				'data'     => false,
+				'expected' => false,
+			),
+			'an integer -1'                              => array(
+				'data'     => -1,
+				'expected' => false,
+			),
+			'an integer 0'                               => array(
+				'data'     => 0,
+				'expected' => false,
+			),
+			'an integer 1'                               => array(
+				'data'     => 1,
+				'expected' => false,
+			),
+			'a float 0.0'                                => array(
+				'data'     => 0.0,
+				'expected' => false,
+			),
+			'a float 1.1'                                => array(
+				'data'     => 1.1,
+				'expected' => false,
+			),
+			'a string'                                   => array(
+				'data'     => 'a string',
+				'expected' => false,
+			),
+			'a string with line break'                   => array(
+				'data'     => "a\nb",
+				'expected' => false,
+			),
+			'a string with leading and trailing garbage' => array(
+				'data'     => 'garbage:a:0:garbage;',
+				'expected' => false,
+			),
+			'a string with missing double quotes'        => array(
+				'data'     => 's:4:test;',
+				'expected' => false,
+			),
+			'a string that is too short'                 => array(
+				'data'     => 's:3',
+				'expected' => false,
+			),
+			'not a colon in second position'             => array(
+				'data'     => 's!3:"foo";',
+				'expected' => false,
+			),
+			'no trailing semicolon (strict check)'       => array(
+				'data'     => 's:3:"foo"',
+				'expected' => false,
+			),
+		);
+	}
+
+	/**
+	 * @ticket 46570
+	 * @dataProvider data_is_serialized_should_return_true_for_large_floats
+	 */
+	public function test_is_serialized_should_return_true_for_large_floats( $value ) {
+		$this->assertTrue( is_serialized( $value ) );
+	}
+
+	public function data_is_serialized_should_return_true_for_large_floats() {
+		return array(
+			array( serialize( 1.7976931348623157E+308 ) ),
+			array( serialize( array( 1.7976931348623157E+308, 1.23e50 ) ) ),
+		);
+	}
+
+	/**
+	 * @ticket 17375
+	 */
+	public function test_no_new_serializable_types() {
+		$this->assertFalse( is_serialized( 'C:16:"Serialized_Class":6:{a:0:{}}' ) );
+	}
+}
diff --git a/tests/functions/isSerializedString.php b/tests/functions/isSerializedString.php
index 677bf6d591..f8f33a2c33 100644
--- a/tests/functions/isSerializedString.php
+++ b/tests/functions/isSerializedString.php
@@ -11,60 +11,70 @@
 class Tests_Functions_IsSerializedString extends WP_UnitTestCase {
 
 	/**
-	 * Data provider method for testing `is_serialized_string()`.
+	 * @dataProvider data_is_serialized_string
 	 *
-	 * @return array
+	 * @param array|object|int|string $data     Data value to test.
+	 * @param bool                    $expected Expected function result.
 	 */
-	public function _is_serialized_string() {
-		return array(
-
-			// pass array.
-			array( array(), false ),
-
-			// pass a class.
-			array( new stdClass(), false ),
-
-			// Not a string.
-			array( 0, false ),
-
-			// Too short when trimmed.
-			array( 's:3       ', false ),
-
-			// Too short.
-			array( 's:3', false ),
-
-			// No colon in second position.
-			array( 's!3:"foo";', false ),
-
-			// No trailing semicolon.
-			array( 's:3:"foo"', false ),
-
-			// Wrong type.
-			array( 'a:3:"foo";', false ),
-
-			// No closing quote.
-			array( 'a:3:"foo;', false ),
-
-			// have to use double Quotes.
-			array( "s:12:'foo';", false ),
-
-			// Wrong number of characters is close enough for is_serialized_string().
-			array( 's:12:"foo";', true ),
-
-			// Okay.
-			array( 's:3:"foo";', true ),
-		);
+	public function test_is_serialized_string( $data, $expected ) {
+		$this->assertSame( $expected, is_serialized_string( $data ) );
 	}
 
 	/**
-	 * Run tests on `is_serialized_string()`.
-	 *
-	 * @dataProvider _is_serialized_string
+	 * Data provider for `test_is_serialized_string()`.
 	 *
-	 * @param array|object|int|string $data     Data value to test.
-	 * @param bool                    $expected Expected function result.
+	 * @return array
 	 */
-	public function test_is_serialized_string( $data, $expected ) {
-		$this->assertSame( $expected, is_serialized_string( $data ) );
+	public function data_is_serialized_string() {
+		return array(
+			'an array'                                => array(
+				'data'     => array(),
+				'expected' => false,
+			),
+			'an object'                               => array(
+				'data'     => new stdClass(),
+				'expected' => false,
+			),
+			'an integer 0'                            => array(
+				'data'     => 0,
+				'expected' => false,
+			),
+			'a string that is too short when trimmed' => array(
+				'data'     => 's:3       ',
+				'expected' => false,
+			),
+			'a string that is too short'              => array(
+				'data'     => 's:3',
+				'expected' => false,
+			),
+			'not a colon in second position'          => array(
+				'data'     => 's!3:"foo";',
+				'expected' => false,
+			),
+			'no trailing semicolon'                   => array(
+				'data'     => 's:3:"foo"',
+				'expected' => false,
+			),
+			'wrong type of serialized data'           => array(
+				'data'     => 'a:3:"foo";',
+				'expected' => false,
+			),
+			'no closing quote'                        => array(
+				'data'     => 'a:3:"foo;',
+				'expected' => false,
+			),
+			'single quotes instead of double'         => array(
+				'data'     => "s:12:'foo';",
+				'expected' => false,
+			),
+			'wrong number of characters (should not matter)' => array(
+				'data'     => 's:12:"foo";',
+				'expected' => true,
+			),
+			'valid serialized string'                 => array(
+				'data'     => 's:3:"foo";',
+				'expected' => true,
+			),
+		);
 	}
 }
diff --git a/tests/functions/isWpVersionCompatible.php b/tests/functions/isWpVersionCompatible.php
new file mode 100644
index 0000000000..6a6b424e92
--- /dev/null
+++ b/tests/functions/isWpVersionCompatible.php
@@ -0,0 +1,184 @@
+<?php
+
+/**
+ * Tests the is_wp_version_compatible() function.
+ *
+ * @group functions.php
+ * @covers ::is_wp_version_compatible
+ */
+class Tests_Functions_IsWpVersionCompatible extends WP_UnitTestCase {
+	/**
+	 * Tests is_wp_version_compatible().
+	 *
+	 * @dataProvider data_is_wp_version_compatible
+	 *
+	 * @ticket 54257
+	 *
+	 * @param mixed $required The minimum required WordPress version.
+	 * @param bool  $expected The expected result.
+	 */
+	public function test_is_wp_version_compatible( $required, $expected ) {
+		$this->assertSame( $expected, is_wp_version_compatible( $required ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_is_wp_version_compatible() {
+		global $wp_version;
+
+		$version_parts  = explode( '.', $wp_version );
+		$lower_version  = $version_parts;
+		$higher_version = $version_parts;
+
+		// Adjust the major version numbers.
+		--$lower_version[0];
+		++$higher_version[0];
+
+		$lower_version  = implode( '.', $lower_version );
+		$higher_version = implode( '.', $higher_version );
+
+		return array(
+			// Happy paths.
+			'the same version'          => array(
+				'required' => $wp_version,
+				'expected' => true,
+			),
+			'a lower required version'  => array(
+				'required' => $lower_version,
+				'expected' => true,
+			),
+			'a higher required version' => array(
+				'required' => $higher_version,
+				'expected' => false,
+			),
+
+			// Falsey values.
+			'false'                     => array(
+				'required' => false,
+				'expected' => true,
+			),
+			'null'                      => array(
+				'required' => null,
+				'expected' => true,
+			),
+			'0 int'                     => array(
+				'required' => 0,
+				'expected' => true,
+			),
+			'0.0 float'                 => array(
+				'required' => 0.0,
+				'expected' => true,
+			),
+			'0 string'                  => array(
+				'required' => '0',
+				'expected' => true,
+			),
+			'empty string'              => array(
+				'required' => '',
+				'expected' => true,
+			),
+			'empty array'               => array(
+				'required' => array(),
+				'expected' => true,
+			),
+		);
+	}
+
+	/**
+	 * Tests is_wp_version_compatible() with development versions.
+	 *
+	 * @dataProvider data_is_wp_version_compatible_with_development_versions
+	 *
+	 * @ticket 54257
+	 *
+	 * @param string $required  The minimum required WordPress version.
+	 * @param string $wp        The value for the $wp_version global variable.
+	 * @param bool   $expected  The expected result.
+	 */
+	public function test_is_wp_version_compatible_with_development_versions( $required, $wp, $expected ) {
+		global $wp_version;
+
+		$original_version = $wp_version;
+		$wp_version       = $wp;
+		$actual           = is_wp_version_compatible( $required );
+
+		// Reset the version before the assertion in case of failure.
+		$wp_version = $original_version;
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_is_wp_version_compatible_with_development_versions() {
+		global $wp_version;
+
+		// For consistent results, remove possible suffixes.
+		list( $version ) = explode( '-', $wp_version );
+
+		$version_parts  = explode( '.', $version );
+		$lower_version  = $version_parts;
+		$higher_version = $version_parts;
+
+		// Adjust the major version numbers.
+		--$lower_version[0];
+		++$higher_version[0];
+
+		$lower_version  = implode( '.', $lower_version );
+		$higher_version = implode( '.', $higher_version );
+
+		return array(
+			'a lower required version and an alpha wordpress version' => array(
+				'required' => $lower_version,
+				'wp'       => $version . '-alpha-12341-src',
+				'expected' => true,
+			),
+			'a lower required version and a beta wordpress version'   => array(
+				'required' => $lower_version,
+				'wp'       => $version . '-beta1',
+				'expected' => true,
+			),
+			'a lower required version and a release candidate wordpress version'   => array(
+				'required' => $lower_version,
+				'wp'       => $version . '-RC1',
+				'expected' => true,
+			),
+			'the same required version and an alpha wordpress version' => array(
+				'required' => $version,
+				'wp'       => $version . '-alpha-12341-src',
+				'expected' => true,
+			),
+			'the same required version and a beta wordpress version' => array(
+				'required' => $version,
+				'wp'       => $version . '-beta1',
+				'expected' => true,
+			),
+			'the same required version and a release candidate wordpress version' => array(
+				'required' => $version,
+				'wp'       => $version . '-RC1',
+				'expected' => true,
+			),
+			'a higher required version and an alpha wordpress version'   => array(
+				'required' => $higher_version,
+				'wp'       => $version . '-alpha-12341-src',
+				'expected' => false,
+			),
+			'a higher required version and a beta wordpress version'   => array(
+				'required' => $higher_version,
+				'wp'       => $version . '-beta1',
+				'expected' => false,
+			),
+			'a higher required version and a release candidate wordpress version'   => array(
+				'required' => $higher_version,
+				'wp'       => $version . '-RC1',
+				'expected' => false,
+			),
+		);
+	}
+}
diff --git a/tests/functions/maybeSerialize.php b/tests/functions/maybeSerialize.php
new file mode 100644
index 0000000000..104c1b1134
--- /dev/null
+++ b/tests/functions/maybeSerialize.php
@@ -0,0 +1,246 @@
+<?php
+
+/**
+ * Tests for `maybe_serialize()` and `maybe_unserialize()`.
+ *
+ * @group functions.php
+ * @covers ::maybe_serialize
+ * @covers ::maybe_unserialize
+ */
+class Tests_Functions_MaybeSerialize extends WP_UnitTestCase {
+
+	/**
+	 * @dataProvider data_is_not_serialized
+	 */
+	public function test_maybe_serialize( $value ) {
+		if ( is_array( $value ) || is_object( $value ) ) {
+			$expected = serialize( $value );
+		} else {
+			$expected = $value;
+		}
+
+		$this->assertSame( $expected, maybe_serialize( $value ) );
+	}
+
+	/**
+	 * @dataProvider data_is_serialized
+	 */
+	public function test_maybe_serialize_with_double_serialization( $value ) {
+		$expected = serialize( $value );
+
+		$this->assertSame( $expected, maybe_serialize( $value ) );
+	}
+
+	/**
+	 * @dataProvider data_is_serialized
+	 * @dataProvider data_is_not_serialized
+	 */
+	public function test_maybe_unserialize( $value, $is_serialized ) {
+		if ( $is_serialized ) {
+			$expected = unserialize( trim( $value ) );
+		} else {
+			$expected = $value;
+		}
+
+		if ( is_object( $expected ) ) {
+			$this->assertEquals( $expected, maybe_unserialize( $value ) );
+		} else {
+			$this->assertSame( $expected, maybe_unserialize( $value ) );
+		}
+	}
+
+	/**
+	 * Data provider for `test_maybe_unserialize()`.
+	 *
+	 * @return array
+	 */
+	public function data_is_serialized() {
+		return array(
+			'serialized empty array'            => array(
+				'data'     => serialize( array() ),
+				'expected' => true,
+			),
+			'serialized non-empty array'        => array(
+				'data'     => serialize( array( 1, 1, 2, 3, 5, 8, 13 ) ),
+				'expected' => true,
+			),
+			'serialized empty object'           => array(
+				'data'     => serialize( new stdClass() ),
+				'expected' => true,
+			),
+			'serialized non-empty object'       => array(
+				'data'     => serialize(
+					(object) array(
+						'test' => true,
+						'1',
+						2,
+					)
+				),
+				'expected' => true,
+			),
+			'serialized null'                   => array(
+				'data'     => serialize( null ),
+				'expected' => true,
+			),
+			'serialized boolean true'           => array(
+				'data'     => serialize( true ),
+				'expected' => true,
+			),
+			'serialized boolean false'          => array(
+				'data'     => serialize( false ),
+				'expected' => true,
+			),
+			'serialized integer -1'             => array(
+				'data'     => serialize( -1 ),
+				'expected' => true,
+			),
+			'serialized integer 1'              => array(
+				'data'     => serialize( -1 ),
+				'expected' => true,
+			),
+			'serialized float 1.1'              => array(
+				'data'     => serialize( 1.1 ),
+				'expected' => true,
+			),
+			'serialized string'                 => array(
+				'data'     => serialize( 'this string will be serialized' ),
+				'expected' => true,
+			),
+			'serialized string with line break' => array(
+				'data'     => serialize( "a\nb" ),
+				'expected' => true,
+			),
+			'serialized string with leading and trailing spaces' => array(
+				'data'     => '   s:25:"this string is serialized";   ',
+				'expected' => true,
+			),
+		);
+	}
+
+	/**
+	 * Data provider for `test_maybe_serialize()`.
+	 *
+	 * @return array
+	 */
+	public function data_is_not_serialized() {
+		return array(
+			'an empty array'                             => array(
+				'data'     => array(),
+				'expected' => false,
+			),
+			'a non-empty array'                          => array(
+				'data'     => array( 1, 1, 2, 3, 5, 8, 13 ),
+				'expected' => false,
+			),
+			'an empty object'                            => array(
+				'data'     => new stdClass(),
+				'expected' => false,
+			),
+			'a non-empty object'                         => array(
+				'data'     => (object) array(
+					'test' => true,
+					'1',
+					2,
+				),
+				'expected' => false,
+			),
+			'null'                                       => array(
+				'data'     => null,
+				'expected' => false,
+			),
+			'a boolean true'                             => array(
+				'data'     => true,
+				'expected' => false,
+			),
+			'a boolean false'                            => array(
+				'data'     => false,
+				'expected' => false,
+			),
+			'an integer -1'                              => array(
+				'data'     => -1,
+				'expected' => false,
+			),
+			'an integer 0'                               => array(
+				'data'     => 0,
+				'expected' => false,
+			),
+			'an integer 1'                               => array(
+				'data'     => 1,
+				'expected' => false,
+			),
+			'a float 0.0'                                => array(
+				'data'     => 0.0,
+				'expected' => false,
+			),
+			'a float 1.1'                                => array(
+				'data'     => 1.1,
+				'expected' => false,
+			),
+			'a string'                                   => array(
+				'data'     => 'a string',
+				'expected' => false,
+			),
+			'a string with line break'                   => array(
+				'data'     => "a\nb",
+				'expected' => false,
+			),
+			'a string with leading and trailing garbage' => array(
+				'data'     => 'garbage:a:0:garbage;',
+				'expected' => false,
+			),
+			'a string with missing double quotes'        => array(
+				'data'     => 's:4:test;',
+				'expected' => false,
+			),
+			'a string that is too short'                 => array(
+				'data'     => 's:3',
+				'expected' => false,
+			),
+			'not a colon in second position'             => array(
+				'data'     => 's!3:"foo";',
+				'expected' => false,
+			),
+			'no trailing semicolon (strict check)'       => array(
+				'data'     => 's:3:"foo"',
+				'expected' => false,
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_serialize_deserialize_objects
+	 */
+	public function test_deserialize_request_utility_filtered_iterator_objects( $value ) {
+		$serialized = maybe_serialize( $value );
+
+		if ( get_class( $value ) === 'Requests_Utility_FilteredIterator' ) {
+			$new_value = unserialize( $serialized );
+			$property  = ( new ReflectionClass( 'Requests_Utility_FilteredIterator' ) )->getProperty( 'callback' );
+			$property->setAccessible( true );
+			$callback_value = $property->getValue( $new_value );
+
+			$this->assertSame( null, $callback_value );
+		} else {
+			$this->assertSame( $value->count(), unserialize( $serialized )->count() );
+		}
+	}
+
+	/**
+	 * Data provider for test_deserialize_request_utility_filtered_iterator_objects().
+	 *
+	 * @return array
+	 */
+	public function data_serialize_deserialize_objects() {
+		return array(
+			'filtered iterator using md5'  => array(
+				new Requests_Utility_FilteredIterator( array( 1 ), 'md5' ),
+			),
+			'filtered iterator using sha1' => array(
+				new Requests_Utility_FilteredIterator( array( 1, 2 ), 'sha1' ),
+			),
+			'array iterator'               => array(
+				new ArrayIterator( array( 1, 2, 3 ) ),
+			),
+		);
+	}
+}
diff --git a/tests/functions/sizeFormat.php b/tests/functions/sizeFormat.php
index 281db07f5d..1337bb39c8 100644
--- a/tests/functions/sizeFormat.php
+++ b/tests/functions/sizeFormat.php
@@ -3,7 +3,9 @@
 /**
  * Tests for size_format()
  *
+ * @ticket 22405
  * @ticket 36635
+ * @ticket 40875
  *
  * @group functions.php
  * @covers ::size_format
@@ -12,31 +14,58 @@ class Tests_Functions_SizeFormat extends WP_UnitTestCase {
 
 	public function _data_size_format() {
 		return array(
+			// Invalid values
 			array( array(), 0, false ),
 			array( 'baba', 0, false ),
 			array( '', 0, false ),
 			array( '-1', 0, false ),
 			array( -1, 0, false ),
+			// Bytes
 			array( 0, 0, '0 B' ),
 			array( 1, 0, '1 B' ),
 			array( 1023, 0, '1,023 B' ),
+			// Kilobytes
 			array( KB_IN_BYTES, 0, '1 KB' ),
 			array( KB_IN_BYTES, 2, '1.00 KB' ),
 			array( 2.5 * KB_IN_BYTES, 0, '3 KB' ),
 			array( 2.5 * KB_IN_BYTES, 2, '2.50 KB' ),
 			array( 10 * KB_IN_BYTES, 0, '10 KB' ),
+			// Megabytes
 			array( (string) 1024 * KB_IN_BYTES, 2, '1.00 MB' ),
 			array( MB_IN_BYTES, 0, '1 MB' ),
 			array( 2.5 * MB_IN_BYTES, 0, '3 MB' ),
 			array( 2.5 * MB_IN_BYTES, 2, '2.50 MB' ),
+			// Gigabytes
 			array( (string) 1024 * MB_IN_BYTES, 2, '1.00 GB' ),
 			array( GB_IN_BYTES, 0, '1 GB' ),
 			array( 2.5 * GB_IN_BYTES, 0, '3 GB' ),
 			array( 2.5 * GB_IN_BYTES, 2, '2.50 GB' ),
+			// Terabytes
 			array( (string) 1024 * GB_IN_BYTES, 2, '1.00 TB' ),
 			array( TB_IN_BYTES, 0, '1 TB' ),
 			array( 2.5 * TB_IN_BYTES, 0, '3 TB' ),
 			array( 2.5 * TB_IN_BYTES, 2, '2.50 TB' ),
+			// Petabytes
+			array( (string) 1024 * TB_IN_BYTES, 2, '1.00 PB' ),
+			array( PB_IN_BYTES, 0, '1 PB' ),
+			array( 2.5 * PB_IN_BYTES, 0, '3 PB' ),
+			array( 2.5 * PB_IN_BYTES, 2, '2.50 PB' ),
+			// Exabytes
+			array( (string) 1024 * PB_IN_BYTES, 2, '1.00 EB' ),
+			array( EB_IN_BYTES, 0, '1 EB' ),
+			array( 2.5 * EB_IN_BYTES, 0, '3 EB' ),
+			array( 2.5 * EB_IN_BYTES, 2, '2.50 EB' ),
+			// Zettabytes
+			array( (string) 1024 * EB_IN_BYTES, 2, '1.00 ZB' ),
+			array( ZB_IN_BYTES, 0, '1 ZB' ),
+			array( 2.5 * ZB_IN_BYTES, 0, '3 ZB' ),
+			array( 2.5 * ZB_IN_BYTES, 2, '2.50 ZB' ),
+			// Yottabytes
+			array( (string) 1024 * ZB_IN_BYTES, 2, '1.00 YB' ),
+			array( YB_IN_BYTES, 0, '1 YB' ),
+			array( 2.5 * YB_IN_BYTES, 0, '3 YB' ),
+			array( 2.5 * YB_IN_BYTES, 2, '2.50 YB' ),
+			// Edge values
 			array( TB_IN_BYTES + ( TB_IN_BYTES / 2 ) + MB_IN_BYTES, 1, '1.5 TB' ),
 			array( TB_IN_BYTES - MB_IN_BYTES - KB_IN_BYTES, 3, '1,023.999 GB' ),
 		);
diff --git a/tests/functions/wpArrayGet.php b/tests/functions/wpArrayGet.php
index 8fdf23bcf9..4249aa9b70 100644
--- a/tests/functions/wpArrayGet.php
+++ b/tests/functions/wpArrayGet.php
@@ -11,7 +11,7 @@
 class Tests_Functions_wpArrayGet extends WP_UnitTestCase {
 
 	/**
-	 * Test _wp_array_get() with invalid parameters.
+	 * Tests _wp_array_get() with invalid parameters.
 	 *
 	 * @ticket 51720
 	 */
@@ -57,7 +57,7 @@ class Tests_Functions_wpArrayGet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_get() with non-subtree paths.
+	 * Tests _wp_array_get() with non-subtree paths.
 	 *
 	 * @ticket 51720
 	 */
@@ -111,7 +111,7 @@ class Tests_Functions_wpArrayGet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_get() with subtrees.
+	 * Tests _wp_array_get() with subtrees.
 	 *
 	 * @ticket 51720
 	 */
@@ -160,7 +160,7 @@ class Tests_Functions_wpArrayGet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_get() with zero strings.
+	 * Tests _wp_array_get() with zero strings.
 	 *
 	 * @ticket 51720
 	 */
@@ -211,7 +211,7 @@ class Tests_Functions_wpArrayGet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_get() with null values.
+	 * Tests _wp_array_get() with null values.
 	 *
 	 * @ticket 51720
 	 */
@@ -253,7 +253,7 @@ class Tests_Functions_wpArrayGet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_get() with empty paths.
+	 * Tests _wp_array_get() with empty paths.
 	 *
 	 * @ticket 51720
 	 */
diff --git a/tests/functions/wpArraySet.php b/tests/functions/wpArraySet.php
index 8a468fabea..568ef637f1 100644
--- a/tests/functions/wpArraySet.php
+++ b/tests/functions/wpArraySet.php
@@ -11,7 +11,7 @@
 class Tests_Functions_wpArraySet extends WP_UnitTestCase {
 
 	/**
-	 * Test _wp_array_set() with invalid parameters.
+	 * Tests _wp_array_set() with invalid parameters.
 	 *
 	 * @ticket 53175
 	 */
@@ -53,7 +53,7 @@ class Tests_Functions_wpArraySet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_set() with simple non-subtree path.
+	 * Tests _wp_array_set() with simple non-subtree path.
 	 *
 	 * @ticket 53175
 	 */
@@ -84,7 +84,7 @@ class Tests_Functions_wpArraySet extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test _wp_array_set() with subtree paths.
+	 * Tests _wp_array_set() with subtree paths.
 	 *
 	 * @ticket 53175
 	 */
diff --git a/tests/functions/wpArraySliceAssoc.php b/tests/functions/wpArraySliceAssoc.php
index f7ce7293a2..f4f2c503e8 100644
--- a/tests/functions/wpArraySliceAssoc.php
+++ b/tests/functions/wpArraySliceAssoc.php
@@ -11,7 +11,7 @@
 class Tests_Functions_wpArraySliceAssoc extends WP_UnitTestCase {
 
 	/**
-	 * Test wp_array_slice_assoc().
+	 * Tests wp_array_slice_assoc().
 	 *
 	 * @dataProvider data_wp_array_slice_assoc_arrays
 	 *
@@ -22,11 +22,11 @@ class Tests_Functions_wpArraySliceAssoc extends WP_UnitTestCase {
 	 * @param array $expected     The expected result.
 	 */
 	public function test_wp_array_slice_assoc( $target_array, $keys, $expected ) {
-		$this->assertSame( wp_array_slice_assoc( $target_array, $keys ), $expected );
+		$this->assertSame( $expected, wp_array_slice_assoc( $target_array, $keys ) );
 	}
 
 	/**
-	 * Test data for wp_array_slice_assoc().
+	 * Data provider for wp_array_slice_assoc().
 	 *
 	 * @return array
 	 */
diff --git a/tests/functions/wpFuzzyNumberMatch.php b/tests/functions/wpFuzzyNumberMatch.php
new file mode 100644
index 0000000000..85034165ce
--- /dev/null
+++ b/tests/functions/wpFuzzyNumberMatch.php
@@ -0,0 +1,112 @@
+<?php
+
+/**
+ * Test wp_fuzzy_number_match().
+ *
+ * @group functions.php
+ * @covers ::wp_fuzzy_number_match
+ */
+class Tests_Functions_wpFuzzyNumberMatch extends WP_UnitTestCase {
+
+	/**
+	 * @dataProvider data_wp_fuzzy_number_match
+	 *
+	 * @ticket 54239
+	 *
+	 * @param int|float $expected  The expected value.
+	 * @param int|float $actual    The actual number.
+	 * @param int|float $precision The allowed variation.
+	 * @param bool      $result    Whether the numbers match within the specified precision.
+	 */
+	public function test_wp_fuzzy_number_match( $expected, $actual, $precision, $result ) {
+		$this->assertSame( $result, wp_fuzzy_number_match( $expected, $actual, $precision ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[] Test parameters {
+	 *     @type int|float $expected  The expected value.
+	 *     @type int|float $actual    The actual number.
+	 *     @type int|float $precision The allowed variation.
+	 *     @type bool      $result    Whether the numbers match within the specified precision.
+	 * }
+	 */
+	public function data_wp_fuzzy_number_match() {
+		return array(
+			'expected 1 int, actual 1 int'                => array(
+				'expected'  => 1,
+				'actual'    => 1,
+				'precision' => 1,
+				'result'    => true,
+			),
+			'expected 1 int, actual 2 int'                => array(
+				'expected'  => 1,
+				'actual'    => 2,
+				'precision' => 1,
+				'result'    => true,
+			),
+			'expected 1 int, actual 3 int'                => array(
+				'expected'  => 1,
+				'actual'    => 3,
+				'precision' => 1,
+				'result'    => false,
+			),
+			'expected 1 int, actual 1 string'             => array(
+				'expected'  => 1,
+				'actual'    => '1',
+				'precision' => 1,
+				'result'    => true,
+			),
+			'expected 1 int, actual 11 int, precision 10' => array(
+				'expected'  => 1,
+				'actual'    => 11,
+				'precision' => 10,
+				'result'    => true,
+			),
+			'expected 1 int, actual 12 int, precision 10' => array(
+				'expected'  => 1,
+				'actual'    => 12,
+				'precision' => 10,
+				'result'    => false,
+			),
+			'expected 1.234 float, actual 1 int'          => array(
+				'expected'  => 1.234,
+				'actual'    => 1,
+				'precision' => 1,
+				'result'    => true,
+			),
+			'expected 2.234 float, actual 2 int'          => array(
+				'expected'  => 1.234,
+				'actual'    => 2,
+				'precision' => 1,
+				'result'    => true,
+			),
+			'expected 1 int, actual 2.0001 float'         => array(
+				'expected'  => 1,
+				'actual'    => 2.0001,
+				'precision' => 1,
+				'result'    => false,
+			),
+			'expected 1 int, actual 3.23 float'           => array(
+				'expected'  => 1,
+				'actual'    => 3.234,
+				'precision' => 1,
+				'result'    => false,
+			),
+			'expected 1.2e1 float (12), actual 1.3e1 float (13)' => array(
+				'expected'  => 1.2e1,
+				'actual'    => 1.3e1,
+				'precision' => 1,
+				'result'    => true,
+			),
+			'expected 1.2e3 float (1200), actual 1.2e3 float, precision 1000' => array(
+				'expected'  => 1.2e3,
+				'actual'    => 1.2e3,
+				'precision' => 1000,
+				'result'    => true,
+			),
+		);
+	}
+
+}
diff --git a/tests/functions/wpGuessUrl.php b/tests/functions/wpGuessUrl.php
new file mode 100644
index 0000000000..cfa21bb4d3
--- /dev/null
+++ b/tests/functions/wpGuessUrl.php
@@ -0,0 +1,38 @@
+<?php
+
+/**
+ * Test wp_guess_url().
+ *
+ * @group functions.php
+ * @covers ::wp_guess_url
+ */
+class Tests_Functions_wpGuessUrl extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 36827
+	 *
+	 * @dataProvider data_wp_guess_url_should_return_site_url
+	 *
+	 * @param string $url The URL to navigate to, relative to `site_url()`.
+	 */
+	public function test_wp_guess_url_should_return_site_url( $url ) {
+		$siteurl = site_url();
+		$this->go_to( site_url( $url ) );
+		$this->assertSame( $siteurl, wp_guess_url() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_guess_url_should_return_site_url() {
+		return array(
+			'no trailing slash'                            => array( 'url' => 'wp-admin' ),
+			'trailing slash'                               => array( 'url' => 'wp-admin/' ),
+			'trailing slash, query var'                    => array( 'url' => 'wp-admin/?foo=bar' ),
+			'file extension, no trailing slash'            => array( 'url' => 'wp-login.php' ),
+			'file extension, query var, no trailing slash' => array( 'url' => 'wp-login.php?foo=bar' ),
+		);
+	}
+}
diff --git a/tests/functions/wpToKebabCase.php b/tests/functions/wpToKebabCase.php
index 24b2e2d187..7a765c78f3 100644
--- a/tests/functions/wpToKebabCase.php
+++ b/tests/functions/wpToKebabCase.php
@@ -10,31 +10,55 @@
  */
 class Tests_Functions_wpToKebabCase extends WP_UnitTestCase {
 
-	public function test_wp_to_kebab_case() {
-		$this->assertSame( 'white', _wp_to_kebab_case( 'white' ) );
-		$this->assertSame( 'white-black', _wp_to_kebab_case( 'white+black' ) );
-		$this->assertSame( 'white-black', _wp_to_kebab_case( 'white:black' ) );
-		$this->assertSame( 'white-black', _wp_to_kebab_case( 'white*black' ) );
-		$this->assertSame( 'white-black', _wp_to_kebab_case( 'white.black' ) );
-		$this->assertSame( 'white-black', _wp_to_kebab_case( 'white black' ) );
-		$this->assertSame( 'white-black', _wp_to_kebab_case( 'white	black' ) );
-		$this->assertSame( 'white-to-black', _wp_to_kebab_case( 'white-to-black' ) );
-		$this->assertSame( 'white-2-white', _wp_to_kebab_case( 'white2white' ) );
-		$this->assertSame( 'white-2nd', _wp_to_kebab_case( 'white2nd' ) );
-		$this->assertSame( 'white-2-ndcolor', _wp_to_kebab_case( 'white2ndcolor' ) );
-		$this->assertSame( 'white-2nd-color', _wp_to_kebab_case( 'white2ndColor' ) );
-		$this->assertSame( 'white-2nd-color', _wp_to_kebab_case( 'white2nd_color' ) );
-		$this->assertSame( 'white-23-color', _wp_to_kebab_case( 'white23color' ) );
-		$this->assertSame( 'white-23', _wp_to_kebab_case( 'white23' ) );
-		$this->assertSame( '23-color', _wp_to_kebab_case( '23color' ) );
-		$this->assertSame( 'white-4th', _wp_to_kebab_case( 'white4th' ) );
-		$this->assertSame( 'font-2-xl', _wp_to_kebab_case( 'font2xl' ) );
-		$this->assertSame( 'white-to-white', _wp_to_kebab_case( 'whiteToWhite' ) );
-		$this->assertSame( 'white-t-owhite', _wp_to_kebab_case( 'whiteTOwhite' ) );
-		$this->assertSame( 'whit-eto-white', _wp_to_kebab_case( 'WHITEtoWHITE' ) );
-		$this->assertSame( '42', _wp_to_kebab_case( 42 ) );
-		$this->assertSame( 'ive-done', _wp_to_kebab_case( "i've done" ) );
-		$this->assertSame( 'ffffff', _wp_to_kebab_case( '#ffffff' ) );
-		$this->assertSame( 'ffffff', _wp_to_kebab_case( '$ffffff' ) );
+	/**
+	 * Tests _wp_to_kebab_case().
+	 *
+	 * @dataProvider data_wp_to_kebab_case
+	 *
+	 * @ticket 53397
+	 *
+	 * @param string $test_value Test value.
+	 * @param string $expected   Expected return value.
+	 */
+	public function test_wp_to_kebab_case( $test_value, $expected ) {
+		$this->assertSame( $expected, _wp_to_kebab_case( $test_value ) );
+	}
+
+	/**
+	 * Data provider for test_wp_to_kebab_case().
+	 *
+	 * @return array[] Test parameters {
+	 *     @type string $test_value Test value.
+	 *     @type string $expected   Expected return value.
+	 * }
+	 */
+	public function data_wp_to_kebab_case() {
+		return array(
+			array( 'white', 'white' ),
+			array( 'white+black', 'white-black' ),
+			array( 'white:black', 'white-black' ),
+			array( 'white*black', 'white-black' ),
+			array( 'white.black', 'white-black' ),
+			array( 'white black', 'white-black' ),
+			array( 'white	black', 'white-black' ),
+			array( 'white-to-black', 'white-to-black' ),
+			array( 'white2white', 'white-2-white' ),
+			array( 'white2nd', 'white-2nd' ),
+			array( 'white2ndcolor', 'white-2-ndcolor' ),
+			array( 'white2ndColor', 'white-2nd-color' ),
+			array( 'white2nd_color', 'white-2nd-color' ),
+			array( 'white23color', 'white-23-color' ),
+			array( 'white23', 'white-23' ),
+			array( '23color', '23-color' ),
+			array( 'white4th', 'white-4th' ),
+			array( 'font2xl', 'font-2-xl' ),
+			array( 'whiteToWhite', 'white-to-white' ),
+			array( 'whiteTOwhite', 'white-t-owhite' ),
+			array( 'WHITEtoWHITE', 'whit-eto-white' ),
+			array( 42, '42' ),
+			array( "i've done", 'ive-done' ),
+			array( '#ffffff', 'ffffff' ),
+			array( '$ffffff', 'ffffff' ),
+		);
 	}
 }
diff --git a/tests/functions/wpValidateBoolean.php b/tests/functions/wpValidateBoolean.php
index 785d1bc986..4cef4534ab 100644
--- a/tests/functions/wpValidateBoolean.php
+++ b/tests/functions/wpValidateBoolean.php
@@ -1,59 +1,63 @@
 <?php
 
 /**
- * Tests the wp_validate_boolean function.
+ * Tests for the wp_validate_boolean() function.
  *
  * @group functions.php
  * @covers ::wp_validate_boolean
  */
 class Tests_Functions_wpValidateBoolean extends WP_UnitTestCase {
-	/**
-	 * Provides test scenarios for all possible scenarios in wp_validate_boolean().
-	 *
-	 * @return array
-	 */
-	public function data_provider() {
-			$std = new \stdClass();
-
-			return array(
-				array( null, false ),
-				array( true, true ),
-				array( false, false ),
-				array( 'true', true ),
-				array( 'false', false ),
-				array( 'FalSE', false ), // @ticket 30238
-				array( 'FALSE', false ), // @ticket 30238
-				array( 'TRUE', true ),
-				array( ' FALSE ', true ),
-				array( 'yes', true ),
-				array( 'no', true ),
-				array( 'string', true ),
-				array( '', false ),
-				array( array(), false ),
-				array( 1, true ),
-				array( 0, false ),
-				array( -1, true ),
-				array( 99, true ),
-				array( 0.1, true ),
-				array( 0.0, false ),
-				array( '1', true ),
-				array( '0', false ),
-				array( $std, true ),
-			);
-	}
 
 	/**
-	 * Test wp_validate_boolean().
-	 *
-	 * @dataProvider data_provider
+	 * Tests wp_validate_boolean().
 	 *
-	 * @param mixed $test_value
-	 * @param bool $expected
+	 * @dataProvider data_wp_validate_boolean
 	 *
 	 * @ticket 30238
 	 * @ticket 39868
+	 *
+	 * @param mixed $test_value Test value.
+	 * @param bool  $expected   Expected return value.
 	 */
 	public function test_wp_validate_boolean( $test_value, $expected ) {
-		$this->assertSame( wp_validate_boolean( $test_value ), $expected );
+		$this->assertSame( $expected, wp_validate_boolean( $test_value ) );
+	}
+
+	/**
+	 * Data provider for test_wp_validate_boolean().
+	 *
+	 * @return array[] Test parameters {
+	 *     @type mixed $test_value Test value.
+	 *     @type bool  $expected   Expected return value.
+	 * }
+	 */
+	public function data_wp_validate_boolean() {
+		$std = new \stdClass();
+
+		return array(
+			array( null, false ),
+			array( true, true ),
+			array( false, false ),
+			array( 'true', true ),
+			array( 'false', false ),
+			array( 'FalSE', false ), // @ticket 30238
+			array( 'FALSE', false ), // @ticket 30238
+			array( 'TRUE', true ),
+			array( ' FALSE ', true ),
+			array( 'yes', true ),
+			array( 'no', true ),
+			array( 'string', true ),
+			array( '', false ),
+			array( array(), false ),
+			array( 1, true ),
+			array( 0, false ),
+			array( -1, true ),
+			array( 99, true ),
+			array( 0.1, true ),
+			array( 0.0, false ),
+			array( '1', true ),
+			array( '0', false ),
+			array( $std, true ),
+		);
 	}
 }
diff --git a/tests/functions/xmlrpc.php b/tests/functions/xmlrpc.php
new file mode 100644
index 0000000000..20164e2e4f
--- /dev/null
+++ b/tests/functions/xmlrpc.php
@@ -0,0 +1,68 @@
+<?php
+
+/**
+ * @group xmlrpc
+ * @ticket 53490
+ */
+class Tests_Functions_XMLRPC extends WP_UnitTestCase {
+
+	private $test_content = '
+			<title>title</title>
+			<category>category,category1</category>
+			<content>content</content>
+		';
+
+	/**
+	 * Tests that xmlrpc_getposttitle() returns the post title if found in the XML.
+	 *
+	 * @covers ::xmlrpc_getposttitle
+	 */
+	public function test_xmlrpc_getposttitle() {
+		$this->assertSame( 'title', xmlrpc_getposttitle( $this->test_content ) );
+	}
+
+	/**
+	 * Tests that xmlrpc_getposttitle() defaults to the `$post_default_title` global.
+	 *
+	 * @covers ::xmlrpc_getposttitle
+	 */
+	public function test_xmlrpc_getposttitle_default() {
+		global $post_default_title;
+
+		$post_default_title = 'post_default_title';
+
+		$this->assertSame( 'post_default_title', xmlrpc_getposttitle( '' ) );
+	}
+
+
+	/**
+	 * Tests that xmlrpc_getpostcategory() returns post categories if found in the XML.
+	 *
+	 * @covers ::xmlrpc_getpostcategory
+	 */
+	public function test_xmlrpc_getpostcategory() {
+		$this->assertSame( array( 'category', 'category1' ), xmlrpc_getpostcategory( $this->test_content ) );
+	}
+
+	/**
+	 * Tests that xmlrpc_getpostcategory() defaults to the `$post_default_category` global.
+	 *
+	 * @covers ::xmlrpc_getpostcategory
+	 */
+	public function test_xmlrpc_getpostcategory_default() {
+		global $post_default_category;
+
+		$post_default_category = 'post_default_category';
+
+		$this->assertSame( 'post_default_category', xmlrpc_getpostcategory( '' ) );
+	}
+
+	/**
+	 * Tests that xmlrpc_removepostdata() returns XML content without title and category elements.
+	 *
+	 * @covers ::xmlrpc_removepostdata
+	 */
+	public function test_xmlrpc_removepostdata() {
+		$this->assertSame( '<content>content</content>', xmlrpc_removepostdata( $this->test_content ) );
+	}
+}
diff --git a/tests/general/feedLinksExtra.php b/tests/general/feedLinksExtra.php
new file mode 100644
index 0000000000..d6a688da0d
--- /dev/null
+++ b/tests/general/feedLinksExtra.php
@@ -0,0 +1,637 @@
+<?php
+/**
+ * Test feed_links_extra().
+ *
+ * @ticket 54713
+ *
+ * @group general
+ * @group template
+ *
+ * @covers ::feed_links_extra
+ */
+class Tests_General_FeedLinksExtra extends WP_UnitTestCase {
+	/**
+	 * Author ID.
+	 *
+	 * @var int
+	 */
+	protected static $author_id;
+
+	/**
+	 * Category ID.
+	 *
+	 * @var int
+	 */
+	protected static $category_id;
+
+	/**
+	 * Tag ID.
+	 *
+	 * @var int
+	 */
+	protected static $tag_id;
+
+	/**
+	 * Taxonomy ID.
+	 *
+	 * @var int
+	 */
+	protected static $tax_id;
+
+	/**
+	 * Post Type.
+	 *
+	 * @var string
+	 */
+	protected static $post_type;
+
+	/**
+	 * The ID of a post with no comment.
+	 *
+	 * @var int
+	 */
+	protected static $post_no_comment_id;
+
+	/**
+	 * The ID of a post with a comment.
+	 *
+	 * @var int
+	 */
+	protected static $post_with_comment_id;
+
+	/**
+	 * The ID of a post with a custom post type.
+	 *
+	 * @var int
+	 */
+	protected static $post_with_cpt_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		// Author.
+		self::$author_id = $factory->user->create(
+			array(
+				'user_login' => 'author_feed_links_extra',
+				'role'       => 'administrator',
+			)
+		);
+
+		// Category.
+		self::$category_id = $factory->category->create(
+			array( 'name' => 'cat_feed_links_extra' )
+		);
+
+		// Tag.
+		self::$tag_id = $factory->tag->create(
+			array( 'name' => 'tag_feed_links_extra' )
+		);
+
+		// Taxonomy.
+		self::$tax_id = 'tax_feed_links_extra';
+
+		// Post type.
+		self::$post_type = 'cpt_feed_links_extra';
+
+		register_taxonomy(
+			self::$tax_id,
+			self::$post_type,
+			array(
+				'labels' => array(
+					'name'          => 'Taxonomy Terms',
+					'singular_name' => 'Taxonomy Term',
+				),
+			)
+		);
+
+		register_post_type(
+			self::$post_type,
+			array(
+				'public'      => true,
+				'has_archive' => true,
+				'taxonomies'  => array( self::$tax_id ),
+				'labels'      => array( 'name' => 'CPT for feed_links_extra()' ),
+			)
+		);
+
+		// Posts.
+		self::$post_no_comment_id = $factory->post->create(
+			array( 'post_title' => 'Post with no comments' )
+		);
+
+		self::$post_with_comment_id = $factory->post->create(
+			array( 'post_title' => 'Post with a comment' )
+		);
+
+		$factory->comment->create(
+			array(
+				'comment_author'  => self::$author_id,
+				'comment_post_ID' => self::$post_with_comment_id,
+			)
+		);
+
+		self::$post_with_cpt_id = $factory->post->create(
+			array(
+				'post_title' => 'Post with a custom post type',
+				'post_type'  => self::$post_type,
+			)
+		);
+
+		wp_set_object_terms( self::$post_with_cpt_id, 'tax_term', self::$tax_id );
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		register_taxonomy(
+			self::$tax_id,
+			self::$post_type,
+			array(
+				'labels' => array(
+					'name'          => 'Taxonomy Terms',
+					'singular_name' => 'Taxonomy Term',
+				),
+			)
+		);
+
+		register_post_type(
+			self::$post_type,
+			array(
+				'public'      => true,
+				'has_archive' => true,
+				'taxonomies'  => array( self::$tax_id ),
+				'labels'      => array( 'name' => 'CPT for feed_links_extra()' ),
+			)
+		);
+	}
+
+	/**
+	 * @dataProvider data_feed_links_extra
+	 * @ticket 54713
+	 *
+	 * @param string $title     The expected title.
+	 * @param string $type      The name of the test class property containing the object ID.
+	 * @param array  $args {
+	 *        Optional arguments. Default empty.
+	 *
+	 *        @type string $separator     The separator between blog name and feed type.
+	 *        @type string $singletitle   The title of the comments feed.
+	 *        @type string $cattitle      The title of the category feed.
+	 *        @type string $tagtitle      The title of the tag feed.
+	 *        @type string $taxtitle      The title of the taxonomy feed.
+	 *        @type string $authortitle   The title of the author feed.
+	 *        @type string $searchtitle   The title of the search feed.
+	 *        @type string $posttypetitle The title of the post type feed.
+	 * }
+	 */
+	public function test_feed_links_extra( $title, $type, array $args = array() ) {
+		$permalink = $this->helper_get_the_permalink( $type );
+		$this->go_to( $permalink );
+
+		$expected = '';
+
+		if ( '' !== $title ) {
+			if ( 'post_type' === $type || 'search' === $type ) {
+				$feed_link = $permalink . '&#038;feed=rss2';
+			} else {
+				$feed_link = str_replace( '?', '?feed=rss2&#038;', $permalink );
+			}
+
+			$expected = sprintf(
+				'<link rel="alternate" type="application/rss+xml" title="%s" href="%s" />' . "\n",
+				esc_attr( $title ),
+				esc_url( $feed_link )
+			);
+		}
+
+		$this->assertSame( $expected, get_echo( 'feed_links_extra', array( $args ) ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_feed_links_extra() {
+		return array(
+			'a post with a comment'                        => array(
+				'title' => 'Test Blog &raquo; Post with a comment Comments Feed',
+				'type'  => 'post_with_comment',
+			),
+			'a post with a comment and a custom separator' => array(
+				'title' => 'Test Blog // Post with a comment Comments Feed',
+				'type'  => 'post_with_comment',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'a post with a comment and a custom title'     => array(
+				'title' => 'Custom Title for Singular Feed',
+				'type'  => 'post_with_comment',
+				'args'  => array(
+					'singletitle' => 'Custom Title for Singular Feed',
+				),
+			),
+			'a post with a comment, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for Singular Feed',
+				'type'  => 'post_with_comment',
+				'args'  => array(
+					'separator'   => '//',
+					'singletitle' => '%1$s %2$s Custom Title for Singular Feed',
+				),
+			),
+			'a custom post type'                           => array(
+				'title' => 'Test Blog &raquo; CPT for feed_links_extra() Feed',
+				'type'  => 'post_type',
+			),
+			'a custom post type and a custom separator'    => array(
+				'title' => 'Test Blog // CPT for feed_links_extra() Feed',
+				'type'  => 'post_type',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'a custom post type and a custom title'        => array(
+				'title' => 'Custom Title for CPT Feed',
+				'type'  => 'post_type',
+				'args'  => array(
+					'posttypetitle' => 'Custom Title for CPT Feed',
+				),
+			),
+			'a custom post type, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for CPT Feed',
+				'type'  => 'post_type',
+				'args'  => array(
+					'separator'     => '//',
+					'posttypetitle' => '%1$s %2$s Custom Title for CPT Feed',
+				),
+			),
+			'a category'                                   => array(
+				'title' => 'Test Blog &raquo; cat_feed_links_extra Category Feed',
+				'type'  => 'category',
+			),
+			'a category and a custom separator'            => array(
+				'title' => 'Test Blog // cat_feed_links_extra Category Feed',
+				'type'  => 'category',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'a category and a custom title'                => array(
+				'title' => 'Custom Title for Category Feed',
+				'type'  => 'category',
+				'args'  => array(
+					'cattitle' => 'Custom Title for Category Feed',
+				),
+			),
+			'a category, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for Category Feed',
+				'type'  => 'category',
+				'args'  => array(
+					'separator' => '//',
+					'cattitle'  => '%1$s %2$s Custom Title for Category Feed',
+				),
+			),
+			'a tag'                                        => array(
+				'title' => 'Test Blog &raquo; tag_feed_links_extra Tag Feed',
+				'type'  => 'tag',
+			),
+			'a tag and a custom separator'                 => array(
+				'title' => 'Test Blog // tag_feed_links_extra Tag Feed',
+				'type'  => 'tag',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'a tag and a custom title'                     => array(
+				'title' => 'Custom Title for Tag Feed',
+				'type'  => 'tag',
+				'args'  => array(
+					'tagtitle' => 'Custom Title for Tag Feed',
+				),
+			),
+			'a tag, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for Tag Feed',
+				'type'  => 'tag',
+				'args'  => array(
+					'separator' => '//',
+					'tagtitle'  => '%1$s %2$s Custom Title for Tag Feed',
+				),
+			),
+			'a taxonomy'                                   => array(
+				'title' => 'Test Blog &raquo; tax_term Taxonomy Term Feed',
+				'type'  => 'tax',
+			),
+			'a taxonomy and a custom separator'            => array(
+				'title' => 'Test Blog // tax_term Taxonomy Term Feed',
+				'type'  => 'tax',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'a taxonomy and a custom title'                => array(
+				'title' => 'Custom Title for Taxonomy Feed',
+				'type'  => 'tax',
+				'args'  => array(
+					'taxtitle' => 'Custom Title for Taxonomy Feed',
+				),
+			),
+			'a taxonomy, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for Taxonomy Feed',
+				'type'  => 'tax',
+				'args'  => array(
+					'separator' => '//',
+					'taxtitle'  => '%1$s %2$s Custom Title for Taxonomy Feed',
+				),
+			),
+			'an author'                                    => array(
+				'title' => 'Test Blog &raquo; Posts by author_feed_links_extra Feed',
+				'type'  => 'author',
+			),
+			'an author and a custom separator'             => array(
+				'title' => 'Test Blog // Posts by author_feed_links_extra Feed',
+				'type'  => 'author',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'an author and a custom title'                 => array(
+				'title' => 'Custom Title for Author Feed',
+				'type'  => 'author',
+				'args'  => array(
+					'authortitle' => 'Custom Title for Author Feed',
+				),
+			),
+			'an author, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for Author Feed',
+				'type'  => 'author',
+				'args'  => array(
+					'separator'   => '//',
+					'authortitle' => '%1$s %2$s Custom Title for Author Feed',
+				),
+			),
+			'search results'                               => array(
+				'title' => 'Test Blog &raquo; Search Results for &#8220;Search&#8221; Feed',
+				'type'  => 'search',
+			),
+			'search results and a custom separator'        => array(
+				'title' => 'Test Blog // Search Results for &#8220;Search&#8221; Feed',
+				'type'  => 'search',
+				'args'  => array(
+					'separator' => '//',
+				),
+			),
+			'search results and a custom title'            => array(
+				'title' => 'Custom Title for Search Feed',
+				'type'  => 'search',
+				'args'  => array(
+					'searchtitle' => 'Custom Title for Search Feed',
+				),
+			),
+			'search results, a custom separator and a custom title' => array(
+				'title' => 'Test Blog // Custom Title for Search Feed',
+				'type'  => 'search',
+				'args'  => array(
+					'separator'   => '//',
+					'searchtitle' => '%1$s %2$s Custom Title for Search Feed',
+				),
+			),
+		);
+	}
+
+	/**
+	 * Helper function to get the permalink based on type.
+	 *
+	 * @ticket 54713
+	 *
+	 * @param string $type The name of the test class property containing the object ID.
+	 * @return string The permalink.
+	 */
+	private function helper_get_the_permalink( $type ) {
+		if ( 'category' === $type || 'tag' === $type ) {
+			return get_term_link( self::${$type . '_id'} );
+		}
+
+		if ( 'tax' === $type ) {
+			return get_term_link( 'tax_term', self::$tax_id );
+		}
+
+		if ( 'post_type' === $type ) {
+			return get_post_type_archive_link( self::$post_type );
+		}
+
+		if ( 'author' === $type ) {
+			return get_author_posts_url( self::$author_id );
+		}
+
+		if ( 'search' === $type ) {
+			return home_url( '?s=Search' );
+		}
+
+		return get_the_permalink( self::${$type . '_id'} );
+	}
+
+	/**
+	 * @ticket 54713
+	 */
+	public function test_feed_links_extra_should_respect_comments_open() {
+		add_filter( 'comments_open', '__return_true' );
+		add_filter( 'pings_open', '__return_false' );
+
+		$this->go_to( get_the_permalink( self::$post_no_comment_id ) );
+
+		$expected  = '<link rel="alternate" type="application/rss+xml"';
+		$expected .= ' title="Test Blog &raquo; Post with no comments Comments Feed"';
+		$expected .= ' href="http://example.org/?feed=rss2&#038;p=' . self::$post_no_comment_id . '" />' . "\n";
+		$this->assertSame( $expected, get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @ticket 54713
+	 */
+	public function test_feed_links_extra_should_respect_pings_open() {
+		add_filter( 'pings_open', '__return_true' );
+		add_filter( 'comments_open', '__return_false' );
+
+		$this->go_to( get_the_permalink( self::$post_no_comment_id ) );
+
+		$expected  = '<link rel="alternate" type="application/rss+xml"';
+		$expected .= ' title="Test Blog &raquo; Post with no comments Comments Feed"';
+		$expected .= ' href="http://example.org/?feed=rss2&#038;p=' . self::$post_no_comment_id . '" />' . "\n";
+		$this->assertSame( $expected, get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @ticket 54713
+	 */
+	public function test_feed_links_extra_should_respect_post_comment_count() {
+		add_filter( 'pings_open', '__return_false' );
+		add_filter( 'comments_open', '__return_false' );
+
+		$this->go_to( get_the_permalink( self::$post_with_comment_id ) );
+
+		$expected  = '<link rel="alternate" type="application/rss+xml"';
+		$expected .= ' title="Test Blog &raquo; Post with a comment Comments Feed"';
+		$expected .= ' href="http://example.org/?feed=rss2&#038;p=' . self::$post_with_comment_id . '" />' . "\n";
+		$this->assertSame( $expected, get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @ticket 54713
+	 */
+	public function test_feed_links_extra_should_return_empty_when_comments_and_pings_are_closed_and_post_has_no_comments() {
+		add_filter( 'comments_open', '__return_false' );
+		add_filter( 'pings_open', '__return_false' );
+
+		$this->go_to( get_the_permalink( self::$post_no_comment_id ) );
+		$this->assertEmpty( get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @ticket 54713
+	 */
+	public function test_feed_links_extra_should_respect_feed_type() {
+		add_filter(
+			'default_feed',
+			static function() {
+				return 'foo';
+			}
+		);
+
+		add_filter(
+			'feed_content_type',
+			static function() {
+				return 'testing/foo';
+			}
+		);
+
+		$this->go_to( get_the_permalink( self::$post_with_comment_id ) );
+
+		$expected  = '<link rel="alternate" type="testing/foo"';
+		$expected .= ' title="Test Blog &raquo; Post with a comment Comments Feed"';
+		$expected .= ' href="http://example.org/?feed=foo&#038;p=' . self::$post_with_comment_id . '" />' . "\n";
+		$this->assertSame( $expected, get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @ticket 54703
+	 */
+	public function test_feed_links_extra_should_output_nothing_when_show_comments_feed_filter_returns_false() {
+		add_filter( 'feed_links_show_comments_feed', '__return_false' );
+
+		$this->go_to( get_the_permalink( self::$post_with_comment_id ) );
+		$this->assertEmpty( get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @dataProvider data_feed_links_extra_should_output_nothing_when_post_comments_feed_link_is_falsy
+	 *
+	 * @ticket 54703
+	 *
+	 * @param string $callback The callback to use for the 'post_comments_feed_link' filter.
+	 */
+	public function test_feed_links_extra_should_output_nothing_when_post_comments_feed_link_is_falsy( $callback ) {
+		add_filter( 'post_comments_feed_link', $callback );
+
+		$this->go_to( get_the_permalink( self::$post_with_comment_id ) );
+		$this->assertEmpty( get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_feed_links_extra_should_output_nothing_when_post_comments_feed_link_is_falsy() {
+		return array(
+			'empty string' => array( 'callback' => '__return_empty_string' ),
+			'empty array'  => array( 'callback' => '__return_empty_array' ),
+			'zero int'     => array( 'callback' => '__return_zero' ),
+			'zero float'   => array( 'callback' => array( $this, 'cb_return_zero_float' ) ),
+			'zero string'  => array( 'callback' => array( $this, 'cb_return_zero_string' ) ),
+			'null'         => array( 'callback' => '__return_null' ),
+			'false'        => array( 'callback' => '__return_false' ),
+		);
+	}
+
+	/**
+	 * Callback that returns 0.0.
+	 *
+	 * @return float 0.0.
+	 */
+	public function cb_return_zero_float() {
+		return 0.0;
+	}
+
+	/**
+	 * Callback that returns '0'.
+	 *
+	 * @return string '0'.
+	 */
+	public function cb_return_zero_string() {
+		return '0';
+	}
+
+	/**
+	 * @ticket 54703
+	 */
+	public function test_feed_links_extra_should_output_the_comments_feed_link_when_show_comments_feed_filter_returns_true() {
+		add_filter( 'feed_links_show_comments_feed', '__return_true' );
+
+		$this->go_to( get_the_permalink( self::$post_with_comment_id ) );
+		$this->assertNotEmpty( get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * @dataProvider data_feed_links_extra_should_output_nothing_when_filters_return_false
+	 *
+	 * @ticket 55904
+	 *
+	 * @param string $type   The name of the test class property containing the object ID.
+	 * @param string $filter The name of the filter to set to false.
+	 */
+	public function test_feed_links_extra_should_output_nothing_when_filters_return_false( $type, $filter ) {
+		$permalink = $this->helper_get_the_permalink( $type );
+		$this->go_to( $permalink );
+
+		add_filter( $filter, '__return_false' );
+
+		$this->assertEmpty( get_echo( 'feed_links_extra' ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_feed_links_extra_should_output_nothing_when_filters_return_false() {
+		return array(
+			'a post with a comment' => array(
+				'type'   => 'post_with_comment',
+				'filter' => 'feed_links_extra_show_post_comments_feed',
+			),
+			'a custom post type'    => array(
+				'type'   => 'post_type',
+				'filter' => 'feed_links_extra_show_post_type_archive_feed',
+			),
+			'a category'            => array(
+				'type'   => 'category',
+				'filter' => 'feed_links_extra_show_category_feed',
+			),
+			'a tag'                 => array(
+				'type'   => 'tag',
+				'filter' => 'feed_links_extra_show_tag_feed',
+			),
+			'a taxonomy'            => array(
+				'type'   => 'tax',
+				'filter' => 'feed_links_extra_show_tax_feed',
+			),
+			'an author'             => array(
+				'type'   => 'author',
+				'filter' => 'feed_links_extra_show_author_feed',
+			),
+			'search results'        => array(
+				'type'   => 'search',
+				'filter' => 'feed_links_extra_show_search_feed',
+			),
+		);
+	}
+}
diff --git a/tests/general/template.php b/tests/general/template.php
index ca2e6063a1..8a29853526 100644
--- a/tests/general/template.php
+++ b/tests/general/template.php
@@ -17,6 +17,27 @@ class Tests_General_Template extends WP_UnitTestCase {
 	public $custom_logo_id;
 	public $custom_logo_url;
 
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		/*
+		 * Declare theme support for custom logo.
+		 *
+		 * This ensures that the `site_logo` option gets deleted in
+		 * _delete_site_logo_on_remove_theme_mods(), which in turn
+		 * prevents the `core/site-logo` block filters from affecting
+		 * the custom logo tests.
+		 *
+		 * Alternatively, these filters can be removed instead:
+		 *
+		 *     remove_filter( 'theme_mod_custom_logo', '_override_custom_logo_theme_mod' );
+		 *     remove_filter( 'pre_set_theme_mod_custom_logo', '_sync_custom_logo_to_site_logo' );
+		 */
+		add_theme_support( 'custom-logo' );
+	}
+
+	public static function wpTearDownAfterClass() {
+		remove_theme_support( 'custom-logo' );
+	}
+
 	public function set_up() {
 		parent::set_up();
 
@@ -38,13 +59,13 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @requires function imagejpeg
 	 */
 	public function test_get_site_icon_url() {
-		$this->assertEmpty( get_site_icon_url() );
+		$this->assertEmpty( get_site_icon_url(), 'Site icon URL should not be set initially.' );
 
 		$this->set_site_icon();
-		$this->assertSame( $this->site_icon_url, get_site_icon_url() );
+		$this->assertSame( $this->site_icon_url, get_site_icon_url(), 'Site icon URL should be set.' );
 
 		$this->remove_site_icon();
-		$this->assertEmpty( get_site_icon_url() );
+		$this->assertEmpty( get_site_icon_url(), 'Site icon URL should not be set after removal.' );
 	}
 
 	/**
@@ -67,13 +88,13 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @requires function imagejpeg
 	 */
 	public function test_has_site_icon() {
-		$this->assertFalse( has_site_icon() );
+		$this->assertFalse( has_site_icon(), 'Site icon should not be set initially.' );
 
 		$this->set_site_icon();
-		$this->assertTrue( has_site_icon() );
+		$this->assertTrue( has_site_icon(), 'Site icon should be set.' );
 
 		$this->remove_site_icon();
-		$this->assertFalse( has_site_icon() );
+		$this->assertFalse( has_site_icon(), 'Site icon should not be set after removal.' );
 	}
 
 	/**
@@ -83,7 +104,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::has_site_icon
 	 */
 	public function test_has_site_icon_returns_true_when_called_for_other_site_with_site_icon_set() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 		switch_to_blog( $blog_id );
 		$this->set_site_icon();
 		restore_current_blog();
@@ -98,7 +119,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::has_site_icon
 	 */
 	public function test_has_site_icon_returns_false_when_called_for_other_site_without_site_icon_set() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 
 		$this->assertFalse( has_site_icon( $blog_id ) );
 	}
@@ -159,7 +180,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 */
 	public function test_customize_preview_wp_site_icon_empty() {
 		global $wp_customize;
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 
 		require_once ABSPATH . WPINC . '/class-wp-customize-manager.php';
 		$wp_customize = new WP_Customize_Manager();
@@ -177,7 +198,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 */
 	public function test_customize_preview_wp_site_icon_dirty() {
 		global $wp_customize;
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'administrator' ) ) );
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
 
 		require_once ABSPATH . WPINC . '/class-wp-customize-manager.php';
 		$wp_customize = new WP_Customize_Manager();
@@ -261,13 +282,13 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @since 4.5.0
 	 */
 	public function test_has_custom_logo() {
-		$this->assertFalse( has_custom_logo() );
+		$this->assertFalse( has_custom_logo(), 'Custom logo should not be set initially.' );
 
 		$this->set_custom_logo();
-		$this->assertTrue( has_custom_logo() );
+		$this->assertTrue( has_custom_logo(), 'Custom logo should be set.' );
 
 		$this->remove_custom_logo();
-		$this->assertFalse( has_custom_logo() );
+		$this->assertFalse( has_custom_logo(), 'Custom logo should not be set after removal.' );
 	}
 
 	/**
@@ -277,7 +298,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::has_custom_logo
 	 */
 	public function test_has_custom_logo_returns_true_when_called_for_other_site_with_custom_logo_set() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 		switch_to_blog( $blog_id );
 		$this->set_custom_logo();
 		restore_current_blog();
@@ -292,7 +313,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::has_custom_logo
 	 */
 	public function test_has_custom_logo_returns_false_when_called_for_other_site_without_custom_logo_set() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 
 		$this->assertFalse( has_custom_logo( $blog_id ) );
 	}
@@ -304,15 +325,15 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @since 4.5.0
 	 */
 	public function test_get_custom_logo() {
-		$this->assertEmpty( get_custom_logo() );
+		$this->assertEmpty( get_custom_logo(), 'Custom logo should not be set initially.' );
 
 		$this->set_custom_logo();
 		$custom_logo = get_custom_logo();
-		$this->assertNotEmpty( $custom_logo );
-		$this->assertIsString( $custom_logo );
+		$this->assertNotEmpty( $custom_logo, 'Custom logo markup should not be empty.' );
+		$this->assertIsString( $custom_logo, 'Custom logo markup should be a string.' );
 
 		$this->remove_custom_logo();
-		$this->assertEmpty( get_custom_logo() );
+		$this->assertEmpty( get_custom_logo(), 'Custom logo should not be set after removal.' );
 	}
 
 	/**
@@ -322,7 +343,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::get_custom_logo
 	 */
 	public function test_get_custom_logo_returns_logo_when_called_for_other_site_with_custom_logo_set() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 		switch_to_blog( $blog_id );
 
 		$this->set_custom_logo();
@@ -402,7 +423,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Sets a site icon in options for testing.
+	 * Sets a custom logo in options for testing.
 	 *
 	 * @since 4.5.0
 	 */
@@ -415,7 +436,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Removes the site icon from options.
+	 * Removes the custom logo from options.
 	 *
 	 * @since 4.5.0
 	 */
@@ -445,7 +466,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::get_site_icon_url
 	 */
 	public function test_get_site_icon_url_preserves_switched_state() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 		switch_to_blog( $blog_id );
 
 		$expected = $GLOBALS['_wp_switched_stack'];
@@ -465,7 +486,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::has_custom_logo
 	 */
 	public function test_has_custom_logo_preserves_switched_state() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 		switch_to_blog( $blog_id );
 
 		$expected = $GLOBALS['_wp_switched_stack'];
@@ -485,7 +506,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::get_custom_logo
 	 */
 	public function test_get_custom_logo_preserves_switched_state() {
-		$blog_id = $this->factory->blog->create();
+		$blog_id = self::factory()->blog->create();
 		switch_to_blog( $blog_id );
 
 		$expected = $GLOBALS['_wp_switched_stack'];
@@ -577,18 +598,18 @@ class Tests_General_Template extends WP_UnitTestCase {
 	 * @covers ::get_the_archive_title
 	 */
 	public function test_get_the_archive_title_is_correct_for_author_queries() {
-		$user_with_posts    = $this->factory()->user->create_and_get(
+		$user_with_posts    = self::factory()->user->create_and_get(
 			array(
 				'role' => 'author',
 			)
 		);
-		$user_with_no_posts = $this->factory()->user->create_and_get(
+		$user_with_no_posts = self::factory()->user->create_and_get(
 			array(
 				'role' => 'author',
 			)
 		);
 
-		$this->factory()->post->create(
+		self::factory()->post->create(
 			array(
 				'post_author' => $user_with_posts->ID,
 			)
diff --git a/tests/general/wpGetDocumentTitle.php b/tests/general/wpGetDocumentTitle.php
index 08d9e033f3..b12990fd5c 100644
--- a/tests/general/wpGetDocumentTitle.php
+++ b/tests/general/wpGetDocumentTitle.php
@@ -60,6 +60,18 @@ class Tests_General_wpGetDocumentTitle extends WP_UnitTestCase {
 	public function test__wp_render_title_tag() {
 		$this->go_to( '/' );
 
+		$this->expectOutputString( sprintf( "<title>%s</title>\n", $this->blog_name ) );
+		_wp_render_title_tag();
+	}
+
+	/**
+	 * @ticket 6479
+	 */
+	public function test__wp_render_title_tag_with_blog_description() {
+		$this->go_to( '/' );
+
+		update_option( 'blogdescription', 'A blog description' );
+
 		$this->expectOutputString( sprintf( "<title>%s &#8211; %s</title>\n", $this->blog_name, get_option( 'blogdescription' ) ) );
 		_wp_render_title_tag();
 	}
@@ -89,7 +101,7 @@ class Tests_General_wpGetDocumentTitle extends WP_UnitTestCase {
 		update_option( 'show_on_front', 'page' );
 		update_option(
 			'page_on_front',
-			$this->factory->post->create(
+			self::factory()->post->create(
 				array(
 					'post_title' => 'front-page',
 					'post_type'  => 'page',
@@ -99,12 +111,12 @@ class Tests_General_wpGetDocumentTitle extends WP_UnitTestCase {
 		add_filter( 'document_title_parts', array( $this, 'front_page_title_parts' ) );
 
 		$this->go_to( '/' );
-		$this->assertSame( sprintf( '%s &#8211; Just another WordPress site', $this->blog_name ), wp_get_document_title() );
+		$this->assertSame( sprintf( '%s', $this->blog_name ), wp_get_document_title() );
 
 		update_option( 'show_on_front', 'posts' );
 
 		$this->go_to( '/' );
-		$this->assertSame( sprintf( '%s &#8211; Just another WordPress site', $this->blog_name ), wp_get_document_title() );
+		$this->assertSame( sprintf( '%s', $this->blog_name ), wp_get_document_title() );
 	}
 
 	public function front_page_title_parts( $parts ) {
@@ -116,7 +128,7 @@ class Tests_General_wpGetDocumentTitle extends WP_UnitTestCase {
 	}
 
 	public function test_home_title() {
-		$blog_page_id = $this->factory->post->create(
+		$blog_page_id = self::factory()->post->create(
 			array(
 				'post_title' => 'blog-page',
 				'post_type'  => 'page',
@@ -135,7 +147,7 @@ class Tests_General_wpGetDocumentTitle extends WP_UnitTestCase {
 
 		add_filter( 'document_title_parts', array( $this, 'paged_title_parts' ) );
 
-		$this->assertSame( sprintf( '%s &#8211; Page 4 &#8211; Just another WordPress site', $this->blog_name ), wp_get_document_title() );
+		$this->assertSame( sprintf( '%s &#8211; Page 4', $this->blog_name ), wp_get_document_title() );
 	}
 
 	public function paged_title_parts( $parts ) {
@@ -193,7 +205,7 @@ class Tests_General_wpGetDocumentTitle extends WP_UnitTestCase {
 			)
 		);
 
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_type' => 'cpt',
 			)
diff --git a/tests/general/wpPreloadResources.php b/tests/general/wpPreloadResources.php
new file mode 100644
index 0000000000..53fd2646a6
--- /dev/null
+++ b/tests/general/wpPreloadResources.php
@@ -0,0 +1,253 @@
+<?php
+
+/**
+ * @group general
+ * @group template
+ * @ticket 42438
+ * @covers ::wp_preload_resources
+ */
+class Tests_General_wpPreloadResources extends WP_UnitTestCase {
+
+	/**
+	 * @dataProvider data_preload_resources
+	 *
+	 * @ticket 42438
+	 */
+	public function test_preload_resources( $expected, $preload_resources ) {
+		$callback = function () use ( $preload_resources ) {
+			return $preload_resources;
+		};
+
+		add_filter( 'wp_preload_resources', $callback, 10 );
+		$actual = get_echo( 'wp_preload_resources' );
+		remove_filter( 'wp_preload_resources', $callback );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Test provider for all preload link possible combinations.
+	 *
+	 * @return array[]
+	 */
+	public function data_preload_resources() {
+		return array(
+			'basic_preload'          => array(
+				'expected' => "<link rel='preload' href='https://example.com/style.css' as='style' />\n",
+				'urls'     => array(
+					array(
+						'href' => 'https://example.com/style.css',
+						'as'   => 'style',
+					),
+				),
+			),
+			'multiple_links'         => array(
+				'expected' => "<link rel='preload' href='https://example.com/style.css' as='style' />\n" .
+							"<link rel='preload' href='https://example.com/main.js' as='script' />\n",
+				'urls'     => array(
+					array(
+						'href' => 'https://example.com/style.css',
+						'as'   => 'style',
+					),
+					array(
+						'href' => 'https://example.com/main.js',
+						'as'   => 'script',
+					),
+				),
+			),
+			'MIME_types'             => array(
+				'expected' => "<link rel='preload' href='https://example.com/style.css' as='style' />\n" .
+							"<link rel='preload' href='https://example.com/video.mp4' as='video' type='video/mp4' />\n" .
+							"<link rel='preload' href='https://example.com/main.js' as='script' />\n",
+				'urls'     => array(
+					array(
+						// Should ignore not valid attributes.
+						'not'  => 'valid',
+						'href' => 'https://example.com/style.css',
+						'as'   => 'style',
+					),
+					array(
+						'href' => 'https://example.com/video.mp4',
+						'as'   => 'video',
+						'type' => 'video/mp4',
+					),
+					array(
+						'href' => 'https://example.com/main.js',
+						'as'   => 'script',
+					),
+				),
+			),
+			'CORS'                   => array(
+				'expected' => "<link rel='preload' href='https://example.com/style.css' as='style' crossorigin='anonymous' />\n" .
+							"<link rel='preload' href='https://example.com/video.mp4' as='video' type='video/mp4' />\n" .
+							"<link rel='preload' href='https://example.com/main.js' as='script' />\n" .
+							"<link rel='preload' href='https://example.com/font.woff2' as='font' type='font/woff2' crossorigin />\n",
+				'urls'     => array(
+					array(
+						'href'        => 'https://example.com/style.css',
+						'as'          => 'style',
+						'crossorigin' => 'anonymous',
+					),
+					array(
+						'href' => 'https://example.com/video.mp4',
+						'as'   => 'video',
+						'type' => 'video/mp4',
+					),
+					array(
+						'href' => 'https://example.com/main.js',
+						'as'   => 'script',
+					),
+					array(
+						// Should ignore not valid attributes.
+						'ignore' => 'ignore',
+						'href'   => 'https://example.com/font.woff2',
+						'as'     => 'font',
+						'type'   => 'font/woff2',
+						'crossorigin',
+					),
+				),
+			),
+			'media'                  => array(
+				'expected' => "<link rel='preload' href='https://example.com/style.css' as='style' crossorigin='anonymous' />\n" .
+							"<link rel='preload' href='https://example.com/video.mp4' as='video' type='video/mp4' />\n" .
+							"<link rel='preload' href='https://example.com/main.js' as='script' />\n" .
+							"<link rel='preload' href='https://example.com/font.woff2' as='font' type='font/woff2' crossorigin />\n" .
+							"<link rel='preload' href='https://example.com/image-narrow.png' as='image' media='(max-width: 600px)' />\n" .
+							"<link rel='preload' href='https://example.com/image-wide.png' as='image' media='(min-width: 601px)' />\n",
+				'urls'     => array(
+					array(
+						'href'        => 'https://example.com/style.css',
+						'as'          => 'style',
+						'crossorigin' => 'anonymous',
+					),
+					array(
+						'href' => 'https://example.com/video.mp4',
+						'as'   => 'video',
+						'type' => 'video/mp4',
+					),
+					// Duplicated href should be ignored.
+					array(
+						'href' => 'https://example.com/video.mp4',
+						'as'   => 'video',
+						'type' => 'video/mp4',
+					),
+					array(
+						'href' => 'https://example.com/main.js',
+						'as'   => 'script',
+					),
+					array(
+						'href' => 'https://example.com/font.woff2',
+						'as'   => 'font',
+						'type' => 'font/woff2',
+						'crossorigin',
+					),
+					array(
+						'href'  => 'https://example.com/image-narrow.png',
+						'as'    => 'image',
+						'media' => '(max-width: 600px)',
+					),
+					array(
+						'href'  => 'https://example.com/image-wide.png',
+						'as'    => 'image',
+						'media' => '(min-width: 601px)',
+					),
+
+				),
+			),
+			'media_extra_attributes' => array(
+				'expected' => "<link rel='preload' href='https://example.com/style.css' as='style' crossorigin='anonymous' />\n" .
+							"<link rel='preload' href='https://example.com/video.mp4' as='video' type='video/mp4' />\n" .
+							"<link rel='preload' href='https://example.com/main.js' as='script' />\n" .
+							"<link rel='preload' href='https://example.com/font.woff2' as='font' type='font/woff2' crossorigin />\n" .
+							"<link rel='preload' href='https://example.com/image-640.png' as='image' imagesrcset='640.png 640w, 800.png 800w, 1024.png 1024w' imagesizes='100vw' />\n" .
+							"<link rel='preload' as='image' imagesrcset='640.png 640w, 800.png 800w, 1024.png 1024w' imagesizes='100vw' />\n" .
+							"<link rel='preload' href='https://example.com/image-wide.png' as='image' media='(min-width: 601px)' />\n" .
+							"<link rel='preload' href='https://example.com/image-800.png' as='image' imagesrcset='640.png 640w, 800.png 800w, 1024.png 1024w' />\n",
+				'urls'     => array(
+					array(
+						'href'        => 'https://example.com/style.css',
+						'as'          => 'style',
+						'crossorigin' => 'anonymous',
+					),
+					array(
+						'href' => 'https://example.com/video.mp4',
+						'as'   => 'video',
+						'type' => 'video/mp4',
+					),
+					array(
+						'href' => 'https://example.com/main.js',
+						'as'   => 'script',
+					),
+					array(
+						'href' => 'https://example.com/font.woff2',
+						'as'   => 'font',
+						'type' => 'font/woff2',
+						'crossorigin',
+					),
+					// imagesrcset only possible when using image, ignore.
+					array(
+						'href'        => 'https://example.com/font.woff2',
+						'as'          => 'font',
+						'type'        => 'font/woff2',
+						'imagesrcset' => '640.png 640w, 800.png 800w, 1024.png 1024w',
+					),
+					// imagesizes only possible when using image, ignore.
+					array(
+						'href'       => 'https://example.com/font.woff2',
+						'as'         => 'font',
+						'type'       => 'font/woff2',
+						'imagesizes' => '100vw',
+					),
+					// Duplicated href should be ignored.
+					array(
+						'href' => 'https://example.com/font.woff2',
+						'as'   => 'font',
+						'type' => 'font/woff2',
+						'crossorigin',
+					),
+					array(
+						'href'        => 'https://example.com/image-640.png',
+						'as'          => 'image',
+						'imagesrcset' => '640.png 640w, 800.png 800w, 1024.png 1024w',
+						'imagesizes'  => '100vw',
+					),
+					// Omit href so that unsupporting browsers won't request a useless image.
+					array(
+						'as'          => 'image',
+						'imagesrcset' => '640.png 640w, 800.png 800w, 1024.png 1024w',
+						'imagesizes'  => '100vw',
+					),
+					// Duplicated imagesrcset should be ignored.
+					array(
+						'as'          => 'image',
+						'imagesrcset' => '640.png 640w, 800.png 800w, 1024.png 1024w',
+						'imagesizes'  => '100vw',
+					),
+					array(
+						'href'  => 'https://example.com/image-wide.png',
+						'as'    => 'image',
+						'media' => '(min-width: 601px)',
+					),
+					// No href but not imagesrcset, should be ignored.
+					array(
+						'as'    => 'image',
+						'media' => '(min-width: 601px)',
+					),
+					// imagesizes is optional.
+					array(
+						'href'        => 'https://example.com/image-800.png',
+						'as'          => 'image',
+						'imagesrcset' => '640.png 640w, 800.png 800w, 1024.png 1024w',
+					),
+					// imagesizes should be ignored since imagesrcset not present.
+					array(
+						'href'       => 'https://example.com/image-640.png',
+						'as'         => 'image',
+						'imagesizes' => '100vw',
+					),
+				),
+			),
+		);
+	}
+
+}
diff --git a/tests/general/wpRequiredFieldIndicator.php b/tests/general/wpRequiredFieldIndicator.php
new file mode 100644
index 0000000000..bd66379a2a
--- /dev/null
+++ b/tests/general/wpRequiredFieldIndicator.php
@@ -0,0 +1,45 @@
+<?php
+/**
+ * Test wp_required_field_indicator().
+ *
+ * @group general
+ * @group template
+ *
+ * @covers ::wp_required_field_indicator
+ */
+class Tests_General_wpRequiredFieldIndicator extends WP_UnitTestCase {
+
+	/**
+	 * Tests that `wp_required_field_indicator()` returns the expected default value.
+	 *
+	 * @ticket 56389
+	 */
+	public function test_wp_required_field_indicator_should_return_default_value() {
+		$this->assertSame( '<span class="required">*</span>', wp_required_field_indicator() );
+	}
+
+	/**
+	 * Tests that `wp_required_field_indicator()` applies 'wp_required_field_indicator' filters.
+	 *
+	 * @ticket 56389
+	 */
+	public function test_wp_required_field_indicator_should_apply_wp_required_field_indicator_filters() {
+		$filter = new MockAction();
+		add_filter( 'wp_required_field_indicator', array( &$filter, 'filter' ) );
+
+		wp_required_field_indicator();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that the final return value of `wp_required_field_indicator()` is the result of
+	 * 'wp_required_field_indicator' filters.
+	 *
+	 * @ticket 56389
+	 */
+	public function test_wp_required_field_indicator_should_return_wp_required_field_indicator_filters() {
+		add_filter( 'wp_required_field_indicator', '__return_empty_string' );
+		$this->assertSame( '', wp_required_field_indicator() );
+	}
+}
diff --git a/tests/general/wpRequiredFieldMessage.php b/tests/general/wpRequiredFieldMessage.php
new file mode 100644
index 0000000000..2dc1a3b8b8
--- /dev/null
+++ b/tests/general/wpRequiredFieldMessage.php
@@ -0,0 +1,48 @@
+<?php
+/**
+ * Test wp_required_field_message().
+ *
+ * @group general
+ * @group template
+ *
+ * @covers ::wp_required_field_message
+ */
+class Tests_General_wpRequiredFieldMessage extends WP_UnitTestCase {
+
+	/**
+	 * Tests that `wp_required_field_message()` returns the expected default value.
+	 *
+	 * @ticket 56389
+	 */
+	public function test_wp_required_field_message_should_return_default_value() {
+		$expected  = '<span class="required-field-message">';
+		$expected .= 'Required fields are marked <span class="required">*</span>';
+		$expected .= '</span>';
+		$this->assertSame( $expected, wp_required_field_message() );
+	}
+
+	/**
+	 * Tests that `wp_required_field_message()` applies 'wp_required_field_message' filters.
+	 *
+	 * @ticket 56389
+	 */
+	public function test_wp_required_field_message_should_apply_wp_required_field_message_filters() {
+		$filter = new MockAction();
+		add_filter( 'wp_required_field_message', array( &$filter, 'filter' ) );
+
+		wp_required_field_message();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * Tests that the final return value of `wp_required_field_message()` is the result of
+	 * 'wp_required_field_message' filters.
+	 *
+	 * @ticket 56389
+	 */
+	public function test_wp_required_field_message_should_return_wp_required_field_message_filters() {
+		add_filter( 'wp_required_field_message', '__return_empty_string' );
+		$this->assertSame( '', wp_required_field_message() );
+	}
+}
diff --git a/tests/general/wpResourceHints.php b/tests/general/wpResourceHints.php
index 1761196b2c..03a4c024e0 100644
--- a/tests/general/wpResourceHints.php
+++ b/tests/general/wpResourceHints.php
@@ -30,17 +30,8 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 		parent::tear_down();
 	}
 
-	public function test_should_have_defaults_on_frontend() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n";
-
-		$this->expectOutputString( $expected );
-
-		wp_resource_hints();
-	}
-
 	public function test_dns_prefetching() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n" .
-					"<link rel='dns-prefetch' href='//wordpress.org' />\n" .
+		$expected = "<link rel='dns-prefetch' href='//wordpress.org' />\n" .
 					"<link rel='dns-prefetch' href='//google.com' />\n" .
 					"<link rel='dns-prefetch' href='//make.wordpress.org' />\n";
 
@@ -70,8 +61,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	 * @ticket 37652
 	 */
 	public function test_preconnect() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n" .
-					"<link rel='preconnect' href='//wordpress.org' />\n" .
+		$expected = "<link rel='preconnect' href='//wordpress.org' />\n" .
 					"<link rel='preconnect' href='https://make.wordpress.org' />\n" .
 					"<link rel='preconnect' href='http://google.com' />\n" .
 					"<link rel='preconnect' href='http://w.org' />\n";
@@ -98,8 +88,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	}
 
 	public function test_prerender() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n" .
-					"<link rel='prerender' href='https://make.wordpress.org/great-again' />\n" .
+		$expected = "<link rel='prerender' href='https://make.wordpress.org/great-again' />\n" .
 					"<link rel='prerender' href='http://jobs.wordpress.net' />\n" .
 					"<link rel='prerender' href='//core.trac.wordpress.org' />\n";
 
@@ -124,8 +113,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	}
 
 	public function test_parse_url_dns_prefetch() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n" .
-					"<link rel='dns-prefetch' href='//make.wordpress.org' />\n";
+		$expected = "<link rel='dns-prefetch' href='//make.wordpress.org' />\n";
 
 		add_filter( 'wp_resource_hints', array( $this, 'add_dns_prefetch_long_urls' ), 10, 2 );
 
@@ -145,8 +133,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	}
 
 	public function test_dns_prefetch_styles() {
-		$expected = "<link rel='dns-prefetch' href='//fonts.googleapis.com' />\n" .
-					"<link rel='dns-prefetch' href='//s.w.org' />\n";
+		$expected = "<link rel='dns-prefetch' href='//fonts.googleapis.com' />\n";
 
 		$args = array(
 			'family' => 'Open+Sans:400',
@@ -164,8 +151,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	}
 
 	public function test_dns_prefetch_scripts() {
-		$expected = "<link rel='dns-prefetch' href='//fonts.googleapis.com' />\n" .
-					"<link rel='dns-prefetch' href='//s.w.org' />\n";
+		$expected = "<link rel='dns-prefetch' href='//fonts.googleapis.com' />\n";
 
 		$args = array(
 			'family' => 'Open+Sans:400',
@@ -185,7 +171,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	 * @ticket 37385
 	 */
 	public function test_dns_prefetch_scripts_does_not_include_registered_only() {
-		$expected   = "<link rel='dns-prefetch' href='//s.w.org' />\n";
+		$expected   = '';
 		$unexpected = "<link rel='dns-prefetch' href='//wordpress.org' />\n";
 
 		wp_register_script( 'jquery-elsewhere', 'https://wordpress.org/wp-includes/js/jquery/jquery.js' );
@@ -202,7 +188,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	 * @ticket 37502
 	 */
 	public function test_deregistered_scripts_are_ignored() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n";
+		$expected = '';
 
 		wp_enqueue_script( 'test-script', 'http://example.org/script.js' );
 		wp_deregister_script( 'test-script' );
@@ -215,7 +201,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	 * @ticket 37652
 	 */
 	public function test_malformed_urls() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n";
+		$expected = '';
 
 		// Errant colon.
 		add_filter( 'wp_resource_hints', array( $this, 'add_malformed_url_errant_colon' ), 10, 2 );
@@ -250,8 +236,7 @@ class Tests_General_wpResourceHints extends WP_UnitTestCase {
 	 * @ticket 38121
 	 */
 	public function test_custom_attributes() {
-		$expected = "<link rel='dns-prefetch' href='//s.w.org' />\n" .
-					"<link rel='preconnect' href='https://make.wordpress.org' />\n" .
+		$expected = "<link rel='preconnect' href='https://make.wordpress.org' />\n" .
 					"<link crossorigin as='image' pr='0.5' href='https://example.com/foo.jpeg' rel='prefetch' />\n" .
 					"<link crossorigin='use-credentials' as='style' href='https://example.com/foo.css' rel='prefetch' />\n" .
 					"<link href='http://wordpress.org' rel='prerender' />\n";
diff --git a/tests/hooks/addFilter.php b/tests/hooks/addFilter.php
index 5890f22044..afa526b484 100644
--- a/tests/hooks/addFilter.php
+++ b/tests/hooks/addFilter.php
@@ -11,16 +11,33 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 
 	public $hook;
 
+	/**
+	 * Temporary storage for action output.
+	 *
+	 * Used in the following tests:
+	 * - `test_remove_and_add_action()`
+	 * - `test_remove_and_add_last_action()`
+	 * - `test_remove_and_recurse_and_add_action()`
+	 *
+	 * @var array
+	 */
+	private $action_output = '';
+
+	public function tear_down() {
+		$this->action_output = '';
+		parent::tear_down();
+	}
+
 	public function test_add_filter_with_function() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$function_index = _wp_filter_build_unique_id( $tag, $callback, $priority );
+		$function_index = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		$this->assertSame( $callback, $hook->callbacks[ $priority ][ $function_index ]['function'] );
 		$this->assertSame( $accepted_args, $hook->callbacks[ $priority ][ $function_index ]['accepted_args'] );
 	}
@@ -29,13 +46,13 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$function_index = _wp_filter_build_unique_id( $tag, $callback, $priority );
+		$function_index = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		$this->assertSame( $callback, $hook->callbacks[ $priority ][ $function_index ]['function'] );
 		$this->assertSame( $accepted_args, $hook->callbacks[ $priority ][ $function_index ]['accepted_args'] );
 	}
@@ -43,13 +60,13 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	public function test_add_filter_with_static_method() {
 		$callback      = array( 'MockAction', 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$function_index = _wp_filter_build_unique_id( $tag, $callback, $priority );
+		$function_index = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		$this->assertSame( $callback, $hook->callbacks[ $priority ][ $function_index ]['function'] );
 		$this->assertSame( $accepted_args, $hook->callbacks[ $priority ][ $function_index ]['accepted_args'] );
 	}
@@ -58,14 +75,14 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$callback_one  = '__return_null';
 		$callback_two  = '__return_false';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
-		$hook->add_filter( $tag, $callback_two, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority, $accepted_args );
 		$this->assertCount( 2, $hook->callbacks[ $priority ] );
 	}
 
@@ -73,14 +90,14 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 		$callback_one  = '__return_null';
 		$callback_two  = '__return_false';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
-		$hook->add_filter( $tag, $callback_two, $priority + 1, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 		$this->assertCount( 1, $hook->callbacks[ $priority + 1 ] );
 	}
@@ -88,48 +105,48 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	public function test_readd_filter() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 	}
 
 	public function test_readd_filter_with_different_priority() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 
-		$hook->add_filter( $tag, $callback, $priority + 1, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority + 1, $accepted_args );
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 		$this->assertCount( 1, $hook->callbacks[ $priority + 1 ] );
 	}
 
 	public function test_sort_after_add_filter() {
-		$a    = new MockAction();
-		$b    = new MockAction();
-		$c    = new MockAction();
-		$hook = new WP_Hook();
-		$tag  = __FUNCTION__;
+		$a         = new MockAction();
+		$b         = new MockAction();
+		$c         = new MockAction();
+		$hook      = new WP_Hook();
+		$hook_name = __FUNCTION__;
 
-		$hook->add_filter( $tag, array( $a, 'action' ), 10, 1 );
-		$hook->add_filter( $tag, array( $b, 'action' ), 5, 1 );
-		$hook->add_filter( $tag, array( $c, 'action' ), 8, 1 );
+		$hook->add_filter( $hook_name, array( $a, 'action' ), 10, 1 );
+		$hook->add_filter( $hook_name, array( $b, 'action' ), 5, 1 );
+		$hook->add_filter( $hook_name, array( $c, 'action' ), 8, 1 );
 
 		$this->assertSame( array( 5, 8, 10 ), array_keys( $hook->callbacks ) );
 	}
 
 	public function test_remove_and_add() {
-		$this->hook = new Wp_Hook();
+		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add', '__return_empty_string', 10, 0 );
 
@@ -143,7 +160,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	}
 
 	public function test_remove_and_add_last_filter() {
-		$this->hook = new Wp_Hook();
+		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add', '__return_empty_string', 10, 0 );
 
@@ -157,7 +174,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	}
 
 	public function test_remove_and_recurse_and_add() {
-		$this->hook = new Wp_Hook();
+		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add', '__return_empty_string', 10, 0 );
 
@@ -202,8 +219,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	}
 
 	public function test_remove_and_add_action() {
-		$this->hook          = new Wp_Hook();
-		$this->action_output = '';
+		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add_action', '__return_empty_string', 10, 0 );
 
@@ -217,8 +233,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	}
 
 	public function test_remove_and_add_last_action() {
-		$this->hook          = new Wp_Hook();
-		$this->action_output = '';
+		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add_action', '__return_empty_string', 10, 0 );
 
@@ -232,8 +247,7 @@ class Tests_Hooks_AddFilter extends WP_UnitTestCase {
 	}
 
 	public function test_remove_and_recurse_and_add_action() {
-		$this->hook          = new Wp_Hook();
-		$this->action_output = '';
+		$this->hook = new WP_Hook();
 
 		$this->hook->add_filter( 'remove_and_add_action', '__return_empty_string', 10, 0 );
 
diff --git a/tests/hooks/applyFilters.php b/tests/hooks/applyFilters.php
index fcb8e3b126..f25bd08582 100644
--- a/tests/hooks/applyFilters.php
+++ b/tests/hooks/applyFilters.php
@@ -12,12 +12,12 @@ class Tests_Hooks_ApplyFilters extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'filter' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
 		$returned = $hook->apply_filters( $arg, array( $arg ) );
 
@@ -29,12 +29,12 @@ class Tests_Hooks_ApplyFilters extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'filter' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
 		$returned_one = $hook->apply_filters( $arg, array( $arg ) );
 		$returned_two = $hook->apply_filters( $returned_one, array( $returned_one ) );
diff --git a/tests/hooks/doAction.php b/tests/hooks/doAction.php
index 0fb5652f3b..858917fdce 100644
--- a/tests/hooks/doAction.php
+++ b/tests/hooks/doAction.php
@@ -20,12 +20,12 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->do_action( array( $arg ) );
 
 		$this->assertSame( 1, $a->get_call_count() );
@@ -35,12 +35,12 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'filter' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->do_action( array( $arg ) );
 		$hook->do_action( array( $arg ) );
 
@@ -53,13 +53,13 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 		$callback_one  = array( $a, 'filter' );
 		$callback_two  = array( $b, 'filter' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
-		$hook->add_filter( $tag, $callback_two, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority, $accepted_args );
 		$hook->do_action( array( $arg ) );
 
 		$this->assertSame( 1, $a->get_call_count() );
@@ -72,13 +72,13 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 		$callback_one  = array( $a, 'filter' );
 		$callback_two  = array( $b, 'filter' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
-		$hook->add_filter( $tag, $callback_two, $priority + 1, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 		$hook->do_action( array( $arg ) );
 
 		$this->assertSame( 1, $a->get_call_count() );
@@ -88,12 +88,12 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 	public function test_do_action_with_no_accepted_args() {
 		$callback      = array( $this, '_action_callback' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
 		$accepted_args = 0;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->do_action( array( $arg ) );
 
 		$this->assertEmpty( $this->events[0]['args'] );
@@ -102,12 +102,12 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 	public function test_do_action_with_one_accepted_arg() {
 		$callback      = array( $this, '_action_callback' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
 		$accepted_args = 1;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->do_action( array( $arg ) );
 
 		$this->assertCount( 1, $this->events[0]['args'] );
@@ -116,12 +116,12 @@ class Tests_Hooks_DoAction extends WP_UnitTestCase {
 	public function test_do_action_with_more_accepted_args() {
 		$callback      = array( $this, '_action_callback' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 100;
 		$accepted_args = 1000;
 		$arg           = __FUNCTION__ . '_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$hook->do_action( array( $arg ) );
 
 		$this->assertCount( 1, $this->events[0]['args'] );
diff --git a/tests/hooks/doAllHook.php b/tests/hooks/doAllHook.php
index 29eec96428..bec1caa0e1 100644
--- a/tests/hooks/doAllHook.php
+++ b/tests/hooks/doAllHook.php
@@ -12,12 +12,12 @@ class Tests_Hooks_DoAllHook extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'action' );
 		$hook          = new WP_Hook();
-		$tag           = 'all';
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = 'all';
+		$priority      = 1;
+		$accepted_args = 2;
 		$arg           = 'all_arg';
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 		$args = array( $arg );
 		$hook->do_all_hook( $args );
 		$hook->do_all_hook( $args );
diff --git a/tests/hooks/hasFilter.php b/tests/hooks/hasFilter.php
index f9d48b3d4e..a13a16b390 100644
--- a/tests/hooks/hasFilter.php
+++ b/tests/hooks/hasFilter.php
@@ -11,48 +11,48 @@ class Tests_Hooks_HasFilter extends WP_UnitTestCase {
 	public function test_has_filter_with_function() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$this->assertSame( $priority, $hook->has_filter( $tag, $callback ) );
+		$this->assertSame( $priority, $hook->has_filter( $hook_name, $callback ) );
 	}
 
 	public function test_has_filter_with_object() {
 		$a             = new MockAction();
 		$callback      = array( $a, 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$this->assertSame( $priority, $hook->has_filter( $tag, $callback ) );
+		$this->assertSame( $priority, $hook->has_filter( $hook_name, $callback ) );
 	}
 
 	public function test_has_filter_with_static_method() {
 		$callback      = array( 'MockAction', 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$this->assertSame( $priority, $hook->has_filter( $tag, $callback ) );
+		$this->assertSame( $priority, $hook->has_filter( $hook_name, $callback ) );
 	}
 
 	public function test_has_filter_without_callback() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
 		$this->assertTrue( $hook->has_filter() );
 	}
@@ -63,22 +63,22 @@ class Tests_Hooks_HasFilter extends WP_UnitTestCase {
 	}
 
 	public function test_not_has_filter_with_callback() {
-		$callback = '__return_null';
-		$hook     = new WP_Hook();
-		$tag      = __FUNCTION__;
+		$callback  = '__return_null';
+		$hook      = new WP_Hook();
+		$hook_name = __FUNCTION__;
 
-		$this->assertFalse( $hook->has_filter( $tag, $callback ) );
+		$this->assertFalse( $hook->has_filter( $hook_name, $callback ) );
 	}
 
 	public function test_has_filter_with_wrong_callback() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
-		$this->assertFalse( $hook->has_filter( $tag, '__return_false' ) );
+		$this->assertFalse( $hook->has_filter( $hook_name, '__return_false' ) );
 	}
 }
diff --git a/tests/hooks/hasFilters.php b/tests/hooks/hasFilters.php
index f5c1e657fc..3cab1f6f47 100644
--- a/tests/hooks/hasFilters.php
+++ b/tests/hooks/hasFilters.php
@@ -11,11 +11,11 @@ class Tests_Hooks_HasFilters extends WP_UnitTestCase {
 	public function test_has_filters_with_callback() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
 		$this->assertTrue( $hook->has_filters() );
 	}
@@ -28,24 +28,24 @@ class Tests_Hooks_HasFilters extends WP_UnitTestCase {
 	public function test_not_has_filters_with_removed_callback() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
-		$hook->remove_filter( $tag, $callback, $priority );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$hook->remove_filter( $hook_name, $callback, $priority );
 		$this->assertFalse( $hook->has_filters() );
 	}
 
 	public function test_not_has_filter_with_directly_removed_callback() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
-		$function_key = _wp_filter_build_unique_id( $tag, $callback, $priority );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$function_key = _wp_filter_build_unique_id( $hook_name, $callback, $priority );
 		unset( $hook->callbacks[ $priority ][ $function_key ] );
 
 		$this->assertFalse( $hook->has_filters() );
diff --git a/tests/hooks/iterator.php b/tests/hooks/iterator.php
index 4840aa3d4d..cf91027e1f 100644
--- a/tests/hooks/iterator.php
+++ b/tests/hooks/iterator.php
@@ -12,12 +12,12 @@ class Tests_Hooks_Iterator extends WP_UnitTestCase {
 		$callback_one  = '__return_null';
 		$callback_two  = '__return_false';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
-		$hook->add_filter( $tag, $callback_two, $priority + 1, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 
 		$functions  = array();
 		$priorities = array();
diff --git a/tests/hooks/preinitHooks.php b/tests/hooks/preinitHooks.php
index 551d64400f..06cd5550c6 100644
--- a/tests/hooks/preinitHooks.php
+++ b/tests/hooks/preinitHooks.php
@@ -9,12 +9,12 @@
 class Tests_Hooks_PreinitHooks extends WP_UnitTestCase {
 
 	public function test_array_to_hooks() {
-		$tag1      = __FUNCTION__ . '_1';
-		$priority1 = rand( 1, 100 );
-		$tag2      = __FUNCTION__ . '_2';
-		$priority2 = rand( 1, 100 );
-		$filters   = array(
-			$tag1 => array(
+		$hook_name1 = __FUNCTION__ . '_1';
+		$priority1  = 1;
+		$hook_name2 = __FUNCTION__ . '_2';
+		$priority2  = 2;
+		$filters    = array(
+			$hook_name1 => array(
 				$priority1 => array(
 					'test1' => array(
 						'function'      => '__return_false',
@@ -22,7 +22,7 @@ class Tests_Hooks_PreinitHooks extends WP_UnitTestCase {
 					),
 				),
 			),
-			$tag2 => array(
+			$hook_name2 => array(
 				$priority2 => array(
 					'test1' => array(
 						'function'      => '__return_null',
@@ -34,7 +34,7 @@ class Tests_Hooks_PreinitHooks extends WP_UnitTestCase {
 
 		$hooks = WP_Hook::build_preinitialized_hooks( $filters );
 
-		$this->assertSame( $priority1, $hooks[ $tag1 ]->has_filter( $tag1, '__return_false' ) );
-		$this->assertSame( $priority2, $hooks[ $tag2 ]->has_filter( $tag2, '__return_null' ) );
+		$this->assertSame( $priority1, $hooks[ $hook_name1 ]->has_filter( $hook_name1, '__return_false' ) );
+		$this->assertSame( $priority2, $hooks[ $hook_name2 ]->has_filter( $hook_name2, '__return_null' ) );
 	}
 }
diff --git a/tests/hooks/removeAllFilters.php b/tests/hooks/removeAllFilters.php
index cfaf81f4c8..e4b0e78408 100644
--- a/tests/hooks/removeAllFilters.php
+++ b/tests/hooks/removeAllFilters.php
@@ -11,11 +11,11 @@ class Tests_Hooks_RemoveAllFilters extends WP_UnitTestCase {
 	public function test_remove_all_filters() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
 
 		$hook->remove_all_filters();
 
@@ -26,17 +26,17 @@ class Tests_Hooks_RemoveAllFilters extends WP_UnitTestCase {
 		$callback_one  = '__return_null';
 		$callback_two  = '__return_false';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
-		$hook->add_filter( $tag, $callback_two, $priority + 1, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 
 		$hook->remove_all_filters( $priority );
 
-		$this->assertFalse( $hook->has_filter( $tag, $callback_one ) );
+		$this->assertFalse( $hook->has_filter( $hook_name, $callback_one ) );
 		$this->assertTrue( $hook->has_filters() );
-		$this->assertSame( $priority + 1, $hook->has_filter( $tag, $callback_two ) );
+		$this->assertSame( $priority + 1, $hook->has_filter( $hook_name, $callback_two ) );
 	}
 }
diff --git a/tests/hooks/removeFilter.php b/tests/hooks/removeFilter.php
index 793cd02b3c..9a6f290bde 100644
--- a/tests/hooks/removeFilter.php
+++ b/tests/hooks/removeFilter.php
@@ -11,12 +11,12 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 	public function test_remove_filter_with_function() {
 		$callback      = '__return_null';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
-		$hook->remove_filter( $tag, $callback, $priority );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$hook->remove_filter( $hook_name, $callback, $priority );
 
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 	}
@@ -25,12 +25,12 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 		$a             = new MockAction();
 		$callback      = array( $a, 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
-		$hook->remove_filter( $tag, $callback, $priority );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$hook->remove_filter( $hook_name, $callback, $priority );
 
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 	}
@@ -38,12 +38,12 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 	public function test_remove_filter_with_static_method() {
 		$callback      = array( 'MockAction', 'action' );
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback, $priority, $accepted_args );
-		$hook->remove_filter( $tag, $callback, $priority );
+		$hook->add_filter( $hook_name, $callback, $priority, $accepted_args );
+		$hook->remove_filter( $hook_name, $callback, $priority );
 
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 	}
@@ -52,14 +52,14 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 		$callback_one  = '__return_null';
 		$callback_two  = '__return_false';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
-		$hook->add_filter( $tag, $callback_two, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority, $accepted_args );
 
-		$hook->remove_filter( $tag, $callback_one, $priority );
+		$hook->remove_filter( $hook_name, $callback_one, $priority );
 
 		$this->assertCount( 1, $hook->callbacks[ $priority ] );
 	}
@@ -68,14 +68,14 @@ class Tests_Hooks_RemoveFilter extends WP_UnitTestCase {
 		$callback_one  = '__return_null';
 		$callback_two  = '__return_false';
 		$hook          = new WP_Hook();
-		$tag           = __FUNCTION__;
-		$priority      = rand( 1, 100 );
-		$accepted_args = rand( 1, 100 );
+		$hook_name     = __FUNCTION__;
+		$priority      = 1;
+		$accepted_args = 2;
 
-		$hook->add_filter( $tag, $callback_one, $priority, $accepted_args );
-		$hook->add_filter( $tag, $callback_two, $priority + 1, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_one, $priority, $accepted_args );
+		$hook->add_filter( $hook_name, $callback_two, $priority + 1, $accepted_args );
 
-		$hook->remove_filter( $tag, $callback_one, $priority );
+		$hook->remove_filter( $hook_name, $callback_one, $priority );
 		$this->assertArrayNotHasKey( $priority, $hook->callbacks );
 		$this->assertCount( 1, $hook->callbacks[ $priority + 1 ] );
 	}
diff --git a/tests/http/functions.php b/tests/http/functions.php
index 43ec8fd12c..49854e0053 100644
--- a/tests/http/functions.php
+++ b/tests/http/functions.php
@@ -147,7 +147,7 @@ class Tests_HTTP_Functions extends WP_UnitTestCase {
 	 * @covers ::wp_remote_retrieve_cookie
 	 */
 	public function test_get_response_cookies_with_wp_http_cookie_object() {
-		$url = 'http://example.org';
+		$url = 'https://login.wordpress.org/wp-login.php';
 
 		$response = wp_remote_get(
 			$url,
@@ -183,7 +183,7 @@ class Tests_HTTP_Functions extends WP_UnitTestCase {
 	 * @covers ::wp_remote_retrieve_cookie
 	 */
 	public function test_get_response_cookies_with_name_value_array() {
-		$url = 'http://example.org';
+		$url = 'https://login.wordpress.org/wp-login.php';
 
 		$response = wp_remote_get(
 			$url,
diff --git a/tests/http/wpGetHttpHeaders.php b/tests/http/wpGetHttpHeaders.php
index 4b7b867a49..b462d7d8da 100644
--- a/tests/http/wpGetHttpHeaders.php
+++ b/tests/http/wpGetHttpHeaders.php
@@ -12,8 +12,8 @@ class Tests_HTTP_wpGetHttpHeaders extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
-		// Hook a fake HTTP request response.
-		add_filter( 'pre_http_request', array( $this, 'fake_http_request' ), 10, 3 );
+		// Hook a mocked HTTP request response.
+		add_filter( 'pre_http_request', array( $this, 'mock_http_request' ), 10, 3 );
 	}
 
 	/**
@@ -47,10 +47,9 @@ class Tests_HTTP_wpGetHttpHeaders extends WP_UnitTestCase {
 	 * @param bool   $false     False.
 	 * @param array  $arguments Request arguments.
 	 * @param string $url       Request URL.
-	 *
 	 * @return array|bool
 	 */
-	public function fake_http_request( $false, $arguments, $url ) {
+	public function mock_http_request( $false, $arguments, $url ) {
 		if ( 'http://example.com' === $url ) {
 			return array( 'headers' => true );
 		}
diff --git a/tests/image/editor.php b/tests/image/editor.php
index 487dad0664..d478dd6bf1 100644
--- a/tests/image/editor.php
+++ b/tests/image/editor.php
@@ -18,11 +18,20 @@ class Tests_Image_Editor extends WP_Image_UnitTestCase {
 		require_once ABSPATH . WPINC . '/class-wp-image-editor.php';
 
 		require_once DIR_TESTDATA . '/../includes/mock-image-editor.php';
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
 
 		// This needs to come after the mock image editor class is loaded.
 		parent::set_up();
 	}
 
+	/**
+	 * Tear down the class.
+	 */
+	public function tear_down() {
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+		parent::tear_down();
+	}
+
 	/**
 	 * Test wp_get_image_editor() where load returns true
 	 *
@@ -226,10 +235,10 @@ class Tests_Image_Editor extends WP_Image_UnitTestCase {
 		$this->assertSame( trailingslashit( realpath( get_temp_dir() ) ), trailingslashit( realpath( dirname( $editor->generate_filename( null, get_temp_dir() ) ) ) ) );
 
 		// Test with a suffix only.
-		$this->assertSame( 'canola-100x50.png', wp_basename( $editor->generate_filename( null, null, 'png' ) ) );
+		$this->assertSame( 'canola-100x50-jpg.png', wp_basename( $editor->generate_filename( null, null, 'png' ) ) );
 
 		// Combo!
-		$this->assertSame( trailingslashit( realpath( get_temp_dir() ) ) . 'canola-new.png', $editor->generate_filename( 'new', realpath( get_temp_dir() ), 'png' ) );
+		$this->assertSame( trailingslashit( realpath( get_temp_dir() ) ) . 'canola-new-jpg.png', $editor->generate_filename( 'new', realpath( get_temp_dir() ), 'png' ) );
 
 		// Test with a stream destination.
 		$this->assertSame( 'file://testing/path/canola-100x50.jpg', $editor->generate_filename( null, 'file://testing/path' ) );
diff --git a/tests/image/editorGd.php b/tests/image/editorGd.php
index 781ff96cb4..88dfb80299 100644
--- a/tests/image/editorGd.php
+++ b/tests/image/editorGd.php
@@ -17,6 +17,8 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 		require_once ABSPATH . WPINC . '/class-wp-image-editor.php';
 		require_once ABSPATH . WPINC . '/class-wp-image-editor-gd.php';
 
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+
 		// This needs to come after the mock image editor class is loaded.
 		parent::set_up();
 	}
@@ -30,6 +32,8 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 
 		$this->remove_added_uploads();
 
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+
 		parent::tear_down();
 	}
 
@@ -100,6 +104,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 50,
 				'height'    => 33,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-50x33.jpg' ),
 			),
 		);
 
@@ -300,6 +305,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 10,
 				'height'    => 7,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-10x7.jpg' ),
 			),
 
 			// #1
@@ -308,6 +314,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 75,
 				'height'    => 50,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-75x50.jpg' ),
 			),
 
 			// #2
@@ -316,6 +323,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 30,
 				'height'    => 20,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-30x20.jpg' ),
 			),
 
 			// #3
@@ -324,6 +332,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 45,
 				'height'    => 400,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-45x400.jpg' ),
 			),
 
 			// #4
@@ -332,6 +341,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 50,
 				'height'    => 33,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-50x33.jpg' ),
 			),
 
 			// #5
@@ -340,6 +350,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 55,
 				'height'    => 37,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-55x37.jpg' ),
 			),
 
 			// #6
@@ -348,6 +359,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 83,
 				'height'    => 55,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-83x55.jpg' ),
 			),
 
 			// #7
@@ -356,6 +368,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 90,
 				'height'    => 60,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-90x60.jpg' ),
 			),
 
 			// #8
@@ -364,6 +377,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 105,
 				'height'    => 70,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-105x70.jpg' ),
 			),
 
 			// #9
@@ -372,6 +386,7 @@ class Tests_Image_Editor_GD extends WP_Image_UnitTestCase {
 				'width'     => 200,
 				'height'    => 133,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-200x133.jpg' ),
 			),
 		);
 
diff --git a/tests/image/editorImagick.php b/tests/image/editorImagick.php
index e82486d828..a6698ec22c 100644
--- a/tests/image/editorImagick.php
+++ b/tests/image/editorImagick.php
@@ -18,6 +18,8 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 		require_once ABSPATH . WPINC . '/class-wp-image-editor-imagick.php';
 		require_once DIR_TESTROOT . '/includes/class-wp-test-stream.php';
 
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+
 		// This needs to come after the mock image editor class is loaded.
 		parent::set_up();
 	}
@@ -31,6 +33,8 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 
 		$this->remove_added_uploads();
 
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+
 		parent::tear_down();
 	}
 
@@ -90,6 +94,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 50,
 				'height'    => 33,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-50x33.jpg' ),
 			),
 		);
 
@@ -289,6 +294,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 10,
 				'height'    => 7,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-10x7.jpg' ),
 			),
 
 			// #1
@@ -297,6 +303,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 75,
 				'height'    => 50,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-75x50.jpg' ),
 			),
 
 			// #2
@@ -305,6 +312,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 30,
 				'height'    => 20,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-30x20.jpg' ),
 			),
 
 			// #3
@@ -313,6 +321,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 45,
 				'height'    => 400,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-45x400.jpg' ),
 			),
 
 			// #4
@@ -321,6 +330,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 50,
 				'height'    => 33,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-50x33.jpg' ),
 			),
 
 			// #5
@@ -329,6 +339,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 55,
 				'height'    => 37,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-55x37.jpg' ),
 			),
 
 			// #6
@@ -337,6 +348,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 83,
 				'height'    => 55,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-83x55.jpg' ),
 			),
 
 			// #7
@@ -345,6 +357,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 90,
 				'height'    => 60,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-90x60.jpg' ),
 			),
 
 			// #8
@@ -353,6 +366,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 105,
 				'height'    => 70,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-105x70.jpg' ),
 			),
 
 			// #9
@@ -361,6 +375,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 				'width'     => 200,
 				'height'    => 133,
 				'mime-type' => 'image/jpeg',
+				'filesize'  => wp_filesize( dirname( $file ) . '/waffles-200x133.jpg' ),
 			),
 		);
 
diff --git a/tests/image/functions.php b/tests/image/functions.php
index 8cd42a13b5..98b2608c87 100644
--- a/tests/image/functions.php
+++ b/tests/image/functions.php
@@ -8,7 +8,7 @@
 class Tests_Image_Functions extends WP_UnitTestCase {
 
 	/**
-	 * Setup test fixture
+	 * Includes the required files.
 	 */
 	public function set_up() {
 		parent::set_up();
@@ -25,10 +25,47 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		foreach ( glob( $folder ) as $file ) {
 			unlink( $file );
 		}
+
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+	}
+
+	/**
+	 * Tear down the class.
+	 */
+	public function tear_down() {
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+		parent::tear_down();
+	}
+
+	/**
+	 * Gets the available image editor engine classes.
+	 *
+	 * @return string[] Available image editor classes; empty array when none are available.
+	 */
+	private function get_image_editor_engine_classes() {
+		$classes = array( 'WP_Image_Editor_GD', 'WP_Image_Editor_Imagick' );
+
+		foreach ( $classes as $key => $class ) {
+			if ( ! call_user_func( array( $class, 'test' ) ) ) {
+				// If the image editor isn't available, skip it.
+				unset( $classes[ $key ] );
+			}
+		}
+
+		return $classes;
 	}
 
 	/**
-	 * Get the MIME type of a file
+	 * Data provider with the available image editor engine classes.
+	 *
+	 * @return array
+	 */
+	public function data_image_editor_engine_classes() {
+		return $this->text_array_to_dataprovider( $this->get_image_editor_engine_classes() );
+	}
+
+	/**
+	 * Gets the MIME type of a file.
 	 *
 	 * @param string $filename
 	 * @return string
@@ -45,12 +82,32 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		return $mime_type;
 	}
 
-	public function test_is_image_positive() {
+	/**
+	 * @dataProvider data_file_is_valid_image_positive
+	 *
+	 * @covers ::file_is_valid_image
+	 * @covers ::wp_getimagesize
+	 *
+	 * @param string $file File name.
+	 */
+	public function test_file_is_valid_image_positive( $file ) {
+		$this->assertTrue(
+			file_is_valid_image( DIR_TESTDATA . '/images/' . $file ),
+			"file_is_valid_image( '$file' ) should return true."
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_file_is_valid_image_positive() {
 		// These are all image files recognized by PHP.
 		$files = array(
 			'test-image-cmyk.jpg',
-			'test-image.bmp',
 			'test-image-grayscale.jpg',
+			'test-image.bmp',
 			'test-image.gif',
 			'test-image.png',
 			'test-image.tiff',
@@ -59,23 +116,37 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			'test-image.psd',
 			'test-image-zip.tiff',
 			'test-image.jpg',
+			'test-image.ico',
 			'webp-animated.webp',
 			'webp-lossless.webp',
 			'webp-lossy.webp',
 			'webp-transparent.webp',
 		);
 
-		// IMAGETYPE_ICO is only defined in PHP 5.3+.
-		if ( defined( 'IMAGETYPE_ICO' ) ) {
-			$files[] = 'test-image.ico';
-		}
+		return $this->text_array_to_dataprovider( $files );
+	}
 
-		foreach ( $files as $file ) {
-			$this->assertTrue( file_is_valid_image( DIR_TESTDATA . '/images/' . $file ), "file_is_valid_image($file) should return true" );
-		}
+	/**
+	 * @dataProvider data_file_is_valid_image_negative
+	 *
+	 * @covers ::file_is_valid_image
+	 * @covers ::wp_getimagesize
+	 *
+	 * @param string $file File name.
+	 */
+	public function test_file_is_valid_image_negative( $file ) {
+		$this->assertFalse(
+			file_is_valid_image( DIR_TESTDATA . '/images/' . $file ),
+			"file_is_valid_image( '$file' ) should return false."
+		);
 	}
 
-	public function test_is_image_negative() {
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_file_is_valid_image_negative() {
 		// These are actually image files but aren't recognized or usable by PHP.
 		$files = array(
 			'test-image.pct',
@@ -83,17 +154,35 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			'test-image.sgi',
 		);
 
-		foreach ( $files as $file ) {
-			$this->assertFalse( file_is_valid_image( DIR_TESTDATA . '/images/' . $file ), "file_is_valid_image($file) should return false" );
-		}
+		return $this->text_array_to_dataprovider( $files );
+	}
+
+	/**
+	 * @dataProvider data_file_is_displayable_image_positive
+	 *
+	 * @covers ::file_is_displayable_image
+	 *
+	 * @param string $file File name.
+	 */
+	public function test_file_is_displayable_image_positive( $file ) {
+		$this->assertTrue(
+			file_is_displayable_image( DIR_TESTDATA . '/images/' . $file ),
+			"file_is_displayable_image( '$file' ) should return true."
+		);
 	}
 
-	public function test_is_displayable_image_positive() {
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_file_is_displayable_image_positive() {
 		// These are all usable in typical web browsers.
 		$files = array(
 			'test-image.gif',
 			'test-image.png',
 			'test-image.jpg',
+			'test-image.ico',
 		);
 
 		// Add WebP images if the image editor supports them.
@@ -101,33 +190,40 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		$editor = wp_get_image_editor( $file );
 
 		if ( ! is_wp_error( $editor ) && $editor->supports_mime_type( 'image/webp' ) ) {
-			$files = array_merge(
-				$files,
-				array(
-					'webp-animated.webp',
-					'webp-lossless.webp',
-					'webp-lossy.webp',
-					'webp-transparent.webp',
-				)
-			);
+			$files[] = 'webp-animated.webp';
+			$files[] = 'webp-lossless.webp';
+			$files[] = 'webp-lossy.webp';
+			$files[] = 'webp-transparent.webp';
 		}
 
-		// IMAGETYPE_ICO is only defined in PHP 5.3+.
-		if ( defined( 'IMAGETYPE_ICO' ) ) {
-			$files[] = 'test-image.ico';
-		}
+		return $this->text_array_to_dataprovider( $files );
+	}
 
-		foreach ( $files as $file ) {
-			$this->assertTrue( file_is_displayable_image( DIR_TESTDATA . '/images/' . $file ), "file_is_valid_image($file) should return true" );
-		}
+	/**
+	 * @dataProvider data_file_is_displayable_image_negative
+	 *
+	 * @covers ::file_is_displayable_image
+	 *
+	 * @param string $file File name.
+	 */
+	public function test_file_is_displayable_image_negative( $file ) {
+		$this->assertFalse(
+			file_is_displayable_image( DIR_TESTDATA . '/images/' . $file ),
+			"file_is_displayable_image( '$file' ) should return false."
+		);
 	}
 
-	public function test_is_displayable_image_negative() {
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_file_is_displayable_image_negative() {
 		// These are image files but aren't suitable for web pages because of compatibility or size issues.
 		$files = array(
 			// 'test-image-cmyk.jpg',      Allowed in r9727.
-			// 'test-image.bmp',           Allowed in r28589.
 			// 'test-image-grayscale.jpg', Allowed in r9727.
+			// 'test-image.bmp',           Allowed in r28589.
 			'test-image.pct',
 			'test-image.tga',
 			'test-image.sgi',
@@ -138,11 +234,16 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			'test-image-zip.tiff',
 		);
 
-		foreach ( $files as $file ) {
-			$this->assertFalse( file_is_displayable_image( DIR_TESTDATA . '/images/' . $file ), "file_is_valid_image($file) should return false" );
-		}
+		return $this->text_array_to_dataprovider( $files );
 	}
 
+	/**
+	 * @ticket 50833
+	 * @requires extension gd
+	 */
+	public function test_is_gd_image_valid_types() {
+		$this->assertTrue( is_gd_image( imagecreate( 5, 5 ) ) );
+	}
 
 	/**
 	 * @ticket 50833
@@ -158,24 +259,58 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @ticket 50833
-	 * @requires extension gd
+	 * Tests wp_save_image_file() and mime types.
+	 *
+	 * @dataProvider data_wp_save_image_file
+	 *
+	 * @ticket 6821
+	 * @covers ::wp_save_image_file
+	 * @requires extension fileinfo
+	 *
+	 * @param string $class_name Name of the image editor engine class to be tested.
+	 * @param string $mime_type  The mime type to test.
 	 */
-	public function test_is_gd_image_valid_types() {
-		$this->assertTrue( is_gd_image( imagecreate( 5, 5 ) ) );
+	public function test_wp_save_image_file( $class_name, $mime_type ) {
+		require_once ABSPATH . 'wp-admin/includes/image-edit.php';
+
+		$img    = new $class_name( DIR_TESTDATA . '/images/canola.jpg' );
+		$loaded = $img->load();
+
+		$this->assertNotWPError( $loaded, 'Image failed to load - WP_Error returned.' );
+
+		if ( ! $img->supports_mime_type( $mime_type ) ) {
+			$this->markTestSkipped(
+				sprintf(
+					'The %s mime type is not supported by the %s engine.',
+					$mime_type,
+					str_replace( 'WP_Image_Editor_', '', $class_name )
+				)
+			);
+		}
+
+		// Save the file.
+		$file = wp_tempnam();
+		$ret  = wp_save_image_file( $file, $img, $mime_type, 1 );
+
+		// Make assertions.
+		$this->assertNotEmpty( $ret, 'Image failed to save - "empty" response returned.' );
+		$this->assertNotWPError( $ret, 'Image failed to save - WP_Error returned.' );
+		$this->assertSame( $mime_type, $this->get_mime_type( $ret['path'] ), 'Mime type of the saved image does not match.' );
+
+		// Clean up.
+		unlink( $file );
+		unlink( $ret['path'] );
+		unset( $img );
 	}
 
 	/**
-	 * Test save image file and mime_types
+	 * Data provider.
 	 *
-	 * @ticket 6821
-	 * @requires extension fileinfo
+	 * @return array
 	 */
-	public function test_wp_save_image_file() {
+	public function data_wp_save_image_file() {
 		$classes = $this->get_image_editor_engine_classes();
 
-		require_once ABSPATH . 'wp-admin/includes/image-edit.php';
-
 		// Mime types.
 		$mime_types = array(
 			'image/jpeg',
@@ -185,74 +320,108 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 
 		// Include WebP in tests when platform supports it.
 		if ( function_exists( 'imagewebp' ) ) {
-			array_push( $mime_types, 'image/webp' );
+			$mime_types[] = 'image/webp';
 		}
 
-		// Test each image editor engine.
-		foreach ( $classes as $class ) {
-			$img    = new $class( DIR_TESTDATA . '/images/canola.jpg' );
-			$loaded = $img->load();
+		$data = array();
 
-			// Save a file as each mime type, assert it works.
+		foreach ( $classes as $class ) {
 			foreach ( $mime_types as $mime_type ) {
-				if ( ! $img->supports_mime_type( $mime_type ) ) {
-					continue;
-				}
-
-				$file = wp_tempnam();
-				$ret  = wp_save_image_file( $file, $img, $mime_type, 1 );
-				$this->assertNotEmpty( $ret );
-				$this->assertNotWPError( $ret );
-				$this->assertSame( $mime_type, $this->get_mime_type( $ret['path'] ) );
-
-				// Clean up.
-				unlink( $file );
-				unlink( $ret['path'] );
+				$data[ $class . '; ' . $mime_type ] = array(
+					'class_name' => $class,
+					'mime_type'  => $mime_type,
+				);
 			}
-
-			// Clean up.
-			unset( $img );
 		}
+
+		return $data;
 	}
 
 	/**
-	 * Test that a passed mime type overrides the extension in the filename
+	 * Tests that a passed mime type overrides the extension in the filename when saving an image.
+	 *
+	 * @dataProvider data_image_editor_engine_classes
 	 *
 	 * @ticket 6821
+	 * @covers WP_Image_Editor::get_mime_type
+	 * @covers WP_Image_Editor::get_output_format
 	 * @requires extension fileinfo
+	 *
+	 * @param string $class_name Name of the image editor engine class to be tested.
 	 */
-	public function test_mime_overrides_filename() {
-		$classes = $this->get_image_editor_engine_classes();
+	public function test_mime_overrides_filename_when_saving_an_image( $class_name ) {
+		$img    = new $class_name( DIR_TESTDATA . '/images/canola.jpg' );
+		$loaded = $img->load();
 
-		// Test each image editor engine.
-		foreach ( $classes as $class ) {
-			$img    = new $class( DIR_TESTDATA . '/images/canola.jpg' );
-			$loaded = $img->load();
+		$this->assertNotWPError( $loaded, 'Image failed to load - WP_Error returned.' );
 
-			// Save the file.
-			$mime_type = 'image/gif';
-			$file      = wp_tempnam( 'tmp.jpg' );
-			$ret       = $img->save( $file, $mime_type );
+		// Save the file.
+		$mime_type = 'image/gif';
+		$file      = wp_tempnam( 'tmp.jpg' );
+		$ret       = $img->save( $file, $mime_type );
 
-			// Make assertions.
-			$this->assertNotEmpty( $ret );
-			$this->assertNotWPError( $ret );
-			$this->assertSame( $mime_type, $this->get_mime_type( $ret['path'] ) );
+		// Make assertions.
+		$this->assertNotEmpty( $ret, 'Image failed to save - "empty" response returned.' );
+		$this->assertNotWPError( $ret, 'Image failed to save - WP_Error returned.' );
+		$this->assertSame( $mime_type, $this->get_mime_type( $ret['path'] ), 'Mime type of the saved image did not override file name.' );
 
-			// Clean up.
-			unlink( $file );
-			unlink( $ret['path'] );
-			unset( $img );
-		}
+		// Clean up.
+		unlink( $file );
+		unlink( $ret['path'] );
+		unset( $img );
 	}
 
 	/**
-	 * Test that mime types are correctly inferred from file extensions
+	 * Tests that mime types are correctly inferred from file extensions when saving an image.
+	 *
+	 * @dataProvider data_inferred_mime_types_when_saving_an_image
 	 *
 	 * @ticket 6821
+	 * @covers WP_Image_Editor::get_mime_type
+	 * @covers WP_Image_Editor::get_output_format
 	 * @requires extension fileinfo
+	 *
+	 * @param string $class_name Name of the image editor engine class to be tested.
+	 * @param string $extension  File extension.
+	 * @param string $mime_type  The mime type to test.
+	 */
+	public function test_inferred_mime_types_when_saving_an_image( $class_name, $extension, $mime_type ) {
+		$img    = new $class_name( DIR_TESTDATA . '/images/canola.jpg' );
+		$loaded = $img->load();
+
+		$this->assertNotWPError( $loaded, 'Image failed to load - WP_Error returned.' );
+
+		if ( ! $img->supports_mime_type( $mime_type ) ) {
+			$this->markTestSkipped(
+				sprintf(
+					'The %s mime type is not supported by the %s engine.',
+					$mime_type,
+					str_replace( 'WP_Image_Editor_', '', $class_name )
+				)
+			);
+		}
+
+		// Save the file.
+		$temp = get_temp_dir();
+		$file = wp_unique_filename( $temp, uniqid() . ".$extension" );
+		$ret  = $img->save( trailingslashit( $temp ) . $file );
+
+		// Make assertions.
+		$this->assertNotEmpty( $ret, 'Image failed to save - "empty" response returned.' );
+		$this->assertNotWPError( $ret, 'Image failed to save - WP Error returned.' );
+		$this->assertSame( $mime_type, $this->get_mime_type( $ret['path'] ), 'Mime type of the saved image was not inferred correctly.' );
+
+		// Clean up.
+		unlink( $ret['path'] );
+		unset( $img );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
 	 */
-	public function test_inferred_mime_types() {
+	public function data_inferred_mime_types_when_saving_an_image() {
 		$classes = $this->get_image_editor_engine_classes();
 
 		// Mime types.
@@ -263,90 +432,71 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			'gif'  => 'image/gif',
 			'png'  => 'image/png',
 			'webp' => 'image/webp',
-			'unk'  => 'image/jpeg',   // Default, unknown.
+			'unk'  => 'image/jpeg', // Default, unknown.
 		);
 
-		// Test each image editor engine.
-		foreach ( $classes as $class ) {
-			$img    = new $class( DIR_TESTDATA . '/images/canola.jpg' );
-			$loaded = $img->load();
-
-			// Save the image as each file extension, check the mime type.
-			$img = wp_get_image_editor( DIR_TESTDATA . '/images/canola.jpg' );
-			$this->assertNotWPError( $img );
+		$data = array();
 
-			$temp = get_temp_dir();
+		foreach ( $classes as $class ) {
 			foreach ( $mime_types as $ext => $mime_type ) {
-				if ( ! $img->supports_mime_type( $mime_type ) ) {
-					continue;
-				}
-
-				$file = wp_unique_filename( $temp, uniqid() . ".$ext" );
-				$ret  = $img->save( trailingslashit( $temp ) . $file );
-				$this->assertNotEmpty( $ret );
-				$this->assertNotWPError( $ret );
-				$this->assertSame( $mime_type, $this->get_mime_type( $ret['path'] ) );
-				unlink( $ret['path'] );
+				$data[ $class . '; Extension: ' . $ext . '; Mime type: ' . $mime_type ] = array(
+					'class_name' => $class,
+					'extension'  => $ext,
+					'mime_type'  => $mime_type,
+				);
 			}
-
-			// Clean up.
-			unset( $img );
 		}
+
+		return $data;
 	}
 
 	/**
-	 * Try loading a directory
+	 * Tests that the deprecated wp_load_image() function fails when loading a directory.
 	 *
 	 * @ticket 17814
+	 * @covers ::wp_load_image
 	 * @expectedDeprecated wp_load_image
 	 */
-	public function test_load_directory() {
-
-		// First, test with deprecated wp_load_image function.
-		$editor1 = wp_load_image( DIR_TESTDATA );
-		$this->assertIsString( $editor1 );
-
-		$editor2 = wp_get_image_editor( DIR_TESTDATA );
-		$this->assertInstanceOf( 'WP_Error', $editor2 );
-
-		$classes = $this->get_image_editor_engine_classes();
-
-		// Then, test with editors.
-		foreach ( $classes as $class ) {
-			$editor = new $class( DIR_TESTDATA );
-			$loaded = $editor->load();
-
-			$this->assertInstanceOf( 'WP_Error', $loaded );
-			$this->assertSame( 'error_loading_image', $loaded->get_error_code() );
-		}
+	public function test_wp_load_image_should_fail_with_error_message_when_loading_a_directory() {
+		$editor = wp_load_image( DIR_TESTDATA );
+		$this->assertIsString( $editor );
 	}
 
 	/**
-	 * Get the available image editor engine class(es).
+	 * Tests that the wp_get_image_editor() function fails when loading a directory.
 	 *
-	 * @return string[] Available image editor classes; empty array when none are avaialble.
+	 * @ticket 17814
+	 * @covers ::wp_get_image_editor
 	 */
-	private function get_image_editor_engine_classes() {
-		$classes = array( 'WP_Image_Editor_GD', 'WP_Image_Editor_Imagick' );
-
-		foreach ( $classes as $key => $class ) {
-			if ( ! call_user_func( array( $class, 'test' ) ) ) {
-				// If the image editor isn't available, skip it.
-				unset( $classes[ $key ] );
-			}
-		}
+	public function test_wp_get_image_editor_should_fail_with_wp_error_object_when_loading_a_directory() {
+		$editor = wp_get_image_editor( DIR_TESTDATA );
+		$this->assertInstanceOf( 'WP_Error', $editor );
+	}
 
-		if ( empty( $classes ) ) {
-			$this->markTestSkipped( 'Image editor engines WP_Image_Editor_GD and WP_Image_Editor_Imagick are not supported on this system.' );
-		}
+	/**
+	 * Tests that the load() method in an image editor class fails when loading a directory.
+	 *
+	 * @dataProvider data_image_editor_engine_classes
+	 *
+	 * @ticket 17814
+	 * @covers WP_Image_Editor_GD::load
+	 * @covers WP_Image_Editor_Imagick::load
+	 *
+	 * @param string $class_name Name of the image editor engine class to be tested.
+	 */
+	public function test_image_editor_classes_should_fail_with_wp_error_object_when_loading_a_directory( $class_name ) {
+		$editor = new $class_name( DIR_TESTDATA );
+		$loaded = $editor->load();
 
-		return $classes;
+		$this->assertInstanceOf( 'WP_Error', $loaded, 'Loading a directory did not result in a WP_Error.' );
+		$this->assertSame( 'error_loading_image', $loaded->get_error_code(), 'Error code from WP_Error did not match expectation.' );
 	}
 
 	/**
+	 * @covers ::wp_crop_image
 	 * @requires function imagejpeg
 	 */
-	public function test_wp_crop_image_file() {
+	public function test_wp_crop_image_with_file() {
 		$file = wp_crop_image(
 			DIR_TESTDATA . '/images/canola.jpg',
 			0,
@@ -356,21 +506,24 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			100,
 			100
 		);
-		$this->assertNotWPError( $file );
-		$this->assertFileExists( $file );
+		$this->assertNotWPError( $file, 'Cropping the image resulted in a WP_Error.' );
+		$this->assertFileExists( $file, "The file $file does not exist." );
+
 		$image = wp_get_image_editor( $file );
 		$size  = $image->get_size();
-		$this->assertSame( 100, $size['height'] );
-		$this->assertSame( 100, $size['width'] );
+
+		$this->assertSame( 100, $size['height'], 'Cropped image height does not match expectation.' );
+		$this->assertSame( 100, $size['width'], 'Cropped image width does not match expectation.' );
 
 		unlink( $file );
 	}
 
 	/**
+	 * @covers ::wp_crop_image
 	 * @requires function imagejpeg
 	 * @requires extension openssl
 	 */
-	public function test_wp_crop_image_url() {
+	public function test_wp_crop_image_with_url() {
 		$file = wp_crop_image(
 			'https://asdftestblog1.files.wordpress.com/2008/04/canola.jpg',
 			0,
@@ -387,17 +540,22 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( 'Tests_Image_Functions::test_wp_crop_image_url() cannot access remote image.' );
 		}
 
-		$this->assertNotWPError( $file );
-		$this->assertFileExists( $file );
+		$this->assertNotWPError( $file, 'Cropping the image resulted in a WP_Error.' );
+		$this->assertFileExists( $file, "The file $file does not exist." );
+
 		$image = wp_get_image_editor( $file );
 		$size  = $image->get_size();
-		$this->assertSame( 100, $size['height'] );
-		$this->assertSame( 100, $size['width'] );
+
+		$this->assertSame( 100, $size['height'], 'Cropped image height does not match expectation.' );
+		$this->assertSame( 100, $size['width'], 'Cropped image width does not match expectation.' );
 
 		unlink( $file );
 	}
 
-	public function test_wp_crop_image_file_not_exist() {
+	/**
+	 * @covers ::wp_crop_image
+	 */
+	public function test_wp_crop_image_should_fail_with_wp_error_object_if_file_does_not_exist() {
 		$file = wp_crop_image(
 			DIR_TESTDATA . '/images/canoladoesnotexist.jpg',
 			0,
@@ -411,9 +569,10 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 	}
 
 	/**
+	 * @covers ::wp_crop_image
 	 * @requires extension openssl
 	 */
-	public function test_wp_crop_image_url_not_exist() {
+	public function test_wp_crop_image_should_fail_with_wp_error_object_if_url_does_not_exist() {
 		$file = wp_crop_image(
 			'https://asdftestblog1.files.wordpress.com/2008/04/canoladoesnotexist.jpg',
 			0,
@@ -426,16 +585,19 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		$this->assertInstanceOf( 'WP_Error', $file );
 	}
 
-	public function mock_image_editor( $editors ) {
-		return array( 'WP_Image_Editor_Mock' );
-	}
-
 	/**
 	 * @ticket 23325
+	 * @covers ::wp_crop_image
 	 */
-	public function test_wp_crop_image_error_on_saving() {
+	public function test_wp_crop_image_should_fail_with_wp_error_object_if_there_was_an_error_on_saving() {
 		WP_Image_Editor_Mock::$save_return = new WP_Error();
-		add_filter( 'wp_image_editors', array( $this, 'mock_image_editor' ) );
+
+		add_filter(
+			'wp_image_editors',
+			static function( $editors ) {
+				return array( 'WP_Image_Editor_Mock' );
+			}
+		);
 
 		$file = wp_crop_image(
 			DIR_TESTDATA . '/images/canola.jpg',
@@ -448,10 +610,37 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		);
 		$this->assertInstanceOf( 'WP_Error', $file );
 
-		remove_filter( 'wp_image_editors', array( $this, 'mock_image_editor' ) );
 		WP_Image_Editor_Mock::$save_return = array();
 	}
 
+	/**
+	 * @ticket 55403
+	 * @covers ::wp_crop_image
+	 */
+	public function test_wp_crop_image_should_return_correct_file_extension_if_output_format_was_modified() {
+		add_filter(
+			'image_editor_output_format',
+			static function() {
+				return array_fill_keys( array( 'image/jpg', 'image/jpeg', 'image/png' ), 'image/webp' );
+			}
+		);
+
+		$file = wp_crop_image(
+			DIR_TESTDATA . '/images/canola.jpg',
+			0,
+			0,
+			100,
+			100,
+			100,
+			100
+		);
+
+		$this->assertNotWPError( $file, 'Cropping the image resulted in a WP_Error.' );
+		$this->assertFileExists( $file, "The file $file does not exist." );
+
+		unlink( $file );
+	}
+
 	/**
 	 * @ticket 31050
 	 */
@@ -469,7 +658,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( $editor->get_error_message() );
 		}
 
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$test_file,
 			0,
 			array(
@@ -479,47 +668,54 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 
 		$this->assertNotEmpty( $attachment_id );
 
+		$temp_dir = get_temp_dir();
+
+		$metadata = wp_generate_attachment_metadata( $attachment_id, $test_file );
+
 		$expected = array(
-			'sizes' => array(
+			'sizes'    => array(
 				'full'      => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf.jpg',
 					'width'     => 1088,
 					'height'    => 1408,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf.jpg' ),
 				),
 				'medium'    => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf-232x300.jpg',
 					'width'     => 232,
 					'height'    => 300,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-232x300.jpg' ),
 				),
 				'large'     => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf-791x1024.jpg',
 					'width'     => 791,
 					'height'    => 1024,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-791x1024.jpg' ),
 				),
 				'thumbnail' => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf-116x150.jpg',
 					'width'     => 116,
 					'height'    => 150,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-116x150.jpg' ),
 				),
 			),
+			'filesize' => wp_filesize( $test_file ),
 		);
 
-		$metadata = wp_generate_attachment_metadata( $attachment_id, $test_file );
 		$this->assertSame( $expected, $metadata );
 
 		unlink( $test_file );
-		$temp_dir = get_temp_dir();
 		foreach ( $metadata['sizes'] as $size ) {
 			unlink( $temp_dir . $size['file'] );
 		}
 	}
 
 	/**
-	 * Crop setting for PDF.
+	 * Tests crop setting for PDF.
 	 *
 	 * @ticket 43226
 	 */
@@ -539,7 +735,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( $editor->get_error_message() );
 		}
 
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$test_file,
 			0,
 			array(
@@ -549,41 +745,49 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 
 		$this->assertNotEmpty( $attachment_id );
 
+		$temp_dir = get_temp_dir();
+
+		$metadata = wp_generate_attachment_metadata( $attachment_id, $test_file );
+
 		$expected = array(
-			'sizes' => array(
+			'sizes'    => array(
 				'full'      => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf.jpg',
 					'width'     => 1088,
 					'height'    => 1408,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf.jpg' ),
 				),
 				'medium'    => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf-300x300.jpg',
 					'width'     => 300,
 					'height'    => 300,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-300x300.jpg' ),
 				),
 				'large'     => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf-791x1024.jpg',
 					'width'     => 791,
 					'height'    => 1024,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-791x1024.jpg' ),
 				),
 				'thumbnail' => array(
 					'file'      => 'wordpress-gsoc-flyer-pdf-116x150.jpg',
 					'width'     => 116,
 					'height'    => 150,
 					'mime-type' => 'image/jpeg',
+					'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-116x150.jpg' ),
 				),
 			),
+			'filesize' => wp_filesize( $test_file ),
 		);
 
-		$metadata = wp_generate_attachment_metadata( $attachment_id, $test_file );
 		$this->assertSame( $expected, $metadata );
 
 		unlink( $test_file );
 		foreach ( $metadata['sizes'] as $size ) {
-			unlink( get_temp_dir() . $size['file'] );
+			unlink( $temp_dir . $size['file'] );
 		}
 	}
 
@@ -604,7 +808,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( $editor->get_error_message() );
 		}
 
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$test_file,
 			0,
 			array(
@@ -617,14 +821,21 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		add_image_size( 'test-size', 100, 100 );
 		add_filter( 'fallback_intermediate_image_sizes', array( $this, 'filter_fallback_intermediate_image_sizes' ), 10, 2 );
 
+		$metadata = wp_generate_attachment_metadata( $attachment_id, $test_file );
+
+		$temp_dir = get_temp_dir();
+
 		$expected = array(
 			'file'      => 'wordpress-gsoc-flyer-pdf-77x100.jpg',
 			'width'     => 77,
 			'height'    => 100,
 			'mime-type' => 'image/jpeg',
+			'filesize'  => wp_filesize( $temp_dir . 'wordpress-gsoc-flyer-pdf-77x100.jpg' ),
 		);
 
-		$metadata = wp_generate_attachment_metadata( $attachment_id, $test_file );
+		// Different environments produce slightly different filesize results.
+		$this->assertSame( $metadata['sizes']['test-size'], $expected );
+
 		$this->assertArrayHasKey( 'test-size', $metadata['sizes'], 'The `test-size` was not added to the metadata.' );
 		$this->assertSame( $expected, $metadata['sizes']['test-size'] );
 
@@ -632,7 +843,6 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 		remove_filter( 'fallback_intermediate_image_sizes', array( $this, 'filter_fallback_intermediate_image_sizes' ), 10 );
 
 		unlink( $test_file );
-		$temp_dir = get_temp_dir();
 		foreach ( $metadata['sizes'] as $size ) {
 			unlink( $temp_dir . $size['file'] );
 		}
@@ -646,7 +856,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test PDF preview doesn't overwrite existing JPEG.
+	 * Tests that PDF preview does not overwrite existing JPEG.
 	 *
 	 * @ticket 39875
 	 */
@@ -672,7 +882,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( $editor->get_error_message() );
 		}
 
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$pdf_path,
 			0,
 			array(
@@ -702,7 +912,7 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test for wp_exif_frac2dec verified that it properly handles edge cases
+	 * Tests that wp_exif_frac2dec() properly handles edge cases
 	 * and always returns an int or float, or 0 for failures.
 	 *
 	 * @param mixed     $fraction The fraction to convert.
diff --git a/tests/image/intermediateSize.php b/tests/image/intermediateSize.php
index b67e795163..deb72c11e0 100644
--- a/tests/image/intermediateSize.php
+++ b/tests/image/intermediateSize.php
@@ -5,6 +5,15 @@
  * @group upload
  */
 class Tests_Image_Intermediate_Size extends WP_UnitTestCase {
+	/**
+	 * Set up the test fixture.
+	 */
+	public function set_up() {
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+
+		parent::set_up();
+	}
+
 	public function tear_down() {
 		$this->remove_added_uploads();
 
@@ -12,6 +21,9 @@ class Tests_Image_Intermediate_Size extends WP_UnitTestCase {
 		remove_image_size( 'false-height' );
 		remove_image_size( 'false-width' );
 		remove_image_size( 'off-by-one' );
+
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+
 		parent::tear_down();
 	}
 
@@ -181,23 +193,23 @@ class Tests_Image_Intermediate_Size extends WP_UnitTestCase {
 	 * @requires function imagejpeg
 	 */
 	public function test_get_intermediate_sizes_by_array_zero_height() {
-		// Generate random width.
-		$random_w = rand( 300, 400 );
+		// Use this width.
+		$width = 300;
 
 		// Only one dimention match shouldn't return false positive (see: #17626).
-		add_image_size( 'test-size', $random_w, 0, false );
-		add_image_size( 'false-height', $random_w, 100, true );
+		add_image_size( 'test-size', $width, 0, false );
+		add_image_size( 'false-height', $width, 100, true );
 
 		$file = DIR_TESTDATA . '/images/waffles.jpg';
 		$id   = $this->_make_attachment( $file, 0 );
 
 		$original = wp_get_attachment_metadata( $id );
-		$image_w  = $random_w;
+		$image_w  = $width;
 		$image_h  = round( ( $image_w / $original['width'] ) * $original['height'] );
 
 		// Look for a size by array that exists.
 		// Note: Staying larger than 300px to miss default medium crop.
-		$image = image_get_intermediate_size( $id, array( $random_w, 0 ) );
+		$image = image_get_intermediate_size( $id, array( $width, 0 ) );
 
 		// Test for the expected string because the array will by definition
 		// return with the correct height and width attributes.
diff --git a/tests/image/resize.php b/tests/image/resize.php
index 12cf8eb7ad..8c448c842c 100644
--- a/tests/image/resize.php
+++ b/tests/image/resize.php
@@ -14,6 +14,15 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 		parent::set_up();
 
 		add_filter( 'wp_image_editors', array( $this, 'wp_image_editors' ) );
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+	}
+
+	/**
+	 * Tear down the class.
+	 */
+	public function tear_down() {
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+		parent::tear_down();
 	}
 
 	public function wp_image_editors() {
@@ -23,13 +32,14 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	public function test_resize_jpg() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/test-image.jpg', 25, 25 );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( 'test-image-25x25.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 25, $w );
 		$this->assertSame( 25, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_png() {
@@ -39,13 +49,14 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 			$this->fail( sprintf( 'No PNG support in the editor engine %s on this system.', $this->editor_engine ) );
 		}
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( 'test-image-25x25.png', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 25, $w );
 		$this->assertSame( 25, $h );
 		$this->assertSame( IMAGETYPE_PNG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_gif() {
@@ -55,13 +66,14 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 			$this->fail( sprintf( 'No GIF support in the editor engine %s on this system.', $this->editor_engine ) );
 		}
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( 'test-image-25x25.gif', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 25, $w );
 		$this->assertSame( 25, $h );
 		$this->assertSame( IMAGETYPE_GIF, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_webp() {
@@ -74,12 +86,15 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 		}
 
 		$image = $this->resize_helper( $file, 25, 25 );
+
+		list( $w, $h, $type ) = wp_getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( 'test-image-25x25.webp', wp_basename( $image ) );
-		list($w, $h, $type) = wp_getimagesize( $image );
 		$this->assertSame( 25, $w );
 		$this->assertSame( 25, $h );
 		$this->assertSame( IMAGETYPE_WEBP, $type );
-		unlink( $image );
 	}
 
 	public function test_resize_larger() {
@@ -93,73 +108,79 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	public function test_resize_thumb_128x96() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 128, 96 );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( '2007-06-17DSC_4173-64x96.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 64, $w );
 		$this->assertSame( 96, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_thumb_128x0() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 128, 0 );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( '2007-06-17DSC_4173-128x193.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 128, $w );
 		$this->assertSame( 193, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_thumb_0x96() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 0, 96 );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( '2007-06-17DSC_4173-64x96.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 64, $w );
 		$this->assertSame( 96, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_thumb_150x150_crop() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 150, 150, true );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( '2007-06-17DSC_4173-150x150.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 150, $w );
 		$this->assertSame( 150, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_thumb_150x100_crop() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 150, 100, true );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( '2007-06-17DSC_4173-150x100.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 150, $w );
 		$this->assertSame( 100, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	public function test_resize_thumb_50x150_crop() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 50, 150, true );
 
+		list( $w, $h, $type ) = getimagesize( $image );
+
+		unlink( $image );
+
 		$this->assertSame( '2007-06-17DSC_4173-50x150.jpg', wp_basename( $image ) );
-		list($w, $h, $type) = getimagesize( $image );
 		$this->assertSame( 50, $w );
 		$this->assertSame( 150, $h );
 		$this->assertSame( IMAGETYPE_JPEG, $type );
-
-		unlink( $image );
 	}
 
 	/**
@@ -185,6 +206,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 		}
 
 		$resized = $editor->resize( $width, $height, $crop );
+
 		if ( is_wp_error( $resized ) ) {
 			return $resized;
 		}
diff --git a/tests/import/import.php b/tests/import/import.php
index 1053b01dbb..0f4412fe11 100644
--- a/tests/import/import.php
+++ b/tests/import/import.php
@@ -33,6 +33,9 @@ class Tests_Import_Import extends WP_Import_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @covers WP_Import::import
+	 */
 	public function test_small_import() {
 		global $wpdb;
 
@@ -201,6 +204,9 @@ class Tests_Import_Import extends WP_Import_UnitTestCase {
 		$this->assertCount( 1, $cats );
 	}
 
+	/**
+	 * @covers WP_Import::import
+	 */
 	public function test_double_import() {
 		$authors = array(
 			'admin'  => false,
@@ -242,6 +248,9 @@ class Tests_Import_Import extends WP_Import_UnitTestCase {
 		$this->assertSame( 1, $comment_count->total_comments );
 	}
 
+	/**
+	 * @covers ::get_importers
+	 */
 	public function test_ordering_of_importers() {
 		global $wp_importers;
 		$_wp_importers = $wp_importers; // Preserve global state.
@@ -267,6 +276,8 @@ class Tests_Import_Import extends WP_Import_UnitTestCase {
 
 	/**
 	 * @ticket 21007
+	 *
+	 * @covers WP_Import::import
 	 */
 	public function test_slashes_should_not_be_stripped() {
 		global $wpdb;
diff --git a/tests/import/parser.php b/tests/import/parser.php
index 40ed789ac6..76dc3c1972 100644
--- a/tests/import/parser.php
+++ b/tests/import/parser.php
@@ -24,6 +24,10 @@ class Tests_Import_Parser extends WP_Import_UnitTestCase {
 		require_once DIR_TESTDATA . '/plugins/wordpress-importer/wordpress-importer.php';
 	}
 
+	/**
+	 * @covers WXR_Parser_SimpleXML::parse
+	 * @covers WXR_Parser_XML::parse
+	 */
 	public function test_malformed_wxr() {
 		$file = DIR_TESTDATA . '/export/malformed.xml';
 
@@ -36,6 +40,11 @@ class Tests_Import_Parser extends WP_Import_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @covers WXR_Parser_SimpleXML::parse
+	 * @covers WXR_Parser_XML::parse
+	 * @covers WXR_Parser_Regex::parse
+	 */
 	public function test_invalid_wxr() {
 		$f1 = DIR_TESTDATA . '/export/missing-version-tag.xml';
 		$f2 = DIR_TESTDATA . '/export/invalid-version-tag.xml';
@@ -50,6 +59,11 @@ class Tests_Import_Parser extends WP_Import_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @covers WXR_Parser_SimpleXML::parse
+	 * @covers WXR_Parser_XML::parse
+	 * @covers WXR_Parser_Regex::parse
+	 */
 	public function test_wxr_version_1_1() {
 		$file = DIR_TESTDATA . '/export/valid-wxr-1.1.xml';
 
@@ -143,6 +157,11 @@ class Tests_Import_Parser extends WP_Import_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @covers WXR_Parser_SimpleXML::parse
+	 * @covers WXR_Parser_XML::parse
+	 * @covers WXR_Parser_Regex::parse
+	 */
 	public function test_wxr_version_1_0() {
 		$file = DIR_TESTDATA . '/export/valid-wxr-1.0.xml';
 
@@ -236,6 +255,10 @@ class Tests_Import_Parser extends WP_Import_UnitTestCase {
 	 * sections that contain escaped closing tags ("]]>" -> "]]]]><![CDATA[>").
 	 *
 	 * @link https://core.trac.wordpress.org/ticket/15203
+	 *
+	 * @covers WXR_Parser_SimpleXML::parse
+	 * @covers WXR_Parser_XML::parse
+	 * @covers WXR_Parser_Regex::parse
 	 */
 	public function test_escaped_cdata_closing_sequence() {
 		$file = DIR_TESTDATA . '/export/crazy-cdata-escaped.xml';
@@ -269,6 +292,8 @@ class Tests_Import_Parser extends WP_Import_UnitTestCase {
 	/**
 	 * Ensure that the regex parser can still parse invalid CDATA blocks (i.e. those
 	 * with "]]>" unescaped within a CDATA section).
+	 *
+	 * @covers WXR_Parser_Regex::parse
 	 */
 	public function test_unescaped_cdata_closing_sequence() {
 		$file = DIR_TESTDATA . '/export/crazy-cdata.xml';
diff --git a/tests/import/postmeta.php b/tests/import/postmeta.php
index 0abd7f0a9d..bbe10deca9 100644
--- a/tests/import/postmeta.php
+++ b/tests/import/postmeta.php
@@ -4,6 +4,8 @@ require_once __DIR__ . '/base.php';
 
 /**
  * @group import
+ *
+ * @covers WP_Import::import
  */
 class Tests_Import_Postmeta extends WP_Import_UnitTestCase {
 	public function set_up() {
diff --git a/tests/includes/factory.php b/tests/includes/factory.php
index c1ab1c2a0d..98ab3f02e3 100644
--- a/tests/includes/factory.php
+++ b/tests/includes/factory.php
@@ -1,6 +1,12 @@
 <?php
 
 class TestFactoryFor extends WP_UnitTestCase {
+
+	/**
+	 * @var WP_UnitTest_Factory_For_Term
+	 */
+	private $category_factory;
+
 	public function set_up() {
 		parent::set_up();
 		$this->category_factory = new WP_UnitTest_Factory_For_Term( null, 'category' );
@@ -8,12 +14,12 @@ class TestFactoryFor extends WP_UnitTestCase {
 
 	public function test_create_creates_a_category() {
 		$id = $this->category_factory->create();
-		$this->assertTrue( (bool) get_term_by( 'id', $id, 'category' ) );
+		$this->assertInstanceOf( 'WP_Term', get_term_by( 'id', $id, 'category' ) );
 	}
 
 	public function test_get_object_by_id_gets_an_object() {
 		$id = $this->category_factory->create();
-		$this->assertTrue( (bool) $this->category_factory->get_object_by_id( $id ) );
+		$this->assertInstanceOf( 'WP_Term', $this->category_factory->get_object_by_id( $id ) );
 	}
 
 	public function test_get_object_by_id_gets_an_object_with_the_same_name() {
diff --git a/tests/kses.php b/tests/kses.php
index 7968dbecaa..7ec4a660ed 100644
--- a/tests/kses.php
+++ b/tests/kses.php
@@ -61,7 +61,6 @@ class Tests_Kses extends WP_UnitTestCase {
 	 *
 	 * @param string $string        Test string for kses.
 	 * @param string $expect_string Expected result after passing through kses.
-	 * @return void
 	 */
 	public function test_wp_filter_post_kses_a( $string, $expect_string ) {
 		global $allowedposttags;
@@ -169,7 +168,6 @@ class Tests_Kses extends WP_UnitTestCase {
 	 *
 	 * @param string $string        Test string for kses.
 	 * @param string $expect_string Expected result after passing through kses.
-	 * @return void
 	 */
 	public function test_wp_filter_post_kses_abbr( $string, $expect_string ) {
 		global $allowedposttags;
@@ -494,9 +492,12 @@ EOF;
 
 		foreach ( $tags as $tag ) {
 			$this->assertTrue( $tag['class'] );
+			$this->assertTrue( $tag['dir'] );
 			$this->assertTrue( $tag['id'] );
+			$this->assertTrue( $tag['lang'] );
 			$this->assertTrue( $tag['style'] );
 			$this->assertTrue( $tag['title'] );
+			$this->assertTrue( $tag['xml:lang'] );
 		}
 
 		$this->assertSame( $allowedtags, wp_kses_allowed_html( 'data' ) );
@@ -858,7 +859,7 @@ EOF;
 	/**
 	 * @ticket 34063
 	 */
-	public function test_bdo() {
+	public function test_bdo_tag_allowed() {
 		global $allowedposttags;
 
 		$input = '<p>This is <bdo dir="rtl">a BDO tag</bdo>. Weird, <bdo dir="ltr">right?</bdo></p>';
@@ -866,10 +867,21 @@ EOF;
 		$this->assertSame( $input, wp_kses( $input, $allowedposttags ) );
 	}
 
+	/**
+	 * @ticket 54698
+	 */
+	public function test_ruby_tag_allowed() {
+		global $allowedposttags;
+
+		$input = '<ruby>✶<rp>: </rp><rt>Star</rt><rp>, </rp><rt lang="fr">Étoile</rt><rp>.</rp></ruby>';
+
+		$this->assertSame( $input, wp_kses( $input, $allowedposttags ) );
+	}
+
 	/**
 	 * @ticket 35079
 	 */
-	public function test_ol_reversed() {
+	public function test_ol_reversed_attribute_allowed() {
 		global $allowedposttags;
 
 		$input = '<ol reversed="reversed"><li>Item 1</li><li>Item 2</li><li>Item 3</li></ol>';
@@ -923,6 +935,8 @@ EOF;
 	 * @ticket 37248
 	 * @ticket 42729
 	 * @ticket 48376
+	 * @ticket 55966
+	 * @ticket 56122
 	 * @dataProvider data_test_safecss_filter_attr
 	 *
 	 * @param string $css      A string of CSS rules.
@@ -1021,8 +1035,8 @@ EOF;
 			),
 			// `flex` and related attributes introduced in 5.3.
 			array(
-				'css'      => 'flex: 0 1 auto;flex-basis: 75%;flex-direction: row-reverse;flex-flow: row-reverse nowrap;flex-grow: 2;flex-shrink: 1',
-				'expected' => 'flex: 0 1 auto;flex-basis: 75%;flex-direction: row-reverse;flex-flow: row-reverse nowrap;flex-grow: 2;flex-shrink: 1',
+				'css'      => 'flex: 0 1 auto;flex-basis: 75%;flex-direction: row-reverse;flex-flow: row-reverse nowrap;flex-grow: 2;flex-shrink: 1;flex-wrap: nowrap',
+				'expected' => 'flex: 0 1 auto;flex-basis: 75%;flex-direction: row-reverse;flex-flow: row-reverse nowrap;flex-grow: 2;flex-shrink: 1;flex-wrap: nowrap',
 			),
 			// `grid` and related attributes introduced in 5.3.
 			array(
@@ -1108,6 +1122,148 @@ EOF;
 				'css'      => 'color: rgb( 100, 100, 100, .4 )',
 				'expected' => '',
 			),
+			// Allow min().
+			array(
+				'css'      => 'width: min(50%, 400px)',
+				'expected' => 'width: min(50%, 400px)',
+			),
+			// Allow max().
+			array(
+				'css'      => 'width: max(50%, 40rem)',
+				'expected' => 'width: max(50%, 40rem)',
+			),
+			// Allow minmax().
+			array(
+				'css'      => 'width: minmax(100px, 50%)',
+				'expected' => 'width: minmax(100px, 50%)',
+			),
+			// Allow clamp().
+			array(
+				'css'      => 'width: clamp(100px, 50%, 100vw)',
+				'expected' => 'width: clamp(100px, 50%, 100vw)',
+			),
+			// Allow two functions in the same CSS.
+			array(
+				'css'      => 'width: clamp(min(100px, 350px), 50%, 500px), 600px)',
+				'expected' => 'width: clamp(min(100px, 350px), 50%, 500px), 600px)',
+			),
+			// Allow gradient() function.
+			array(
+				'css'      => 'background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgba(0,212,255,1) 100%)',
+				'expected' => 'background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgba(0,212,255,1) 100%)',
+			),
+			// Combined CSS function names.
+			array(
+				'css'      => 'width: calcmax(100px + 50%)',
+				'expected' => '',
+			),
+			// Allow calc().
+			array(
+				'css'      => 'width: calc(2em + 3px)',
+				'expected' => 'width: calc(2em + 3px)',
+			),
+			// Allow calc() with nested brackets.
+			array(
+				'css'      => 'width: calc(3em + (10px * 2))',
+				'expected' => 'width: calc(3em + (10px * 2))',
+			),
+			// Allow var().
+			array(
+				'css'      => 'padding: var(--wp-var1) var(--wp-var2)',
+				'expected' => 'padding: var(--wp-var1) var(--wp-var2)',
+			),
+			// Allow var() with fallback (commas).
+			array(
+				'css'      => 'padding: var(--wp-var1, 10px)',
+				'expected' => 'padding: var(--wp-var1, 10px)',
+			),
+			// Allow var() with fallback (percentage).
+			array(
+				'css'      => 'padding: var(--wp-var1, 50%)',
+				'expected' => 'padding: var(--wp-var1, 50%)',
+			),
+			// Allow var() with fallback var().
+			array(
+				'css'      => 'background-color: var(--wp-var, var(--wp-var-fallback, pink))',
+				'expected' => 'background-color: var(--wp-var, var(--wp-var-fallback, pink))',
+			),
+			// Allow var() with square brackets.
+			array(
+				'css'      => 'background-color: var(--wp-var, [pink])',
+				'expected' => 'background-color: var(--wp-var, [pink])',
+			),
+			// Allow calc() with var().
+			array(
+				'css'      => 'margin-top: calc(var(--wp-var1) * 3 + 2em)',
+				'expected' => 'margin-top: calc(var(--wp-var1) * 3 + 2em)',
+			),
+			// Malformed min, no closing `)`.
+			array(
+				'css'      => 'width: min(3em + 10px',
+				'expected' => '',
+			),
+			// Malformed max, no closing `)`.
+			array(
+				'css'      => 'width: max(3em + 10px',
+				'expected' => '',
+			),
+			// Malformed minmax, no closing `)`.
+			array(
+				'css'      => 'width: minmax(3em + 10px',
+				'expected' => '',
+			),
+			// Malformed calc, no closing `)`.
+			array(
+				'css'      => 'width: calc(3em + 10px',
+				'expected' => '',
+			),
+			// Malformed var, no closing `)`.
+			array(
+				'css'      => 'width: var(--wp-var1',
+				'expected' => '',
+			),
+			// Malformed calc, mismatching brackets.
+			array(
+				'css'      => 'width: calc(3em + (10px * 2)',
+				'expected' => '',
+			),
+			// Malformed var, mismatching brackets.
+			array(
+				'css'      => 'background-color: var(--wp-var, var(--wp-var-fallback, pink)',
+				'expected' => '',
+			),
+			// Don't allow expressions outside of a calc().
+			array(
+				'css'      => 'width: (3em + (10px * 2))',
+				'expected' => '',
+			),
+			// Gap introduced in 6.1.
+			array(
+				'css'      => 'gap: 10px;column-gap: 5px;row-gap: 20px',
+				'expected' => 'gap: 10px;column-gap: 5px;row-gap: 20px',
+			),
+			// Margin and padding logical properties introduced in 6.1.
+			array(
+				'css'      => 'margin-block-start: 1px;margin-block-end: 2px;margin-inline-start: 3px;margin-inline-end: 4px;padding-block-start: 1px;padding-block-end: 2px;padding-inline-start: 3px;padding-inline-end: 4px',
+				'expected' => 'margin-block-start: 1px;margin-block-end: 2px;margin-inline-start: 3px;margin-inline-end: 4px;padding-block-start: 1px;padding-block-end: 2px;padding-inline-start: 3px;padding-inline-end: 4px',
+			),
+			// Assigning values to CSS variables introduced in 6.1.
+			array(
+				'css'      => '--wp--medium-width: 100px; --var_with_underscores: #cccccc;',
+				'expected' => '--wp--medium-width: 100px;--var_with_underscores: #cccccc',
+			),
+			array(
+				'css'      => '--miXeD-CAse: red; --with-numbers-3_56: red; --with-url-value: url("foo.jpg");',
+				'expected' => '--miXeD-CAse: red;--with-numbers-3_56: red;--with-url-value: url("foo.jpg")',
+			),
+			array(
+				'css'      => '--with-gradient: repeating-linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%);',
+				'expected' => '--with-gradient: repeating-linear-gradient(135deg,rgba(6,147,227,1) 0%,rgb(155,81,224) 100%)',
+			),
+			array(
+				'css'      => '--?><.%-not-allowed: red;',
+				'expected' => '',
+			),
 		);
 	}
 
@@ -1289,24 +1445,6 @@ EOF;
 				'background: red',
 			),
 
-			// CSS calc().
-			array(
-				'width: calc(2em + 3px)',
-				'width: calc(2em + 3px)',
-			),
-
-			// CSS variable.
-			array(
-				'padding: var(--wp-var1) var(--wp-var2)',
-				'padding: var(--wp-var1) var(--wp-var2)',
-			),
-
-			// CSS calc() with var().
-			array(
-				'margin-top: calc(var(--wp-var1) * 3 + 2em)',
-				'margin-top: calc(var(--wp-var1) * 3 + 2em)',
-			),
-
 			/*
 			 * Invalid use cases.
 			 */
@@ -1370,18 +1508,6 @@ EOF;
 				'background-image: url( "http://example.com );',
 				'',
 			),
-
-			// Malformed calc, no closing `)`.
-			array(
-				'width: calc(3em + 10px',
-				'',
-			),
-
-			// Malformed var, no closing `)`.
-			array(
-				'width: var(--wp-var1',
-				'',
-			),
 		);
 	}
 
@@ -1964,19 +2090,13 @@ HTML;
 	 * @return array
 	 */
 	public function data_kses_globals_are_defined() {
-		return array(
-			'allowedposttags'       => array(
-				'global' => 'allowedposttags',
-			),
-			'allowedtags'           => array(
-				'global' => 'allowedtags',
-			),
-			'allowedentitynames'    => array(
-				'global' => 'allowedentitynames',
-			),
-			'allowedxmlentitynames' => array(
-				'global' => 'allowedxmlentitynames',
-			),
+		$globals = array(
+			'allowedposttags',
+			'allowedtags',
+			'allowedentitynames',
+			'allowedxmlentitynames',
 		);
+
+		return $this->text_array_to_dataprovider( $globals );
 	}
 }
diff --git a/tests/l10n.php b/tests/l10n.php
index b31c165692..3d23dd7f20 100644
--- a/tests/l10n.php
+++ b/tests/l10n.php
@@ -17,12 +17,14 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35961
+	 *
+	 * @covers ::_n_noop
 	 */
 	public function test_n_noop() {
 		$text_domain   = 'text-domain';
 		$nooped_plural = _n_noop( '%s post', '%s posts', $text_domain );
 
-		$this->assertNotEmpty( $nooped_plural['domain'] );
+		$this->assertSame( 'text-domain', $nooped_plural['domain'] );
 		$this->assertSame( '%s posts', translate_nooped_plural( $nooped_plural, 0, $text_domain ) );
 		$this->assertSame( '%s post', translate_nooped_plural( $nooped_plural, 1, $text_domain ) );
 		$this->assertSame( '%s posts', translate_nooped_plural( $nooped_plural, 2, $text_domain ) );
@@ -30,13 +32,15 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35961
+	 *
+	 * @covers ::_nx_noop
 	 */
 	public function test_nx_noop() {
 		$text_domain   = 'text-domain';
 		$nooped_plural = _nx_noop( '%s post', '%s posts', 'my-context', $text_domain );
 
-		$this->assertNotEmpty( $nooped_plural['domain'] );
-		$this->assertNotEmpty( $nooped_plural['context'] );
+		$this->assertSame( 'text-domain', $nooped_plural['domain'] );
+		$this->assertSame( 'my-context', $nooped_plural['context'] );
 		$this->assertSame( '%s posts', translate_nooped_plural( $nooped_plural, 0, $text_domain ) );
 		$this->assertSame( '%s post', translate_nooped_plural( $nooped_plural, 1, $text_domain ) );
 		$this->assertSame( '%s posts', translate_nooped_plural( $nooped_plural, 2, $text_domain ) );
@@ -44,6 +48,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35073
+	 *
+	 * @covers ::before_last_bar
 	 */
 	public function test_before_last_bar() {
 		$this->assertSame( 'no-bar-at-all', before_last_bar( 'no-bar-at-all' ) );
@@ -53,6 +59,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35950
+	 *
+	 * @covers ::get_available_languages
 	 */
 	public function test_get_available_languages() {
 		$array = get_available_languages();
@@ -67,6 +75,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35284
+	 *
+	 * @covers ::wp_get_installed_translations
 	 */
 	public function test_wp_get_installed_translations_for_core() {
 		$installed_translations = wp_get_installed_translations( 'core' );
@@ -89,6 +99,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35294
+	 *
+	 * @covers ::wp_dropdown_languages
 	 */
 	public function test_wp_dropdown_languages() {
 		$args   = array(
@@ -111,6 +123,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38632
+	 *
+	 * @covers ::wp_dropdown_languages
 	 */
 	public function test_wp_dropdown_languages_site_default() {
 		$args   = array(
@@ -135,6 +149,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44494
+	 *
+	 * @covers ::wp_dropdown_languages
 	 */
 	public function test_wp_dropdown_languages_exclude_en_us() {
 		$args   = array(
@@ -153,6 +169,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38632
+	 *
+	 * @covers ::wp_dropdown_languages
 	 */
 	public function test_wp_dropdown_languages_en_US_selected() {
 		$args   = array(
@@ -175,6 +193,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * Add site default language to ja_JP in dropdown
+	 *
+	 * @covers ::wp_dropdown_languages
 	 */
 	public function test_wp_dropdown_languages_site_default_ja_JP() {
 		$args   = array(
@@ -199,6 +219,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * Select dropdown language from de_DE to ja_JP
+	 *
+	 * @covers ::wp_dropdown_languages
 	 */
 	public function test_wp_dropdown_languages_ja_JP_selected() {
 		$args   = array(
@@ -246,6 +268,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 35284
+	 *
+	 * @covers ::wp_get_pomo_file_data
 	 */
 	public function test_wp_get_pomo_file_data() {
 		$file  = DIR_TESTDATA . '/pomo/empty.po';
@@ -272,6 +296,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::the_excerpt
 	 */
 	public function test_length_of_excerpt_should_be_counted_by_words() {
 		global $post;
@@ -283,7 +309,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_excerpt' => '',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 		setup_postdata( $post );
 
 		$expect = "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat [&hellip;]</p>\n";
@@ -296,6 +322,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::the_excerpt
 	 */
 	public function test_length_of_excerpt_should_be_counted_by_chars() {
 		global $post;
@@ -307,7 +335,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_excerpt' => '',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 		setup_postdata( $post );
 
 		$expect = "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore  [&hellip;]</p>\n";
@@ -320,6 +348,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::the_excerpt
 	 */
 	public function test_length_of_excerpt_should_be_counted_by_chars_in_japanese() {
 		global $post;
@@ -331,7 +361,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_excerpt' => '',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 		setup_postdata( $post );
 
 		$expect = '<p>' . str_repeat( 'あ', 110 ) . " [&hellip;]</p>\n";
@@ -344,6 +374,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::the_excerpt_rss
 	 */
 	public function test_length_of_excerpt_rss_should_be_counted_by_words() {
 		global $post;
@@ -355,7 +387,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_excerpt' => '',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 		setup_postdata( $post );
 
 		$expect = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat [&#8230;]';
@@ -368,6 +400,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::the_excerpt_rss
 	 */
 	public function test_length_of_excerpt_rss_should_be_counted_by_chars() {
 		global $post;
@@ -379,7 +413,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_excerpt' => '',
 		);
 
-		$post = $this->factory()->post->create_and_get( $args );
+		$post = self::factory()->post->create_and_get( $args );
 		setup_postdata( $post );
 
 		$expect = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore  [&#8230;]';
@@ -393,6 +427,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::wp_dashboard_recent_drafts
 	 */
 	public function test_length_of_draft_should_be_counted_by_words() {
 		require_once ABSPATH . 'wp-admin/includes/dashboard.php';
@@ -405,7 +441,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_status'  => 'draft',
 		);
 
-		$this->factory()->post->create( $args );
+		self::factory()->post->create( $args );
 
 		$expect = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do&hellip;';
 		$this->expectOutputRegex( '/' . $expect . '/' );
@@ -417,6 +453,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::wp_dashboard_recent_drafts
 	 */
 	public function test_length_of_draft_should_be_counted_by_chars() {
 		require_once ABSPATH . 'wp-admin/includes/dashboard.php';
@@ -429,7 +467,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_status'  => 'draft',
 		);
 
-		$post = $this->factory()->post->create( $args );
+		$post = self::factory()->post->create( $args );
 
 		$expect = 'Lorem ipsum dolor sit amet, consectetur &hellip;';
 		$this->expectOutputRegex( '/' . $expect . '/' );
@@ -441,6 +479,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::wp_dashboard_recent_drafts
 	 */
 	public function test_length_of_draft_should_be_counted_by_chars_in_japanese() {
 		require_once ABSPATH . 'wp-admin/includes/dashboard.php';
@@ -453,7 +493,7 @@ class Tests_L10n extends WP_UnitTestCase {
 			'post_status'  => 'draft',
 		);
 
-		$this->factory()->post->create( $args );
+		self::factory()->post->create( $args );
 
 		$expect = str_repeat( 'あ', 40 ) . '&hellip;';
 		$this->expectOutputRegex( '/' . $expect . '/' );
@@ -465,6 +505,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::get_comment_excerpt
 	 */
 	public function test_length_of_comment_excerpt_should_be_counted_by_words() {
 		switch_to_locale( 'en_US' );
@@ -472,7 +514,7 @@ class Tests_L10n extends WP_UnitTestCase {
 		$args            = array(
 			'comment_content' => $this->long_text,
 		);
-		$comment_id      = $this->factory()->comment->create( $args );
+		$comment_id      = self::factory()->comment->create( $args );
 		$expect          = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut&hellip;';
 		$comment_excerpt = get_comment_excerpt( $comment_id );
 
@@ -483,6 +525,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::get_comment_excerpt
 	 */
 	public function test_length_of_comment_excerpt_should_be_counted_by_chars() {
 		switch_to_locale( 'ja_JP' );
@@ -490,7 +534,7 @@ class Tests_L10n extends WP_UnitTestCase {
 		$args            = array(
 			'comment_content' => $this->long_text,
 		);
-		$comment_id      = $this->factory()->comment->create( $args );
+		$comment_id      = self::factory()->comment->create( $args );
 		$expect          = 'Lorem ipsum dolor sit amet, consectetur &hellip;';
 		$comment_excerpt = get_comment_excerpt( $comment_id );
 
@@ -501,6 +545,8 @@ class Tests_L10n extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 44541
+	 *
+	 * @covers ::get_comment_excerpt
 	 */
 	public function test_length_of_comment_excerpt_should_be_counted_by_chars_in_Japanese() {
 		switch_to_locale( 'ja_JP' );
@@ -508,7 +554,7 @@ class Tests_L10n extends WP_UnitTestCase {
 		$args            = array(
 			'comment_content' => str_repeat( 'あ', 200 ),
 		);
-		$comment_id      = $this->factory()->comment->create( $args );
+		$comment_id      = self::factory()->comment->create( $args );
 		$expect          = str_repeat( 'あ', 40 ) . '&hellip;';
 		$comment_excerpt = get_comment_excerpt( $comment_id );
 
diff --git a/tests/l10n/getLocale.php b/tests/l10n/getLocale.php
index 5a212019b9..5044e6ea87 100644
--- a/tests/l10n/getLocale.php
+++ b/tests/l10n/getLocale.php
@@ -3,6 +3,8 @@
 /**
  * @group l10n
  * @group i18n
+ *
+ * @covers ::get_locale
  */
 class Tests_L10n_GetLocale extends WP_UnitTestCase {
 	public function test_should_respect_locale_global() {
diff --git a/tests/l10n/getUserLocale.php b/tests/l10n/getUserLocale.php
index aeefb72c78..91e98b63e1 100644
--- a/tests/l10n/getUserLocale.php
+++ b/tests/l10n/getUserLocale.php
@@ -3,6 +3,8 @@
 /**
  * @group l10n
  * @group i18n
+ *
+ * @covers ::get_user_locale
  */
 class Tests_L10n_GetUserLocale extends WP_UnitTestCase {
 	protected $user_id;
@@ -10,7 +12,7 @@ class Tests_L10n_GetUserLocale extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
-		$this->user_id = $this->factory()->user->create(
+		$this->user_id = self::factory()->user->create(
 			array(
 				'role'   => 'administrator',
 				'locale' => 'de_DE',
@@ -80,7 +82,7 @@ class Tests_L10n_GetUserLocale extends WP_UnitTestCase {
 	}
 
 	public function test_user_id_argument_with_id() {
-		$user_id = $this->factory()->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'locale' => 'es_ES',
 			)
@@ -97,7 +99,7 @@ class Tests_L10n_GetUserLocale extends WP_UnitTestCase {
 	}
 
 	public function test_user_id_argument_with_wp_user_object() {
-		$user_id = $this->factory()->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'locale' => 'es_ES',
 			)
diff --git a/tests/l10n/loadScriptTextdomain.php b/tests/l10n/loadScriptTextdomain.php
index 0cce2a1f2e..bc612d7471 100644
--- a/tests/l10n/loadScriptTextdomain.php
+++ b/tests/l10n/loadScriptTextdomain.php
@@ -3,6 +3,8 @@
 /**
  * @group l10n
  * @group i18n
+ *
+ * @covers ::load_script_textdomain
  */
 class Tests_L10n_LoadScriptTextdomain extends WP_UnitTestCase {
 
diff --git a/tests/l10n/loadTextdomain.php b/tests/l10n/loadTextdomain.php
index 079a4aec49..882cb9535f 100644
--- a/tests/l10n/loadTextdomain.php
+++ b/tests/l10n/loadTextdomain.php
@@ -24,6 +24,21 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 		add_filter( 'plugin_locale', array( $this, 'store_locale' ) );
 		add_filter( 'theme_locale', array( $this, 'store_locale' ) );
+
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_textdomain_registry;
+
+		$wp_textdomain_registry->reset();
+	}
+
+	public function tear_down() {
+
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_textdomain_registry;
+
+		$wp_textdomain_registry->reset();
+
+		parent::tear_down();
 	}
 
 	public function store_locale( $locale ) {
@@ -32,14 +47,23 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		return $locale;
 	}
 
+	/**
+	 * @covers ::is_textdomain_loaded
+	 */
 	public function test_is_textdomain_loaded() {
 		$this->assertFalse( is_textdomain_loaded( 'wp-tests-domain' ) );
 	}
 
+	/**
+	 * @covers ::unload_textdomain
+	 */
 	public function test_unload_textdomain() {
 		$this->assertFalse( unload_textdomain( 'wp-tests-domain' ) );
 	}
 
+	/**
+	 * @covers ::unload_textdomain
+	 */
 	public function test_load_textdomain() {
 		$loaded = load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/pomo/simple.mo' );
 
@@ -48,6 +72,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertTrue( $loaded );
 	}
 
+	/**
+	 * @covers ::unload_textdomain
+	 */
 	public function test_is_textdomain_loaded_after_loading() {
 		load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/pomo/simple.mo' );
 
@@ -58,12 +85,18 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertTrue( $loaded );
 	}
 
+	/**
+	 * @covers ::unload_textdomain
+	 */
 	public function test_unload_textdomain_after_loading() {
 		load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/pomo/simple.mo' );
 
 		$this->assertTrue( unload_textdomain( 'wp-tests-domain' ) );
 	}
 
+	/**
+	 * @covers ::is_textdomain_loaded
+	 */
 	public function test_is_textdomain_loaded_after_unloading() {
 		load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/pomo/simple.mo' );
 
@@ -74,6 +107,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21319
+	 *
+	 * @covers ::load_textdomain
 	 */
 	public function test_load_textdomain_non_existent_file() {
 		$this->assertFalse( load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/non-existent-file' ) );
@@ -81,6 +116,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21319
+	 *
+	 * @covers ::is_textdomain_loaded
 	 */
 	public function test_is_textdomain_loaded_non_existent_file() {
 		load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/non-existent-file' );
@@ -90,6 +127,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21319
+	 *
+	 * @covers ::get_translations_for_domain
 	 */
 	public function test_get_translations_for_domain_non_existent_file() {
 		load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/non-existent-file' );
@@ -99,6 +138,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21319
+	 *
+	 * @covers ::unload_textdomain
 	 */
 	public function test_unload_textdomain_non_existent_file() {
 		load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/non-existent-file' );
@@ -108,6 +149,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 21319
+	 *
+	 * @covers ::is_textdomain_loaded
 	 */
 	public function test_is_textdomain_is_not_loaded_after_gettext_call_with_no_translations() {
 		$this->assertFalse( is_textdomain_loaded( 'wp-tests-domain' ) );
@@ -115,6 +158,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertFalse( is_textdomain_loaded( 'wp-tests-domain' ) );
 	}
 
+	/**
+	 * @covers ::load_textdomain
+	 */
 	public function test_override_load_textdomain_noop() {
 		add_filter( 'override_load_textdomain', '__return_true' );
 		$load_textdomain = load_textdomain( 'wp-tests-domain', DIR_TESTDATA . '/non-existent-file' );
@@ -124,6 +170,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertFalse( is_textdomain_loaded( 'wp-tests-domain' ) );
 	}
 
+	/**
+	 * @covers ::load_textdomain
+	 */
 	public function test_override_load_textdomain_non_existent_mofile() {
 		add_filter( 'override_load_textdomain', array( $this, 'override_load_textdomain_filter' ), 10, 3 );
 		$load_textdomain = load_textdomain( 'wp-tests-domain', WP_LANG_DIR . '/non-existent-file.mo' );
@@ -138,6 +187,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertFalse( $is_textdomain_loaded_after );
 	}
 
+	/**
+	 * @covers ::load_textdomain
+	 */
 	public function test_override_load_textdomain_custom_mofile() {
 		add_filter( 'override_load_textdomain', array( $this, 'override_load_textdomain_filter' ), 10, 3 );
 		$load_textdomain = load_textdomain( 'wp-tests-domain', WP_LANG_DIR . '/plugins/internationalized-plugin-de_DE.mo' );
@@ -180,6 +232,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		return true;
 	}
 
+	/**
+	 * @covers ::load_muplugin_textdomain
+	 */
 	public function test_load_muplugin_textdomain_site_locale() {
 		load_muplugin_textdomain( 'wp-tests-domain' );
 
@@ -188,6 +243,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38485
+	 *
+	 * @covers ::load_muplugin_textdomain
 	 */
 	public function test_load_muplugin_textdomain_user_locale() {
 		set_current_screen( 'dashboard' );
@@ -198,6 +255,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertSame( get_user_locale(), $this->locale );
 	}
 
+	/**
+	 * @covers ::load_plugin_textdomain
+	 */
 	public function test_load_plugin_textdomain_site_locale() {
 		load_plugin_textdomain( 'wp-tests-domain' );
 
@@ -206,6 +266,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38485
+	 *
+	 * @covers ::load_plugin_textdomain
 	 */
 	public function test_load_plugin_textdomain_user_locale() {
 		set_current_screen( 'dashboard' );
@@ -216,6 +278,9 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 		$this->assertSame( get_user_locale(), $this->locale );
 	}
 
+	/**
+	 * @covers ::load_theme_textdomain
+	 */
 	public function test_load_theme_textdomain_site_locale() {
 		load_theme_textdomain( 'wp-tests-domain' );
 
@@ -224,6 +289,8 @@ class Tests_L10n_LoadTextdomain extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38485
+	 *
+	 * @covers ::load_theme_textdomain
 	 */
 	public function test_load_theme_textdomain_user_locale() {
 		set_current_screen( 'dashboard' );
diff --git a/tests/l10n/loadTextdomainJustInTime.php b/tests/l10n/loadTextdomainJustInTime.php
index eafcb134d4..2d3c480a5e 100644
--- a/tests/l10n/loadTextdomainJustInTime.php
+++ b/tests/l10n/loadTextdomainJustInTime.php
@@ -32,19 +32,23 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 		add_filter( 'stylesheet_root', array( $this, 'filter_theme_root' ) );
 		add_filter( 'template_root', array( $this, 'filter_theme_root' ) );
 		wp_clean_themes_cache();
-		unset( $GLOBALS['wp_themes'] );
-		unset( $GLOBALS['l10n'] );
-		unset( $GLOBALS['l10n_unloaded'] );
-		_get_path_to_translation( null, true );
+		unset( $GLOBALS['wp_themes'], $GLOBALS['l10n'], $GLOBALS['l10n_unloaded'] );
+
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_textdomain_registry;
+
+		$wp_textdomain_registry->reset();
 	}
 
 	public function tear_down() {
 		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
 		wp_clean_themes_cache();
-		unset( $GLOBALS['wp_themes'] );
-		unset( $GLOBALS['l10n'] );
-		unset( $GLOBALS['l10n_unloaded'] );
-		_get_path_to_translation( null, true );
+		unset( $GLOBALS['wp_themes'], $GLOBALS['l10n'], $GLOBALS['l10n_unloaded'] );
+
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_textdomain_registry;
+
+		$wp_textdomain_registry->reset();
 
 		parent::tear_down();
 	}
@@ -62,6 +66,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34114
+	 *
+	 * @covers ::is_textdomain_loaded
 	 */
 	public function test_plugin_translation_should_be_translated_without_calling_load_plugin_textdomain() {
 		add_filter( 'locale', array( $this, 'filter_set_locale_to_german' ) );
@@ -81,6 +87,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34114
+	 *
+	 * @covers ::is_textdomain_loaded
 	 */
 	public function test_theme_translation_should_be_translated_without_calling_load_theme_textdomain() {
 		add_filter( 'locale', array( $this, 'filter_set_locale_to_german' ) );
@@ -102,6 +110,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 34114
+	 *
+	 * @covers ::get_translations_for_domain
 	 */
 	public function test_get_translations_for_domain_does_not_return_null_if_override_load_textdomain_is_used() {
 		add_filter( 'locale', array( $this, 'filter_set_locale_to_german' ) );
@@ -115,6 +125,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 37113
+	 *
+	 * @covers ::is_textdomain_loaded
 	 */
 	public function test_should_allow_unloading_of_text_domain() {
 		add_filter( 'locale', array( $this, 'filter_set_locale_to_german' ) );
@@ -154,6 +166,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26511
+	 *
+	 * @covers ::switch_to_locale
 	 */
 	public function test_plugin_translation_after_switching_locale() {
 		require_once DIR_TESTDATA . '/plugins/internationalized-plugin.php';
@@ -167,6 +181,9 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 37997
+	 * @ticket 39210
+	 *
+	 * @covers ::switch_to_locale
 	 */
 	public function test_plugin_translation_after_switching_locale_twice() {
 		require_once DIR_TESTDATA . '/plugins/internationalized-plugin.php';
@@ -180,11 +197,13 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 		restore_current_locale();
 
 		$this->assertSame( 'Das ist ein Dummy Plugin', $actual_de_de );
-		$this->assertSame( 'This is a dummy plugin', $actual_es_es );
+		$this->assertSame( 'Este es un plugin dummy', $actual_es_es );
 	}
 
 	/**
 	 * @ticket 26511
+	 *
+	 * @covers ::switch_to_locale
 	 */
 	public function test_theme_translation_after_switching_locale() {
 		switch_theme( 'internationalized-theme' );
@@ -202,6 +221,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38485
+	 *
+	 * @covers ::wp_set_current_user
 	 */
 	public function test_plugin_translation_with_user_locale() {
 		require_once DIR_TESTDATA . '/plugins/internationalized-plugin.php';
@@ -216,6 +237,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38485
+	 *
+	 * @covers ::wp_set_current_user
 	 */
 	public function test_theme_translation_with_user_locale() {
 		switch_theme( 'internationalized-theme' );
@@ -233,6 +256,8 @@ class Tests_L10n_LoadTextdomainJustInTime extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 37997
+	 *
+	 * @covers ::_load_textdomain_just_in_time
 	 */
 	public function test_get_locale_is_called_only_once_per_textdomain() {
 		$textdomain = 'foo-bar-baz';
diff --git a/tests/l10n/translateSettingsUsingI18nSchema.php b/tests/l10n/translateSettingsUsingI18nSchema.php
index 94588491fa..62c84117a9 100644
--- a/tests/l10n/translateSettingsUsingI18nSchema.php
+++ b/tests/l10n/translateSettingsUsingI18nSchema.php
@@ -3,6 +3,8 @@
 /**
  * @group l10n
  * @group i18n
+ *
+ * @covers ::translate_settings_using_i18n_schema
  */
 class Tests_L10n_TranslateSettingsUsingI18nSchema extends WP_UnitTestCase {
 	/**
diff --git a/tests/l10n/wpLocaleSwitcher.php b/tests/l10n/wpLocaleSwitcher.php
index 7f769d4ea6..c1791d8c10 100644
--- a/tests/l10n/wpLocaleSwitcher.php
+++ b/tests/l10n/wpLocaleSwitcher.php
@@ -22,29 +22,44 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->locale          = '';
 		$this->previous_locale = '';
 
-		unset( $GLOBALS['l10n'] );
-		unset( $GLOBALS['l10n_unloaded'] );
-		_get_path_to_translation( null, true );
+		unset( $GLOBALS['l10n'], $GLOBALS['l10n_unloaded'] );
+
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_textdomain_registry;
+
+		$wp_textdomain_registry->reset();
 	}
 
 	public function tear_down() {
-		unset( $GLOBALS['l10n'] );
-		unset( $GLOBALS['l10n_unloaded'] );
-		_get_path_to_translation( null, true );
+		unset( $GLOBALS['l10n'], $GLOBALS['l10n_unloaded'] );
+
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_textdomain_registry;
+
+		$wp_textdomain_registry->reset();
 
 		parent::tear_down();
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_non_existent_locale_returns_false() {
 		$this->assertFalse( switch_to_locale( 'foo_BAR' ) );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_non_existent_locale_does_not_change_locale() {
 		switch_to_locale( 'foo_BAR' );
 
 		$this->assertSame( 'en_US', get_locale() );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_locale_returns_true() {
 		$expected = switch_to_locale( 'en_GB' );
 
@@ -54,6 +69,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertTrue( $expected );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_locale_changes_the_locale() {
 		switch_to_locale( 'en_GB' );
 
@@ -65,6 +83,11 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'en_GB', $locale );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 * @covers ::translate
+	 * @covers ::__
+	 */
 	public function test_switch_to_locale_loads_translation() {
 		switch_to_locale( 'es_ES' );
 
@@ -76,6 +99,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'Parámetro no válido. ', $actual );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_locale_changes_wp_locale_global() {
 		global $wp_locale;
 
@@ -94,6 +120,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSameSetsWithIndex( $expected, $wp_locale_de_de->number_format );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_locale_en_US() {
 		switch_to_locale( 'en_GB' );
 		$locale_en_gb = get_locale();
@@ -107,6 +136,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'en_US', $locale_en_us );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_locale_multiple_times() {
 		switch_to_locale( 'en_GB' );
 		switch_to_locale( 'es_ES' );
@@ -119,6 +151,11 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'es_ES', $locale );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 * @covers ::__
+	 * @covers ::translate
+	 */
 	public function test_switch_to_locale_multiple_times_loads_translation() {
 		switch_to_locale( 'en_GB' );
 		switch_to_locale( 'de_DE' );
@@ -134,10 +171,16 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'Parámetro no válido. ', $actual );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 */
 	public function test_restore_previous_locale_without_switching() {
 		$this->assertFalse( restore_previous_locale() );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 */
 	public function test_restore_previous_locale_changes_the_locale_back() {
 		switch_to_locale( 'en_GB' );
 
@@ -147,6 +190,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'en_US', get_locale() );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 */
 	public function test_restore_previous_locale_after_switching_multiple_times() {
 		switch_to_locale( 'en_GB' );
 		switch_to_locale( 'es_ES' );
@@ -160,6 +206,11 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'en_GB', $locale );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 * @covers ::__
+	 * @covers ::translate
+	 */
 	public function test_restore_previous_locale_restores_translation() {
 		switch_to_locale( 'es_ES' );
 		restore_previous_locale();
@@ -169,6 +220,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'Invalid parameter.', $actual );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 */
 	public function test_restore_previous_locale_action_passes_previous_locale() {
 		switch_to_locale( 'en_GB' );
 		switch_to_locale( 'es_ES' );
@@ -185,6 +239,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'es_ES', $previous_locale );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 */
 	public function test_restore_previous_locale_restores_wp_locale_global() {
 		global $wp_locale;
 
@@ -199,10 +256,16 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSameSetsWithIndex( $expected, $wp_locale->number_format );
 	}
 
+	/**
+	 * @covers ::restore_current_locale
+	 */
 	public function test_restore_current_locale_without_switching() {
 		$this->assertFalse( restore_current_locale() );
 	}
 
+	/**
+	 * @covers ::restore_previous_locale
+	 */
 	public function test_restore_current_locale_after_switching_multiple_times() {
 		switch_to_locale( 'en_GB' );
 		switch_to_locale( 'nl_NL' );
@@ -218,10 +281,16 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->previous_locale = $previous_locale;
 	}
 
+	/**
+	 * @covers ::is_locale_switched
+	 */
 	public function test_is_locale_switched_if_not_switched() {
 		$this->assertFalse( is_locale_switched() );
 	}
 
+	/**
+	 * @covers ::is_locale_switched
+	 */
 	public function test_is_locale_switched_original_locale() {
 		$original_locale = get_locale();
 
@@ -235,6 +304,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertTrue( $is_locale_switched );
 	}
 
+	/**
+	 * @covers ::is_locale_switched
+	 */
 	public function test_is_locale_switched() {
 		switch_to_locale( 'en_GB' );
 		switch_to_locale( 'nl_NL' );
@@ -246,12 +318,15 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertTrue( $is_locale_switched );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_site_locale_if_user_locale_is_set() {
 		global $l10n, $wp_locale_switcher;
 
 		$site_locale = get_locale();
 
-		$user_id = $this->factory()->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role'   => 'administrator',
 				'locale' => 'de_DE',
@@ -292,6 +367,9 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'de_DE', $language_header_after_restore );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 */
 	public function test_switch_to_different_site_locale_if_user_locale_is_set() {
 		global $l10n, $wp_locale_switcher;
 
@@ -300,7 +378,7 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 
 		$site_locale = get_locale();
 
-		$user_id = $this->factory()->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role'   => 'administrator',
 				'locale' => 'de_DE',
@@ -343,12 +421,16 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'de_DE', $language_header_after_restore );
 	}
 
+	/**
+	 * @covers ::switch_to_locale
+	 * @covers ::load_default_textdomain
+	 */
 	public function test_multiple_switches_to_site_locale_and_user_locale() {
 		global $wp_locale_switcher;
 
 		$site_locale = get_locale();
 
-		$user_id = $this->factory()->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role'   => 'administrator',
 				'locale' => 'en_GB',
@@ -382,6 +464,82 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'This is a dummy plugin', $actual );
 	}
 
+	/**
+	 * @ticket 39210
+	 */
+	public function test_switch_reloads_plugin_translations_outside_wp_lang_dir() {
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_locale_switcher, $wp_textdomain_registry;
+
+		$locale_switcher = clone $wp_locale_switcher;
+
+		$wp_locale_switcher = new WP_Locale_Switcher();
+		$wp_locale_switcher->init();
+
+		require_once DIR_TESTDATA . '/plugins/custom-internationalized-plugin/custom-internationalized-plugin.php';
+
+		$registry_value = $wp_textdomain_registry->get( 'custom-internationalized-plugin', determine_locale() );
+
+		$actual = custom_i18n_plugin_test();
+
+		switch_to_locale( 'es_ES' );
+		switch_to_locale( 'de_DE' );
+
+		$actual_de_de = custom_i18n_plugin_test();
+
+		restore_previous_locale();
+
+		$actual_es_es = custom_i18n_plugin_test();
+
+		restore_current_locale();
+
+		$wp_locale_switcher = $locale_switcher;
+
+		$this->assertSame( 'This is a dummy plugin', $actual );
+		$this->assertSame( WP_PLUGIN_DIR . '/custom-internationalized-plugin/languages/', $registry_value );
+		$this->assertSame( 'Das ist ein Dummy Plugin', $actual_de_de );
+		$this->assertSame( 'Este es un plugin dummy', $actual_es_es );
+	}
+
+	/**
+	 * @ticket 39210
+	 */
+	public function test_switch_reloads_theme_translations_outside_wp_lang_dir() {
+		/** @var WP_Textdomain_Registry $wp_textdomain_registry */
+		global $wp_locale_switcher, $wp_textdomain_registry;
+
+		$locale_switcher = clone $wp_locale_switcher;
+
+		$wp_locale_switcher = new WP_Locale_Switcher();
+		$wp_locale_switcher->init();
+
+		switch_theme( 'custom-internationalized-theme' );
+
+		require_once get_stylesheet_directory() . '/functions.php';
+
+		$registry_value = $wp_textdomain_registry->get( 'custom-internationalized-theme', determine_locale() );
+
+		$actual = custom_i18n_theme_test();
+
+		switch_to_locale( 'es_ES' );
+		switch_to_locale( 'de_DE' );
+
+		$actual_de_de = custom_i18n_theme_test();
+
+		restore_previous_locale();
+
+		$actual_es_es = custom_i18n_theme_test();
+
+		restore_current_locale();
+
+		$wp_locale_switcher = $locale_switcher;
+
+		$this->assertSame( get_template_directory() . '/languages/', $registry_value );
+		$this->assertSame( 'This is a dummy theme', $actual );
+		$this->assertSame( 'Das ist ein Dummy Theme', $actual_de_de );
+		$this->assertSame( 'Este es un tema dummy', $actual_es_es );
+	}
+
 	public function filter_locale() {
 		return 'es_ES';
 	}
diff --git a/tests/link/editTermLink.php b/tests/link/editTermLink.php
index 906014f067..3128ddfe0e 100644
--- a/tests/link/editTermLink.php
+++ b/tests/link/editTermLink.php
@@ -12,7 +12,7 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::register_custom_taxonomy();
 
-		$taxonomies = array( 'category', 'post_tag', 'custom_taxonomy' );
+		$taxonomies = array( 'category', 'post_tag', 'wptests_tax' );
 		foreach ( $taxonomies as $taxonomy ) {
 			self::$terms[ $taxonomy ] = $factory->term->create_and_get( array( 'taxonomy' => $taxonomy ) );
 		}
@@ -23,28 +23,35 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 
 	public function set_up() {
 		parent::set_up();
+		wp_set_current_user( self::$user_ids['admin'] );
 		self::register_custom_taxonomy();
 	}
 
 	/**
-	 * @dataProvider data_edit_term_link
+	 * Helper to register a custom taxonomy for use in tests.
 	 *
-	 * @ticket 50225
+	 * @since 5.9.0
+	 */
+	private static function register_custom_taxonomy() {
+		register_taxonomy( 'wptests_tax', 'post' );
+	}
+
+	/**
+	 * Helper to get the term for the given taxonomy.
+	 *
+	 * @since 5.9.0
 	 *
 	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
-	 * @param string $expected Expected URL within admin of edit link.
+	 * @param bool   $use_id   Whether to return term ID or term object.
+	 * @return WP_Term|int Term ID if `$use_id` is true, WP_Term instance otherwise.
 	 */
-	public function test_edit_term_link_for_permitted_user( $taxonomy, $use_id, $expected ) {
-		wp_set_current_user( self::$user_ids['admin'] );
-		$term = $this->get_term( $taxonomy, $use_id );
-
-		// Term IDs are not known by the data provider so need to be replaced.
-		$expected = str_replace( '%ID%', $use_id ? $term : $term->term_id, $expected );
-		$expected = '"' . admin_url( $expected ) . '"';
+	private function get_term( $taxonomy, $use_id ) {
+		$term = self::$terms[ $taxonomy ];
+		if ( $use_id ) {
+			$term = $term->term_id;
+		}
 
-		$this->assertStringContainsString( $expected, edit_term_link( '', '', '', $term, false ) );
-		$this->assertStringContainsString( $expected, edit_term_link( '', '', '', get_term( $term, $taxonomy ), false ) );
+		return $term;
 	}
 
 	/**
@@ -52,15 +59,18 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `edit_term_link()`.
+	 * @param string $expected Expected part of admin URL for the edit link.
 	 */
-	public function test_edit_term_link_for_denied_user( $taxonomy, $use_id ) {
-		wp_set_current_user( self::$user_ids['subscriber'] );
+	public function test_edit_term_link_should_return_the_link_for_permitted_user( $taxonomy, $use_id, $expected ) {
 		$term = $this->get_term( $taxonomy, $use_id );
 
-		$this->assertNull( edit_term_link( '', '', '', $term, false ) );
-		$this->assertNull( edit_term_link( '', '', '', get_term( $term, $taxonomy ), false ) );
+		// Term IDs are not known by the data provider so need to be replaced.
+		$expected = str_replace( '%ID%', $use_id ? $term : $term->term_id, $expected );
+		$expected = '"' . admin_url( $expected ) . '"';
+
+		$this->assertStringContainsString( $expected, edit_term_link( '', '', '', $term, false ) );
 	}
 
 	/**
@@ -68,23 +78,14 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `edit_term_link()`.
 	 */
-	public function test_edit_term_link_filter_is_int_by_term_id( $taxonomy, $use_id ) {
-		wp_set_current_user( self::$user_ids['admin'] );
+	public function test_edit_term_link_should_return_null_for_denied_user( $taxonomy, $use_id ) {
+		wp_set_current_user( self::$user_ids['subscriber'] );
 		$term = $this->get_term( $taxonomy, $use_id );
 
-		add_filter(
-			'edit_term_link',
-			function( $location, $term ) {
-				$this->assertIsInt( $term );
-			},
-			10,
-			2
-		);
-
-		edit_term_link( '', '', '', $term, false );
+		$this->assertNull( edit_term_link( '', '', '', $term, false ) );
 	}
 
 	/**
@@ -92,11 +93,10 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `edit_term_link()`.
 	 */
-	public function test_edit_term_link_filter_is_int_by_term_object( $taxonomy, $use_id ) {
-		wp_set_current_user( self::$user_ids['admin'] );
+	public function test_edit_term_link_filter_should_receive_term_id( $taxonomy, $use_id ) {
 		$term = $this->get_term( $taxonomy, $use_id );
 
 		add_filter(
@@ -108,7 +108,7 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 			2
 		);
 
-		edit_term_link( '', '', '', get_term( $term, $taxonomy ), false );
+		edit_term_link( '', '', '', $term, false );
 	}
 
 	/**
@@ -118,63 +118,36 @@ class Tests_Link_EditTermLink extends WP_UnitTestCase {
 	 */
 	public function data_edit_term_link() {
 		return array(
-			'category passing term_id'          => array(
-				'taxonomy' => 'category',
-				'use_id'   => false,
-				'expected' => 'term.php?taxonomy=category&tag_ID=%ID%&post_type=post',
-			),
-			'category passing term object'      => array(
+			'category passing term_id'              => array(
 				'taxonomy' => 'category',
 				'use_id'   => true,
 				'expected' => 'term.php?taxonomy=category&tag_ID=%ID%&post_type=post',
 			),
-			'post_tag passing term_id'          => array(
-				'taxonomy' => 'post_tag',
+			'category passing term object'          => array(
+				'taxonomy' => 'category',
 				'use_id'   => false,
-				'expected' => 'term.php?taxonomy=post_tag&tag_ID=%ID%&post_type=post',
+				'expected' => 'term.php?taxonomy=category&tag_ID=%ID%&post_type=post',
 			),
-			'post_tag passing term object'      => array(
+			'post_tag passing term_id'              => array(
 				'taxonomy' => 'post_tag',
 				'use_id'   => true,
 				'expected' => 'term.php?taxonomy=post_tag&tag_ID=%ID%&post_type=post',
 			),
-			'a custom taxonomy passing term_id' => array(
-				'taxonomy' => 'custom_taxonomy',
+			'post_tag passing term object'          => array(
+				'taxonomy' => 'post_tag',
 				'use_id'   => false,
-				'expected' => 'term.php?taxonomy=custom_taxonomy&tag_ID=%ID%&post_type=post',
+				'expected' => 'term.php?taxonomy=post_tag&tag_ID=%ID%&post_type=post',
 			),
-			'a custom taxonomy passing term_id' => array(
-				'taxonomy' => 'custom_taxonomy',
+			'a custom taxonomy passing term_id'     => array(
+				'taxonomy' => 'wptests_tax',
 				'use_id'   => true,
-				'expected' => 'term.php?taxonomy=custom_taxonomy&tag_ID=%ID%&post_type=post',
+				'expected' => 'term.php?taxonomy=wptests_tax&tag_ID=%ID%&post_type=post',
+			),
+			'a custom taxonomy passing term object' => array(
+				'taxonomy' => 'wptests_tax',
+				'use_id'   => false,
+				'expected' => 'term.php?taxonomy=wptests_tax&tag_ID=%ID%&post_type=post',
 			),
 		);
 	}
-
-	/**
-	 * Helper to register a custom taxonomy for use in tests.
-	 *
-	 * @since 5.9.0
-	 */
-	private static function register_custom_taxonomy() {
-		register_taxonomy( 'custom_taxonomy', 'post' );
-	}
-
-	/**
-	 * Helper to get the term for the given taxonomy.
-	 *
-	 * @since 5.9.0
-	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
-	 * @return WP_Term|int If $use_id is true, term ID is returned; else instance of WP_Term.
-	 */
-	private function get_term( $taxonomy, $use_id ) {
-		$term = self::$terms[ $taxonomy ];
-		if ( $use_id ) {
-			$term = $term->term_id;
-		}
-
-		return $term;
-	}
 }
diff --git a/tests/link/getEditTermLink.php b/tests/link/getEditTermLink.php
index 29a0466b24..2df1aa7aac 100644
--- a/tests/link/getEditTermLink.php
+++ b/tests/link/getEditTermLink.php
@@ -12,7 +12,7 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::register_custom_taxonomy();
 
-		$taxonomies = array( 'category', 'post_tag', 'custom_taxonomy' );
+		$taxonomies = array( 'category', 'post_tag', 'wptests_tax' );
 		foreach ( $taxonomies as $taxonomy ) {
 			self::$terms[ $taxonomy ] = $factory->term->create_and_get( array( 'taxonomy' => $taxonomy ) );
 		}
@@ -23,28 +23,121 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 
 	public function set_up() {
 		parent::set_up();
+		wp_set_current_user( self::$user_ids['admin'] );
 		self::register_custom_taxonomy();
 	}
 
 	/**
-	 * @dataProvider data_get_edit_term_link
+	 * Helper to register a custom taxonomy for use in tests.
 	 *
-	 * @ticket 50225
+	 * @since 5.9.0
+	 */
+	private static function register_custom_taxonomy() {
+		register_taxonomy( 'wptests_tax', 'post' );
+	}
+
+	/**
+	 * Helper to get the term for the given taxonomy.
+	 *
+	 * @since 5.9.0
 	 *
 	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
-	 * @param string $expected Expected URL within admin of edit link.
+	 * @param bool   $use_id   Whether to return term ID or term object.
+	 * @return WP_Term|int Term ID if `$use_id` is true, WP_Term instance otherwise.
 	 */
-	public function test_get_edit_term_link_for_permitted_user( $taxonomy, $use_id, $expected ) {
-		wp_set_current_user( self::$user_ids['admin'] );
-		$term = $this->get_term( $taxonomy, $use_id );
+	private function get_term( $taxonomy, $use_id ) {
+		$term = self::$terms[ $taxonomy ];
+		if ( $use_id ) {
+			$term = $term->term_id;
+		}
 
-		// Term IDs are not known by the data provider so need to be replaced.
-		$expected = str_replace( '%ID%', $use_id ? $term : $term->term_id, $expected );
-		$expected = admin_url( $expected );
+		return $term;
+	}
 
-		$this->assertSame( $expected, get_edit_term_link( $term, $taxonomy ) );
-		$this->assertSame( $expected, get_edit_term_link( get_term( $term, $taxonomy ), $taxonomy ) );
+	public function test_get_edit_term_link_default() {
+		$term1 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'name'     => 'foo',
+			)
+		);
+
+		$actual   = get_edit_term_link( $term1, 'wptests_tax' );
+		$expected = 'http://' . WP_TESTS_DOMAIN . '/wp-admin/term.php?taxonomy=wptests_tax&tag_ID=' . $term1 . '&post_type=post';
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 32786
+	 */
+	public function test_get_edit_term_link_invalid_id() {
+		$term1 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'name'     => 'foo',
+			)
+		);
+
+		$actual = get_edit_term_link( 12345, 'wptests_tax' );
+		$this->assertNull( $actual );
+	}
+
+	/**
+	 * @ticket 32786
+	 */
+	public function test_get_edit_term_link_empty_id() {
+		$actual = get_edit_term_link( '', 'wptests_tax' );
+		$this->assertNull( $actual );
+	}
+
+	/**
+	 * @ticket 32786
+	 */
+	public function test_get_edit_term_link_bad_tax() {
+		$actual = get_edit_term_link( '', 'bad_tax' );
+		$this->assertNull( $actual );
+	}
+
+	/**
+	 * @ticket 35922
+	 */
+	public function test_taxonomy_should_not_be_required() {
+		$t = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'name'     => 'foo',
+			)
+		);
+
+		$actual = get_edit_term_link( $t );
+		$this->assertNotNull( $actual );
+	}
+
+	/**
+	 * @ticket 35922
+	 */
+	public function test_cap_check_should_use_correct_taxonomy_when_taxonomy_is_not_specified() {
+		register_taxonomy(
+			'wptests_tax_subscriber',
+			'post',
+			array(
+				'capabilities' => array(
+					'edit_terms' => 'read',
+				),
+			)
+		);
+
+		$t = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax_subscriber',
+				'name'     => 'foo',
+			)
+		);
+
+		wp_set_current_user( self::$user_ids['subscriber'] );
+
+		$actual = get_edit_term_link( $t );
+		$this->assertNotNull( $actual );
 	}
 
 	/**
@@ -52,15 +145,18 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `get_edit_term_link()`.
+	 * @param string $expected Expected part of admin URL for the edit link.
 	 */
-	public function test_get_edit_term_link_for_denied_user( $taxonomy, $use_id ) {
-		wp_set_current_user( self::$user_ids['subscriber'] );
+	public function test_get_edit_term_link_should_return_the_link_for_permitted_user( $taxonomy, $use_id, $expected ) {
 		$term = $this->get_term( $taxonomy, $use_id );
 
-		$this->assertNull( get_edit_term_link( $term, $taxonomy ) );
-		$this->assertNull( get_edit_term_link( get_term( $term, $taxonomy ), $taxonomy ) );
+		// Term IDs are not known by the data provider so need to be replaced.
+		$expected = str_replace( '%ID%', $use_id ? $term : $term->term_id, $expected );
+		$expected = admin_url( $expected );
+
+		$this->assertSame( $expected, get_edit_term_link( $term, $taxonomy ) );
 	}
 
 	/**
@@ -68,23 +164,14 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `get_edit_term_link()`.
 	 */
-	public function test_get_edit_term_link_filter_is_int_by_term_id( $taxonomy, $use_id ) {
-		wp_set_current_user( self::$user_ids['admin'] );
+	public function test_get_edit_term_link_should_return_null_for_denied_user( $taxonomy, $use_id ) {
+		wp_set_current_user( self::$user_ids['subscriber'] );
 		$term = $this->get_term( $taxonomy, $use_id );
 
-		add_filter(
-			'get_edit_term_link',
-			function( $location, $term ) {
-				$this->assertIsInt( $term );
-			},
-			10,
-			2
-		);
-
-		get_edit_term_link( $term, $taxonomy );
+		$this->assertNull( get_edit_term_link( $term, $taxonomy ) );
 	}
 
 	/**
@@ -92,11 +179,10 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `get_edit_term_link()`.
 	 */
-	public function test_get_edit_term_link_filter_is_int_by_term_object( $taxonomy, $use_id ) {
-		wp_set_current_user( self::$user_ids['admin'] );
+	public function test_get_edit_term_link_filter_should_receive_term_id( $taxonomy, $use_id ) {
 		$term = $this->get_term( $taxonomy, $use_id );
 
 		add_filter(
@@ -108,7 +194,7 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 			2
 		);
 
-		get_edit_term_link( get_term( $term, $taxonomy ), $taxonomy );
+		get_edit_term_link( $term, $taxonomy );
 	}
 
 	/**
@@ -118,63 +204,36 @@ class Tests_Link_GetEditTermLink extends WP_UnitTestCase {
 	 */
 	public function data_get_edit_term_link() {
 		return array(
-			'category passing term_id'          => array(
-				'taxonomy' => 'category',
-				'use_id'   => false,
-				'expected' => 'term.php?taxonomy=category&tag_ID=%ID%&post_type=post',
-			),
-			'category passing term object'      => array(
+			'category passing term_id'              => array(
 				'taxonomy' => 'category',
 				'use_id'   => true,
 				'expected' => 'term.php?taxonomy=category&tag_ID=%ID%&post_type=post',
 			),
-			'post_tag passing term_id'          => array(
-				'taxonomy' => 'post_tag',
+			'category passing term object'          => array(
+				'taxonomy' => 'category',
 				'use_id'   => false,
-				'expected' => 'term.php?taxonomy=post_tag&tag_ID=%ID%&post_type=post',
+				'expected' => 'term.php?taxonomy=category&tag_ID=%ID%&post_type=post',
 			),
-			'post_tag passing term object'      => array(
+			'post_tag passing term_id'              => array(
 				'taxonomy' => 'post_tag',
 				'use_id'   => true,
 				'expected' => 'term.php?taxonomy=post_tag&tag_ID=%ID%&post_type=post',
 			),
-			'a custom taxonomy passing term_id' => array(
-				'taxonomy' => 'custom_taxonomy',
+			'post_tag passing term object'          => array(
+				'taxonomy' => 'post_tag',
 				'use_id'   => false,
-				'expected' => 'term.php?taxonomy=custom_taxonomy&tag_ID=%ID%&post_type=post',
+				'expected' => 'term.php?taxonomy=post_tag&tag_ID=%ID%&post_type=post',
 			),
-			'a custom taxonomy passing term_id' => array(
-				'taxonomy' => 'custom_taxonomy',
+			'a custom taxonomy passing term_id'     => array(
+				'taxonomy' => 'wptests_tax',
 				'use_id'   => true,
-				'expected' => 'term.php?taxonomy=custom_taxonomy&tag_ID=%ID%&post_type=post',
+				'expected' => 'term.php?taxonomy=wptests_tax&tag_ID=%ID%&post_type=post',
+			),
+			'a custom taxonomy passing term object' => array(
+				'taxonomy' => 'wptests_tax',
+				'use_id'   => false,
+				'expected' => 'term.php?taxonomy=wptests_tax&tag_ID=%ID%&post_type=post',
 			),
 		);
 	}
-
-	/**
-	 * Helper to register a custom taxonomy for use in tests.
-	 *
-	 * @since 5.9.0
-	 */
-	private static function register_custom_taxonomy() {
-		register_taxonomy( 'custom_taxonomy', 'post' );
-	}
-
-	/**
-	 * Helper to get the term for the given taxonomy.
-	 *
-	 * @since 5.9.0
-	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
-	 * @return WP_Term|int If $use_id is true, term ID is returned; else instance of WP_Term.
-	 */
-	private function get_term( $taxonomy, $use_id ) {
-		$term = self::$terms[ $taxonomy ];
-		if ( $use_id ) {
-			$term = $term->term_id;
-		}
-
-		return $term;
-	}
 }
diff --git a/tests/link/getPostPermalink.php b/tests/link/getPostPermalink.php
new file mode 100644
index 0000000000..16d1da0bea
--- /dev/null
+++ b/tests/link/getPostPermalink.php
@@ -0,0 +1,18 @@
+<?php
+/**
+ * @group link
+ * @covers ::get_post_permalink
+ */
+class Tests_Link_GetPostPermalink extends WP_UnitTestCase {
+
+	public function test_get_post_permalink_should_return_string_on_success() {
+		$post = self::factory()->post->create();
+
+		$this->assertIsString( get_post_permalink( $post ) );
+	}
+
+	public function test_get_post_permalink_should_return_false_for_non_existing_post() {
+		$this->assertFalse( get_post_permalink( -1 ) );
+	}
+
+}
diff --git a/tests/link/getPostTypeArchiveLink.php b/tests/link/getPostTypeArchiveLink.php
index e658b78725..7f3da3f30f 100644
--- a/tests/link/getPostTypeArchiveLink.php
+++ b/tests/link/getPostTypeArchiveLink.php
@@ -19,7 +19,7 @@ class Tests_Link_GetPostTypeArchiveLink extends WP_UnitTestCase {
 	 * @ticket 19902
 	 */
 	public function test_get_post_archive_link_with_post_archive_on_a_blog_page() {
-		$page_for_posts = $this->factory->post->create(
+		$page_for_posts = self::factory()->post->create(
 			array(
 				'post_title' => 'blog-page',
 				'post_type'  => 'page',
diff --git a/tests/link/getThePrivacyPolicyLink.php b/tests/link/getThePrivacyPolicyLink.php
index 97d321b805..942ae20c41 100644
--- a/tests/link/getThePrivacyPolicyLink.php
+++ b/tests/link/getThePrivacyPolicyLink.php
@@ -115,7 +115,7 @@ class Tests_Link_GetThePrivacyPolicyLink extends WP_UnitTestCase {
 	 * @ticket 44192
 	 */
 	public function test_function_should_return_empty_string_when_privacy_page_title_empty() {
-		$nameless_page_id = $this->factory->post->create(
+		$nameless_page_id = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => '',
diff --git a/tests/link/themeFile.php b/tests/link/themeFile.php
index 3e78a655e3..f988dc1006 100644
--- a/tests/link/themeFile.php
+++ b/tests/link/themeFile.php
@@ -144,8 +144,8 @@ class Tests_Link_ThemeFile extends WP_UnitTestCase {
 		$uri        = get_theme_file_uri( $file );
 		$parent_uri = get_parent_theme_file_uri( $file );
 
-		$this->assertSame( esc_url_raw( $uri ), $uri );
-		$this->assertSame( esc_url_raw( $parent_uri ), $parent_uri );
+		$this->assertSame( sanitize_url( $uri ), $uri );
+		$this->assertSame( sanitize_url( $parent_uri ), $parent_uri );
 	}
 
 	public function data_theme_files() {
diff --git a/tests/load/isLoginScreen.php b/tests/load/isLoginScreen.php
new file mode 100644
index 0000000000..d0cd1df9a6
--- /dev/null
+++ b/tests/load/isLoginScreen.php
@@ -0,0 +1,21 @@
+<?php
+
+/**
+ * Tests for is_login_screen().
+ *
+ * @group load.php
+ * @covers ::is_login_screen
+ */
+class Tests_Load_IsLoginScreen extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 19898
+	 */
+	public function test_is_login_screen() {
+		$this->assertFalse( is_login_screen() );
+
+		$_SERVER['SCRIPT_NAME'] = '/wp-login.php';
+
+		$this->assertTrue( is_login_screen() );
+	}
+}
diff --git a/tests/load/wpConvertHrToBytes.php b/tests/load/wpConvertHrToBytes.php
index 8275d260e4..66f4d4329b 100644
--- a/tests/load/wpConvertHrToBytes.php
+++ b/tests/load/wpConvertHrToBytes.php
@@ -4,6 +4,7 @@
  * Tests for wp_convert_hr_to_bytes().
  *
  * @group load.php
+ *
  * @covers ::wp_convert_hr_to_bytes
  */
 class Tests_Load_wpConvertHrToBytes extends WP_UnitTestCase {
diff --git a/tests/load/wpIsIniValueChangeable.php b/tests/load/wpIsIniValueChangeable.php
index f92ea43d51..6b73bb9e5f 100644
--- a/tests/load/wpIsIniValueChangeable.php
+++ b/tests/load/wpIsIniValueChangeable.php
@@ -4,6 +4,7 @@
  * Tests for wp_is_ini_value_changeable().
  *
  * @group load.php
+ *
  * @covers ::wp_is_ini_value_changeable
  */
 class Tests_Load_wpIsIniValueChangeable extends WP_UnitTestCase {
@@ -40,7 +41,7 @@ class Tests_Load_wpIsIniValueChangeable extends WP_UnitTestCase {
 			array( 'upload_tmp_dir', false ), // PHP_INI_SYSTEM.
 		);
 
-		if ( extension_loaded( 'Tidy' ) && version_compare( PHP_VERSION, '7.0.0', '>' ) ) {
+		if ( PHP_VERSION_ID > 70000 && extension_loaded( 'Tidy' ) ) {
 			$array[] = array( 'tidy.clean_output', true ); // PHP_INI_USER.
 		}
 
diff --git a/tests/locale.php b/tests/locale.php
index a89a3034b6..2e7daa87e1 100644
--- a/tests/locale.php
+++ b/tests/locale.php
@@ -15,6 +15,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->locale = new WP_Locale();
 	}
 
+	/**
+	 * @covers WP_Locale::get_weekday
+	 */
 	public function test_get_weekday() {
 		$this->assertSame( __( 'Sunday' ), $this->locale->get_weekday( 0 ) );
 		$this->assertSame( __( 'Monday' ), $this->locale->get_weekday( 1 ) );
@@ -25,6 +28,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'Saturday' ), $this->locale->get_weekday( 6 ) );
 	}
 
+	/**
+	 * @covers WP_Locale::get_weekday
+	 */
 	public function test_get_weekday_undefined_index() {
 		if ( PHP_VERSION_ID >= 80000 ) {
 			$this->expectWarning();
@@ -35,6 +41,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->locale->get_weekday( 7 );
 	}
 
+	/**
+	 * @covers WP_Locale::get_weekday_initial
+	 */
 	public function test_get_weekday_initial() {
 		$this->assertSame( __( 'S' ), $this->locale->get_weekday_initial( __( 'Sunday' ) ) );
 		$this->assertSame( __( 'M' ), $this->locale->get_weekday_initial( __( 'Monday' ) ) );
@@ -45,6 +54,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'S' ), $this->locale->get_weekday_initial( __( 'Saturday' ) ) );
 	}
 
+	/**
+	 * @covers WP_Locale::get_weekday_abbrev
+	 */
 	public function test_get_weekday_abbrev() {
 		$this->assertSame( __( 'Sun' ), $this->locale->get_weekday_abbrev( __( 'Sunday' ) ) );
 		$this->assertSame( __( 'Mon' ), $this->locale->get_weekday_abbrev( __( 'Monday' ) ) );
@@ -55,6 +67,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'Sat' ), $this->locale->get_weekday_abbrev( __( 'Saturday' ) ) );
 	}
 
+	/**
+	 * @covers WP_Locale::get_month
+	 */
 	public function test_get_month() {
 		$this->assertSame( __( 'January' ), $this->locale->get_month( 1 ) );
 		$this->assertSame( __( 'February' ), $this->locale->get_month( 2 ) );
@@ -70,6 +85,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'December' ), $this->locale->get_month( 12 ) );
 	}
 
+	/**
+	 * @covers WP_Locale::get_month
+	 */
 	public function test_get_month_leading_zero() {
 		$this->assertSame( __( 'January' ), $this->locale->get_month( '01' ) );
 		$this->assertSame( __( 'February' ), $this->locale->get_month( '02' ) );
@@ -82,6 +100,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'September' ), $this->locale->get_month( '09' ) );
 	}
 
+	/**
+	 * @covers WP_Locale::get_month_abbrev
+	 */
 	public function test_get_month_abbrev() {
 		$this->assertSame( __( 'Jan' ), $this->locale->get_month_abbrev( __( 'January' ) ) );
 		$this->assertSame( __( 'Feb' ), $this->locale->get_month_abbrev( __( 'February' ) ) );
@@ -97,6 +118,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'Dec' ), $this->locale->get_month_abbrev( __( 'December' ) ) );
 	}
 
+	/**
+	 * @covers WP_Locale::get_meridiem
+	 */
 	public function test_get_meridiem() {
 		$this->assertSame( __( 'am' ), $this->locale->get_meridiem( 'am' ) );
 		$this->assertSame( __( 'AM' ), $this->locale->get_meridiem( 'AM' ) );
@@ -104,6 +128,9 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->assertSame( __( 'PM' ), $this->locale->get_meridiem( 'PM' ) );
 	}
 
+	/**
+	 * @covers WP_Locale::is_rtl
+	 */
 	public function test_is_rtl() {
 		$this->assertFalse( $this->locale->is_rtl() );
 		$this->locale->text_direction = 'foo';
diff --git a/tests/mail.php b/tests/mail.php
index 66a613234b..c130658e3f 100644
--- a/tests/mail.php
+++ b/tests/mail.php
@@ -193,6 +193,28 @@ class Tests_Mail extends WP_UnitTestCase {
 		$this->assertStringContainsString( $expected, $mailer->get_sent()->header );
 	}
 
+	/**
+	 * @ticket 19847
+	 */
+	public function test_wp_mail_with_from_header_missing_space() {
+		$to        = 'address@tld.com';
+		$subject   = 'Testing';
+		$message   = 'Test Message';
+		$from      = 'bar@example.com';
+		$from_name = 'Foo';
+		$headers   = "From: {$from_name}<{$from}>";
+		$corrected = "From: {$from_name} <{$from}>";
+
+		wp_mail( $to, $subject, $message, $headers );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+		// phpcs:disable WordPress.NamingConventions.ValidVariableName.UsedPropertyNotSnakeCase
+		$this->assertSame( $from, $mailer->From );
+		$this->assertSame( $from_name, $mailer->FromName );
+		// phpcs:enable
+		$this->assertStringContainsString( $corrected, $mailer->get_sent()->header );
+	}
+
 	/**
 	 * @ticket 30266
 	 */
@@ -225,6 +247,28 @@ class Tests_Mail extends WP_UnitTestCase {
 		$this->assertStringContainsString( $expected, $mailer->get_sent()->header );
 	}
 
+	/**
+	 * Tests that wp_mail() returns false with an empty home URL and does not error out on PHP 8.1.
+	 *
+	 * @ticket 54730
+	 */
+	public function test_wp_mail_with_empty_home_url() {
+		$to      = 'address@tld.com';
+		$subject = 'Testing';
+		$message = 'Test Message';
+
+		// Multisite test runs.
+		add_filter( 'network_home_url', '__return_empty_string' );
+
+		// Single site test runs.
+		add_filter( 'home_url', '__return_empty_string' );
+
+		$result = wp_mail( $to, $subject, $message );
+
+		$this->assertFalse( $result, 'wp_mail() should have returned false' );
+		$this->assertGreaterThan( 0, did_action( 'wp_mail_failed' ), 'wp_mail_failed action was not called' );
+	}
+
 	/**
 	 * @ticket 30266
 	 */
diff --git a/tests/media.php b/tests/media.php
index 5d92d9718b..6afb92a343 100644
--- a/tests/media.php
+++ b/tests/media.php
@@ -5,6 +5,25 @@
  * @group shortcode
  */
 class Tests_Media extends WP_UnitTestCase {
+
+	const CAPTION           = 'A simple caption.';
+	const ALTERNATE_CAPTION = 'Alternate caption.';
+
+	const HTML_CONTENT = <<<'CAP'
+A <strong class='classy'>bolded</strong> <em>caption</em> with a <a href="#">link</a>.
+CAP;
+	const IMG_CONTENT  = <<<'CAP'
+<img src="pic.jpg" id='anId' alt="pic"/>
+CAP;
+
+	const IMG_NAME = 'image.jpg';
+	const IMG_URL  = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . self::IMG_NAME;
+	const IMG_META = array(
+		'width'  => 100,
+		'height' => 100,
+		'sizes'  => '',
+	);
+
 	protected static $large_id;
 	protected static $_sizes;
 	protected static $large_filename = 'test-image-large.jpg';
@@ -14,7 +33,8 @@ class Tests_Media extends WP_UnitTestCase {
 		self::$_sizes                          = wp_get_additional_image_sizes();
 		$GLOBALS['_wp_additional_image_sizes'] = array();
 
-		$filename       = DIR_TESTDATA . '/images/' . self::$large_filename;
+		$filename = DIR_TESTDATA . '/images/' . self::$large_filename;
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
 		self::$large_id = $factory->attachment->create_upload_object( $filename );
 
 		$post_statuses = array( 'publish', 'future', 'draft', 'auto-draft', 'trash' );
@@ -49,33 +69,14 @@ class Tests_Media extends WP_UnitTestCase {
 
 	public static function wpTearDownAfterClass() {
 		$GLOBALS['_wp_additional_image_sizes'] = self::$_sizes;
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
 	}
 
 	public static function tear_down_after_class() {
-		wp_delete_post( self::$large_id, true );
+		wp_delete_attachment( self::$large_id, true );
 		parent::tear_down_after_class();
 	}
 
-	public function set_up() {
-		parent::set_up();
-		$this->caption           = 'A simple caption.';
-		$this->alternate_caption = 'Alternate caption.';
-		$this->html_content      = <<<CAP
-A <strong class='classy'>bolded</strong> <em>caption</em> with a <a href="#">link</a>.
-CAP;
-		$this->img_content       = <<<CAP
-<img src="pic.jpg" id='anId' alt="pic"/>
-CAP;
-		$this->img_name          = 'image.jpg';
-		$this->img_url           = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . $this->img_name;
-		$this->img_html          = '<img src="' . $this->img_url . '"/>';
-		$this->img_meta          = array(
-			'width'  => 100,
-			'height' => 100,
-			'sizes'  => '',
-		);
-	}
-
 	public function test_img_caption_shortcode_added() {
 		global $shortcode_tags;
 		$this->assertSame( 'img_caption_shortcode', $shortcode_tags['caption'] );
@@ -91,8 +92,8 @@ CAP;
 	 * @ticket 33981
 	 */
 	public function test_img_caption_shortcode_with_empty_params_but_content() {
-		$result = img_caption_shortcode( array(), $this->caption );
-		$this->assertSame( $this->caption, $result );
+		$result = img_caption_shortcode( array(), self::CAPTION );
+		$this->assertSame( self::CAPTION, $result );
 	}
 
 	/**
@@ -101,15 +102,15 @@ CAP;
 	public function test_img_caption_shortcode_short_circuit_filter() {
 		add_filter( 'img_caption_shortcode', array( $this, 'return_alt_caption' ) );
 
-		$result = img_caption_shortcode( array(), $this->caption );
-		$this->assertSame( $this->alternate_caption, $result );
+		$result = img_caption_shortcode( array(), self::CAPTION );
+		$this->assertSame( self::ALTERNATE_CAPTION, $result );
 	}
 
 	/**
 	 * Filter used in test_img_caption_shortcode_short_circuit_filter()
 	 */
 	public function return_alt_caption() {
-		return $this->alternate_caption;
+		return self::ALTERNATE_CAPTION;
 	}
 
 	/**
@@ -120,9 +121,9 @@ CAP;
 			array(
 				'width' => 0,
 			),
-			$this->caption
+			self::CAPTION
 		);
-		$this->assertSame( $this->caption, $result );
+		$this->assertSame( self::CAPTION, $result );
 	}
 
 	/**
@@ -145,27 +146,27 @@ CAP;
 			array(
 				'caption' => '',
 			),
-			$this->caption
+			self::CAPTION
 		);
-		$this->assertSame( $this->caption, $result );
+		$this->assertSame( self::CAPTION, $result );
 	}
 
 	public function test_img_caption_shortcode_with_old_format() {
 		$result = img_caption_shortcode(
 			array(
 				'width'   => 20,
-				'caption' => $this->caption,
+				'caption' => self::CAPTION,
 			)
 		);
 
-		$this->assertSame( 2, preg_match_all( '/wp-caption/', $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( '/alignnone/', $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( "/{$this->caption}/", $result, $_r ) );
+		$this->assertSame( 2, substr_count( $result, 'wp-caption' ) );
+		$this->assertSame( 1, substr_count( $result, 'alignnone' ) );
+		$this->assertSame( 1, substr_count( $result, self::CAPTION ) );
 
 		if ( current_theme_supports( 'html5', 'caption' ) ) {
-			$this->assertSame( 1, preg_match_all( '/width: 20/', $result, $_r ) );
+			$this->assertSame( 1, substr_count( $result, 'width: 20' ) );
 		} else {
-			$this->assertSame( 1, preg_match_all( '/width: 30/', $result, $_r ) );
+			$this->assertSame( 1, substr_count( $result, 'width: 30' ) );
 		}
 	}
 
@@ -173,14 +174,14 @@ CAP;
 		$result = img_caption_shortcode(
 			array(
 				'width'   => 20,
-				'caption' => $this->caption,
+				'caption' => self::CAPTION,
 				'id'      => '"myId',
 				'align'   => '&myAlignment',
 			)
 		);
-		$this->assertSame( 1, preg_match_all( '/wp-caption &amp;myAlignment/', $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( '/id="myId"/', $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( "/{$this->caption}/", $result, $_r ) );
+		$this->assertSame( 1, substr_count( $result, 'wp-caption &amp;myAlignment' ) );
+		$this->assertSame( 1, substr_count( $result, 'id="myId"' ) );
+		$this->assertSame( 1, substr_count( $result, self::CAPTION ) );
 	}
 
 	public function test_img_caption_shortcode_with_old_format_and_class() {
@@ -188,61 +189,60 @@ CAP;
 			array(
 				'width'   => 20,
 				'class'   => 'some-class another-class',
-				'caption' => $this->caption,
+				'caption' => self::CAPTION,
 			)
 		);
-		$this->assertSame( 1, preg_match_all( '/wp-caption alignnone some-class another-class/', $result, $_r ) );
+		$this->assertSame( 1, substr_count( $result, 'wp-caption alignnone some-class another-class' ) );
 
 	}
 
 	public function test_new_img_caption_shortcode_with_html_caption() {
-		$result   = img_caption_shortcode(
+		$result = img_caption_shortcode(
 			array(
 				'width'   => 20,
-				'caption' => $this->html_content,
+				'caption' => self::HTML_CONTENT,
 			)
 		);
-		$our_preg = preg_quote( $this->html_content );
 
-		$this->assertSame( 1, preg_match_all( "~{$our_preg}~", $result, $_r ) );
+		$this->assertSame( 1, substr_count( $result, self::HTML_CONTENT ) );
 	}
 
 	public function test_new_img_caption_shortcode_new_format() {
 		$result       = img_caption_shortcode(
 			array( 'width' => 20 ),
-			$this->img_content . $this->html_content
+			self::IMG_CONTENT . self::HTML_CONTENT
 		);
-		$img_preg     = preg_quote( $this->img_content );
-		$content_preg = preg_quote( $this->html_content );
+		$img_preg     = preg_quote( self::IMG_CONTENT );
+		$content_preg = preg_quote( self::HTML_CONTENT );
 
-		$this->assertSame( 1, preg_match_all( "~{$img_preg}.*wp-caption-text~", $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( "~wp-caption-text.*{$content_preg}~", $result, $_r ) );
+		$this->assertSame( 1, preg_match_all( "~{$img_preg}.*wp-caption-text~", $result ) );
+		$this->assertSame( 1, preg_match_all( "~wp-caption-text.*{$content_preg}~", $result ) );
 	}
 
 	public function test_new_img_caption_shortcode_new_format_and_linked_image() {
-		$linked_image = "<a href='#'>{$this->img_content}</a>";
+		$linked_image = "<a href='#'>" . self::IMG_CONTENT . '</a>';
 		$result       = img_caption_shortcode(
 			array( 'width' => 20 ),
-			$linked_image . $this->html_content
+			$linked_image . self::HTML_CONTENT
 		);
 		$img_preg     = preg_quote( $linked_image );
-		$content_preg = preg_quote( $this->html_content );
+		$content_preg = preg_quote( self::HTML_CONTENT );
 
-		$this->assertSame( 1, preg_match_all( "~{$img_preg}.*wp-caption-text~", $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( "~wp-caption-text.*{$content_preg}~", $result, $_r ) );
+		$this->assertSame( 1, preg_match_all( "~{$img_preg}.*wp-caption-text~", $result ) );
+		$this->assertSame( 1, preg_match_all( "~wp-caption-text.*{$content_preg}~", $result ) );
 	}
 
 	public function test_new_img_caption_shortcode_new_format_and_linked_image_with_newline() {
-		$linked_image = "<a href='#'>{$this->img_content}</a>";
+		$linked_image = "<a href='#'>" . self::IMG_CONTENT . '</a>';
 		$result       = img_caption_shortcode(
 			array( 'width' => 20 ),
-			$linked_image . "\n\n" . $this->html_content
+			$linked_image . "\n\n" . self::HTML_CONTENT
 		);
 		$img_preg     = preg_quote( $linked_image );
-		$content_preg = preg_quote( $this->html_content );
+		$content_preg = preg_quote( self::HTML_CONTENT );
 
-		$this->assertSame( 1, preg_match_all( "~{$img_preg}.*wp-caption-text~", $result, $_r ) );
-		$this->assertSame( 1, preg_match_all( "~wp-caption-text.*{$content_preg}~", $result, $_r ) );
+		$this->assertSame( 1, preg_match_all( "~{$img_preg}.*wp-caption-text~", $result ) );
+		$this->assertSame( 1, preg_match_all( "~wp-caption-text.*{$content_preg}~", $result ) );
 	}
 
 	/**
@@ -254,10 +254,10 @@ CAP;
 				'width' => 20,
 				'id'    => 'myId',
 			),
-			$this->img_content . $this->html_content
+			self::IMG_CONTENT . self::HTML_CONTENT
 		);
 
-		$this->assertSame( 1, preg_match_all( '/aria-describedby="caption-myId"/', $result, $_r ) );
+		$this->assertSame( 1, substr_count( $result, 'aria-describedby="caption-myId"' ) );
 	}
 
 	public function test_add_remove_oembed_provider() {
@@ -494,7 +494,7 @@ https://w.org</a>',
 	public function test_get_attached_images() {
 		$post_id       = self::factory()->post->create();
 		$attachment_id = self::factory()->attachment->create_object(
-			$this->img_name,
+			self::IMG_NAME,
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
@@ -521,7 +521,7 @@ https://w.org</a>',
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids1[]      = $attachment_id;
 			$ids1_srcs[] = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -538,7 +538,7 @@ https://w.org</a>',
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids2[]      = $attachment_id;
 			$ids2_srcs[] = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -572,7 +572,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids1[]      = $attachment_id;
 			$ids1_srcs[] = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -589,7 +589,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids2[]      = $attachment_id;
 			$ids2_srcs[] = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -622,7 +622,7 @@ BLOB;
 				"image$i.jpg",
 				0
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -660,7 +660,7 @@ BLOB;
 				"image$i.jpg",
 				0
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -702,7 +702,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -745,7 +745,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -788,7 +788,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -1023,6 +1023,7 @@ VIDEO;
 
 	/**
 	 * @ticket 35367
+	 * @ticket 54788
 	 * @depends test_video_shortcode_body
 	 */
 	public function test_wp_video_shortcode_attributes() {
@@ -1035,6 +1036,7 @@ VIDEO;
 		$this->assertStringContainsString( 'src="https://example.com/foo.mp4', $actual );
 		$this->assertStringNotContainsString( 'loop', $actual );
 		$this->assertStringNotContainsString( 'autoplay', $actual );
+		$this->assertStringNotContainsString( 'muted', $actual );
 		$this->assertStringContainsString( 'preload="metadata"', $actual );
 		$this->assertStringContainsString( 'width="640"', $actual );
 		$this->assertStringContainsString( 'height="360"', $actual );
@@ -1046,6 +1048,7 @@ VIDEO;
 				'poster'   => 'https://example.com/foo.png',
 				'loop'     => true,
 				'autoplay' => true,
+				'muted'    => true,
 				'preload'  => true,
 				'width'    => 123,
 				'height'   => 456,
@@ -1057,6 +1060,7 @@ VIDEO;
 		$this->assertStringContainsString( 'poster="https://example.com/foo.png', $actual );
 		$this->assertStringContainsString( 'loop="1"', $actual );
 		$this->assertStringContainsString( 'autoplay="1"', $actual );
+		$this->assertStringContainsString( 'muted', $actual );
 		$this->assertStringContainsString( 'preload="1"', $actual );
 		$this->assertStringContainsString( 'width="123"', $actual );
 		$this->assertStringContainsString( 'height="456"', $actual );
@@ -1181,7 +1185,7 @@ VIDEO;
 	 * @ticket 30346
 	 */
 	public function test_attachment_url_to_postid() {
-		$image_path    = '2014/11/' . $this->img_name;
+		$image_path    = '2014/11/' . self::IMG_NAME;
 		$attachment_id = self::factory()->attachment->create_object(
 			$image_path,
 			0,
@@ -1199,7 +1203,7 @@ VIDEO;
 	 * @ticket 33109
 	 */
 	public function test_attachment_url_to_postid_with_different_scheme() {
-		$image_path    = '2014/11/' . $this->img_name;
+		$image_path    = '2014/11/' . self::IMG_NAME;
 		$attachment_id = self::factory()->attachment->create_object(
 			$image_path,
 			0,
@@ -1217,7 +1221,7 @@ VIDEO;
 	 * @ticket 39768
 	 */
 	public function test_attachment_url_to_postid_should_be_case_sensitive() {
-		$image_path_lower_case    = '2014/11/' . $this->img_name;
+		$image_path_lower_case    = '2014/11/' . self::IMG_NAME;
 		$attachment_id_lower_case = self::factory()->attachment->create_object(
 			$image_path_lower_case,
 			0,
@@ -1227,7 +1231,7 @@ VIDEO;
 			)
 		);
 
-		$image_path_upper_case    = '2014/11/' . ucfirst( $this->img_name );
+		$image_path_upper_case    = '2014/11/' . ucfirst( self::IMG_NAME );
 		$attachment_id_upper_case = self::factory()->attachment->create_object(
 			$image_path_upper_case,
 			0,
@@ -1242,7 +1246,7 @@ VIDEO;
 	}
 
 	public function test_attachment_url_to_postid_filtered() {
-		$image_path    = '2014/11/' . $this->img_name;
+		$image_path    = '2014/11/' . self::IMG_NAME;
 		$attachment_id = self::factory()->attachment->create_object(
 			$image_path,
 			0,
@@ -1306,7 +1310,7 @@ VIDEO;
 		$post = get_post( $post_id );
 
 		// Clean up.
-		wp_delete_attachment( $post_id );
+		wp_delete_attachment( $post_id, true );
 
 		$this->assertSame( 'This is a comment. / Это комментарий. / Βλέπετε ένα σχόλιο.', $post->post_excerpt );
 	}
@@ -1345,7 +1349,7 @@ VIDEO;
 		$post = get_post( $post_id );
 
 		// Clean up.
-		wp_delete_attachment( $post_id );
+		wp_delete_attachment( $post_id, true );
 
 		$this->assertSame( 'This is a test', $post->post_title );
 	}
@@ -1474,7 +1478,7 @@ EOF;
 	public function test_wp_get_attachment_image_defaults() {
 		$image    = image_downsize( self::$large_id, 'thumbnail' );
 		$expected = sprintf(
-			'<img width="%1$d" height="%2$d" src="%3$s" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" />',
+			'<img width="%1$d" height="%2$d" src="%3$s" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" />',
 			$image[1],
 			$image[2],
 			$image[0]
@@ -1512,7 +1516,7 @@ EOF;
 
 		$image    = image_downsize( self::$large_id, 'thumbnail' );
 		$expected = sprintf(
-			'<img width="%1$d" height="%2$d" src="%3$s" class="attachment-thumbnail size-thumbnail" alt="Some very clever alt text" loading="lazy" />',
+			'<img width="%1$d" height="%2$d" src="%3$s" class="attachment-thumbnail size-thumbnail" alt="Some very clever alt text" decoding="async" loading="lazy" />',
 			$image[1],
 			$image[2],
 			$image[0]
@@ -1532,7 +1536,7 @@ EOF;
 
 		$post_id       = self::factory()->post->create();
 		$attachment_id = self::factory()->attachment->create_object(
-			$this->img_name,
+			self::IMG_NAME,
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
@@ -1555,7 +1559,7 @@ EOF;
 
 		$post_id       = self::factory()->post->create();
 		$attachment_id = self::factory()->attachment->create_object(
-			$this->img_name,
+			self::IMG_NAME,
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
@@ -1575,7 +1579,7 @@ EOF;
 	public function test_wp_get_attachment_caption_empty() {
 		$post_id       = self::factory()->post->create();
 		$attachment_id = self::factory()->attachment->create_object(
-			$this->img_name,
+			self::IMG_NAME,
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
@@ -1655,11 +1659,11 @@ EOF;
 
 		$expected = trim( $expected, ' ,' );
 
-		foreach ( $intermediates as $int ) {
-			$image_url  = wp_get_attachment_image_url( self::$large_id, $int );
-			$size_array = $this->get_image_size_array_from_meta( $image_meta, $int );
+		foreach ( $intermediates as $int_size ) {
+			$image_url  = wp_get_attachment_image_url( self::$large_id, $int_size );
+			$size_array = $this->get_image_size_array_from_meta( $image_meta, $int_size );
 
-			if ( 'full' === $int ) {
+			if ( 'full' === $int_size ) {
 				// Add the full size image. Expected to be in the srcset when the full size image is used as src.
 				$_expected = $uploads_dir_url . $image_meta['file'] . ' ' . $image_meta['width'] . 'w, ' . $expected;
 			} else {
@@ -1708,11 +1712,19 @@ EOF;
 
 		$expected = trim( $expected, ' ,' );
 
-		foreach ( $intermediates as $int ) {
-			$size_array = $this->get_image_size_array_from_meta( $image_meta, $int );
-			$image_url  = wp_get_attachment_image_url( $id, $int );
+		foreach ( $intermediates as $int_size ) {
+			$image_urls[ $int_size ] = wp_get_attachment_image_url( $id, $int_size );
+		}
 
-			if ( 'full' === $int ) {
+		// Remove the attachment.
+		wp_delete_attachment( $id, true );
+		remove_filter( 'upload_dir', '_upload_dir_no_subdir' );
+
+		foreach ( $intermediates as $int_size ) {
+			$size_array = $this->get_image_size_array_from_meta( $image_meta, $int_size );
+			$image_url  = $image_urls[ $int_size ];
+
+			if ( 'full' === $int_size ) {
 				// Add the full size image. Expected to be in the srcset when the full size image is used as src.
 				$_expected = $uploads_dir_url . $image_meta['file'] . ' ' . $image_meta['width'] . 'w, ' . $expected;
 			} else {
@@ -1723,9 +1735,6 @@ EOF;
 			$this->assertSame( $expected_srcset, wp_calculate_image_srcset( $size_array, $image_url, $image_meta ) );
 		}
 
-		// Remove the attachment.
-		wp_delete_attachment( $id );
-		remove_filter( 'upload_dir', '_upload_dir_no_subdir' );
 	}
 
 	/**
@@ -1798,11 +1807,11 @@ EOF;
 		// Prepend an absolute path to simulate a pre-2.7 upload.
 		$image_meta['file'] = 'H:\home\wordpress\trunk/wp-content/uploads/' . $image_meta['file'];
 
-		foreach ( $intermediates as $int ) {
-			$image_url  = wp_get_attachment_image_url( self::$large_id, $int );
-			$size_array = $this->get_image_size_array_from_meta( $image_meta, $int );
+		foreach ( $intermediates as $int_size ) {
+			$image_url  = wp_get_attachment_image_url( self::$large_id, $int_size );
+			$size_array = $this->get_image_size_array_from_meta( $image_meta, $int_size );
 
-			if ( 'full' === $int ) {
+			if ( 'full' === $int_size ) {
 				// Add the full size image. Expected to be in the srcset when the full size image is used as src.
 				$_expected = $uploads_dir_url . $full_size_file . ' ' . $image_meta['width'] . 'w, ' . $expected;
 			} else {
@@ -1829,9 +1838,8 @@ EOF;
 	 * @requires function imagejpeg
 	 */
 	public function test_wp_calculate_image_srcset_no_width() {
-		$file       = get_attached_file( self::$large_id );
 		$image_url  = wp_get_attachment_image_url( self::$large_id, 'medium' );
-		$image_meta = wp_generate_attachment_metadata( self::$large_id, $file );
+		$image_meta = wp_get_attachment_metadata( self::$large_id );
 
 		$size_array = array( 0, 0 );
 
@@ -2248,6 +2256,7 @@ EOF;
 			$respimg_xhtml,
 			$respimg_html5
 		);
+		$content_filtered = wp_img_tag_add_decoding_attr( $content_filtered, 'the_content' );
 
 		// Do not add width, height, and loading.
 		add_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
@@ -2273,6 +2282,7 @@ EOF;
 	public function test_wp_filter_content_tags_srcset_sizes_wrong() {
 		$img = get_image_tag( self::$large_id, '', '', '', 'medium' );
 		$img = wp_img_tag_add_loading_attr( $img, 'test' );
+		$img = wp_img_tag_add_decoding_attr( $img, 'the_content' );
 
 		// Replace the src URL.
 		$image_wrong_src = preg_replace( '|src="[^"]+"|', 'src="http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/foo.jpg"', $img );
@@ -2287,12 +2297,92 @@ EOF;
 		// Generate HTML and add a dummy srcset attribute.
 		$img = get_image_tag( self::$large_id, '', '', '', 'medium' );
 		$img = wp_img_tag_add_loading_attr( $img, 'test' );
+		$img = wp_img_tag_add_decoding_attr( $img, 'the_content' );
 		$img = preg_replace( '|<img ([^>]+) />|', '<img $1 ' . 'srcset="image2x.jpg 2x" />', $img );
 
 		// The content filter should return the image unchanged.
 		$this->assertSame( $img, wp_filter_content_tags( $img ) );
 	}
 
+	/**
+	 * @ticket 55347
+	 */
+	public function test_wp_filter_content_tags_has_filter() {
+		$filter = new MockAction();
+		add_filter( 'wp_content_img_tag', array( &$filter, 'filter' ) );
+		$img_tag_1 = get_image_tag( self::$large_id, '', '', '', 'medium' );
+
+		wp_filter_content_tags( $img_tag_1 );
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * @ticket 55510
+	 * @covers ::wp_filter_content_tags
+	 */
+	public function test_wp_filter_content_tags_handles_duplicate_img_and_iframe_tags_once() {
+		$img     = get_image_tag( self::$large_id, '', '', '', 'large' );
+		$iframe  = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
+		$content = "$img\n$img\n$iframe\n$iframe";
+
+		// Record how often one of the available img and iframe filters is run.
+		// Both images and iframes support lazy-loading, so that's why this is used here.
+		$img_filter = new MockAction();
+		add_filter( 'wp_img_tag_add_loading_attr', array( &$img_filter, 'filter' ) );
+		$iframe_filter = new MockAction();
+		add_filter( 'wp_iframe_tag_add_loading_attr', array( &$iframe_filter, 'filter' ) );
+
+		// Ensure the img and iframe filters only ran once because the content is a single duplicated img tag and a
+		// single duplicate iframe tag.
+		wp_filter_content_tags( $content );
+		$this->assertSame( 1, $img_filter->get_call_count() );
+		$this->assertSame( 1, $iframe_filter->get_call_count() );
+	}
+
+	/**
+	 * @ticket 55510
+	 * @covers ::wp_filter_content_tags
+	 */
+	public function test_wp_filter_content_tags_filter_with_identical_image_tags_custom_attributes() {
+		$img     = get_image_tag( self::$large_id, '', '', '', 'large' );
+		$img     = str_replace( '<img ', '<img srcset="custom" sizes="custom" loading="custom" decoding="custom"', $img );
+		$content = "$img\n$img";
+
+		add_filter(
+			'wp_content_img_tag',
+			function( $filtered_image ) {
+				return "<span>$filtered_image</span>";
+			}
+		);
+
+		// Ensure there is no duplicate <span> wrapping the image.
+		$this->assertStringNotContainsString( '<span><span><img ', wp_filter_content_tags( $content ) );
+	}
+
+	/**
+	 * @ticket 55510
+	 * @covers ::wp_filter_content_tags
+	 */
+	public function test_wp_filter_content_tags_filter_with_identical_image_tags_disabled_core_filters() {
+		$img     = get_image_tag( self::$large_id, '', '', '', 'large' );
+		$content = "$img\n$img";
+
+		add_filter( 'wp_img_tag_add_loading_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
+
+		add_filter(
+			'wp_content_img_tag',
+			function( $filtered_image ) {
+				return "<span>$filtered_image</span>";
+			}
+		);
+
+		// Ensure the output has both instances of the image wrapped with a single <span>.
+		$this->assertSame( "<span>$img</span>\n<span>$img</span>", wp_filter_content_tags( $content ) );
+	}
+
 	/**
 	 * @ticket 33641
 	 * @ticket 34528
@@ -2383,6 +2473,7 @@ EOF;
 			$respimg_https,
 			$respimg_relative
 		);
+		$expected = wp_img_tag_add_decoding_attr( $expected, 'the_content' );
 
 		$actual = wp_filter_content_tags( $unfiltered );
 
@@ -2448,7 +2539,14 @@ EOF;
 		$attachment = wp_get_attachment_image_src( $id, 'medium' );
 
 		$html     = '<img src="%1$s" alt="" width="%2$d" height="%3$d" class="align%4$s size-medium wp-image-%5$d" />';
-		$expected = sprintf( $html, $attachment[0], $attachment[1], $attachment[2], $align, $id );
+		$expected = sprintf(
+			$html,
+			$attachment[0],
+			$attachment[1],
+			$attachment[2],
+			$align,
+			$id
+		);
 
 		$this->assertSame( $expected, get_image_send_to_editor( $id, $caption, $title, $align ) );
 
@@ -2474,7 +2572,19 @@ EOF;
 		$html = '<a href="%1$s" rel="%2$s"><img src="%3$s" alt="%4$s" width="%5$d" height="%6$d" class="size-%8$s wp-image-%9$d" /></a>';
 		$html = '[caption id="attachment_%9$d" align="align%7$s" width="%5$d"]' . $html . ' %10$s[/caption]';
 
-		$expected = sprintf( $html, $url, 'attachment wp-att-' . $id, $attachment[0], $alt, $attachment[1], $attachment[2], $align, $size, $id, $caption );
+		$expected = sprintf(
+			$html,
+			$url,
+			'attachment wp-att-' . $id,
+			$attachment[0],
+			$alt,
+			$attachment[1],
+			$attachment[2],
+			$align,
+			$size,
+			$id,
+			$caption
+		);
 
 		$this->assertSame( $expected, get_image_send_to_editor( $id, $caption, $title, $align, $url, $rel, $size, $alt ) );
 	}
@@ -2497,7 +2607,17 @@ EOF;
 
 		$html = '<a href="%1$s"><img src="%2$s" alt="%3$s" width="%4$d" height="%5$d" class="align%6$s size-%7$s wp-image-%8$d" /></a>';
 
-		$expected = sprintf( $html, $url, $attachment[0], $alt, $attachment[1], $attachment[2], $align, $size, $id );
+		$expected = sprintf(
+			$html,
+			$url,
+			$attachment[0],
+			$alt,
+			$attachment[1],
+			$attachment[2],
+			$align,
+			$size,
+			$id
+		);
 
 		$this->assertSame( $expected, get_image_send_to_editor( $id, $caption, $title, $align, $url, $rel, $size, $alt ) );
 	}
@@ -2525,7 +2645,7 @@ EOF;
 
 		$expected = '<img width="999" height="999" ' .
 			'src="' . $uploads_url . 'test-image-testsize-999x999.jpg" ' .
-			'class="attachment-testsize size-testsize" alt="" loading="lazy" ' .
+			'class="attachment-testsize size-testsize" alt="" decoding="async" loading="lazy" ' .
 			'srcset="' . $uploads_url . 'test-image-testsize-999x999.jpg 999w, ' . $uploads_url . $basename . '-150x150.jpg 150w" ' .
 			'sizes="(max-width: 999px) 100vw, 999px" />';
 
@@ -2741,8 +2861,8 @@ EOF;
 		$expected = $uploads_dir['url'] . '/test-image-iptc.jpg';
 
 		// Clean up.
-		wp_delete_attachment( $post_id );
-		wp_delete_post( $parent_id );
+		wp_delete_attachment( $post_id, true );
+		wp_delete_post( $parent_id, true );
 
 		$this->assertSame( $expected, $url );
 	}
@@ -2793,8 +2913,8 @@ EOF;
 		$expected = $uploads_dir['url'] . '/test-image-iptc.jpg';
 
 		// Clean up.
-		wp_delete_attachment( $post_id );
-		wp_delete_post( $parent_id );
+		wp_delete_attachment( $post_id, true );
+		wp_delete_post( $parent_id, true );
 
 		$this->assertSame( $expected, $url );
 	}
@@ -2831,8 +2951,22 @@ EOF;
 			<p>Image, no height but width attribute. Should NOT be modified.</p>
 			%4$s';
 
-		$content_unfiltered = sprintf( $content, $img, $img_no_width_height, $img_no_width, $img_no_height );
-		$content_filtered   = sprintf( $content, $img, $respimg_no_width_height, $img_no_width, $img_no_height );
+		$content_unfiltered = sprintf(
+			$content,
+			$img,
+			$img_no_width_height,
+			$img_no_width,
+			$img_no_height
+		);
+
+		$content_filtered = sprintf(
+			$content,
+			$img,
+			$respimg_no_width_height,
+			$img_no_width,
+			$img_no_height
+		);
+		$content_filtered = wp_img_tag_add_decoding_attr( $content_filtered, 'the_content' );
 
 		// Do not add loading, srcset, and sizes.
 		add_filter( 'wp_img_tag_add_loading_attr', '__return_false' );
@@ -2889,8 +3023,30 @@ EOF;
 			<p>Iframe, without dimension attributes. Should not be modified.</p>
 			%8$s';
 
-		$content_unfiltered = sprintf( $content, $img, $img_xhtml, $img_html5, $img_eager, $img_no_width_height, $iframe, $iframe_eager, $iframe_no_width_height );
-		$content_filtered   = sprintf( $content, $lazy_img, $lazy_img_xhtml, $lazy_img_html5, $img_eager, $img_no_width_height, $lazy_iframe, $iframe_eager, $iframe_no_width_height );
+		$content_unfiltered = sprintf(
+			$content,
+			$img,
+			$img_xhtml,
+			$img_html5,
+			$img_eager,
+			$img_no_width_height,
+			$iframe,
+			$iframe_eager,
+			$iframe_no_width_height
+		);
+
+		$content_filtered = sprintf(
+			$content,
+			$lazy_img,
+			$lazy_img_xhtml,
+			$lazy_img_html5,
+			$img_eager,
+			$img_no_width_height,
+			$lazy_iframe,
+			$iframe_eager,
+			$iframe_no_width_height
+		);
+		$content_filtered = wp_img_tag_add_decoding_attr( $content_filtered, 'the_content' );
 
 		// Do not add width, height, srcset, and sizes.
 		add_filter( 'wp_img_tag_add_width_and_height_attr', '__return_false' );
@@ -2909,6 +3065,7 @@ EOF;
 	public function test_wp_filter_content_tags_loading_lazy_opted_in() {
 		$img         = get_image_tag( self::$large_id, '', '', '', 'medium' );
 		$lazy_img    = wp_img_tag_add_loading_attr( $img, 'test' );
+		$lazy_img    = wp_img_tag_add_decoding_attr( $lazy_img, 'the_content' );
 		$iframe      = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
 		$lazy_iframe = wp_iframe_tag_add_loading_attr( $iframe, 'test' );
 
@@ -2938,6 +3095,7 @@ EOF;
 	 */
 	public function test_wp_filter_content_tags_loading_lazy_opted_out() {
 		$img    = get_image_tag( self::$large_id, '', '', '', 'medium' );
+		$img    = wp_img_tag_add_decoding_attr( $img, 'the_content' );
 		$iframe = '<iframe src="https://www.example.com" width="640" height="360"></iframe>';
 
 		$content = '
@@ -3184,7 +3342,7 @@ EOF;
 	 */
 	public function test_wp_image_file_matches_image_meta_invalid_meta() {
 		$image_meta = ''; // Attachment is not an image.
-		$image_src  = $this->img_url;
+		$image_src  = self::IMG_URL;
 
 		$this->assertFalse( wp_image_file_matches_image_meta( $image_src, $image_meta ) );
 	}
@@ -3194,7 +3352,7 @@ EOF;
 	 */
 	public function test_wp_image_file_matches_image_meta_different_meta() {
 		$image_meta = wp_get_attachment_metadata( self::$large_id );
-		$image_src  = $this->img_url; // Different image.
+		$image_src  = self::IMG_URL; // Different image.
 
 		$this->assertFalse( wp_image_file_matches_image_meta( $image_src, $image_meta ) );
 	}
@@ -3402,6 +3560,7 @@ EOF;
 		// Following the threshold of 2, the first two content media elements should not be lazy-loaded.
 		$content_unfiltered = $img1 . $iframe1 . $img2 . $img3 . $iframe2;
 		$content_expected   = $img1 . $iframe1 . $lazy_img2 . $lazy_img3 . $lazy_iframe2;
+		$content_expected   = wp_img_tag_add_decoding_attr( $content_expected, 'the_content' );
 
 		$wp_query     = new WP_Query( array( 'post__in' => array( self::$post_ids['publish'] ) ) );
 		$wp_the_query = $wp_query;
@@ -3464,6 +3623,131 @@ EOF;
 		// Clean up the above filter.
 		remove_filter( 'wp_omit_loading_attr_threshold', '__return_null', 100 );
 	}
+
+	/**
+	 * Test the wp_default_image_output_mapping function.
+	 *
+	 * @ticket 55443
+	 */
+	public function test_wp_default_image_output_mapping() {
+		$mapping = wp_default_image_output_mapping( array(), 'test.jpg', 'image/jpeg', '' );
+		$this->assertSame( array( 'image/jpeg' => 'image/webp' ), $mapping );
+	}
+
+	/**
+	 * Test that wp_default_image_output_mapping doesn't overwrite existing mappings.
+	 *
+	 * @ticket 55443
+	 */
+	public function test_wp_default_image_output_mapping_existing() {
+		$mapping = array( 'mime/png' => 'mime/webp' );
+		$mapping = wp_default_image_output_mapping( $mapping, 'test.jpg', 'image/jpeg', '' );
+		$this->assertSame(
+			array(
+				'mime/png'   => 'mime/webp',
+				'image/jpeg' => 'image/webp',
+			),
+			$mapping
+		);
+	}
+
+	/**
+	 * Test that the image editor default output for JPEGs is WebP.
+	 *
+	 * @ticket 55443
+	 */
+	public function test_wp_image_editor_default_output_maps_to_webp() {
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+
+		$editor = wp_get_image_editor( DIR_TESTDATA . '/images/canola.jpg' );
+		$this->assertNotWPError( $editor );
+
+		$resized = $editor->resize( 100, 100, false );
+		$this->assertNotWPError( $resized );
+
+		$saved = $editor->save();
+		$this->assertNotWPError( $saved );
+
+		if ( $editor->supports_mime_type( 'image/webp' ) ) {
+			$this->assertSame( 'image/webp', $saved['mime-type'] );
+			$this->assertSame( 'canola-100x75-jpg.webp', $saved['file'] );
+		} else {
+			$this->assertSame( 'image/jpeg', $saved['mime-type'] );
+			$this->assertSame( 'canola-100x75.jpg', $saved['file'] );
+		}
+	}
+
+	/**
+	 * @ticket 56526
+	 * @dataProvider data_wp_default_image_output_mapping_size_filter
+	 */
+	public function test_wp_default_image_output_mapping_size_filter( $size_name, $filter_callback, $expects_webp ) {
+		remove_all_filters( 'wp_image_sizes_with_additional_mime_type_support' );
+		if ( $filter_callback ) {
+			add_filter( 'wp_image_sizes_with_additional_mime_type_support', $filter_callback );
+		}
+
+		$mapping = wp_default_image_output_mapping( array(), 'test.jpg', 'image/jpeg', $size_name );
+		if ( $expects_webp ) {
+			$this->assertSame( array( 'image/jpeg' => 'image/webp' ), $mapping );
+		} else {
+			$this->assertSame( array(), $mapping );
+		}
+	}
+
+	public function data_wp_default_image_output_mapping_size_filter() {
+		return array(
+			'default size thumbnail'    => array(
+				'thumbnail',
+				null,
+				true,
+			),
+			'default size medium'       => array(
+				'medium',
+				null,
+				true,
+			),
+			'default size medium_large' => array(
+				'medium_large',
+				null,
+				true,
+			),
+			'default size large'        => array(
+				'large',
+				null,
+				true,
+			),
+			'default size unset'        => array(
+				'medium',
+				function( $enabled_sizes ) {
+					unset( $enabled_sizes['medium'] );
+					return $enabled_sizes;
+				},
+				false,
+			),
+			'default size set to false' => array(
+				'medium',
+				function( $enabled_sizes ) {
+					$enabled_sizes['medium'] = false;
+					return $enabled_sizes;
+				},
+				false,
+			),
+			'custom size'               => array(
+				'custom',
+				null,
+				false,
+			),
+			'custom size opted in'      => array(
+				'custom',
+				function( $enabled_sizes ) {
+					$enabled_sizes['custom'] = true;
+					return $enabled_sizes;
+				},
+				true,
+			),
+		);
+	}
 }
 
 /**
diff --git a/tests/media/getAdjacentImageLink.php b/tests/media/getAdjacentImageLink.php
index 735c0ff15c..7f413cab2e 100644
--- a/tests/media/getAdjacentImageLink.php
+++ b/tests/media/getAdjacentImageLink.php
@@ -32,7 +32,7 @@ class Tests_Media_GetAdjacentImageLink extends WP_Test_Adjacent_Image_Link_TestC
 			'when has previous link'           => array(
 				'current_attachment_index'  => 3,
 				'expected_attachment_index' => 2,
-				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="http://example.org/wp-content/uploads/image2.jpg" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" /></a>',
+				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="' . WP_CONTENT_URL . '/uploads/image2.jpg" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" /></a>',
 			),
 			'with text when has previous link' => array(
 				'current_attachment_index'  => 3,
@@ -43,7 +43,7 @@ class Tests_Media_GetAdjacentImageLink extends WP_Test_Adjacent_Image_Link_TestC
 			'when has next link'               => array(
 				'current_attachment_index'  => 4,
 				'expected_attachment_index' => 5,
-				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="http://example.org/wp-content/uploads/image5.jpg" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" /></a>',
+				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="' . WP_CONTENT_URL . '/uploads/image5.jpg" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" /></a>',
 				'args'                      => array( 'prev' => false ),
 			),
 			'with text when has next link'     => array(
diff --git a/tests/media/getNextImageLink.php b/tests/media/getNextImageLink.php
index 86a843cbfc..b26f1fcd69 100644
--- a/tests/media/getNextImageLink.php
+++ b/tests/media/getNextImageLink.php
@@ -31,7 +31,7 @@ class Tests_Media_GetNextImageLink extends WP_Test_Adjacent_Image_Link_TestCase
 			'when has next link'           => array(
 				'current_attachment_index'  => 4,
 				'expected_attachment_index' => 5,
-				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="http://example.org/wp-content/uploads/image5.jpg" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" /></a>',
+				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="' . WP_CONTENT_URL . '/uploads/image5.jpg" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" /></a>',
 			),
 			'with text when has next link' => array(
 				'current_attachment_index'  => 4,
diff --git a/tests/media/getPostGalleries.php b/tests/media/getPostGalleries.php
index bd114b899f..363fea8149 100644
--- a/tests/media/getPostGalleries.php
+++ b/tests/media/getPostGalleries.php
@@ -4,19 +4,16 @@
  *
  * @covers ::get_post_galleries
  */
-class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
+class Tests_Media_GetPostGalleries extends WP_UnitTestCase {
 
-	public function set_up() {
-		parent::set_up();
-		$this->img_meta = array(
-			'width'  => 100,
-			'height' => 100,
-			'sizes'  => '',
-		);
-	}
+	const IMG_META = array(
+		'width'  => 100,
+		'height' => 100,
+		'sizes'  => '',
+	);
 
 	/**
-	 * Test that an empty array is returned for a post that does not exist.
+	 * Tests that an empty array is returned for a post that does not exist.
 	 *
 	 * @ticket 43826
 	 */
@@ -26,12 +23,12 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test that an empty array is returned for a post that has no gallery.
+	 * Tests that an empty array is returned for a post that has no gallery.
 	 *
 	 * @ticket 43826
 	 */
 	public function test_returns_empty_array_with_post_with_no_gallery() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => '<p>A post with no gallery</p>',
 			)
@@ -42,7 +39,83 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test that no srcs are returned for a shortcode gallery
+	 * Tests that only galleries are returned.
+	 *
+	 * @dataProvider data_returns_only_galleries
+	 *
+	 * @ticket 55203
+	 *
+	 * @param string $content The content of the post.
+	 * @param string $needle  The content of a non-gallery block.
+	 */
+	public function test_returns_only_galleries( $content, $needle ) {
+		$image_id = self::factory()->attachment->create_object(
+			array(
+				'file'           => 'test.jpg',
+				'post_parent'    => 0,
+				'post_mime_type' => 'image/jpeg',
+				'post_type'      => 'attachment',
+			)
+		);
+
+		$image_url = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/test.jpg';
+
+		$content = str_replace(
+			array( 'IMAGE_ID', 'IMAGE_URL' ),
+			array( $image_id, $image_url ),
+			$content
+		);
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $content,
+			)
+		);
+
+		$galleries = get_post_galleries( $post_id );
+		$actual    = implode( '', $galleries );
+
+		$this->assertStringNotContainsString( $needle, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_returns_only_galleries() {
+		$gallery = '
+		<!-- wp:gallery {"linkTo":"none","className":"columns-2"} -->
+		<figure
+		class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"
+		>
+		<!-- wp:image {"id":IMAGE_ID,"sizeSlug":"large","linkDestination":"none"} -->
+		<figure class="wp-block-image size-large">
+		<img
+		src="IMAGE_URL"
+		alt="Image gallery image"
+		class="wp-image-IMAGE_ID"
+		/>
+		</figure>
+		<!-- /wp:image -->
+		</figure>
+		<!-- /wp:gallery -->
+		';
+
+		return array(
+			'a paragraph before a gallery' => array(
+				'content' => '<!-- wp:paragraph --><p>A paragraph before a gallery.</p><!-- /wp:paragraph -->' . $gallery,
+				'needle'  => 'A paragraph before a gallery.',
+			),
+			'a paragraph after a gallery'  => array(
+				'content' => $gallery . '<!-- wp:paragraph --><p>A paragraph after a gallery.</p><!-- /wp:paragraph -->',
+				'needle'  => 'A paragraph after a gallery.',
+			),
+		);
+	}
+
+	/**
+	 * Tests that no srcs are returned for a shortcode gallery
 	 * in a post with no attached images.
 	 *
 	 * @ticket 39304
@@ -51,7 +124,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	 */
 	public function test_returns_no_srcs_with_shortcode_in_post_with_no_attached_images() {
 		// Set up an unattached image.
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => 0,
@@ -60,7 +133,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 			)
 		);
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => '[gallery]',
 			)
@@ -74,8 +147,10 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 			'The galleries array is empty.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -89,7 +164,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test that no srcs are returned for a gallery block
+	 * Tests that no srcs are returned for a gallery block
 	 * in a post with no attached images.
 	 *
 	 * @ticket 43826
@@ -98,7 +173,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	 */
 	public function test_returns_no_srcs_with_block_in_post_with_no_attached_images() {
 		// Set up an unattached image.
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => 0,
@@ -107,7 +182,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 			)
 		);
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => '<!-- wp:gallery -->',
 			)
@@ -121,15 +196,19 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of strings
-		// instead of an array of arrays.
+		/*
+		 * The method can return an array of strings
+		 * instead of an array of arrays.
+		 */
 		$this->assertIsArray(
 			$galleries[0],
 			'The returned data does not contain an array.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -143,7 +222,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test that no srcs are returned for a gallery block v2
+	 * Tests that no srcs are returned for a gallery block v2
 	 * in a post with no attached images.
 	 *
 	 * @ticket 43826
@@ -152,7 +231,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 	 */
 	public function test_returns_no_srcs_with_block_v2_in_post_with_no_attached_images() {
 		// Set up an unattached image.
-		$image_id = $this->factory->attachment->create_object(
+		$image_id = self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => 0,
@@ -181,7 +260,7 @@ class Tests_Functions_getPostGalleries extends WP_UnitTestCase {
 <!-- /wp:gallery -->
 BLOB;
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => $blob,
 			)
@@ -196,15 +275,19 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of strings
-		// instead of an array of arrays.
+		/*
+		 * The method can return an array of strings
+		 * instead of an array of arrays.
+		 */
 		$this->assertIsArray(
 			$galleries[0],
 			'The returned data does not contain an array.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -219,26 +302,26 @@ BLOB;
 	}
 
 	/**
-	 * Test that HTML is returned for a shortcode gallery.
+	 * Tests that HTML is returned for a shortcode gallery.
 	 *
 	 * @ticket 43826
 	 *
 	 * @group shortcode
 	 */
 	public function test_returns_html_with_shortcode_gallery() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => 'I have no gallery',
 			)
 		);
 
-		$post_id_two = $this->factory->post->create(
+		$post_id_two = self::factory()->post->create(
 			array(
 				'post_content' => "[gallery id='$post_id']",
 			)
 		);
 
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -256,8 +339,10 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of arrays
-		// instead of an array of strings.
+		/*
+		 * The method can return an array of arrays
+		 * instead of an array of strings.
+		 */
 		$this->assertIsString(
 			$galleries[0],
 			'Did not return the data as a string.'
@@ -271,21 +356,21 @@ BLOB;
 	}
 
 	/**
-	 * Test that HTML is returned for a block gallery.
+	 * Tests that HTML is returned for a block gallery.
 	 *
 	 * @ticket 43826
 	 *
 	 * @group blocks
 	 */
 	public function test_returns_html_with_block_gallery() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => 'I have no gallery.',
 			)
 		);
 
 		// Set up an unattached image.
-		$image_id = $this->factory->attachment->create(
+		$image_id = self::factory()->attachment->create(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -302,7 +387,7 @@ BLOB;
 <!-- /wp:gallery -->
 BLOB;
 
-		$post_id_two = $this->factory->post->create(
+		$post_id_two = self::factory()->post->create(
 			array(
 				'post_content' => $blob,
 			)
@@ -317,8 +402,10 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of arrays
-		// instead of an array of strings.
+		/*
+		 * The method can return an array of arrays
+		 * instead of an array of strings.
+		 */
 		$this->assertIsString(
 			$galleries[0],
 			'Did not return the data as a string.'
@@ -332,14 +419,14 @@ BLOB;
 	}
 
 	/**
-	 * Test that HTML is returned for a block gallery v2.
+	 * Tests that HTML is returned for a block gallery v2.
 	 *
 	 * @ticket 43826
 	 *
 	 * @group blocks
 	 */
 	public function test_returns_html_with_block_gallery_v2() {
-		$image_id = $this->factory->attachment->create_object(
+		$image_id = self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => 0,
@@ -368,7 +455,7 @@ BLOB;
 <!-- /wp:gallery -->
 BLOB;
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => $blob,
 			)
@@ -383,8 +470,10 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of arrays
-		// instead of an array of strings.
+		/*
+		 * The method can return an array of arrays
+		 * instead of an array of strings.
+		 */
 		$this->assertIsString(
 			$galleries[0],
 			'Did not return the data as a string.'
@@ -398,7 +487,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that the global post object does not override
+	 * Tests that the global post object does not override
 	 * a provided post ID with a shortcode gallery.
 	 *
 	 * @ticket 39304
@@ -406,17 +495,17 @@ BLOB;
 	 * @group shortcode
 	 */
 	public function test_respects_post_id_with_shortcode_gallery() {
-		$global_post_id = $this->factory->post->create(
+		$global_post_id = self::factory()->post->create(
 			array(
 				'post_content' => 'Global Post',
 			)
 		);
-		$post_id        = $this->factory->post->create(
+		$post_id        = self::factory()->post->create(
 			array(
 				'post_content' => '[gallery]',
 			)
 		);
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -439,8 +528,10 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -455,7 +546,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that the global post object does not override
+	 * Tests that the global post object does not override
 	 * a provided post ID with a block gallery.
 	 *
 	 * @ticket 43826
@@ -475,7 +566,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -486,7 +577,7 @@ BLOB;
 
 		$ids_joined = join( ',', $ids );
 
-		$global_post_id = $this->factory->post->create(
+		$global_post_id = self::factory()->post->create(
 			array(
 				'post_content' => 'Global Post',
 			)
@@ -497,12 +588,12 @@ BLOB;
 <!-- /wp:gallery -->
 BLOB;
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => $blob,
 			)
 		);
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -525,8 +616,10 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -546,7 +639,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that the global post object does not override
+	 * Tests that the global post object does not override
 	 * a provided post ID with a block gallery v2.
 	 *
 	 * @ticket 43826
@@ -562,9 +655,9 @@ BLOB;
 				'post_type'      => 'attachment',
 			)
 		);
-		$metadata       = array_merge( array( 'file' => 'image1.jpg' ), $this->img_meta );
+		$metadata       = array_merge( array( 'file' => 'image1.jpg' ), self::IMG_META );
 		$url            = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . 'image1.jpg';
-		$global_post_id = $this->factory->post->create(
+		$global_post_id = self::factory()->post->create(
 			array(
 				'post_content' => 'Global Post',
 			)
@@ -590,12 +683,12 @@ BLOB;
 <!-- /wp:gallery -->
 BLOB;
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => $blob,
 			)
 		);
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -618,8 +711,10 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -639,7 +734,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that the gallery only contains images specified in
+	 * Tests that the gallery only contains images specified in
 	 * the shortcode's id attribute.
 	 *
 	 * @ticket 39304
@@ -647,17 +742,17 @@ BLOB;
 	 * @group shortcode
 	 */
 	public function test_respects_shortcode_id_attribute() {
-		$post_id     = $this->factory->post->create(
+		$post_id     = self::factory()->post->create(
 			array(
 				'post_content' => 'No gallery defined',
 			)
 		);
-		$post_id_two = $this->factory->post->create(
+		$post_id_two = self::factory()->post->create(
 			array(
 				'post_content' => "[gallery id='$post_id']",
 			)
 		);
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -688,15 +783,19 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of strings
-		// instead of an array of arrays.
+		/*
+		 * The method can return an array of strings
+		 * instead of an array of arrays.
+		 */
 		$this->assertIsArray(
 			$galleries[0],
 			'The returned data does not contain an array.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -711,7 +810,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that galleries only contain images specified in the
+	 * Tests that galleries only contain images specified in the
 	 * id attribute of their respective shortcode and block.
 	 *
 	 * @ticket 43826
@@ -720,7 +819,10 @@ BLOB;
 	 * @group shortcode
 	 */
 	public function test_respects_shortcode_and_block_id_attributes() {
-		// Test the get_post_galleries() function in $html=false mode, with both shortcode and block galleries
+		/*
+		 * Test the get_post_galleries() function in `$html = false` mode,
+		 * with both shortcode and block galleries.
+		 */
 		$ids      = array();
 		$imgs     = array();
 		$ids_srcs = array();
@@ -733,7 +835,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -772,7 +874,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that galleries contain the additional attributes
+	 * Tests that galleries contain the additional attributes
 	 * specified for their respective shortcode and block.
 	 *
 	 * @ticket 43826
@@ -781,7 +883,10 @@ BLOB;
 	 * @group shortcode
 	 */
 	public function test_respects_additional_shortcode_and_block_attributes() {
-		// Test attributes returned by get_post_galleries() function in $html=false mode, with both shortcode and block galleries
+		/*
+		 * Test attributes returned by get_post_galleries() function in `$html = false` mode,
+		 * with both shortcode and block galleries.
+		 */
 		$ids      = array();
 		$imgs     = array();
 		$ids_srcs = array();
@@ -794,7 +899,7 @@ BLOB;
 					'post_type'      => 'attachment',
 				)
 			);
-			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), $this->img_meta );
+			$metadata      = array_merge( array( 'file' => "image$i.jpg" ), self::IMG_META );
 			wp_update_attachment_metadata( $attachment_id, $metadata );
 			$ids[]      = $attachment_id;
 			$url        = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . "image$i.jpg";
@@ -819,14 +924,14 @@ BLOB;
 			array(
 				array(
 					'ids'  => $ids1_joined,
-					// The shortcode code passes arbitrary attributes
+					// The shortcode code passes arbitrary attributes.
 					'type' => 'type',
 					'foo'  => 'bar',
 					'src'  => array_slice( $ids_srcs, 0, 3 ),
 				),
 				array(
 					'ids' => $ids2_joined,
-					// The block only passes ids, no other attributes
+					// The block only passes ids, no other attributes.
 					'src' => array_slice( $ids_srcs, 3, 3 ),
 				),
 			),
@@ -836,7 +941,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that srcs are retrieved from the HTML of a block gallery
+	 * Tests that srcs are retrieved from the HTML of a block gallery
 	 * that has no JSON blob.
 	 *
 	 * @ticket 43826
@@ -845,7 +950,7 @@ BLOB;
 	 */
 	public function test_returns_srcs_from_html_with_block_with_no_json_blob() {
 		// Set up an unattached image.
-		$image_id = $this->factory->attachment->create_object(
+		$image_id = self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => 0,
@@ -867,7 +972,7 @@ BLOB;
 <!-- /wp:gallery -->
 BLOB;
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => $blob,
 			)
@@ -882,15 +987,19 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of strings
-		// instead of an array of arrays.
+		/*
+		 * The method can return an array of strings
+		 * instead of an array of arrays.
+		 */
 		$this->assertIsArray(
 			$galleries[0],
 			'The returned data does not contain an array.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
@@ -905,7 +1014,7 @@ BLOB;
 	}
 
 	/**
-	 * Test that srcs are returned for a block gallery nested within
+	 * Tests that srcs are returned for a block gallery nested within
 	 * other blocks.
 	 *
 	 * @ticket 43826
@@ -913,12 +1022,12 @@ BLOB;
 	 * @group blocks
 	 */
 	public function test_returns_srcs_with_nested_block_gallery() {
-		$post_id  = $this->factory->post->create(
+		$post_id  = self::factory()->post->create(
 			array(
 				'post_content' => 'I have no gallery.',
 			)
 		);
-		$image_id = $this->factory->attachment->create_object(
+		$image_id = self::factory()->attachment->create_object(
 			array(
 				'file'           => 'test.jpg',
 				'post_parent'    => $post_id,
@@ -936,7 +1045,7 @@ BLOB;
 <!-- /wp:columns -->
 BLOB;
 
-		$post_id_two = $this->factory->post->create( array( 'post_content' => $blob ) );
+		$post_id_two = self::factory()->post->create( array( 'post_content' => $blob ) );
 
 		$galleries = get_post_galleries( $post_id_two, false );
 
@@ -946,15 +1055,19 @@ BLOB;
 			'The galleries array is empty.'
 		);
 
-		// The method can return an array of strings
-		// instead of an array of arrays.
+		/*
+		 * The method can return an array of strings
+		 * instead of an array of arrays.
+		 */
 		$this->assertIsArray(
 			$galleries[0],
 			'The returned data does not contain an array.'
 		);
 
-		// This prevents future changes from causing
-		// backwards compatibility breaks.
+		/*
+		 * This prevents future changes from causing
+		 * backwards compatibility breaks.
+		 */
 		$this->assertArrayHasKey(
 			'src',
 			$galleries[0],
diff --git a/tests/media/getPreviousImageLink.php b/tests/media/getPreviousImageLink.php
index 2d2d511e4f..36652e75ad 100644
--- a/tests/media/getPreviousImageLink.php
+++ b/tests/media/getPreviousImageLink.php
@@ -31,7 +31,7 @@ class Tests_Media_GetPreviousImageLink extends WP_Test_Adjacent_Image_Link_TestC
 			'when has previous link'           => array(
 				'current_attachment_index'  => 3,
 				'expected_attachment_index' => 2,
-				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="http://example.org/wp-content/uploads/image2.jpg" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" /></a>',
+				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="' . WP_CONTENT_URL . '/uploads/image2.jpg" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" /></a>',
 			),
 			'with text when has previous link' => array(
 				'current_attachment_index'  => 3,
diff --git a/tests/media/nextImageLink.php b/tests/media/nextImageLink.php
index 7799779fa8..569e1900ce 100644
--- a/tests/media/nextImageLink.php
+++ b/tests/media/nextImageLink.php
@@ -30,7 +30,7 @@ class Tests_Media_NextImageLink extends WP_Test_Adjacent_Image_Link_TestCase {
 			'when has next link'           => array(
 				'current_attachment_index'  => 4,
 				'expected_attachment_index' => 5,
-				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="http://example.org/wp-content/uploads/image5.jpg" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" /></a>',
+				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="' . WP_CONTENT_URL . '/uploads/image5.jpg" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" /></a>',
 			),
 			'with text when has next link' => array(
 				'current_attachment_index'  => 4,
diff --git a/tests/media/previousImageLink.php b/tests/media/previousImageLink.php
index 11d6583d6a..c75e083537 100644
--- a/tests/media/previousImageLink.php
+++ b/tests/media/previousImageLink.php
@@ -30,7 +30,7 @@ class Tests_Media_PreviousImageLink extends WP_Test_Adjacent_Image_Link_TestCase
 			'when has previous link'           => array(
 				'current_attachment_index'  => 3,
 				'expected_attachment_index' => 2,
-				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="http://example.org/wp-content/uploads/image2.jpg" class="attachment-thumbnail size-thumbnail" alt="" loading="lazy" /></a>',
+				'expected'                  => '<a href=\'http://example.org/?attachment_id=%%ID%%\'><img width="1" height="1" src="' . WP_CONTENT_URL . '/uploads/image2.jpg" class="attachment-thumbnail size-thumbnail" alt="" decoding="async" loading="lazy" /></a>',
 			),
 			'with text when has previous link' => array(
 				'current_attachment_index'  => 3,
diff --git a/tests/media/wpImageTagAddDecodingAttr.php b/tests/media/wpImageTagAddDecodingAttr.php
new file mode 100644
index 0000000000..76fa203b7e
--- /dev/null
+++ b/tests/media/wpImageTagAddDecodingAttr.php
@@ -0,0 +1,164 @@
+<?php
+
+/**
+ * Tests the `wp_img_tag_add_decoding_attr()` function.
+ *
+ * @group media
+ * @covers ::wp_img_tag_add_decoding_attr
+ */
+class Tests_Media_Wp_Img_Tag_Add_Decoding_Attr extends WP_UnitTestCase {
+	/**
+	 * Tests that the `wp_img_tag_add_decoding_attr()` function should add
+	 * the 'decoding' attribute.
+	 *
+	 * @ticket 53232
+	 *
+	 * @dataProvider data_should_add_decoding_attr
+	 *
+	 * @param string $image    The HTML `img` tag where the attribute should be added.
+	 * @param string $context  Additional context to pass to the filters.
+	 * @param string $decoding The value for the 'decoding' attribute. 'no value' for default.
+	 * @param string $expected The expected `img` tag.
+	 */
+	public function test_should_add_decoding_attr( $image, $context, $decoding, $expected ) {
+		// Falsey values are allowed in the filter, cannot use `null` or `false` here.
+		if ( 'no value' !== $decoding ) {
+			add_filter(
+				'wp_img_tag_add_decoding_attr',
+				static function( $value ) use ( $decoding ) {
+					return $decoding;
+				}
+			);
+		}
+
+		$this->assertSame( $expected, wp_img_tag_add_decoding_attr( $image, $context ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_add_decoding_attr() {
+		return array(
+			'default' => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 'no value',
+				'expected' => '<img decoding="async" src="my-image.png">',
+			),
+			'async'   => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 'async',
+				'expected' => '<img decoding="async" src="my-image.png">',
+			),
+			'sync'    => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 'sync',
+				'expected' => '<img decoding="sync" src="my-image.png">',
+			),
+			'auto'    => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 'auto',
+				'expected' => '<img decoding="auto" src="my-image.png">',
+			),
+		);
+	}
+
+	/**
+	 * Tests that the `wp_img_tag_add_decoding_attr()` function should not add
+	 * the 'decoding' attribute.
+	 *
+	 * @ticket 53232
+	 *
+	 * @dataProvider data_should_not_add_decoding_attr
+	 *
+	 * @param string $image    The HTML `img` tag where the attribute should be added.
+	 * @param string $context  Additional context to pass to the filters.
+	 * @param mixed  $decoding The value for the 'decoding' attribute. 'no value' for default.
+	 * @param string $expected The expected `img` tag.
+	 */
+	public function test_should_not_add_decoding_attr( $image, $context, $decoding, $expected ) {
+		// Falsey values are allowed in the filter, cannot use `null` or `false` here.
+		if ( 'no value' !== $decoding ) {
+			add_filter(
+				'wp_img_tag_add_decoding_attr',
+				static function( $value ) use ( $decoding ) {
+					return $decoding;
+				}
+			);
+		}
+
+		$this->assertSame( $expected, wp_img_tag_add_decoding_attr( $image, $context, $expected ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_should_not_add_decoding_attr() {
+		return array(
+			// Unhappy paths.
+			'lazy (unaccepted value)' => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 'lazy',
+				'expected' => '<img src="my-image.png">',
+			),
+			'a non-string value'      => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => array( 'sync' ),
+				'expected' => '<img src="my-image.png">',
+			),
+
+			// Falsey values.
+			'false'                   => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => false,
+				'expected' => '<img src="my-image.png">',
+			),
+			'null'                    => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => null,
+				'expected' => '<img src="my-image.png">',
+			),
+			'empty string'            => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => '',
+				'expected' => '<img src="my-image.png">',
+			),
+			'empty array'             => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => array(),
+				'expected' => '<img src="my-image.png">',
+			),
+			'0 int'                   => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 0,
+				'expected' => '<img src="my-image.png">',
+			),
+			'0 string'                => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => '0',
+				'expected' => '<img src="my-image.png">',
+			),
+			'0.0 float'               => array(
+				'image'    => '<img src="my-image.png">',
+				'context'  => '',
+				'decoding' => 0.0,
+				'expected' => '<img src="my-image.png">',
+			),
+		);
+	}
+}
diff --git a/tests/menu/walker-nav-menu-edit.php b/tests/menu/walker-nav-menu-edit.php
index 345bf82d76..0df5531975 100644
--- a/tests/menu/walker-nav-menu-edit.php
+++ b/tests/menu/walker-nav-menu-edit.php
@@ -5,6 +5,12 @@
  * @group walker
  */
 class Tests_Menu_Walker_Nav_Menu_Edit extends WP_UnitTestCase {
+
+	/**
+	 * @var \Walker_Nav_Menu_Edit
+	 */
+	private $walker;
+
 	protected $_wp_nav_menu_max_depth;
 
 	public function set_up() {
@@ -34,7 +40,7 @@ class Tests_Menu_Walker_Nav_Menu_Edit extends WP_UnitTestCase {
 	public function test_original_title_prefix_should_not_be_shown_if_empty() {
 		$expected = '';
 
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		$item = array(
 			'classes'          => array(),
diff --git a/tests/menu/walker-nav-menu.php b/tests/menu/walker-nav-menu.php
index b004819134..1dda827c1e 100644
--- a/tests/menu/walker-nav-menu.php
+++ b/tests/menu/walker-nav-menu.php
@@ -10,6 +10,13 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public $walker;
 
+	/**
+	 * Original nav menu max depth.
+	 *
+	 * @var int
+	 */
+	private $orig_wp_nav_menu_max_depth;
+
 	/**
 	 * Setup.
 	 */
@@ -22,7 +29,7 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 		require_once ABSPATH . 'wp-includes/class-walker-nav-menu.php';
 		$this->walker = new Walker_Nav_Menu();
 
-		$this->_wp_nav_menu_max_depth = $_wp_nav_menu_max_depth;
+		$this->orig_wp_nav_menu_max_depth = $_wp_nav_menu_max_depth;
 	}
 
 	/**
@@ -31,7 +38,7 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 	public function tear_down() {
 		global $_wp_nav_menu_max_depth;
 
-		$_wp_nav_menu_max_depth = $this->_wp_nav_menu_max_depth;
+		$_wp_nav_menu_max_depth = $this->orig_wp_nav_menu_max_depth;
 		parent::tear_down();
 	}
 
@@ -42,7 +49,7 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public function test_noopener_no_referrer_for_target_blank() {
 		$actual     = '';
-		$post_id    = $this->factory->post->create();
+		$post_id    = self::factory()->post->create();
 		$post_title = get_the_title( $post_id );
 
 		$item = array(
@@ -73,7 +80,7 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public function test_start_el_with_empty_attributes( $value, $expected ) {
 		$output     = '';
-		$post_id    = $this->factory->post->create();
+		$post_id    = self::factory()->post->create();
 		$post_title = get_the_title( $post_id );
 
 		$item = array(
diff --git a/tests/menu/wpAjaxMenuQuickSearch.php b/tests/menu/wpAjaxMenuQuickSearch.php
index 232b729c23..9fceb5fc95 100644
--- a/tests/menu/wpAjaxMenuQuickSearch.php
+++ b/tests/menu/wpAjaxMenuQuickSearch.php
@@ -104,7 +104,7 @@ class Tests_Menu_WpAjaxMenuQuickSeach extends WP_UnitTestCase {
 	public function test_search_should_return_unassigned_term_items() {
 		register_taxonomy( 'wptests_tax', 'post' );
 
-		$this->factory->term->create(
+		self::factory()->term->create(
 			array(
 				'taxonomy' => 'wptests_tax',
 				'name'     => 'foobar',
diff --git a/tests/meta.php b/tests/meta.php
index b6fd1c71ba..d49f106821 100644
--- a/tests/meta.php
+++ b/tests/meta.php
@@ -6,6 +6,14 @@
 class Tests_Meta extends WP_UnitTestCase {
 	protected $updated_mids = array();
 
+	/**
+	 * @var \WP_User
+	 */
+	private $author;
+
+	private $meta_id;
+	private $delete_meta_id;
+
 	public function set_up() {
 		parent::set_up();
 		$this->author         = new WP_User( self::factory()->user->create( array( 'role' => 'author' ) ) );
diff --git a/tests/meta/slashes.php b/tests/meta/slashes.php
index 8cd5005762..d9eebeb397 100644
--- a/tests/meta/slashes.php
+++ b/tests/meta/slashes.php
@@ -6,6 +6,20 @@
  * @ticket 21767
  */
 class Tests_Meta_Slashes extends WP_UnitTestCase {
+
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
+
 	protected static $editor_id;
 	protected static $post_id;
 	protected static $comment_id;
@@ -22,14 +36,6 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 		parent::set_up();
 
 		wp_set_current_user( self::$editor_id );
-
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 	}
 
 	/**
@@ -53,19 +59,19 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 		$_POST['post_ID']       = $post_id;
 		$_POST['metakeyselect'] = '#NONE#';
 		$_POST['metakeyinput']  = 'slash_test_0';
-		$_POST['metavalue']     = $this->slash_6;
+		$_POST['metavalue']     = self::SLASH_6;
 		$_POST['meta']          = array(
 			$meta_1 => array(
 				'key'   => 'slash_test_1',
-				'value' => $this->slash_1,
+				'value' => self::SLASH_1,
 			),
 			$meta_2 => array(
 				'key'   => 'slash_test_2',
-				'value' => $this->slash_3,
+				'value' => self::SLASH_3,
 			),
 			$meta_3 => array(
 				'key'   => 'slash_test_3',
-				'value' => $this->slash_4,
+				'value' => self::SLASH_4,
 			),
 		);
 
@@ -74,28 +80,28 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 		edit_post();
 		$post = get_post( $post_id );
 
-		$this->assertSame( $this->slash_6, get_post_meta( $post_id, 'slash_test_0', true ) );
-		$this->assertSame( $this->slash_1, get_post_meta( $post_id, 'slash_test_1', true ) );
-		$this->assertSame( $this->slash_3, get_post_meta( $post_id, 'slash_test_2', true ) );
-		$this->assertSame( $this->slash_4, get_post_meta( $post_id, 'slash_test_3', true ) );
+		$this->assertSame( self::SLASH_6, get_post_meta( $post_id, 'slash_test_0', true ) );
+		$this->assertSame( self::SLASH_1, get_post_meta( $post_id, 'slash_test_1', true ) );
+		$this->assertSame( self::SLASH_3, get_post_meta( $post_id, 'slash_test_2', true ) );
+		$this->assertSame( self::SLASH_4, get_post_meta( $post_id, 'slash_test_3', true ) );
 
 		$_POST                  = array();
 		$_POST['post_ID']       = $post_id;
 		$_POST['metakeyselect'] = '#NONE#';
 		$_POST['metakeyinput']  = 'slash_test_0';
-		$_POST['metavalue']     = $this->slash_7;
+		$_POST['metavalue']     = self::SLASH_7;
 		$_POST['meta']          = array(
 			$meta_1 => array(
 				'key'   => 'slash_test_1',
-				'value' => $this->slash_2,
+				'value' => self::SLASH_2,
 			),
 			$meta_2 => array(
 				'key'   => 'slash_test_2',
-				'value' => $this->slash_4,
+				'value' => self::SLASH_4,
 			),
 			$meta_3 => array(
 				'key'   => 'slash_test_3',
-				'value' => $this->slash_5,
+				'value' => self::SLASH_5,
 			),
 		);
 
@@ -104,9 +110,9 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 		edit_post();
 		$post = get_post( $post_id );
 
-		$this->assertSame( $this->slash_2, get_post_meta( $post_id, 'slash_test_1', true ) );
-		$this->assertSame( $this->slash_4, get_post_meta( $post_id, 'slash_test_2', true ) );
-		$this->assertSame( $this->slash_5, get_post_meta( $post_id, 'slash_test_3', true ) );
+		$this->assertSame( self::SLASH_2, get_post_meta( $post_id, 'slash_test_1', true ) );
+		$this->assertSame( self::SLASH_4, get_post_meta( $post_id, 'slash_test_2', true ) );
+		$this->assertSame( self::SLASH_5, get_post_meta( $post_id, 'slash_test_3', true ) );
 	}
 
 	/**
@@ -115,13 +121,13 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 	public function test_add_post_meta() {
 		$post_id = self::$post_id;
 
-		add_post_meta( $post_id, 'slash_test_1', addslashes( $this->slash_1 ) );
-		add_post_meta( $post_id, 'slash_test_2', addslashes( $this->slash_3 ) );
-		add_post_meta( $post_id, 'slash_test_3', addslashes( $this->slash_4 ) );
+		add_post_meta( $post_id, 'slash_test_1', addslashes( self::SLASH_1 ) );
+		add_post_meta( $post_id, 'slash_test_2', addslashes( self::SLASH_3 ) );
+		add_post_meta( $post_id, 'slash_test_3', addslashes( self::SLASH_4 ) );
 
-		$this->assertSame( $this->slash_1, get_post_meta( $post_id, 'slash_test_1', true ) );
-		$this->assertSame( $this->slash_3, get_post_meta( $post_id, 'slash_test_2', true ) );
-		$this->assertSame( $this->slash_4, get_post_meta( $post_id, 'slash_test_3', true ) );
+		$this->assertSame( self::SLASH_1, get_post_meta( $post_id, 'slash_test_1', true ) );
+		$this->assertSame( self::SLASH_3, get_post_meta( $post_id, 'slash_test_2', true ) );
+		$this->assertSame( self::SLASH_4, get_post_meta( $post_id, 'slash_test_3', true ) );
 	}
 
 	/**
@@ -130,13 +136,13 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 	public function test_update_post_meta() {
 		$post_id = self::$post_id;
 
-		update_post_meta( $post_id, 'slash_test_1', addslashes( $this->slash_1 ) );
-		update_post_meta( $post_id, 'slash_test_2', addslashes( $this->slash_3 ) );
-		update_post_meta( $post_id, 'slash_test_3', addslashes( $this->slash_4 ) );
+		update_post_meta( $post_id, 'slash_test_1', addslashes( self::SLASH_1 ) );
+		update_post_meta( $post_id, 'slash_test_2', addslashes( self::SLASH_3 ) );
+		update_post_meta( $post_id, 'slash_test_3', addslashes( self::SLASH_4 ) );
 
-		$this->assertSame( $this->slash_1, get_post_meta( $post_id, 'slash_test_1', true ) );
-		$this->assertSame( $this->slash_3, get_post_meta( $post_id, 'slash_test_2', true ) );
-		$this->assertSame( $this->slash_4, get_post_meta( $post_id, 'slash_test_3', true ) );
+		$this->assertSame( self::SLASH_1, get_post_meta( $post_id, 'slash_test_1', true ) );
+		$this->assertSame( self::SLASH_3, get_post_meta( $post_id, 'slash_test_2', true ) );
+		$this->assertSame( self::SLASH_4, get_post_meta( $post_id, 'slash_test_3', true ) );
 	}
 
 	/**
@@ -145,21 +151,21 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 	public function test_add_comment_meta() {
 		$comment_id = self::$comment_id;
 
-		add_comment_meta( $comment_id, 'slash_test_1', $this->slash_1 );
-		add_comment_meta( $comment_id, 'slash_test_2', $this->slash_3 );
-		add_comment_meta( $comment_id, 'slash_test_3', $this->slash_5 );
+		add_comment_meta( $comment_id, 'slash_test_1', self::SLASH_1 );
+		add_comment_meta( $comment_id, 'slash_test_2', self::SLASH_3 );
+		add_comment_meta( $comment_id, 'slash_test_3', self::SLASH_5 );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), get_comment_meta( $comment_id, 'slash_test_1', true ) );
-		$this->assertSame( wp_unslash( $this->slash_3 ), get_comment_meta( $comment_id, 'slash_test_2', true ) );
-		$this->assertSame( wp_unslash( $this->slash_5 ), get_comment_meta( $comment_id, 'slash_test_3', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), get_comment_meta( $comment_id, 'slash_test_1', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), get_comment_meta( $comment_id, 'slash_test_2', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), get_comment_meta( $comment_id, 'slash_test_3', true ) );
 
-		add_comment_meta( $comment_id, 'slash_test_4', $this->slash_2 );
-		add_comment_meta( $comment_id, 'slash_test_5', $this->slash_4 );
-		add_comment_meta( $comment_id, 'slash_test_6', $this->slash_6 );
+		add_comment_meta( $comment_id, 'slash_test_4', self::SLASH_2 );
+		add_comment_meta( $comment_id, 'slash_test_5', self::SLASH_4 );
+		add_comment_meta( $comment_id, 'slash_test_6', self::SLASH_6 );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), get_comment_meta( $comment_id, 'slash_test_4', true ) );
-		$this->assertSame( wp_unslash( $this->slash_4 ), get_comment_meta( $comment_id, 'slash_test_5', true ) );
-		$this->assertSame( wp_unslash( $this->slash_6 ), get_comment_meta( $comment_id, 'slash_test_6', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), get_comment_meta( $comment_id, 'slash_test_4', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), get_comment_meta( $comment_id, 'slash_test_5', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), get_comment_meta( $comment_id, 'slash_test_6', true ) );
 	}
 
 	/**
@@ -172,21 +178,21 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 		add_comment_meta( $comment_id, 'slash_test_2', 'foo' );
 		add_comment_meta( $comment_id, 'slash_test_3', 'foo' );
 
-		update_comment_meta( $comment_id, 'slash_test_1', $this->slash_1 );
-		update_comment_meta( $comment_id, 'slash_test_2', $this->slash_3 );
-		update_comment_meta( $comment_id, 'slash_test_3', $this->slash_5 );
+		update_comment_meta( $comment_id, 'slash_test_1', self::SLASH_1 );
+		update_comment_meta( $comment_id, 'slash_test_2', self::SLASH_3 );
+		update_comment_meta( $comment_id, 'slash_test_3', self::SLASH_5 );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), get_comment_meta( $comment_id, 'slash_test_1', true ) );
-		$this->assertSame( wp_unslash( $this->slash_3 ), get_comment_meta( $comment_id, 'slash_test_2', true ) );
-		$this->assertSame( wp_unslash( $this->slash_5 ), get_comment_meta( $comment_id, 'slash_test_3', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), get_comment_meta( $comment_id, 'slash_test_1', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), get_comment_meta( $comment_id, 'slash_test_2', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), get_comment_meta( $comment_id, 'slash_test_3', true ) );
 
-		update_comment_meta( $comment_id, 'slash_test_1', $this->slash_2 );
-		update_comment_meta( $comment_id, 'slash_test_2', $this->slash_4 );
-		update_comment_meta( $comment_id, 'slash_test_3', $this->slash_6 );
+		update_comment_meta( $comment_id, 'slash_test_1', self::SLASH_2 );
+		update_comment_meta( $comment_id, 'slash_test_2', self::SLASH_4 );
+		update_comment_meta( $comment_id, 'slash_test_3', self::SLASH_6 );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), get_comment_meta( $comment_id, 'slash_test_1', true ) );
-		$this->assertSame( wp_unslash( $this->slash_4 ), get_comment_meta( $comment_id, 'slash_test_2', true ) );
-		$this->assertSame( wp_unslash( $this->slash_6 ), get_comment_meta( $comment_id, 'slash_test_3', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), get_comment_meta( $comment_id, 'slash_test_1', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), get_comment_meta( $comment_id, 'slash_test_2', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), get_comment_meta( $comment_id, 'slash_test_3', true ) );
 	}
 
 	/**
@@ -195,21 +201,21 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 	public function test_add_user_meta() {
 		$user_id = self::$user_id;
 
-		add_user_meta( $user_id, 'slash_test_1', $this->slash_1 );
-		add_user_meta( $user_id, 'slash_test_2', $this->slash_3 );
-		add_user_meta( $user_id, 'slash_test_3', $this->slash_5 );
+		add_user_meta( $user_id, 'slash_test_1', self::SLASH_1 );
+		add_user_meta( $user_id, 'slash_test_2', self::SLASH_3 );
+		add_user_meta( $user_id, 'slash_test_3', self::SLASH_5 );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), get_user_meta( $user_id, 'slash_test_1', true ) );
-		$this->assertSame( wp_unslash( $this->slash_3 ), get_user_meta( $user_id, 'slash_test_2', true ) );
-		$this->assertSame( wp_unslash( $this->slash_5 ), get_user_meta( $user_id, 'slash_test_3', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), get_user_meta( $user_id, 'slash_test_1', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), get_user_meta( $user_id, 'slash_test_2', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), get_user_meta( $user_id, 'slash_test_3', true ) );
 
-		add_user_meta( $user_id, 'slash_test_4', $this->slash_2 );
-		add_user_meta( $user_id, 'slash_test_5', $this->slash_4 );
-		add_user_meta( $user_id, 'slash_test_6', $this->slash_6 );
+		add_user_meta( $user_id, 'slash_test_4', self::SLASH_2 );
+		add_user_meta( $user_id, 'slash_test_5', self::SLASH_4 );
+		add_user_meta( $user_id, 'slash_test_6', self::SLASH_6 );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), get_user_meta( $user_id, 'slash_test_4', true ) );
-		$this->assertSame( wp_unslash( $this->slash_4 ), get_user_meta( $user_id, 'slash_test_5', true ) );
-		$this->assertSame( wp_unslash( $this->slash_6 ), get_user_meta( $user_id, 'slash_test_6', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), get_user_meta( $user_id, 'slash_test_4', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), get_user_meta( $user_id, 'slash_test_5', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), get_user_meta( $user_id, 'slash_test_6', true ) );
 	}
 
 	/**
@@ -222,20 +228,20 @@ class Tests_Meta_Slashes extends WP_UnitTestCase {
 		add_user_meta( $user_id, 'slash_test_2', 'foo' );
 		add_user_meta( $user_id, 'slash_test_3', 'foo' );
 
-		update_user_meta( $user_id, 'slash_test_1', $this->slash_1 );
-		update_user_meta( $user_id, 'slash_test_2', $this->slash_3 );
-		update_user_meta( $user_id, 'slash_test_3', $this->slash_5 );
+		update_user_meta( $user_id, 'slash_test_1', self::SLASH_1 );
+		update_user_meta( $user_id, 'slash_test_2', self::SLASH_3 );
+		update_user_meta( $user_id, 'slash_test_3', self::SLASH_5 );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), get_user_meta( $user_id, 'slash_test_1', true ) );
-		$this->assertSame( wp_unslash( $this->slash_3 ), get_user_meta( $user_id, 'slash_test_2', true ) );
-		$this->assertSame( wp_unslash( $this->slash_5 ), get_user_meta( $user_id, 'slash_test_3', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), get_user_meta( $user_id, 'slash_test_1', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), get_user_meta( $user_id, 'slash_test_2', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), get_user_meta( $user_id, 'slash_test_3', true ) );
 
-		update_user_meta( $user_id, 'slash_test_1', $this->slash_2 );
-		update_user_meta( $user_id, 'slash_test_2', $this->slash_4 );
-		update_user_meta( $user_id, 'slash_test_3', $this->slash_6 );
+		update_user_meta( $user_id, 'slash_test_1', self::SLASH_2 );
+		update_user_meta( $user_id, 'slash_test_2', self::SLASH_4 );
+		update_user_meta( $user_id, 'slash_test_3', self::SLASH_6 );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), get_user_meta( $user_id, 'slash_test_1', true ) );
-		$this->assertSame( wp_unslash( $this->slash_4 ), get_user_meta( $user_id, 'slash_test_2', true ) );
-		$this->assertSame( wp_unslash( $this->slash_6 ), get_user_meta( $user_id, 'slash_test_3', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), get_user_meta( $user_id, 'slash_test_1', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), get_user_meta( $user_id, 'slash_test_2', true ) );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), get_user_meta( $user_id, 'slash_test_3', true ) );
 	}
 }
diff --git a/tests/multisite/network.php b/tests/multisite/network.php
index edfa4babb6..db5cfb25ca 100644
--- a/tests/multisite/network.php
+++ b/tests/multisite/network.php
@@ -205,54 +205,7 @@ if ( is_multisite() ) :
 			$this->assertEquals( count( self::$different_site_ids ), $site_count );
 		}
 
-		/**
-		 * @ticket 37866
-		 */
-		public function test_get_user_count_on_different_network() {
-			wp_update_network_user_counts();
-			$current_network_user_count = get_user_count();
-
-			// Add another user to fake the network user count to be different.
-			wpmu_create_user( 'user', 'pass', 'email' );
-
-			wp_update_network_user_counts( self::$different_network_id );
-
-			$user_count = get_user_count( self::$different_network_id );
 
-			$this->assertEquals( $current_network_user_count + 1, $user_count );
-		}
-
-		/**
-		 * @ticket 22917
-		 */
-		public function test_enable_live_network_user_counts_filter() {
-			// False for large networks by default.
-			add_filter( 'enable_live_network_counts', '__return_false' );
-
-			// Refresh the cache.
-			wp_update_network_counts();
-			$start_count = get_user_count();
-
-			wpmu_create_user( 'user', 'pass', 'email' );
-
-			// No change, cache not refreshed.
-			$count = get_user_count();
-
-			$this->assertSame( $start_count, $count );
-
-			wp_update_network_counts();
-			$start_count = get_user_count();
-
-			add_filter( 'enable_live_network_counts', '__return_true' );
-
-			wpmu_create_user( 'user2', 'pass2', 'email2' );
-
-			$count = get_user_count();
-			$this->assertEquals( $start_count + 1, $count );
-
-			remove_filter( 'enable_live_network_counts', '__return_false' );
-			remove_filter( 'enable_live_network_counts', '__return_true' );
-		}
 
 		public function test_active_network_plugins() {
 			$path = 'hello.php';
@@ -319,25 +272,6 @@ if ( is_multisite() ) :
 			$this->plugin_hook_count++;
 		}
 
-		public function test_get_user_count() {
-			// Refresh the cache.
-			wp_update_network_counts();
-			$start_count = get_user_count();
-
-			// Only false for large networks as of 3.7.
-			add_filter( 'enable_live_network_counts', '__return_false' );
-			self::factory()->user->create( array( 'role' => 'administrator' ) );
-
-			$count = get_user_count(); // No change, cache not refreshed.
-			$this->assertSame( $start_count, $count );
-
-			wp_update_network_counts(); // Magic happens here.
-
-			$count = get_user_count();
-			$this->assertEquals( $start_count + 1, $count );
-			remove_filter( 'enable_live_network_counts', '__return_false' );
-		}
-
 		public function test_wp_schedule_update_network_counts() {
 			$this->assertFalse( wp_next_scheduled( 'update_network_counts' ) );
 
@@ -407,7 +341,7 @@ if ( is_multisite() ) :
 
 			update_network_option( null, 'user_count', 40 );
 
-			$expected = $wpdb->get_var( "SELECT COUNT(ID) as c FROM $wpdb->users WHERE spam = '0' AND deleted = '0'" );
+			$expected = (int) $wpdb->get_var( "SELECT COUNT(ID) as c FROM $wpdb->users WHERE spam = '0' AND deleted = '0'" );
 
 			wp_update_network_user_counts();
 
@@ -423,7 +357,7 @@ if ( is_multisite() ) :
 
 			update_network_option( self::$different_network_id, 'user_count', 40 );
 
-			$expected = $wpdb->get_var( "SELECT COUNT(ID) as c FROM $wpdb->users WHERE spam = '0' AND deleted = '0'" );
+			$expected = (int) $wpdb->get_var( "SELECT COUNT(ID) as c FROM $wpdb->users WHERE spam = '0' AND deleted = '0'" );
 
 			wp_update_network_user_counts( self::$different_network_id );
 
@@ -627,7 +561,7 @@ if ( is_multisite() ) :
 			$new_network_id = $this->_get_next_network_id();
 			$this->assertNull( get_network( $new_network_id ) );
 
-			$new_network = $this->factory()->network->create_and_get();
+			$new_network = self::factory()->network->create_and_get();
 
 			// Double-check we got the ID of the new network correct.
 			$this->assertSame( $new_network_id, $new_network->id );
diff --git a/tests/multisite/site.php b/tests/multisite/site.php
index e2d4d78ddb..58057feef2 100644
--- a/tests/multisite/site.php
+++ b/tests/multisite/site.php
@@ -2459,7 +2459,7 @@ if ( is_multisite() ) :
 			$new_site_id = $this->_get_next_site_id();
 			$this->assertNull( get_site( $new_site_id ) );
 
-			$new_site = $this->factory()->blog->create_and_get();
+			$new_site = self::factory()->blog->create_and_get();
 
 			// Double-check we got the ID of the new site correct.
 			$this->assertEquals( $new_site_id, $new_site->blog_id );
diff --git a/tests/multisite/wpInstallDefaults.php b/tests/multisite/wpInstallDefaults.php
index c48a832a05..cb05566a37 100644
--- a/tests/multisite/wpInstallDefaults.php
+++ b/tests/multisite/wpInstallDefaults.php
@@ -13,7 +13,7 @@ if ( is_multisite() ) :
 		 * @ticket 40036
 		 */
 		public function test_option_should_not_be_empty_by_default() {
-			$blog_id = $this->factory->blog->create();
+			$blog_id = self::factory()->blog->create();
 
 			switch_to_blog( $blog_id );
 
@@ -39,7 +39,7 @@ if ( is_multisite() ) :
 			update_site_option( 'first_page', '' );
 			update_site_option( 'first_comment', '' );
 
-			$blog_id = $this->factory->blog->create();
+			$blog_id = self::factory()->blog->create();
 
 			switch_to_blog( $blog_id );
 
@@ -65,7 +65,7 @@ if ( is_multisite() ) :
 			update_site_option( 'first_page', 'Some page content' );
 			update_site_option( 'first_comment', 'Some comment content' );
 
-			$blog_id = $this->factory->blog->create();
+			$blog_id = self::factory()->blog->create();
 
 			switch_to_blog( $blog_id );
 
diff --git a/tests/multisite/wpMsSitesListTable.php b/tests/multisite/wpMsSitesListTable.php
index 8bccd34f07..559f7412f4 100644
--- a/tests/multisite/wpMsSitesListTable.php
+++ b/tests/multisite/wpMsSitesListTable.php
@@ -230,5 +230,17 @@ if ( is_multisite() ) :
 
 			$this->assertSameSets( $expected, $items );
 		}
+
+		/**
+		 * @ticket 42066
+		 */
+		public function test_get_views_should_return_views_by_default() {
+			$expected = array(
+				'all'    => '<a href="sites.php" class="current" aria-current="page">All <span class="count">(14)</span></a>',
+				'public' => '<a href="sites.php?status=public">Public <span class="count">(14)</span></a>',
+			);
+
+			$this->assertSame( $expected, $this->table->get_views() );
+		}
 	}
 endif;
diff --git a/tests/multisite/wpMsThemesListTable.php b/tests/multisite/wpMsThemesListTable.php
new file mode 100644
index 0000000000..b02df1a740
--- /dev/null
+++ b/tests/multisite/wpMsThemesListTable.php
@@ -0,0 +1,125 @@
+<?php
+
+/**
+ * @group ms-required
+ * @group admin
+ * @group network-admin
+ *
+ * @covers WP_MS_Themes_List_Table
+ */
+class Tests_Multisite_wpMsThemesListTable extends WP_UnitTestCase {
+	protected static $site_ids;
+
+	/**
+	 * @var WP_MS_Themes_List_Table
+	 */
+	public $table = false;
+
+	public function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_MS_Themes_List_Table', array( 'screen' => 'ms-themes' ) );
+	}
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$site_ids = array(
+			'wordpress.org/'          => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/',
+			),
+			'wordpress.org/foo/'      => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/foo/',
+			),
+			'wordpress.org/foo/bar/'  => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/foo/bar/',
+			),
+			'wordpress.org/afoo/'     => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/afoo/',
+			),
+			'make.wordpress.org/'     => array(
+				'domain' => 'make.wordpress.org',
+				'path'   => '/',
+			),
+			'make.wordpress.org/foo/' => array(
+				'domain' => 'make.wordpress.org',
+				'path'   => '/foo/',
+			),
+			'www.w.org/'              => array(
+				'domain' => 'www.w.org',
+				'path'   => '/',
+			),
+			'www.w.org/foo/'          => array(
+				'domain' => 'www.w.org',
+				'path'   => '/foo/',
+			),
+			'www.w.org/foo/bar/'      => array(
+				'domain' => 'www.w.org',
+				'path'   => '/foo/bar/',
+			),
+			'test.example.org/'       => array(
+				'domain' => 'test.example.org',
+				'path'   => '/',
+			),
+			'test2.example.org/'      => array(
+				'domain' => 'test2.example.org',
+				'path'   => '/',
+			),
+			'test3.example.org/zig/'  => array(
+				'domain' => 'test3.example.org',
+				'path'   => '/zig/',
+			),
+			'atest.example.org/'      => array(
+				'domain' => 'atest.example.org',
+				'path'   => '/',
+			),
+		);
+
+		foreach ( self::$site_ids as &$id ) {
+			$id = $factory->blog->create( $id );
+		}
+		unset( $id );
+	}
+
+	public static function wpTearDownAfterClass() {
+		foreach ( self::$site_ids as $site_id ) {
+			wp_delete_site( $site_id );
+		}
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_MS_Themes_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		global $totals;
+
+		$totals_backup = $totals;
+		$totals        = array(
+			'all'                  => 21,
+			'enabled'              => 1,
+			'disabled'             => 2,
+			'upgrade'              => 3,
+			'broken'               => 4,
+			'auto-update-enabled'  => 5,
+			'auto-update-disabled' => 6,
+		);
+
+		$expected = array(
+			'all'                  => '<a href="themes.php?theme_status=all" class="current" aria-current="page">All <span class="count">(21)</span></a>',
+			'enabled'              => '<a href="themes.php?theme_status=enabled">Enabled <span class="count">(1)</span></a>',
+			'disabled'             => '<a href="themes.php?theme_status=disabled">Disabled <span class="count">(2)</span></a>',
+			'upgrade'              => '<a href="themes.php?theme_status=upgrade">Update Available <span class="count">(3)</span></a>',
+			'broken'               => '<a href="themes.php?theme_status=broken">Broken <span class="count">(4)</span></a>',
+			'auto-update-enabled'  => '<a href="themes.php?theme_status=auto-update-enabled">Auto-updates Enabled <span class="count">(5)</span></a>',
+			'auto-update-disabled' => '<a href="themes.php?theme_status=auto-update-disabled">Auto-updates Disabled <span class="count">(6)</span></a>',
+		);
+
+		$actual = $this->table->get_views();
+		$totals = $totals_backup;
+
+		$this->assertSame( $expected, $actual );
+	}
+}
diff --git a/tests/multisite/wpMsUsersListTable.php b/tests/multisite/wpMsUsersListTable.php
new file mode 100644
index 0000000000..be17e7ae36
--- /dev/null
+++ b/tests/multisite/wpMsUsersListTable.php
@@ -0,0 +1,107 @@
+<?php
+
+/**
+ * @group admin
+ * @group network-admin
+ * @group ms-required
+ *
+ * @covers WP_MS_Users_List_Table
+ */
+class Tests_Multisite_wpMsUsersListTable extends WP_UnitTestCase {
+	protected static $site_ids;
+
+	/**
+	 * @var WP_MS_Users_List_Table
+	 */
+	public $table = false;
+
+	public function set_up() {
+		parent::set_up();
+		$this->table = _get_list_table( 'WP_MS_Users_List_Table', array( 'screen' => 'ms-users' ) );
+	}
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$site_ids = array(
+			'wordpress.org/'          => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/',
+			),
+			'wordpress.org/foo/'      => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/foo/',
+			),
+			'wordpress.org/foo/bar/'  => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/foo/bar/',
+			),
+			'wordpress.org/afoo/'     => array(
+				'domain' => 'wordpress.org',
+				'path'   => '/afoo/',
+			),
+			'make.wordpress.org/'     => array(
+				'domain' => 'make.wordpress.org',
+				'path'   => '/',
+			),
+			'make.wordpress.org/foo/' => array(
+				'domain' => 'make.wordpress.org',
+				'path'   => '/foo/',
+			),
+			'www.w.org/'              => array(
+				'domain' => 'www.w.org',
+				'path'   => '/',
+			),
+			'www.w.org/foo/'          => array(
+				'domain' => 'www.w.org',
+				'path'   => '/foo/',
+			),
+			'www.w.org/foo/bar/'      => array(
+				'domain' => 'www.w.org',
+				'path'   => '/foo/bar/',
+			),
+			'test.example.org/'       => array(
+				'domain' => 'test.example.org',
+				'path'   => '/',
+			),
+			'test2.example.org/'      => array(
+				'domain' => 'test2.example.org',
+				'path'   => '/',
+			),
+			'test3.example.org/zig/'  => array(
+				'domain' => 'test3.example.org',
+				'path'   => '/zig/',
+			),
+			'atest.example.org/'      => array(
+				'domain' => 'atest.example.org',
+				'path'   => '/',
+			),
+		);
+
+		foreach ( self::$site_ids as &$id ) {
+			$id = $factory->blog->create( $id );
+		}
+		unset( $id );
+	}
+
+	public static function wpTearDownAfterClass() {
+		foreach ( self::$site_ids as $site_id ) {
+			wp_delete_site( $site_id );
+		}
+	}
+
+	/**
+	 * @ticket 42066
+	 *
+	 * @covers WP_MS_Users_List_Table::get_views
+	 */
+	public function test_get_views_should_return_views_by_default() {
+		$all   = get_user_count();
+		$super = count( get_super_admins() );
+
+		$expected = array(
+			'all'   => '<a href="http://example.org/wp-admin/network/users.php" class="current" aria-current="page">All <span class="count">(' . $all . ')</span></a>',
+			'super' => '<a href="http://example.org/wp-admin/network/users.php?role=super">Super Admin <span class="count">(' . $super . ')</span></a>',
+		);
+
+		$this->assertSame( $expected, $this->table->get_views() );
+	}
+}
diff --git a/tests/multisite/wpNetworkQuery.php b/tests/multisite/wpNetworkQuery.php
index 42fcc21f96..29b2b8f5f7 100644
--- a/tests/multisite/wpNetworkQuery.php
+++ b/tests/multisite/wpNetworkQuery.php
@@ -509,6 +509,60 @@ if ( is_multisite() ) :
 			$this->assertSame( $number_of_queries + 1, $wpdb->num_queries );
 		}
 
+		/**
+		 * @ticket 55461
+		 */
+		public function test_wp_network_query_cache_with_same_fields_same_cache_field() {
+			$q                 = new WP_Network_Query();
+			$query_1           = $q->query(
+				array(
+					'fields'               => 'all',
+					'number'               => 3,
+					'order'                => 'ASC',
+					'update_network_cache' => true,
+				)
+			);
+			$number_of_queries = get_num_queries();
+
+			$query_2 = $q->query(
+				array(
+					'fields'               => 'all',
+					'number'               => 3,
+					'order'                => 'ASC',
+					'update_network_cache' => true,
+				)
+			);
+
+			$this->assertSame( $number_of_queries, get_num_queries() );
+		}
+
+		/**
+		 * @ticket 55461
+		 */
+		public function test_wp_network_query_cache_with_same_fields_different_cache_field() {
+			$q                 = new WP_Network_Query();
+			$query_1           = $q->query(
+				array(
+					'fields'               => 'all',
+					'number'               => 3,
+					'order'                => 'ASC',
+					'update_network_cache' => true,
+				)
+			);
+			$number_of_queries = get_num_queries();
+
+			$query_2 = $q->query(
+				array(
+					'fields'               => 'all',
+					'number'               => 3,
+					'order'                => 'ASC',
+					'update_network_cache' => false,
+				)
+			);
+
+			$this->assertSame( $number_of_queries, get_num_queries() );
+		}
+
 		/**
 		 * @ticket 45749
 		 * @ticket 47599
diff --git a/tests/multisite/wpSiteQuery.php b/tests/multisite/wpSiteQuery.php
index f48667f23f..8d1d84c1f0 100644
--- a/tests/multisite/wpSiteQuery.php
+++ b/tests/multisite/wpSiteQuery.php
@@ -849,7 +849,7 @@ if ( is_multisite() ) :
 				)
 			);
 
-			$number_of_queries = $wpdb->num_queries;
+			$number_of_queries = get_num_queries();
 
 			$query_2 = $q->query(
 				array(
@@ -863,6 +863,70 @@ if ( is_multisite() ) :
 			$this->assertSame( $number_of_queries + 1, $wpdb->num_queries );
 		}
 
+		/**
+		 * @ticket 55462
+		 */
+		public function test_wp_site_query_cache_with_same_fields_same_cache_fields() {
+			$q = new WP_Site_Query();
+
+			$query_1 = $q->query(
+				array(
+					'fields'                 => 'ids',
+					'network_id'             => self::$network_ids['wordpress.org/'],
+					'number'                 => 3,
+					'order'                  => 'ASC',
+					'update_site_cache'      => true,
+					'update_site_meta_cache' => true,
+				)
+			);
+
+			$number_of_queries = get_num_queries();
+
+			$query_2 = $q->query(
+				array(
+					'fields'                 => 'ids',
+					'network_id'             => self::$network_ids['wordpress.org/'],
+					'number'                 => 3,
+					'order'                  => 'ASC',
+					'update_site_cache'      => true,
+					'update_site_meta_cache' => true,
+				)
+			);
+			$this->assertSame( $number_of_queries, get_num_queries() );
+		}
+
+		/**
+		 * @ticket 55462
+		 */
+		public function test_wp_site_query_cache_with_same_fields_different_cache_fields() {
+			$q = new WP_Site_Query();
+
+			$query_1 = $q->query(
+				array(
+					'fields'                 => 'ids',
+					'network_id'             => self::$network_ids['wordpress.org/'],
+					'number'                 => 3,
+					'order'                  => 'ASC',
+					'update_site_cache'      => true,
+					'update_site_meta_cache' => true,
+				)
+			);
+
+			$number_of_queries = get_num_queries();
+
+			$query_2 = $q->query(
+				array(
+					'fields'                 => 'ids',
+					'network_id'             => self::$network_ids['wordpress.org/'],
+					'number'                 => 3,
+					'order'                  => 'ASC',
+					'update_site_cache'      => false,
+					'update_site_meta_cache' => false,
+				)
+			);
+			$this->assertSame( $number_of_queries, get_num_queries() );
+		}
+
 		/**
 		 * @ticket 40229
 		 * @dataProvider data_wp_site_query_meta_query
diff --git a/tests/oembed/WpEmbed.php b/tests/oembed/WpEmbed.php
index 239ea24d56..eb64f084e7 100644
--- a/tests/oembed/WpEmbed.php
+++ b/tests/oembed/WpEmbed.php
@@ -28,7 +28,7 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 	}
 
 	public function test_maybe_run_ajax_cache_should_return_nothing_if_there_is_no_message() {
-		$GLOBALS['post'] = $this->factory()->post->create_and_get(
+		$GLOBALS['post'] = self::factory()->post->create_and_get(
 			array(
 				'post_title' => 'Hello World',
 			)
@@ -41,7 +41,7 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 	}
 
 	public function test_maybe_run_ajax_cache_should_return_javascript() {
-		$GLOBALS['post'] = $this->factory()->post->create_and_get(
+		$GLOBALS['post'] = self::factory()->post->create_and_get(
 			array(
 				'post_title' => 'Hello World',
 			)
@@ -134,7 +134,7 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 	}
 
 	public function test_delete_oembed_caches() {
-		$post_id = $this->factory()->post->create();
+		$post_id = self::factory()->post->create();
 
 		add_post_meta( $post_id, '_oembed_foo', 'bar' );
 		add_post_meta( $post_id, '_oembed_foo', 'baz' );
@@ -147,14 +147,14 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 	}
 
 	public function test_cache_oembed_invalid_post_type() {
-		$post_id = $this->factory()->post->create( array( 'post_type' => 'nav_menu_item' ) );
+		$post_id = self::factory()->post->create( array( 'post_type' => 'nav_menu_item' ) );
 
 		$this->wp_embed->cache_oembed( $post_id );
 		$this->assertNotSame( $post_id, $this->wp_embed->post_ID );
 	}
 
 	public function test_cache_oembed_empty_content() {
-		$post_id = $this->factory()->post->create( array( 'post_content' => '' ) );
+		$post_id = self::factory()->post->create( array( 'post_content' => '' ) );
 
 		$this->wp_embed->cache_oembed( $post_id );
 		$this->assertNotSame( $post_id, $this->wp_embed->post_ID );
@@ -167,7 +167,7 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 		$cachekey      = '_oembed_' . $key_suffix;
 		$cachekey_time = '_oembed_time_' . $key_suffix;
 
-		$post_id = $this->factory()->post->create( array( 'post_content' => 'https://example.com/' ) );
+		$post_id = self::factory()->post->create( array( 'post_content' => 'https://example.com/' ) );
 
 		add_filter( 'pre_oembed_result', array( $this, '_pre_oembed_result_callback' ) );
 		$this->wp_embed->cache_oembed( $post_id );
@@ -181,7 +181,7 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 	public function test_shortcode_should_get_cached_data_from_post_meta_for_known_post() {
 		global $post;
 
-		$post       = $this->factory()->post->create_and_get();
+		$post       = self::factory()->post->create_and_get();
 		$url        = 'https://example.com/';
 		$expected   = '<b>Embedded content</b>';
 		$key_suffix = md5( $url . serialize( wp_embed_defaults( $url ) ) );
@@ -208,7 +208,7 @@ class Tests_WP_Embed extends WP_UnitTestCase {
 	public function test_shortcode_should_get_cached_failure_from_post_meta_for_known_post() {
 		global $post;
 
-		$post          = $this->factory()->post->create_and_get();
+		$post          = self::factory()->post->create_and_get();
 		$url           = 'https://example.com/';
 		$expected      = '<a href="' . esc_url( $url ) . '">' . esc_html( $url ) . '</a>';
 		$key_suffix    = md5( $url . serialize( wp_embed_defaults( $url ) ) );
diff --git a/tests/oembed/controller.php b/tests/oembed/controller.php
index 9ff05193e2..a5b8d6a483 100644
--- a/tests/oembed/controller.php
+++ b/tests/oembed/controller.php
@@ -290,7 +290,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 	}
 
 	public function test_request_invalid_format() {
-		$post_id = $this->factory()->post->create();
+		$post_id = self::factory()->post->create();
 
 		$request = new WP_REST_Request( 'GET', '/oembed/1.0/embed' );
 		$request->set_param( 'url', get_permalink( $post_id ) );
@@ -461,12 +461,12 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 	}
 
 	public function test_rest_pre_serve_request() {
-		$user = $this->factory()->user->create_and_get(
+		$user = self::factory()->user->create_and_get(
 			array(
 				'display_name' => 'John Doe',
 			)
 		);
-		$post = $this->factory()->post->create_and_get(
+		$post = self::factory()->post->create_and_get(
 			array(
 				'post_author' => $user->ID,
 				'post_title'  => 'Hello World',
@@ -485,7 +485,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 	}
 
 	public function test_rest_pre_serve_request_wrong_format() {
-		$post = $this->factory()->post->create_and_get();
+		$post = self::factory()->post->create_and_get();
 
 		$request = new WP_REST_Request( 'GET', '/oembed/1.0/embed' );
 		$request->set_param( 'url', get_permalink( $post->ID ) );
@@ -497,7 +497,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 	}
 
 	public function test_rest_pre_serve_request_wrong_method() {
-		$post = $this->factory()->post->create_and_get();
+		$post = self::factory()->post->create_and_get();
 
 		$request = new WP_REST_Request( 'HEAD', '/oembed/1.0/embed' );
 		$request->set_param( 'url', get_permalink( $post->ID ) );
@@ -513,7 +513,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 		$this->assertSame( home_url() . '/index.php?rest_route=/oembed/1.0/embed', get_oembed_endpoint_url( '', 'json' ) );
 		$this->assertSame( home_url() . '/index.php?rest_route=/oembed/1.0/embed', get_oembed_endpoint_url( '', 'xml' ) );
 
-		$post_id     = $this->factory()->post->create();
+		$post_id     = self::factory()->post->create();
 		$url         = get_permalink( $post_id );
 		$url_encoded = urlencode( $url );
 
@@ -527,7 +527,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 		$this->assertSame( home_url() . '/wp-json/oembed/1.0/embed', get_oembed_endpoint_url() );
 		$this->assertSame( home_url() . '/wp-json/oembed/1.0/embed', get_oembed_endpoint_url( '', 'xml' ) );
 
-		$post_id     = $this->factory()->post->create();
+		$post_id     = self::factory()->post->create();
 		$url         = get_permalink( $post_id );
 		$url_encoded = urlencode( $url );
 
diff --git a/tests/oembed/headers.php b/tests/oembed/headers.php
index 8a36a5bc1c..8f9c4e4c8d 100644
--- a/tests/oembed/headers.php
+++ b/tests/oembed/headers.php
@@ -13,7 +13,7 @@ class Tests_oEmbed_HTTP_Headers extends WP_UnitTestCase {
 	 * @requires function xdebug_get_headers
 	 */
 	public function test_rest_pre_serve_request_headers() {
-		$post = $this->factory()->post->create_and_get(
+		$post = self::factory()->post->create_and_get(
 			array(
 				'post_title' => 'Hello World',
 			)
diff --git a/tests/oembed/template.php b/tests/oembed/template.php
index f24b421a87..20643c92a2 100644
--- a/tests/oembed/template.php
+++ b/tests/oembed/template.php
@@ -47,7 +47,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringNotContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringNotContainsString( 'That embed cannot be found.', $actual );
 		$this->assertStringContainsString( 'Hello World', $actual );
 	}
 
@@ -79,7 +79,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringNotContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringNotContainsString( 'That embed cannot be found.', $actual );
 		$this->assertStringContainsString( 'Hello World', $actual );
 		$this->assertStringContainsString( 'canola.jpg', $actual );
 	}
@@ -96,7 +96,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringContainsString( 'That embed cannot be found.', $actual );
 	}
 
 	public function test_oembed_output_attachment() {
@@ -123,7 +123,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringNotContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringNotContainsString( 'That embed cannot be found.', $actual );
 		$this->assertStringContainsString( 'Hello World', $actual );
 		$this->assertStringContainsString( 'canola.jpg', $actual );
 	}
@@ -148,7 +148,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringContainsString( 'That embed cannot be found.', $actual );
 	}
 
 	public function test_oembed_output_scheduled_post() {
@@ -172,7 +172,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringContainsString( 'That embed cannot be found.', $actual );
 	}
 
 	public function test_oembed_output_private_post() {
@@ -195,7 +195,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringContainsString( 'That embed cannot be found.', $actual );
 	}
 
 	public function test_oembed_output_private_post_with_permissions() {
@@ -222,7 +222,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 
 		$doc = new DOMDocument();
 		$this->assertTrue( $doc->loadHTML( $actual ) );
-		$this->assertStringNotContainsString( 'That embed can&#8217;t be found.', $actual );
+		$this->assertStringNotContainsString( 'That embed cannot be found.', $actual );
 		$this->assertStringContainsString( 'Hello World', $actual );
 	}
 
@@ -309,13 +309,14 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 	public function test_add_host_js() {
 		remove_all_filters( 'embed_oembed_html' );
 
+		// This function is now a no-op.
 		wp_oembed_add_host_js();
 
-		$this->assertEquals( 10, has_filter( 'embed_oembed_html', 'wp_maybe_enqueue_oembed_host_js' ) );
+		$this->assertFalse( has_filter( 'embed_oembed_html', 'wp_maybe_enqueue_oembed_host_js' ) );
 	}
 
 	/** @covers ::wp_maybe_enqueue_oembed_host_js() */
-	function test_wp_maybe_enqueue_oembed_host_js() {
+	public function test_wp_maybe_enqueue_oembed_host_js() {
 		$scripts = wp_scripts();
 
 		$this->assertFalse( $scripts->query( 'wp-embed', 'enqueued' ) );
@@ -330,6 +331,19 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 		$this->assertTrue( $scripts->query( 'wp-embed', 'enqueued' ) );
 	}
 
+	/** @covers ::wp_maybe_enqueue_oembed_host_js() */
+	public function test_wp_maybe_enqueue_oembed_host_js_without_wp_head_action() {
+		$scripts = wp_scripts();
+
+		remove_action( 'wp_head', 'wp_oembed_add_host_js' );
+		$this->assertFalse( $scripts->query( 'wp-embed', 'enqueued' ) );
+
+		$post_embed = '<blockquote class="wp-embedded-content" data-secret="S24AQCJW9i"><a href="https://make.wordpress.org/core/2016/03/11/embeds-changes-in-wordpress-4-5/">Embeds Changes in WordPress 4.5</a></blockquote><iframe class="wp-embedded-content" sandbox="allow-scripts" security="restricted" style="position: absolute; clip: rect(1px, 1px, 1px, 1px);" title="&#8220;Embeds Changes in WordPress 4.5&#8221; &#8212; Make WordPress Core" src="https://make.wordpress.org/core/2016/03/11/embeds-changes-in-wordpress-4-5/embed/#?secret=S24AQCJW9i" data-secret="S24AQCJW9i" width="600" height="338" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe>';
+
+		wp_maybe_enqueue_oembed_host_js( $post_embed );
+		$this->assertFalse( $scripts->query( 'wp-embed', 'enqueued' ) );
+	}
+
 	/**
 	 * Confirms that no ampersands exist in src/wp-includes/js/wp-embed.js.
 	 *
diff --git a/tests/option/multisite.php b/tests/option/multisite.php
index 4f6d194b84..05ee5f9555 100644
--- a/tests/option/multisite.php
+++ b/tests/option/multisite.php
@@ -9,8 +9,15 @@ if ( is_multisite() ) :
 	 * @group ms-option
 	 * @group multisite
 	 */
-	class Tests_Multisite_Option extends WP_UnitTestCase {
+	class Tests_Option_Multisite extends WP_UnitTestCase {
 
+		/**
+		 * @covers ::get_blog_option
+		 * @covers ::get_option
+		 * @covers ::add_blog_option
+		 * @covers ::update_blog_option
+		 * @covers ::delete_blog_option
+		 */
 		public function test_from_same_site() {
 			$key    = __FUNCTION__ . '_1';
 			$key2   = __FUNCTION__ . '_2';
@@ -48,6 +55,13 @@ if ( is_multisite() ) :
 			$this->assertFalse( get_option( $key2 ) );                    // Check get_option().
 		}
 
+		/**
+		 * @covers ::get_blog_option
+		 * @covers ::get_option
+		 * @covers ::add_blog_option
+		 * @covers ::update_blog_option
+		 * @covers ::delete_blog_option
+		 */
 		public function test_from_same_site_with_null_blog_id() {
 			$key    = __FUNCTION__ . '_1';
 			$key2   = __FUNCTION__ . '_2';
@@ -84,6 +98,13 @@ if ( is_multisite() ) :
 			$this->assertFalse( get_option( $key2 ) );                       // Check get_option().
 		}
 
+		/**
+		 * @covers ::get_blog_option
+		 * @covers ::get_option
+		 * @covers ::add_blog_option
+		 * @covers ::update_blog_option
+		 * @covers ::delete_blog_option
+		 */
 		public function test_with_another_site() {
 			$user_id = self::factory()->user->create();
 			$this->assertIsInt( $user_id );
@@ -132,28 +153,12 @@ if ( is_multisite() ) :
 		}
 
 		/**
-		 * @group multisite
+		 * @covers ::users_can_register_signup_filter
+		 * @covers ::get_site_option
 		 */
-		public function test_site_notoptions() {
-			$network_id     = get_current_network_id();
-			$notoptions_key = "{$network_id}:notoptions";
-
-			$_notoptions = wp_cache_get( 'notoptions', 'site-options' );
-			$this->assertEmpty( $_notoptions );
-			$_notoptions1 = wp_cache_get( $notoptions_key, 'site-options' );
-			$this->assertEmpty( $_notoptions1 );
-
-			get_site_option( 'burrito' );
-
-			$notoptions = wp_cache_get( 'notoptions', 'site-options' );
-			$this->assertEmpty( $notoptions );
-			$notoptions1 = wp_cache_get( $notoptions_key, 'site-options' );
-			$this->assertNotEmpty( $notoptions1 );
-		}
-
 		public function test_users_can_register_signup_filter() {
 
-			$registration = get_site_option( 'registration' );
+			get_site_option( 'registration' );
 			$this->assertFalse( users_can_register_signup_filter() );
 
 			update_site_option( 'registration', 'all' );
@@ -168,6 +173,9 @@ if ( is_multisite() ) :
 
 		/**
 		 * @dataProvider data_illegal_names
+		 *
+		 * @covers ::update_site_option
+		 * @covers ::get_site_option
 		 */
 		public function test_sanitize_network_option_illegal_names( $option_value, $sanitized_option_value ) {
 			update_site_option( 'illegal_names', $option_value );
@@ -187,6 +195,9 @@ if ( is_multisite() ) :
 		 *
 		 * @param $option_value
 		 * @param $sanitized_option_value
+		 *
+		 * @covers ::update_site_option
+		 * @covers ::get_site_option
 		 */
 		public function test_sanitize_network_option_limited_email_domains( $option_value, $sanitized_option_value ) {
 			update_site_option( 'limited_email_domains', $option_value );
@@ -198,6 +209,9 @@ if ( is_multisite() ) :
 		 *
 		 * @param $option_value
 		 * @param $sanitized_option_value
+		 *
+		 * @covers ::update_site_option
+		 * @covers ::get_site_option
 		 */
 		public function test_sanitize_network_option_banned_email_domains( $option_value, $sanitized_option_value ) {
 			update_site_option( 'banned_email_domains', $option_value );
diff --git a/tests/option/networkOption.php b/tests/option/networkOption.php
index 39351c861d..2231ecf0fa 100644
--- a/tests/option/networkOption.php
+++ b/tests/option/networkOption.php
@@ -14,6 +14,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 
 	/**
 	 * @group ms-required
+	 *
+	 * @covers ::add_site_option
 	 */
 	public function test_add_network_option_not_available_on_other_network() {
 		$id     = self::factory()->network->create();
@@ -26,6 +28,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 
 	/**
 	 * @group ms-required
+	 *
+	 * @covers ::add_network_option
 	 */
 	public function test_add_network_option_available_on_same_network() {
 		$id     = self::factory()->network->create();
@@ -38,6 +42,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 
 	/**
 	 * @group ms-required
+	 *
+	 * @covers ::delete_site_option
 	 */
 	public function test_delete_network_option_on_only_one_network() {
 		$id     = self::factory()->network->create();
@@ -53,6 +59,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 	/**
 	 * @ticket 22846
 	 * @group ms-excluded
+	 *
+	 * @covers ::add_network_option
 	 */
 	public function test_add_network_option_is_not_stored_as_autoload_option() {
 		$key = __FUNCTION__;
@@ -67,6 +75,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 	/**
 	 * @ticket 22846
 	 * @group ms-excluded
+	 *
+	 * @covers ::update_network_option
 	 */
 	public function test_update_network_option_is_not_stored_as_autoload_option() {
 		$key = __FUNCTION__;
@@ -83,6 +93,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 	 *
 	 * @param $network_id
 	 * @param $expected_response
+	 *
+	 * @covers ::add_network_option
 	 */
 	public function test_add_network_option_network_id_parameter( $network_id, $expected_response ) {
 		$option = rand_str();
@@ -96,6 +108,8 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 	 *
 	 * @param $network_id
 	 * @param $expected_response
+	 *
+	 * @covers ::get_network_option
 	 */
 	public function test_get_network_option_network_id_parameter( $network_id, $expected_response ) {
 		$option = rand_str();
@@ -123,59 +137,138 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @ticket 43506
+	 * @ticket 37181
+	 *
 	 * @group ms-required
+	 *
+	 * @covers ::get_network_option
+	 * @covers ::wp_cache_get
+	 * @covers ::wp_cache_delete
 	 */
-	public function test_get_network_option_sets_notoptions_if_option_found() {
-		$network_id     = get_current_network_id();
-		$notoptions_key = "$network_id:notoptions";
+	public function test_meta_api_use_values_in_network_option() {
+		$network_id = self::factory()->network->create();
+		$option     = __FUNCTION__;
+		$value      = __FUNCTION__;
 
-		$original_cache = wp_cache_get( $notoptions_key, 'site-options' );
-		if ( false !== $original_cache ) {
-			wp_cache_delete( $notoptions_key, 'site-options' );
-		}
-
-		// Retrieve any existing option.
-		get_network_option( $network_id, 'site_name' );
+		add_metadata( 'site', $network_id, $option, $value, true );
+		$this->assertEqualSets( get_metadata( 'site', $network_id, $option ), array( get_network_option( $network_id, $option, true ) ) );
+	}
 
-		$cache = wp_cache_get( $notoptions_key, 'site-options' );
-		if ( false !== $original_cache ) {
-			wp_cache_set( $notoptions_key, $original_cache, 'site-options' );
-		}
+	/**
+	 * @ticket 37181
+	 *
+	 * @group ms-required
+	 */
+	function test_funky_network_meta() {
+		$network_id      = self::factory()->network->create();
+		$option          = __FUNCTION__;
+		$classy          = new StdClass();
+		$classy->ID      = 1;
+		$classy->stringy = 'I love slashes\\\\';
+		$funky_meta[]    = $classy;
+
+		$classy          = new StdClass();
+		$classy->ID      = 2;
+		$classy->stringy = 'I love slashes\\\\ more';
+		$funky_meta[]    = $classy;
+
+		// Add a network meta item.
+		$this->assertIsInt( add_metadata( 'site', $network_id, $option, $funky_meta, true ) );
+
+		// Check they exists.
+		$this->assertEquals( $funky_meta, get_network_option( $network_id, $option ) );
+	}
 
-		$this->assertSame( array(), $cache );
+	/**
+	 * @ticket 37181
+	 *
+	 * @group ms-required
+	 */
+	public function test_meta_api_multiple_values_in_network_option() {
+		$network_id = self::factory()->network->create();
+		$option     = __FUNCTION__;
+		add_metadata( 'site', $network_id, $option, 'monday', true );
+		add_metadata( 'site', $network_id, $option, 'tuesday', true );
+		add_metadata( 'site', $network_id, $option, 'wednesday', true );
+		$this->assertEquals( 'monday', get_network_option( $network_id, $option, true ) );
 	}
 
 	/**
-	 * @ticket 43506
+	 * @ticket 37181
+	 *
 	 * @group ms-required
+	 *
+	 * @covers ::get_network_option
+	 * @covers ::wp_cache_get
 	 */
-	public function test_get_network_option_sets_notoptions_if_option_not_found() {
-		$network_id     = get_current_network_id();
-		$notoptions_key = "$network_id:notoptions";
+	public function test_network_option_count_queries_on_non_existing() {
+		$network_id = self::factory()->network->create();
+		$option     = __FUNCTION__;
+		add_network_option( $network_id, $option, 'monday' );
+		get_network_option( $network_id, $option );
+		$num_queries_pre_get = get_num_queries();
+		get_network_option( $network_id, 'do_not_exist' );
+		$num_queries_after_get = get_num_queries();
+
+		$this->assertSame( $num_queries_pre_get, $num_queries_after_get );
+	}
 
-		$original_cache = wp_cache_get( $notoptions_key, 'site-options' );
-		if ( false !== $original_cache ) {
-			wp_cache_delete( $notoptions_key, 'site-options' );
-		}
+	/**
+	 * @ticket 37181
+	 *
+	 * @group ms-required
+	 */
+	public function test_register_meta_network_option_single_false() {
+		$network_id = self::factory()->network->create();
+		$option     = __FUNCTION__;
+		$value      = __FUNCTION__;
+		register_meta(
+			'site',
+			$option,
+			array(
+				'type'    => 'string',
+				'default' => $value,
+				'single'  => false,
+			)
+		);
 
-		// Retrieve any non-existing option.
-		get_network_option( $network_id, 'this_does_not_exist' );
+		$this->assertSame( $value, get_network_option( $network_id, $option ) );
+	}
 
-		$cache = wp_cache_get( $notoptions_key, 'site-options' );
-		if ( false !== $original_cache ) {
-			wp_cache_set( $notoptions_key, $original_cache, 'site-options' );
-		}
+	/**
+	 * @ticket 37181
+	 *
+	 * @group ms-required
+	 */
+	public function test_register_meta_network_option_single_true() {
+		$network_id = self::factory()->network->create();
+		$option     = __FUNCTION__;
+		$value      = __FUNCTION__;
+		register_meta(
+			'site',
+			$option,
+			array(
+				'type'    => 'string',
+				'default' => $value,
+				'single'  => true,
+			)
+		);
 
-		$this->assertSame( array( 'this_does_not_exist' => true ), $cache );
+		$this->assertSame( $value, get_network_option( $network_id, $option ) );
 	}
 
 	/**
 	 * Ensure updating network options containing an object do not result in unneeded database calls.
 	 *
 	 * @ticket 44956
+	 *
+	 * @group ms-required
+	 *
+	 * @covers ::update_network_option
 	 */
 	public function test_update_network_option_array_with_object() {
+		$network_id     = self::factory()->network->create();
+		$option         = __FUNCTION__;
 		$array_w_object = array(
 			'url'       => 'http://src.wordpress-develop.dev/wp-content/uploads/2016/10/cropped-Blurry-Lights.jpg',
 			'meta_data' => (object) array(
@@ -185,24 +278,140 @@ class Tests_Option_NetworkOption extends WP_UnitTestCase {
 			),
 		);
 
-		$array_w_object_2 = array(
-			'url'       => 'http://src.wordpress-develop.dev/wp-content/uploads/2016/10/cropped-Blurry-Lights.jpg',
-			'meta_data' => (object) array(
-				'attachment_id' => 292,
-				'height'        => 708,
-				'width'         => 1260,
-			),
-		);
+		add_metadata( 'site', $network_id, $option, $array_w_object, true );
+		$this->assertEquals( $array_w_object, get_network_option( $network_id, $option ) );
+	}
 
-		// Add the option, it did not exist before this.
-		add_network_option( null, 'array_w_object', $array_w_object );
+	/**
+	 * @ticket 37181
+	 *
+	 * @group ms-required
+	 *
+	 * @covers ::add_network_option
+	 *
+	 * @dataProvider data_types_options
+	 */
+	public function test_type_add_network_option( $name, $value, $expected ) {
+		$result = add_network_option( null, $name, $value );
+		$this->assertTrue( $result, 'Network option was not added' );
+
+		$test_value = get_network_option( null, $name );
+		$this->assertSame( $expected, $test_value, 'Values do not match' );
+	}
+
+	/**
+	 * @ticket 37181
+	 *
+	 * @covers ::add_network_option
+	 *
+	 * @dataProvider data_slashed_options
+	 */
+	public function test_slash_add_network_option( $name, $value ) {
+		$result = add_network_option( null, $name, $value );
+		$this->assertTrue( $result, 'Network option was not added' );
+		$this->assertSame( $value, get_network_option( null, $name ), 'Values do not match' );
+	}
 
-		$num_queries_pre_update = get_num_queries();
+	/**
+	 * @ticket 37181
+	 *
+	 * @covers ::update_network_option
+	 *
+	 * @dataProvider data_slashed_options
+	 */
+	public function test_slash_update_network_option( $name, $value ) {
+		$result = update_network_option( null, $name, $value );
+		$this->assertTrue( $result, 'Network option was not updated' );
+		$this->assertSame( $value, get_network_option( null, $name ), 'Values do not match' );
+	}
+
+	/**
+	 * @ticket 37181
+	 *
+	 * @covers ::delete_network_option()
+	 *
+	 * @dataProvider data_slashed_options
+	 */
+	public function test_slash_delete_network_option( $name, $value ) {
+		$result = add_network_option( null, $name, $value );
+		$this->assertTrue( $result, 'Network option was not added' );
+		$this->assertSame( $value, get_network_option( null, $name ) );
+		$result = delete_network_option( null, $name );
+		$this->assertTrue( $result, 'Network option was not deleted' );
+		$this->assertFalse( get_network_option( null, $name ), 'Network option was not deleted' );
+	}
 
-		// Update the option using the same array with an object for the value.
-		$this->assertFalse( update_network_option( null, 'array_w_object', $array_w_object_2 ) );
+	public function data_slashed_options() {
+		return array(
+			'slashed option name'                   => array(
+				'option' => 'String with 1 slash \\',
+				'value'  => 'foo',
+			),
+			'slashed in middle option name'         => array(
+				'option' => 'String\\thing',
+				'value'  => 'foo',
+			),
+			'slashed option value'                  => array(
+				'option' => 'bar',
+				'value'  => 'String with 1 slash \\',
+			),
+			'slashed option name and value'         => array(
+				'option' => 'String with 1 slash \\',
+				'value'  => 'String with 1 slash \\',
+			),
+			'slashed 4 times option name and value' => array(
+				'option' => 'String with 4 slashes \\\\\\\\',
+				'value'  => 'String with 4 slashes \\\\\\\\',
+			),
+			'slashed 7 times option name and value' => array(
+				'option' => 'String with 7 slashes \\\\\\\\\\\\\\',
+				'value'  => 'String with 7 slashes \\\\\\\\\\\\\\',
+			),
+		);
+	}
 
-		// Check that no new database queries were performed.
-		$this->assertSame( $num_queries_pre_update, get_num_queries() );
+	public function data_types_options() {
+		return array(
+			'array'       => array(
+				'option'   => 'array',
+				'value'    => array(),
+				'expected' => array(),
+			),
+			'array_keys'  => array(
+				'option'   => 'array',
+				'value'    => array( 'key' => 'value' ),
+				'expected' => array( 'key' => 'value' ),
+			),
+			'int'         => array(
+				'option'   => 'int',
+				'value'    => 33,
+				'expected' => '33',
+			),
+			'string'      => array(
+				'option'   => 'string',
+				'value'    => 'foo',
+				'expected' => 'foo',
+			),
+			'string_bool' => array(
+				'option'   => 'string',
+				'value'    => 'true',
+				'expected' => 'true',
+			),
+			'float'       => array(
+				'option'   => 'float',
+				'value'    => 33.5555,
+				'expected' => '33.5555',
+			),
+			'bool'        => array(
+				'option'   => 'bool',
+				'value'    => true,
+				'expected' => '1',
+			),
+			'null'        => array(
+				'option'   => 'null',
+				'value'    => null,
+				'expected' => null,
+			),
+		);
 	}
 }
diff --git a/tests/option/option.php b/tests/option/option.php
index 0ed9128421..d510528e07 100644
--- a/tests/option/option.php
+++ b/tests/option/option.php
@@ -9,6 +9,12 @@ class Tests_Option_Option extends WP_UnitTestCase {
 		return 'foo';
 	}
 
+	/**
+	 * @covers ::get_option
+	 * @covers ::add_option
+	 * @covers ::update_option
+	 * @covers ::delete_option
+	 */
 	public function test_the_basics() {
 		$key    = 'key1';
 		$key2   = 'key2';
@@ -34,7 +40,12 @@ class Tests_Option_Option extends WP_UnitTestCase {
 		$this->assertFalse( get_option( $key2 ) );
 	}
 
-	public function test_default_filter() {
+	/**
+	 * @covers ::get_option
+	 * @covers ::add_option
+	 * @covers ::delete_option
+	 */
+	public function test_default_option_filter() {
 		$value = 'value';
 
 		$this->assertFalse( get_option( 'doesnotexist' ) );
@@ -61,6 +72,9 @@ class Tests_Option_Option extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 31047
+	 *
+	 * @covers ::get_option
+	 * @covers ::add_option
 	 */
 	public function test_add_option_should_respect_default_option_filter() {
 		add_filter( 'default_option_doesnotexist', array( $this, '__return_foo' ) );
@@ -71,6 +85,27 @@ class Tests_Option_Option extends WP_UnitTestCase {
 		$this->assertSame( 'bar', get_option( 'doesnotexist' ) );
 	}
 
+	/**
+	 * @ticket 37930
+	 *
+	 * @covers ::get_option
+	 */
+	public function test_get_option_should_call_pre_option_filter() {
+		$filter = new MockAction();
+
+		add_filter( 'pre_option', array( $filter, 'filter' ) );
+
+		get_option( 'ignored' );
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+
+	/**
+	 * @covers ::get_option
+	 * @covers ::add_option
+	 * @covers ::delete_option
+	 * @covers ::update_option
+	 */
 	public function test_serialized_data() {
 		$key   = __FUNCTION__;
 		$value = array(
@@ -93,6 +128,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_bad_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::get_option
 	 */
 	public function test_get_option_bad_option_name( $option_name ) {
 		$this->assertFalse( get_option( $option_name ) );
@@ -104,6 +141,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_bad_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::add_option
 	 */
 	public function test_add_option_bad_option_name( $option_name ) {
 		$this->assertFalse( add_option( $option_name, '' ) );
@@ -115,6 +154,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_bad_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::update_option
 	 */
 	public function test_update_option_bad_option_name( $option_name ) {
 		$this->assertFalse( update_option( $option_name, '' ) );
@@ -126,6 +167,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_bad_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::delete_option
 	 */
 	public function test_delete_option_bad_option_name( $option_name ) {
 		$this->assertFalse( delete_option( $option_name ) );
@@ -154,6 +197,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_valid_but_undesired_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::get_option
 	 */
 	public function test_get_option_valid_but_undesired_option_names( $option_name ) {
 		$this->assertFalse( get_option( $option_name ) );
@@ -165,6 +210,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_valid_but_undesired_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::add_option
 	 */
 	public function test_add_option_valid_but_undesired_option_names( $option_name ) {
 		$this->assertTrue( add_option( $option_name, '' ) );
@@ -176,6 +223,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_valid_but_undesired_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::update_option
 	 */
 	public function test_update_option_valid_but_undesired_option_names( $option_name ) {
 		$this->assertTrue( update_option( $option_name, '' ) );
@@ -187,6 +236,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 	 * @dataProvider data_valid_but_undesired_option_names
 	 *
 	 * @param mixed $option_name Option name.
+	 *
+	 * @covers ::delete_option
 	 */
 	public function test_delete_option_valid_but_undesired_option_names( $option_name ) {
 		$this->assertFalse( delete_option( $option_name ) );
@@ -210,6 +261,8 @@ class Tests_Option_Option extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 23289
+	 *
+	 * @covers ::delete_option
 	 */
 	public function test_special_option_name_alloption() {
 		$this->expectException( 'WPDieException' );
@@ -218,28 +271,21 @@ class Tests_Option_Option extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 23289
+	 *
+	 * @covers ::delete_option
 	 */
 	public function test_special_option_name_notoptions() {
 		$this->expectException( 'WPDieException' );
 		delete_option( 'notoptions' );
 	}
 
-	public function data_option_autoloading() {
-		return array(
-			array( 'autoload_yes', 'yes', 'yes' ),
-			array( 'autoload_true', true, 'yes' ),
-			array( 'autoload_string', 'foo', 'yes' ),
-			array( 'autoload_int', 123456, 'yes' ),
-			array( 'autoload_array', array(), 'yes' ),
-			array( 'autoload_no', 'no', 'no' ),
-			array( 'autoload_false', false, 'no' ),
-		);
-	}
 	/**
 	 * Options should be autoloaded unless they were added with "no" or `false`.
 	 *
 	 * @ticket 31119
 	 * @dataProvider data_option_autoloading
+	 *
+	 * @covers ::add_option
 	 */
 	public function test_option_autoloading( $name, $autoload_value, $expected ) {
 		global $wpdb;
@@ -249,4 +295,21 @@ class Tests_Option_Option extends WP_UnitTestCase {
 		$actual = $wpdb->get_row( $wpdb->prepare( "SELECT autoload FROM $wpdb->options WHERE option_name = %s LIMIT 1", $name ) );
 		$this->assertSame( $expected, $actual->autoload );
 	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_option_autoloading() {
+		return array(
+			array( 'autoload_yes', 'yes', 'yes' ),
+			array( 'autoload_true', true, 'yes' ),
+			array( 'autoload_string', 'foo', 'yes' ),
+			array( 'autoload_int', 123456, 'yes' ),
+			array( 'autoload_array', array(), 'yes' ),
+			array( 'autoload_no', 'no', 'no' ),
+			array( 'autoload_false', false, 'no' ),
+		);
+	}
 }
diff --git a/tests/option/registration.php b/tests/option/registration.php
index d60acb9ef1..04991e4a33 100644
--- a/tests/option/registration.php
+++ b/tests/option/registration.php
@@ -4,6 +4,10 @@
  * @group option
  */
 class Tests_Option_Registration extends WP_UnitTestCase {
+
+	/**
+	 * @covers ::register_setting
+	 */
 	public function test_register() {
 		register_setting( 'test_group', 'test_option' );
 
@@ -19,6 +23,10 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 		$this->assertSame( '', $args['description'] );
 	}
 
+	/**
+	 * @covers ::register_setting
+	 * @covers ::apply_filters
+	 */
 	public function test_register_with_callback() {
 		register_setting( 'test_group', 'test_option', array( $this, 'filter_registered_setting' ) );
 
@@ -26,6 +34,11 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 		$this->assertSame( 'S-M-R-T', $filtered );
 	}
 
+	/**
+	 * @covers ::register_setting
+	 * @covers WP_REST_Settings_Controller
+	 * @covers ::apply_filters
+	 */
 	public function test_register_with_array() {
 		register_setting(
 			'test_group',
@@ -45,6 +58,8 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38176
+	 *
+	 * @covers ::register_setting
 	 */
 	public function test_register_with_default() {
 		register_setting(
@@ -60,6 +75,8 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38176
+	 *
+	 * @covers ::register_setting
 	 */
 	public function test_register_with_default_override() {
 		register_setting(
@@ -77,6 +94,10 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 38930
+	 *
+	 * @covers ::register_setting
+	 * @covers ::add_option
+	 * @covers ::get_option
 	 */
 	public function test_add_option_with_no_options_cache() {
 		register_setting(
@@ -93,6 +114,8 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 
 	/**
 	 * @expectedDeprecated register_setting
+	 *
+	 * @covers ::register_setting
 	 */
 	public function test_register_deprecated_group_misc() {
 		register_setting( 'misc', 'test_option' );
@@ -100,6 +123,8 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 
 	/**
 	 * @expectedDeprecated register_setting
+	 *
+	 * @covers ::register_setting
 	 */
 	public function test_register_deprecated_group_privacy() {
 		register_setting( 'privacy', 'test_option' );
@@ -107,6 +132,9 @@ class Tests_Option_Registration extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 43207
+	 *
+	 * @covers ::register_setting
+	 * @covers ::unregister_setting
 	 */
 	public function test_unregister_setting_removes_default() {
 		register_setting(
diff --git a/tests/option/sanitize-option.php b/tests/option/sanitizeOption.php
similarity index 95%
rename from tests/option/sanitize-option.php
rename to tests/option/sanitizeOption.php
index c9e56470c7..bc0dd0843b 100644
--- a/tests/option/sanitize-option.php
+++ b/tests/option/sanitizeOption.php
@@ -3,7 +3,7 @@
 /**
  * @group option
  */
-class Tests_Sanitize_Option extends WP_UnitTestCase {
+class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 
 	/**
 	 * Data provider to test all of the sanitize_option() case
@@ -81,6 +81,8 @@ class Tests_Sanitize_Option extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider sanitize_option_provider
+	 *
+	 * @covers ::sanitize_option
 	 */
 	public function test_sanitize_option( $option_name, $sanitized, $original ) {
 		$this->assertSame( $sanitized, sanitize_option( $option_name, $original ) );
@@ -97,6 +99,8 @@ class Tests_Sanitize_Option extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider upload_path_provider
+	 *
+	 * @covers ::sanitize_option
 	 */
 	public function test_sanitize_option_upload_path( $provided, $expected ) {
 		$this->assertSame( $expected, sanitize_option( 'upload_path', $provided ) );
@@ -104,6 +108,8 @@ class Tests_Sanitize_Option extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36122
+	 *
+	 * @covers ::sanitize_option
 	 */
 	public function test_emoji_in_blogname_and_description() {
 		global $wpdb;
@@ -122,6 +128,9 @@ class Tests_Sanitize_Option extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider permalink_structure_provider
+	 *
+	 * @covers ::sanitize_option
+	 * @covers ::get_settings_errors
 	 */
 	public function test_sanitize_permalink_structure( $provided, $expected, $valid ) {
 		global $wp_settings_errors;
@@ -155,7 +164,7 @@ class Tests_Sanitize_Option extends WP_UnitTestCase {
 			array( '/%postname%/', '/%postname%/', true ),
 			array( '/%year%/%monthnum%/%day%/%postname%/', '/%year%/%monthnum%/%day%/%postname%/', true ),
 			array( '/%year/%postname%/', '/%year/%postname%/', true ),
-			array( new WP_Error( 'wpdb_get_table_charset_failure' ), false, false ), // ticket 53986
+			array( new WP_Error( 'wpdb_get_table_charset_failure' ), false, false ), // @ticket 53986
 		);
 	}
 
diff --git a/tests/option/siteOption.php b/tests/option/siteOption.php
index b1b7dfc0a4..1cba141534 100644
--- a/tests/option/siteOption.php
+++ b/tests/option/siteOption.php
@@ -8,10 +8,18 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		return 'foo';
 	}
 
+	/**
+	 * @covers ::get_site_option
+	 */
 	public function test_get_site_option_returns_false_if_option_does_not_exist() {
 		$this->assertFalse( get_site_option( 'doesnotexist' ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::delete_site_option
+	 * @covers ::get_site_option
+	 */
 	public function test_get_site_option_returns_false_after_deletion() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -20,6 +28,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertFalse( get_site_option( $key ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::get_site_option
+	 */
 	public function test_get_site_option_returns_value() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -27,6 +39,11 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( $value, get_site_option( $key ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::update_site_option
+	 * @covers ::get_site_option
+	 */
 	public function test_get_site_option_returns_updated_value() {
 		$key       = __FUNCTION__;
 		$value     = __FUNCTION__ . '_1';
@@ -36,6 +53,11 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( $new_value, get_site_option( $key ) );
 	}
 
+	/**
+	 * @covers ::add_filter
+	 * @covers ::get_site_option
+	 * @covers ::remove_filter
+	 */
 	public function test_get_site_option_does_not_exist_returns_filtered_default_with_no_default_provided() {
 		add_filter( 'default_site_option_doesnotexist', array( $this, '__return_foo' ) );
 		$site_option = get_site_option( 'doesnotexist' );
@@ -43,6 +65,11 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( 'foo', $site_option );
 	}
 
+	/**
+	 * @covers ::add_filter
+	 * @covers ::get_site_option
+	 * @covers ::remove_filter
+	 */
 	public function test_get_site_option_does_not_exist_returns_filtered_default_with_default_provided() {
 		add_filter( 'default_site_option_doesnotexist', array( $this, '__return_foo' ) );
 		$site_option = get_site_option( 'doesnotexist', 'bar' );
@@ -50,10 +77,17 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( 'foo', $site_option );
 	}
 
+	/**
+	 * @covers ::get_site_option
+	 */
 	public function test_get_site_option_does_not_exist_returns_provided_default() {
 		$this->assertSame( 'bar', get_site_option( 'doesnotexist', 'bar' ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::get_site_option
+	 */
 	public function test_get_site_option_exists_does_not_return_provided_default() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -61,6 +95,12 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( $value, get_site_option( $key, 'foo' ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::add_filter
+	 * @covers ::get_site_option
+	 * @covers ::remove_filter
+	 */
 	public function test_get_site_option_exists_does_not_return_filtered_default() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -71,12 +111,18 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( $value, $site_option );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 */
 	public function test_add_site_option_returns_true_for_new_option() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
 		$this->assertTrue( add_site_option( $key, $value ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 */
 	public function test_add_site_option_returns_false_for_existing_option() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -84,6 +130,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertFalse( add_site_option( $key, $value ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::update_site_option
+	 */
 	public function test_update_site_option_returns_false_for_same_value() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -91,6 +141,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertFalse( update_site_option( $key, $value ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::update_site_option
+	 */
 	public function test_update_site_option_returns_true_for_new_value() {
 		$key       = 'key';
 		$value     = 'value1';
@@ -99,6 +153,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertTrue( update_site_option( $key, $new_value ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::delete_site_option
+	 */
 	public function test_delete_site_option_returns_true_if_option_exists() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -106,6 +164,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertTrue( delete_site_option( $key ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::delete_site_option
+	 */
 	public function test_delete_site_option_returns_false_if_option_does_not_exist() {
 		$key   = __FUNCTION__;
 		$value = __FUNCTION__;
@@ -114,6 +176,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertFalse( delete_site_option( $key ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::get_site_option
+	 */
 	public function test_site_option_add_and_get_serialized_array() {
 		$key   = __FUNCTION__;
 		$value = array(
@@ -124,6 +190,10 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 		$this->assertSame( $value, get_site_option( $key ) );
 	}
 
+	/**
+	 * @covers ::add_site_option
+	 * @covers ::get_site_option
+	 */
 	public function test_site_option_add_and_get_serialized_object() {
 		$key        = __FUNCTION__;
 		$value      = new stdClass();
@@ -137,6 +207,9 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 	 * Ensure update_site_option() will add options with false-y values.
 	 *
 	 * @ticket 15497
+	 *
+	 * @covers ::update_site_option
+	 * @covers ::get_site_option
 	 */
 	public function test_update_adds_falsey_value() {
 		$key   = __FUNCTION__;
@@ -152,6 +225,8 @@ class Tests_Option_SiteOption extends WP_UnitTestCase {
 	 * Ensure get_site_option() doesn't cache the default value for non-existent options.
 	 *
 	 * @ticket 18955
+	 *
+	 * @covers ::get_site_option
 	 */
 	public function test_get_doesnt_cache_default_value() {
 		$option  = __FUNCTION__;
diff --git a/tests/option/siteTransient.php b/tests/option/siteTransient.php
index c654a724c5..774fc4a20a 100644
--- a/tests/option/siteTransient.php
+++ b/tests/option/siteTransient.php
@@ -13,6 +13,11 @@ class Tests_Option_SiteTransient extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @covers ::get_site_transient
+	 * @covers ::set_site_transient
+	 * @covers ::delete_site_transient
+	 */
 	public function test_the_basics() {
 		$key    = 'key1';
 		$value  = 'value1';
@@ -29,6 +34,11 @@ class Tests_Option_SiteTransient extends WP_UnitTestCase {
 		$this->assertFalse( delete_site_transient( $key ) );
 	}
 
+	/**
+	 * @covers ::get_site_transient
+	 * @covers ::set_site_transient
+	 * @covers ::delete_site_transient
+	 */
 	public function test_serialized_data() {
 		$key   = __FUNCTION__;
 		$value = array(
@@ -48,6 +58,9 @@ class Tests_Option_SiteTransient extends WP_UnitTestCase {
 	/**
 	 * @ticket 22846
 	 * @group ms-excluded
+	 *
+	 * @covers ::set_site_transient
+	 * @covers ::wp_load_alloptions
 	 */
 	public function test_set_site_transient_is_not_stored_as_autoload_option() {
 		$key = 'not_autoloaded';
diff --git a/tests/option/slashes.php b/tests/option/slashes.php
index 1cc31309e6..b7bc4f7748 100644
--- a/tests/option/slashes.php
+++ b/tests/option/slashes.php
@@ -7,51 +7,57 @@
  */
 class Tests_Option_Slashes extends WP_UnitTestCase {
 
-	public function set_up() {
-		parent::set_up();
-
-		// It is important to test with both even and odd numbered slashes,
-		// as KSES does a strip-then-add slashes in some of its function calls.
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
-	}
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 
 	/**
 	 * Tests the model function that expects un-slashed data
+	 *
+	 * @covers ::add_option
+	 * @covers ::get_option
 	 */
 	public function test_add_option() {
-		add_option( 'slash_test_1', $this->slash_1 );
-		add_option( 'slash_test_2', $this->slash_2 );
-		add_option( 'slash_test_3', $this->slash_3 );
-		add_option( 'slash_test_4', $this->slash_4 );
-
-		$this->assertSame( $this->slash_1, get_option( 'slash_test_1' ) );
-		$this->assertSame( $this->slash_2, get_option( 'slash_test_2' ) );
-		$this->assertSame( $this->slash_3, get_option( 'slash_test_3' ) );
-		$this->assertSame( $this->slash_4, get_option( 'slash_test_4' ) );
+		add_option( 'slash_test_1', self::SLASH_1 );
+		add_option( 'slash_test_2', self::SLASH_2 );
+		add_option( 'slash_test_3', self::SLASH_3 );
+		add_option( 'slash_test_4', self::SLASH_4 );
+
+		$this->assertSame( self::SLASH_1, get_option( 'slash_test_1' ) );
+		$this->assertSame( self::SLASH_2, get_option( 'slash_test_2' ) );
+		$this->assertSame( self::SLASH_3, get_option( 'slash_test_3' ) );
+		$this->assertSame( self::SLASH_4, get_option( 'slash_test_4' ) );
 	}
 
 	/**
 	 * Tests the model function that expects un-slashed data
+	 *
+	 * @covers ::add_option
+	 * @covers ::update_option
+	 * @covers ::get_option
 	 */
 	public function test_update_option() {
 		add_option( 'slash_test_5', 'foo' );
 
-		update_option( 'slash_test_5', $this->slash_1 );
-		$this->assertSame( $this->slash_1, get_option( 'slash_test_5' ) );
+		update_option( 'slash_test_5', self::SLASH_1 );
+		$this->assertSame( self::SLASH_1, get_option( 'slash_test_5' ) );
 
-		update_option( 'slash_test_5', $this->slash_2 );
-		$this->assertSame( $this->slash_2, get_option( 'slash_test_5' ) );
+		update_option( 'slash_test_5', self::SLASH_2 );
+		$this->assertSame( self::SLASH_2, get_option( 'slash_test_5' ) );
 
-		update_option( 'slash_test_5', $this->slash_3 );
-		$this->assertSame( $this->slash_3, get_option( 'slash_test_5' ) );
+		update_option( 'slash_test_5', self::SLASH_3 );
+		$this->assertSame( self::SLASH_3, get_option( 'slash_test_5' ) );
 
-		update_option( 'slash_test_5', $this->slash_4 );
-		$this->assertSame( $this->slash_4, get_option( 'slash_test_5' ) );
+		update_option( 'slash_test_5', self::SLASH_4 );
+		$this->assertSame( self::SLASH_4, get_option( 'slash_test_5' ) );
 	}
 }
diff --git a/tests/option/themeMods.php b/tests/option/themeMods.php
index 5c008e8a15..48512dc100 100644
--- a/tests/option/themeMods.php
+++ b/tests/option/themeMods.php
@@ -3,16 +3,26 @@
 /**
  * @group option
  */
-class Tests_Option_Theme_Mods extends WP_UnitTestCase {
+class Tests_Option_ThemeMods extends WP_UnitTestCase {
 
+	/**
+	 * @covers ::get_theme_mod
+	 */
 	public function test_theme_mod_default() {
 		$this->assertFalse( get_theme_mod( 'non_existent' ) );
 	}
 
+	/**
+	 * @covers ::get_theme_mod
+	 */
 	public function test_theme_mod_defined_default() {
 		$this->assertSame( 'default', get_theme_mod( 'non_existent', 'default' ) );
 	}
 
+	/**
+	 * @covers ::get_theme_mod
+	 * @covers ::set_theme_mod
+	 */
 	public function test_theme_mod_set() {
 		$expected = 'value';
 		set_theme_mod( 'test_name', $expected );
@@ -21,6 +31,8 @@ class Tests_Option_Theme_Mods extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 51423
+	 *
+	 * @covers ::set_theme_mod
 	 */
 	public function test_theme_mod_set_with_invalid_theme_mods_option() {
 		$theme_slug = get_option( 'stylesheet' );
@@ -28,6 +40,10 @@ class Tests_Option_Theme_Mods extends WP_UnitTestCase {
 		self::test_theme_mod_set();
 	}
 
+	/**
+	 * @covers ::get_theme_mod
+	 * @covers ::set_theme_mod
+	 */
 	public function test_theme_mod_update() {
 		set_theme_mod( 'test_update', 'first_value' );
 		$expected = 'updated_value';
@@ -35,6 +51,11 @@ class Tests_Option_Theme_Mods extends WP_UnitTestCase {
 		$this->assertSame( $expected, get_theme_mod( 'test_update' ) );
 	}
 
+	/**
+	 * @covers ::set_theme_mod
+	 * @covers ::remove_theme_mod
+	 * @covers ::get_theme_mod
+	 */
 	public function test_theme_mod_remove() {
 		set_theme_mod( 'test_remove', 'value' );
 		remove_theme_mod( 'test_remove' );
@@ -45,6 +66,8 @@ class Tests_Option_Theme_Mods extends WP_UnitTestCase {
 	 * @ticket 34290
 	 *
 	 * @dataProvider data_theme_mod_default_value_with_percent_symbols
+	 *
+	 * @covers ::get_theme_mod
 	 */
 	public function test_theme_mod_default_value_with_percent_symbols( $default, $expected ) {
 		$this->assertSame( $expected, get_theme_mod( 'test_name', $default ) );
diff --git a/tests/option/transient.php b/tests/option/transient.php
index 0bb6b685ee..cf10eaed1b 100644
--- a/tests/option/transient.php
+++ b/tests/option/transient.php
@@ -13,6 +13,11 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @covers ::get_transient
+	 * @covers ::set_transient
+	 * @covers ::delete_transient
+	 */
 	public function test_the_basics() {
 		$key    = 'key1';
 		$value  = 'value1';
@@ -29,6 +34,11 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 		$this->assertFalse( delete_transient( $key ) );
 	}
 
+	/**
+	 * @covers ::get_transient
+	 * @covers ::set_transient
+	 * @covers ::delete_transient
+	 */
 	public function test_serialized_data() {
 		$key   = rand_str();
 		$value = array(
@@ -47,6 +57,10 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22807
+	 *
+	 * @covers ::get_option
+	 * @covers ::set_transient
+	 * @covers ::update_option
 	 */
 	public function test_transient_data_with_timeout() {
 		$key   = rand_str();
@@ -68,6 +82,11 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22807
+	 *
+	 * @covers ::set_transient
+	 * @covers ::get_transient
+	 * @covers ::get_option
+	 * @covers ::update_option
 	 */
 	public function test_transient_add_timeout() {
 		$key    = rand_str();
@@ -91,6 +110,9 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 	 * If get_option( $transient_timeout ) returns false, don't bother trying to delete the transient.
 	 *
 	 * @ticket 30380
+	 *
+	 * @covers ::set_transient
+	 * @covers ::get_transient
 	 */
 	public function test_nonexistent_key_dont_delete_if_false() {
 		// Create a bogus a transient.
@@ -119,6 +141,9 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30380
+	 *
+	 * @covers ::set_transient
+	 * @covers ::get_transient
 	 */
 	public function test_nonexistent_key_old_timeout() {
 		// Create a transient.
@@ -145,14 +170,16 @@ class Tests_Option_Transient extends WP_UnitTestCase {
 
 		$expected = array(
 			array(
-				'action' => 'action',
-				'tag'    => 'delete_option',
-				'args'   => array( $transient_option ),
+				'action'    => 'action',
+				'hook_name' => 'delete_option',
+				'tag'       => 'delete_option', // Back compat.
+				'args'      => array( $transient_option ),
 			),
 			array(
-				'action' => 'action',
-				'tag'    => 'delete_option',
-				'args'   => array( $timeout ),
+				'action'    => 'action',
+				'hook_name' => 'delete_option',
+				'tag'       => 'delete_option', // Back compat.
+				'args'      => array( $timeout ),
 			),
 		);
 		$this->assertSame( $expected, $a->get_events() );
diff --git a/tests/option/updateOption.php b/tests/option/updateOption.php
index db2aab24a2..7832a7f8fb 100644
--- a/tests/option/updateOption.php
+++ b/tests/option/updateOption.php
@@ -6,6 +6,10 @@
 class Tests_Option_UpdateOption extends WP_UnitTestCase {
 	/**
 	 * @ticket 31047
+	 *
+	 * @covers ::add_filter
+	 * @covers ::update_option
+	 * @covers ::remove_filter
 	 */
 	public function test_should_respect_default_option_filter_when_option_does_not_yet_exist_in_database() {
 		add_filter( 'default_option_doesnotexist', array( $this, '__return_foo' ) );
@@ -18,6 +22,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_yes_for_nonexistent_option_when_autoload_param_is_missing() {
 		global $wpdb;
@@ -38,6 +46,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_yes_for_nonexistent_option_when_autoload_param_is_yes() {
 		global $wpdb;
@@ -58,6 +70,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_no_for_nonexistent_option_when_autoload_param_is_no() {
 		global $wpdb;
@@ -79,6 +95,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_should_set_autoload_no_for_nonexistent_option_when_autoload_param_is_false() {
 		global $wpdb;
@@ -100,6 +120,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_autoload_should_be_updated_for_existing_option_when_value_is_changed() {
 		global $wpdb;
@@ -121,6 +145,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_autoload_should_not_be_updated_for_existing_option_when_value_is_unchanged() {
 		global $wpdb;
@@ -143,6 +171,10 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 26394
+	 *
+	 * @covers ::update_option
+	 * @covers ::wp_load_alloptions
+	 * @covers ::get_option
 	 */
 	public function test_autoload_should_not_be_updated_for_existing_option_when_value_is_changed_but_no_value_of_autoload_is_provided() {
 		global $wpdb;
@@ -160,13 +192,17 @@ class Tests_Option_UpdateOption extends WP_UnitTestCase {
 		$before = $wpdb->num_queries;
 		$value  = get_option( 'foo' );
 
-		// 'foo' should still be autoload=yes, so we should see no additional querios.
+		// 'foo' should still be autoload=yes, so we should see no additional queries.
 		$this->assertSame( $before, $wpdb->num_queries );
 		$this->assertSame( $value, 'bar2' );
 	}
 
 	/**
 	 * @ticket 38903
+	 *
+	 * @covers ::add_option
+	 * @covers ::get_num_queries
+	 * @covers ::update_option
 	 */
 	public function test_update_option_array_with_object() {
 		$array_w_object = array(
diff --git a/tests/option/userSettings.php b/tests/option/userSettings.php
index 46ab2a899a..b2cc9dfbff 100644
--- a/tests/option/userSettings.php
+++ b/tests/option/userSettings.php
@@ -1,8 +1,9 @@
 <?php
 /**
- * @group 123456
+ * @group option
+ * @group user
  */
-class Tests_User_Settings extends WP_UnitTestCase {
+class Tests_Option_UserSettings extends WP_UnitTestCase {
 	protected $user_id;
 
 	public function set_up() {
@@ -23,6 +24,11 @@ class Tests_User_Settings extends WP_UnitTestCase {
 		parent::tear_down();
 	}
 
+	/**
+	 * @covers ::get_user_setting
+	 * @covers ::get_all_user_settings
+	 * @covers ::wp_set_all_user_settings
+	 */
 	public function test_set_user_setting() {
 		$foo = get_user_setting( 'foo' );
 
@@ -33,6 +39,11 @@ class Tests_User_Settings extends WP_UnitTestCase {
 		$this->assertSame( 'bar', get_user_setting( 'foo' ) );
 	}
 
+	/**
+	 * @covers ::get_user_setting
+	 * @covers ::get_all_user_settings
+	 * @covers ::wp_set_all_user_settings
+	 */
 	public function test_set_user_setting_dashes() {
 		$foo = get_user_setting( 'foo' );
 
@@ -43,6 +54,11 @@ class Tests_User_Settings extends WP_UnitTestCase {
 		$this->assertSame( 'foo-bar-baz', get_user_setting( 'foo' ) );
 	}
 
+	/**
+	 * @covers ::get_user_setting
+	 * @covers ::get_all_user_settings
+	 * @covers ::wp_set_all_user_settings
+	 */
 	public function test_set_user_setting_strip_asterisks() {
 		$foo = get_user_setting( 'foo' );
 
diff --git a/tests/option/wpLoadAllOptions.php b/tests/option/wpLoadAlloptions.php
similarity index 90%
rename from tests/option/wpLoadAllOptions.php
rename to tests/option/wpLoadAlloptions.php
index 53843c674f..b012e72435 100644
--- a/tests/option/wpLoadAllOptions.php
+++ b/tests/option/wpLoadAlloptions.php
@@ -4,7 +4,7 @@
  *
  * @group option
  */
-class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
+class Tests_Option_wpLoadAlloptions extends WP_UnitTestCase {
 	protected $alloptions = null;
 
 	public function tear_down() {
@@ -12,12 +12,17 @@ class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
 		parent::tear_down();
 	}
 
+	/**
+	 * @covers ::wp_cache_get
+	 */
 	public function test_if_alloptions_is_cached() {
 		$this->assertNotEmpty( wp_cache_get( 'alloptions', 'options' ) );
 	}
 
 	/**
 	 * @depends test_if_alloptions_is_cached
+	 *
+	 * @covers ::wp_cache_delete
 	 */
 	public function test_if_cached_alloptions_is_deleted() {
 		$this->assertTrue( wp_cache_delete( 'alloptions', 'options' ) );
@@ -25,6 +30,8 @@ class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
 
 	/**
 	 * @depends test_if_alloptions_is_cached
+	 *
+	 * @covers ::wp_load_alloptions
 	 */
 	public function test_if_alloptions_are_retrieved_from_cache() {
 		global $wpdb;
@@ -38,6 +45,8 @@ class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
 
 	/**
 	 * @depends test_if_cached_alloptions_is_deleted
+	 *
+	 * @covers ::wp_load_alloptions
 	 */
 	public function test_if_alloptions_are_retrieved_from_database() {
 		global $wpdb;
@@ -55,6 +64,8 @@ class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
 
 	/**
 	 * @depends test_if_cached_alloptions_is_deleted
+	 *
+	 * @covers ::wp_load_alloptions
 	 */
 	public function test_filter_pre_cache_alloptions_is_called() {
 		$temp = wp_installing();
@@ -81,6 +92,8 @@ class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
 
 	/**
 	 * @depends test_if_alloptions_is_cached
+	 *
+	 * @covers ::wp_load_alloptions
 	 */
 	public function test_filter_pre_cache_alloptions_is_not_called() {
 		$temp = wp_installing();
diff --git a/tests/option/wpUserSettings.php b/tests/option/wpUserSettings.php
new file mode 100644
index 0000000000..44cffc730e
--- /dev/null
+++ b/tests/option/wpUserSettings.php
@@ -0,0 +1,36 @@
+<?php
+/**
+ * Test wp_user_settings().
+ *
+ * @group option
+ * @group user
+ * @covers ::wp_user_settings
+ */
+class Tests_Option_wpUserSettings extends WP_UnitTestCase {
+
+	/**
+	 * Tests that PHP 8.1 "passing null to non-nullable" deprecation notice
+	 * is not thrown for the `$domain` parameter of setcookie() calls in the function.
+	 *
+	 * The notice that we should not see:
+	 * `Deprecated: setcookie(): Passing null to parameter #5 ($domain) of type string is deprecated`.
+	 *
+	 * Note: This does not test the actual functioning of wp_user_settings().
+	 * It just and only tests for/against the deprecation notice.
+	 *
+	 * @ticket 54914
+	 */
+	public function test_wp_user_settings_does_not_throw_deprecation_notice_for_setcookie() {
+		set_current_screen( 'edit.php' );
+		wp_set_current_user( self::factory()->user->create() );
+
+		// Verify that the function's starting conditions are satisfied.
+		$this->assertTrue( is_admin() );
+		$this->assertGreaterThan( 0, get_current_user_id() );
+
+		// `Cannot modify header information - headers already sent by...` from setcookie().
+		$this->expectWarning();
+
+		wp_user_settings();
+	}
+}
diff --git a/tests/pluggable.php b/tests/pluggable.php
index 0138ab371e..8cd8831f22 100644
--- a/tests/pluggable.php
+++ b/tests/pluggable.php
@@ -224,8 +224,8 @@ class Tests_Pluggable extends WP_UnitTestCase {
 				'extra_special_chars' => false,
 			),
 			'wp_rand'                         => array(
-				'min' => 0,
-				'max' => 0,
+				'min' => null,
+				'max' => null,
 			),
 			'wp_set_password'                 => array( 'password', 'user_id' ),
 			'get_avatar'                      => array(
@@ -249,7 +249,7 @@ class Tests_Pluggable extends WP_UnitTestCase {
 				'blog_title',
 				'user_name',
 				'user_email',
-				'public',
+				'is_public',
 				'deprecated'    => '',
 				'user_password' => '',
 				'language'      => '',
@@ -267,23 +267,35 @@ class Tests_Pluggable extends WP_UnitTestCase {
 				array(
 
 					// wp-includes/cache.php:
+					'wp_cache_init'                      => array(),
 					'wp_cache_add'                       => array(
 						'key',
 						'data',
 						'group'  => '',
 						'expire' => 0,
 					),
-					'wp_cache_close'                     => array(),
-					'wp_cache_decr'                      => array(
+					'wp_cache_add_multiple'              => array(
+						'data',
+						'group'  => '',
+						'expire' => 0,
+					),
+					'wp_cache_replace'                   => array(
 						'key',
-						'offset' => 1,
+						'data',
 						'group'  => '',
+						'expire' => 0,
 					),
-					'wp_cache_delete'                    => array(
+					'wp_cache_set'                       => array(
 						'key',
-						'group' => '',
+						'data',
+						'group'  => '',
+						'expire' => 0,
+					),
+					'wp_cache_set_multiple'              => array(
+						'data',
+						'group'  => '',
+						'expire' => 0,
 					),
-					'wp_cache_flush'                     => array(),
 					'wp_cache_get'                       => array(
 						'key',
 						'group' => '',
@@ -295,27 +307,32 @@ class Tests_Pluggable extends WP_UnitTestCase {
 						'group' => '',
 						'force' => false,
 					),
-					'wp_cache_incr'                      => array(
+					'wp_cache_delete'                    => array(
 						'key',
-						'offset' => 1,
-						'group'  => '',
+						'group' => '',
 					),
-					'wp_cache_init'                      => array(),
-					'wp_cache_replace'                   => array(
+					'wp_cache_delete_multiple'           => array(
+						'keys',
+						'group' => '',
+					),
+					'wp_cache_incr'                      => array(
 						'key',
-						'data',
+						'offset' => 1,
 						'group'  => '',
-						'expire' => 0,
 					),
-					'wp_cache_set'                       => array(
+					'wp_cache_decr'                      => array(
 						'key',
-						'data',
+						'offset' => 1,
 						'group'  => '',
-						'expire' => 0,
 					),
-					'wp_cache_switch_to_blog'            => array( 'blog_id' ),
+					'wp_cache_flush'                     => array(),
+					'wp_cache_flush_runtime'             => array(),
+					'wp_cache_flush_group'               => array( 'group' ),
+					'wp_cache_supports_group_flush'      => array(),
+					'wp_cache_close'                     => array(),
 					'wp_cache_add_global_groups'         => array( 'groups' ),
 					'wp_cache_add_non_persistent_groups' => array( 'groups' ),
+					'wp_cache_switch_to_blog'            => array( 'blog_id' ),
 					'wp_cache_reset'                     => array(),
 				)
 			);
@@ -323,20 +340,4 @@ class Tests_Pluggable extends WP_UnitTestCase {
 
 		return $signatures;
 	}
-
-	/**
-	 * @ticket 28020
-	 */
-	public function test_get_user_by_should_return_same_instance_as_wp_get_current_user() {
-		// Create a test user.
-		$new_user = self::factory()->user->create( array( 'role' => 'subscriber' ) );
-
-		// Set the test user as the current user.
-		$current_user = wp_set_current_user( $new_user );
-
-		// Get the test user using get_user_by().
-		$from_get_user_by = get_user_by( 'id', $new_user );
-
-		$this->assertSame( $current_user, $from_get_user_by );
-	}
 }
diff --git a/tests/pluggable/getUserBy.php b/tests/pluggable/getUserBy.php
new file mode 100644
index 0000000000..96ae8a1b5f
--- /dev/null
+++ b/tests/pluggable/getUserBy.php
@@ -0,0 +1,24 @@
+<?php
+
+/**
+ * @group pluggable
+ * @covers ::get_user_by
+ */
+class Tests_Pluggable_GetUserBy extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 28020
+	 */
+	public function test_get_user_by_should_return_same_instance_as_wp_get_current_user() {
+		// Create a test user.
+		$new_user = self::factory()->user->create( array( 'role' => 'subscriber' ) );
+
+		// Set the test user as the current user.
+		$current_user = wp_set_current_user( $new_user );
+
+		// Get the test user using get_user_by().
+		$from_get_user_by = get_user_by( 'id', $new_user );
+
+		$this->assertSame( $current_user, $from_get_user_by );
+	}
+}
diff --git a/tests/pluggable/wpRand.php b/tests/pluggable/wpRand.php
new file mode 100644
index 0000000000..e7ef3b2725
--- /dev/null
+++ b/tests/pluggable/wpRand.php
@@ -0,0 +1,100 @@
+<?php
+
+/**
+ * @group pluggable
+ * @covers ::wp_rand
+ */
+class Tests_Pluggable_wpRand extends WP_UnitTestCase {
+
+	/**
+	 * Tests that wp_rand() returns a non-negative integer for both positive and negative input.
+	 *
+	 * @ticket 55194
+	 * @dataProvider data_wp_rand_should_return_a_non_negative_integer
+	 *
+	 * @param int $min Lower limit for the generated number.
+	 * @param int $max Upper limit for the generated number.
+	 */
+	public function test_wp_rand_should_return_a_non_negative_integer( $min, $max ) {
+		$this->assertGreaterThanOrEqual(
+			0,
+			wp_rand( $min, $max ),
+			'The value was not greater than or equal 0'
+		);
+
+		$this->assertLessThan(
+			100,
+			wp_rand( $min, $max ),
+			'The value was not less than 100'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_rand_should_return_a_non_negative_integer() {
+		return array(
+			'1 and 99'       => array(
+				'min' => 1,
+				'max' => 99,
+			),
+			'-1 and 99'      => array(
+				'min' => -1,
+				'max' => 99,
+			),
+			'1 and -99'      => array(
+				'min' => 1,
+				'max' => -99,
+			),
+			'-1 and -99'     => array(
+				'min' => -1,
+				'max' => -99,
+			),
+			'1.0 and 99.0'   => array(
+				'min' => 1.0,
+				'max' => 99.0,
+			),
+			'-1.0 and -99.0' => array(
+				'min' => -1.0,
+				'max' => -99.0,
+			),
+		);
+	}
+
+	/**
+	 * Tests that wp_rand() returns zero when `$min` and `$max` are zero.
+	 *
+	 * @ticket 55194
+	 * @dataProvider data_wp_rand_should_return_zero_when_min_and_max_are_zero
+	 *
+	 * @param mixed $min Lower limit for the generated number.
+	 * @param mixed $max Upper limit for the generated number.
+	 */
+	public function test_wp_rand_should_return_zero_when_min_and_max_are_zero( $min, $max ) {
+		$this->assertSame( 0, wp_rand( $min, $max ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_rand_should_return_zero_when_min_and_max_are_zero() {
+		return array(
+			'min and max as 0'      => array(
+				'min' => 0,
+				'max' => 0,
+			),
+			'min and max as 0.0'    => array(
+				'min' => 0.0,
+				'max' => 0.0,
+			),
+			'min as null, max as 0' => array(
+				'min' => null,
+				'max' => 0,
+			),
+		);
+	}
+}
diff --git a/tests/pomo/noopTranslations.php b/tests/pomo/noopTranslations.php
index 00ce41ee82..3fcfed6b57 100644
--- a/tests/pomo/noopTranslations.php
+++ b/tests/pomo/noopTranslations.php
@@ -4,6 +4,28 @@
  * @group pomo
  */
 class Tests_POMO_NOOPTranslations extends WP_UnitTestCase {
+
+	/**
+	 * NOOP translations object.
+	 *
+	 * @var NOOP_Translations
+	 */
+	private $noop;
+
+	/**
+	 * Single translation entry object.
+	 *
+	 * @var Translation_Entry
+	 */
+	private $entry;
+
+	/**
+	 * Multi translation entries object.
+	 *
+	 * @var Translation_Entry
+	 */
+	private $plural_entry;
+
 	public function set_up() {
 		parent::set_up();
 		$this->noop         = new NOOP_Translations;
diff --git a/tests/pomo/po.php b/tests/pomo/po.php
index 9661aa6883..d7652f27e6 100644
--- a/tests/pomo/po.php
+++ b/tests/pomo/po.php
@@ -5,17 +5,12 @@
  */
 class Tests_POMO_PO extends WP_UnitTestCase {
 
-	public static function set_up_before_class() {
-		parent::set_up_before_class();
-
-		require_once ABSPATH . '/wp-includes/pomo/po.php';
-	}
-
-	public function set_up() {
-		parent::set_up();
-
-		// Not so random wordpress.pot string -- multiple lines.
-		$this->mail    = 'Your new WordPress blog has been successfully set up at:
+	/**
+	 * Mail content.
+	 *
+	 * @var string
+	 */
+	const MAIL_TEXT = 'Your new WordPress blog has been successfully set up at:
 
 %1$s
 
@@ -29,8 +24,13 @@ We hope you enjoy your new blog. Thanks!
 --The WordPress Team
 http://wordpress.org/
 ';
-		$this->mail    = str_replace( "\r\n", "\n", $this->mail );
-		$this->po_mail = '""
+
+	/**
+	 * Mail content for translation readiness.
+	 *
+	 * @var string
+	 */
+	const PO_MAIL = '""
 "Your new WordPress blog has been successfully set up at:\n"
 "\n"
 "%1$s\n"
@@ -44,8 +44,11 @@ http://wordpress.org/
 "\n"
 "--The WordPress Team\n"
 "http://wordpress.org/\n"';
-		$this->a90     = str_repeat( 'a', 90 );
-		$this->po_a90  = "\"$this->a90\"";
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		require_once ABSPATH . '/wp-includes/pomo/po.php';
 	}
 
 	public function test_prepend_each_line() {
@@ -60,7 +63,9 @@ http://wordpress.org/
 		// Simple.
 		$this->assertSame( '"baba"', $po->poify( 'baba' ) );
 		// Long word.
-		$this->assertSame( $this->po_a90, $po->poify( $this->a90 ) );
+		$long_word    = str_repeat( 'a', 90 );
+		$po_long_word = "\"$long_word\"";
+		$this->assertSame( $po_long_word, $po->poify( $long_word ) );
 		// Tab.
 		$this->assertSame( '"ba\tba"', $po->poify( "ba\tba" ) );
 		// Do not add leading empty string of one-line string ending on a newline.
@@ -71,18 +76,24 @@ http://wordpress.org/
 		$src = 'Categories can be selectively converted to tags using the <a href="%s">category to tag converter</a>.';
 		$this->assertSame( '"Categories can be selectively converted to tags using the <a href=\\"%s\\">category to tag converter</a>."', $po->poify( $src ) );
 
-		$this->assertSameIgnoreEOL( $this->po_mail, $po->poify( $this->mail ) );
+		$mail = str_replace( "\r\n", "\n", self::MAIL_TEXT );
+		$this->assertSameIgnoreEOL( self::PO_MAIL, $po->poify( $mail ) );
 	}
 
 	public function test_unpoify() {
 		$po = new PO();
 		$this->assertSame( 'baba', $po->unpoify( '"baba"' ) );
 		$this->assertSame( "baba\ngugu", $po->unpoify( '"baba\n"' . "\t\t\t\n" . '"gugu"' ) );
-		$this->assertSame( $this->a90, $po->unpoify( $this->po_a90 ) );
+
+		$long_word    = str_repeat( 'a', 90 );
+		$po_long_word = "\"$long_word\"";
+		$this->assertSame( $long_word, $po->unpoify( $po_long_word ) );
 		$this->assertSame( '\\t\\n', $po->unpoify( '"\\\\t\\\\n"' ) );
 		// Wordwrapped.
 		$this->assertSame( 'babadyado', $po->unpoify( "\"\"\n\"baba\"\n\"dyado\"" ) );
-		$this->assertSameIgnoreEOL( $this->mail, $po->unpoify( $this->po_mail ) );
+
+		$mail = str_replace( "\r\n", "\n", self::MAIL_TEXT );
+		$this->assertSameIgnoreEOL( $mail, $po->unpoify( self::PO_MAIL ) );
 	}
 
 	public function test_export_entry() {
diff --git a/tests/post.php b/tests/post.php
index f8edf13dae..6f07ca8593 100644
--- a/tests/post.php
+++ b/tests/post.php
@@ -9,6 +9,8 @@ class Tests_Post extends WP_UnitTestCase {
 	protected static $editor_id;
 	protected static $grammarian_id;
 
+	private $post_ids = array();
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$editor_id = $factory->user->create( array( 'role' => 'editor' ) );
 
@@ -30,683 +32,17 @@ class Tests_Post extends WP_UnitTestCase {
 		remove_role( 'grammarian' );
 	}
 
-	public function set_up() {
-		parent::set_up();
-
-		wp_set_current_user( self::$editor_id );
-		_set_cron_array( array() );
-
-		$this->post_ids = array();
-	}
-
-	/**
-	 * Helper function: return the timestamp(s) of cron jobs for the specified hook and post.
-	 */
-	private function next_schedule_for_post( $hook, $id ) {
-		return wp_next_scheduled( 'publish_future_post', array( 0 => (int) $id ) );
-	}
-
-	/**
-	 * Helper function, unsets current user globally.
-	 */
-	private function unset_current_user() {
-		global $current_user, $user_ID;
-
-		$current_user = null;
-		$user_ID      = null;
-	}
-
-	/**
-	 * Test simple valid behavior: insert and get a post.
-	 */
-	public function test_vb_insert_get_delete() {
-		register_post_type( 'cpt', array( 'taxonomies' => array( 'post_tag', 'ctax' ) ) );
-		register_taxonomy( 'ctax', 'cpt' );
-		$post_types = array( 'post', 'cpt' );
-
-		foreach ( $post_types as $post_type ) {
-			$post = array(
-				'post_author'  => self::$editor_id,
-				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
-				'tax_input'    => array(
-					'post_tag' => 'tag1,tag2',
-					'ctax'     => 'cterm1,cterm2',
-				),
-				'post_type'    => $post_type,
-			);
-
-			// Insert a post and make sure the ID is OK.
-			$id = wp_insert_post( $post );
-			$this->assertIsNumeric( $id );
-			$this->assertGreaterThan( 0, $id );
-
-			// Fetch the post and make sure it matches.
-			$out = get_post( $id );
-
-			$this->assertSame( $post['post_content'], $out->post_content );
-			$this->assertSame( $post['post_title'], $out->post_title );
-			$this->assertSame( $post['post_status'], $out->post_status );
-			$this->assertEquals( $post['post_author'], $out->post_author );
-
-			// Test cache state.
-			$pcache = wp_cache_get( $id, 'posts' );
-			$this->assertInstanceOf( 'stdClass', $pcache );
-			$this->assertSame( $id, $pcache->ID );
-
-			update_object_term_cache( $id, $post_type );
-			$tcache = wp_cache_get( $id, 'post_tag_relationships' );
-			$this->assertIsArray( $tcache );
-			$this->assertCount( 2, $tcache );
-
-			$tcache = wp_cache_get( $id, 'ctax_relationships' );
-			if ( 'cpt' === $post_type ) {
-				$this->assertIsArray( $tcache );
-				$this->assertCount( 2, $tcache );
-			} else {
-				$this->assertFalse( $tcache );
-			}
-
-			wp_delete_post( $id, true );
-			$this->assertFalse( wp_cache_get( $id, 'posts' ) );
-			$this->assertFalse( wp_cache_get( $id, 'post_tag_relationships' ) );
-			$this->assertFalse( wp_cache_get( $id, 'ctax_relationships' ) );
-		}
-
-		$GLOBALS['wp_taxonomies']['post_tag']->object_type = array( 'post' );
-	}
-
-	/**
-	 * Insert a post with a future date, and make sure the status and cron schedule are correct.
-	 */
-	public function test_vb_insert_future() {
-		$future_date = strtotime( '+1 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-		// dmp( _get_cron_array() );
-		$this->assertIsNumeric( $id );
-		$this->assertGreaterThan( 0, $id );
-
-		// Fetch the post and make sure it matches.
-		$out = get_post( $id );
-
-		$this->assertSame( $post['post_content'], $out->post_content );
-		$this->assertSame( $post['post_title'], $out->post_title );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertEquals( $post['post_author'], $out->post_author );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// There should be a publish_future_post hook scheduled on the future date.
-		$this->assertSame( $future_date, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * Insert a post with a future date, and make sure the status and cron schedule are correct.
-	 */
-	public function test_vb_insert_future_over_dst() {
-		// Some magic days - one DST one not.
-		$future_date_1 = strtotime( 'June 21st +1 year' );
-		$future_date_2 = strtotime( 'Jan 11th +1 year' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-
-		// Fetch the post and make sure has the correct date and status.
-		$out = get_post( $id );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// Check that there's a publish_future_post job scheduled at the right time.
-		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-		// Now save it again with a date further in the future.
-
-		$post['ID']            = $id;
-		$post['post_date']     = date_format( date_create( "@{$future_date_2}" ), 'Y-m-d H:i:s' );
-		$post['post_date_gmt'] = null;
-		wp_update_post( $post );
-
-		// Fetch the post again and make sure it has the new post_date.
-		$out = get_post( $id );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// And the correct date on the cron job.
-		$this->assertSame( $future_date_2, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * Future post bug: posts get published at the wrong time if you edit the timestamp.
-	 *
-	 * @ticket 4710
-	 */
-	public function test_vb_insert_future_edit_bug() {
-		$future_date_1 = strtotime( '+1 day' );
-		$future_date_2 = strtotime( '+2 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-
-		// Fetch the post and make sure has the correct date and status.
-		$out = get_post( $id );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// Check that there's a publish_future_post job scheduled at the right time.
-		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-		// Now save it again with a date further in the future.
-
-		$post['ID']            = $id;
-		$post['post_date']     = date_format( date_create( "@{$future_date_2}" ), 'Y-m-d H:i:s' );
-		$post['post_date_gmt'] = null;
-		wp_update_post( $post );
-
-		// Fetch the post again and make sure it has the new post_date.
-		$out = get_post( $id );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// And the correct date on the cron job.
-		$this->assertSame( $future_date_2, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * Insert a draft post with a future date, and make sure no cron schedule is set.
-	 */
-	public function test_vb_insert_future_draft() {
-		$future_date = strtotime( '+1 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'draft',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-		// dmp( _get_cron_array() );
-		$this->assertIsNumeric( $id );
-		$this->assertGreaterThan( 0, $id );
-
-		// Fetch the post and make sure it matches.
-		$out = get_post( $id );
-
-		$this->assertSame( $post['post_content'], $out->post_content );
-		$this->assertSame( $post['post_title'], $out->post_title );
-		$this->assertSame( 'draft', $out->post_status );
-		$this->assertEquals( $post['post_author'], $out->post_author );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// There should be a publish_future_post hook scheduled on the future date.
-		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-	}
-
-	/**
-	 * Insert a future post, then edit and change it to draft, and make sure cron gets it right.
-	 */
-	public function test_vb_insert_future_change_to_draft() {
-		$future_date_1 = strtotime( '+1 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-
-		// Fetch the post and make sure has the correct date and status.
-		$out = get_post( $id );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// Check that there's a publish_future_post job scheduled at the right time.
-		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-		// Now save it again with status set to draft.
-
-		$post['ID']          = $id;
-		$post['post_status'] = 'draft';
-		wp_update_post( $post );
-
-		// Fetch the post again and make sure it has the new post_date.
-		$out = get_post( $id );
-		$this->assertSame( 'draft', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// And the correct date on the cron job.
-		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * Insert a future post, then edit and change the status, and make sure cron gets it right.
-	 */
-	public function test_vb_insert_future_change_status() {
-		$future_date_1 = strtotime( '+1 day' );
-
-		$statuses = array( 'draft', 'static', 'object', 'attachment', 'inherit', 'pending' );
-
-		foreach ( $statuses as $status ) {
-			$post = array(
-				'post_author'  => self::$editor_id,
-				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
-				'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
-			);
-
-			// Insert a post and make sure the ID is OK.
-			$id               = wp_insert_post( $post );
-			$this->post_ids[] = $id;
-
-			// Fetch the post and make sure has the correct date and status.
-			$out = get_post( $id );
-			$this->assertSame( 'future', $out->post_status );
-			$this->assertSame( $post['post_date'], $out->post_date );
-
-			// Check that there's a publish_future_post job scheduled at the right time.
-			$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-			// Now save it again with status changed.
-
-			$post['ID']          = $id;
-			$post['post_status'] = $status;
-			wp_update_post( $post );
-
-			// Fetch the post again and make sure it has the new post_date.
-			$out = get_post( $id );
-			$this->assertSame( $status, $out->post_status );
-			$this->assertSame( $post['post_date'], $out->post_date );
-
-			// And the correct date on the cron job.
-			$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $id ) );
-		}
-	}
-
-	/**
-	 * Insert a draft post with a future date, and make sure no cron schedule is set.
-	 */
-	public function test_vb_insert_future_private() {
-		$future_date = strtotime( '+1 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'private',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-		// dmp( _get_cron_array() );
-		$this->assertIsNumeric( $id );
-		$this->assertGreaterThan( 0, $id );
-
-		// Fetch the post and make sure it matches.
-		$out = get_post( $id );
-
-		$this->assertSame( $post['post_content'], $out->post_content );
-		$this->assertSame( $post['post_title'], $out->post_title );
-		$this->assertSame( 'private', $out->post_status );
-		$this->assertEquals( $post['post_author'], $out->post_author );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// There should be a publish_future_post hook scheduled on the future date.
-		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * Insert a post with an invalid date, make sure it fails.
-	 *
-	 * @ticket 17180
-	 */
-	public function test_vb_insert_invalid_date() {
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => '2012-02-30 00:00:00',
-		);
-
-		// Test both return paths with or without WP_Error.
-		$insert_post = wp_insert_post( $post, true );
-		$this->assertWPError( $insert_post );
-		$this->assertSame( 'invalid_date', $insert_post->get_error_code() );
-
-		$insert_post = wp_insert_post( $post );
-		$this->assertSame( 0, $insert_post );
-	}
-
-	/**
-	 * Insert a future post, then edit and change it to private, and make sure cron gets it right.
-	 */
-	public function test_vb_insert_future_change_to_private() {
-		$future_date_1 = strtotime( '+1 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-
-		// Fetch the post and make sure has the correct date and status.
-		$out = get_post( $id );
-		$this->assertSame( 'future', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// Check that there's a publish_future_post job scheduled at the right time.
-		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-		// Now save it again with status set to draft.
-
-		$post['ID']          = $id;
-		$post['post_status'] = 'private';
-		wp_update_post( $post );
-
-		// Fetch the post again and make sure it has the new post_date.
-		$out = get_post( $id );
-		$this->assertSame( 'private', $out->post_status );
-		$this->assertSame( $post['post_date'], $out->post_date );
-
-		// And the correct date on the cron job.
-		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * @ticket 5305
-	 */
-	public function test_wp_insert_post_should_not_allow_a_bare_numeric_slug_that_might_conflict_with_a_date_archive_when_generating_from_an_empty_post_title() {
-		$this->set_permalink_structure( '/%postname%/' );
-
-		$p = wp_insert_post(
-			array(
-				'post_title'   => '',
-				'post_content' => 'test',
-				'post_status'  => 'publish',
-				'post_type'    => 'post',
-			)
-		);
-
-		$post = get_post( $p );
-
-		$this->set_permalink_structure();
-
-		$this->assertSame( "$p-2", $post->post_name );
-	}
-
-	/**
-	 * @ticket 5305
-	 * @ticket 33392
-	 */
-	public function test_wp_insert_post_should_invalidate_post_cache_before_generating_guid_when_post_name_is_empty_and_is_generated_from_the_post_ID() {
-		register_post_type( 'wptests_pt' );
-
-		$p = wp_insert_post(
-			array(
-				'post_title'  => '',
-				'post_type'   => 'wptests_pt',
-				'post_status' => 'publish',
-			)
-		);
-
-		$post = get_post( $p );
-
-		$this->assertStringContainsString( 'wptests_pt=' . $p, $post->guid );
-	}
-
-	/**
-	 * @ticket 20451
-	 */
-	public function test_wp_insert_post_with_meta_input() {
-		$post_id = wp_insert_post(
-			array(
-				'post_title'   => '',
-				'post_content' => 'test',
-				'post_status'  => 'publish',
-				'post_type'    => 'post',
-				'meta_input'   => array(
-					'hello' => 'world',
-					'foo'   => 'bar',
-				),
-			)
-		);
-
-		$this->assertSame( 'world', get_post_meta( $post_id, 'hello', true ) );
-		$this->assertSame( 'bar', get_post_meta( $post_id, 'foo', true ) );
-	}
-
-	/**
-	 * "When I delete a future post using wp_delete_post( $post->ID ) it does not update the cron correctly."
-	 *
-	 * @ticket 5364
-	 */
-	public function test_delete_future_post_cron() {
-		$future_date = strtotime( '+1 day' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
-			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-
-		// Check that there's a publish_future_post job scheduled at the right time.
-		$this->assertSame( $future_date, $this->next_schedule_for_post( 'publish_future_post', $id ) );
-
-		// Now delete the post and make sure the cron entry is removed.
-		wp_delete_post( $id );
-
-		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $id ) );
-	}
-
-	/**
-	 * Bug: permalink doesn't work if post title is empty.
-	 *
-	 * Might only fail if the post ID is greater than four characters.
-	 *
-	 * @ticket 5305
-	 */
-	public function test_permalink_without_title() {
-		$this->set_permalink_structure( '/%year%/%monthnum%/%day%/%postname%/' );
-
-		$post = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => '',
-			'post_date'    => '2007-10-31 06:15:00',
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id               = wp_insert_post( $post );
-		$this->post_ids[] = $id;
-
-		$plink = get_permalink( $id );
-
-		// Permalink should include the post ID at the end.
-		$this->assertSame( get_option( 'siteurl' ) . '/2007/10/31/' . $id . '/', $plink );
-	}
-
-	public function test_wp_publish_post() {
-		$draft_id = self::factory()->post->create( array( 'post_status' => 'draft' ) );
-
-		$post = get_post( $draft_id );
-		$this->assertSame( 'draft', $post->post_status );
-
-		wp_publish_post( $draft_id );
-		$post = get_post( $draft_id );
-
-		$this->assertSame( 'publish', $post->post_status );
-	}
-
-	/**
-	 * @ticket 22944
-	 */
-	public function test_wp_insert_post_and_wp_publish_post_with_future_date() {
-		$future_date = gmdate( 'Y-m-d H:i:s', time() + 10000000 );
-		$post_id     = self::factory()->post->create(
-			array(
-				'post_status' => 'publish',
-				'post_date'   => $future_date,
-			)
-		);
-
-		$post = get_post( $post_id );
-		$this->assertSame( 'future', $post->post_status );
-		$this->assertSame( $future_date, $post->post_date );
-
-		wp_publish_post( $post_id );
-		$post = get_post( $post_id );
-
-		$this->assertSame( 'publish', $post->post_status );
-		$this->assertSame( $future_date, $post->post_date );
-	}
-
-	/**
-	 * @ticket 48145
-	 */
-	public function test_wp_insert_post_should_default_to_publish_if_post_date_is_within_59_seconds_from_current_time() {
-		$future_date = gmdate( 'Y-m-d H:i:s', time() + 59 );
-		$post_id     = self::factory()->post->create(
-			array(
-				'post_date' => $future_date,
-			)
-		);
-
-		$post = get_post( $post_id );
-		$this->assertSame( 'publish', $post->post_status );
-		$this->assertSame( $future_date, $post->post_date );
-	}
-
-	/**
-	 * @ticket 22944
-	 */
-	public function test_publish_post_with_content_filtering() {
-		kses_remove_filters();
-
-		$post_id = wp_insert_post( array( 'post_title' => '<script>Test</script>' ) );
-		$post    = get_post( $post_id );
-		$this->assertSame( '<script>Test</script>', $post->post_title );
-		$this->assertSame( 'draft', $post->post_status );
-
-		kses_init_filters();
+	public function test_parse_post_content_single_page() {
+		global $multipage, $pages, $numpages;
 
-		wp_update_post(
+		$post_id = self::factory()->post->create(
 			array(
-				'ID'          => $post->ID,
-				'post_status' => 'publish',
+				'post_content' => 'Page 0',
 			)
 		);
-		$post = get_post( $post->ID );
-		$this->assertSame( 'Test', $post->post_title );
-
-		kses_remove_filters();
-	}
-
-	/**
-	 * @ticket 22944
-	 */
-	public function test_wp_publish_post_and_avoid_content_filtering() {
-		kses_remove_filters();
-
-		$post_id = wp_insert_post( array( 'post_title' => '<script>Test</script>' ) );
-		$post    = get_post( $post_id );
-		$this->assertSame( '<script>Test</script>', $post->post_title );
-		$this->assertSame( 'draft', $post->post_status );
-
-		kses_init_filters();
-
-		wp_publish_post( $post->ID );
-		$post = get_post( $post->ID );
-		$this->assertSame( '<script>Test</script>', $post->post_title );
-
-		kses_remove_filters();
-	}
-
-	/**
-	 * @ticket 23708
-	 */
-	public function test_get_post_ancestors_within_loop() {
-		global $post;
-		$parent_id = self::factory()->post->create();
-		$post      = self::factory()->post->create_and_get( array( 'post_parent' => $parent_id ) );
-		$this->assertSame( array( $parent_id ), get_post_ancestors( 0 ) );
-	}
-
-	/**
-	 * @ticket 23474
-	 */
-	public function test_update_invalid_post_id() {
-		$post_id = self::factory()->post->create( array( 'post_name' => 'get-page-uri-post-name' ) );
-		$post    = get_post( $post_id, ARRAY_A );
-
-		$post['ID'] = 123456789;
-
-		$this->assertSame( 0, wp_insert_post( $post ) );
-		$this->assertSame( 0, wp_update_post( $post ) );
-
-		$this->assertInstanceOf( 'WP_Error', wp_insert_post( $post, true ) );
-		$this->assertInstanceOf( 'WP_Error', wp_update_post( $post, true ) );
-
-	}
-
-	public function test_parse_post_content_single_page() {
-		global $multipage, $pages, $numpages;
-		$post_id = self::factory()->post->create( array( 'post_content' => 'Page 0' ) );
 		$post    = get_post( $post_id );
 		setup_postdata( $post );
+
 		$this->assertSame( 0, $multipage );
 		$this->assertCount( 1, $pages );
 		$this->assertSame( 1, $numpages );
@@ -715,9 +51,15 @@ class Tests_Post extends WP_UnitTestCase {
 
 	public function test_parse_post_content_multi_page() {
 		global $multipage, $pages, $numpages;
-		$post_id = self::factory()->post->create( array( 'post_content' => 'Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3' ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => 'Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3',
+			)
+		);
 		$post    = get_post( $post_id );
 		setup_postdata( $post );
+
 		$this->assertSame( 1, $multipage );
 		$this->assertCount( 4, $pages );
 		$this->assertSame( 4, $numpages );
@@ -726,9 +68,15 @@ class Tests_Post extends WP_UnitTestCase {
 
 	public function test_parse_post_content_remaining_single_page() {
 		global $multipage, $pages, $numpages;
-		$post_id = self::factory()->post->create( array( 'post_content' => 'Page 0' ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => 'Page 0',
+			)
+		);
 		$post    = get_post( $post_id );
 		setup_postdata( $post );
+
 		$this->assertSame( 0, $multipage );
 		$this->assertCount( 1, $pages );
 		$this->assertSame( 1, $numpages );
@@ -737,9 +85,15 @@ class Tests_Post extends WP_UnitTestCase {
 
 	public function test_parse_post_content_remaining_multi_page() {
 		global $multipage, $pages, $numpages;
-		$post_id = self::factory()->post->create( array( 'post_content' => 'Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3' ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => 'Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3',
+			)
+		);
 		$post    = get_post( $post_id );
 		setup_postdata( $post );
+
 		$this->assertSame( 1, $multipage );
 		$this->assertCount( 4, $pages );
 		$this->assertSame( 4, $numpages );
@@ -751,9 +105,15 @@ class Tests_Post extends WP_UnitTestCase {
 	 */
 	public function test_parse_post_content_starting_with_nextpage() {
 		global $multipage, $pages, $numpages;
-		$post_id = self::factory()->post->create( array( 'post_content' => '<!--nextpage-->Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3' ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => '<!--nextpage-->Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3',
+			)
+		);
 		$post    = get_post( $post_id );
 		setup_postdata( $post );
+
 		$this->assertSame( 1, $multipage );
 		$this->assertCount( 4, $pages );
 		$this->assertSame( 4, $numpages );
@@ -765,78 +125,60 @@ class Tests_Post extends WP_UnitTestCase {
 	 */
 	public function test_parse_post_content_starting_with_nextpage_multi() {
 		global $multipage, $pages, $numpages;
-		$post_id = self::factory()->post->create( array( 'post_content' => '<!--nextpage-->Page 0' ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => '<!--nextpage-->Page 0',
+			)
+		);
 		$post    = get_post( $post_id );
 		setup_postdata( $post );
+
 		$this->assertSame( 0, $multipage );
 		$this->assertCount( 1, $pages );
 		$this->assertSame( 1, $numpages );
 		$this->assertSame( array( 'Page 0' ), $pages );
 	}
 
-	/**
-	 * @ticket 19373
-	 */
-	public function test_insert_programmatic_sanitized() {
-		$this->unset_current_user();
-
-		register_taxonomy( 'test_tax', 'post' );
-
-		$title          = rand_str();
-		$post_data      = array(
-			'post_author'  => self::$editor_id,
-			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => $title,
-			'tax_input'    => array(
-				'test_tax' => array( 'term', 'term2', 'term3' ),
-			),
-		);
-		$insert_post_id = wp_insert_post( $post_data, true, true );
-		$this->assertIsInt( $insert_post_id );
-		$this->assertGreaterThan( 0, $insert_post_id );
-
-		$post = get_post( $insert_post_id );
-		$this->assertEquals( $post->post_author, self::$editor_id );
-		$this->assertSame( $post->post_title, $title );
-	}
-
 	/**
 	 * @ticket 24803
 	 */
 	public function test_wp_count_posts() {
 		$post_type = rand_str( 20 );
 		register_post_type( $post_type );
+
 		self::factory()->post->create(
 			array(
-				'post_type'   => $post_type,
-				'post_author' => self::$editor_id,
+				'post_type' => $post_type,
 			)
 		);
+
 		$count = wp_count_posts( $post_type, 'readable' );
 		$this->assertEquals( 1, $count->publish );
+
 		_unregister_post_type( $post_type );
-		$this->assertEquals( new stdClass, wp_count_posts( $post_type, 'readable' ) );
+		$count = wp_count_posts( $post_type, 'readable' );
+		$this->assertEquals( new stdClass, $count );
 	}
 
 	public function test_wp_count_posts_filtered() {
 		$post_type = rand_str( 20 );
 		register_post_type( $post_type );
+
 		self::factory()->post->create_many(
 			3,
 			array(
-				'post_type'   => $post_type,
-				'post_author' => self::$editor_id,
+				'post_type' => $post_type,
 			)
 		);
+
 		$count1 = wp_count_posts( $post_type, 'readable' );
 		$this->assertEquals( 3, $count1->publish );
-		add_filter( 'wp_count_posts', array( $this, 'filter_wp_count_posts' ) );
-
-		$count2 = wp_count_posts( $post_type, 'readable' );
-		$this->assertEquals( 2, $count2->publish );
 
+		add_filter( 'wp_count_posts', array( $this, 'filter_wp_count_posts' ) );
+		$count2 = wp_count_posts( $post_type, 'readable' );
 		remove_filter( 'wp_count_posts', array( $this, 'filter_wp_count_posts' ) );
+		$this->assertEquals( 2, $count2->publish );
 	}
 
 	public function filter_wp_count_posts( $counts ) {
@@ -848,10 +190,12 @@ class Tests_Post extends WP_UnitTestCase {
 		$post_ids       = self::factory()->post->create_many( 3 );
 		$initial_counts = wp_count_posts();
 
-		$key                  = array_rand( $post_ids );
-		$_post                = get_post( $post_ids[ $key ], ARRAY_A );
+		$key   = array_rand( $post_ids );
+		$_post = get_post( $post_ids[ $key ], ARRAY_A );
+
 		$_post['post_status'] = 'draft';
 		wp_insert_post( $_post );
+
 		$post = get_post( $post_ids[ $key ] );
 		$this->assertSame( 'draft', $post->post_status );
 		$this->assertNotEquals( 'publish', $post->post_status );
@@ -906,7 +250,9 @@ class Tests_Post extends WP_UnitTestCase {
 		register_taxonomy( $tax, $post_type );
 
 		$post = self::factory()->post->create( array( 'post_type' => $post_type ) );
-		wp_set_object_terms( $post, rand_str(), $tax );
+		wp_set_object_terms( $post, 'foo', $tax );
+
+		wp_set_current_user( self::$editor_id );
 
 		$wp_tag_cloud = wp_tag_cloud(
 			array(
@@ -956,6 +302,8 @@ class Tests_Post extends WP_UnitTestCase {
 			'post_excerpt' => 'foo&#x1f610;bat',
 		);
 
+		wp_set_current_user( self::$editor_id );
+
 		edit_post( $data );
 
 		$post = get_post( $post_id );
@@ -966,641 +314,161 @@ class Tests_Post extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @ticket 31168
-	 */
-	public function test_wp_insert_post_default_comment_ping_status_open() {
-		$post_id = self::factory()->post->create(
-			array(
-				'post_author'  => self::$editor_id,
-				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
-			)
-		);
-		$post    = get_post( $post_id );
-
-		$this->assertSame( 'open', $post->comment_status );
-		$this->assertSame( 'open', $post->ping_status );
-	}
-
-	/**
-	 * @ticket 31168
-	 */
-	public function test_wp_insert_post_page_default_comment_ping_status_closed() {
-		$post_id = self::factory()->post->create(
-			array(
-				'post_author'  => self::$editor_id,
-				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
-				'post_type'    => 'page',
-			)
-		);
-		$post    = get_post( $post_id );
-
-		$this->assertSame( 'closed', $post->comment_status );
-		$this->assertSame( 'closed', $post->ping_status );
-	}
-
-	/**
-	 * @ticket 31168
-	 */
-	public function test_wp_insert_post_cpt_default_comment_ping_status_open() {
-		$post_type = rand_str( 20 );
-		register_post_type( $post_type, array( 'supports' => array( 'comments', 'trackbacks' ) ) );
-		$post_id = self::factory()->post->create(
-			array(
-				'post_author'  => self::$editor_id,
-				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
-				'post_type'    => $post_type,
-			)
-		);
-		$post    = get_post( $post_id );
-
-		$this->assertSame( 'open', $post->comment_status );
-		$this->assertSame( 'open', $post->ping_status );
-		_unregister_post_type( $post_type );
-	}
-
-	/**
-	 * @ticket 31168
-	 */
-	public function test_wp_insert_post_cpt_default_comment_ping_status_closed() {
-		$post_type = rand_str( 20 );
-		register_post_type( $post_type );
-		$post_id = self::factory()->post->create(
-			array(
-				'post_author'  => self::$editor_id,
-				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
-				'post_type'    => $post_type,
-			)
-		);
-		$post    = get_post( $post_id );
-
-		$this->assertSame( 'closed', $post->comment_status );
-		$this->assertSame( 'closed', $post->ping_status );
-		_unregister_post_type( $post_type );
-	}
-
-	/**
-	 * If a post is sticky and is updated by a user that does not have the publish_post capability,
-	 * it should _stay_ sticky.
-	 *
-	 * @ticket 24153
-	 */
-	public function test_user_without_publish_cannot_affect_sticky() {
-		wp_set_current_user( self::$grammarian_id );
-
-		// Sanity check.
-		$this->assertFalse( current_user_can( 'publish_posts' ) );
-		$this->assertTrue( current_user_can( 'edit_others_posts' ) );
-		$this->assertTrue( current_user_can( 'edit_published_posts' ) );
-
-		// Create a sticky post.
-		$post = self::factory()->post->create_and_get(
-			array(
-				'post_title'   => 'Will be changed',
-				'post_content' => 'Will be changed',
-			)
-		);
-		stick_post( $post->ID );
-
-		// Sanity check.
-		$this->assertTrue( is_sticky( $post->ID ) );
-
-		// Edit the post.
-		$post->post_title   = 'Updated';
-		$post->post_content = 'Updated';
-		wp_update_post( $post );
-
-		// Make sure it's still sticky.
-		$saved_post = get_post( $post->ID );
-		$this->assertTrue( is_sticky( $saved_post->ID ) );
-		$this->assertSame( 'Updated', $saved_post->post_title );
-		$this->assertSame( 'Updated', $saved_post->post_content );
-	}
-
-	/**
-	 * If the `edit_post()` method is invoked by a user without publish_posts permission,
-	 * the sticky status of the post should not be changed.
-	 *
-	 * @ticket 24153
-	 */
-	public function test_user_without_publish_cannot_affect_sticky_with_edit_post() {
-		// Create a sticky post.
-		$post = self::factory()->post->create_and_get(
-			array(
-				'post_title'   => 'Will be changed',
-				'post_content' => 'Will be changed',
-			)
-		);
-		stick_post( $post->ID );
-
-		// Sanity check.
-		$this->assertTrue( is_sticky( $post->ID ) );
-
-		wp_set_current_user( self::$grammarian_id );
-
-		// Sanity check.
-		$this->assertFalse( current_user_can( 'publish_posts' ) );
-		$this->assertTrue( current_user_can( 'edit_others_posts' ) );
-		$this->assertTrue( current_user_can( 'edit_published_posts' ) );
-
-		// Edit the post - the key 'sticky' is intentionally unset.
-		$data = array(
-			'post_ID'      => $post->ID,
-			'post_title'   => 'Updated',
-			'post_content' => 'Updated',
-		);
-		edit_post( $data );
-
-		// Make sure it's still sticky.
-		$saved_post = get_post( $post->ID );
-		$this->assertTrue( is_sticky( $saved_post->ID ) );
-		$this->assertSame( 'Updated', $saved_post->post_title );
-		$this->assertSame( 'Updated', $saved_post->post_content );
-	}
-
-	/**
-	 * Test that hooks are fired when post gets stuck and unstuck.
-	 *
-	 * @ticket 35600
-	 */
-	public function test_hooks_fire_when_post_gets_stuck_and_unstuck() {
-		$post_id = self::factory()->post->create();
-		$a1      = new MockAction();
-		$a2      = new MockAction();
-
-		$this->assertFalse( is_sticky( $post_id ) );
-
-		add_action( 'post_stuck', array( $a1, 'action' ) );
-		add_action( 'post_unstuck', array( $a2, 'action' ) );
-
-		stick_post( $post_id );
-		$this->assertTrue( is_sticky( $post_id ) );
-		unstick_post( $post_id );
-		$this->assertFalse( is_sticky( $post_id ) );
-
-		remove_action( 'post_stuck', array( $a1, 'action' ) );
-		remove_action( 'post_unstuck', array( $a2, 'action' ) );
-
-		$this->assertSame( 1, $a1->get_call_count() );
-		$this->assertSame( 1, $a2->get_call_count() );
-	}
-
-	/**
-	 * If a post is updated without providing a post_name param,
-	 * a new slug should not be generated.
-	 *
-	 * @ticket 34865
-	 */
-	public function test_post_updates_without_slug_provided() {
-		$post_id = self::factory()->post->create(
-			array(
-				'post_title'  => 'Stuff',
-				'post_status' => 'publish',
-			)
-		);
-
-		$data = array(
-			'ID'         => $post_id,
-			'post_title' => 'Stuff and Things',
-		);
-
-		wp_insert_post( $data );
-
-		$updated_post = get_post( $post_id );
-		// Ensure changing the post_title didn't modify the post_name.
-		$this->assertSame( 'stuff', $updated_post->post_name );
-	}
-
-	/**
-	 * @ticket 32585
-	 */
-	public function test_wp_insert_post_author_zero() {
-		$post_id = self::factory()->post->create( array( 'post_author' => 0 ) );
-
-		$this->assertEquals( 0, get_post( $post_id )->post_author );
-	}
-
-	/**
-	 * @ticket 32585
-	 */
-	public function test_wp_insert_post_author_null() {
-		$post_id = self::factory()->post->create( array( 'post_author' => null ) );
-
-		$this->assertEquals( self::$editor_id, get_post( $post_id )->post_author );
-	}
-
-	/**
-	 * @ticket 15946
-	 */
-	public function test_wp_insert_post_should_respect_post_date_gmt() {
-		$post = array(
-			'post_author'   => self::$editor_id,
-			'post_status'   => 'publish',
-			'post_content'  => rand_str(),
-			'post_title'    => rand_str(),
-			'post_date_gmt' => '2014-01-01 12:00:00',
-		);
-
-		// Insert a post and make sure the ID is OK.
-		$id = wp_insert_post( $post );
-
-		$out = get_post( $id );
-
-		$this->assertSame( $post['post_content'], $out->post_content );
-		$this->assertSame( $post['post_title'], $out->post_title );
-		$this->assertEquals( $post['post_author'], $out->post_author );
-		$this->assertSame( get_date_from_gmt( $post['post_date_gmt'] ), $out->post_date );
-		$this->assertSame( $post['post_date_gmt'], $out->post_date_gmt );
-	}
-
-	public function test_wp_delete_post_reassign_hierarchical_post_type() {
-		$grandparent_page_id = self::factory()->post->create( array( 'post_type' => 'page' ) );
-		$parent_page_id      = self::factory()->post->create(
-			array(
-				'post_type'   => 'page',
-				'post_parent' => $grandparent_page_id,
-			)
-		);
-		$page_id             = self::factory()->post->create(
-			array(
-				'post_type'   => 'page',
-				'post_parent' => $parent_page_id,
-			)
-		);
-		$this->assertSame( $parent_page_id, get_post( $page_id )->post_parent );
-		wp_delete_post( $parent_page_id, true );
-		$this->assertSame( $grandparent_page_id, get_post( $page_id )->post_parent );
-		wp_delete_post( $grandparent_page_id, true );
-		$this->assertSame( 0, get_post( $page_id )->post_parent );
-	}
-
-	/**
-	 * Test ensuring that the post_name (UUID) is preserved when wp_insert_post()/wp_update_post() is called.
-	 *
-	 * @see _wp_customize_changeset_filter_insert_post_data()
-	 * @ticket 30937
-	 */
-	public function test_wp_insert_post_for_customize_changeset_should_not_drop_post_name() {
-
-		$this->assertSame( 10, has_filter( 'wp_insert_post_data', '_wp_customize_changeset_filter_insert_post_data' ) );
-
-		$changeset_data = array(
-			'blogname' => array(
-				'value' => 'Hello World',
-			),
-		);
-
-		wp_set_current_user( $this->factory()->user->create( array( 'role' => 'contributor' ) ) );
-
-		$uuid    = wp_generate_uuid4();
-		$post_id = wp_insert_post(
-			array(
-				'post_type'    => 'customize_changeset',
-				'post_name'    => strtoupper( $uuid ),
-				'post_content' => wp_json_encode( $changeset_data ),
-			)
-		);
-		$this->assertSame( $uuid, get_post( $post_id )->post_name, 'Expected lower-case UUID4 to be inserted.' );
-		$this->assertSame( $changeset_data, json_decode( get_post( $post_id )->post_content, true ) );
-
-		$changeset_data['blogname']['value'] = 'Hola Mundo';
-		wp_update_post(
-			array(
-				'ID'           => $post_id,
-				'post_status'  => 'draft',
-				'post_content' => wp_json_encode( $changeset_data ),
-			)
-		);
-		$this->assertSame( $uuid, get_post( $post_id )->post_name, 'Expected post_name to not have been dropped for drafts.' );
-		$this->assertSame( $changeset_data, json_decode( get_post( $post_id )->post_content, true ) );
-
-		$changeset_data['blogname']['value'] = 'Hallo Welt';
-		wp_update_post(
-			array(
-				'ID'           => $post_id,
-				'post_status'  => 'pending',
-				'post_content' => wp_json_encode( $changeset_data ),
-			)
-		);
-		$this->assertSame( $uuid, get_post( $post_id )->post_name, 'Expected post_name to not have been dropped for pending.' );
-		$this->assertSame( $changeset_data, json_decode( get_post( $post_id )->post_content, true ) );
-	}
-
-	/**
-	 * Test ensuring that the post_slug can be filtered with a custom value short circuiting the built in
-	 * function that tries to create a unique name based on the post name.
-	 *
-	 * @see wp_unique_post_slug()
-	 * @ticket 21112
-	 */
-	public function test_pre_wp_unique_post_slug_filter() {
-		add_filter( 'pre_wp_unique_post_slug', array( $this, 'filter_pre_wp_unique_post_slug' ), 10, 6 );
-
-		$post_id = $this->factory->post->create(
-			array(
-				'title'       => 'An example',
-				'post_status' => 'publish',
-				'post_type'   => 'page',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( 'override-slug-' . $post->post_type, $post->post_name );
-
-		remove_filter( 'pre_wp_unique_post_slug', array( $this, 'filter_pre_wp_unique_post_slug' ), 10, 6 );
-	}
-
-	public function filter_pre_wp_unique_post_slug( $default, $slug, $post_ID, $post_status, $post_type, $post_parent ) {
-		return 'override-slug-' . $post_type;
-	}
-
-	/**
-	 * @ticket 48113
+	 * If a sticky post is updated via `wp_update_post()` by a user
+	 * without the `publish_posts` capability, it should stay sticky.
+	 *
+	 * @ticket 24153
 	 */
-	public function test_insert_post_should_respect_date_floating_post_status_arg() {
-		register_post_status( 'floating', array( 'date_floating' => true ) );
-
-		$post_id = self::factory()->post->create(
+	public function test_user_without_publish_posts_cannot_affect_sticky() {
+		// Create a sticky post.
+		$post = self::factory()->post->create_and_get(
 			array(
-				'post_status'   => 'floating',
-				'post_date'     => null,
-				'post_date_gmt' => null,
+				'post_title'   => 'Will be changed',
+				'post_content' => 'Will be changed',
 			)
 		);
+		stick_post( $post->ID );
 
-		$post = get_post( $post_id );
-		self::assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
-	}
+		// Sanity check.
+		$this->assertTrue( is_sticky( $post->ID ) );
 
-	/**
-	 * @ticket 48113
-	 */
-	public function test_insert_post_should_respect_date_floating_post_status_arg_not_set() {
-		register_post_status( 'not-floating', array( 'date_floating' => false ) );
+		wp_set_current_user( self::$grammarian_id );
 
-		$post_id = self::factory()->post->create(
-			array(
-				'post_status'   => 'floating',
-				'post_date'     => null,
-				'post_date_gmt' => null,
-			)
-		);
+		// Sanity check.
+		$this->assertFalse( current_user_can( 'publish_posts' ) );
+		$this->assertTrue( current_user_can( 'edit_others_posts' ) );
+		$this->assertTrue( current_user_can( 'edit_published_posts' ) );
 
-		$post = get_post( $post_id );
-		self::assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date_gmt ), 2, 'The dates should be equal' );
+		// Edit the post.
+		$post->post_title   = 'Updated';
+		$post->post_content = 'Updated';
+		wp_update_post( $post );
+
+		// Make sure it's still sticky.
+		$saved_post = get_post( $post->ID );
+		$this->assertTrue( is_sticky( $saved_post->ID ) );
+		$this->assertSame( 'Updated', $saved_post->post_title );
+		$this->assertSame( 'Updated', $saved_post->post_content );
 	}
 
 	/**
-	 * Test ensuring that wp_update_post() does not unintentionally modify post tags
-	 * if the post has several tags with the same name but different slugs.
-	 *
-	 * Tags should only be modified if 'tags_input' parameter was explicitly provided,
-	 * and is different from the existing tags.
+	 * If a sticky post is updated via `edit_post()` by a user
+	 * without the `publish_posts` capability, it should stay sticky.
 	 *
-	 * @ticket 45121
+	 * @ticket 24153
 	 */
-	public function test_update_post_should_only_modify_post_tags_if_different_tags_input_was_provided() {
-		$tag_1 = wp_insert_term( 'wp_update_post_tag', 'post_tag', array( 'slug' => 'wp_update_post_tag_1' ) );
-		$tag_2 = wp_insert_term( 'wp_update_post_tag', 'post_tag', array( 'slug' => 'wp_update_post_tag_2' ) );
-		$tag_3 = wp_insert_term( 'wp_update_post_tag', 'post_tag', array( 'slug' => 'wp_update_post_tag_3' ) );
-
-		$post_id = self::factory()->post->create(
+	public function test_user_without_publish_posts_cannot_affect_sticky_with_edit_post() {
+		// Create a sticky post.
+		$post = self::factory()->post->create_and_get(
 			array(
-				'tags_input' => array( $tag_1['term_id'], $tag_2['term_id'] ),
+				'post_title'   => 'Will be changed',
+				'post_content' => 'Will be changed',
 			)
 		);
+		stick_post( $post->ID );
 
-		$post = get_post( $post_id );
-
-		$tags = wp_get_post_tags( $post->ID, array( 'fields' => 'ids' ) );
-		$this->assertSameSets( array( $tag_1['term_id'], $tag_2['term_id'] ), $tags );
+		// Sanity check.
+		$this->assertTrue( is_sticky( $post->ID ) );
 
-		wp_update_post( $post );
+		wp_set_current_user( self::$grammarian_id );
 
-		$tags = wp_get_post_tags( $post->ID, array( 'fields' => 'ids' ) );
-		$this->assertSameSets( array( $tag_1['term_id'], $tag_2['term_id'] ), $tags );
+		// Sanity check.
+		$this->assertFalse( current_user_can( 'publish_posts' ) );
+		$this->assertTrue( current_user_can( 'edit_others_posts' ) );
+		$this->assertTrue( current_user_can( 'edit_published_posts' ) );
 
-		wp_update_post(
-			array(
-				'ID'         => $post->ID,
-				'tags_input' => array( $tag_2['term_id'], $tag_3['term_id'] ),
-			)
+		// Edit the post - the key 'sticky' is intentionally unset.
+		$data = array(
+			'post_ID'      => $post->ID,
+			'post_title'   => 'Updated',
+			'post_content' => 'Updated',
 		);
+		edit_post( $data );
 
-		$tags = wp_get_post_tags( $post->ID, array( 'fields' => 'ids' ) );
-		$this->assertSameSets( array( $tag_2['term_id'], $tag_3['term_id'] ), $tags );
+		// Make sure it's still sticky.
+		$saved_post = get_post( $post->ID );
+		$this->assertTrue( is_sticky( $saved_post->ID ) );
+		$this->assertSame( 'Updated', $saved_post->post_title );
+		$this->assertSame( 'Updated', $saved_post->post_content );
 	}
 
 	/**
-	 * @ticket 52187
+	 * Test that hooks are fired when post gets stuck and unstuck.
+	 *
+	 * @ticket 35600
 	 */
-	public function test_insert_empty_post_date() {
-		$post_date_gmt = '2020-12-29 10:11:45';
-		$invalid_date  = '2020-12-41 14:15:27';
+	public function test_hooks_fire_when_post_gets_stuck_and_unstuck() {
+		$post_id = self::factory()->post->create();
+		$a1      = new MockAction();
+		$a2      = new MockAction();
 
-		// Empty post_date_gmt with floating status
-		$post_id = self::factory()->post->create(
-			array(
-				'post_status' => 'draft',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
-		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+		$this->assertFalse( is_sticky( $post_id ) );
 
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date_gmt' => '0000-00-00 00:00:00',
-				'post_status'   => 'draft',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
-		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+		add_action( 'post_stuck', array( $a1, 'action' ) );
+		add_action( 'post_unstuck', array( $a2, 'action' ) );
 
-		// Empty post_date_gmt without floating status
-		$post_id = self::factory()->post->create(
-			array(
-				'post_status' => 'publish',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( get_gmt_from_date( $post->post_date ) ), 2, 'The dates should be equal' );
+		stick_post( $post_id );
+		$this->assertTrue( is_sticky( $post_id ) );
 
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date_gmt' => '0000-00-00 00:00:00',
-				'post_status'   => 'publish',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date ), 2, 'The dates should be equal' );
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( get_gmt_from_date( $post->post_date ) ), 2, 'The dates should be equal' );
+		unstick_post( $post_id );
+		$this->assertFalse( is_sticky( $post_id ) );
 
-		// Valid post_date_gmt
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date_gmt' => $post_date_gmt,
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( get_date_from_gmt( $post_date_gmt ), $post->post_date );
-		$this->assertSame( $post_date_gmt, $post->post_date_gmt );
+		remove_action( 'post_stuck', array( $a1, 'action' ) );
+		remove_action( 'post_unstuck', array( $a2, 'action' ) );
 
-		// Invalid post_date_gmt
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date_gmt' => $invalid_date,
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( '1970-01-01 00:00:00', $post->post_date );
-		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+		$this->assertSame( 1, $a1->get_call_count() );
+		$this->assertSame( 1, $a2->get_call_count() );
 	}
 
-	/**
-	 * @ticket 52187
-	 */
-	public function test_insert_valid_post_date() {
-		$post_date     = '2020-12-28 11:26:35';
-		$post_date_gmt = '2020-12-29 10:11:45';
-		$invalid_date  = '2020-12-41 14:15:27';
-
-		// Empty post_date_gmt with floating status
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'   => $post_date,
-				'post_status' => 'draft',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( $post_date, $post->post_date );
-		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
-
-		$post_id = self::factory()->post->create(
+	public function test_wp_delete_post_reassign_hierarchical_post_type() {
+		$grandparent_page_id = self::factory()->post->create( array( 'post_type' => 'page' ) );
+		$parent_page_id      = self::factory()->post->create(
 			array(
-				'post_date'     => $post_date,
-				'post_date_gmt' => '0000-00-00 00:00:00',
-				'post_status'   => 'draft',
+				'post_type'   => 'page',
+				'post_parent' => $grandparent_page_id,
 			)
 		);
-		$post    = get_post( $post_id );
-		$this->assertSame( $post_date, $post->post_date );
-		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
-
-		// Empty post_date_gmt without floating status
-		$post_id = self::factory()->post->create(
+		$page_id             = self::factory()->post->create(
 			array(
-				'post_date'   => $post_date,
-				'post_status' => 'publish',
+				'post_type'   => 'page',
+				'post_parent' => $parent_page_id,
 			)
 		);
-		$post    = get_post( $post_id );
-		$this->assertSame( $post_date, $post->post_date );
-		$this->assertSame( get_gmt_from_date( $post_date ), $post->post_date_gmt );
 
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $post_date,
-				'post_date_gmt' => '0000-00-00 00:00:00',
-				'post_status'   => 'publish',
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( $post_date, $post->post_date );
-		$this->assertSame( get_gmt_from_date( $post_date ), $post->post_date_gmt );
+		$this->assertSame( $parent_page_id, get_post( $page_id )->post_parent );
 
-		// Valid post_date_gmt
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $post_date,
-				'post_date_gmt' => $post_date_gmt,
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( $post_date, $post->post_date );
-		$this->assertSame( $post_date_gmt, $post->post_date_gmt );
+		wp_delete_post( $parent_page_id, true );
+		$this->assertSame( $grandparent_page_id, get_post( $page_id )->post_parent );
 
-		// Invalid post_date_gmt
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $post_date,
-				'post_date_gmt' => $invalid_date,
-			)
-		);
-		$post    = get_post( $post_id );
-		$this->assertSame( $post_date, $post->post_date );
-		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+		wp_delete_post( $grandparent_page_id, true );
+		$this->assertSame( 0, get_post( $page_id )->post_parent );
 	}
 
 	/**
-	 * @ticket 52187
+	 * Test ensuring that the post_slug can be filtered with a custom value short circuiting the built in
+	 * function that tries to create a unique name based on the post name.
+	 *
+	 * @see wp_unique_post_slug()
+	 * @ticket 21112
 	 */
-	public function test_insert_invalid_post_date() {
-		$post_date     = '2020-12-28 11:26:35';
-		$post_date_gmt = '2020-12-29 10:11:45';
-		$invalid_date  = '2020-12-41 14:15:27';
-
-		// Empty post_date_gmt with floating status
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'   => $invalid_date,
-				'post_status' => 'draft',
-			)
-		);
-		$this->assertSame( 0, $post_id );
-
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $invalid_date,
-				'post_date_gmt' => '0000-00-00 00:00:00',
-				'post_status'   => 'draft',
-			)
-		);
-		$this->assertSame( 0, $post_id );
+	public function test_pre_wp_unique_post_slug_filter() {
+		add_filter( 'pre_wp_unique_post_slug', array( $this, 'filter_pre_wp_unique_post_slug' ), 10, 6 );
 
-		// Empty post_date_gmt without floating status
 		$post_id = self::factory()->post->create(
 			array(
-				'post_date'   => $invalid_date,
+				'title'       => 'An example',
 				'post_status' => 'publish',
+				'post_type'   => 'page',
 			)
 		);
-		$this->assertSame( 0, $post_id );
-
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $invalid_date,
-				'post_date_gmt' => '0000-00-00 00:00:00',
-				'post_status'   => 'publish',
-			)
-		);
-		$this->assertSame( 0, $post_id );
+		$post    = get_post( $post_id );
+		$this->assertSame( 'override-slug-' . $post->post_type, $post->post_name );
 
-		// Valid post_date_gmt
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $invalid_date,
-				'post_date_gmt' => $post_date_gmt,
-			)
-		);
-		$this->assertSame( 0, $post_id );
+		remove_filter( 'pre_wp_unique_post_slug', array( $this, 'filter_pre_wp_unique_post_slug' ), 10, 6 );
+	}
 
-		// Invalid post_date_gmt
-		$post_id = self::factory()->post->create(
-			array(
-				'post_date'     => $invalid_date,
-				'post_date_gmt' => $invalid_date,
-			)
-		);
-		$this->assertSame( 0, $post_id );
+	public function filter_pre_wp_unique_post_slug( $default, $slug, $post_ID, $post_status, $post_type, $post_parent ) {
+		return 'override-slug-' . $post_type;
 	}
 
 	/**
@@ -1612,7 +480,12 @@ class Tests_Post extends WP_UnitTestCase {
 		$invalid_date  = '2020-12-41 14:15:27';
 
 		$resolved_post_date = wp_resolve_post_date();
-		$this->assertEqualsWithDelta( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $resolved_post_date ), 2, 'The dates should be equal' );
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( $resolved_post_date ),
+			2,
+			'The dates should be equal'
+		);
 
 		$resolved_post_date = wp_resolve_post_date( '', $post_date_gmt );
 		$this->assertSame( get_date_from_gmt( $post_date_gmt ), $resolved_post_date );
@@ -1685,6 +558,53 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Ensures sticking a post succeeds after deleting the 'sticky_posts' option.
+	 *
+	 * @ticket 52007
+	 * @ticket 55176
+	 * @covers ::stick_post
+	 */
+	public function test_stick_post_after_delete_sticky_posts_option() {
+		delete_option( 'sticky_posts' );
+
+		stick_post( 1 );
+		$this->assertSameSets( array( 1 ), get_option( 'sticky_posts' ) );
+	}
+
+	/**
+	 * Ensures sticking works with an unexpected option value.
+	 *
+	 * @ticket 52007
+	 * @ticket 55176
+	 * @covers ::stick_post
+	 * @dataProvider data_stick_post_with_unexpected_sticky_posts_option
+	 *
+	 * @param mixed $starting_option Starting value for sticky_posts option.
+	 */
+	public function test_stick_post_with_unexpected_sticky_posts_option( $starting_option ) {
+		update_option( 'sticky_posts', $starting_option );
+
+		stick_post( 1 );
+		$this->assertSameSets( array( 1 ), get_option( 'sticky_posts' ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_stick_post_with_unexpected_sticky_posts_option() {
+		return array(
+			'false'     => array( false ),
+			'a string'  => array( 'string' ),
+			'1 int'     => array( 1 ),
+			'null'      => array( null ),
+			'true'      => array( true ),
+			'an object' => array( new stdClass ),
+		);
+	}
+
 	/**
 	 * Ensure sticking a post removes other duplicate post IDs from the option.
 	 *
@@ -1797,4 +717,43 @@ class Tests_Post extends WP_UnitTestCase {
 		unstick_post( 3 );
 		$this->assertSameSets( array( 1, 2, 2 ), get_option( 'sticky_posts' ) );
 	}
+
+	/**
+	 * Check if post supports block editor.
+	 *
+	 * @ticket 51819
+	 * @covers ::use_block_editor_for_post
+	 */
+	public function test_use_block_editor_for_post() {
+		$this->assertFalse( use_block_editor_for_post( -1 ) );
+		$bogus_post_id = self::factory()->post->create(
+			array(
+				'post_type' => 'bogus',
+			)
+		);
+		$this->assertFalse( use_block_editor_for_post( $bogus_post_id ) );
+
+		register_post_type(
+			'restless',
+			array(
+				'show_in_rest' => false,
+			)
+		);
+		$restless_post_id = self::factory()->post->create(
+			array(
+				'post_type' => 'restless',
+			)
+		);
+		$this->assertFalse( use_block_editor_for_post( $restless_post_id ) );
+
+		$generic_post_id = self::factory()->post->create();
+
+		add_filter( 'use_block_editor_for_post', '__return_false' );
+		$this->assertFalse( use_block_editor_for_post( $generic_post_id ) );
+		remove_filter( 'use_block_editor_for_post', '__return_false' );
+
+		add_filter( 'use_block_editor_for_post', '__return_true' );
+		$this->assertTrue( use_block_editor_for_post( $restless_post_id ) );
+		remove_filter( 'use_block_editor_for_post', '__return_true' );
+	}
 }
diff --git a/tests/post/attachments.php b/tests/post/attachments.php
index 86b24cfd32..1bbc0c6f79 100644
--- a/tests/post/attachments.php
+++ b/tests/post/attachments.php
@@ -6,10 +6,19 @@
  * @group upload
  */
 class Tests_Post_Attachments extends WP_UnitTestCase {
+	/**
+	 * Set up the test fixture.
+	 */
+	public function set_up() {
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+
+		parent::set_up();
+	}
 
 	public function tear_down() {
 		// Remove all uploads.
 		$this->remove_added_uploads();
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
 		parent::tear_down();
 	}
 
@@ -272,8 +281,8 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 
 		$post_id = wp_insert_post(
 			array(
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
+				'post_content' => 'content',
+				'post_title'   => 'title',
 			)
 		);
 
diff --git a/tests/post/getAttachedFile.php b/tests/post/getAttachedFile.php
new file mode 100644
index 0000000000..09501b6c18
--- /dev/null
+++ b/tests/post/getAttachedFile.php
@@ -0,0 +1,67 @@
+<?php
+
+/**
+ * @group post
+ * @covers ::get_attached_file
+ */
+class Tests_Post_GetAttachedFile extends WP_UnitTestCase {
+	/**
+	 * Post
+	 *
+	 * @var WP_Post
+	 */
+	protected static $post;
+
+	/**
+	 * Create shared fixtures.
+	 */
+	public static function set_up_before_class() {
+		self::$post = self::factory()->post->create_and_get(
+			array(
+				'post_title' => 'example-page',
+				'post_type'  => 'post',
+			)
+		);
+	}
+
+	/**
+	 * @ticket 36308
+	 *
+	 * @dataProvider data_get_attached_file_with_windows_paths
+	 *
+	 * @param string $file     The file path to attach to the post.
+	 * @param string $expected The expected attached file path.
+	 * @param string $message  The message when an assertion fails.
+	 */
+	public function test_get_attached_file_with_windows_paths( $file, $expected, $message ) {
+		$attachment = self::factory()->attachment->create_and_get(
+			array(
+				'post_parent' => self::$post->ID,
+				'file'        => $file,
+			)
+		);
+
+		$this->assertSame( $expected, get_attached_file( $attachment->ID ), $message );
+	}
+
+	/**
+	 * Data provider with Windows paths.
+	 *
+	 * @return array
+	 */
+	public function data_get_attached_file_with_windows_paths() {
+		return array(
+			'a local path'         => array(
+				'file'     => 'C:/WWW/Sites/demo/htdocs/wordpress/wp-content/uploads/2016/03/example.jpg',
+				'expected' => 'C:/WWW/Sites/demo/htdocs/wordpress/wp-content/uploads/2016/03/example.jpg',
+				'message'  => 'Windows local filesystem paths should be equal',
+			),
+			'a network share path' => array(
+				'file'     => '//ComputerName/ShareName/SubfolderName/example.txt',
+				'expected' => '//ComputerName/ShareName/SubfolderName/example.txt',
+				'message'  => 'Network share paths should be equal',
+			),
+		);
+	}
+
+}
diff --git a/tests/post/isPostPubliclyViewable.php b/tests/post/isPostPubliclyViewable.php
index cd3b341c19..094d5eb408 100644
--- a/tests/post/isPostPubliclyViewable.php
+++ b/tests/post/isPostPubliclyViewable.php
@@ -54,7 +54,7 @@ class Tests_Post_IsPostPubliclyViewable extends WP_UnitTestCase {
 			$date = date_format( date_create( '+1 year' ), 'Y-m-d H:i:s' );
 		}
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_type'   => $post_type,
 				'post_status' => $post_status,
diff --git a/tests/post/meta.php b/tests/post/meta.php
index 37c07d84e8..ad391e741f 100644
--- a/tests/post/meta.php
+++ b/tests/post/meta.php
@@ -23,8 +23,8 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 			array(
 				'post_author'  => self::$author->ID,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
+				'post_content' => 'content',
+				'post_title'   => 'title',
 			)
 		);
 
@@ -32,8 +32,8 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 			array(
 				'post_author'  => self::$author->ID,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
+				'post_content' => 'content',
+				'post_title'   => 'title',
 			)
 		);
 	}
diff --git a/tests/post/nav-menu.php b/tests/post/nav-menu.php
index 36c7785f6e..d20c9a5a86 100644
--- a/tests/post/nav-menu.php
+++ b/tests/post/nav-menu.php
@@ -12,7 +12,7 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
-		$this->menu_id = wp_create_nav_menu( rand_str() );
+		$this->menu_id = wp_create_nav_menu( 'foo' );
 	}
 
 	/**
@@ -202,6 +202,69 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		$this->assertEquals( $t, $menu_items[0]->object_id );
 	}
 
+	/**
+	 * @ticket 55620
+	 * @covers ::update_menu_item_cache
+	 */
+	public function test_update_menu_item_cache_primes_posts() {
+		$post_id = self::factory()->post->create();
+		wp_update_nav_menu_item(
+			$this->menu_id,
+			0,
+			array(
+				'menu-item-type'      => 'post_type',
+				'menu-item-object'    => 'post',
+				'menu-item-object-id' => $post_id,
+				'menu-item-status'    => 'publish',
+			)
+		);
+
+		$posts_query  = new WP_Query();
+		$query_result = $posts_query->query( array( 'post_type' => 'nav_menu_item' ) );
+
+		wp_cache_delete( $post_id, 'posts' );
+		$action = new MockAction();
+		add_filter( 'update_post_metadata_cache', array( $action, 'filter' ), 10, 2 );
+
+		update_menu_item_cache( $query_result );
+
+		$args = $action->get_args();
+		$last = end( $args );
+		$this->assertSameSets( array( $post_id ), $last[1], '_prime_post_caches() was not executed.' );
+	}
+
+	/**
+	 * @ticket 55620
+	 * @covers ::update_menu_item_cache
+	 */
+	public function test_update_menu_item_cache_primes_terms() {
+		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
+		$term_id = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
+		wp_update_nav_menu_item(
+			$this->menu_id,
+			0,
+			array(
+				'menu-item-type'      => 'taxonomy',
+				'menu-item-object'    => 'wptests_tax',
+				'menu-item-object-id' => $term_id,
+				'menu-item-status'    => 'publish',
+			)
+		);
+
+		$posts_query  = new WP_Query();
+		$query_result = $posts_query->query( array( 'post_type' => 'nav_menu_item' ) );
+
+		wp_cache_delete( $term_id, 'terms' );
+		$action = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $action, 'filter' ), 10, 2 );
+
+		update_menu_item_cache( $query_result );
+
+		$args = $action->get_args();
+		$last = end( $args );
+		$this->assertSameSets( array( $term_id ), $last[1], '_prime_term_caches() was not executed.' );
+	}
+
 	/**
 	 * @ticket 13910
 	 */
@@ -255,8 +318,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public function test_wp_setup_nav_menu_item_for_post_type_archive() {
 
-		$post_type_slug        = rand_str( 12 );
-		$post_type_description = rand_str();
+		$post_type_slug        = 'fooo-bar-baz';
+		$post_type_description = 'foo';
 		register_post_type(
 			$post_type_slug,
 			array(
@@ -288,7 +351,7 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public function test_wp_setup_nav_menu_item_for_post_type_archive_no_description() {
 
-		$post_type_slug        = rand_str( 12 );
+		$post_type_slug        = 'fooo-bar-baz';
 		$post_type_description = '';
 		register_post_type(
 			$post_type_slug,
@@ -319,8 +382,8 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public function test_wp_setup_nav_menu_item_for_post_type_archive_custom_description() {
 
-		$post_type_slug        = rand_str( 12 );
-		$post_type_description = rand_str();
+		$post_type_slug        = 'fooo-bar-baz';
+		$post_type_description = 'foobaz';
 		register_post_type(
 			$post_type_slug,
 			array(
@@ -331,7 +394,7 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 			)
 		);
 
-		$menu_item_description = rand_str();
+		$menu_item_description = 'foo_description';
 
 		$post_type_archive_item_id = wp_update_nav_menu_item(
 			$this->menu_id,
@@ -354,7 +417,7 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 	 */
 	public function test_wp_setup_nav_menu_item_for_unknown_post_type_archive_no_description() {
 
-		$post_type_slug = rand_str( 12 );
+		$post_type_slug = 'fooo-bar-baz';
 
 		$post_type_archive_item_id = wp_update_nav_menu_item(
 			$this->menu_id,
@@ -682,17 +745,17 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 	 * @covers ::_wp_delete_customize_changeset_dependent_auto_drafts
 	 */
 	public function test_wp_delete_customize_changeset_dependent_auto_drafts() {
-		$auto_draft_post_id = $this->factory()->post->create(
+		$auto_draft_post_id = self::factory()->post->create(
 			array(
 				'post_status' => 'auto-draft',
 			)
 		);
-		$draft_post_id      = $this->factory()->post->create(
+		$draft_post_id      = self::factory()->post->create(
 			array(
 				'post_status' => 'draft',
 			)
 		);
-		$private_post_id    = $this->factory()->post->create(
+		$private_post_id    = self::factory()->post->create(
 			array(
 				'post_status' => 'private',
 			)
diff --git a/tests/post/output.php b/tests/post/output.php
index 5af6e05837..a08f7524ee 100644
--- a/tests/post/output.php
+++ b/tests/post/output.php
@@ -98,7 +98,7 @@ Graf by itself:
 
   [paragraph foo="bar"]another graf with whitespace[/paragraph]
 
-An [paragraph]inline graf[/paragraph], this doesn't make much sense.
+An [paragraph]inline graf[/paragraph], this does not make much sense.
 
 A graf with a single EOL first:
 [paragraph]blah[/paragraph]
@@ -112,7 +112,7 @@ EOF;
   <p class='graf'>another graf with whitespace</p>
 
 <p>An <p class='graf'>inline graf</p>
-, this doesn&#8217;t make much sense.</p>
+, this does not make much sense.</p>
 <p>A graf with a single EOL first:<br />
 <p class='graf'>blah</p>
 </p>
diff --git a/tests/post/query.php b/tests/post/query.php
index 29267e429a..66bcdc2691 100644
--- a/tests/post/query.php
+++ b/tests/post/query.php
@@ -5,6 +5,25 @@
  * @group post
  */
 class Tests_Post_Query extends WP_UnitTestCase {
+
+	/**
+	 * Temporary storage for a post ID for tests using filter callbacks.
+	 *
+	 * Used in the `test_posts_pre_query_filter_should_respect_set_found_posts()` method.
+	 *
+	 * @var int
+	 */
+	private $post_id;
+
+	/**
+	 * Clean up after each test.
+	 */
+	public function tear_down() {
+		unset( $this->post_id );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @group taxonomy
 	 */
@@ -132,33 +151,33 @@ class Tests_Post_Query extends WP_UnitTestCase {
 		$post_id1 = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
-				'menu_order' => rand( 1, 100 ),
+				'menu_order' => 1,
 			)
 		);
 		$post_id2 = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
-				'menu_order' => rand( 1, 100 ),
+				'menu_order' => 2,
 			)
 		);
 		$post_id3 = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_parent' => $post_id2,
-				'menu_order'  => rand( 1, 100 ),
+				'menu_order'  => 3,
 			)
 		);
 		$post_id4 = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_parent' => $post_id2,
-				'menu_order'  => rand( 1, 100 ),
+				'menu_order'  => 4,
 			)
 		);
 		$post_id5 = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
-				'menu_order' => rand( 1, 100 ),
+				'menu_order' => 5,
 			)
 		);
 
@@ -219,7 +238,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
-				'menu_order'     => rand( 1, 100 ),
+				'menu_order'     => 1,
 			)
 		);
 		$att_ids[2] = self::factory()->attachment->create_object(
@@ -227,7 +246,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
-				'menu_order'     => rand( 1, 100 ),
+				'menu_order'     => 2,
 			)
 		);
 		$att_ids[3] = self::factory()->attachment->create_object(
@@ -235,7 +254,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
-				'menu_order'     => rand( 1, 100 ),
+				'menu_order'     => 3,
 			)
 		);
 		$att_ids[4] = self::factory()->attachment->create_object(
@@ -243,7 +262,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
-				'menu_order'     => rand( 1, 100 ),
+				'menu_order'     => 4,
 			)
 		);
 		$att_ids[5] = self::factory()->attachment->create_object(
@@ -251,7 +270,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 			$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
-				'menu_order'     => rand( 1, 100 ),
+				'menu_order'     => 5,
 			)
 		);
 
@@ -729,7 +748,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 	 * @ticket 42469
 	 */
 	public function test_found_posts_should_be_integer_not_string() {
-		$this->post_id = self::factory()->post->create();
+		$post_id = self::factory()->post->create();
 
 		$q = new WP_Query(
 			array(
@@ -744,7 +763,7 @@ class Tests_Post_Query extends WP_UnitTestCase {
 	 * @ticket 42469
 	 */
 	public function test_found_posts_should_be_integer_even_if_found_posts_filter_returns_string_value() {
-		$this->post_id = self::factory()->post->create();
+		$post_id = self::factory()->post->create();
 
 		add_filter( 'found_posts', '__return_empty_string' );
 
diff --git a/tests/post/revisions.php b/tests/post/revisions.php
index 4ff458a012..c8effbccc2 100644
--- a/tests/post/revisions.php
+++ b/tests/post/revisions.php
@@ -5,6 +5,9 @@
  * @group revision
  */
 class Tests_Post_Revisions extends WP_UnitTestCase {
+
+	const POST_TYPE = 'test-revision';
+
 	protected static $admin_user_id;
 	protected static $editor_user_id;
 	protected static $author_user_id;
@@ -15,11 +18,6 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 		self::$author_user_id = $factory->user->create( array( 'role' => 'author' ) );
 	}
 
-	public function set_up() {
-		parent::set_up();
-		$this->post_type = rand_str( 20 );
-	}
-
 	/**
 	 * Note: Test needs reviewing when #16215 is fixed because I'm not sure the test current tests the "correct" behavior
 	 *
@@ -318,7 +316,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 	 */
 	public function test_revision_view_caps_cpt() {
 		register_post_type(
-			$this->post_type,
+			self::POST_TYPE,
 			array(
 				'capability_type' => 'event',
 				'map_meta_cap'    => true,
@@ -328,7 +326,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 
 		$post_id = self::factory()->post->create(
 			array(
-				'post_type'   => $this->post_type,
+				'post_type'   => self::POST_TYPE,
 				'post_author' => self::$editor_user_id,
 			)
 		);
@@ -360,7 +358,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 	 */
 	public function test_revision_restore_caps_cpt() {
 		register_post_type(
-			$this->post_type,
+			self::POST_TYPE,
 			array(
 				'capability_type' => 'event',
 				'map_meta_cap'    => true,
@@ -375,7 +373,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 		// Create a post as Editor.
 		$post_id = self::factory()->post->create(
 			array(
-				'post_type'   => $this->post_type,
+				'post_type'   => self::POST_TYPE,
 				'post_author' => self::$editor_user_id,
 			)
 		);
@@ -406,7 +404,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 	 */
 	public function test_revision_restore_caps_before_publish() {
 		register_post_type(
-			$this->post_type,
+			self::POST_TYPE,
 			array(
 				'capability_type' => 'post',
 				'capabilities'    => array(
@@ -424,7 +422,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 
 		$post_id = self::factory()->post->create(
 			array(
-				'post_type'   => $this->post_type,
+				'post_type'   => self::POST_TYPE,
 				'post_status' => 'draft',
 			)
 		);
@@ -446,7 +444,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 			array(
 				'post_status'  => 'publish',
 				'ID'           => $post_id,
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 			)
 		);
 
@@ -466,7 +464,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 	 */
 	public function test_revision_diff_caps_cpt() {
 		register_post_type(
-			$this->post_type,
+			self::POST_TYPE,
 			array(
 				'capability_type' => 'event',
 				'map_meta_cap'    => true,
@@ -476,7 +474,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 
 		$post_id = self::factory()->post->create(
 			array(
-				'post_type'   => $this->post_type,
+				'post_type'   => self::POST_TYPE,
 				'post_author' => self::$editor_user_id,
 			)
 		);
@@ -655,6 +653,61 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 		$this->assertWPError( $revision );
 	}
 
+	/**
+	 * Tests that wp_get_latest_revision_id_and_total_count() returns the latest revision ID and total count.
+	 *
+	 * @covers ::wp_get_latest_revision_id_and_total_count
+	 * @ticket 55857
+	 * @dataProvider data_wp_get_post_revisions_url
+	 */
+	public function test_wp_get_latest_revision_id_and_total_count( $revisions ) {
+		$post_id = self::factory()->post->create();
+		for ( $i = 0; $i < $revisions; ++$i ) {
+			wp_update_post(
+				array(
+					'ID'         => $post_id,
+					'post_title' => 'Some Post',
+				)
+			);
+		}
+
+		$post_revisions       = wp_get_post_revisions( $post_id );
+		$latest_post_revision = current( $post_revisions );
+		$revisions            = wp_get_latest_revision_id_and_total_count( $post_id );
+
+		$this->assertSame(
+			$latest_post_revision->ID,
+			$revisions['latest_id'],
+			'The latest revision ID does not match.'
+		);
+
+		$this->assertSame(
+			count( $post_revisions ),
+			$revisions['count'],
+			'The total count of revisions does not match.'
+		);
+	}
+
+	/**
+	 * Tests that wp_get_latest_revision_id_and_total_count() returns a WP_Error when no revisions exist.
+	 *
+	 * @covers ::wp_get_latest_revision_id_and_total_count
+	 * @ticket 55857
+	 */
+	public function test_wp_get_latest_revision_id_and_total_count_no_revisions() {
+		$revision = wp_get_latest_revision_id_and_total_count( null );
+
+		$this->assertWPError( $revision, 'Invalid post, no revisions should exist.' );
+		$this->assertSame( $revision->get_error_code(), 'invalid_post' );
+
+		add_filter( 'wp_revisions_to_keep', '__return_zero' );
+		$post_id  = self::factory()->post->create();
+		$revision = wp_get_latest_revision_id_and_total_count( $post_id );
+
+		$this->assertWPError( $revision, 'Revisions should not be enabled.' );
+		$this->assertSame( $revision->get_error_code(), 'revisions_not_enabled' );
+	}
+
 	/**
 	 * Tests that wp_get_post_revisions_url() returns the revisions URL.
 	 *
diff --git a/tests/post/slashes.php b/tests/post/slashes.php
index c0654770b6..fdab733f1d 100644
--- a/tests/post/slashes.php
+++ b/tests/post/slashes.php
@@ -6,6 +6,20 @@
  * @ticket 21767
  */
 class Tests_Post_Slashes extends WP_UnitTestCase {
+
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
+
 	protected static $author_id;
 	protected static $post_id;
 
@@ -18,16 +32,6 @@ class Tests_Post_Slashes extends WP_UnitTestCase {
 		parent::set_up();
 
 		wp_set_current_user( self::$author_id );
-
-		// It is important to test with both even and odd numbered slashes,
-		// as KSES does a strip-then-add slashes in some of its function calls.
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 	}
 
 	/**
@@ -38,33 +42,33 @@ class Tests_Post_Slashes extends WP_UnitTestCase {
 
 		$_POST               = array();
 		$_POST['post_ID']    = $post_id;
-		$_POST['post_title'] = $this->slash_1;
-		$_POST['content']    = $this->slash_5;
-		$_POST['excerpt']    = $this->slash_7;
+		$_POST['post_title'] = self::SLASH_1;
+		$_POST['content']    = self::SLASH_5;
+		$_POST['excerpt']    = self::SLASH_7;
 
 		$_POST = add_magic_quotes( $_POST ); // The edit_post() function will strip slashes.
 
 		$post_id = edit_post();
 		$post    = get_post( $post_id );
 
-		$this->assertSame( $this->slash_1, $post->post_title );
-		$this->assertSame( $this->slash_5, $post->post_content );
-		$this->assertSame( $this->slash_7, $post->post_excerpt );
+		$this->assertSame( self::SLASH_1, $post->post_title );
+		$this->assertSame( self::SLASH_5, $post->post_content );
+		$this->assertSame( self::SLASH_7, $post->post_excerpt );
 
 		$_POST               = array();
 		$_POST['post_ID']    = $post_id;
-		$_POST['post_title'] = $this->slash_2;
-		$_POST['content']    = $this->slash_4;
-		$_POST['excerpt']    = $this->slash_6;
+		$_POST['post_title'] = self::SLASH_2;
+		$_POST['content']    = self::SLASH_4;
+		$_POST['excerpt']    = self::SLASH_6;
 
 		$_POST = add_magic_quotes( $_POST ); // The edit_post() function will strip slashes.
 
 		$post_id = edit_post();
 		$post    = get_post( $post_id );
 
-		$this->assertSame( $this->slash_2, $post->post_title );
-		$this->assertSame( $this->slash_4, $post->post_content );
-		$this->assertSame( $this->slash_6, $post->post_excerpt );
+		$this->assertSame( self::SLASH_2, $post->post_title );
+		$this->assertSame( self::SLASH_4, $post->post_content );
+		$this->assertSame( self::SLASH_6, $post->post_excerpt );
 	}
 
 	/**
@@ -74,33 +78,33 @@ class Tests_Post_Slashes extends WP_UnitTestCase {
 		$post_id = wp_insert_post(
 			array(
 				'post_status'  => 'publish',
-				'post_title'   => $this->slash_1,
-				'post_content' => $this->slash_3,
-				'post_excerpt' => $this->slash_5,
+				'post_title'   => self::SLASH_1,
+				'post_content' => self::SLASH_3,
+				'post_excerpt' => self::SLASH_5,
 				'post_type'    => 'post',
 				'slashed'      => false,
 			)
 		);
 		$post    = get_post( $post_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $post->post_title );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $post->post_content );
-		$this->assertSame( wp_unslash( $this->slash_5 ), $post->post_excerpt );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $post->post_title );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $post->post_content );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), $post->post_excerpt );
 
 		$post_id = wp_insert_post(
 			array(
 				'post_status'  => 'publish',
-				'post_title'   => $this->slash_2,
-				'post_content' => $this->slash_4,
-				'post_excerpt' => $this->slash_6,
+				'post_title'   => self::SLASH_2,
+				'post_content' => self::SLASH_4,
+				'post_excerpt' => self::SLASH_6,
 				'post_type'    => 'post',
 			)
 		);
 		$post    = get_post( $post_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $post->post_title );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $post->post_content );
-		$this->assertSame( wp_unslash( $this->slash_6 ), $post->post_excerpt );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $post->post_title );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $post->post_content );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), $post->post_excerpt );
 	}
 
 	/**
@@ -112,30 +116,30 @@ class Tests_Post_Slashes extends WP_UnitTestCase {
 		wp_update_post(
 			array(
 				'ID'           => $post_id,
-				'post_title'   => $this->slash_1,
-				'post_content' => $this->slash_3,
-				'post_excerpt' => $this->slash_5,
+				'post_title'   => self::SLASH_1,
+				'post_content' => self::SLASH_3,
+				'post_excerpt' => self::SLASH_5,
 			)
 		);
 		$post = get_post( $post_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $post->post_title );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $post->post_content );
-		$this->assertSame( wp_unslash( $this->slash_5 ), $post->post_excerpt );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $post->post_title );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $post->post_content );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), $post->post_excerpt );
 
 		wp_update_post(
 			array(
 				'ID'           => $post_id,
-				'post_title'   => $this->slash_2,
-				'post_content' => $this->slash_4,
-				'post_excerpt' => $this->slash_6,
+				'post_title'   => self::SLASH_2,
+				'post_content' => self::SLASH_4,
+				'post_excerpt' => self::SLASH_6,
 			)
 		);
 		$post = get_post( $post_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $post->post_title );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $post->post_content );
-		$this->assertSame( wp_unslash( $this->slash_6 ), $post->post_excerpt );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $post->post_title );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $post->post_content );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), $post->post_excerpt );
 	}
 
 	/**
@@ -143,9 +147,9 @@ class Tests_Post_Slashes extends WP_UnitTestCase {
 	 */
 	public function test_wp_trash_untrash() {
 		$post    = array(
-			'post_title'   => $this->slash_1,
-			'post_content' => $this->slash_3,
-			'post_excerpt' => $this->slash_5,
+			'post_title'   => self::SLASH_1,
+			'post_content' => self::SLASH_3,
+			'post_excerpt' => self::SLASH_5,
 		);
 		$post_id = wp_insert_post( wp_slash( $post ) );
 
@@ -154,17 +158,17 @@ class Tests_Post_Slashes extends WP_UnitTestCase {
 
 		$post = get_post( $post_id );
 
-		$this->assertSame( $this->slash_1, $post->post_title );
-		$this->assertSame( $this->slash_3, $post->post_content );
-		$this->assertSame( $this->slash_5, $post->post_excerpt );
+		$this->assertSame( self::SLASH_1, $post->post_title );
+		$this->assertSame( self::SLASH_3, $post->post_content );
+		$this->assertSame( self::SLASH_5, $post->post_excerpt );
 
 		$untrashed = wp_untrash_post( $post_id );
 		$this->assertNotEmpty( $untrashed );
 
 		$post = get_post( $post_id );
 
-		$this->assertSame( $this->slash_1, $post->post_title );
-		$this->assertSame( $this->slash_3, $post->post_content );
-		$this->assertSame( $this->slash_5, $post->post_excerpt );
+		$this->assertSame( self::SLASH_1, $post->post_title );
+		$this->assertSame( self::SLASH_3, $post->post_content );
+		$this->assertSame( self::SLASH_5, $post->post_excerpt );
 	}
 }
diff --git a/tests/post/thumbnails.php b/tests/post/thumbnails.php
index 58ac548584..d170e1bfa5 100644
--- a/tests/post/thumbnails.php
+++ b/tests/post/thumbnails.php
@@ -27,7 +27,7 @@ class Tests_Post_Thumbnail_Template extends WP_UnitTestCase {
 	}
 
 	public static function tear_down_after_class() {
-		wp_delete_post( self::$attachment_id, true );
+		wp_delete_attachment( self::$attachment_id, true );
 		parent::tear_down_after_class();
 	}
 
diff --git a/tests/post/types.php b/tests/post/types.php
index 449467cf1d..5ea10cbb2c 100644
--- a/tests/post/types.php
+++ b/tests/post/types.php
@@ -21,7 +21,7 @@ class Tests_Post_Types extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
-		$this->post_type = rand_str( 20 );
+		$this->post_type = 'foo1';
 	}
 
 	public function test_register_post_type() {
@@ -163,6 +163,23 @@ class Tests_Post_Types extends WP_UnitTestCase {
 		$this->assertSame( $public, $args->show_in_admin_bar );
 	}
 
+	/**
+	 * @ticket 53212
+	 * @covers ::register_post_type
+	 */
+	public function test_fires_registered_post_type_actions() {
+		$post_type = 'cpt';
+		$action    = new MockAction();
+
+		add_action( 'registered_post_type', array( $action, 'action' ) );
+		add_action( "registered_post_type_{$post_type}", array( $action, 'action' ) );
+
+		register_post_type( $post_type );
+		register_post_type( $this->post_type );
+
+		$this->assertSame( 3, $action->get_call_count() );
+	}
+
 	public function test_register_taxonomy_for_object_type() {
 		global $wp_taxonomies;
 
diff --git a/tests/post/updatePostAuthorCaches.php b/tests/post/updatePostAuthorCaches.php
new file mode 100644
index 0000000000..0c5823561b
--- /dev/null
+++ b/tests/post/updatePostAuthorCaches.php
@@ -0,0 +1,75 @@
+<?php
+/**
+ * Test `update_post_author_caches()`.
+ *
+ * @package WordPress
+ */
+
+/**
+ * Test class for `update_post_author_caches()`.
+ *
+ * @group post
+ * @group query
+ * @group user
+ *
+ * @covers ::update_post_author_caches
+ */
+class Tests_Post_UpdatePostAuthorCaches extends WP_UnitTestCase {
+
+	/**
+	 * User IDs from the shared fixture.
+	 *
+	 * @var int[]
+	 */
+	public static $user_ids;
+
+	/**
+	 * Post author count.
+	 *
+	 * @var int
+	 */
+	public static $post_author_count = 5;
+
+	/**
+	 * Set up test resources before the class.
+	 *
+	 * @param WP_UnitTest_Factory $factory The unit test factory.
+	 */
+	public static function wpSetupBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$user_ids = array();
+
+		for ( $i = 0; $i < self::$post_author_count; $i++ ) {
+			self::$user_ids[ $i ] = $factory->user->create();
+			$factory->post->create(
+				array(
+					'post_type'   => 'post',
+					'post_author' => self::$user_ids[ $i ],
+				)
+			);
+		}
+	}
+
+	/**
+	 * @ticket 55716
+	 */
+	public function test_update_post_author_caches() {
+		$action = new MockAction();
+		add_filter( 'update_user_metadata_cache', array( $action, 'filter' ), 10, 2 );
+
+		$q = new WP_Query(
+			array(
+				'post_type'      => 'post',
+				'posts_per_page' => self::$post_author_count,
+			)
+		);
+
+		while ( $q->have_posts() ) {
+			$q->the_post();
+		}
+
+		$args      = $action->get_args();
+		$last_args = end( $args );
+
+		$this->assertSameSets( self::$user_ids, $last_args[1], 'Ensure that user IDs are primed' );
+	}
+}
diff --git a/tests/post/updatePostCache.php b/tests/post/updatePostCache.php
new file mode 100644
index 0000000000..cfb279b67c
--- /dev/null
+++ b/tests/post/updatePostCache.php
@@ -0,0 +1,141 @@
+<?php
+/**
+ * Test `update_post_cache()`.
+ *
+ * @package WordPress
+ */
+
+/**
+ * Test class for `update_post_cache()`.
+ *
+ * @group post
+ * @group query
+ *
+ * @covers ::update_post_cache
+ */
+class Tests_Post_UpdatePostCache extends WP_UnitTestCase {
+
+	/**
+	 * Post IDs from the shared fixture.
+	 *
+	 * @var int[]
+	 */
+	public static $post_ids;
+
+	/**
+	 * Set up test resources before the class.
+	 *
+	 * @param WP_UnitTest_Factory $factory The unit test factory.
+	 */
+	public static function wpSetupBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$post_ids = $factory->post->create_many( 1 );
+	}
+
+	/**
+	 * Ensure that `update_post_cache()` returns `null` when
+	 * `$posts` is empty.
+	 *
+	 * @ticket 50567
+	 */
+	public function test_should_return_null_with_an_empty_array() {
+		$posts = array();
+		$this->assertNull( update_post_cache( $posts ) );
+	}
+
+	/**
+	 * Ensure filter = raw is always set via Query.
+	 *
+	 * @ticket 50567
+	 */
+	public function test_query_caches_post_filter() {
+		$post_id = self::$post_ids[0];
+		$this->go_to( '/' );
+
+		$cached_post = wp_cache_get( $post_id, 'posts' );
+		$this->assertIsObject(
+			$cached_post,
+			'The cached post is not an object'
+		);
+
+		$this->assertObjectHasAttribute(
+			'filter',
+			$cached_post,
+			'The cached post does not have a "filter" property'
+		);
+
+		$this->assertSame(
+			'raw',
+			$cached_post->filter,
+			'The filter is not set to "raw"'
+		);
+	}
+
+	/**
+	 * Ensure filter = raw is always set via get_post.
+	 *
+	 * @ticket 50567
+	 */
+	public function test_get_post_caches_post_filter() {
+		$post_id = self::$post_ids[0];
+		get_post( $post_id );
+
+		$cached_post = wp_cache_get( $post_id, 'posts' );
+		$this->assertSame( 'raw', $cached_post->filter );
+	}
+
+	/**
+	 * Ensure filter = raw is always set via get_post called with a different filter setting.
+	 *
+	 * @ticket 50567
+	 */
+	public function test_get_post_caches_post_filter_is_always_raw() {
+		$post_id = self::$post_ids[0];
+		get_post( $post_id, OBJECT, 'display' );
+
+		$cached_post = wp_cache_get( $post_id, 'posts' );
+		$this->assertIsObject(
+			$cached_post,
+			'The cached post is not an object'
+		);
+
+		$this->assertObjectHasAttribute(
+			'filter',
+			$cached_post,
+			'The cached post does not have a "filter" property'
+		);
+
+		$this->assertSame(
+			'raw',
+			$cached_post->filter,
+			'The filter is not set to "raw"'
+		);
+	}
+
+	/**
+	 * Ensure filter = raw is always set via get_posts.
+	 *
+	 * @ticket 50567
+	 */
+	public function test_get_posts_caches_post_filter_is_always_raw() {
+		$post_id = self::$post_ids[0];
+		get_posts( array( 'includes' => $post_id ) );
+
+		$cached_post = wp_cache_get( $post_id, 'posts' );
+		$this->assertIsObject(
+			$cached_post,
+			'The cached post is not an object'
+		);
+
+		$this->assertObjectHasAttribute(
+			'filter',
+			$cached_post,
+			'The cached post does not have a "filter" property'
+		);
+
+		$this->assertSame(
+			'raw',
+			$cached_post->filter,
+			'The filter is not set to "raw"'
+		);
+	}
+}
diff --git a/tests/post/walkerPage.php b/tests/post/walkerPage.php
index 6b71bb0216..a5a632dcda 100644
--- a/tests/post/walkerPage.php
+++ b/tests/post/walkerPage.php
@@ -28,7 +28,7 @@ class Tests_Post_Walker_Page extends WP_UnitTestCase {
 	 */
 	public function test_start_el_with_empty_attributes( $value, $expected ) {
 		$output = '';
-		$page   = $this->factory->post->create_and_get( array( 'post_type' => 'page' ) );
+		$page   = self::factory()->post->create_and_get( array( 'post_type' => 'page' ) );
 		$link   = get_permalink( $page );
 
 		add_filter(
diff --git a/tests/post/wpInsertPost.php b/tests/post/wpInsertPost.php
index c1a60753da..4ec43bbfec 100644
--- a/tests/post/wpInsertPost.php
+++ b/tests/post/wpInsertPost.php
@@ -2,11 +2,13 @@
 
 /**
  * @group post
+ * @covers ::wp_insert_post
  */
 class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 
 	protected static $user_ids = array(
 		'administrator' => null,
+		'editor'        => null,
 		'contributor'   => null,
 	);
 
@@ -17,6 +19,11 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 					'role' => 'administrator',
 				)
 			),
+			'editor'        => $factory->user->create(
+				array(
+					'role' => 'editor',
+				)
+			),
 			'contributor'   => $factory->user->create(
 				array(
 					'role' => 'contributor',
@@ -65,6 +72,1174 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Helper function: return the timestamp(s) of cron jobs for the specified hook and post.
+	 */
+	private function next_schedule_for_post( $hook, $post_id ) {
+		return wp_next_scheduled( 'publish_future_post', array( 0 => (int) $post_id ) );
+	}
+
+	/**
+	 * Helper function, unsets current user globally.
+	 */
+	private function unset_current_user() {
+		global $current_user, $user_ID;
+
+		$current_user = null;
+		$user_ID      = null;
+	}
+
+	/**
+	 * Test simple valid behavior: insert and get a post.
+	 *
+	 * @dataProvider data_vb_insert_get_delete
+	 */
+	public function test_vb_insert_get_delete( $post_type ) {
+		register_post_type(
+			'cpt',
+			array(
+				'taxonomies' => array( 'post_tag', 'ctax' ),
+			)
+		);
+		register_taxonomy( 'ctax', 'cpt' );
+
+		wp_set_current_user( self::$user_ids['editor'] );
+
+		$data = array(
+			'post_author'  => self::$user_ids['editor'],
+			'post_status'  => 'publish',
+			'post_content' => "{$post_type}_content",
+			'post_title'   => "{$post_type}_title",
+			'tax_input'    => array(
+				'post_tag' => 'tag1,tag2',
+				'ctax'     => 'cterm1,cterm2',
+			),
+			'post_type'    => $post_type,
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+		$this->assertIsInt( $post_id );
+		$this->assertGreaterThan( 0, $post_id );
+
+		// Fetch the post and make sure it matches.
+		$post = get_post( $post_id );
+
+		$this->assertSame( $data['post_content'], $post->post_content );
+		$this->assertSame( $data['post_title'], $post->post_title );
+		$this->assertSame( $data['post_status'], $post->post_status );
+		$this->assertEquals( $data['post_author'], $post->post_author );
+
+		// Test cache state.
+		$post_cache = wp_cache_get( $post_id, 'posts' );
+		$this->assertInstanceOf( 'stdClass', $post_cache );
+		$this->assertSame( $post_id, $post_cache->ID );
+
+		update_object_term_cache( $post_id, $post_type );
+		$term_cache = wp_cache_get( $post_id, 'post_tag_relationships' );
+		$this->assertIsArray( $term_cache );
+		$this->assertCount( 2, $term_cache );
+
+		$term_cache = wp_cache_get( $post_id, 'ctax_relationships' );
+		if ( 'cpt' === $post_type ) {
+			$this->assertIsArray( $term_cache );
+			$this->assertCount( 2, $term_cache );
+		} else {
+			$this->assertFalse( $term_cache );
+		}
+
+		wp_delete_post( $post_id, true );
+
+		$this->assertFalse( wp_cache_get( $post_id, 'posts' ) );
+		$this->assertFalse( wp_cache_get( $post_id, 'post_tag_relationships' ) );
+		$this->assertFalse( wp_cache_get( $post_id, 'ctax_relationships' ) );
+
+		$GLOBALS['wp_taxonomies']['post_tag']->object_type = array( 'post' );
+	}
+
+	public function data_vb_insert_get_delete() {
+		$post_types = array( 'post', 'cpt' );
+
+		return $this->text_array_to_dataprovider( $post_types );
+	}
+
+	/**
+	 * Insert a post with a future date, and make sure the status and cron schedule are correct.
+	 */
+	public function test_vb_insert_future() {
+		$future_date = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+		$this->assertIsInt( $post_id );
+		$this->assertGreaterThan( 0, $post_id );
+
+		// Fetch the post and make sure it matches.
+		$post = get_post( $post_id );
+
+		$this->assertSame( $data['post_content'], $post->post_content );
+		$this->assertSame( $data['post_title'], $post->post_title );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// There should be a publish_future_post hook scheduled on the future date.
+		$this->assertSame( $future_date, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * Insert a post with a future date, and make sure the status and cron schedule are correct.
+	 */
+	public function test_vb_insert_future_over_dst() {
+		// Some magic days - one DST one not.
+		$future_date_1 = strtotime( 'June 21st +1 year' );
+		$future_date_2 = strtotime( 'Jan 11th +1 year' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Fetch the post and make sure has the correct date and status.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// Check that there's a publish_future_post job scheduled at the right time.
+		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+		// Now save it again with a date further in the future.
+		$data['ID']            = $post_id;
+		$data['post_date']     = date_format( date_create( "@{$future_date_2}" ), 'Y-m-d H:i:s' );
+		$data['post_date_gmt'] = null;
+		wp_update_post( $data );
+
+		// Fetch the post again and make sure it has the new post_date.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// And the correct date on the cron job.
+		$this->assertSame( $future_date_2, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * Future post bug: posts get published at the wrong time if you edit the timestamp.
+	 *
+	 * @ticket 4710
+	 */
+	public function test_vb_insert_future_edit_bug() {
+		$future_date_1 = strtotime( '+1 day' );
+		$future_date_2 = strtotime( '+2 day' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Fetch the post and make sure has the correct date and status.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// Check that there's a publish_future_post job scheduled at the right time.
+		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+		// Now save it again with a date further in the future.
+		$data['ID']            = $post_id;
+		$data['post_date']     = date_format( date_create( "@{$future_date_2}" ), 'Y-m-d H:i:s' );
+		$data['post_date_gmt'] = null;
+		wp_update_post( $data );
+
+		// Fetch the post again and make sure it has the new post_date.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// And the correct date on the cron job.
+		$this->assertSame( $future_date_2, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * Insert a draft post with a future date, and make sure no cron schedule is set.
+	 */
+	public function test_vb_insert_future_draft() {
+		$future_date = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'draft',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+		$this->assertIsInt( $post_id );
+		$this->assertGreaterThan( 0, $post_id );
+
+		// Fetch the post and make sure it matches.
+		$post = get_post( $post_id );
+
+		$this->assertSame( $data['post_content'], $post->post_content );
+		$this->assertSame( $data['post_title'], $post->post_title );
+		$this->assertSame( 'draft', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// There should be a publish_future_post hook scheduled on the future date.
+		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+	}
+
+	/**
+	 * Insert a future post, then edit and change it to draft, and make sure cron gets it right.
+	 */
+	public function test_vb_insert_future_change_to_draft() {
+		$future_date_1 = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Fetch the post and make sure has the correct date and status.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// Check that there's a publish_future_post job scheduled at the right time.
+		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+		// Now save it again with status set to draft.
+		$data['ID']          = $post_id;
+		$data['post_status'] = 'draft';
+		wp_update_post( $data );
+
+		// Fetch the post again and make sure it has the new post_date.
+		$post = get_post( $post_id );
+		$this->assertSame( 'draft', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// And the correct date on the cron job.
+		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * Insert a future post, then edit and change the status, and make sure cron gets it right.
+	 *
+	 * @dataProvider data_vb_insert_future_change_status
+	 */
+	public function test_vb_insert_future_change_status( $status ) {
+		$future_date_1 = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => "{$status}_content",
+			'post_title'   => "{$status}_title",
+			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Fetch the post and make sure has the correct date and status.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// Check that there's a publish_future_post job scheduled at the right time.
+		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+		// Now save it again with status changed.
+		$data['ID']          = $post_id;
+		$data['post_status'] = $status;
+		wp_update_post( $data );
+
+		// Fetch the post again and make sure it has the new post_date.
+		$post = get_post( $post_id );
+		$this->assertSame( $status, $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// And the correct date on the cron job.
+		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	public function data_vb_insert_future_change_status() {
+		$statuses = array(
+			'draft',
+			'static',
+			'object',
+			'attachment',
+			'inherit',
+			'pending',
+		);
+
+		return $this->text_array_to_dataprovider( $statuses );
+	}
+
+	/**
+	 * Insert a draft post with a future date, and make sure no cron schedule is set.
+	 */
+	public function test_vb_insert_future_private() {
+		$future_date = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'private',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+		$this->assertIsInt( $post_id );
+		$this->assertGreaterThan( 0, $post_id );
+
+		// Fetch the post and make sure it matches.
+		$post = get_post( $post_id );
+
+		$this->assertSame( $data['post_content'], $post->post_content );
+		$this->assertSame( $data['post_title'], $post->post_title );
+		$this->assertSame( 'private', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// There should be a publish_future_post hook scheduled on the future date.
+		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * Insert a post with an invalid date, make sure it fails.
+	 *
+	 * @ticket 17180
+	 */
+	public function test_vb_insert_invalid_date() {
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => '2012-02-30 00:00:00',
+		);
+
+		// Test both return paths with or without WP_Error.
+		$post_id = wp_insert_post( $data, true );
+		$this->assertWPError( $post_id );
+		$this->assertSame( 'invalid_date', $post_id->get_error_code() );
+
+		$post_id = wp_insert_post( $data );
+		$this->assertSame( 0, $post_id );
+	}
+
+	/**
+	 * Insert a future post, then edit and change it to private, and make sure cron gets it right.
+	 */
+	public function test_vb_insert_future_change_to_private() {
+		$future_date_1 = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date_1}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Fetch the post and make sure has the correct date and status.
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// Check that there's a publish_future_post job scheduled at the right time.
+		$this->assertSame( $future_date_1, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+		// Now save it again with status set to draft.
+		$data['ID']          = $post_id;
+		$data['post_status'] = 'private';
+		wp_update_post( $data );
+
+		// Fetch the post again and make sure it has the new post_date.
+		$post = get_post( $post_id );
+		$this->assertSame( 'private', $post->post_status );
+		$this->assertSame( $data['post_date'], $post->post_date );
+
+		// And the correct date on the cron job.
+		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * @ticket 5305
+	 */
+	public function test_wp_insert_post_should_not_allow_a_bare_numeric_slug_that_might_conflict_with_a_date_archive_when_generating_from_an_empty_post_title() {
+		$this->set_permalink_structure( '/%postname%/' );
+
+		$post_id = wp_insert_post(
+			array(
+				'post_title'   => '',
+				'post_content' => 'test',
+				'post_status'  => 'publish',
+				'post_type'    => 'post',
+			)
+		);
+
+		$post = get_post( $post_id );
+
+		$this->assertSame( "$post_id-2", $post->post_name );
+	}
+
+	/**
+	 * @ticket 5305
+	 * @ticket 33392
+	 */
+	public function test_wp_insert_post_should_invalidate_post_cache_before_generating_guid_when_post_name_is_empty_and_is_generated_from_the_post_ID() {
+		register_post_type( 'wptests_pt' );
+
+		$post_id = wp_insert_post(
+			array(
+				'post_title'  => '',
+				'post_type'   => 'wptests_pt',
+				'post_status' => 'publish',
+			)
+		);
+
+		$post = get_post( $post_id );
+
+		$this->assertStringContainsString( 'wptests_pt=' . $post_id, $post->guid );
+	}
+
+	/**
+	 * @ticket 55877
+	 * @covers ::wp_insert_post
+	 */
+	public function test_wp_insert_post_should_not_trigger_warning_for_pending_posts_with_unknown_cpt() {
+		$post_id = wp_insert_post(
+			array(
+				'post_title'  => 'title',
+				'post_type'   => 'unknown',
+				'post_status' => 'pending',
+			)
+		);
+
+		$this->assertIsInt( $post_id );
+		$this->assertGreaterThan( 0, $post_id );
+	}
+
+	/**
+	 * @ticket 20451
+	 */
+	public function test_wp_insert_post_with_meta_input() {
+		$post_id = wp_insert_post(
+			array(
+				'post_title'   => '',
+				'post_content' => 'test',
+				'post_status'  => 'publish',
+				'post_type'    => 'post',
+				'meta_input'   => array(
+					'hello' => 'world',
+					'foo'   => 'bar',
+				),
+			)
+		);
+
+		$this->assertSame( 'world', get_post_meta( $post_id, 'hello', true ) );
+		$this->assertSame( 'bar', get_post_meta( $post_id, 'foo', true ) );
+	}
+
+	/**
+	 * "When I delete a future post using wp_delete_post( $post->ID ) it does not update the cron correctly."
+	 *
+	 * @ticket 5364
+	 * @covers ::wp_delete_post
+	 */
+	public function test_delete_future_post_cron() {
+		$future_date = strtotime( '+1 day' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => 'title',
+			'post_date'    => date_format( date_create( "@{$future_date}" ), 'Y-m-d H:i:s' ),
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Check that there's a publish_future_post job scheduled at the right time.
+		$this->assertSame( $future_date, $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+
+		// Now delete the post and make sure the cron entry is removed.
+		wp_delete_post( $post_id );
+
+		$this->assertFalse( $this->next_schedule_for_post( 'publish_future_post', $post_id ) );
+	}
+
+	/**
+	 * Bug: permalink doesn't work if post title is empty.
+	 *
+	 * Might only fail if the post ID is greater than four characters.
+	 *
+	 * @ticket 5305
+	 */
+	public function test_permalink_without_title() {
+		$this->set_permalink_structure( '/%year%/%monthnum%/%day%/%postname%/' );
+
+		$data = array(
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => '',
+			'post_date'    => '2007-10-31 06:15:00',
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		// Permalink should include the post ID at the end.
+		$expected = get_option( 'siteurl' ) . '/2007/10/31/' . $post_id . '/';
+		$this->assertSame( $expected, get_permalink( $post_id ) );
+	}
+
+	/**
+	 * @ticket 23708
+	 */
+	public function test_get_post_ancestors_within_loop() {
+		global $post;
+
+		$parent_id = self::factory()->post->create();
+		$post      = self::factory()->post->create_and_get(
+			array(
+				'post_parent' => $parent_id,
+			)
+		);
+
+		$this->assertSame( array( $parent_id ), get_post_ancestors( 0 ) );
+	}
+
+	/**
+	 * @ticket 23474
+	 * @covers ::wp_update_post
+	 */
+	public function test_update_invalid_post_id() {
+		$post_id = self::factory()->post->create();
+		$post    = get_post( $post_id, ARRAY_A );
+
+		$post['ID'] = 123456789;
+
+		$this->assertSame( 0, wp_insert_post( $post ) );
+		$this->assertSame( 0, wp_update_post( $post ) );
+
+		$this->assertInstanceOf( 'WP_Error', wp_insert_post( $post, true ) );
+		$this->assertInstanceOf( 'WP_Error', wp_update_post( $post, true ) );
+
+	}
+
+	/**
+	 * @ticket 19373
+	 */
+	public function test_insert_programmatic_sanitized() {
+		$this->unset_current_user();
+
+		register_taxonomy( 'test_tax', 'post' );
+
+		$title = 'title';
+		$data  = array(
+			'post_author'  => self::$user_ids['editor'],
+			'post_status'  => 'publish',
+			'post_content' => 'content',
+			'post_title'   => $title,
+			'tax_input'    => array(
+				'test_tax' => array( 'term', 'term2', 'term3' ),
+			),
+		);
+
+		$post_id = wp_insert_post( $data, true, true );
+		$this->assertIsInt( $post_id );
+		$this->assertGreaterThan( 0, $post_id );
+
+		$post = get_post( $post_id );
+		$this->assertEquals( self::$user_ids['editor'], $post->post_author );
+		$this->assertSame( $title, $post->post_title );
+	}
+
+	/**
+	 * @ticket 31168
+	 */
+	public function test_wp_insert_post_default_comment_ping_status_open() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status' => 'publish',
+			)
+		);
+		$post    = get_post( $post_id );
+
+		$this->assertSame( 'open', $post->comment_status );
+		$this->assertSame( 'open', $post->ping_status );
+	}
+
+	/**
+	 * @ticket 31168
+	 */
+	public function test_wp_insert_post_page_default_comment_ping_status_closed() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status' => 'publish',
+				'post_type'   => 'page',
+			)
+		);
+		$post    = get_post( $post_id );
+
+		$this->assertSame( 'closed', $post->comment_status );
+		$this->assertSame( 'closed', $post->ping_status );
+	}
+
+	/**
+	 * @ticket 31168
+	 */
+	public function test_wp_insert_post_cpt_default_comment_ping_status_open() {
+		register_post_type(
+			'cpt',
+			array(
+				'supports' => array( 'comments', 'trackbacks' ),
+			)
+		);
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status' => 'publish',
+				'post_type'   => 'cpt',
+			)
+		);
+		$post    = get_post( $post_id );
+
+		_unregister_post_type( 'cpt' );
+
+		$this->assertSame( 'open', $post->comment_status );
+		$this->assertSame( 'open', $post->ping_status );
+	}
+
+	/**
+	 * @ticket 31168
+	 */
+	public function test_wp_insert_post_cpt_default_comment_ping_status_closed() {
+		register_post_type( 'cpt' );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status' => 'publish',
+				'post_type'   => 'cpt',
+			)
+		);
+		$post    = get_post( $post_id );
+
+		_unregister_post_type( 'cpt' );
+
+		$this->assertSame( 'closed', $post->comment_status );
+		$this->assertSame( 'closed', $post->ping_status );
+	}
+
+	/**
+	 * If a post is updated without providing a post_name param,
+	 * a new slug should not be generated.
+	 *
+	 * @ticket 34865
+	 */
+	public function test_post_updates_without_slug_provided() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_title'  => 'Stuff',
+				'post_status' => 'publish',
+			)
+		);
+
+		$data = array(
+			'ID'         => $post_id,
+			'post_title' => 'Stuff and Things',
+		);
+
+		wp_insert_post( $data );
+
+		$updated_post = get_post( $post_id );
+		// Ensure changing the post_title didn't modify the post_name.
+		$this->assertSame( 'stuff', $updated_post->post_name );
+	}
+
+	/**
+	 * @ticket 32585
+	 */
+	public function test_wp_insert_post_author_zero() {
+		$post_id = self::factory()->post->create( array( 'post_author' => 0 ) );
+
+		$this->assertEquals( 0, get_post( $post_id )->post_author );
+	}
+
+	/**
+	 * @ticket 32585
+	 */
+	public function test_wp_insert_post_author_null() {
+		wp_set_current_user( self::$user_ids['editor'] );
+
+		$post_id = self::factory()->post->create( array( 'post_author' => null ) );
+
+		$this->assertEquals( self::$user_ids['editor'], get_post( $post_id )->post_author );
+	}
+
+	/**
+	 * @ticket 15946
+	 */
+	public function test_wp_insert_post_should_respect_post_date_gmt() {
+		$data = array(
+			'post_status'   => 'publish',
+			'post_content'  => 'content',
+			'post_title'    => 'title',
+			'post_date_gmt' => '2014-01-01 12:00:00',
+		);
+
+		// Insert a post and make sure the ID is OK.
+		$post_id = wp_insert_post( $data );
+
+		$post = get_post( $post_id );
+
+		$this->assertSame( $data['post_content'], $post->post_content );
+		$this->assertSame( $data['post_title'], $post->post_title );
+		$this->assertSame( get_date_from_gmt( $data['post_date_gmt'] ), $post->post_date );
+		$this->assertSame( $data['post_date_gmt'], $post->post_date_gmt );
+	}
+
+	/**
+	 * Test ensuring that the post_name (UUID) is preserved when wp_insert_post()/wp_update_post() is called.
+	 *
+	 * @see _wp_customize_changeset_filter_insert_post_data()
+	 * @ticket 30937
+	 */
+	public function test_wp_insert_post_for_customize_changeset_should_not_drop_post_name() {
+		$this->assertSame( 10, has_filter( 'wp_insert_post_data', '_wp_customize_changeset_filter_insert_post_data' ) );
+
+		$changeset_data = array(
+			'blogname' => array(
+				'value' => 'Hello World',
+			),
+		);
+
+		wp_set_current_user( self::$user_ids['contributor'] );
+
+		$uuid    = wp_generate_uuid4();
+		$post_id = wp_insert_post(
+			array(
+				'post_type'    => 'customize_changeset',
+				'post_name'    => strtoupper( $uuid ),
+				'post_content' => wp_json_encode( $changeset_data ),
+			)
+		);
+		$this->assertSame( $uuid, get_post( $post_id )->post_name, 'Expected lower-case UUID4 to be inserted.' );
+		$this->assertSame( $changeset_data, json_decode( get_post( $post_id )->post_content, true ) );
+
+		$changeset_data['blogname']['value'] = 'Hola Mundo';
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_status'  => 'draft',
+				'post_content' => wp_json_encode( $changeset_data ),
+			)
+		);
+		$this->assertSame( $uuid, get_post( $post_id )->post_name, 'Expected post_name to not have been dropped for drafts.' );
+		$this->assertSame( $changeset_data, json_decode( get_post( $post_id )->post_content, true ) );
+
+		$changeset_data['blogname']['value'] = 'Hallo Welt';
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_status'  => 'pending',
+				'post_content' => wp_json_encode( $changeset_data ),
+			)
+		);
+		$this->assertSame( $uuid, get_post( $post_id )->post_name, 'Expected post_name to not have been dropped for pending.' );
+		$this->assertSame( $changeset_data, json_decode( get_post( $post_id )->post_content, true ) );
+	}
+
+	/**
+	 * @ticket 19954
+	 */
+	function test_updating_a_post_should_not_trash_categories() {
+		// Create a category and attach it to a new post.
+		$term_id = self::factory()->term->create(
+			array(
+				'name'     => 'Term',
+				'taxonomy' => 'category',
+			)
+		);
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_type'     => 'post',
+				'post_title'    => 'Post with categories',
+				'post_status'   => 'publish',
+				'post_category' => array( $term_id ),
+			)
+		);
+
+		// Validate that the term got assigned.
+		$assigned_terms = wp_get_object_terms( array( $post_id ), array( 'category' ), array() );
+		$this->assertCount( 1, $assigned_terms );
+		$this->assertEquals( $term_id, $assigned_terms[0]->term_id );
+
+		// Update the post with no changes.
+		$post = get_post( $post_id );
+		wp_insert_post( $post );
+
+		// Validate the term is still assigned.
+		$assigned_terms = wp_get_object_terms( array( $post_id ), array( 'category' ), array() );
+		$this->assertCount( 1, $assigned_terms );
+		$this->assertEquals( $term_id, $assigned_terms[0]->term_id );
+
+		// Remove the term from the post.
+		$post->post_category = array();
+		wp_insert_post( $post );
+		$assigned_terms = wp_get_object_terms( array( $post_id ), array( 'category' ), array() );
+
+		// Validate that the post has had the default category assigned again.
+		$this->assertCount( 1, $assigned_terms );
+		$this->assertEquals( get_option( 'default_category' ), $assigned_terms[0]->term_id );
+	}
+
+	/**
+	 * @ticket 48113
+	 */
+	public function test_insert_post_should_respect_date_floating_post_status_arg() {
+		register_post_status( 'floating', array( 'date_floating' => true ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status'   => 'floating',
+				'post_date'     => null,
+				'post_date_gmt' => null,
+			)
+		);
+
+		$post = get_post( $post_id );
+		self::assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 48113
+	 */
+	public function test_insert_post_should_respect_date_floating_post_status_arg_not_set() {
+		register_post_status( 'not-floating', array( 'date_floating' => false ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status'   => 'floating',
+				'post_date'     => null,
+				'post_date_gmt' => null,
+			)
+		);
+
+		$post = get_post( $post_id );
+		self::assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( $post->post_date_gmt ),
+			2,
+			'The dates should be equal'
+		);
+	}
+
+	/**
+	 * Test ensuring that wp_update_post() does not unintentionally modify post tags
+	 * if the post has several tags with the same name but different slugs.
+	 *
+	 * Tags should only be modified if 'tags_input' parameter was explicitly provided,
+	 * and is different from the existing tags.
+	 *
+	 * @ticket 45121
+	 * @covers ::wp_update_post
+	 */
+	public function test_update_post_should_only_modify_post_tags_if_different_tags_input_was_provided() {
+		$tag_1 = wp_insert_term( 'wp_update_post_tag', 'post_tag', array( 'slug' => 'wp_update_post_tag_1' ) );
+		$tag_2 = wp_insert_term( 'wp_update_post_tag', 'post_tag', array( 'slug' => 'wp_update_post_tag_2' ) );
+		$tag_3 = wp_insert_term( 'wp_update_post_tag', 'post_tag', array( 'slug' => 'wp_update_post_tag_3' ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'tags_input' => array( $tag_1['term_id'], $tag_2['term_id'] ),
+			)
+		);
+
+		$post = get_post( $post_id );
+
+		$tags = wp_get_post_tags( $post->ID, array( 'fields' => 'ids' ) );
+		$this->assertSameSets( array( $tag_1['term_id'], $tag_2['term_id'] ), $tags );
+
+		wp_update_post( $post );
+
+		$tags = wp_get_post_tags( $post->ID, array( 'fields' => 'ids' ) );
+		$this->assertSameSets( array( $tag_1['term_id'], $tag_2['term_id'] ), $tags );
+
+		wp_update_post(
+			array(
+				'ID'         => $post->ID,
+				'tags_input' => array( $tag_2['term_id'], $tag_3['term_id'] ),
+			)
+		);
+
+		$tags = wp_get_post_tags( $post->ID, array( 'fields' => 'ids' ) );
+		$this->assertSameSets( array( $tag_2['term_id'], $tag_3['term_id'] ), $tags );
+	}
+
+	/**
+	 * @ticket 52187
+	 */
+	public function test_insert_empty_post_date() {
+		$post_date_gmt = '2020-12-29 10:11:45';
+		$invalid_date  = '2020-12-41 14:15:27';
+
+		// Empty post_date_gmt with floating status
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status' => 'draft',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( $post->post_date ),
+			2,
+			'The dates should be equal'
+		);
+		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date_gmt' => '0000-00-00 00:00:00',
+				'post_status'   => 'draft',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( $post->post_date ),
+			2,
+			'The dates should be equal'
+		);
+		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		// Empty post_date_gmt without floating status
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status' => 'publish',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( $post->post_date ),
+			2,
+			'The dates should be equal'
+		);
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( get_gmt_from_date( $post->post_date ) ),
+			2,
+			'The dates should be equal'
+		);
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date_gmt' => '0000-00-00 00:00:00',
+				'post_status'   => 'publish',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( $post->post_date ),
+			2,
+			'The dates should be equal'
+		);
+		$this->assertEqualsWithDelta(
+			strtotime( gmdate( 'Y-m-d H:i:s' ) ),
+			strtotime( get_gmt_from_date( $post->post_date ) ),
+			2,
+			'The dates should be equal'
+		);
+
+		// Valid post_date_gmt
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date_gmt' => $post_date_gmt,
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( get_date_from_gmt( $post_date_gmt ), $post->post_date );
+		$this->assertSame( $post_date_gmt, $post->post_date_gmt );
+
+		// Invalid post_date_gmt
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date_gmt' => $invalid_date,
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( '1970-01-01 00:00:00', $post->post_date );
+		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 52187
+	 */
+	public function test_insert_valid_post_date() {
+		$post_date     = '2020-12-28 11:26:35';
+		$post_date_gmt = '2020-12-29 10:11:45';
+		$invalid_date  = '2020-12-41 14:15:27';
+
+		// Empty post_date_gmt with floating status
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'   => $post_date,
+				'post_status' => 'draft',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( $post_date, $post->post_date );
+		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $post_date,
+				'post_date_gmt' => '0000-00-00 00:00:00',
+				'post_status'   => 'draft',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( $post_date, $post->post_date );
+		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		// Empty post_date_gmt without floating status
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'   => $post_date,
+				'post_status' => 'publish',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( $post_date, $post->post_date );
+		$this->assertSame( get_gmt_from_date( $post_date ), $post->post_date_gmt );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $post_date,
+				'post_date_gmt' => '0000-00-00 00:00:00',
+				'post_status'   => 'publish',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( $post_date, $post->post_date );
+		$this->assertSame( get_gmt_from_date( $post_date ), $post->post_date_gmt );
+
+		// Valid post_date_gmt
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $post_date,
+				'post_date_gmt' => $post_date_gmt,
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( $post_date, $post->post_date );
+		$this->assertSame( $post_date_gmt, $post->post_date_gmt );
+
+		// Invalid post_date_gmt
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $post_date,
+				'post_date_gmt' => $invalid_date,
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( $post_date, $post->post_date );
+		$this->assertSame( '0000-00-00 00:00:00', $post->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 52187
+	 */
+	public function test_insert_invalid_post_date() {
+		$post_date     = '2020-12-28 11:26:35';
+		$post_date_gmt = '2020-12-29 10:11:45';
+		$invalid_date  = '2020-12-41 14:15:27';
+
+		// Empty post_date_gmt with floating status
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'   => $invalid_date,
+				'post_status' => 'draft',
+			)
+		);
+		$this->assertSame( 0, $post_id );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $invalid_date,
+				'post_date_gmt' => '0000-00-00 00:00:00',
+				'post_status'   => 'draft',
+			)
+		);
+		$this->assertSame( 0, $post_id );
+
+		// Empty post_date_gmt without floating status
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'   => $invalid_date,
+				'post_status' => 'publish',
+			)
+		);
+		$this->assertSame( 0, $post_id );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $invalid_date,
+				'post_date_gmt' => '0000-00-00 00:00:00',
+				'post_status'   => 'publish',
+			)
+		);
+		$this->assertSame( 0, $post_id );
+
+		// Valid post_date_gmt
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $invalid_date,
+				'post_date_gmt' => $post_date_gmt,
+			)
+		);
+		$this->assertSame( 0, $post_id );
+
+		// Invalid post_date_gmt
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $invalid_date,
+				'post_date_gmt' => $invalid_date,
+			)
+		);
+		$this->assertSame( 0, $post_id );
+	}
+
 	/**
 	 * @ticket 11863
 	 */
@@ -216,17 +1391,13 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 	 * @return array Array of test arguments.
 	 */
 	public function data_various_post_types() {
-		return array(
-			array(
-				'mapped_meta_caps',
-			),
-			array(
-				'unmapped_meta_caps',
-			),
-			array(
-				'post',
-			),
+		$post_types = array(
+			'mapped_meta_caps',
+			'unmapped_meta_caps',
+			'post',
 		);
+
+		return $this->text_array_to_dataprovider( $post_types );
 	}
 
 	/**
@@ -235,20 +1406,14 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 	 * @return array Array of test arguments.
 	 */
 	public function data_various_post_statuses() {
-		return array(
-			array(
-				'draft',
-			),
-			array(
-				'pending',
-			),
-			array(
-				'private',
-			),
-			array(
-				'publish',
-			),
+		$post_statuses = array(
+			'draft',
+			'pending',
+			'private',
+			'publish',
 		);
+
+		return $this->text_array_to_dataprovider( $post_statuses );
 	}
 
 	/**
@@ -260,7 +1425,7 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 	public function test_contributor_cannot_set_post_slug( $post_type ) {
 		wp_set_current_user( self::$user_ids['contributor'] );
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_title'   => 'Jefferson claim: nice to have Washington on your side.',
 				'post_content' => "I’m in the cabinet. I am complicit in watching him grabbin’ at power and kiss it.\n\nIf Washington isn’t gon’ listen to disciplined dissidents, this is the difference: this kid is out!",
@@ -299,7 +1464,7 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 	public function test_administrator_can_set_post_slug( $post_type ) {
 		wp_set_current_user( self::$user_ids['administrator'] );
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_title'   => 'What is the Conner Project?',
 				'post_content' => 'Evan Hansen’s last link to his friend Conner is a signature on his broken arm.',
@@ -340,7 +1505,7 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 	public function test_administrator_cannot_set_post_slug_on_post_type_they_cannot_publish() {
 		wp_set_current_user( self::$user_ids['administrator'] );
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_title'   => 'Everything is legal in New Jersey',
 				'post_content' => 'Shortly before his death, Philip Hamilton was heard to claim everything was legal in the garden state.',
@@ -377,7 +1542,7 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 
 		$now = new DateTimeImmutable( 'now', new DateTimeZone( 'UTC' ) );
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_date_gmt' => $now->modify( '-1 year' )->format( 'Y-m-d H:i:s' ),
 				'post_status'   => 'future',
@@ -386,7 +1551,7 @@ class Tests_Post_wpInsertPost extends WP_UnitTestCase {
 
 		$this->assertSame( 'publish', get_post_status( $post_id ) );
 
-		$post_id = $this->factory()->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_date_gmt' => $now->modify( '+50 years' )->format( 'Y-m-d H:i:s' ),
 				'post_status'   => 'future',
diff --git a/tests/post/wpPostType.php b/tests/post/wpPostType.php
index c08af7a142..8443c804ad 100644
--- a/tests/post/wpPostType.php
+++ b/tests/post/wpPostType.php
@@ -216,4 +216,17 @@ class Tests_Post_WP_Post_Type extends WP_UnitTestCase {
 		$this->assertSameSets( array( 'post_tag' ), $taxonomies );
 		$this->assertSameSets( array(), $taxonomies_after );
 	}
+
+	public function test_applies_registration_args_filters() {
+		$post_type = 'cpt';
+		$action    = new MockAction();
+
+		add_filter( 'register_post_type_args', array( $action, 'filter' ) );
+		add_filter( "register_{$post_type}_post_type_args", array( $action, 'filter' ) );
+
+		new WP_Post_Type( $post_type );
+		new WP_Post_Type( 'random' );
+
+		$this->assertSame( 3, $action->get_call_count() );
+	}
 }
diff --git a/tests/post/wpPublishPost.php b/tests/post/wpPublishPost.php
index 609ae7570a..25fa87a71c 100644
--- a/tests/post/wpPublishPost.php
+++ b/tests/post/wpPublishPost.php
@@ -2,6 +2,7 @@
 
 /**
  * @group post
+ * @covers ::wp_publish_post
  */
 class Tests_Post_wpPublishPost extends WP_UnitTestCase {
 
@@ -21,6 +22,119 @@ class Tests_Post_wpPublishPost extends WP_UnitTestCase {
 		self::$auto_draft_id = $factory->post->create( array( 'post_status' => 'auto-draft' ) );
 	}
 
+	public function test_wp_publish_post() {
+		$draft_id = self::factory()->post->create(
+			array(
+				'post_status' => 'draft',
+			)
+		);
+
+		$post = get_post( $draft_id );
+		$this->assertSame( 'draft', $post->post_status );
+
+		wp_publish_post( $draft_id );
+
+		$post = get_post( $draft_id );
+		$this->assertSame( 'publish', $post->post_status );
+	}
+
+	/**
+	 * @ticket 22944
+	 * @covers ::wp_insert_post
+	 */
+	public function test_wp_insert_post_and_wp_publish_post_with_future_date() {
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 10000000 );
+		$post_id     = self::factory()->post->create(
+			array(
+				'post_status' => 'publish',
+				'post_date'   => $future_date,
+			)
+		);
+
+		$post = get_post( $post_id );
+		$this->assertSame( 'future', $post->post_status );
+		$this->assertSame( $future_date, $post->post_date );
+
+		wp_publish_post( $post_id );
+
+		$post = get_post( $post_id );
+		$this->assertSame( 'publish', $post->post_status );
+		$this->assertSame( $future_date, $post->post_date );
+	}
+
+	/**
+	 * @ticket 48145
+	 * @covers ::wp_insert_post
+	 */
+	public function test_wp_insert_post_should_default_to_publish_if_post_date_is_within_59_seconds_from_current_time() {
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 59 );
+		$post_id     = self::factory()->post->create(
+			array(
+				'post_date' => $future_date,
+			)
+		);
+
+		$post = get_post( $post_id );
+		$this->assertSame( 'publish', $post->post_status );
+		$this->assertSame( $future_date, $post->post_date );
+	}
+
+	/**
+	 * @ticket 22944
+	 * @covers ::wp_update_post
+	 */
+	public function test_wp_update_post_with_content_filtering() {
+		kses_remove_filters();
+
+		$post_id = wp_insert_post(
+			array(
+				'post_title' => '<script>Test</script>',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( '<script>Test</script>', $post->post_title );
+		$this->assertSame( 'draft', $post->post_status );
+
+		kses_init_filters();
+
+		wp_update_post(
+			array(
+				'ID'          => $post->ID,
+				'post_status' => 'publish',
+			)
+		);
+
+		kses_remove_filters();
+
+		$post = get_post( $post->ID );
+		$this->assertSame( 'Test', $post->post_title );
+	}
+
+	/**
+	 * @ticket 22944
+	 */
+	public function test_wp_publish_post_and_avoid_content_filtering() {
+		kses_remove_filters();
+
+		$post_id = wp_insert_post(
+			array(
+				'post_title' => '<script>Test</script>',
+			)
+		);
+		$post    = get_post( $post_id );
+		$this->assertSame( '<script>Test</script>', $post->post_title );
+		$this->assertSame( 'draft', $post->post_status );
+
+		kses_init_filters();
+
+		wp_publish_post( $post->ID );
+
+		kses_remove_filters();
+
+		$post = get_post( $post->ID );
+		$this->assertSame( '<script>Test</script>', $post->post_title );
+	}
+
 	/**
 	 * Ensure wp_publish_post does not add default category in error.
 	 *
@@ -28,7 +142,7 @@ class Tests_Post_wpPublishPost extends WP_UnitTestCase {
 	 */
 	public function test_wp_publish_post_respects_current_categories() {
 		$post_id     = self::$auto_draft_id;
-		$category_id = $this->factory->term->create( array( 'taxonomy' => 'category' ) );
+		$category_id = self::factory()->term->create( array( 'taxonomy' => 'category' ) );
 		wp_set_post_categories( $post_id, $category_id );
 		wp_publish_post( $post_id );
 
@@ -69,7 +183,7 @@ class Tests_Post_wpPublishPost extends WP_UnitTestCase {
 	 */
 	public function test_wp_publish_post_adds_default_category_when_tagged() {
 		$post_id = self::$auto_draft_id;
-		$tag_id  = $this->factory->term->create( array( 'taxonomy' => 'post_tag' ) );
+		$tag_id  = self::factory()->term->create( array( 'taxonomy' => 'post_tag' ) );
 		wp_set_post_tags( $post_id, array( $tag_id ) );
 		wp_publish_post( $post_id );
 
@@ -104,7 +218,7 @@ class Tests_Post_wpPublishPost extends WP_UnitTestCase {
 		);
 
 		$post_id = self::$auto_draft_id;
-		$term_id = $this->factory->term->create( array( 'taxonomy' => 'tax_51292' ) );
+		$term_id = self::factory()->term->create( array( 'taxonomy' => 'tax_51292' ) );
 		wp_set_object_terms( $post_id, array( $term_id ), 'tax_51292' );
 		wp_publish_post( $post_id );
 
diff --git a/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php b/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
index a322778941..784845821e 100644
--- a/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
+++ b/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
@@ -12,6 +12,7 @@
  *
  * @group privacy
  * @covers ::wp_privacy_generate_personal_data_export_file
+ * @requires extension zip
  *
  * @since 5.2.0
  */
@@ -43,6 +44,13 @@ class Tests_Privacy_wpPrivacyGeneratePersonalDataExportFile extends WP_UnitTestC
 	 */
 	public static $exports_dir;
 
+	/**
+	 * Original error level.
+	 *
+	 * @var int
+	 */
+	private $orig_error_level;
+
 	/**
 	 * Create fixtures that are shared by multiple test cases.
 	 *
@@ -68,10 +76,6 @@ class Tests_Privacy_wpPrivacyGeneratePersonalDataExportFile extends WP_UnitTestC
 
 		$this->export_file_name = '';
 
-		if ( ! class_exists( 'ZipArchive' ) ) {
-			$this->markTestSkipped( 'The ZipArchive class is missing.' );
-		}
-
 		if ( ! $this->remove_exports_dir() ) {
 			$this->markTestSkipped( 'Existing exports directory could not be removed. Skipping test.' );
 		}
@@ -82,8 +86,8 @@ class Tests_Privacy_wpPrivacyGeneratePersonalDataExportFile extends WP_UnitTestC
 		add_action( 'wp_privacy_personal_data_export_file_created', array( $this, 'action_wp_privacy_personal_data_export_file_created' ) );
 
 		// Suppress warnings from "Cannot modify header information - headers already sent by".
-		$this->_error_level = error_reporting();
-		error_reporting( $this->_error_level & ~E_WARNING );
+		$this->orig_error_level = error_reporting();
+		error_reporting( $this->orig_error_level & ~E_WARNING );
 	}
 
 	/**
@@ -95,7 +99,7 @@ class Tests_Privacy_wpPrivacyGeneratePersonalDataExportFile extends WP_UnitTestC
 	 */
 	public function tear_down() {
 		$this->remove_exports_dir();
-		error_reporting( $this->_error_level );
+		error_reporting( $this->orig_error_level );
 		parent::tear_down();
 	}
 
diff --git a/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php b/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
index 9653c79818..e8d94d4a77 100644
--- a/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
+++ b/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
@@ -140,6 +140,13 @@ class Tests_Privacy_wpPrivacyProcessPersonalDataExportPage extends WP_UnitTestCa
 	 */
 	public $_export_data_grouped_fetched_within_callback;
 
+	/**
+	 * Original error level.
+	 *
+	 * @var int
+	 */
+	private $orig_error_level;
+
 	/**
 	 * Create user request fixtures shared by test methods.
 	 *
@@ -209,8 +216,8 @@ class Tests_Privacy_wpPrivacyProcessPersonalDataExportPage extends WP_UnitTestCa
 		add_filter( 'wp_die_ajax_handler', array( $this, 'get_wp_die_handler' ), 1, 1 );
 
 		// Suppress warnings from "Cannot modify header information - headers already sent by".
-		$this->_error_level = error_reporting();
-		error_reporting( $this->_error_level & ~E_WARNING );
+		$this->orig_error_level = error_reporting();
+		error_reporting( $this->orig_error_level & ~E_WARNING );
 	}
 
 	/**
@@ -219,7 +226,7 @@ class Tests_Privacy_wpPrivacyProcessPersonalDataExportPage extends WP_UnitTestCa
 	 * @since 5.2.0
 	 */
 	public function tear_down() {
-		error_reporting( $this->_error_level );
+		error_reporting( $this->orig_error_level );
 
 		parent::tear_down();
 	}
diff --git a/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php b/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
index 96b4e0ecd9..ef71a5f85d 100644
--- a/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
+++ b/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
@@ -131,7 +131,7 @@ class Tests_Privacy_wpPrivacySendErasureFulfillmentNotification extends WP_UnitT
 	 * @ticket 44234
 	 */
 	public function test_should_send_email_with_privacy_policy() {
-		$privacy_policy = $this->factory->post->create(
+		$privacy_policy = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'title'       => 'Site Privacy Policy',
@@ -307,7 +307,7 @@ class Tests_Privacy_wpPrivacySendErasureFulfillmentNotification extends WP_UnitT
 	 * @ticket 44234
 	 */
 	public function test_should_not_send_email_when_not_user_request() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_type' => 'post', // Should be 'user_request'.
 			)
diff --git a/tests/privacy/wpPrivacySendRequestConfirmationNotification.php b/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
index f2933bdda0..ee083b30c6 100644
--- a/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
+++ b/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
@@ -55,7 +55,7 @@ class Tests_Privacy_wpPrivacySendRequestConfirmationNotification extends WP_Unit
 	 * @ticket 43967
 	 */
 	public function test_function_should_not_send_email_when_not_a_wp_user_request() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_type' => 'post',
 			)
diff --git a/tests/query.php b/tests/query.php
index 8dfd3fb200..fef3e19748 100644
--- a/tests/query.php
+++ b/tests/query.php
@@ -644,19 +644,19 @@ class Tests_Query extends WP_UnitTestCase {
 		register_taxonomy( 'tax1', 'post' );
 		register_taxonomy( 'tax2', 'post' );
 
-		$term1   = $this->factory->term->create(
+		$term1   = self::factory()->term->create(
 			array(
 				'taxonomy' => 'tax1',
 				'name'     => 'term1',
 			)
 		);
-		$term2   = $this->factory->term->create(
+		$term2   = self::factory()->term->create(
 			array(
 				'taxonomy' => 'tax2',
 				'name'     => 'term2',
 			)
 		);
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 		wp_set_object_terms( $post_id, 'term1', 'tax1' );
 		wp_set_object_terms( $post_id, 'term2', 'tax2' );
 
@@ -674,19 +674,19 @@ class Tests_Query extends WP_UnitTestCase {
 		register_taxonomy( 'tax1', 'post' );
 		register_taxonomy( 'tax2', 'post' );
 
-		$term1   = $this->factory->term->create(
+		$term1   = self::factory()->term->create(
 			array(
 				'taxonomy' => 'tax1',
 				'name'     => 'term1',
 			)
 		);
-		$term2   = $this->factory->term->create(
+		$term2   = self::factory()->term->create(
 			array(
 				'taxonomy' => 'tax2',
 				'name'     => 'term2',
 			)
 		);
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 		wp_set_object_terms( $post_id, 'term1', 'tax1' );
 		wp_set_object_terms( $post_id, 'term2', 'tax2' );
 
@@ -696,4 +696,77 @@ class Tests_Query extends WP_UnitTestCase {
 		$this->assertSame( 'tax1', get_query_var( 'taxonomy' ) );
 		$this->assertSame( 'term1', get_query_var( 'term' ) );
 	}
+
+	/**
+	 * @ticket 55100
+	 */
+	public function test_get_queried_object_should_work_for_author_name_before_get_posts() {
+		$user_id = self::factory()->user->create();
+		$user    = get_user_by( 'ID', $user_id );
+		$post_id = self::factory()->post->create(
+			array(
+				'post_author' => $user_id,
+			)
+		);
+
+		$this->go_to( home_url( '?author=' . $user_id ) );
+
+		$this->assertInstanceOf( 'WP_User', get_queried_object() );
+		$this->assertSame( get_queried_object_id(), $user_id );
+
+		$this->go_to( home_url( '?author_name=' . $user->user_nicename ) );
+
+		$this->assertInstanceOf( 'WP_User', get_queried_object() );
+		$this->assertSame( get_queried_object_id(), $user_id );
+	}
+
+	/**
+	 * Tests that the `posts_clauses` filter receives an array of clauses
+	 * with the other `posts_*` filters applied, e.g. `posts_join_paged`.
+	 *
+	 * @ticket 55699
+	 * @covers WP_Query::get_posts
+	 */
+	public function test_posts_clauses_filter_should_receive_filtered_clauses() {
+		add_filter(
+			'posts_join_paged',
+			static function() {
+				return '/* posts_join_paged */';
+			}
+		);
+
+		$filter = new MockAction();
+		add_filter( 'posts_clauses', array( $filter, 'filter' ), 10, 2 );
+		$this->go_to( '/' );
+		$filter_args   = $filter->get_args();
+		$posts_clauses = $filter_args[0][0];
+
+		$this->assertArrayHasKey( 'join', $posts_clauses );
+		$this->assertSame( '/* posts_join_paged */', $posts_clauses['join'] );
+	}
+
+	/**
+	 * Tests that the `posts_clauses_request` filter receives an array of clauses
+	 * with the other `posts_*_request` filters applied, e.g. `posts_join_request`.
+	 *
+	 * @ticket 55699
+	 * @covers WP_Query::get_posts
+	 */
+	public function test_posts_clauses_request_filter_should_receive_filtered_clauses() {
+		add_filter(
+			'posts_join_request',
+			static function() {
+				return '/* posts_join_request */';
+			}
+		);
+
+		$filter = new MockAction();
+		add_filter( 'posts_clauses_request', array( $filter, 'filter' ), 10, 2 );
+		$this->go_to( '/' );
+		$filter_args           = $filter->get_args();
+		$posts_clauses_request = $filter_args[0][0];
+
+		$this->assertArrayHasKey( 'join', $posts_clauses_request );
+		$this->assertSame( '/* posts_join_request */', $posts_clauses_request['join'] );
+	}
 }
diff --git a/tests/query/cacheResults.php b/tests/query/cacheResults.php
new file mode 100644
index 0000000000..d93b5ae9f1
--- /dev/null
+++ b/tests/query/cacheResults.php
@@ -0,0 +1,987 @@
+<?php
+
+/**
+ * @group query
+ * @covers WP_Query::get_posts
+ */
+class Test_Query_CacheResults extends WP_UnitTestCase {
+	/**
+	 * Page IDs.
+	 *
+	 * @var int[]
+	 */
+	public static $pages;
+
+	/**
+	 * Post IDs.
+	 *
+	 * @var int[]
+	 */
+	public static $posts;
+
+	/**
+	 * Term ID.
+	 *
+	 * @var int
+	 */
+	public static $t1;
+
+	/**
+	 * Author's user ID.
+	 *
+	 * @var int
+	 */
+	public static $author_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		// Make some post objects.
+		self::$posts = $factory->post->create_many( 5 );
+		self::$pages = $factory->post->create_many( 5, array( 'post_type' => 'page' ) );
+
+		self::$t1 = $factory->term->create(
+			array(
+				'taxonomy' => 'category',
+				'slug'     => 'foo',
+				'name'     => 'Foo',
+			)
+		);
+
+		wp_set_post_terms( self::$posts[0], self::$t1, 'category' );
+		add_post_meta( self::$posts[0], 'color', '#000000' );
+
+		// Make a user.
+		self::$author_id = $factory->user->create(
+			array(
+				'role' => 'author',
+			)
+		);
+	}
+
+	/**
+	 * @dataProvider data_query_cache
+	 * @ticket 22176
+	 */
+	public function test_query_cache( $args ) {
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		$queries_before = get_num_queries();
+		$query2         = new WP_Query();
+		$posts2         = $query2->query( $args );
+		$queries_after  = get_num_queries();
+
+		add_filter( 'split_the_query', '__return_false' );
+		$split_query = new WP_Query();
+		$split_posts = $split_query->query( $args );
+		remove_filter( 'split_the_query', '__return_false' );
+
+		if ( isset( $args['fields'] ) ) {
+			if ( 'all' !== $args['fields'] ) {
+				$this->assertSameSets( $posts1, $posts2, 'Second query produces different set of posts to first.' );
+				$this->assertSameSets( $posts1, $split_posts, 'Split query produces different set of posts to first.' );
+			}
+			if ( 'id=>parent' !== $args['fields'] ) {
+				$this->assertSame( $queries_after, $queries_before, 'Second query produces unexpected DB queries.' );
+			}
+		} else {
+			$this->assertSame( $queries_after, $queries_before, 'Second query produces unexpected DB queries.' );
+		}
+		$this->assertSame( $query1->found_posts, $query2->found_posts, 'Second query has a different number of found posts to first.' );
+		$this->assertSame( $query1->found_posts, $split_query->found_posts, 'Split query has a different number of found posts to first.' );
+		$this->assertSame( $query1->max_num_pages, $query2->max_num_pages, 'Second query has a different number of total to first.' );
+		$this->assertSame( $query1->max_num_pages, $split_query->max_num_pages, 'Split query has a different number of total to first.' );
+
+		if ( ! $query1->query_vars['no_found_rows'] ) {
+			wp_delete_post( self::$posts[0], true );
+			wp_delete_post( self::$pages[0], true );
+			$query3 = new WP_Query();
+			$query3->query( $args );
+
+			$this->assertNotSame( $query1->found_posts, $query3->found_posts );
+			$this->assertNotSame( $queries_after, get_num_queries() );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[] Test parameters.
+	 */
+	public function data_query_cache() {
+		return array(
+			'cache true'                                  => array(
+				'args' => array(
+					'cache_results' => true,
+				),
+			),
+			'cache true and pagination'                   => array(
+				'args' => array(
+					'cache_results'  => true,
+					'posts_per_page' => 3,
+					'page'           => 2,
+				),
+			),
+			'cache true and no pagination'                => array(
+				'args' => array(
+					'cache_results' => true,
+					'nopaging'      => true,
+				),
+			),
+			'cache true and post type any'                => array(
+				'args' => array(
+					'cache_results' => true,
+					'nopaging'      => true,
+					'post_type'     => 'any',
+				),
+			),
+			'cache true and get all'                      => array(
+				'args' => array(
+					'cache_results'  => true,
+					'fields'         => 'all',
+					'posts_per_page' => -1,
+					'post_status'    => 'any',
+					'post_type'      => 'any',
+				),
+			),
+			'cache true and page'                         => array(
+				'args' => array(
+					'cache_results' => true,
+					'post_type'     => 'page',
+				),
+			),
+			'cache true and ids'                          => array(
+				'args' => array(
+					'cache_results' => true,
+					'fields'        => 'ids',
+				),
+			),
+			'cache true and id=>parent and no found rows' => array(
+				'args' => array(
+					'cache_results' => true,
+					'fields'        => 'id=>parent',
+				),
+			),
+			'cache true and ids and no found rows'        => array(
+				'args' => array(
+					'no_found_rows' => true,
+					'cache_results' => true,
+					'fields'        => 'ids',
+				),
+			),
+			'cache true and id=>parent'                   => array(
+				'args' => array(
+					'no_found_rows' => true,
+					'cache_results' => true,
+					'fields'        => 'id=>parent',
+				),
+			),
+			'cache and ignore_sticky_posts'               => array(
+				'args' => array(
+					'cache_results'       => true,
+					'ignore_sticky_posts' => true,
+				),
+			),
+			'cache meta query'                            => array(
+				'args' => array(
+					'cache_results' => true,
+					'meta_query'    => array(
+						array(
+							'key' => 'color',
+						),
+					),
+				),
+			),
+			'cache comment_count'                         => array(
+				'args' => array(
+					'cache_results' => true,
+					'comment_count' => 0,
+				),
+			),
+			'cache term query'                            => array(
+				'args' => array(
+					'cache_results' => true,
+					'tax_query'     => array(
+						array(
+							'taxonomy' => 'category',
+							'terms'    => array( 'foo' ),
+							'field'    => 'slug',
+						),
+					),
+				),
+			),
+		);
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_seeded_random_queries_only_cache_post_objects() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'orderby'       => 'rand(6)',
+		);
+		$query1 = new WP_Query();
+		$query1->query( $args );
+		$queries_before = get_num_queries();
+
+		$query2 = new WP_Query();
+		$query2->query( $args );
+
+		$queries_after = get_num_queries();
+
+		$this->assertNotSame( $queries_before, $queries_after );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_unseeded_random_queries_only_cache_post_objects() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'orderby'       => 'rand',
+		);
+		$query1 = new WP_Query();
+		$query1->query( $args );
+		$queries_before = get_num_queries();
+
+		$query2 = new WP_Query();
+		$query2->query( $args );
+
+		$queries_after = get_num_queries();
+
+		$this->assertNotSame( $queries_before, $queries_after );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_filter_request() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+		);
+		$query1 = new WP_Query();
+		$query1->query( $args );
+		$queries_before = get_num_queries();
+
+		add_filter( 'posts_request', array( $this, 'filter_posts_request' ) );
+
+		$query2 = new WP_Query();
+		$query2->query( $args );
+
+		$queries_after = get_num_queries();
+
+		$this->assertNotSame( $queries_before, $queries_after );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_no_caching() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+		);
+		$query1 = new WP_Query();
+		$query1->query( $args );
+		$queries_before = get_num_queries();
+
+		$query2                = new WP_Query();
+		$args['cache_results'] = false;
+		$query2->query( $args );
+
+		$queries_after = get_num_queries();
+
+		$this->assertNotSame( $queries_before, $queries_after );
+	}
+
+	public function filter_posts_request( $request ) {
+		return $request . ' -- Add comment';
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_new_post() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		$p1 = self::factory()->post->create();
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_main_query_sticky_posts_change() {
+		add_action( 'parse_query', array( $this, 'set_cache_results' ) );
+		update_option( 'posts_per_page', 5 );
+
+		$old_date = date_create( '-25 hours' );
+		$old_post = self::factory()->post->create( array( 'post_date' => $old_date->format( 'Y-m-d H:i:s' ) ) );
+
+		// Post is unstuck.
+		$this->go_to( '/' );
+		$unstuck     = $GLOBALS['wp_query']->posts;
+		$unstuck_ids = wp_list_pluck( $unstuck, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+		$this->assertSame( $expected, $unstuck_ids );
+
+		// Stick the post.
+		stick_post( $old_post );
+
+		$this->go_to( '/' );
+		$stuck     = $GLOBALS['wp_query']->posts;
+		$stuck_ids = wp_list_pluck( $stuck, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+		array_unshift( $expected, $old_post );
+
+		$this->assertSame( $expected, $stuck_ids );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_main_query_in_query_sticky_posts_change() {
+		add_action( 'parse_query', array( $this, 'set_cache_results' ) );
+		update_option( 'posts_per_page', 5 );
+
+		$middle_post = self::$posts[2];
+
+		// Post is unstuck.
+		$this->go_to( '/' );
+		$unstuck     = $GLOBALS['wp_query']->posts;
+		$unstuck_ids = wp_list_pluck( $unstuck, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+		$this->assertSame( $expected, $unstuck_ids );
+
+		// Stick the post.
+		stick_post( $middle_post );
+
+		$this->go_to( '/' );
+		$stuck     = $GLOBALS['wp_query']->posts;
+		$stuck_ids = wp_list_pluck( $stuck, 'ID' );
+
+		$expected = array_diff( array_reverse( self::$posts ), array( $middle_post ) );
+		array_unshift( $expected, $middle_post );
+
+		$this->assertSame( $expected, $stuck_ids );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_sticky_posts_change() {
+		add_action( 'parse_query', array( $this, 'set_cache_results' ) );
+
+		$old_date = date_create( '-25 hours' );
+		$old_post = self::factory()->post->create( array( 'post_date' => $old_date->format( 'Y-m-d H:i:s' ) ) );
+
+		// Post is unstuck.
+		$unstuck     = new WP_Query( array( 'posts_per_page' => 5 ) );
+		$unstuck_ids = wp_list_pluck( $unstuck->posts, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+
+		$this->assertSame( $expected, $unstuck_ids );
+
+		// Stick the post.
+		stick_post( $old_post );
+
+		$stuck     = new WP_Query( array( 'posts_per_page' => 5 ) );
+		$stuck_ids = wp_list_pluck( $stuck->posts, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+		array_unshift( $expected, $old_post );
+
+		$this->assertSame( $expected, $stuck_ids );
+
+		// Ignore sticky posts.
+		$ignore_stuck     = new WP_Query(
+			array(
+				'posts_per_page'      => 5,
+				'ignore_sticky_posts' => true,
+			)
+		);
+		$ignore_stuck_ids = wp_list_pluck( $ignore_stuck->posts, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+
+		$this->assertSame( $expected, $ignore_stuck_ids );
+
+		// Just to make sure everything has changed.
+		$this->assertNotSame( $unstuck, $stuck );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_in_query_sticky_posts_change() {
+		add_action( 'parse_query', array( $this, 'set_cache_results' ) );
+
+		$middle_post = self::$posts[2];
+
+		// Post is unstuck.
+		$unstuck     = new WP_Query( array( 'posts_per_page' => 5 ) );
+		$unstuck_ids = wp_list_pluck( $unstuck->posts, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+
+		$this->assertSame( $expected, $unstuck_ids );
+
+		// Stick the post.
+		stick_post( $middle_post );
+
+		$stuck     = new WP_Query( array( 'posts_per_page' => 5 ) );
+		$stuck_ids = wp_list_pluck( $stuck->posts, 'ID' );
+
+		$expected = array_diff( array_reverse( self::$posts ), array( $middle_post ) );
+		array_unshift( $expected, $middle_post );
+
+		$this->assertSame( $expected, $stuck_ids );
+
+		// Ignore sticky posts.
+		$ignore_stuck     = new WP_Query(
+			array(
+				'posts_per_page'      => 5,
+				'ignore_sticky_posts' => true,
+			)
+		);
+		$ignore_stuck_ids = wp_list_pluck( $ignore_stuck->posts, 'ID' );
+
+		$expected = array_reverse( self::$posts );
+
+		$this->assertSame( $expected, $ignore_stuck_ids );
+
+		// Just to make sure everything has changed.
+		$this->assertNotSame( $unstuck, $stuck );
+	}
+
+	public function set_cache_results( $q ) {
+		$q->set( 'cache_results', true );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_different_args() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		$args           = array(
+			'cache_results'          => true,
+			'fields'                 => 'ids',
+			'suppress_filters'       => true,
+			'cache_results'          => true,
+			'update_post_meta_cache' => false,
+			'update_post_term_cache' => false,
+			'lazy_load_term_meta'    => false,
+		);
+		$queries_before = get_num_queries();
+		$query2         = new WP_Query();
+		$posts2         = $query2->query( $args );
+		$queries_after  = get_num_queries();
+
+		$this->assertSame( $queries_before, $queries_after );
+		$this->assertSame( $posts1, $posts2 );
+		$this->assertSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_different_fields() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'all',
+		);
+		$query1 = new WP_Query();
+		$query1->query( $args );
+
+		$args           = array(
+			'cache_results' => true,
+			'fields'        => 'id=>parent',
+		);
+		$queries_before = get_num_queries();
+		$query2         = new WP_Query();
+		$query2->query( $args );
+		$queries_after = get_num_queries();
+
+		$this->assertSame( $queries_before, $queries_after );
+		$this->assertCount( 5, $query1->posts );
+		$this->assertCount( 5, $query2->posts );
+		$this->assertSame( $query1->found_posts, $query2->found_posts );
+
+		/*
+		 * Make sure the returned post objects differ due to the field argument.
+		 *
+		 * This uses assertNotEquals rather than assertNotSame as the former is
+		 * agnostic to the instance ID of objects, whereas the latter will take
+		 * it in to account. The test needs to discard the instance ID when
+		 * confirming inequality.
+		 */
+		$this->assertNotEquals( $query1->posts, $query2->posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_logged_in() {
+		$user_id = self::$author_id;
+
+		self::factory()->post->create(
+			array(
+				'post_status' => 'private',
+				'post_author' => $user_id,
+			)
+		);
+
+		$args   = array(
+			'cache_results' => true,
+			'author'        => $user_id,
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		wp_set_current_user( $user_id );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+		$this->assertEmpty( $posts1 );
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_logged_in_password() {
+		$user_id = self::$author_id;
+		self::factory()->post->create(
+			array(
+				'post_title'    => 'foo',
+				'post_password' => 'password',
+				'post_author'   => $user_id,
+			)
+		);
+
+		$args   = array(
+			'cache_results' => true,
+			's'             => 'foo',
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		wp_set_current_user( $user_id );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+		$this->assertEmpty( $posts1 );
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_new_comment() {
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'comment_count' => 1,
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		self::factory()->comment->create( array( 'comment_post_ID' => self::$posts[0] ) );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( self::$posts[0], $posts2 );
+		$this->assertNotEmpty( $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_main_comments_feed_includes_attachment_comments() {
+		$attachment_id = self::factory()->post->create( array( 'post_type' => 'attachment' ) );
+		$comment_id    = self::factory()->comment->create(
+			array(
+				'comment_post_ID'  => $attachment_id,
+				'comment_approved' => '1',
+			)
+		);
+
+		$args   = array(
+			'cache_results' => true,
+			'withcomments'  => 1,
+			'feed'          => 'feed',
+		);
+		$query1 = new WP_Query();
+		$query1->query( $args );
+
+		$query2 = new WP_Query();
+		$query2->query( $args );
+
+		$this->assertTrue( $query1->have_comments() );
+		$this->assertTrue( $query2->have_comments() );
+
+		$feed_comment = $query1->next_comment();
+		$this->assertEquals( $comment_id, $feed_comment->comment_ID );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_delete_comment() {
+		$comment_id = self::factory()->comment->create( array( 'comment_post_ID' => self::$posts[0] ) );
+		$args       = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'comment_count' => 1,
+		);
+		$query1     = new WP_Query();
+		$posts1     = $query1->query( $args );
+
+		wp_delete_comment( $comment_id, true );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertEmpty( $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_update_post() {
+		$p1 = self::$posts[0];
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		wp_update_post(
+			array(
+				'ID'          => $p1,
+				'post_status' => 'draft',
+			)
+		);
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts1 );
+		$this->assertNotContains( $p1, $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_new_meta() {
+		$p1 = self::$posts[1]; // Post 0 already has a color meta value.
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'meta_query'    => array(
+				array(
+					'key' => 'color',
+				),
+			),
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		add_post_meta( $p1, 'color', 'black' );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_update_meta() {
+		// Posts[0] already has a color meta value set to #000000.
+		$p1 = self::$posts[0];
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'meta_query'    => array(
+				array(
+					'key'   => 'color',
+					'value' => '#000000',
+				),
+			),
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		update_post_meta( $p1, 'color', 'blue' );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts1 );
+		$this->assertEmpty( $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_delete_attachment() {
+		$p1 = self::factory()->post->create(
+			array(
+				'post_type'   => 'attachment',
+				'post_status' => 'inherit',
+			)
+		);
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'post_type'     => 'attachment',
+			'post_status'   => 'inherit',
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		wp_delete_attachment( $p1 );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts1 );
+		$this->assertEmpty( $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_delete_meta() {
+		// Post 0 already has a color meta value.
+		$p1 = self::$posts[1];
+		add_post_meta( $p1, 'color', 'black' );
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'meta_query'    => array(
+				array(
+					'key' => 'color',
+				),
+			),
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		delete_post_meta( $p1, 'color' );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts1 );
+		$this->assertNotEmpty( $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_new_term() {
+		// Post 0 already has the category foo.
+		$p1 = self::$posts[1];
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'tax_query'     => array(
+				array(
+					'taxonomy' => 'category',
+					'terms'    => array( 'foo' ),
+					'field'    => 'slug',
+				),
+			),
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		wp_set_post_terms( $p1, array( self::$t1 ), 'category' );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_delete_term() {
+		// Post 0 already has the category foo.
+		$p1 = self::$posts[1];
+		register_taxonomy( 'wptests_tax1', 'post' );
+
+		$t1 = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax1' ) );
+
+		wp_set_object_terms( $p1, array( $t1 ), 'wptests_tax1' );
+
+		$args   = array(
+			'cache_results' => true,
+			'fields'        => 'ids',
+			'tax_query'     => array(
+				array(
+					'taxonomy' => 'wptests_tax1',
+					'terms'    => array( $t1 ),
+					'field'    => 'term_id',
+				),
+			),
+		);
+		$query1 = new WP_Query();
+		$posts1 = $query1->query( $args );
+
+		wp_delete_term( $t1, 'wptests_tax1' );
+
+		$query2 = new WP_Query();
+		$posts2 = $query2->query( $args );
+
+		$this->assertNotSame( $posts1, $posts2 );
+		$this->assertContains( $p1, $posts1 );
+		$this->assertEmpty( $posts2 );
+		$this->assertNotSame( $query1->found_posts, $query2->found_posts );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_should_exclude_post_with_excluded_term() {
+		$term_id = self::$t1;
+		// Post 0 has the term applied
+		$post_id = self::$posts[0];
+
+		$args = array(
+			'fields'    => 'ids',
+			'tax_query' => array(
+				array(
+					'taxonomy' => 'category',
+					'terms'    => array( $term_id ),
+					'operator' => 'NOT IN',
+				),
+			),
+		);
+
+		$post_ids_q1 = get_posts( $args );
+		$this->assertNotContains( $post_id, $post_ids_q1, 'First query includes the post ID.' );
+
+		$num_queries = get_num_queries();
+		$post_ids_q2 = get_posts( $args );
+		$this->assertNotContains( $post_id, $post_ids_q2, 'Second query includes the post ID.' );
+
+		$this->assertSame( $num_queries, get_num_queries(), 'Second query is not cached.' );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_should_exclude_post_when_excluded_term_is_added_after_caching() {
+		$term_id = self::$t1;
+		// Post 1 does not have the term applied.
+		$post_id = self::$posts[1];
+
+		$args = array(
+			'fields'    => 'ids',
+			'tax_query' => array(
+				array(
+					'taxonomy' => 'category',
+					'terms'    => array( $term_id ),
+					'operator' => 'NOT IN',
+				),
+			),
+		);
+
+		$post_ids_q1 = get_posts( $args );
+		$this->assertContains( $post_id, $post_ids_q1, 'First query does not include the post ID.' );
+
+		wp_set_object_terms( $post_id, array( $term_id ), 'category' );
+
+		$num_queries = get_num_queries();
+		$post_ids_q2 = get_posts( $args );
+		$this->assertNotContains( $post_id, $post_ids_q2, 'Second query includes the post ID.' );
+		$this->assertNotSame( $num_queries, get_num_queries(), 'Applying term does not invalidate previous cache.' );
+	}
+
+	/**
+	 * @ticket 22176
+	 */
+	public function test_query_cache_should_not_exclude_post_when_excluded_term_is_removed_after_caching() {
+		$term_id = self::$t1;
+		// Post 0 has the term applied.
+		$post_id = self::$posts[0];
+
+		$args = array(
+			'fields'    => 'ids',
+			'tax_query' => array(
+				array(
+					'taxonomy' => 'category',
+					'terms'    => array( $term_id ),
+					'operator' => 'NOT IN',
+				),
+			),
+		);
+
+		$post_ids_q1 = get_posts( $args );
+		$this->assertNotContains( $post_id, $post_ids_q1, 'First query includes the post ID.' );
+
+		// Clear the post of terms.
+		wp_set_object_terms( $post_id, array(), 'category' );
+
+		$num_queries = get_num_queries();
+		$post_ids_q2 = get_posts( $args );
+		$this->assertContains( $post_id, $post_ids_q2, 'Second query does not include the post ID.' );
+		$this->assertNotSame( $num_queries, get_num_queries(), 'Removing term does not invalidate previous cache.' );
+	}
+}
diff --git a/tests/query/commentCount.php b/tests/query/commentCount.php
index 4f7803dd6b..5a759a3f06 100644
--- a/tests/query/commentCount.php
+++ b/tests/query/commentCount.php
@@ -21,7 +21,7 @@ class Tests_Query_CommentCount extends WP_UnitTestCase {
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		$post_id             = $factory->post->create(
 			array(
-				'post_content' => 1 . rand_str() . ' about',
+				'post_content' => '1 about',
 				'post_type'    => self::$post_type,
 			)
 		);
@@ -30,7 +30,7 @@ class Tests_Query_CommentCount extends WP_UnitTestCase {
 
 		$post_id             = $factory->post->create(
 			array(
-				'post_content' => 1 . rand_str() . ' about',
+				'post_content' => '2 about',
 				'post_type'    => self::$post_type,
 			)
 		);
@@ -41,7 +41,7 @@ class Tests_Query_CommentCount extends WP_UnitTestCase {
 
 		$post_id             = $factory->post->create(
 			array(
-				'post_content' => 1 . rand_str() . ' about',
+				'post_content' => '3 about',
 				'post_type'    => self::$post_type,
 			)
 		);
@@ -52,7 +52,7 @@ class Tests_Query_CommentCount extends WP_UnitTestCase {
 
 		$post_id             = $factory->post->create(
 			array(
-				'post_content' => 1 . rand_str() . ' about',
+				'post_content' => '4 about',
 				'post_type'    => self::$post_type,
 			)
 		);
diff --git a/tests/query/commentFeed.php b/tests/query/commentFeed.php
new file mode 100644
index 0000000000..35c4eb0b60
--- /dev/null
+++ b/tests/query/commentFeed.php
@@ -0,0 +1,114 @@
+<?php
+
+/**
+ * @group query
+ * @group comments
+ * @group feeds
+ */
+class Tests_Query_CommentFeed extends WP_UnitTestCase {
+	public static $post_type   = 'post';
+	protected static $post_ids = array();
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$post_ids = $factory->post->create_many(
+			3,
+			array(
+				'post_type'   => self::$post_type,
+				'post_status' => 'publish',
+			)
+		);
+		foreach ( self::$post_ids as $post_id ) {
+			$factory->comment->create_post_comments( $post_id, 5 );
+		}
+
+		update_option( 'posts_per_rss', 100 );
+	}
+
+	/**
+	 * @ticket 36904
+	 */
+	public function test_archive_comment_feed() {
+		global $wpdb;
+		add_filter( 'split_the_query', '__return_false' );
+		$q1   = new WP_Query();
+		$args = array(
+			'withcomments'           => 1,
+			'feed'                   => 'comments-rss',
+			'post_type'              => self::$post_type,
+			'update_post_meta_cache' => false,
+			'update_post_term_cache' => false,
+			'ignore_sticky_posts'    => false,
+			'no_found_rows'          => true,
+			'cache_results'          => false,
+		);
+		$q1->query( $args );
+		$num_queries = $wpdb->num_queries;
+		$q2          = new WP_Query();
+		$q2->query( $args );
+		$this->assertTrue( $q2->is_comment_feed() );
+		$this->assertFalse( $q2->is_singular() );
+		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+	}
+
+	/**
+	 * @ticket 36904
+	 */
+	public function test_archive_comment_feed_invalid_cache() {
+		$q1   = new WP_Query();
+		$args = array(
+			'withcomments'           => 1,
+			'feed'                   => 'comments-rss',
+			'post_type'              => self::$post_type,
+			'update_post_meta_cache' => false,
+			'update_post_term_cache' => false,
+			'ignore_sticky_posts'    => false,
+		);
+		$q1->query( $args );
+		$comment_count = $q1->comment_count;
+		$this->assertSame( 15, $comment_count );
+
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_type'   => self::$post_type,
+				'post_status' => 'publish',
+			)
+		);
+		self::factory()->comment->create_post_comments( $post->ID, 5 );
+		$q2 = new WP_Query();
+		$q2->query( $args );
+		$this->assertTrue( $q2->is_comment_feed() );
+		$this->assertFalse( $q2->is_singular() );
+
+		$comment_count = $q2->comment_count;
+		$this->assertSame( 20, $comment_count );
+	}
+
+	/**
+	 * @ticket 36904
+	 */
+	public function test_single_comment_feed() {
+		global $wpdb;
+		$post = get_post( self::$post_ids[0] );
+
+		$q1   = new WP_Query();
+		$args = array(
+			'withcomments'           => 1,
+			'feed'                   => 'comments-rss',
+			'post_type'              => $post->post_type,
+			'name'                   => $post->post_name,
+			'update_post_meta_cache' => false,
+			'update_post_term_cache' => false,
+			'ignore_sticky_posts'    => false,
+			'cache_results'          => false,
+		);
+
+		$q1->query( $args );
+		$num_queries = $wpdb->num_queries;
+		$q2          = new WP_Query();
+		$q2->query( $args );
+
+		$this->assertTrue( $q2->is_comment_feed() );
+		$this->assertTrue( $q2->is_singular() );
+		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+	}
+}
diff --git a/tests/query/conditionals.php b/tests/query/conditionals.php
index 4ef661b21a..c447c638d6 100644
--- a/tests/query/conditionals.php
+++ b/tests/query/conditionals.php
@@ -978,13 +978,13 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 	public function test_is_single_with_slug_that_clashes_with_attachment() {
 		$this->set_permalink_structure( '/%postname%/' );
 
-		$attachment_id = $this->factory->post->create(
+		$attachment_id = self::factory()->post->create(
 			array(
 				'post_type' => 'attachment',
 			)
 		);
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_title' => get_post( $attachment_id )->post_title,
 			)
@@ -1616,4 +1616,81 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 		$this->assertQueryTrue( 'is_page', 'is_singular', 'is_privacy_policy' );
 	}
 
+	/**
+	 * @ticket 55104
+	 *
+	 * @dataProvider data_conditional_tags_trigger_doing_it_wrong_and_return_false_if_wp_query_is_not_set
+	 *
+	 * @param string $function_name The name of the function to test.
+	 */
+	public function test_conditional_tags_trigger_doing_it_wrong_and_return_false_if_wp_query_is_not_set( $function_name ) {
+		unset( $GLOBALS['wp_query'] );
+
+		if ( 'is_comments_popup' === $function_name ) {
+			// `is_comments_popup()` is deprecated as of WP 4.5.
+			$this->setExpectedDeprecated( $function_name );
+		} else {
+			// All the other functions should throw a `_doing_it_wrong()` notice.
+			$this->setExpectedIncorrectUsage( $function_name );
+		}
+
+		$this->assertFalse( call_user_func( $function_name ) );
+	}
+
+	/**
+	 * Data provider.
+	 */
+	public function data_conditional_tags_trigger_doing_it_wrong_and_return_false_if_wp_query_is_not_set() {
+		// Get the list of `is_*()` conditional tags.
+		$functions = array_filter(
+			get_class_methods( 'WP_Query' ),
+			static function( $function_name ) {
+				return str_starts_with( $function_name, 'is_' );
+			}
+		);
+
+		// Wrap each function name in an array.
+		$functions = array_map(
+			static function( $function_name ) {
+				return array( $function_name );
+			},
+			$functions
+		);
+
+		return $functions;
+	}
+
+	/**
+	 * @ticket 55722
+	 *
+	 * @dataProvider data_loop_functions_do_not_trigger_a_fatal_error_if_wp_query_is_not_set
+	 *
+	 * @param string     $function_name The name of the function to test.
+	 * @param false|null $expected      Expected return value.
+	 */
+	public function test_loop_functions_do_not_trigger_a_fatal_error_if_wp_query_is_not_set( $function_name, $expected ) {
+		unset( $GLOBALS['wp_query'] );
+
+		$this->assertSame( $expected, call_user_func( $function_name ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[] Test parameters {
+	 *     @type string     $function_name The name of the function to test.
+	 *     @type false|null $expected      Expected return value.
+	 * }
+	 */
+	public function data_loop_functions_do_not_trigger_a_fatal_error_if_wp_query_is_not_set() {
+		return array(
+			array( 'have_posts', false ),
+			array( 'in_the_loop', false ),
+			array( 'rewind_posts', null ),
+			array( 'the_post', null ),
+			array( 'have_comments', false ),
+			array( 'the_comment', null ),
+		);
+	}
+
 }
diff --git a/tests/query/invalidQueries.php b/tests/query/invalidQueries.php
index ea18617b28..4c0b631f80 100644
--- a/tests/query/invalidQueries.php
+++ b/tests/query/invalidQueries.php
@@ -91,11 +91,10 @@ class Tests_Query_InvalidQueries extends WP_UnitTestCase {
 		global $wpdb;
 
 		$query = new WP_Query( array( 'post_type' => 'unregistered_cpt' ) );
-		$posts = $query->get_posts();
 
 		$this->assertStringContainsString( "{$wpdb->posts}.post_type = 'unregistered_cpt'", self::$last_posts_request );
 		$this->assertStringContainsString( "{$wpdb->posts}.post_status = 'publish'", self::$last_posts_request );
-		$this->assertCount( 0, $posts );
+		$this->assertCount( 0, $query->posts );
 	}
 
 	/**
@@ -111,10 +110,9 @@ class Tests_Query_InvalidQueries extends WP_UnitTestCase {
 				'post_type' => array( 'unregistered_cpt', 'page' ),
 			)
 		);
-		$posts = $query->get_posts();
 
 		$this->assertStringContainsString( "{$wpdb->posts}.post_type = 'unregistered_cpt'", self::$last_posts_request );
-		$this->assertCount( 1, $posts, 'the valid `page` post type should still return one post' );
+		$this->assertCount( 1, $query->posts, 'the valid `page` post type should still return one post' );
 	}
 
 	/**
@@ -143,10 +141,9 @@ class Tests_Query_InvalidQueries extends WP_UnitTestCase {
 				'post_type' => 'page',
 			)
 		);
-		$posts = $query->get_posts();
 
 		// Only the published page should be returned.
-		$this->assertCount( 1, $posts );
+		$this->assertCount( 1, $query->posts );
 	}
 
 	/**
@@ -158,9 +155,8 @@ class Tests_Query_InvalidQueries extends WP_UnitTestCase {
 				'static' => 'a',
 			)
 		);
-		$posts = $query->get_posts();
 
 		// Only the published post should be returned.
-		$this->assertCount( 1, $posts );
+		$this->assertCount( 1, $query->posts );
 	}
 }
diff --git a/tests/query/noFoundRows.php b/tests/query/noFoundRows.php
index 457da44994..7b4f66a416 100644
--- a/tests/query/noFoundRows.php
+++ b/tests/query/noFoundRows.php
@@ -73,7 +73,7 @@ class Tests_Query_NoFoundRows extends WP_UnitTestCase {
 	 * @ticket 29552
 	 */
 	public function test_no_found_rows_default_with_nopaging_true() {
-		$p = $this->factory->post->create();
+		$p = self::factory()->post->create();
 
 		$q = new WP_Query(
 			array(
@@ -90,7 +90,7 @@ class Tests_Query_NoFoundRows extends WP_UnitTestCase {
 	 * @ticket 29552
 	 */
 	public function test_no_found_rows_default_with_postsperpage_minus1() {
-		$p = $this->factory->post->create();
+		$p = self::factory()->post->create();
 
 		$q = new WP_Query(
 			array(
diff --git a/tests/query/parseQuery.php b/tests/query/parseQuery.php
index 5b3625ed0f..bbf3f1217f 100644
--- a/tests/query/parseQuery.php
+++ b/tests/query/parseQuery.php
@@ -104,4 +104,133 @@ class Tests_Query_ParseQuery extends WP_UnitTestCase {
 		$this->assertSame( '404', $q->query_vars['error'] );
 	}
 
+	/**
+	 * Ensure an array of authors is rejected.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_author_array() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'author' => array( 1, 2, 3 ),
+			)
+		);
+
+		$this->assertEmpty( $q->query_vars['author'] );
+	}
+
+	/**
+	 * Ensure a non-scalar (non-numeric) author value is rejected.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_author_string() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'author' => 'admin',
+			)
+		);
+
+		$this->assertEmpty( $q->query_vars['author'] );
+	}
+
+	/**
+	 * Ensure nonscalar 'cat' array values are rejected.
+	 *
+	 * Note the returned 'cat' query_var value is a string.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_cat_array_mixed() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'cat' => array( 1, 'uncategorized', '-1' ),
+			)
+		);
+
+		$this->assertSame( '1,-1', $q->query_vars['cat'] );
+	}
+
+	/**
+	 * Ensure a nonscalar menu_order value is rejected.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_menu_order_nonscalar() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'menu_order' => array( 1 ),
+			)
+		);
+
+		$this->assertEmpty( $q->query_vars['menu_order'] );
+	}
+
+	/**
+	 * Ensure numeric 'subpost' gets assigned to 'attachment'.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_subpost_scalar() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'subpost' => 1,
+			)
+		);
+
+		$this->assertSame( 1, $q->query_vars['attachment'] );
+	}
+
+	/**
+	 * Ensure non-scalar 'subpost' does not get assigned to 'attachment'.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_subpost_nonscalar() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'subpost' => array( 1 ),
+			)
+		);
+
+		$this->assertEmpty( $q->query_vars['attachment'] );
+	}
+
+	/**
+	 * Ensure numeric 'attachment_id' value is assigned.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_attachment_id() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'attachment_id' => 1,
+			)
+		);
+
+		$this->assertSame( 1, $q->query_vars['attachment_id'] );
+	}
+
+	/**
+	 * Ensure non-scalar 'attachment_id' value is rejected.
+	 *
+	 * @ticket 17737
+	 */
+	public function test_parse_query_attachment_id_nonscalar() {
+		$q = new WP_Query();
+		$q->parse_query(
+			array(
+				'attachment_id' => array( 1 ),
+			)
+		);
+
+		$this->assertEmpty( $q->query_vars['attachment_id'] );
+	}
 }
diff --git a/tests/query/search.php b/tests/query/search.php
index 2beda65d2f..954bd5f748 100644
--- a/tests/query/search.php
+++ b/tests/query/search.php
@@ -10,7 +10,7 @@ class Tests_Query_Search extends WP_UnitTestCase {
 	public function set_up() {
 		parent::set_up();
 
-		$this->post_type = rand_str( 12 );
+		$this->post_type = 'foo1';
 		register_post_type( $this->post_type );
 
 		$this->q = new WP_Query();
@@ -36,7 +36,7 @@ class Tests_Query_Search extends WP_UnitTestCase {
 		foreach ( range( 1, 7 ) as $i ) {
 			self::factory()->post->create(
 				array(
-					'post_content' => $i . rand_str() . ' about',
+					'post_content' => "{$i} about",
 					'post_type'    => $this->post_type,
 				)
 			);
@@ -266,7 +266,7 @@ class Tests_Query_Search extends WP_UnitTestCase {
 	 * @ticket 31025
 	 */
 	public function test_s_zero() {
-		$p1 = $this->factory->post->create(
+		$p1 = self::factory()->post->create(
 			array(
 				'post_status'  => 'publish',
 				'post_title'   => '1',
@@ -275,7 +275,7 @@ class Tests_Query_Search extends WP_UnitTestCase {
 			)
 		);
 
-		$p2 = $this->factory->post->create(
+		$p2 = self::factory()->post->create(
 			array(
 				'post_status'  => 'publish',
 				'post_title'   => '0',
diff --git a/tests/query/stickies.php b/tests/query/stickies.php
index e6d9d41f40..0070f4cb31 100644
--- a/tests/query/stickies.php
+++ b/tests/query/stickies.php
@@ -4,6 +4,7 @@
  * Tests related to sticky functionality in WP_Query.
  *
  * @group query
+ * @covers WP_Query::get_posts
  */
 class Tests_Query_Stickies extends WP_UnitTestCase {
 	public static $posts = array();
@@ -104,4 +105,48 @@ class Tests_Query_Stickies extends WP_UnitTestCase {
 	public function set_post__not_in( $q ) {
 		$q->set( 'post__not_in', array( self::$posts[8] ) );
 	}
+
+	/**
+	 * @ticket 36907
+	 */
+	public function test_stickies_should_obey_parameters_from_the_main_query() {
+		$filter = new MockAction();
+		add_filter( 'posts_pre_query', array( $filter, 'filter' ), 10, 2 );
+		$this->go_to( '/' );
+		$filter_args       = $filter->get_args();
+		$query_vars        = $filter_args[0][1]->query_vars;
+		$sticky_query_vars = $filter_args[1][1]->query_vars;
+
+		$this->assertNotEmpty( $sticky_query_vars['posts_per_page'] );
+		$this->assertSame( $query_vars['suppress_filters'], $sticky_query_vars['suppress_filters'] );
+		$this->assertSame( $query_vars['cache_results'], $sticky_query_vars['cache_results'] );
+		$this->assertSame( $query_vars['update_post_meta_cache'], $sticky_query_vars['update_post_meta_cache'] );
+		$this->assertSame( $query_vars['update_post_term_cache'], $sticky_query_vars['update_post_term_cache'] );
+		$this->assertSame( $query_vars['lazy_load_term_meta'], $sticky_query_vars['lazy_load_term_meta'] );
+		$this->assertTrue( $sticky_query_vars['ignore_sticky_posts'] );
+		$this->assertTrue( $sticky_query_vars['no_found_rows'] );
+	}
+
+	/**
+	 * @ticket 36907
+	 */
+	public function test_stickies_should_limit_query() {
+		$sticky_count = 6;
+		$post_date    = gmdate( 'Y-m-d H:i:s', time() - 10000 );
+		$post_ids     = self::factory()->post->create_many( $sticky_count, array( 'post_date' => $post_date ) );
+		add_filter(
+			'pre_option_sticky_posts',
+			function () use ( $post_ids ) {
+				return $post_ids;
+			}
+		);
+
+		$filter = new MockAction();
+		add_filter( 'posts_pre_query', array( $filter, 'filter' ), 10, 2 );
+		$this->go_to( '/' );
+		$filter_args       = $filter->get_args();
+		$sticky_query_vars = $filter_args[1][1]->query_vars;
+
+		$this->assertSame( $sticky_query_vars['posts_per_page'], $sticky_count );
+	}
 }
diff --git a/tests/query/taxQuery.php b/tests/query/taxQuery.php
index 2ca00b605b..e67ca6f36e 100644
--- a/tests/query/taxQuery.php
+++ b/tests/query/taxQuery.php
@@ -1024,8 +1024,7 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 			)
 		);
 
-		$posts = $query->get_posts();
-		$this->assertCount( 0, $posts );
+		$this->assertCount( 0, $query->posts );
 	}
 
 	/**
@@ -1059,8 +1058,7 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 			)
 		);
 
-		$posts = $query->get_posts();
-		$this->assertCount( 0, $posts );
+		$this->assertCount( 0, $query->posts );
 	}
 
 	public function test_tax_query_include_children() {
@@ -1209,8 +1207,8 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 		register_taxonomy_for_object_type( 'post_tag', 'attachment:image' );
 		$tag_id   = self::factory()->term->create(
 			array(
-				'slug' => rand_str(),
-				'name' => rand_str(),
+				'slug' => 'foo-bar',
+				'name' => 'Foo Bar',
 			)
 		);
 		$image_id = self::factory()->attachment->create_object(
@@ -1623,4 +1621,124 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 
 		$this->assertSameSets( array( $p ), $q->posts );
 	}
+
+	/**
+	 * @ticket 55360
+	 *
+	 * @covers WP_Tax_Query::transform_query
+	 */
+	public function test_tax_terms_should_limit_query() {
+		$filter = new MockAction();
+		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
+		register_taxonomy( 'wptests_tax', 'post' );
+		$name = 'foobar';
+		$t    = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'name'     => $name,
+			)
+		);
+
+		$p = self::factory()->post->create();
+		wp_set_object_terms( $p, array( $t ), 'wptests_tax' );
+
+		$q = new WP_Query(
+			array(
+				'fields'    => 'ids',
+				'tax_query' => array(
+					array(
+						'taxonomy' => 'wptests_tax',
+						'field'    => 'name',
+						'terms'    => $name,
+					),
+				),
+			)
+		);
+
+		$filter_args = $filter->get_args();
+		$query       = $filter_args[1][1]->request;
+
+		$this->assertSameSets( array( $p ), $q->posts );
+		$this->assertStringContainsString( 'LIMIT 1', $query );
+	}
+
+	/**
+	 * @ticket 55360
+	 *
+	 * @covers WP_Tax_Query::transform_query
+	 */
+	public function test_tax_terms_should_limit_query_to_one() {
+		$filter = new MockAction();
+		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
+		register_taxonomy( 'wptests_tax', 'post' );
+		$name = 'foobar';
+		$t    = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'name'     => $name,
+			)
+		);
+
+		$p = self::factory()->post->create();
+		wp_set_object_terms( $p, array( $t ), 'wptests_tax' );
+
+		$q = new WP_Query(
+			array(
+				'fields'    => 'ids',
+				'tax_query' => array(
+					array(
+						'taxonomy' => 'wptests_tax',
+						'field'    => 'term_id',
+						'terms'    => array( $t, $t, $t ),
+					),
+				),
+			)
+		);
+
+		$filter_args = $filter->get_args();
+		$query       = $filter_args[1][1]->request;
+
+		$this->assertSameSets( array( $p ), $q->posts );
+		$this->assertStringContainsString( 'LIMIT 1', $query );
+	}
+
+	/**
+	 * @ticket 55360
+	 *
+	 * @covers WP_Tax_Query::transform_query
+	 */
+	public function test_hierarchical_taxonomies_do_not_limit_query() {
+		$filter = new MockAction();
+		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
+		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
+		$name = 'foobar';
+		$t    = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'name'     => $name,
+			)
+		);
+
+		$p = self::factory()->post->create();
+		wp_set_object_terms( $p, array( $t ), 'wptests_tax' );
+
+		$q = new WP_Query(
+			array(
+				'fields'    => 'ids',
+				'tax_query' => array(
+					array(
+						'taxonomy' => 'wptests_tax',
+						'field'    => 'name',
+						'terms'    => $name,
+					),
+				),
+			)
+		);
+
+		$filter_args = $filter->get_args();
+		$query       = $filter_args[0][1]->request;
+
+		$this->assertSameSets( array( $p ), $q->posts );
+		$this->assertStringNotContainsString( 'LIMIT 1', $query );
+	}
 }
diff --git a/tests/rest-api.php b/tests/rest-api.php
index acc0e7110c..fa25502959 100644
--- a/tests/rest-api.php
+++ b/tests/rest-api.php
@@ -2490,4 +2490,32 @@ class Tests_REST_API extends WP_UnitTestCase {
 			array( '', array(), array() ),
 		);
 	}
+
+	/**
+	 * @ticket 55213
+	 */
+	public function test_rest_preload_api_request_fields() {
+		$preload_paths = array(
+			'/',
+			'/?_fields=description',
+		);
+
+		$preload_data = array_reduce(
+			$preload_paths,
+			'rest_preload_api_request',
+			array()
+		);
+
+		$this->assertSame( array_keys( $preload_data ), array( '/', '/?_fields=description' ) );
+
+		// Unfiltered request has all fields
+		$this->assertArrayHasKey( 'description', $preload_data['/']['body'] );
+		$this->assertArrayHasKey( 'routes', $preload_data['/']['body'] );
+
+		// Filtered request only has the desired fields + links
+		$this->assertSame(
+			array_keys( $preload_data['/?_fields=description']['body'] ),
+			array( 'description', '_links' )
+		);
+	}
 }
diff --git a/tests/rest-api/rest-application-passwords-controller.php b/tests/rest-api/rest-application-passwords-controller.php
index cbfe965fa1..d4418f62cd 100644
--- a/tests/rest-api/rest-application-passwords-controller.php
+++ b/tests/rest-api/rest-application-passwords-controller.php
@@ -409,6 +409,32 @@ class WP_Test_REST_Application_Passwords_Controller extends WP_Test_REST_Control
 		$this->assertErrorResponse( 'rest_user_invalid_id', $response, 404 );
 	}
 
+	/**
+	 * @ticket 53224
+	 * @group ms-required
+	 */
+	public function test_create_item_for_super_admin_on_site_where_they_are_not_a_member() {
+		wp_set_current_user( self::$admin );
+
+		// Create a site where the Super Admin is not a member.
+		$blog_id = self::factory()->blog->create(
+			array(
+				'user_id' => self::$subscriber_id,
+			)
+		);
+
+		switch_to_blog( $blog_id );
+
+		$request = new WP_REST_Request( 'POST', '/wp/v2/users/me/application-passwords' );
+		$request->set_body_params( array( 'name' => 'App' ) );
+		$response = rest_do_request( $request );
+
+		restore_current_blog();
+
+		$this->assertNotWPError( $response );
+		$this->assertSame( 201, $response->get_status() );
+	}
+
 	/**
 	 * @ticket 51939
 	 */
@@ -946,6 +972,86 @@ class WP_Test_REST_Application_Passwords_Controller extends WP_Test_REST_Control
 		$this->assertErrorResponse( 'rest_application_password_not_found', $response, 500 );
 	}
 
+	/**
+	 * @ticket 53658
+	 *
+	 * @covers ::wp_is_application_passwords_supported
+	 */
+	public function test_wp_is_application_passwords_supported_with_https_only() {
+		$_SERVER['HTTPS'] = 'on';
+		$this->assertTrue( wp_is_application_passwords_supported() );
+	}
+
+	/**
+	 * @ticket 53658
+	 *
+	 * @covers ::wp_is_application_passwords_supported
+	 */
+	public function test_wp_is_application_passwords_supported_with_local_environment_only() {
+		putenv( 'WP_ENVIRONMENT_TYPE=local' );
+
+		$actual = wp_is_application_passwords_supported();
+
+		// Revert to default behaviour so that other tests are not affected.
+		putenv( 'WP_ENVIRONMENT_TYPE' );
+
+		$this->assertTrue( $actual );
+	}
+
+	/**
+	 * @dataProvider data_wp_is_application_passwords_available
+	 *
+	 * @ticket 53658
+	 *
+	 * @covers ::wp_is_application_passwords_available
+	 *
+	 * @param bool|string $expected The expected value.
+	 * @param string|null $callback Optional. The callback for the `wp_is_application_passwords_available` hook.
+	 *                              Default: null.
+	 */
+	public function test_wp_is_application_passwords_available( $expected, $callback = null ) {
+		remove_filter( 'wp_is_application_passwords_available', '__return_true' );
+
+		if ( $callback ) {
+			add_filter( 'wp_is_application_passwords_available', $callback );
+		}
+
+		if ( 'default' === $expected ) {
+			putenv( 'WP_ENVIRONMENT_TYPE=local' );
+			$expected = wp_is_application_passwords_supported();
+		}
+
+		$actual = wp_is_application_passwords_available();
+
+		if ( 'default' === $expected ) {
+			// Revert to default behaviour so that other tests are not affected.
+			putenv( 'WP_ENVIRONMENT_TYPE' );
+		}
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_is_application_passwords_available() {
+		return array(
+			'availability not forced'   => array(
+				'expected' => 'default',
+			),
+			'availability forced true'  => array(
+				'expected' => true,
+				'callback' => '__return_true',
+			),
+			'availability forced false' => array(
+				'expected' => false,
+				'callback' => '__return_false',
+			),
+		);
+	}
+
 	/**
 	 * Sets up a REST API request to be authenticated using an App Password.
 	 *
diff --git a/tests/rest-api/rest-attachments-controller.php b/tests/rest-api/rest-attachments-controller.php
index fae3bbb8b3..05f6aab921 100644
--- a/tests/rest-api/rest-attachments-controller.php
+++ b/tests/rest-api/rest-attachments-controller.php
@@ -29,6 +29,11 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	 */
 	private $test_file2;
 
+	/**
+	 * @var array The recorded posts query clauses.
+	 */
+	protected $posts_clauses;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$superadmin_id  = $factory->user->create(
 			array(
@@ -85,6 +90,20 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$orig_file2       = DIR_TESTDATA . '/images/codeispoetry.png';
 		$this->test_file2 = get_temp_dir() . 'codeispoetry.png';
 		copy( $orig_file2, $this->test_file2 );
+
+		add_filter( 'rest_pre_dispatch', array( $this, 'wpSetUpBeforeRequest' ), 10, 3 );
+		add_filter( 'posts_clauses', array( $this, 'save_posts_clauses' ), 10, 2 );
+		add_filter( 'image_editor_output_format', '__return_empty_array' );
+	}
+
+	public function wpSetUpBeforeRequest( $result ) {
+		$this->posts_clauses = array();
+		return $result;
+	}
+
+	public function save_posts_clauses( $clauses ) {
+		$this->posts_clauses[] = $clauses;
+		return $clauses;
 	}
 
 	public function tear_down() {
@@ -103,6 +122,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 			WP_Image_Editor_Mock::$size_return = null;
 		}
 
+		remove_filter( 'image_editor_output_format', '__return_empty_array' );
+
 		parent::tear_down();
 	}
 
@@ -164,7 +185,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertSame( 'view', $data['endpoints'][0]['args']['context']['default'] );
 		$this->assertSame( array( 'view', 'embed', 'edit' ), $data['endpoints'][0]['args']['context']['enum'] );
 		// Single.
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -225,7 +246,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_registered_get_item_params() {
-		$id1      = $this->factory->attachment->create_object(
+		$id1      = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -245,7 +266,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	 * @ticket 43701
 	 */
 	public function test_allow_header_sent_on_options_request() {
-		$id1      = $this->factory->attachment->create_object(
+		$id1      = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -273,7 +294,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_get_items() {
 		wp_set_current_user( 0 );
-		$id1            = $this->factory->attachment->create_object(
+		$id1            = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -281,8 +302,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$draft_post     = $this->factory->post->create( array( 'post_status' => 'draft' ) );
-		$id2            = $this->factory->attachment->create_object(
+		$draft_post     = self::factory()->post->create( array( 'post_status' => 'draft' ) );
+		$id2            = self::factory()->attachment->create_object(
 			$this->test_file,
 			$draft_post,
 			array(
@@ -290,8 +311,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$published_post = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3            = $this->factory->attachment->create_object(
+		$published_post = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3            = self::factory()->attachment->create_object(
 			$this->test_file,
 			$published_post,
 			array(
@@ -313,7 +334,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_get_items_logged_in_editor() {
 		wp_set_current_user( self::$editor_id );
-		$id1            = $this->factory->attachment->create_object(
+		$id1            = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -321,8 +342,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$draft_post     = $this->factory->post->create( array( 'post_status' => 'draft' ) );
-		$id2            = $this->factory->attachment->create_object(
+		$draft_post     = self::factory()->post->create( array( 'post_status' => 'draft' ) );
+		$id2            = self::factory()->attachment->create_object(
 			$this->test_file,
 			$draft_post,
 			array(
@@ -330,8 +351,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$published_post = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3            = $this->factory->attachment->create_object(
+		$published_post = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3            = self::factory()->attachment->create_object(
 			$this->test_file,
 			$published_post,
 			array(
@@ -351,7 +372,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_get_items_media_type() {
-		$id1      = $this->factory->attachment->create_object(
+		$id1      = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -374,7 +395,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_get_items_mime_type() {
-		$id1      = $this->factory->attachment->create_object(
+		$id1      = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -397,8 +418,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_get_items_parent() {
-		$post_id        = $this->factory->post->create( array( 'post_title' => 'Test Post' ) );
-		$attachment_id  = $this->factory->attachment->create_object(
+		$post_id        = self::factory()->post->create( array( 'post_title' => 'Test Post' ) );
+		$attachment_id  = self::factory()->attachment->create_object(
 			$this->test_file,
 			$post_id,
 			array(
@@ -406,7 +427,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$attachment_id2 = $this->factory->attachment->create_object(
+		$attachment_id2 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -442,7 +463,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_get_items_invalid_status_param_is_error_response() {
 		wp_set_current_user( self::$editor_id );
-		$this->factory->attachment->create_object(
+		self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -460,7 +481,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	public function test_get_items_private_status() {
 		// Logged out users can't make the request.
 		wp_set_current_user( 0 );
-		$attachment_id1 = $this->factory->attachment->create_object(
+		$attachment_id1 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -484,7 +505,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	public function test_get_items_multiple_statuses() {
 		// Logged out users can't make the request.
 		wp_set_current_user( 0 );
-		$attachment_id1 = $this->factory->attachment->create_object(
+		$attachment_id1 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -493,7 +514,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_status'    => 'private',
 			)
 		);
-		$attachment_id2 = $this->factory->attachment->create_object(
+		$attachment_id2 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -522,14 +543,14 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_get_items_invalid_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/media' );
-		$request->set_param( 'after', rand_str() );
-		$request->set_param( 'before', rand_str() );
+		$request->set_param( 'after', 'foo' );
+		$request->set_param( 'before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
 
 	public function test_get_items_valid_date() {
-		$id1     = $this->factory->attachment->create_object(
+		$id1     = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -538,7 +559,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$id2     = $this->factory->attachment->create_object(
+		$id2     = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -547,7 +568,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$id3     = $this->factory->attachment->create_object(
+		$id3     = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -570,8 +591,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	 */
 	public function test_get_items_invalid_modified_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/media' );
-		$request->set_param( 'modified_after', rand_str() );
-		$request->set_param( 'modified_before', rand_str() );
+		$request->set_param( 'modified_after', 'foo' );
+		$request->set_param( 'modified_before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
@@ -580,7 +601,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	 * @ticket 50617
 	 */
 	public function test_get_items_valid_modified_date() {
-		$id1 = $this->factory->attachment->create_object(
+		$id1 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -589,7 +610,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$id2 = $this->factory->attachment->create_object(
+		$id2 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -598,7 +619,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'post_excerpt'   => 'A sample caption',
 			)
 		);
-		$id3 = $this->factory->attachment->create_object(
+		$id3 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -619,8 +640,50 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertSame( $id2, $data[0]['id'] );
 	}
 
+	/**
+	 * @ticket 55677
+	 */
+	public function test_get_items_avoid_duplicated_count_query_if_no_items() {
+		$request = new WP_REST_Request( 'GET', '/wp/v2/media' );
+		$request->set_param( 'media_type', 'video' );
+
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->assertCount( 1, $this->posts_clauses );
+
+		$headers = $response->get_headers();
+
+		$this->assertSame( 0, $headers['X-WP-Total'] );
+		$this->assertSame( 0, $headers['X-WP-TotalPages'] );
+	}
+
+	/**
+	 * @ticket 55677
+	 */
+	public function test_get_items_with_empty_page_runs_count_query_after() {
+		self::factory()->attachment->create_object(
+			$this->test_file,
+			0,
+			array(
+				'post_date'      => '2022-06-12T00:00:00Z',
+				'post_mime_type' => 'image/jpeg',
+				'post_excerpt'   => 'A sample caption',
+			)
+		);
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/media' );
+		$request->set_param( 'media_type', 'image' );
+		$request->set_param( 'page', 2 );
+
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->assertCount( 2, $this->posts_clauses );
+
+		$this->assertErrorResponse( 'rest_post_invalid_page_number', $response, 400 );
+	}
+
 	public function test_get_item() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -640,7 +703,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	 * @requires function imagejpeg
 	 */
 	public function test_get_item_sizes() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -671,7 +734,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	 * @requires function imagejpeg
 	 */
 	public function test_get_item_sizes_with_no_url() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -698,8 +761,8 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_get_item_private_post_not_authenticated() {
 		wp_set_current_user( 0 );
-		$draft_post = $this->factory->post->create( array( 'post_status' => 'draft' ) );
-		$id1        = $this->factory->attachment->create_object(
+		$draft_post = self::factory()->post->create( array( 'post_status' => 'draft' ) );
+		$id1        = self::factory()->attachment->create_object(
 			$this->test_file,
 			$draft_post,
 			array(
@@ -713,7 +776,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_get_item_inherit_status_with_invalid_parent() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			REST_TESTS_IMPOSSIBLY_HIGH_NUMBER,
 			array(
@@ -730,7 +793,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_get_item_auto_status_with_invalid_parent_not_authenticated_returns_error() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			REST_TESTS_IMPOSSIBLY_HIGH_NUMBER,
 			array(
@@ -900,7 +963,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_create_item_invalid_edit_permissions() {
-		$post_id = $this->factory->post->create( array( 'post_author' => self::$editor_id ) );
+		$post_id = self::factory()->post->create( array( 'post_author' => self::$editor_id ) );
 		wp_set_current_user( self::$author_id );
 		$request = new WP_REST_Request( 'POST', '/wp/v2/media' );
 		$request->set_param( 'post', $post_id );
@@ -909,7 +972,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_create_item_invalid_upload_permissions() {
-		$post_id = $this->factory->post->create( array( 'post_author' => self::$editor_id ) );
+		$post_id = self::factory()->post->create( array( 'post_author' => self::$editor_id ) );
 		wp_set_current_user( self::$uploader_id );
 		$request = new WP_REST_Request( 'POST', '/wp/v2/media' );
 		$request->set_param( 'post', $post_id );
@@ -918,7 +981,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_create_item_invalid_post_type() {
-		$attachment_id = $this->factory->post->create(
+		$attachment_id = self::factory()->post->create(
 			array(
 				'post_type'   => 'attachment',
 				'post_status' => 'inherit',
@@ -983,7 +1046,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_update_item() {
 		wp_set_current_user( self::$editor_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1012,21 +1075,21 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_update_item_parent() {
 		wp_set_current_user( self::$editor_id );
-		$original_parent = $this->factory->post->create( array() );
-		$attachment_id   = $this->factory->attachment->create_object(
+		$original_parent = self::factory()->post->create( array() );
+		$attachment_id   = self::factory()->attachment->create_object(
 			$this->test_file,
 			$original_parent,
 			array(
 				'post_mime_type' => 'image/jpeg',
 				'post_excerpt'   => 'A sample caption',
-				'post_author'    => $this->editor_id,
+				'post_author'    => self::$editor_id,
 			)
 		);
 
 		$attachment = get_post( $attachment_id );
 		$this->assertSame( $original_parent, $attachment->post_parent );
 
-		$new_parent = $this->factory->post->create( array() );
+		$new_parent = self::factory()->post->create( array() );
 		$request    = new WP_REST_Request( 'POST', '/wp/v2/media/' . $attachment_id );
 		$request->set_param( 'post', $new_parent );
 		rest_get_server()->dispatch( $request );
@@ -1037,7 +1100,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_update_item_invalid_permissions() {
 		wp_set_current_user( self::$author_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1053,7 +1116,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_update_item_invalid_post_type() {
-		$attachment_id = $this->factory->post->create(
+		$attachment_id = self::factory()->post->create(
 			array(
 				'post_type'   => 'attachment',
 				'post_status' => 'inherit',
@@ -1061,7 +1124,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 			)
 		);
 		wp_set_current_user( self::$editor_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1385,7 +1448,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_delete_item() {
 		wp_set_current_user( self::$editor_id );
-		$attachment_id    = $this->factory->attachment->create_object(
+		$attachment_id    = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1401,7 +1464,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_delete_item_no_trash() {
 		wp_set_current_user( self::$editor_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1426,7 +1489,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 
 	public function test_delete_item_invalid_delete_permissions() {
 		wp_set_current_user( self::$author_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1441,7 +1504,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_prepare_item() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1460,7 +1523,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_prepare_item_limit_fields() {
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1551,7 +1614,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertArrayHasKey( 'my_custom_int', $data['schema']['properties'] );
 		$this->assertSame( $schema, $data['schema']['properties']['my_custom_int'] );
 
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1588,7 +1651,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		);
 
 		wp_set_current_user( self::$editor_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
@@ -1614,14 +1677,14 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 	}
 
 	public function test_search_item_by_filename() {
-		$id1 = $this->factory->attachment->create_object(
+		$id1 = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
 				'post_mime_type' => 'image/jpeg',
 			)
 		);
-		$id2 = $this->factory->attachment->create_object(
+		$id2 = self::factory()->attachment->create_object(
 			$this->test_file2,
 			0,
 			array(
@@ -1872,7 +1935,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		add_action( 'rest_after_insert_attachment', array( $this, 'filter_rest_after_insert_attachment' ) );
 
 		wp_set_current_user( self::$editor_id );
-		$attachment_id = $this->factory->attachment->create_object(
+		$attachment_id = self::factory()->attachment->create_object(
 			$this->test_file,
 			0,
 			array(
diff --git a/tests/rest-api/rest-autosaves-controller.php b/tests/rest-api/rest-autosaves-controller.php
index cf85a864be..2a7eacb8b9 100644
--- a/tests/rest-api/rest-autosaves-controller.php
+++ b/tests/rest-api/rest-autosaves-controller.php
@@ -25,6 +25,8 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 	protected static $child_page_id;
 	protected static $child_draft_page_id;
 
+	private $post_autosave;
+
 	protected function set_post_data( $args = array() ) {
 		$defaults = array(
 			'title'   => 'Post Title',
@@ -269,8 +271,11 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		$this->assertErrorResponse( 'rest_post_invalid_parent', $response, 404 );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_delete_item() {
-		// Doesn't exist.
+		// Controller does not implement delete_item().
 	}
 
 	public function test_prepare_item() {
@@ -602,4 +607,71 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertNotEquals( 'garbage', get_post( self::$draft_page_id )->comment_status );
 	}
+
+	/**
+	 * Test ensuring that autosave from the original author doesn't overwrite changes after it has been taken over by a 2nd author.
+	 *
+	 * @ticket 55659
+	 */
+	public function test_rest_autosave_draft_post_locked_to_different_author() {
+
+		// Create a post by the editor.
+		$post_data = array(
+			'post_content' => 'Test post content',
+			'post_title'   => 'Test post title',
+			'post_excerpt' => 'Test post excerpt',
+			'post_author'  => self::$editor_id,
+			'post_status'  => 'draft',
+		);
+		$post_id   = wp_insert_post( $post_data );
+
+		// Set the post lock to the contributor, simulating a takeover of the post.
+		wp_set_current_user( self::$contributor_id );
+		wp_set_post_lock( $post_id );
+
+		// Update the post with new data from the contributor.
+		$updated_post_data = array(
+			'ID'           => $post_id,
+			'post_content' => 'New post content from the contributor',
+			'post_title'   => 'New post title',
+		);
+		wp_update_post( $updated_post_data );
+
+		// Set the current user to the editor and initiate an autosave with some new data.
+		wp_set_current_user( self::$editor_id );
+		$autosave_data = array(
+			'id'      => $post_id,
+			'content' => 'Updated post content',
+			'excerpt' => 'A new excerpt to test',
+			'title'   => $post_data['post_title'],
+		);
+
+		// Initiate an autosave via the REST API as Gutenberg does.
+		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
+		$request->add_header( 'content-type', 'application/json' );
+		$request->set_body( wp_json_encode( $autosave_data ) );
+
+		$response = rest_get_server()->dispatch( $request );
+		$new_data = $response->get_data();
+
+		// The current version of our test post.
+		$current_post = get_post( $post_id );
+
+		// The new data from the autosave should have its parent ID set to the original post ID.
+		$this->assertSame( $post_id, $new_data['parent'] );
+
+		// The post title and content should still be the updated versions from the contributor.
+		$this->assertSame( $current_post->post_title, $updated_post_data['post_title'] );
+		$this->assertSame( $current_post->post_content, $updated_post_data['post_content'] );
+
+		// The excerpt should have stayed the same.
+		$this->assertSame( $current_post->post_excerpt, $post_data['post_excerpt'] );
+
+		$autosave_post = wp_get_post_autosave( $post_id );
+
+		// Has changes.
+		$this->assertSame( $autosave_data['content'], $autosave_post->post_content );
+
+		wp_delete_post( $post_id );
+	}
 }
diff --git a/tests/rest-api/rest-block-directory-controller.php b/tests/rest-api/rest-block-directory-controller.php
index f772c1e026..af014d93fd 100644
--- a/tests/rest-api/rest-block-directory-controller.php
+++ b/tests/rest-api/rest-block-directory-controller.php
@@ -130,20 +130,32 @@ class WP_REST_Block_Directory_Controller_Test extends WP_Test_REST_Controller_Te
 		$this->assertSame( array(), $data );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_get_item() {
-		$this->markTestSkipped( 'Controller does not have get_item route.' );
+		// Controller does not implement get_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_create_item() {
-		$this->markTestSkipped( 'Controller does not have create_item route.' );
+		// Controller does not implement create_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_update_item() {
-		$this->markTestSkipped( 'Controller does not have update_item route.' );
+		// Controller does not implement update_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_delete_item() {
-		$this->markTestSkipped( 'Controller does not have delete_item route.' );
+		// Controller does not implement delete_item().
 	}
 
 	/**
@@ -212,6 +224,46 @@ class WP_REST_Block_Directory_Controller_Test extends WP_Test_REST_Controller_Te
 		$this->assertArrayHasKey( 'humanized_updated', $properties );
 	}
 
+	/**
+	 * @ticket 53621
+	 */
+	public function test_get_items_response_conforms_to_schema() {
+		wp_set_current_user( self::$admin_id );
+		$plugin = $this->get_mock_plugin();
+
+		// Fetch the block directory schema.
+		$request = new WP_REST_Request( 'OPTIONS', '/wp/v2/block-directory/search' );
+		$schema  = rest_get_server()->dispatch( $request )->get_data()['schema'];
+
+		add_filter(
+			'plugins_api',
+			static function () use ( $plugin ) {
+				return (object) array(
+					'info'    =>
+						array(
+							'page'    => 1,
+							'pages'   => 1,
+							'results' => 1,
+						),
+					'plugins' => array(
+						$plugin,
+					),
+				);
+			}
+		);
+
+		// Fetch a block plugin.
+		$request = new WP_REST_Request( 'GET', '/wp/v2/block-directory/search' );
+		$request->set_query_params( array( 'term' => 'cache' ) );
+
+		$result = rest_get_server()->dispatch( $request );
+		$data   = $result->get_data();
+
+		$valid = rest_validate_value_from_schema( $data[0], $schema );
+
+		$this->assertNotWPError( $valid );
+	}
+
 	/**
 	 * Simulate a network failure on outbound http requests to a given hostname.
 	 *
diff --git a/tests/rest-api/rest-block-renderer-controller.php b/tests/rest-api/rest-block-renderer-controller.php
index 454bc6da35..9f2401e893 100644
--- a/tests/rest-api/rest-block-renderer-controller.php
+++ b/tests/rest-api/rest-block-renderer-controller.php
@@ -614,43 +614,55 @@ class REST_Block_Renderer_Controller_Test extends WP_Test_REST_Controller_Testca
 
 	/**
 	 * The update_item() method does not exist for block rendering.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_update_item() {
-		$this->markTestSkipped( 'Controller does not implement update_item().' );
+		// Controller does not implement update_item().
 	}
 
 	/**
 	 * The create_item() method does not exist for block rendering.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_create_item() {
-		$this->markTestSkipped( 'Controller does not implement create_item().' );
+		// Controller does not implement create_item().
 	}
 
 	/**
 	 * The delete_item() method does not exist for block rendering.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_delete_item() {
-		$this->markTestSkipped( 'Controller does not implement delete_item().' );
+		// Controller does not implement delete_item().
 	}
 
 	/**
 	 * The get_items() method does not exist for block rendering.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_get_items() {
-		$this->markTestSkipped( 'Controller does not implement get_items().' );
+		// Controller does not implement get_items().
 	}
 
 	/**
-	 * The context_param() method does not exist for block rendering.
+	 * The get_context_param() method is not used for block rendering.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_context_param() {
-		$this->markTestSkipped( 'Controller does not implement context_param().' );
+		// Controller does not use get_context_param().
 	}
 
 	/**
 	 * The prepare_item() method does not exist for block rendering.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_prepare_item() {
-		$this->markTestSkipped( 'Controller does not implement prepare_item().' );
+		// Controller does not implement prepare_item().
 	}
 }
diff --git a/tests/rest-api/rest-block-type-controller.php b/tests/rest-api/rest-block-type-controller.php
index a774b9be1f..ed3ee62fe8 100644
--- a/tests/rest-api/rest-block-type-controller.php
+++ b/tests/rest-api/rest-block-type-controller.php
@@ -221,6 +221,7 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			'keywords'         => 'invalid_keywords',
 			'example'          => 'invalid_example',
 			'parent'           => 'invalid_parent',
+			'ancestor'         => 'invalid_ancestor',
 			'supports'         => 'invalid_supports',
 			'styles'           => 'invalid_styles',
 			'render_callback'  => 'invalid_callback',
@@ -236,16 +237,22 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$this->assertSame( '1', $data['title'] );
 		$this->assertSame( '1', $data['description'] );
 		$this->assertNull( $data['icon'] );
-		$this->assertNull( $data['editor_script'] );
-		$this->assertNull( $data['script'] );
-		$this->assertNull( $data['view_script'] );
-		$this->assertNull( $data['editor_style'] );
-		$this->assertNull( $data['style'] );
+		$this->assertSameSets( array(), $data['editor_script_handles'] );
+		$this->assertSameSets( array(), $data['script_handles'] );
+		$this->assertSameSets( array(), $data['view_script_handles'] );
+		$this->assertSameSets( array(), $data['editor_style_handles'] );
+		$this->assertSameSets( array(), $data['style_handles'] );
 		$this->assertSameSets( array(), $data['provides_context'] );
-		$this->assertSameSets( array(), $data['attributes'] );
+		$this->assertSameSetsWithIndex(
+			array(
+				'lock' => array( 'type' => 'object' ),
+			),
+			$data['attributes']
+		);
 		$this->assertSameSets( array( 'invalid_uses_context' ), $data['uses_context'] );
 		$this->assertSameSets( array( 'invalid_keywords' ), $data['keywords'] );
 		$this->assertSameSets( array( 'invalid_parent' ), $data['parent'] );
+		$this->assertSameSets( array( 'invalid_ancestor' ), $data['ancestor'] );
 		$this->assertSameSets( array(), $data['supports'] );
 		$this->assertSameSets( array(), $data['styles'] );
 		$this->assertNull( $data['example'] );
@@ -253,6 +260,13 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$this->assertNull( $data['textdomain'] );
 		$this->assertFalse( $data['is_dynamic'] );
 		$this->assertSameSets( array( array() ), $data['variations'] );
+		// Deprecated properties.
+		$this->assertNull( $data['editor_script'] );
+		$this->assertNull( $data['script'] );
+		$this->assertNull( $data['view_script'] );
+		$this->assertNull( $data['editor_style'] );
+		$this->assertNull( $data['style'] );
+
 	}
 
 	/**
@@ -275,6 +289,7 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			'style'            => false,
 			'keywords'         => false,
 			'parent'           => false,
+			'ancestor'         => false,
 			'supports'         => false,
 			'styles'           => false,
 			'render_callback'  => false,
@@ -291,16 +306,22 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$this->assertSame( '', $data['title'] );
 		$this->assertSame( '', $data['description'] );
 		$this->assertNull( $data['icon'] );
-		$this->assertNull( $data['editor_script'] );
-		$this->assertNull( $data['script'] );
-		$this->assertNull( $data['view_script'] );
-		$this->assertNull( $data['editor_style'] );
-		$this->assertNull( $data['style'] );
-		$this->assertSameSets( array(), $data['attributes'] );
+		$this->assertSameSets( array(), $data['editor_script_handles'] );
+		$this->assertSameSets( array(), $data['script_handles'] );
+		$this->assertSameSets( array(), $data['view_script_handles'] );
+		$this->assertSameSets( array(), $data['editor_style_handles'] );
+		$this->assertSameSets( array(), $data['style_handles'] );
+		$this->assertSameSetsWithIndex(
+			array(
+				'lock' => array( 'type' => 'object' ),
+			),
+			$data['attributes']
+		);
 		$this->assertSameSets( array(), $data['provides_context'] );
 		$this->assertSameSets( array(), $data['uses_context'] );
 		$this->assertSameSets( array(), $data['keywords'] );
 		$this->assertSameSets( array(), $data['parent'] );
+		$this->assertSameSets( array(), $data['ancestor'] );
 		$this->assertSameSets( array(), $data['supports'] );
 		$this->assertSameSets( array(), $data['styles'] );
 		$this->assertNull( $data['example'] );
@@ -309,6 +330,12 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$this->assertNull( $data['textdomain'] );
 		$this->assertFalse( $data['is_dynamic'] );
 		$this->assertSameSets( array(), $data['variations'] );
+		// Deprecated properties.
+		$this->assertNull( $data['editor_script'] );
+		$this->assertNull( $data['script'] );
+		$this->assertNull( $data['view_script'] );
+		$this->assertNull( $data['editor_style'] );
+		$this->assertNull( $data['style'] );
 	}
 
 	public function test_get_variation() {
@@ -378,7 +405,7 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertCount( 22, $properties );
+		$this->assertCount( 28, $properties );
 		$this->assertArrayHasKey( 'api_version', $properties );
 		$this->assertArrayHasKey( 'title', $properties );
 		$this->assertArrayHasKey( 'icon', $properties );
@@ -391,16 +418,24 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 		$this->assertArrayHasKey( 'supports', $properties );
 		$this->assertArrayHasKey( 'category', $properties );
 		$this->assertArrayHasKey( 'is_dynamic', $properties );
-		$this->assertArrayHasKey( 'editor_script', $properties );
-		$this->assertArrayHasKey( 'script', $properties );
-		$this->assertArrayHasKey( 'view_script', $properties );
-		$this->assertArrayHasKey( 'editor_style', $properties );
-		$this->assertArrayHasKey( 'style', $properties );
+		$this->assertArrayHasKey( 'editor_script_handles', $properties );
+		$this->assertArrayHasKey( 'script_handles', $properties );
+		$this->assertArrayHasKey( 'view_script_handles', $properties );
+		$this->assertArrayHasKey( 'editor_style_handles', $properties );
+		$this->assertArrayHasKey( 'style_handles', $properties );
 		$this->assertArrayHasKey( 'parent', $properties );
 		$this->assertArrayHasKey( 'example', $properties );
 		$this->assertArrayHasKey( 'uses_context', $properties );
 		$this->assertArrayHasKey( 'provides_context', $properties );
 		$this->assertArrayHasKey( 'variations', $properties );
+		$this->assertArrayHasKey( 'ancestor', $properties );
+		// Deprecated properties.
+		$this->assertArrayHasKey( 'editor_script', $properties );
+		$this->assertArrayHasKey( 'script', $properties );
+		$this->assertArrayHasKey( 'view_script', $properties );
+		$this->assertArrayHasKey( 'editor_style', $properties );
+		$this->assertArrayHasKey( 'style', $properties );
+
 	}
 
 	/**
@@ -503,11 +538,11 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			'api_version',
 			'name',
 			'category',
-			'editor_script',
-			'script',
-			'view_script',
-			'editor_style',
-			'style',
+			'editor_script_handles',
+			'script_handles',
+			'view_script_handles',
+			'editor_style_handles',
+			'style_handles',
 			'title',
 			'icon',
 			'description',
@@ -519,6 +554,12 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			'styles',
 			'textdomain',
 			'example',
+			// Deprecated fields.
+			'editor_script',
+			'script',
+			'view_script',
+			'editor_style',
+			'style',
 		);
 
 		foreach ( $extra_fields as $extra_field ) {
@@ -536,17 +577,29 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 	}
 
 	/**
-	 * The test_create_item() method does not exist for block types.
+	 * The create_item() method does not exist for block types.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_create_item() {}
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
 
 	/**
-	 * The test_update_item() method does not exist for block types.
+	 * The update_item() method does not exist for block types.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_update_item() {}
+	public function test_update_item() {
+		// Controller does not implement create_item().
+	}
 
 	/**
-	 * The test_delete_item() method does not exist for block types.
+	 * The delete_item() method does not exist for block types.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_delete_item() {}
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
 }
diff --git a/tests/rest-api/rest-categories-controller.php b/tests/rest-api/rest-categories-controller.php
index 01bddd3738..805472487f 100644
--- a/tests/rest-api/rest-categories-controller.php
+++ b/tests/rest-api/rest-categories-controller.php
@@ -38,7 +38,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 
 		// Set up categories for pagination tests.
 		for ( $i = 0; $i < self::$total_categories - 1; $i++ ) {
-			$category_ids[] = $factory->category->create(
+			self::$category_ids[] = $factory->category->create(
 				array(
 					'name' => "Category {$i}",
 				)
@@ -121,7 +121,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 		$this->assertSame( 'view', $data['endpoints'][0]['args']['context']['default'] );
 		$this->assertSameSets( array( 'view', 'embed', 'edit' ), $data['endpoints'][0]['args']['context']['enum'] );
 		// Single.
-		$category1 = $this->factory->category->create( array( 'name' => 'Season 5' ) );
+		$category1 = self::factory()->category->create( array( 'name' => 'Season 5' ) );
 		$request   = new WP_REST_Request( 'OPTIONS', '/wp/v2/categories/' . $category1 );
 		$response  = rest_get_server()->dispatch( $request );
 		$data      = $response->get_data();
@@ -172,9 +172,9 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_hide_empty_arg() {
-		$post_id   = $this->factory->post->create();
-		$category1 = $this->factory->category->create( array( 'name' => 'Season 5' ) );
-		$category2 = $this->factory->category->create( array( 'name' => 'The Be Sharps' ) );
+		$post_id   = self::factory()->post->create();
+		$category1 = self::factory()->category->create( array( 'name' => 'Season 5' ) );
+		$category2 = self::factory()->category->create( array( 'name' => 'The Be Sharps' ) );
 
 		$total_categories = self::$total_categories + 2;
 
@@ -197,15 +197,15 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_parent_zero_arg() {
-		$parent1 = $this->factory->category->create( array( 'name' => 'Homer' ) );
-		$parent2 = $this->factory->category->create( array( 'name' => 'Marge' ) );
-		$this->factory->category->create(
+		$parent1 = self::factory()->category->create( array( 'name' => 'Homer' ) );
+		$parent2 = self::factory()->category->create( array( 'name' => 'Marge' ) );
+		self::factory()->category->create(
 			array(
 				'name'   => 'Bart',
 				'parent' => $parent1,
 			)
 		);
-		$this->factory->category->create(
+		self::factory()->category->create(
 			array(
 				'name'   => 'Lisa',
 				'parent' => $parent2,
@@ -229,15 +229,15 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_parent_zero_arg_string() {
-		$parent1 = $this->factory->category->create( array( 'name' => 'Homer' ) );
-		$parent2 = $this->factory->category->create( array( 'name' => 'Marge' ) );
-		$this->factory->category->create(
+		$parent1 = self::factory()->category->create( array( 'name' => 'Homer' ) );
+		$parent2 = self::factory()->category->create( array( 'name' => 'Marge' ) );
+		self::factory()->category->create(
 			array(
 				'name'   => 'Bart',
 				'parent' => $parent1,
 			)
 		);
-		$this->factory->category->create(
+		self::factory()->category->create(
 			array(
 				'name'   => 'Lisa',
 				'parent' => $parent2,
@@ -261,7 +261,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_by_parent_non_found() {
-		$parent1 = $this->factory->category->create( array( 'name' => 'Homer' ) );
+		$parent1 = self::factory()->category->create( array( 'name' => 'Homer' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
 		$request->set_param( 'parent', $parent1 );
@@ -284,8 +284,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_include_query() {
-		$id1 = $this->factory->category->create();
-		$id2 = $this->factory->category->create();
+		$id1 = self::factory()->category->create();
+		$id2 = self::factory()->category->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
 
@@ -305,8 +305,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_exclude_query() {
-		$id1 = $this->factory->category->create();
-		$id2 = $this->factory->category->create();
+		$id1 = self::factory()->category->create();
+		$id2 = self::factory()->category->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
 		$request->set_param( 'per_page', self::$per_page );
@@ -325,8 +325,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_orderby_args() {
-		$this->factory->category->create( array( 'name' => 'Apple' ) );
-		$this->factory->category->create( array( 'name' => 'Banana' ) );
+		self::factory()->category->create( array( 'name' => 'Apple' ) );
+		self::factory()->category->create( array( 'name' => 'Banana' ) );
 
 		/*
 		 * Tests:
@@ -356,9 +356,9 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_orderby_id() {
-		$this->factory->category->create( array( 'name' => 'Cantaloupe' ) );
-		$this->factory->category->create( array( 'name' => 'Apple' ) );
-		$this->factory->category->create( array( 'name' => 'Banana' ) );
+		self::factory()->category->create( array( 'name' => 'Cantaloupe' ) );
+		self::factory()->category->create( array( 'name' => 'Apple' ) );
+		self::factory()->category->create( array( 'name' => 'Banana' ) );
 
 		// Defaults to 'orderby' => 'name', 'order' => 'asc'.
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/categories' );
@@ -392,9 +392,9 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_orderby_slugs() {
-		$this->factory->category->create( array( 'name' => 'Burrito' ) );
-		$this->factory->category->create( array( 'name' => 'Taco' ) );
-		$this->factory->category->create( array( 'name' => 'Chalupa' ) );
+		self::factory()->category->create( array( 'name' => 'Burrito' ) );
+		self::factory()->category->create( array( 'name' => 'Taco' ) );
+		self::factory()->category->create( array( 'name' => 'Chalupa' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
 		$request->set_param( 'orderby', 'include_slugs' );
@@ -408,20 +408,20 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	protected function post_with_categories() {
-		$post_id   = $this->factory->post->create();
-		$category1 = $this->factory->category->create(
+		$post_id   = self::factory()->post->create();
+		$category1 = self::factory()->category->create(
 			array(
 				'name'        => 'DC',
 				'description' => 'Purveyor of fine detective comics',
 			)
 		);
-		$category2 = $this->factory->category->create(
+		$category2 = self::factory()->category->create(
 			array(
 				'name'        => 'Marvel',
 				'description' => 'Home of the Marvel Universe',
 			)
 		);
-		$category3 = $this->factory->category->create(
+		$category3 = self::factory()->category->create(
 			array(
 				'name'        => 'Image',
 				'description' => 'American independent comic publisher',
@@ -493,25 +493,25 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 		register_taxonomy( 'batman', 'post', array( 'show_in_rest' => true ) );
 		$controller = new WP_REST_Terms_Controller( 'batman' );
 		$controller->register_routes();
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'batman',
 			)
 		);
-		$term2 = $this->factory->term->create(
+		$term2 = self::factory()->term->create(
 			array(
 				'name'     => 'Mask',
 				'taxonomy' => 'batman',
 			)
 		);
-		$this->factory->term->create(
+		self::factory()->term->create(
 			array(
 				'name'     => 'Car',
 				'taxonomy' => 'batman',
 			)
 		);
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 		wp_set_object_terms( $post_id, array( $term1, $term2 ), 'batman' );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/batman' );
@@ -525,8 +525,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_search_args() {
-		$this->factory->category->create( array( 'name' => 'Apple' ) );
-		$this->factory->category->create( array( 'name' => 'Banana' ) );
+		self::factory()->category->create( array( 'name' => 'Apple' ) );
+		self::factory()->category->create( array( 'name' => 'Banana' ) );
 
 		/*
 		 * Tests:
@@ -549,8 +549,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_items_slug_arg() {
-		$this->factory->category->create( array( 'name' => 'Apple' ) );
-		$this->factory->category->create( array( 'name' => 'Banana' ) );
+		self::factory()->category->create( array( 'name' => 'Apple' ) );
+		self::factory()->category->create( array( 'name' => 'Banana' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
 		$request->set_param( 'slug', 'apple' );
@@ -562,8 +562,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_terms_parent_arg() {
-		$category1 = $this->factory->category->create( array( 'name' => 'Parent' ) );
-		$this->factory->category->create(
+		$category1 = self::factory()->category->create( array( 'name' => 'Parent' ) );
+		self::factory()->category->create(
 			array(
 				'name'   => 'Child',
 				'parent' => $category1,
@@ -587,13 +587,13 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 
 	public function test_get_terms_private_taxonomy() {
 		register_taxonomy( 'robin', 'post', array( 'public' => false ) );
-		$this->factory->term->create(
+		self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'robin',
 			)
 		);
-		$this->factory->term->create(
+		self::factory()->term->create(
 			array(
 				'name'     => 'Mask',
 				'taxonomy' => 'robin',
@@ -632,7 +632,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 		$this->assertStringContainsString( '<' . $next_link . '>; rel="next"', $headers['Link'] );
 
 		// 3rd page.
-		$this->factory->category->create();
+		self::factory()->category->create();
 		$total_categories++;
 		$total_pages++;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/categories' );
@@ -775,7 +775,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 
 	public function test_get_term_private_taxonomy() {
 		register_taxonomy( 'robin', 'post', array( 'public' => false ) );
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'robin',
@@ -789,7 +789,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 
 	public function test_get_item_incorrect_taxonomy() {
 		register_taxonomy( 'robin', 'post' );
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'robin',
@@ -824,7 +824,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_create_item_term_already_exists() {
 		wp_set_current_user( self::$administrator );
 
-		$existing_id = $this->factory->category->create( array( 'name' => 'Existing' ) );
+		$existing_id = self::factory()->category->create( array( 'name' => 'Existing' ) );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/categories' );
 		$request->set_param( 'name', 'Existing' );
@@ -890,7 +890,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_create_item_invalid_parent() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$term = get_term_by( 'id', self::factory()->category->create(), 'category' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/categories/' . $term->term_id );
 		$request->set_param( 'name', 'My Awesome Term' );
@@ -922,7 +922,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 			'slug'        => 'original-slug',
 		);
 
-		$term = get_term_by( 'id', $this->factory->category->create( $orig_args ), 'category' );
+		$term = get_term_by( 'id', self::factory()->category->create( $orig_args ), 'category' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/categories/' . $term->term_id );
 		$request->set_param( 'name', 'New Name' );
@@ -968,7 +968,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_update_item_incorrect_permissions() {
 		wp_set_current_user( self::$subscriber );
 
-		$term = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$term = get_term_by( 'id', self::factory()->category->create(), 'category' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/categories/' . $term->term_id );
 		$request->set_param( 'name', 'Incorrect permissions' );
@@ -979,8 +979,8 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_update_item_parent() {
 		wp_set_current_user( self::$administrator );
 
-		$parent = get_term_by( 'id', $this->factory->category->create(), 'category' );
-		$term   = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$parent = get_term_by( 'id', self::factory()->category->create(), 'category' );
+		$term   = get_term_by( 'id', self::factory()->category->create(), 'category' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/categories/' . $term->term_id );
 		$request->set_param( 'parent', $parent->term_id );
@@ -994,12 +994,12 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_update_item_remove_parent() {
 		wp_set_current_user( self::$administrator );
 
-		$old_parent_term = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$old_parent_term = get_term_by( 'id', self::factory()->category->create(), 'category' );
 		$new_parent_id   = 0;
 
 		$term = get_term_by(
 			'id',
-			$this->factory->category->create(
+			self::factory()->category->create(
 				array(
 					'parent' => $old_parent_term->term_id,
 				)
@@ -1021,7 +1021,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_update_item_invalid_parent() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$term = get_term_by( 'id', self::factory()->category->create(), 'category' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/categories/' . $term->term_id );
 		$request->set_param( 'parent', REST_TESTS_IMPOSSIBLY_HIGH_NUMBER );
@@ -1032,7 +1032,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_delete_item() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->category->create( array( 'name' => 'Deleted Category' ) ), 'category' );
+		$term = get_term_by( 'id', self::factory()->category->create( array( 'name' => 'Deleted Category' ) ), 'category' );
 
 		$request = new WP_REST_Request( 'DELETE', '/wp/v2/categories/' . $term->term_id );
 		$request->set_param( 'force', true );
@@ -1046,7 +1046,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_delete_item_no_trash() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->category->create( array( 'name' => 'Deleted Category' ) ), 'category' );
+		$term = get_term_by( 'id', self::factory()->category->create( array( 'name' => 'Deleted Category' ) ), 'category' );
 
 		$request  = new WP_REST_Request( 'DELETE', '/wp/v2/categories/' . $term->term_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -1076,7 +1076,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	public function test_delete_item_incorrect_permissions() {
 		wp_set_current_user( self::$subscriber );
 
-		$term     = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$term     = get_term_by( 'id', self::factory()->category->create(), 'category' );
 		$request  = new WP_REST_Request( 'DELETE', '/wp/v2/categories/' . $term->term_id );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_cannot_delete', $response, 403 );
@@ -1108,7 +1108,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_prepare_taxonomy_term_child() {
-		$child = $this->factory->category->create(
+		$child = self::factory()->category->create(
 			array(
 				'parent' => 1,
 			)
@@ -1170,7 +1170,7 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 		$this->assertArrayHasKey( 'my_custom_int', $data['schema']['properties'] );
 		$this->assertSame( $schema, $data['schema']['properties']['my_custom_int'] );
 
-		$category_id = $this->factory->category->create();
+		$category_id = self::factory()->category->create();
 		$request     = new WP_REST_Request( 'GET', '/wp/v2/categories/' . $category_id );
 
 		$response = rest_get_server()->dispatch( $request );
diff --git a/tests/rest-api/rest-comments-controller.php b/tests/rest-api/rest-comments-controller.php
index 0c7ed625b7..eb66ee5d41 100644
--- a/tests/rest-api/rest-comments-controller.php
+++ b/tests/rest-api/rest-comments-controller.php
@@ -117,7 +117,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		// Set up comments for pagination tests.
 		for ( $i = 0; $i < self::$total_comments - 1; $i++ ) {
-			$comment_ids[] = $factory->comment->create(
+			self::$comment_ids[] = $factory->comment->create(
 				array(
 					'comment_content' => "Comment {$i}",
 					'comment_post_ID' => self::$post_id,
@@ -237,7 +237,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_param( 'password', 'toomanysecrets' );
@@ -261,7 +261,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_param( 'password', 'toomanysecrets' );
@@ -284,7 +284,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_param( 'password', 'toomanysecrets' );
@@ -302,7 +302,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 
@@ -321,7 +321,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 
@@ -340,7 +340,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$private_id,
 		);
 
-		$private_comment = $this->factory->comment->create( $args );
+		$private_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 
@@ -359,7 +359,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$private_id,
 		);
 
-		$private_comment = $this->factory->comment->create( $args );
+		$private_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 
@@ -373,7 +373,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_get_items_with_invalid_post() {
 		wp_set_current_user( 0 );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => REST_TESTS_IMPOSSIBLY_HIGH_NUMBER,
@@ -394,7 +394,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_get_items_with_invalid_post_permission() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => REST_TESTS_IMPOSSIBLY_HIGH_NUMBER,
@@ -424,7 +424,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_get_items_no_post() {
 		wp_set_current_user( self::$admin_id );
 
-		$this->factory->comment->create_post_comments( 0, 2 );
+		self::factory()->comment->create_post_comments( 0, 2 );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_param( 'post', 0 );
@@ -453,8 +453,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_get_items_for_post() {
-		$second_post_id = $this->factory->post->create();
-		$this->factory->comment->create_post_comments( $second_post_id, 2 );
+		$second_post_id = self::factory()->post->create();
+		self::factory()->comment->create_post_comments( $second_post_id, 2 );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_query_params(
@@ -478,8 +478,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$post_id,
 		);
 
-		$id1 = $this->factory->comment->create( $args );
-		$id2 = $this->factory->comment->create( $args );
+		$id1 = self::factory()->comment->create( $args );
+		$id2 = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 
@@ -518,8 +518,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$post_id,
 		);
 
-		$id1 = $this->factory->comment->create( $args );
-		$id2 = $this->factory->comment->create( $args );
+		$id1 = self::factory()->comment->create( $args );
+		$id2 = self::factory()->comment->create( $args );
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$response = rest_get_server()->dispatch( $request );
@@ -574,7 +574,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$post_id,
 		);
 
-		$id = $this->factory->comment->create( $args );
+		$id = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 
@@ -598,7 +598,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_get_items_private_post_no_permissions() {
 		wp_set_current_user( 0 );
 
-		$post_id = $this->factory->post->create( array( 'post_status' => 'private' ) );
+		$post_id = self::factory()->post->create( array( 'post_status' => 'private' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
 		$request->set_param( 'post', $post_id );
@@ -616,11 +616,11 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'user_id'          => self::$author_id,
 		);
 
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 		$args['user_id'] = self::$subscriber_id;
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 		unset( $args['user_id'] );
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 
 		// Limit to comment author.
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
@@ -659,11 +659,11 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'user_id'          => self::$author_id,
 		);
 
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 		$args['user_id'] = self::$subscriber_id;
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 		unset( $args['user_id'] );
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 
 		$total_comments = self::$total_comments + 3;
 
@@ -709,12 +709,12 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_approved' => 1,
 			'comment_post_ID'  => self::$post_id,
 		);
-		$parent_id              = $this->factory->comment->create( $args );
-		$parent_id2             = $this->factory->comment->create( $args );
+		$parent_id              = self::factory()->comment->create( $args );
+		$parent_id2             = self::factory()->comment->create( $args );
 		$args['comment_parent'] = $parent_id;
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 		$args['comment_parent'] = $parent_id2;
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 
 		$total_comments = self::$total_comments + 4;
 
@@ -745,12 +745,12 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_approved' => 1,
 			'comment_post_ID'  => self::$post_id,
 		);
-		$parent_id              = $this->factory->comment->create( $args );
-		$parent_id2             = $this->factory->comment->create( $args );
+		$parent_id              = self::factory()->comment->create( $args );
+		$parent_id2             = self::factory()->comment->create( $args );
 		$args['comment_parent'] = $parent_id;
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 		$args['comment_parent'] = $parent_id2;
-		$this->factory->comment->create( $args );
+		self::factory()->comment->create( $args );
 
 		$total_comments = self::$total_comments + 4;
 
@@ -786,7 +786,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_author'   => 'Homer J Simpson',
 		);
 
-		$id = $this->factory->comment->create( $args );
+		$id = self::factory()->comment->create( $args );
 
 		$total_comments = self::$total_comments + 1;
 
@@ -825,7 +825,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertStringContainsString( '<' . $next_link . '>; rel="next"', $headers['Link'] );
 
 		// 3rd page.
-		$this->factory->comment->create(
+		self::factory()->comment->create(
 			array(
 				'comment_post_ID' => self::$post_id,
 			)
@@ -888,26 +888,26 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 	public function test_get_comments_invalid_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/comments' );
-		$request->set_param( 'after', rand_str() );
-		$request->set_param( 'before', rand_str() );
+		$request->set_param( 'after', 'foo' );
+		$request->set_param( 'before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
 
 	public function test_get_comments_valid_date() {
-		$comment1 = $this->factory->comment->create(
+		$comment1 = self::factory()->comment->create(
 			array(
 				'comment_date'    => '2016-01-15T00:00:00Z',
 				'comment_post_ID' => self::$post_id,
 			)
 		);
-		$comment2 = $this->factory->comment->create(
+		$comment2 = self::factory()->comment->create(
 			array(
 				'comment_date'    => '2016-01-16T00:00:00Z',
 				'comment_post_ID' => self::$post_id,
 			)
 		);
-		$comment3 = $this->factory->comment->create(
+		$comment3 = self::factory()->comment->create(
 			array(
 				'comment_date'    => '2016-01-17T00:00:00Z',
 				'comment_post_ID' => self::$post_id,
@@ -1003,7 +1003,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_get_comment_invalid_post_id() {
 		wp_set_current_user( 0 );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => REST_TESTS_IMPOSSIBLY_HIGH_NUMBER,
@@ -1018,7 +1018,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_get_comment_invalid_post_id_as_admin() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => REST_TESTS_IMPOSSIBLY_HIGH_NUMBER,
@@ -1047,7 +1047,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_get_comment_with_children_link() {
-		$comment_id_1 = $this->factory->comment->create(
+		$comment_id_1 = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -1055,7 +1055,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			)
 		);
 
-		$child_comment = $this->factory->comment->create(
+		$child_comment = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_parent'   => $comment_id_1,
@@ -1071,7 +1071,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_get_comment_without_children_link() {
-		$comment_id_1 = $this->factory->comment->create(
+		$comment_id_1 = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -1093,7 +1093,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/comments/%s', $password_comment ) );
 		$response = rest_get_server()->dispatch( $request );
@@ -1111,7 +1111,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'comment_post_ID'  => self::$password_id,
 		);
 
-		$password_comment = $this->factory->comment->create( $args );
+		$password_comment = self::factory()->comment->create( $args );
 
 		$request = new WP_REST_Request( 'GET', sprintf( '/wp/v2/comments/%s', $password_comment ) );
 		$request->set_param( 'password', 'toomanysecrets' );
@@ -1477,7 +1477,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'author_email' => 'lovejoy@example.com',
 			'author_url'   => 'http://timothylovejoy.jr',
 			'content'      => 'It\'s all over\, people! We don\'t have a prayer!',
-			'date'         => rand_str(),
+			'date'         => 'foo-bar',
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
@@ -1490,7 +1490,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 
 	public function test_create_item_assign_different_user() {
-		$subscriber_id = $this->factory->user->create(
+		$subscriber_id = self::factory()->user->create(
 			array(
 				'role'       => 'subscriber',
 				'user_email' => 'cbg@androidsdungeon.com',
@@ -1521,7 +1521,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_create_comment_without_type() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$admin_id );
 
@@ -1559,7 +1559,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	 * @ticket 38820
 	 */
 	public function test_create_comment_with_invalid_type() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$admin_id );
 
@@ -1583,7 +1583,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_create_comment_invalid_email() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$admin_id );
 
@@ -1606,7 +1606,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_create_item_current_user() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role'         => 'subscriber',
 				'user_email'   => 'lylelanley@example.com',
@@ -1728,7 +1728,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_create_comment_with_status_IP_and_user_agent() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$admin_id );
 
@@ -2006,7 +2006,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_create_item_duplicate() {
 		wp_set_current_user( self::$subscriber_id );
 
-		$this->factory->comment->create(
+		self::factory()->comment->create(
 			array(
 				'comment_post_ID'      => self::$post_id,
 				'comment_author'       => 'Guy N. Cognito',
@@ -2031,7 +2031,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_create_comment_closed() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'comment_status' => 'closed',
 			)
@@ -2303,7 +2303,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_update_item() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$admin_id );
 
@@ -2347,7 +2347,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		update_option( 'timezone_string', $params['timezone_string'] );
 
-		$comment_id = $this->factory->comment->create();
+		$comment_id = self::factory()->comment->create();
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', $comment_id ) );
 		if ( isset( $params['date'] ) ) {
@@ -2374,7 +2374,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_update_item_no_content() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$admin_id );
 
@@ -2412,7 +2412,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_update_comment_status() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 0,
 				'comment_post_ID'  => self::$post_id,
@@ -2439,7 +2439,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_update_comment_field_does_not_use_default_values() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 0,
 				'comment_post_ID'  => self::$post_id,
@@ -2625,8 +2625,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		wp_set_current_user( self::$admin_id );
 
 		$params = array(
-			'content' => rand_str(),
-			'date'    => rand_str(),
+			'content' => 'content',
+			'date'    => 'foo',
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
@@ -2641,8 +2641,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		wp_set_current_user( self::$admin_id );
 
 		$params = array(
-			'content'  => rand_str(),
-			'date_gmt' => rand_str(),
+			'content'  => 'content',
+			'date_gmt' => 'foo',
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
@@ -2720,7 +2720,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public function test_update_comment_private_post_invalid_permission() {
-		$private_comment_id = $this->factory->comment->create(
+		$private_comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$private_id,
@@ -2745,7 +2745,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_update_comment_with_children_link() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id_1 = $this->factory->comment->create(
+		$comment_id_1 = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -2753,7 +2753,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			)
 		);
 
-		$child_comment = $this->factory->comment->create(
+		$child_comment = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -2770,7 +2770,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		// Change the comment parent.
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%s', $child_comment ) );
 		$request->set_param( 'parent', $comment_id_1 );
-		$request->set_param( 'content', rand_str() );
+		$request->set_param( 'content', 'foo bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertSame( 200, $response->get_status() );
 
@@ -3047,7 +3047,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_delete_item() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -3067,7 +3067,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_delete_item_skip_trash() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -3088,7 +3088,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_delete_item_already_trashed() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -3123,7 +3123,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	public function test_delete_child_comment_link() {
 		wp_set_current_user( self::$admin_id );
 
-		$comment_id_1 = $this->factory->comment->create(
+		$comment_id_1 = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_post_ID'  => self::$post_id,
@@ -3131,7 +3131,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			)
 		);
 
-		$child_comment = $this->factory->comment->create(
+		$child_comment = self::factory()->comment->create(
 			array(
 				'comment_approved' => 1,
 				'comment_parent'   => $comment_id_1,
diff --git a/tests/rest-api/rest-controller.php b/tests/rest-api/rest-controller.php
index 270d1f32d1..77b1596d3d 100644
--- a/tests/rest-api/rest-controller.php
+++ b/tests/rest-api/rest-controller.php
@@ -11,6 +11,11 @@
  */
 class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
 
+	/**
+	 * @var WP_REST_Request
+	 */
+	private $request;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		// Load the WP_REST_Test_Controller class if not already loaded.
 		require_once __DIR__ . '/rest-test-controller.php';
@@ -386,6 +391,7 @@ class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
 				'somedefault',
 				'somearray',
 				'someobject',
+				'_links',
 			),
 			$fields
 		);
@@ -421,11 +427,23 @@ class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
 					'somedefault',
 					'somearray',
 					'someobject',
+					'_links',
 				),
 			),
 		);
 	}
 
+	public function test_get_fields_for_response_respects_embed() {
+		$controller = new WP_REST_Test_Controller();
+		$request    = new WP_REST_Request( 'GET', '/wp/v2/testroute' );
+
+		$this->assertNotContains( '_embedded', $controller->get_fields_for_response( $request ) );
+
+		$request->set_param( '_embed', 1 );
+
+		$this->assertContains( '_embedded', $controller->get_fields_for_response( $request ) );
+	}
+
 	public function test_get_fields_for_response_filters_by_context() {
 		$controller = new WP_REST_Test_Controller();
 
diff --git a/tests/rest-api/rest-global-styles-controller.php b/tests/rest-api/rest-global-styles-controller.php
index e99232985b..0c27723a1c 100644
--- a/tests/rest-api/rest-global-styles-controller.php
+++ b/tests/rest-api/rest-global-styles-controller.php
@@ -93,21 +93,49 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 
 	/**
 	 * @covers WP_REST_Global_Styles_Controller::register_routes
+	 * @ticket 54596
 	 */
 	public function test_register_routes() {
 		$routes = rest_get_server()->get_routes();
-		$this->assertArrayHasKey( '/wp/v2/global-styles/(?P<id>[\/\w-]+)', $routes );
-		$this->assertCount( 2, $routes['/wp/v2/global-styles/(?P<id>[\/\w-]+)'] );
-		$this->assertArrayHasKey( '/wp/v2/global-styles/themes/(?P<stylesheet>[^.\/]+(?:\/[^.\/]+)?)', $routes );
-		$this->assertCount( 1, $routes['/wp/v2/global-styles/themes/(?P<stylesheet>[^.\/]+(?:\/[^.\/]+)?)'] );
+		$this->assertArrayHasKey(
+			'/wp/v2/global-styles/(?P<id>[\/\w-]+)',
+			$routes,
+			'Single global style based on the given ID route does not exist'
+		);
+		$this->assertCount(
+			2,
+			$routes['/wp/v2/global-styles/(?P<id>[\/\w-]+)'],
+			'Single global style based on the given ID route does not have exactly two elements'
+		);
+		$this->assertArrayHasKey(
+			'/wp/v2/global-styles/themes/(?P<stylesheet>[^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)',
+			$routes,
+			'Theme global styles route does not exist'
+		);
+		$this->assertCount(
+			1,
+			$routes['/wp/v2/global-styles/themes/(?P<stylesheet>[^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)'],
+			'Theme global styles route does not have exactly one element'
+		);
+		$this->assertArrayHasKey(
+			'/wp/v2/global-styles/themes/(?P<stylesheet>[\/\s%\w\.\(\)\[\]\@_\-]+)/variations',
+			$routes,
+			'Theme global styles variations route does not exist'
+		);
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_context_param() {
-		$this->markTestSkipped( 'Controller does not implement context_param().' );
+		// Controller does not use get_context_param().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_get_items() {
-		$this->markTestSkipped( 'Controller does not implement get_items().' );
+		// Controller does not implement get_items().
 	}
 
 	/**
@@ -132,7 +160,6 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 		$this->assertErrorResponse( 'rest_cannot_manage_global_styles', $response, 403 );
 	}
 
-
 	/**
 	 * @covers WP_REST_Global_Styles_Controller::get_theme_item
 	 * @ticket 54516
@@ -145,17 +172,136 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 	}
 
 	/**
+	 * @dataProvider data_get_theme_item_invalid_theme_dirname
 	 * @covers WP_REST_Global_Styles_Controller::get_theme_item
+	 * @ticket 54596
+	 *
+	 * @param string $theme_dirname Theme directory to test.
+	 * @param string $expected      Expected error code.
 	 */
-	public function test_get_theme_item() {
+	public function test_get_theme_item_invalid_theme_dirname( $theme_dirname, $expected ) {
 		wp_set_current_user( self::$admin_id );
-		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/themes/tt1-blocks' );
+		switch_theme( $theme_dirname );
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/themes/' . $theme_dirname );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( $expected, $response, 404 );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_theme_item_invalid_theme_dirname() {
+		return array(
+			'+'                      => array(
+				'theme_dirname' => 'my+theme+',
+				'expected'      => 'rest_theme_not_found',
+			),
+			':'                      => array(
+				'theme_dirname' => 'my:theme:',
+				'expected'      => 'rest_no_route',
+			),
+			'<>'                     => array(
+				'theme_dirname' => 'my<theme>',
+				'expected'      => 'rest_no_route',
+			),
+			'*'                      => array(
+				'theme_dirname' => 'my*theme*',
+				'expected'      => 'rest_no_route',
+			),
+			'?'                      => array(
+				'theme_dirname' => 'my?theme?',
+				'expected'      => 'rest_no_route',
+			),
+			'"'                      => array(
+				'theme_dirname' => 'my"theme?"',
+				'expected'      => 'rest_no_route',
+			),
+			'| (invalid on Windows)' => array(
+				'theme_dirname' => 'my|theme|',
+				'expected'      => 'rest_no_route',
+			),
+			// Themes deep in subdirectories.
+			'2 subdirectories deep'  => array(
+				'theme_dirname' => 'subdir/subsubdir/mytheme',
+				'expected'      => 'rest_global_styles_not_found',
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_theme_item
+	 * @covers WP_REST_Global_Styles_Controller::get_theme_item
+	 * @ticket 54596
+	 *
+	 * @param string $theme Theme directory to test.
+	 */
+	public function test_get_theme_item( $theme ) {
+		wp_set_current_user( self::$admin_id );
+		switch_theme( $theme );
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/themes/' . $theme );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
-		unset( $data['_links'] );
+		$links    = $response->get_links();
+		$this->assertArrayHasKey( 'settings', $data, 'Data does not have "settings" key' );
+		$this->assertArrayHasKey( 'styles', $data, 'Data does not have "styles" key' );
+		$this->assertArrayHasKey( 'self', $links, 'Links do not have a "self" key' );
+		$this->assertStringContainsString( '/wp/v2/global-styles/themes/' . $theme, $links['self'][0]['href'] );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_theme_item() {
+		return array(
+			'alphabetic'                     => array( 'mytheme' ),
+			'alphanumeric'                   => array( 'mythemev1' ),
+			'àáâãäåæç'                       => array( 'àáâãäåæç' ),
+			'space'                          => array( 'my theme' ),
+			'-_.'                            => array( 'my_theme-0.1' ),
+			'[]'                             => array( 'my[theme]' ),
+			'()'                             => array( 'my(theme)' ),
+			'{}'                             => array( 'my{theme}' ),
+			'&=#@!$,^~%'                     => array( 'theme &=#@!$,^~%' ),
+			'all combined'                   => array( 'thémé {}&=@!$,^~%[0.1](-_-)' ),
+
+			// Themes in a subdirectory.
+			'subdir: alphabetic'             => array( 'subdir/mytheme' ),
+			'subdir: alphanumeric in theme'  => array( 'subdir/mythemev1' ),
+			'subdir: alphanumeric in subdir' => array( 'subdirv1/mytheme' ),
+			'subdir: alphanumeric in both'   => array( 'subdirv1/mythemev1' ),
+			'subdir: àáâãäåæç in theme'      => array( 'subdir/àáâãäåæç' ),
+			'subdir: àáâãäåæç in subdir'     => array( 'àáâãäåæç/mythemev1' ),
+			'subdir: àáâãäåæç in both'       => array( 'àáâãäåæç/àáâãäåæç' ),
+			'subdir: space in theme'         => array( 'subdir/my theme' ),
+			'subdir: space in subdir'        => array( 'sub dir/mytheme' ),
+			'subdir: space in both'          => array( 'sub dir/my theme' ),
+			'subdir: -_. in theme'           => array( 'subdir/my_theme-0.1' ),
+			'subdir: -_. in subdir'          => array( 'sub_dir-0.1/mytheme' ),
+			'subdir: -_. in both'            => array( 'sub_dir-0.1/my_theme-0.1' ),
+			'subdir: all combined in theme'  => array( 'subdir/thémé {}&=@!$,^~%[0.1](-_-)' ),
+			'subdir: all combined in subdir' => array( 'sűbdīr {}&=@!$,^~%[0.1](-_-)/mytheme' ),
+			'subdir: all combined in both'   => array( 'sűbdīr {}&=@!$,^~%[0.1](-_-)/thémé {}&=@!$,^~%[0.1](-_-)' ),
+		);
+	}
 
+	/**
+	 * @covers WP_REST_Global_Styles_Controller::get_theme_item
+	 * @ticket 54595
+	 */
+	public function test_get_theme_item_fields() {
+		wp_set_current_user( self::$admin_id );
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/themes/tt1-blocks' );
+		$request->set_param( '_fields', 'settings' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
 		$this->assertArrayHasKey( 'settings', $data );
-		$this->assertArrayHasKey( 'styles', $data );
+		$this->assertArrayNotHasKey( 'styles', $data );
 	}
 
 	/**
@@ -223,7 +369,7 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
-		unset( $data['_links'] );
+		$links    = $response->get_links();
 
 		$this->assertEquals(
 			array(
@@ -237,10 +383,16 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 			),
 			$data
 		);
+
+		$this->assertArrayHasKey( 'self', $links );
+		$this->assertStringContainsString( '/wp/v2/global-styles/' . self::$global_styles_id, $links['self'][0]['href'] );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_create_item() {
-		$this->markTestSkipped( 'Controller does not implement create_item().' );
+		// Controller does not implement create_item().
 	}
 
 	/**
@@ -294,12 +446,18 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 		$this->assertErrorResponse( 'rest_cannot_edit', $response, 403 );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_delete_item() {
-		$this->markTestSkipped( 'Controller does not implement delete_item().' );
+		// Controller does not implement delete_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_prepare_item() {
-		$this->markTestSkipped( 'Controller does not implement prepare_item().' );
+		// Controller does not implement prepare_item().
 	}
 
 	/**
@@ -317,4 +475,42 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 		$this->assertArrayHasKey( 'settings', $properties, 'Schema properties array does not have "settings" key' );
 		$this->assertArrayHasKey( 'title', $properties, 'Schema properties array does not have "title" key' );
 	}
+
+
+	public function test_get_theme_items() {
+		wp_set_current_user( self::$admin_id );
+		switch_theme( 'block-theme' );
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/global-styles/themes/block-theme/variations' );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+		$expected = array(
+			array(
+				'version'  => 2,
+				'title'    => 'Block theme variation',
+				'settings' => array(
+					'color' => array(
+						'palette' => array(
+							'theme' => array(
+								array(
+									'slug'  => 'foreground',
+									'color' => '#3F67C6',
+									'name'  => 'Foreground',
+								),
+							),
+						),
+					),
+				),
+				'styles'   => array(
+					'blocks' => array(
+						'core/post-title' => array(
+							'typography' => array(
+								'fontWeight' => '700',
+							),
+						),
+					),
+				),
+			),
+		);
+		$this->assertSameSetsWithIndex( $data, $expected );
+	}
 }
diff --git a/tests/rest-api/rest-pages-controller.php b/tests/rest-api/rest-pages-controller.php
index f4548f3fc8..a6a9cfa3f4 100644
--- a/tests/rest-api/rest-pages-controller.php
+++ b/tests/rest-api/rest-pages-controller.php
@@ -27,7 +27,6 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function set_up() {
 		parent::set_up();
-		$this->has_setup_template = false;
 		add_filter( 'theme_page_templates', array( $this, 'filter_theme_page_templates' ) );
 		// Re-register the route as we now have a template available.
 		$GLOBALS['wp_rest_server']->override_by_default = true;
@@ -52,7 +51,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertSame( 'view', $data['endpoints'][0]['args']['context']['default'] );
 		$this->assertSame( array( 'view', 'embed', 'edit' ), $data['endpoints'][0]['args']['context']['enum'] );
 		// Single.
-		$page_id  = $this->factory->post->create( array( 'post_type' => 'page' ) );
+		$page_id  = self::factory()->post->create( array( 'post_type' => 'page' ) );
 		$request  = new WP_REST_Request( 'OPTIONS', '/wp/v2/pages/' . $page_id );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
@@ -95,13 +94,13 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items() {
-		$id1      = $this->factory->post->create(
+		$id1      = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id2      = $this->factory->post->create(
+		$id2      = self::factory()->post->create(
 			array(
 				'post_status' => 'draft',
 				'post_type'   => 'page',
@@ -115,13 +114,13 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_parent_query() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
@@ -149,26 +148,26 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_parents_query() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 				'post_parent' => $id1,
 			)
 		);
-		$id3 = $this->factory->post->create(
+		$id3 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id4 = $this->factory->post->create(
+		$id4 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
@@ -191,13 +190,13 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_parent_exclude_query() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
@@ -225,27 +224,27 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_menu_order_query() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 				'menu_order'  => 2,
 			)
 		);
-		$id3 = $this->factory->post->create(
+		$id3 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 				'menu_order'  => 3,
 			)
 		);
-		$id4 = $this->factory->post->create(
+		$id4 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
@@ -303,13 +302,13 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_items_private_filter_query_var() {
 		// Private query vars inaccessible to unauthorized users.
 		wp_set_current_user( 0 );
-		$page_id  = $this->factory->post->create(
+		$page_id  = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$draft_id = $this->factory->post->create(
+		$draft_id = self::factory()->post->create(
 			array(
 				'post_status' => 'draft',
 				'post_type'   => 'page',
@@ -330,26 +329,26 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_invalid_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/pages' );
-		$request->set_param( 'after', rand_str() );
-		$request->set_param( 'before', rand_str() );
+		$request->set_param( 'after', 'foo' );
+		$request->set_param( 'before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
 
 	public function test_get_items_valid_date() {
-		$post1   = $this->factory->post->create(
+		$post1   = self::factory()->post->create(
 			array(
 				'post_date' => '2016-01-15T00:00:00Z',
 				'post_type' => 'page',
 			)
 		);
-		$post2   = $this->factory->post->create(
+		$post2   = self::factory()->post->create(
 			array(
 				'post_date' => '2016-01-16T00:00:00Z',
 				'post_type' => 'page',
 			)
 		);
-		$post3   = $this->factory->post->create(
+		$post3   = self::factory()->post->create(
 			array(
 				'post_date' => '2016-01-17T00:00:00Z',
 				'post_type' => 'page',
@@ -369,8 +368,8 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_get_items_invalid_modified_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/pages' );
-		$request->set_param( 'modified_after', rand_str() );
-		$request->set_param( 'modified_before', rand_str() );
+		$request->set_param( 'modified_after', 'foo' );
+		$request->set_param( 'modified_before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
@@ -379,19 +378,19 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 * @ticket 50617
 	 */
 	public function test_get_items_valid_modified_date() {
-		$post1 = $this->factory->post->create(
+		$post1 = self::factory()->post->create(
 			array(
 				'post_date' => '2016-01-01 00:00:00',
 				'post_type' => 'page',
 			)
 		);
-		$post2 = $this->factory->post->create(
+		$post2 = self::factory()->post->create(
 			array(
 				'post_date' => '2016-01-02 00:00:00',
 				'post_type' => 'page',
 			)
 		);
-		$post3 = $this->factory->post->create(
+		$post3 = self::factory()->post->create(
 			array(
 				'post_date' => '2016-01-03 00:00:00',
 				'post_type' => 'page',
@@ -409,19 +408,25 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertSame( $post2, $data[0]['id'] );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_get_item() {
-
+		// Controller does not implement get_item().
 	}
 
 	public function test_get_item_invalid_post_type() {
-		$post_id  = $this->factory->post->create();
+		$post_id  = self::factory()->post->create();
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/pages/' . $post_id );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertSame( 404, $response->get_status() );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_create_item() {
-
+		// Controller does not implement create_item().
 	}
 
 	public function test_create_item_with_template() {
@@ -443,7 +448,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_create_page_with_parent() {
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'type' => 'page',
 			)
@@ -485,12 +490,15 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertErrorResponse( 'rest_post_invalid_id', $response, 400 );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_update_item() {
-
+		// Controller does not implement update_item().
 	}
 
 	public function test_delete_item() {
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => 'Deleted page',
@@ -508,13 +516,16 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertSame( 'trash', $data['status'] );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_prepare_item() {
-
+		// Controller does not implement prepare_item().
 	}
 
 	public function test_prepare_item_limit_fields() {
 		wp_set_current_user( self::$editor_id );
-		$page_id  = $this->factory->post->create(
+		$page_id  = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
@@ -536,7 +547,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_pages_params() {
-		$this->factory->post->create_many(
+		self::factory()->post->create_many(
 			8,
 			array(
 				'post_type' => 'page',
@@ -567,7 +578,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_update_page_menu_order() {
 
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type' => 'page',
 			)
@@ -590,7 +601,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_update_page_menu_order_to_zero() {
 
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'menu_order' => 1,
@@ -613,12 +624,12 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_update_page_parent_non_zero() {
-		$page_id1 = $this->factory->post->create(
+		$page_id1 = self::factory()->post->create(
 			array(
 				'post_type' => 'page',
 			)
 		);
-		$page_id2 = $this->factory->post->create(
+		$page_id2 = self::factory()->post->create(
 			array(
 				'post_type' => 'page',
 			)
@@ -636,12 +647,12 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_update_page_parent_zero() {
-		$page_id1 = $this->factory->post->create(
+		$page_id1 = self::factory()->post->create(
 			array(
 				'post_type' => 'page',
 			)
 		);
-		$page_id2 = $this->factory->post->create(
+		$page_id2 = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_parent' => $page_id1,
@@ -660,7 +671,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_page_with_password() {
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type'     => 'page',
 				'post_password' => '$inthebananastand',
@@ -678,7 +689,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_page_with_password_using_password() {
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type'     => 'page',
 				'post_password' => '$inthebananastand',
@@ -700,7 +711,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_page_with_password_using_incorrect_password() {
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type'     => 'page',
 				'post_password' => '$inthebananastand',
@@ -716,7 +727,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_page_with_password_without_permission() {
-		$page_id  = $this->factory->post->create(
+		$page_id  = self::factory()->post->create(
 			array(
 				'post_type'     => 'page',
 				'post_password' => '$inthebananastand',
diff --git a/tests/rest-api/rest-pattern-directory-controller.php b/tests/rest-api/rest-pattern-directory-controller.php
index 4a12e663b5..22a9e08ad1 100644
--- a/tests/rest-api/rest-pattern-directory-controller.php
+++ b/tests/rest-api/rest-pattern-directory-controller.php
@@ -21,6 +21,15 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 	 */
 	protected static $contributor_id;
 
+	/**
+	 * An instance of WP_REST_Pattern_Directory_Controller class.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var WP_REST_Pattern_Directory_Controller
+	 */
+	private static $controller;
+
 	/**
 	 * Set up class test fixtures.
 	 *
@@ -34,6 +43,8 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 				'role' => 'contributor',
 			)
 		);
+
+		static::$controller = new WP_REST_Pattern_Directory_Controller();
 	}
 
 	/**
@@ -42,7 +53,7 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 	 * @param WP_REST_Response[] $pattern An individual pattern from the REST API response.
 	 */
 	public function assertPatternMatchesSchema( $pattern ) {
-		$schema     = ( new WP_REST_Pattern_Directory_Controller() )->get_item_schema();
+		$schema     = static::$controller->get_item_schema();
 		$pattern_id = isset( $pattern->id ) ? $pattern->id : '{pattern ID is missing}';
 
 		$this->assertTrue(
@@ -79,7 +90,7 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		$patterns = $response->get_data();
 
 		$this->assertSame( 'view', $patterns['endpoints'][0]['args']['context']['default'] );
-		$this->assertSame( array( 'view', 'embed' ), $patterns['endpoints'][0]['args']['context']['enum'] );
+		$this->assertSame( array( 'view', 'embed', 'edit' ), $patterns['endpoints'][0]['args']['context']['enum'] );
 	}
 
 	/**
@@ -100,6 +111,9 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		$this->assertGreaterThan( 0, count( $patterns ) );
 
 		array_walk( $patterns, array( $this, 'assertPatternMatchesSchema' ) );
+		$this->assertSame( array( 'blog post' ), $patterns[0]['keywords'] );
+		$this->assertSame( array( 'header', 'hero' ), $patterns[1]['keywords'] );
+		$this->assertSame( array( 'call to action', 'hero section' ), $patterns[2]['keywords'] );
 	}
 
 	/**
@@ -146,10 +160,6 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		$this->assertGreaterThan( 0, count( $patterns ) );
 
 		array_walk( $patterns, array( $this, 'assertPatternMatchesSchema' ) );
-
-		foreach ( $patterns as $pattern ) {
-			$this->assertContains( 'core', $pattern['keywords'] );
-		}
 	}
 
 	/**
@@ -300,20 +310,32 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		$this->assertSame( 'modified the cache', $patterns[0] );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_get_item() {
-		$this->markTestSkipped( 'Controller does not have get_item route.' );
+		// Controller does not implement get_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_create_item() {
-		$this->markTestSkipped( 'Controller does not have create_item route.' );
+		// Controller does not implement create_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_update_item() {
-		$this->markTestSkipped( 'Controller does not have update_item route.' );
+		// Controller does not implement update_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_delete_item() {
-		$this->markTestSkipped( 'Controller does not have delete_item route.' );
+		// Controller does not implement delete_item().
 	}
 
 	/**
@@ -322,12 +344,11 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 	 * @since 5.8.0
 	 */
 	public function test_prepare_item() {
-		$controller                   = new WP_REST_Pattern_Directory_Controller();
 		$raw_patterns                 = json_decode( self::get_raw_response( 'browse-all' ) );
 		$raw_patterns[0]->extra_field = 'this should be removed';
 
-		$prepared_pattern = $controller->prepare_response_for_collection(
-			$controller->prepare_item_for_response( $raw_patterns[0], new WP_REST_Request() )
+		$prepared_pattern = static::$controller->prepare_response_for_collection(
+			static::$controller->prepare_item_for_response( $raw_patterns[0], new WP_REST_Request() )
 		);
 
 		$this->assertPatternMatchesSchema( $prepared_pattern );
@@ -340,12 +361,11 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 	 * @since 5.8.0
 	 */
 	public function test_prepare_item_search() {
-		$controller                   = new WP_REST_Pattern_Directory_Controller();
 		$raw_patterns                 = json_decode( self::get_raw_response( 'search' ) );
 		$raw_patterns[0]->extra_field = 'this should be removed';
 
-		$prepared_pattern = $controller->prepare_response_for_collection(
-			$controller->prepare_item_for_response( $raw_patterns[0], new WP_REST_Request() )
+		$prepared_pattern = static::$controller->prepare_response_for_collection(
+			static::$controller->prepare_item_for_response( $raw_patterns[0], new WP_REST_Request() )
 		);
 
 		$this->assertPatternMatchesSchema( $prepared_pattern );
@@ -394,9 +414,101 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 	 * @covers WP_REST_Pattern_Directory_Controller::get_item_schema
 	 *
 	 * @since 5.8.0
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_get_item_schema() {
-		$this->markTestSkipped( "The controller's schema is hardcoded, so tests would not be meaningful." );
+		// The controller's schema is hardcoded, so tests would not be meaningful.
+	}
+
+	/**
+	 * Tests if the transient key gets generated correctly.
+	 *
+	 * @dataProvider data_get_query_parameters
+	 *
+	 * @covers WP_REST_Pattern_Directory_Controller::get_transient_key
+	 *
+	 * @since 6.0.0
+	 *
+	 * @ticket 55617
+	 *
+	 * @param array     $parameters_1   Expected query arguments.
+	 * @param array     $parameters_2   Actual query arguments.
+	 * @param string    $message        An error message to display.
+	 * @param bool      $assert_same    Assertion type (assertSame vs assertNotSame).
+	 */
+	public function test_transient_keys_get_generated_correctly( $parameters_1, $parameters_2, $message, $assert_same = true ) {
+		$reflection_method = new ReflectionMethod( static::$controller, 'get_transient_key' );
+		$reflection_method->setAccessible( true );
+
+		$result_1 = $reflection_method->invoke( self::$controller, $parameters_1 );
+		$result_2 = $reflection_method->invoke( self::$controller, $parameters_2 );
+
+		$this->assertIsString( $result_1, 'Transient key #1 must be a string.' );
+		$this->assertNotEmpty( $result_1, 'Transient key #1 must not be empty.' );
+
+		$this->assertIsString( $result_2, 'Transient key #2 must be a string.' );
+		$this->assertNotEmpty( $result_2, 'Transient key #2 must not be empty.' );
+
+		if ( $assert_same ) {
+			$this->assertSame( $result_1, $result_2, $message );
+		} else {
+			$this->assertNotSame( $result_1, $result_2, $message );
+		}
+
+	}
+
+	/**
+	 * @since 6.0.0
+	 *
+	 * @ticket 55617
+	 */
+	public function data_get_query_parameters() {
+		return array(
+			'same key and empty slugs'              => array(
+				'parameters_1' => array(
+					'parameter_1' => 1,
+					'slug'        => array(),
+				),
+				'parameters_2' => array(
+					'parameter_1' => 1,
+				),
+				'message'      => 'Empty slugs should not affect the transient key.',
+			),
+			'same key and slugs in different order' => array(
+				'parameters_1' => array(
+					'parameter_1' => 1,
+					'slug'        => array( 0, 2 ),
+				),
+				'parameters_2' => array(
+					'parameter_1' => 1,
+					'slug'        => array( 2, 0 ),
+				),
+				'message'      => 'The order of slugs should not affect the transient key.',
+			),
+			'same key and different slugs'          => array(
+				'parameters_1' => array(
+					'parameter_1' => 1,
+					'slug'        => array( 'some_slug' ),
+				),
+				'parameters_2' => array(
+					'parameter_1' => 1,
+					'slug'        => array( 'some_other_slug' ),
+				),
+				'message'      => 'Transient keys must not match.',
+				false,
+			),
+			'different keys'                        => array(
+				'parameters_1' => array(
+					'parameter_1' => 1,
+				),
+				'parameters_2' => array(
+					'parameter_2' => 1,
+				),
+				'message'      => 'Transient keys must depend on array keys.',
+				false,
+			),
+		);
 	}
 
 	/**
diff --git a/tests/rest-api/rest-post-meta-fields.php b/tests/rest-api/rest-post-meta-fields.php
index 85671eff54..ebce49a7f3 100644
--- a/tests/rest-api/rest-post-meta-fields.php
+++ b/tests/rest-api/rest-post-meta-fields.php
@@ -253,7 +253,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 
 	protected function grant_write_permission() {
 		// Ensure we have write permission.
-		$user = $this->factory->user->create(
+		$user = self::factory()->user->create(
 			array(
 				'role' => 'editor',
 			)
diff --git a/tests/rest-api/rest-post-statuses-controller.php b/tests/rest-api/rest-post-statuses-controller.php
index 273c4e3916..901e8bb357 100644
--- a/tests/rest-api/rest-post-statuses-controller.php
+++ b/tests/rest-api/rest-post-statuses-controller.php
@@ -43,7 +43,7 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 	}
 
 	public function test_get_items_logged_in() {
-		$user_id = $this->factory->user->create( array( 'role' => 'author' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'author' ) );
 		wp_set_current_user( $user_id );
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/statuses' );
@@ -72,7 +72,7 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 	}
 
 	public function test_get_item() {
-		$user_id = $this->factory->user->create( array( 'role' => 'author' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'author' ) );
 		wp_set_current_user( $user_id );
 		$request = new WP_REST_Request( 'GET', '/wp/v2/statuses/publish' );
 		$request->set_param( 'context', 'edit' );
@@ -94,7 +94,7 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 	}
 
 	public function test_get_item_invalid_internal() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 		wp_set_current_user( $user_id );
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/statuses/inherit' );
diff --git a/tests/rest-api/rest-post-types-controller.php b/tests/rest-api/rest-post-types-controller.php
index 22ff225a69..0ab2a7b937 100644
--- a/tests/rest-api/rest-post-types-controller.php
+++ b/tests/rest-api/rest-post-types-controller.php
@@ -94,7 +94,7 @@ class WP_Test_REST_Post_Types_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_item_edit_context() {
-		$editor_id = $this->factory->user->create( array( 'role' => 'editor' ) );
+		$editor_id = self::factory()->user->create( array( 'role' => 'editor' ) );
 		wp_set_current_user( $editor_id );
 		$request = new WP_REST_Request( 'GET', '/wp/v2/types/post' );
 		$request->set_param( 'context', 'edit' );
diff --git a/tests/rest-api/rest-posts-controller.php b/tests/rest-api/rest-posts-controller.php
index d820e86d74..5fa7e3cf98 100644
--- a/tests/rest-api/rest-posts-controller.php
+++ b/tests/rest-api/rest-posts-controller.php
@@ -26,6 +26,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	protected $forbidden_cat;
 	protected $posts_clauses;
 
+	private $attachments_created = false;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$post_id = $factory->post->create();
 
@@ -115,13 +117,24 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		add_filter( 'posts_clauses', array( $this, 'save_posts_clauses' ), 10, 2 );
 	}
 
+	public function tear_down() {
+		if ( true === $this->attachments_created ) {
+			$this->remove_added_uploads();
+			$this->attachments_created = false;
+		}
+
+		parent::tear_down();
+	}
+
 	public function wpSetUpBeforeRequest( $result, $server, $request ) {
 		$this->posts_clauses = array();
 		return $result;
 	}
 
 	public function save_posts_clauses( $orderby, $query ) {
-		array_push( $this->posts_clauses, $orderby );
+		if ( 'revision' !== $query->query_vars['post_type'] ) {
+			array_push( $this->posts_clauses, $orderby );
+		}
 		return $orderby;
 	}
 
@@ -260,8 +273,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_author_query() {
-		$this->factory->post->create( array( 'post_author' => self::$editor_id ) );
-		$this->factory->post->create( array( 'post_author' => self::$author_id ) );
+		self::factory()->post->create( array( 'post_author' => self::$editor_id ) );
+		self::factory()->post->create( array( 'post_author' => self::$author_id ) );
 
 		$total_posts = self::$total_posts + 2;
 
@@ -292,8 +305,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_author_exclude_query() {
-		$this->factory->post->create( array( 'post_author' => self::$editor_id ) );
-		$this->factory->post->create( array( 'post_author' => self::$author_id ) );
+		self::factory()->post->create( array( 'post_author' => self::$editor_id ) );
+		self::factory()->post->create( array( 'post_author' => self::$author_id ) );
 
 		$total_posts = self::$total_posts + 2;
 
@@ -334,13 +347,13 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_include_query() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_date'   => '2001-02-03 04:05:06',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_date'   => '2001-02-03 04:05:07',
@@ -373,19 +386,19 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_orderby_author_query() {
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_author' => self::$editor_id,
 			)
 		);
-		$id3 = $this->factory->post->create(
+		$id3 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_author' => self::$editor_id,
 			)
 		);
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_author' => self::$author_id,
@@ -408,9 +421,9 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_orderby_modified_query() {
-		$id1 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$this->update_post_modified( $id1, '2016-04-20 4:26:20' );
 		$this->update_post_modified( $id2, '2016-02-01 20:24:02' );
@@ -432,19 +445,19 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_orderby_parent_query() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
 			)
 		);
-		$id3 = $this->factory->post->create(
+		$id3 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_type'   => 'page',
@@ -470,8 +483,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_exclude_query() {
-		$id1 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id1 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$response = rest_get_server()->dispatch( $request );
@@ -500,7 +513,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_search_query() {
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Search Result',
 				'post_status' => 'publish',
@@ -522,13 +535,13 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_slug_query() {
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Banana',
 				'post_status' => 'publish',
@@ -545,19 +558,19 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_multiple_slugs_array_query() {
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Banana',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Peach',
 				'post_status' => 'publish',
@@ -579,19 +592,19 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_multiple_slugs_string_query() {
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Banana',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Peach',
 				'post_status' => 'publish',
@@ -615,7 +628,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_items_status_query() {
 		wp_set_current_user( 0 );
 
-		$this->factory->post->create( array( 'post_status' => 'draft' ) );
+		self::factory()->post->create( array( 'post_status' => 'draft' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$request->set_param( 'per_page', self::$per_page );
@@ -641,9 +654,9 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_items_multiple_statuses_string_query() {
 		wp_set_current_user( self::$editor_id );
 
-		$this->factory->post->create( array( 'post_status' => 'draft' ) );
-		$this->factory->post->create( array( 'post_status' => 'private' ) );
-		$this->factory->post->create( array( 'post_status' => 'publish' ) );
+		self::factory()->post->create( array( 'post_status' => 'draft' ) );
+		self::factory()->post->create( array( 'post_status' => 'private' ) );
+		self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$request->set_param( 'context', 'edit' );
@@ -664,9 +677,9 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_items_multiple_statuses_array_query() {
 		wp_set_current_user( self::$editor_id );
 
-		$this->factory->post->create( array( 'post_status' => 'draft' ) );
-		$this->factory->post->create( array( 'post_status' => 'pending' ) );
-		$this->factory->post->create( array( 'post_status' => 'publish' ) );
+		self::factory()->post->create( array( 'post_status' => 'draft' ) );
+		self::factory()->post->create( array( 'post_status' => 'pending' ) );
+		self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$request->set_param( 'context', 'edit' );
@@ -696,7 +709,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 * @ticket 43701
 	 */
 	public function test_get_items_multiple_statuses_custom_role_one_invalid_query() {
-		$private_post_id = $this->factory->post->create( array( 'post_status' => 'private' ) );
+		$private_post_id = self::factory()->post->create( array( 'post_status' => 'private' ) );
 
 		wp_set_current_user( self::$private_reader_id );
 
@@ -717,7 +730,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_status_without_permissions() {
-		$draft_id = $this->factory->post->create(
+		$draft_id = self::factory()->post->create(
 			array(
 				'post_status' => 'draft',
 			)
@@ -737,25 +750,25 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_order_and_orderby() {
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple Pie',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple Sauce',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple Cobbler',
 				'post_status' => 'publish',
 			)
 		);
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'  => 'Apple Coffee Cake',
 				'post_status' => 'publish',
@@ -792,7 +805,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_with_orderby_include_without_include_param() {
-		$this->factory->post->create( array( 'post_status' => 'publish' ) );
+		self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$request->set_param( 'orderby', 'include' );
@@ -803,19 +816,19 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_with_orderby_id() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_date'   => '2016-01-13 02:26:48',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_date'   => '2016-01-12 02:26:48',
 			)
 		);
-		$id3 = $this->factory->post->create(
+		$id3 = self::factory()->post->create(
 			array(
 				'post_status' => 'publish',
 				'post_date'   => '2016-01-11 02:26:48',
@@ -837,14 +850,14 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_with_orderby_slug() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_title'  => 'ABC',
 				'post_name'   => 'xyz',
 				'post_status' => 'publish',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_title'  => 'XYZ',
 				'post_name'   => 'abc',
@@ -868,7 +881,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_items_with_orderby_slugs() {
 		$slugs = array( 'burrito', 'taco', 'chalupa' );
 		foreach ( $slugs as $slug ) {
-			$this->factory->post->create(
+			self::factory()->post->create(
 				array(
 					'post_title'  => $slug,
 					'post_name'   => $slug,
@@ -890,14 +903,14 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_with_orderby_relevance() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_title'   => 'Title is more relevant',
 				'post_content' => 'Content is',
 				'post_status'  => 'publish',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_title'   => 'Title is',
 				'post_content' => 'Content is less relevant',
@@ -918,14 +931,14 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_with_orderby_relevance_two_terms() {
-		$id1 = $this->factory->post->create(
+		$id1 = self::factory()->post->create(
 			array(
 				'post_title'   => 'Title is more relevant',
 				'post_content' => 'Content is',
 				'post_status'  => 'publish',
 			)
 		);
-		$id2 = $this->factory->post->create(
+		$id2 = self::factory()->post->create(
 			array(
 				'post_title'   => 'Title is',
 				'post_content' => 'Content is less relevant',
@@ -992,9 +1005,9 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_tags_exclude_query() {
 		$id1 = self::$post_id;
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id4 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id4 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$tag = wp_insert_term( 'My Tag', 'post_tag' );
 
 		$total_posts = self::$total_posts + 3;
@@ -1015,7 +1028,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_tags_and_categories_query() {
 		$id1      = self::$post_id;
-		$id2      = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2      = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$tag      = wp_insert_term( 'My Tag', 'post_tag' );
 		$category = wp_insert_term( 'My Category', 'category' );
 
@@ -1040,7 +1053,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_get_items_tags_or_categories_query() {
 		$id1      = self::$post_id;
-		$id2      = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2      = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$tag      = wp_insert_term( 'My Tag', 'post_tag' );
 		$category = wp_insert_term( 'My Category', 'category' );
 
@@ -1062,7 +1075,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_tags_and_categories_exclude_query() {
 		$id1      = self::$post_id;
-		$id2      = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2      = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$tag      = wp_insert_term( 'My Tag', 'post_tag' );
 		$category = wp_insert_term( 'My Category', 'category' );
 
@@ -1089,9 +1102,9 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_get_items_tags_or_categories_exclude_query() {
 		$id1      = end( self::$post_ids );
-		$id2      = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3      = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id4      = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2      = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3      = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id4      = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 		$tag      = wp_insert_term( 'My Tag', 'post_tag' );
 		$category = wp_insert_term( 'My Category', 'category' );
 
@@ -1353,7 +1366,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_sticky() {
 		$id1 = self::$post_id;
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		update_option( 'sticky_posts', array( $id2 ) );
 
@@ -1374,7 +1387,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_sticky_with_include() {
 		$id1 = self::$post_id;
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		update_option( 'sticky_posts', array( $id2 ) );
 
@@ -1385,8 +1398,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertCount( 0, $response->get_data() );
 
-		// FIXME Since this request returns zero posts, the query is executed twice.
-		$this->assertCount( 2, $this->posts_clauses );
+		$this->assertCount( 1, $this->posts_clauses );
 		$this->posts_clauses = array_slice( $this->posts_clauses, 0, 1 );
 
 		$this->assertPostsWhere( " AND {posts}.ID IN (0) AND {posts}.post_type = 'post' AND (({posts}.post_status = 'publish'))" );
@@ -1417,8 +1429,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertCount( 0, $response->get_data() );
 
-		// FIXME Since this request returns zero posts, the query is executed twice.
-		$this->assertCount( 2, $this->posts_clauses );
+		$this->assertCount( 1, $this->posts_clauses );
 		$this->posts_clauses = array_slice( $this->posts_clauses, 0, 1 );
 
 		$this->assertPostsWhere( " AND {posts}.ID IN (0) AND {posts}.post_type = 'post' AND (({posts}.post_status = 'publish'))" );
@@ -1436,8 +1447,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertCount( 0, $response->get_data() );
 
-		// FIXME Since this request returns zero posts, the query is executed twice.
-		$this->assertCount( 2, $this->posts_clauses );
+		$this->assertCount( 1, $this->posts_clauses );
 		$this->posts_clauses = array_slice( $this->posts_clauses, 0, 1 );
 
 		$this->assertPostsWhere( " AND {posts}.ID IN (0) AND {posts}.post_type = 'post' AND (({posts}.post_status = 'publish'))" );
@@ -1445,7 +1455,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_not_sticky() {
 		$id1 = end( self::$post_ids );
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$total_posts = self::$total_posts + 1;
 
@@ -1467,8 +1477,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_not_sticky_with_exclude() {
 		$id1 = end( self::$post_ids );
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$total_posts = self::$total_posts + 2;
 
@@ -1493,8 +1503,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_not_sticky_with_exclude_no_sticky_posts() {
 		$id1 = self::$post_id;
-		$id2 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
-		$id3 = $this->factory->post->create( array( 'post_status' => 'publish' ) );
+		$id2 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+		$id3 = self::factory()->post->create( array( 'post_status' => 'publish' ) );
 
 		$total_posts = self::$total_posts + 2;
 
@@ -1517,6 +1527,87 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertPostsWhere( " AND {posts}.ID NOT IN ($id3) AND {posts}.post_type = 'post' AND (({posts}.post_status = 'publish'))" );
 	}
 
+	/**
+	 * @ticket 55592
+	 * @covers WP_REST_Posts_Controller::get_items
+	 * @covers ::update_post_thumbnail_cache
+	 */
+	public function test_get_items_primes_thumbnail_cache_for_featured_media() {
+		$file           = DIR_TESTDATA . '/images/canola.jpg';
+		$attachment_ids = array();
+		$post_ids       = array();
+		for ( $i = 0; $i < 3; $i++ ) {
+			$post_ids[ $i ]       = self::factory()->post->create( array( 'post_status' => 'publish' ) );
+			$attachment_ids[ $i ] = self::factory()->attachment->create_object(
+				$file,
+				$post_ids[ $i ],
+				array(
+					'post_mime_type' => 'image/jpeg',
+				)
+			);
+			set_post_thumbnail( $post_ids[ $i ], $attachment_ids[ $i ] );
+		}
+
+		// Attachment creation warms thumbnail IDs. Needs clean up for test.
+		wp_cache_delete_multiple( $attachment_ids, 'posts' );
+
+		$filter = new MockAction();
+		add_filter( 'update_post_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
+		$request->set_param( 'include', $post_ids );
+		rest_get_server()->dispatch( $request );
+
+		$args = $filter->get_args();
+		$last = end( $args );
+		$this->assertIsArray( $last, 'The last value is not an array' );
+		$this->assertSameSets( $attachment_ids, $last[1] );
+	}
+
+	/**
+	 * @ticket 55593
+	 * @covers WP_REST_Posts_Controller::get_items
+	 * @covers ::update_post_parent_caches
+	 */
+	public function test_get_items_primes_parent_post_caches() {
+		$parent_id1       = self::$post_ids[0];
+		$parent_id2       = self::$post_ids[1];
+		$parent_ids       = array( $parent_id1, $parent_id2 );
+		$attachment_ids   = array();
+		$attachment_ids[] = self::factory()->attachment->create_object(
+			DIR_TESTDATA . '/images/canola.jpg',
+			$parent_id1,
+			array(
+				'post_mime_type' => 'image/jpeg',
+				'post_excerpt'   => 'A sample caption 1',
+			)
+		);
+
+		$attachment_ids[] = self::factory()->attachment->create_object(
+			DIR_TESTDATA . '/images/canola.jpg',
+			$parent_id2,
+			array(
+				'post_mime_type' => 'image/jpeg',
+				'post_excerpt'   => 'A sample caption 2',
+			)
+		);
+
+		// Attachment creation warms parent IDs. Needs clean up for test.
+		wp_cache_delete_multiple( $parent_ids, 'posts' );
+		wp_cache_delete_multiple( $attachment_ids, 'posts' );
+
+		$filter = new MockAction();
+		add_filter( 'update_post_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/media' );
+		rest_get_server()->dispatch( $request );
+
+		$args = $filter->get_args();
+		$last = end( $args );
+		$this->assertIsArray( $last, 'The last value is not an array' );
+		$this->assertSameSets( $parent_ids, $last[1] );
+	}
+
 	public function test_get_items_pagination_headers() {
 		$total_posts = self::$total_posts;
 		$total_pages = (int) ceil( $total_posts / 10 );
@@ -1537,7 +1628,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertStringContainsString( '<' . $next_link . '>; rel="next"', $headers['Link'] );
 
 		// 3rd page.
-		$this->factory->post->create();
+		self::factory()->post->create();
 		$total_posts++;
 		$total_pages++;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
@@ -1616,7 +1707,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_items_status_draft_permissions() {
-		$draft_id = $this->factory->post->create( array( 'post_status' => 'draft' ) );
+		$draft_id = self::factory()->post->create( array( 'post_status' => 'draft' ) );
 
 		// Drafts status query var inaccessible to unauthorized users.
 		wp_set_current_user( 0 );
@@ -1646,7 +1737,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 * @ticket 43701
 	 */
 	public function test_get_items_status_private_permissions() {
-		$private_post_id = $this->factory->post->create( array( 'post_status' => 'private' ) );
+		$private_post_id = self::factory()->post->create( array( 'post_status' => 'private' ) );
 
 		wp_set_current_user( 0 );
 
@@ -1694,16 +1785,16 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_items_invalid_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
-		$request->set_param( 'after', rand_str() );
-		$request->set_param( 'before', rand_str() );
+		$request->set_param( 'after', 'foo' );
+		$request->set_param( 'before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
 
 	public function test_get_items_valid_date() {
-		$post1 = $this->factory->post->create( array( 'post_date' => '2016-01-15T00:00:00Z' ) );
-		$post2 = $this->factory->post->create( array( 'post_date' => '2016-01-16T00:00:00Z' ) );
-		$post3 = $this->factory->post->create( array( 'post_date' => '2016-01-17T00:00:00Z' ) );
+		$post1 = self::factory()->post->create( array( 'post_date' => '2016-01-15T00:00:00Z' ) );
+		$post2 = self::factory()->post->create( array( 'post_date' => '2016-01-16T00:00:00Z' ) );
+		$post3 = self::factory()->post->create( array( 'post_date' => '2016-01-17T00:00:00Z' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$request->set_param( 'after', '2016-01-15T00:00:00Z' );
@@ -1719,8 +1810,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_get_items_invalid_modified_date() {
 		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
-		$request->set_param( 'modified_after', rand_str() );
-		$request->set_param( 'modified_before', rand_str() );
+		$request->set_param( 'modified_after', 'foo' );
+		$request->set_param( 'modified_before', 'bar' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 	}
@@ -1729,9 +1820,9 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 * @ticket 50617
 	 */
 	public function test_get_items_valid_modified_date() {
-		$post1 = $this->factory->post->create( array( 'post_date' => '2016-01-01 00:00:00' ) );
-		$post2 = $this->factory->post->create( array( 'post_date' => '2016-01-02 00:00:00' ) );
-		$post3 = $this->factory->post->create( array( 'post_date' => '2016-01-03 00:00:00' ) );
+		$post1 = self::factory()->post->create( array( 'post_date' => '2016-01-01 00:00:00' ) );
+		$post2 = self::factory()->post->create( array( 'post_date' => '2016-01-02 00:00:00' ) );
+		$post3 = self::factory()->post->create( array( 'post_date' => '2016-01-03 00:00:00' ) );
 		$this->update_post_modified( $post1, '2016-01-15 00:00:00' );
 		$this->update_post_modified( $post2, '2016-01-16 00:00:00' );
 		$this->update_post_modified( $post3, '2016-01-17 00:00:00' );
@@ -1849,7 +1940,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_post_draft_status_not_authenticated() {
-		$draft_id = $this->factory->post->create(
+		$draft_id = self::factory()->post->create(
 			array(
 				'post_status' => 'draft',
 			)
@@ -1865,7 +1956,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_get_post_draft_edit_context() {
 		$post_content = 'Hello World!';
-		$this->factory->post->create(
+		self::factory()->post->create(
 			array(
 				'post_title'    => 'Hola',
 				'post_password' => 'password',
@@ -1874,7 +1965,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 				'post_author'   => self::$editor_id,
 			)
 		);
-		$draft_id = $this->factory->post->create(
+		$draft_id = self::factory()->post->create(
 			array(
 				'post_status'  => 'draft',
 				'post_author'  => self::$contributor_id,
@@ -1940,7 +2031,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_post_with_password() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_password' => '$inthebananastand',
 			)
@@ -1959,7 +2050,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_post_with_password_using_password() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_password' => '$inthebananastand',
 				'post_content'  => 'Some secret content.',
@@ -1983,7 +2074,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_post_with_password_using_incorrect_password() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_password' => '$inthebananastand',
 			)
@@ -1999,7 +2090,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_get_post_with_password_without_permission() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_password' => '$inthebananastand',
 				'post_content'  => 'Some secret content.',
@@ -2023,7 +2114,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 * @ticket 43887
 	 */
 	public function test_get_post_should_not_have_block_version_when_context_view() {
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => '<!-- wp:core/separator -->',
 			)
@@ -2043,7 +2134,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_post_should_have_block_version_indicate_block_content_when_context_edit() {
 		wp_set_current_user( self::$editor_id );
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => '<!-- wp:core/separator -->',
 			)
@@ -2064,7 +2155,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_get_post_should_have_block_version_indicate_no_block_content_when_context_edit() {
 		wp_set_current_user( self::$editor_id );
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_content' => '<hr />',
 			)
@@ -2691,30 +2782,32 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	public function test_create_update_post_with_featured_media() {
 
-		$file                = DIR_TESTDATA . '/images/canola.jpg';
-		$this->attachment_id = $this->factory->attachment->create_object(
+		$file          = DIR_TESTDATA . '/images/canola.jpg';
+		$attachment_id = self::factory()->attachment->create_object(
 			$file,
 			0,
 			array(
 				'post_mime_type' => 'image/jpeg',
-				'menu_order'     => rand( 1, 100 ),
+				'menu_order'     => 1,
 			)
 		);
 
+		$this->attachments_created = true;
+
 		wp_set_current_user( self::$editor_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts' );
 		$params  = $this->set_post_data(
 			array(
-				'featured_media' => $this->attachment_id,
+				'featured_media' => $attachment_id,
 			)
 		);
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
 		$new_post = get_post( $data['id'] );
-		$this->assertSame( $this->attachment_id, $data['featured_media'] );
-		$this->assertSame( $this->attachment_id, (int) get_post_thumbnail_id( $new_post->ID ) );
+		$this->assertSame( $attachment_id, $data['featured_media'] );
+		$this->assertSame( $attachment_id, (int) get_post_thumbnail_id( $new_post->ID ) );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . $new_post->ID );
 		$params  = $this->set_post_data(
@@ -3094,7 +3187,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	 */
 	public function test_rest_update_post_with_empty_date() {
 		// Create a new test post.
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_current_user( self::$editor_id );
 
@@ -3310,7 +3403,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	public function test_update_post_ignore_readonly() {
 		wp_set_current_user( self::$editor_id );
 
-		$new_content       = rand_str();
+		$new_content       = 'foo bar baz';
 		$expected_modified = current_time( 'mysql' );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
@@ -3343,7 +3436,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		update_option( 'timezone_string', $params['timezone_string'] );
 
-		$post_id = $this->factory->post->create( array( 'post_status' => $status ) );
+		$post_id = self::factory()->post->create( array( 'post_status' => $status ) );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
 		if ( isset( $params['date'] ) ) {
@@ -3375,7 +3468,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
 		$params  = $this->set_post_data(
 			array(
-				'date' => rand_str(),
+				'date' => 'foo',
 			)
 		);
 		$request->set_body_params( $params );
@@ -3390,7 +3483,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
 		$params  = $this->set_post_data(
 			array(
-				'date_gmt' => rand_str(),
+				'date_gmt' => 'foo',
 			)
 		);
 		$request->set_body_params( $params );
@@ -3408,7 +3501,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		// Need to set dates using wpdb directly because `wp_update_post` and
 		// `wp_insert_post` have additional validation on dates.
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 		$wpdb->update(
 			$wpdb->posts,
 			array(
@@ -4078,7 +4171,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_delete_item() {
-		$post_id = $this->factory->post->create( array( 'post_title' => 'Deleted post' ) );
+		$post_id = self::factory()->post->create( array( 'post_title' => 'Deleted post' ) );
 
 		wp_set_current_user( self::$editor_id );
 
@@ -4093,7 +4186,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_delete_item_skip_trash() {
-		$post_id = $this->factory->post->create( array( 'post_title' => 'Deleted post' ) );
+		$post_id = self::factory()->post->create( array( 'post_title' => 'Deleted post' ) );
 
 		wp_set_current_user( self::$editor_id );
 
@@ -4108,7 +4201,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_delete_item_already_trashed() {
-		$post_id = $this->factory->post->create( array( 'post_title' => 'Deleted post' ) );
+		$post_id = self::factory()->post->create( array( 'post_title' => 'Deleted post' ) );
 
 		wp_set_current_user( self::$editor_id );
 
@@ -4129,7 +4222,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function test_delete_post_invalid_post_type() {
-		$page_id = $this->factory->post->create( array( 'post_type' => 'page' ) );
+		$page_id = self::factory()->post->create( array( 'post_type' => 'page' ) );
 
 		wp_set_current_user( self::$editor_id );
 
@@ -4372,7 +4465,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		wp_set_current_user( 1 );
 
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/posts/' . $post_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -4417,7 +4510,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 				'update_callback' => null,
 			)
 		);
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		// 'my_custom_int' should appear because ?_fields= isn't set.
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/posts/' . $post_id );
@@ -4838,7 +4931,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		wp_set_current_user( self::$editor_id );
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_title'  => 'Permalink Template',
 				'post_type'   => 'private-post',
@@ -4862,7 +4955,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		wp_set_current_user( self::$editor_id );
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_title'  => 'Permalink Template',
 				'post_type'   => 'post',
@@ -5156,12 +5249,45 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$GLOBALS['wp_rest_server']->override_by_default = false;
 	}
 
-	public function tear_down() {
-		if ( isset( $this->attachment_id ) ) {
-			$this->remove_added_uploads();
-		}
+	/**
+	 * @ticket 52422
+	 *
+	 * @covers WP_REST_Posts_Controller::create_item
+	 */
+	public function test_draft_post_does_not_have_the_same_slug_as_existing_post() {
+		wp_set_current_user( self::$editor_id );
+		self::factory()->post->create( array( 'post_name' => 'sample-slug' ) );
 
-		parent::tear_down();
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$params  = $this->set_post_data(
+			array(
+				'status' => 'draft',
+				'slug'   => 'sample-slug',
+			)
+		);
+		$request->set_body_params( $params );
+		$response = rest_get_server()->dispatch( $request );
+
+		$new_data = $response->get_data();
+		$this->assertSame(
+			'sample-slug-2',
+			$new_data['slug'],
+			'The slug from the REST response did not match'
+		);
+
+		$post = get_post( $new_data['id'] );
+
+		$this->assertSame(
+			'draft',
+			$post->post_status,
+			'The post status is not draft'
+		);
+
+		$this->assertSame(
+			'sample-slug-2',
+			$post->post_name,
+			'The post slug was not set to "sample-slug-2"'
+		);
 	}
 
 	/**
diff --git a/tests/rest-api/rest-revisions-controller.php b/tests/rest-api/rest-revisions-controller.php
index 37a529f763..c84624ca80 100644
--- a/tests/rest-api/rest-revisions-controller.php
+++ b/tests/rest-api/rest-revisions-controller.php
@@ -16,6 +16,15 @@ class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase
 	protected static $editor_id;
 	protected static $contributor_id;
 
+	private $total_revisions;
+	private $revisions;
+	private $revision_1;
+	private $revision_id1;
+	private $revision_2;
+	private $revision_id2;
+	private $revision_3;
+	private $revision_id3;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$post_id = $factory->post->create();
 		self::$page_id = $factory->post->create( array( 'post_type' => 'page' ) );
diff --git a/tests/rest-api/rest-schema-setup.php b/tests/rest-api/rest-schema-setup.php
index 1ed1d89611..a1e4330c0c 100644
--- a/tests/rest-api/rest-schema-setup.php
+++ b/tests/rest-api/rest-schema-setup.php
@@ -69,6 +69,9 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 		}
 	}
 
+	/**
+	 * @ticket 54596
+	 */
 	public function test_expected_routes_in_schema() {
 		$routes = rest_get_server()->get_routes();
 
@@ -133,7 +136,8 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp/v2/comments',
 			'/wp/v2/comments/(?P<id>[\\d]+)',
 			'/wp/v2/global-styles/(?P<id>[\/\w-]+)',
-			'/wp/v2/global-styles/themes/(?P<stylesheet>[^.\/]+(?:\/[^.\/]+)?)',
+			'/wp/v2/global-styles/themes/(?P<stylesheet>[\/\s%\w\.\(\)\[\]\@_\-]+)/variations',
+			'/wp/v2/global-styles/themes/(?P<stylesheet>[^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)',
 			'/wp/v2/search',
 			'/wp/v2/block-renderer/(?P<name>[a-z0-9-]+/[a-z0-9-]+)',
 			'/wp/v2/block-types',
@@ -141,22 +145,24 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp/v2/block-types/(?P<namespace>[a-zA-Z0-9_-]+)/(?P<name>[a-zA-Z0-9_-]+)',
 			'/wp/v2/settings',
 			'/wp/v2/template-parts',
-			'/wp/v2/template-parts/(?P<id>[\/\w-]+)',
 			'/wp/v2/template-parts/(?P<id>[\d]+)/autosaves',
+			'/wp/v2/template-parts/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w-]+)',
 			'/wp/v2/template-parts/(?P<parent>[\d]+)/autosaves/(?P<id>[\d]+)',
 			'/wp/v2/template-parts/(?P<parent>[\d]+)/revisions',
 			'/wp/v2/template-parts/(?P<parent>[\d]+)/revisions/(?P<id>[\d]+)',
 			'/wp/v2/templates',
-			'/wp/v2/templates/(?P<id>[\/\w-]+)',
 			'/wp/v2/templates/(?P<id>[\d]+)/autosaves',
+			'/wp/v2/templates/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w-]+)',
 			'/wp/v2/templates/(?P<parent>[\d]+)/autosaves/(?P<id>[\d]+)',
 			'/wp/v2/templates/(?P<parent>[\d]+)/revisions',
 			'/wp/v2/templates/(?P<parent>[\d]+)/revisions/(?P<id>[\d]+)',
 			'/wp/v2/themes',
-			'/wp/v2/themes/(?P<stylesheet>[^.\/]+(?:\/[^.\/]+)?)',
+			'/wp/v2/themes/(?P<stylesheet>[^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)',
 			'/wp/v2/plugins',
 			'/wp/v2/plugins/(?P<plugin>[^.\/]+(?:\/[^.\/]+)?)',
 			'/wp/v2/block-directory/search',
+			'/wp/v2/block-patterns/categories',
+			'/wp/v2/block-patterns/patterns',
 			'/wp/v2/sidebars',
 			'/wp/v2/sidebars/(?P<id>[\w-]+)',
 			'/wp/v2/widget-types',
@@ -177,6 +183,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp-site-health/v1/tests/https-status',
 			'/wp-site-health/v1/tests/dotorg-communication',
 			'/wp-site-health/v1/tests/authorization-header',
+			'/wp-site-health/v1/tests/page-cache',
 			'/wp-site-health/v1/directory-sizes',
 		);
 
@@ -198,7 +205,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 		// fixture file will be different between runs of PHPUnit tests, which
 		// is not desirable.
 
-		$administrator_id = $this->factory->user->create(
+		$administrator_id = self::factory()->user->create(
 			array(
 				'role'          => 'administrator',
 				'display_name'  => 'REST API Client Fixture: User',
@@ -208,7 +215,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 		);
 		wp_set_current_user( $administrator_id );
 
-		$post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
 				'post_name'    => 'restapi-client-fixture-post',
 				'post_title'   => 'REST API Client Fixture: Post',
@@ -236,7 +243,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			)
 		);
 
-		$page_id = $this->factory->post->create(
+		$page_id = self::factory()->post->create(
 			array(
 				'post_type'     => 'page',
 				'post_name'     => 'restapi-client-fixture-page',
@@ -266,7 +273,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			)
 		);
 
-		$tag_id = $this->factory->tag->create(
+		$tag_id = self::factory()->tag->create(
 			array(
 				'name'        => 'REST API Client Fixture: Tag',
 				'slug'        => 'restapi-client-fixture-tag',
@@ -274,7 +281,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			)
 		);
 
-		$media_id = $this->factory->attachment->create_object(
+		$media_id = self::factory()->attachment->create_object(
 			get_temp_dir() . 'canola.jpg',
 			0,
 			array(
@@ -288,7 +295,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			)
 		);
 
-		$comment_id = $this->factory->comment->create(
+		$comment_id = self::factory()->comment->create(
 			array(
 				'comment_approved'     => 1,
 				'comment_post_ID'      => $post_id,
@@ -514,7 +521,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 		wp_delete_post( $post_id, true );
 		wp_delete_post( $page_id, true );
 		wp_delete_term( $tag_id, 'tags' );
-		wp_delete_attachment( $media_id );
+		wp_delete_attachment( $media_id, true );
 		wp_delete_comment( $comment_id );
 	}
 
diff --git a/tests/rest-api/rest-search-controller.php b/tests/rest-api/rest-search-controller.php
index f6706b18ff..2b2e87adeb 100644
--- a/tests/rest-api/rest-search-controller.php
+++ b/tests/rest-api/rest-search-controller.php
@@ -332,6 +332,36 @@ class WP_Test_REST_Search_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 	}
 
+	/**
+	 * @ticket 55674
+	 */
+	public function test_get_items_search_prime_ids() {
+		$action = new MockAction();
+		add_filter( 'query', array( $action, 'filter' ), 10, 2 );
+
+		$query_args = array(
+			'per_page' => 100,
+			'search'   => 'foocontent',
+		);
+		$response   = $this->do_request_with_params( $query_args );
+		$this->assertSame( 200, $response->get_status(), 'Request Status Response is not 200.' );
+
+		$ids = wp_list_pluck( $response->get_data(), 'id' );
+		$this->assertSameSets( self::$my_content_post_ids, $ids, 'Query result posts ids do not match with expected ones.' );
+
+		$args               = $action->get_args();
+		$primed_query_found = false;
+		foreach ( $args as $arg ) {
+			// Primed query will use WHERE ID IN clause.
+			if ( str_contains( $arg[0], 'WHERE ID IN (' . implode( ',', $ids ) ) ) {
+				$primed_query_found = true;
+				break;
+			}
+		}
+
+		$this->assertTrue( $primed_query_found, 'Prime query was not executed.' );
+	}
+
 	/**
 	 * Test retrieving a single item isn't possible.
 	 */
@@ -413,7 +443,6 @@ class WP_Test_REST_Search_Controller extends WP_Test_REST_Controller_Testcase {
 			array(
 				'id',
 				'title',
-				'_links',
 			),
 			array_keys( $data[0] )
 		);
@@ -790,4 +819,78 @@ class WP_Test_REST_Search_Controller extends WP_Test_REST_Controller_Testcase {
 		return $request;
 	}
 
+	/**
+	 * @ticket 56546
+	 */
+	public function test_get_items_search_posts_include_ids() {
+		$response = $this->do_request_with_params(
+			array(
+				'include' => array_slice( self::$my_title_post_ids, 1, 2 ),
+			)
+		);
+
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSameSets(
+			array( self::$my_title_post_ids[1], self::$my_title_post_ids[2] ),
+			wp_list_pluck( $response->get_data(), 'id' )
+		);
+	}
+
+	/**
+	 * @ticket 56546
+	 */
+	public function test_get_items_search_posts_exclude_ids() {
+		$response = $this->do_request_with_params(
+			array(
+				'exclude' => self::$my_title_page_ids,
+			)
+		);
+
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSameSets(
+			array_merge(
+				self::$my_title_post_ids,
+				self::$my_content_post_ids
+			),
+			wp_list_pluck( $response->get_data(), 'id' )
+		);
+	}
+
+	/**
+	 * @ticket 56546
+	 */
+	public function test_get_items_search_terms_include_ids() {
+		$response = $this->do_request_with_params(
+			array(
+				'include' => self::$my_tag_id,
+				'type'    => 'term',
+			)
+		);
+
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSameSets(
+			array( self::$my_tag_id ),
+			wp_list_pluck( $response->get_data(), 'id' )
+		);
+	}
+
+	/**
+	 * @ticket 56546
+	 */
+	public function test_get_items_search_terms_exclude_ids() {
+		$response = $this->do_request_with_params(
+			array(
+				// "1" is the default category.
+				'exclude' => array( 1, self::$my_tag_id ),
+				'type'    => 'term',
+			)
+		);
+
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSameSets(
+			array( self::$my_category_id ),
+			wp_list_pluck( $response->get_data(), 'id' )
+		);
+	}
+
 }
diff --git a/tests/rest-api/rest-server.php b/tests/rest-api/rest-server.php
index 33e1f70506..aa927c8b1c 100644
--- a/tests/rest-api/rest-server.php
+++ b/tests/rest-api/rest-server.php
@@ -77,6 +77,62 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertSame( $headers, $enveloped['headers'] );
 	}
 
+	/**
+	 * @dataProvider data_envelope_params
+	 * @ticket 54015
+	 */
+	public function test_envelope_param( $_embed ) {
+		// Register our testing route.
+		rest_get_server()->register_route(
+			'test',
+			'/test/embeddable',
+			array(
+				'methods'  => 'GET',
+				'callback' => array( $this, 'embedded_response_callback' ),
+			)
+		);
+		$data    = array(
+			'amount of arbitrary data' => 'alot',
+		);
+		$status  = 987;
+		$headers = array(
+			'Arbitrary-Header' => 'value',
+			'Multiple'         => 'maybe, yes',
+		);
+
+		$response = new WP_REST_Response( $data, $status );
+		$response->header( 'Arbitrary-Header', 'value' );
+
+		// Check header concatenation as well.
+		$response->header( 'Multiple', 'maybe' );
+		$response->header( 'Multiple', 'yes', false );
+
+		// All others should be embedded.
+		$response->add_link( 'alternate', rest_url( '/test/embeddable' ), array( 'embeddable' => true ) );
+
+		$embed             = rest_parse_embed_param( $_embed );
+		$envelope_response = rest_get_server()->envelope_response( $response, $embed );
+
+		// The envelope should still be a response, but with defaults.
+		$this->assertInstanceOf( WP_REST_Response::class, $envelope_response );
+		$this->assertSame( 200, $envelope_response->get_status() );
+		$this->assertEmpty( $envelope_response->get_headers() );
+		$this->assertEmpty( $envelope_response->get_links() );
+
+		$enveloped = $envelope_response->get_data();
+
+		$this->assertArrayHasKey( 'body', $enveloped );
+		$this->assertArrayHasKey( '_links', $enveloped['body'] );
+		$this->assertArrayHasKey( '_embedded', $enveloped['body'] );
+		$this->assertArrayHasKey( 'alternate', $enveloped['body']['_embedded'] );
+
+		$alternate = $enveloped['body']['_embedded']['alternate'];
+		$this->assertCount( 1, $alternate );
+
+		$this->assertSame( $status, $enveloped['status'] );
+		$this->assertSame( $headers, $enveloped['headers'] );
+	}
+
 	public function test_default_param() {
 
 		register_rest_route(
@@ -1025,14 +1081,29 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertArrayHasKey( 'help', $index->get_links() );
 		$this->assertArrayNotHasKey( 'wp:active-theme', $index->get_links() );
 
-		// Check site icon.
+		// Check site logo and icon.
+		$this->assertArrayHasKey( 'site_logo', $data );
 		$this->assertArrayHasKey( 'site_icon', $data );
+		$this->assertArrayHasKey( 'site_icon_url', $data );
+	}
+
+	/**
+	 * @ticket 50152
+	 */
+	public function test_index_includes_link_to_active_theme_if_authenticated() {
+		$server = new WP_REST_Server();
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
+
+		$request = new WP_REST_Request( 'GET', '/' );
+		$index   = $server->dispatch( $request );
+
+		$this->assertArrayHasKey( 'https://api.w.org/active-theme', $index->get_links() );
 	}
 
 	/**
 	 * @ticket 52321
 	 */
-	public function test_get_index_with_site_icon() {
+	public function test_index_includes_site_icon() {
 		$server = new WP_REST_Server();
 		update_option( 'site_icon', self::$icon_id );
 
@@ -1041,7 +1112,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$data    = $index->get_data();
 
 		$this->assertArrayHasKey( 'site_icon', $data );
-		$this->assertEquals( self::$icon_id, $data['site_icon'] );
+		$this->assertSame( self::$icon_id, $data['site_icon'] );
 	}
 
 	public function test_get_namespace_index() {
@@ -1169,7 +1240,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$result  = rest_get_server()->serve_request( '/' );
 		$headers = rest_get_server()->sent_headers;
 
-		$this->assertSame( '<' . esc_url_raw( $api_root ) . '>; rel="https://api.w.org/"', $headers['Link'] );
+		$this->assertSame( '<' . sanitize_url( $api_root ) . '>; rel="https://api.w.org/"', $headers['Link'] );
 	}
 
 	public function test_nocache_headers_on_authenticated_requests() {
@@ -2079,16 +2150,6 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertSameSetsWithIndex( $expected, $args['param'] );
 	}
 
-	/**
-	 * @ticket 50152
-	 */
-	public function test_index_includes_link_to_active_theme_if_authenticated() {
-		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
-
-		$index = rest_do_request( '/' );
-		$this->assertArrayHasKey( 'https://api.w.org/active-theme', $index->get_links() );
-	}
-
 	/**
 	 * @ticket 53056
 	 */
@@ -2169,4 +2230,19 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 
 		return rest_get_server()->sent_headers;
 	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_envelope_params() {
+		return array(
+			array( '1' ),
+			array( 'true' ),
+			array( false ),
+			array( 'alternate' ),
+			array( array( 'alternate' ) ),
+		);
+	}
 }
diff --git a/tests/rest-api/rest-settings-controller.php b/tests/rest-api/rest-settings-controller.php
index bb9a4bbdb6..60a5f28c8d 100644
--- a/tests/rest-api/rest-settings-controller.php
+++ b/tests/rest-api/rest-settings-controller.php
@@ -14,6 +14,11 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 	protected static $administrator;
 	protected static $author;
 
+	/**
+	 * @var WP_REST_Settings_Controller
+	 */
+	private $endpoint;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$administrator = $factory->user->create(
 			array(
@@ -70,7 +75,11 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertSame( 404, $response->get_status() );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_context_param() {
+		// Controller does not use get_context_param().
 	}
 
 	public function test_get_item_is_not_public_not_authenticated() {
@@ -106,8 +115,12 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 			'default_category',
 			'default_post_format',
 			'posts_per_page',
+			'show_on_front',
+			'page_on_front',
+			'page_for_posts',
 			'default_ping_status',
 			'default_comment_status',
+			'site_icon', // Registered in wp-includes/blocks/site-logo.php
 		);
 
 		if ( ! is_multisite() ) {
@@ -373,8 +386,11 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertNull( $data['mycustomsettinginrest'] );
 	}
 
-
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_create_item() {
+		// Controller does not implement create_item().
 	}
 
 	public function test_update_item() {
@@ -654,10 +670,18 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertSame( 404, $response->get_status() );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_get_item_schema() {
+		// Controller does not implement get_item_schema().
 	}
 
 	/**
@@ -713,4 +737,50 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 			)
 		);
 	}
+
+	/**
+	 * @ticket 56493
+	 */
+	public function test_register_setting_with_custom_additional_properties_value() {
+		wp_set_current_user( self::$administrator );
+
+		register_setting(
+			'somegroup',
+			'mycustomsetting',
+			array(
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'                 => 'object',
+						'properties'           => array(
+							'test1' => array(
+								'type' => 'string',
+							),
+						),
+						'additionalProperties' => array(
+							'type' => 'integer',
+						),
+					),
+				),
+			)
+		);
+
+		$data    = array(
+			'mycustomsetting' => array(
+				'test1' => 'my-string',
+				'test2' => '2',
+				'test3' => 3,
+			),
+		);
+		$request = new WP_REST_Request( 'PUT', '/wp/v2/settings' );
+		$request->add_header( 'content-type', 'application/json' );
+		$request->set_body( wp_json_encode( $data ) );
+
+		$response = rest_do_request( $request );
+
+		$this->assertSame( 200, $response->get_status() );
+		$this->assertSame( 'my-string', $response->data['mycustomsetting']['test1'] );
+		$this->assertSame( 2, $response->data['mycustomsetting']['test2'] );
+		$this->assertSame( 3, $response->data['mycustomsetting']['test3'] );
+	}
 }
diff --git a/tests/rest-api/rest-sidebars-controller.php b/tests/rest-api/rest-sidebars-controller.php
index 91bdeeb342..e15a7f910a 100644
--- a/tests/rest-api/rest-sidebars-controller.php
+++ b/tests/rest-api/rest-sidebars-controller.php
@@ -573,9 +573,12 @@ class WP_Test_REST_Sidebars_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	/**
-	 * The test_create_item() method does not exist for sidebar.
+	 * The create_item() method does not exist for sidebar.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_create_item() {
+		// Controller does not implement create_item().
 	}
 
 	/**
@@ -890,15 +893,21 @@ class WP_Test_REST_Sidebars_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	/**
-	 * The test_delete_item() method does not exist for sidebar.
+	 * The delete_item() method does not exist for sidebar.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_delete_item() {
+		// Controller does not implement delete_item().
 	}
 
 	/**
-	 * The test_prepare_item() method does not exist for sidebar.
+	 * The prepare_item() method does not exist for sidebar.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
 	}
 
 	/**
diff --git a/tests/rest-api/rest-site-health-controller.php b/tests/rest-api/rest-site-health-controller.php
index 46f47de091..ddc932709d 100644
--- a/tests/rest-api/rest-site-health-controller.php
+++ b/tests/rest-api/rest-site-health-controller.php
@@ -99,4 +99,49 @@ class WP_Test_REST_Site_Health_Controller extends WP_Test_REST_TestCase {
 		$response = rest_do_request( '/wp-site-health/v1/tests/dotorg-communication' );
 		$this->assertSame( 'dotorg_communication', $response->get_data()['test'] );
 	}
+
+	/**
+	 * Tests Page Cache Rest endpoint registration.
+	 *
+	 * @ticket 56041
+	 */
+	public function test_page_cache_endpoint() {
+		$server = rest_get_server();
+		$routes = $server->get_routes();
+
+		$endpoint = '/wp-site-health/v1/tests/page-cache';
+		$this->assertArrayHasKey( $endpoint, $routes );
+
+		$route = $routes[ $endpoint ];
+		$this->assertCount( 1, $route );
+
+		$route = current( $route );
+		$this->assertEquals(
+			array( WP_REST_Server::READABLE => true ),
+			$route['methods']
+		);
+
+		$this->assertEquals(
+			'test_page_cache',
+			$route['callback'][1]
+		);
+
+		$this->assertIsCallable( $route['permission_callback'] );
+
+		if ( current_user_can( 'view_site_health_checks' ) ) {
+			$this->assertTrue( call_user_func( $route['permission_callback'] ) );
+		} else {
+			$this->assertFalse( call_user_func( $route['permission_callback'] ) );
+		}
+
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'author' ) ) );
+		$this->assertFalse( call_user_func( $route['permission_callback'] ) );
+
+		$user = wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
+		if ( is_multisite() ) {
+			// Site health cap is only available for super admins in Multi sites.
+			grant_super_admin( $user->ID );
+		}
+		$this->assertTrue( call_user_func( $route['permission_callback'] ) );
+	}
 }
diff --git a/tests/rest-api/rest-tags-controller.php b/tests/rest-api/rest-tags-controller.php
index b9ac20cf71..a4b566f7b2 100644
--- a/tests/rest-api/rest-tags-controller.php
+++ b/tests/rest-api/rest-tags-controller.php
@@ -54,7 +54,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 		// Set up tags for pagination tests.
 		for ( $i = 0; $i < self::$total_tags; $i++ ) {
-			$tag_ids[] = $factory->tag->create(
+			self::$tag_ids[] = $factory->tag->create(
 				array(
 					'name' => "Tag {$i}",
 				)
@@ -139,7 +139,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertSame( 'view', $data['endpoints'][0]['args']['context']['default'] );
 		$this->assertSameSets( array( 'view', 'embed', 'edit' ), $data['endpoints'][0]['args']['context']['enum'] );
 		// Single.
-		$tag1     = $this->factory->tag->create( array( 'name' => 'Season 5' ) );
+		$tag1     = self::factory()->tag->create( array( 'name' => 'Season 5' ) );
 		$request  = new WP_REST_Request( 'OPTIONS', '/wp/v2/tags/' . $tag1 );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
@@ -174,7 +174,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items() {
-		$this->factory->tag->create();
+		self::factory()->tag->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'per_page', self::$per_page );
@@ -192,9 +192,9 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_hide_empty_arg() {
-		$post_id = $this->factory->post->create();
-		$tag1    = $this->factory->tag->create( array( 'name' => 'Season 5' ) );
-		$tag2    = $this->factory->tag->create( array( 'name' => 'The Be Sharps' ) );
+		$post_id = self::factory()->post->create();
+		$tag1    = self::factory()->tag->create( array( 'name' => 'Season 5' ) );
+		$tag2    = self::factory()->tag->create( array( 'name' => 'The Be Sharps' ) );
 
 		wp_set_object_terms( $post_id, array( $tag1, $tag2 ), 'post_tag' );
 
@@ -213,8 +213,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_include_query() {
-		$id1 = $this->factory->tag->create();
-		$id2 = $this->factory->tag->create();
+		$id1 = self::factory()->tag->create();
+		$id2 = self::factory()->tag->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 
@@ -239,8 +239,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_exclude_query() {
-		$id1 = $this->factory->tag->create();
-		$id2 = $this->factory->tag->create();
+		$id1 = self::factory()->tag->create();
+		$id2 = self::factory()->tag->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'per_page', self::$per_page );
@@ -288,8 +288,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 
 	public function test_get_items_orderby_args() {
-		$tag1 = $this->factory->tag->create( array( 'name' => 'Apple' ) );
-		$tag2 = $this->factory->tag->create( array( 'name' => 'Zucchini' ) );
+		$tag1 = self::factory()->tag->create( array( 'name' => 'Apple' ) );
+		$tag2 = self::factory()->tag->create( array( 'name' => 'Zucchini' ) );
 
 		/*
 		 * Tests:
@@ -324,9 +324,9 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_orderby_id() {
-		$tag0 = $this->factory->tag->create( array( 'name' => 'Cantaloupe' ) );
-		$tag1 = $this->factory->tag->create( array( 'name' => 'Apple' ) );
-		$tag2 = $this->factory->tag->create( array( 'name' => 'Banana' ) );
+		$tag0 = self::factory()->tag->create( array( 'name' => 'Cantaloupe' ) );
+		$tag1 = self::factory()->tag->create( array( 'name' => 'Apple' ) );
+		$tag2 = self::factory()->tag->create( array( 'name' => 'Banana' ) );
 
 		// Defaults to 'orderby' => 'name', 'order' => 'asc'.
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/tags' );
@@ -360,9 +360,9 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_orderby_slugs() {
-		$this->factory->tag->create( array( 'name' => 'Burrito' ) );
-		$this->factory->tag->create( array( 'name' => 'Taco' ) );
-		$this->factory->tag->create( array( 'name' => 'Chalupa' ) );
+		self::factory()->tag->create( array( 'name' => 'Burrito' ) );
+		self::factory()->tag->create( array( 'name' => 'Taco' ) );
+		self::factory()->tag->create( array( 'name' => 'Chalupa' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'orderby', 'include_slugs' );
@@ -376,10 +376,10 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_post_args() {
-		$post_id = $this->factory->post->create();
-		$tag1    = $this->factory->tag->create( array( 'name' => 'DC' ) );
-		$tag2    = $this->factory->tag->create( array( 'name' => 'Marvel' ) );
-		$this->factory->tag->create( array( 'name' => 'Dark Horse' ) );
+		$post_id = self::factory()->post->create();
+		$tag1    = self::factory()->tag->create( array( 'name' => 'DC' ) );
+		$tag2    = self::factory()->tag->create( array( 'name' => 'Marvel' ) );
+		self::factory()->tag->create( array( 'name' => 'Dark Horse' ) );
 
 		wp_set_object_terms( $post_id, array( $tag1, $tag2 ), 'post_tag' );
 
@@ -400,7 +400,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_terms_post_args_paging() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_object_terms( $post_id, self::$tag_ids, 'post_tag' );
 
@@ -412,6 +412,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$response = rest_get_server()->dispatch( $request );
 		$tags     = $response->get_data();
 
+		$this->assertNotEmpty( $tags );
+
 		$i = 0;
 		foreach ( $tags as $tag ) {
 			$this->assertSame( $tag['name'], "Tag {$i}" );
@@ -426,6 +428,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$response = rest_get_server()->dispatch( $request );
 		$tags     = $response->get_data();
 
+		$this->assertNotEmpty( $tags );
+
 		foreach ( $tags as $tag ) {
 			$this->assertSame( $tag['name'], "Tag {$i}" );
 			$i++;
@@ -433,7 +437,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_post_empty() {
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'post', $post_id );
@@ -448,25 +452,25 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		register_taxonomy( 'batman', 'post', array( 'show_in_rest' => true ) );
 		$controller = new WP_REST_Terms_Controller( 'batman' );
 		$controller->register_routes();
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'batman',
 			)
 		);
-		$term2 = $this->factory->term->create(
+		$term2 = self::factory()->term->create(
 			array(
 				'name'     => 'Mask',
 				'taxonomy' => 'batman',
 			)
 		);
-		$this->factory->term->create(
+		self::factory()->term->create(
 			array(
 				'name'     => 'Car',
 				'taxonomy' => 'batman',
 			)
 		);
-		$post_id = $this->factory->post->create();
+		$post_id = self::factory()->post->create();
 
 		wp_set_object_terms( $post_id, array( $term1, $term2 ), 'batman' );
 
@@ -481,8 +485,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_search_args() {
-		$tag1 = $this->factory->tag->create( array( 'name' => 'Apple' ) );
-		$tag2 = $this->factory->tag->create( array( 'name' => 'Banana' ) );
+		$tag1 = self::factory()->tag->create( array( 'name' => 'Apple' ) );
+		$tag2 = self::factory()->tag->create( array( 'name' => 'Banana' ) );
 
 		/*
 		 * Tests:
@@ -505,8 +509,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_slug_arg() {
-		$tag1 = $this->factory->tag->create( array( 'name' => 'Apple' ) );
-		$tag2 = $this->factory->tag->create( array( 'name' => 'Banana' ) );
+		$tag1 = self::factory()->tag->create( array( 'name' => 'Apple' ) );
+		$tag2 = self::factory()->tag->create( array( 'name' => 'Banana' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'slug', 'apple' );
@@ -518,10 +522,10 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_slug_array_arg() {
-		$id1 = $this->factory->tag->create( array( 'name' => 'Taco' ) );
-		$id2 = $this->factory->tag->create( array( 'name' => 'Enchilada' ) );
-		$id3 = $this->factory->tag->create( array( 'name' => 'Burrito' ) );
-		$this->factory->tag->create( array( 'name' => 'Pizza' ) );
+		$id1 = self::factory()->tag->create( array( 'name' => 'Taco' ) );
+		$id2 = self::factory()->tag->create( array( 'name' => 'Enchilada' ) );
+		$id3 = self::factory()->tag->create( array( 'name' => 'Burrito' ) );
+		self::factory()->tag->create( array( 'name' => 'Pizza' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param(
@@ -541,10 +545,10 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_items_slug_csv_arg() {
-		$id1 = $this->factory->tag->create( array( 'name' => 'Taco' ) );
-		$id2 = $this->factory->tag->create( array( 'name' => 'Enchilada' ) );
-		$id3 = $this->factory->tag->create( array( 'name' => 'Burrito' ) );
-		$this->factory->tag->create( array( 'name' => 'Pizza' ) );
+		$id1 = self::factory()->tag->create( array( 'name' => 'Taco' ) );
+		$id2 = self::factory()->tag->create( array( 'name' => 'Enchilada' ) );
+		$id3 = self::factory()->tag->create( array( 'name' => 'Burrito' ) );
+		self::factory()->tag->create( array( 'name' => 'Pizza' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
 		$request->set_param( 'slug', 'taco,burrito, enchilada' );
@@ -558,13 +562,13 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 	public function test_get_terms_private_taxonomy() {
 		register_taxonomy( 'robin', 'post', array( 'public' => false ) );
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'robin',
 			)
 		);
-		$term2 = $this->factory->term->create(
+		$term2 = self::factory()->term->create(
 			array(
 				'name'     => 'Mask',
 				'taxonomy' => 'robin',
@@ -596,7 +600,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertStringContainsString( '<' . $next_link . '>; rel="next"', $headers['Link'] );
 
 		// 3rd page.
-		$this->factory->tag->create();
+		self::factory()->tag->create();
 		$total_tags++;
 		$total_pages++;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
@@ -661,7 +665,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_item() {
-		$id = $this->factory->tag->create();
+		$id = self::factory()->tag->create();
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/tags/' . $id );
 		$response = rest_get_server()->dispatch( $request );
@@ -672,7 +676,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 39122
 	 */
 	public function test_get_item_meta() {
-		$id = $this->factory->tag->create();
+		$id = self::factory()->tag->create();
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/tags/' . $id );
 		$response = rest_get_server()->dispatch( $request );
@@ -694,7 +698,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 39122
 	 */
 	public function test_get_item_meta_registered_for_different_taxonomy() {
-		$id = $this->factory->tag->create();
+		$id = self::factory()->tag->create();
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/tags/' . $id );
 		$response = rest_get_server()->dispatch( $request );
@@ -712,7 +716,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_item_invalid_permission_for_context() {
-		$id = $this->factory->tag->create();
+		$id = self::factory()->tag->create();
 
 		wp_set_current_user( 0 );
 
@@ -724,7 +728,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 	public function test_get_term_private_taxonomy() {
 		register_taxonomy( 'robin', 'post', array( 'public' => false ) );
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'robin',
@@ -738,7 +742,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 	public function test_get_item_incorrect_taxonomy() {
 		register_taxonomy( 'robin', 'post' );
-		$term1 = $this->factory->term->create(
+		$term1 = self::factory()->term->create(
 			array(
 				'name'     => 'Cape',
 				'taxonomy' => 'robin',
@@ -829,7 +833,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_create_item_with_meta_wrong_id() {
 		wp_set_current_user( self::$administrator );
 
-		$existing_tag_id = $this->factory->tag->create( array( 'name' => 'My Not So Awesome Term' ) );
+		$existing_tag_id = self::factory()->tag->create( array( 'name' => 'My Not So Awesome Term' ) );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/tags' );
 		$request->set_param( 'name', 'My Awesome Term' );
@@ -854,7 +858,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 			'slug'        => 'original-slug',
 		);
 
-		$term = get_term_by( 'id', $this->factory->tag->create( $orig_args ), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create( $orig_args ), 'post_tag' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'name', 'New Name' );
@@ -882,7 +886,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_update_item_no_change() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->tag->create(), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create(), 'post_tag' );
 
 		$request  = new WP_REST_Request( 'PUT', '/wp/v2/tags/' . $term->term_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -910,7 +914,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_update_item_incorrect_permissions() {
 		wp_set_current_user( self::$subscriber );
 
-		$term = get_term_by( 'id', $this->factory->tag->create(), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create(), 'post_tag' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'name', 'Incorrect permissions' );
@@ -924,7 +928,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_update_item_with_edit_term_cap_granted() {
 		wp_set_current_user( self::$subscriber );
 
-		$term = $this->factory->tag->create_and_get();
+		$term = self::factory()->tag->create_and_get();
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'name', 'New Name' );
@@ -951,7 +955,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_update_item_with_edit_term_cap_revoked() {
 		wp_set_current_user( self::$administrator );
 
-		$term = $this->factory->tag->create_and_get();
+		$term = self::factory()->tag->create_and_get();
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'name', 'New Name' );
@@ -973,7 +977,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_update_item_parent_non_hierarchical_taxonomy() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->tag->create(), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create(), 'post_tag' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'parent', REST_TESTS_IMPOSSIBLY_HIGH_NUMBER );
@@ -1100,7 +1104,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_delete_item() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
 
 		$request = new WP_REST_Request( 'DELETE', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'force', true );
@@ -1114,7 +1118,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_delete_item_no_trash() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
 
 		$request  = new WP_REST_Request( 'DELETE', '/wp/v2/tags/' . $term->term_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -1136,7 +1140,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_delete_item_incorrect_permissions() {
 		wp_set_current_user( self::$subscriber );
 
-		$term = get_term_by( 'id', $this->factory->tag->create(), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create(), 'post_tag' );
 
 		$request  = new WP_REST_Request( 'DELETE', '/wp/v2/tags/' . $term->term_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -1149,7 +1153,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_delete_item_with_delete_term_cap_granted() {
 		wp_set_current_user( self::$subscriber );
 
-		$term = get_term_by( 'id', $this->factory->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
 
 		$request = new WP_REST_Request( 'DELETE', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'force', true );
@@ -1177,7 +1181,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_delete_item_with_delete_term_cap_revoked() {
 		wp_set_current_user( self::$administrator );
 
-		$term = get_term_by( 'id', $this->factory->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create( array( 'name' => 'Deleted Tag' ) ), 'post_tag' );
 
 		$request = new WP_REST_Request( 'DELETE', '/wp/v2/tags/' . $term->term_id );
 		$request->set_param( 'force', true );
@@ -1197,7 +1201,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_prepare_item() {
-		$term = get_term_by( 'id', $this->factory->tag->create(), 'post_tag' );
+		$term = get_term_by( 'id', self::factory()->tag->create(), 'post_tag' );
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/tags/' . $term->term_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -1210,7 +1214,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$request  = new WP_REST_Request;
 		$endpoint = new WP_REST_Terms_Controller( 'post_tag' );
 		$request->set_param( '_fields', 'id,name' );
-		$term     = get_term_by( 'id', $this->factory->tag->create(), 'post_tag' );
+		$term     = get_term_by( 'id', self::factory()->tag->create(), 'post_tag' );
 		$response = $endpoint->prepare_item_for_response( $term, $request );
 		$this->assertSame(
 			array(
@@ -1272,7 +1276,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertArrayHasKey( 'my_custom_int', $data['schema']['properties'] );
 		$this->assertSame( $schema, $data['schema']['properties']['my_custom_int'] );
 
-		$tag_id = $this->factory->tag->create();
+		$tag_id = self::factory()->tag->create();
 
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/tags/' . $tag_id );
 		$response = rest_get_server()->dispatch( $request );
@@ -1302,7 +1306,7 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 
 		wp_set_current_user( self::$administrator );
 
-		$tag_id = $this->factory->tag->create();
+		$tag_id = self::factory()->tag->create();
 
 		// Check for error on update.
 		$request = new WP_REST_Request( 'POST', sprintf( '/wp/v2/tags/%d', $tag_id ) );
@@ -1326,8 +1330,8 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_object_term_queries_are_cached() {
 		global $wpdb;
 
-		$tags = $this->factory->tag->create_many( 2 );
-		$p    = $this->factory->post->create();
+		$tags = self::factory()->tag->create_many( 2 );
+		$p    = self::factory()->post->create();
 		wp_set_object_terms( $p, $tags[0], 'post_tag' );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/tags' );
diff --git a/tests/rest-api/rest-taxonomies-controller.php b/tests/rest-api/rest-taxonomies-controller.php
index 38906f5513..78593e6bd8 100644
--- a/tests/rest-api/rest-taxonomies-controller.php
+++ b/tests/rest-api/rest-taxonomies-controller.php
@@ -112,7 +112,7 @@ class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcas
 	}
 
 	public function test_get_item_edit_context() {
-		$editor_id = $this->factory->user->create( array( 'role' => 'editor' ) );
+		$editor_id = self::factory()->user->create( array( 'role' => 'editor' ) );
 		wp_set_current_user( $editor_id );
 		$request = new WP_REST_Request( 'GET', '/wp/v2/taxonomies/category' );
 		$request->set_param( 'context', 'edit' );
diff --git a/tests/rest-api/rest-term-meta-fields.php b/tests/rest-api/rest-term-meta-fields.php
index eb25ffc226..5a61623387 100644
--- a/tests/rest-api/rest-term-meta-fields.php
+++ b/tests/rest-api/rest-term-meta-fields.php
@@ -200,7 +200,7 @@ class WP_Test_REST_Term_Meta_Fields extends WP_Test_REST_TestCase {
 
 	protected function grant_write_permission() {
 		// Ensure we have write permission.
-		$user = $this->factory->user->create(
+		$user = self::factory()->user->create(
 			array(
 				'role' => 'editor',
 			)
diff --git a/tests/rest-api/rest-themes-controller.php b/tests/rest-api/rest-themes-controller.php
index 73a8b4c3cc..0492f191fe 100644
--- a/tests/rest-api/rest-themes-controller.php
+++ b/tests/rest-api/rest-themes-controller.php
@@ -387,6 +387,8 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 		$theme_supports = $properties['theme_supports']['properties'];
 		$this->assertArrayHasKey( 'align-wide', $theme_supports );
 		$this->assertArrayHasKey( 'automatic-feed-links', $theme_supports );
+		$this->assertArrayHasKey( 'block-templates', $theme_supports );
+		$this->assertArrayHasKey( 'block-template-parts', $theme_supports, "Theme supports should have 'block-template-parts' key" );
 		$this->assertArrayHasKey( 'custom-header', $theme_supports );
 		$this->assertArrayHasKey( 'custom-background', $theme_supports );
 		$this->assertArrayHasKey( 'custom-logo', $theme_supports );
@@ -395,6 +397,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertArrayHasKey( 'dark-editor-style', $theme_supports );
 		$this->assertArrayHasKey( 'disable-custom-font-sizes', $theme_supports );
 		$this->assertArrayHasKey( 'disable-custom-gradients', $theme_supports );
+		$this->assertArrayHasKey( 'disable-layout-styles', $theme_supports );
 		$this->assertArrayHasKey( 'editor-color-palette', $theme_supports );
 		$this->assertArrayHasKey( 'editor-font-sizes', $theme_supports );
 		$this->assertArrayHasKey( 'editor-gradient-presets', $theme_supports );
@@ -405,7 +408,7 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertArrayHasKey( 'responsive-embeds', $theme_supports );
 		$this->assertArrayHasKey( 'title-tag', $theme_supports );
 		$this->assertArrayHasKey( 'wp-block-styles', $theme_supports );
-		$this->assertCount( 20, $theme_supports );
+		$this->assertCount( 23, $theme_supports, 'There should be 23 theme supports' );
 	}
 
 	/**
@@ -1199,13 +1202,21 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 
 	/**
 	 * The create_item() method does not exist for themes.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_create_item() {}
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
 
 	/**
 	 * The update_item() method does not exist for themes.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_update_item() {}
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
 
 	/**
 	 * Test single theme.
@@ -1285,15 +1296,86 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	/**
-	 * @ticket 54349
+	 * @dataProvider data_get_item_non_subdir_theme
+	 * @ticket 54596
+	 * @covers WP_REST_Themes_Controller::get_item
+	 *
+	 * @param string $theme_dir     Theme directory to test.
+	 * @param string $expected_name Expected theme name.
 	 */
-	public function test_get_item_subdirectory_theme() {
+	public function test_get_item_non_subdir_theme( $theme_dir, $expected_name ) {
 		wp_set_current_user( self::$admin_id );
-		$request  = new WP_REST_Request( 'GET', self::$themes_route . '/subdir/theme2' );
+		$request  = new WP_REST_Request( 'GET', self::$themes_route . $theme_dir );
 		$response = rest_do_request( $request );
 
 		$this->assertSame( 200, $response->get_status() );
-		$this->assertSame( 'My Subdir Theme', $response->get_data()['name']['raw'] );
+		$this->assertSame( $expected_name, $response->get_data()['name']['raw'] );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_item_non_subdir_theme() {
+		return array(
+			'parent theme'                => array(
+				'theme_dir'     => '/block-theme',
+				'expected_name' => 'Block Theme',
+			),
+			'child theme'                 => array(
+				'theme_dir'     => '/block-theme-child',
+				'expected_name' => 'Block Theme Child Theme',
+			),
+			'theme with _-[]. characters' => array(
+				'theme_dir'     => '/block_theme-[0.4.0]',
+				'expected_name' => 'Block Theme [0.4.0]',
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_item_subdirectory_theme
+	 * @ticket 54349
+	 * @ticket 54596
+	 * @covers WP_REST_Themes_Controller::get_item
+	 *
+	 * @param string $theme_dir     Theme directory to test.
+	 * @param string $expected_name Expected theme name.
+	 */
+	public function test_get_item_subdirectory_theme( $theme_dir, $expected_name ) {
+		wp_set_current_user( self::$admin_id );
+		$request  = new WP_REST_Request( 'GET', self::$themes_route . $theme_dir );
+		$response = rest_do_request( $request );
+
+		$this->assertSame(
+			200,
+			$response->get_status(),
+			'A 200 OK status was not returned.'
+		);
+		$this->assertSame(
+			$expected_name,
+			$response->get_data()['name']['raw'],
+			'The actual theme name was not the expected theme name.'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_item_subdirectory_theme() {
+		return array(
+			'theme2'                      => array(
+				'theme_dir'     => '/subdir/theme2',
+				'expected_name' => 'My Subdir Theme',
+			),
+			'theme with _-[]. characters' => array(
+				'theme_dir'     => '/subdir/block_theme-[1.0.0]',
+				'expected_name' => 'Block Theme [1.0.0] in subdirectory',
+			),
+		);
 	}
 
 	/**
@@ -1322,11 +1404,19 @@ class WP_Test_REST_Themes_Controller extends WP_Test_REST_Controller_Testcase {
 
 	/**
 	 * The delete_item() method does not exist for themes.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_delete_item() {}
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
 
 	/**
 	 * Context is not supported for themes.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_context_param() {}
+	public function test_context_param() {
+		// Controller does not use get_context_param().
+	}
 }
diff --git a/tests/rest-api/rest-users-controller.php b/tests/rest-api/rest-users-controller.php
index 4a28f210a1..849b0e5464 100644
--- a/tests/rest-api/rest-users-controller.php
+++ b/tests/rest-api/rest-users-controller.php
@@ -25,6 +25,11 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 
 	protected static $site;
 
+	/**
+	 * @var WP_REST_Users_Controller
+	 */
+	private $endpoint;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$superadmin   = $factory->user->create(
 			array(
@@ -192,7 +197,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
 		$keys     = array_keys( $data['endpoints'][0]['args'] );
-		$this->assertEqualSets(
+		$this->assertSameSets(
 			array(
 				'context',
 				'exclude',
@@ -335,7 +340,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertStringContainsString( '<' . $next_link . '>; rel="next"', $headers['Link'] );
 
 		// 3rd page.
-		$this->factory->user->create();
+		self::factory()->user->create();
 		$total_users++;
 		$total_pages++;
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
@@ -427,9 +432,9 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_orderby_name() {
 		wp_set_current_user( self::$user );
 
-		$low_id  = $this->factory->user->create( array( 'display_name' => 'AAAAA' ) );
-		$mid_id  = $this->factory->user->create( array( 'display_name' => 'NNNNN' ) );
-		$high_id = $this->factory->user->create( array( 'display_name' => 'ZZZZ' ) );
+		$low_id  = self::factory()->user->create( array( 'display_name' => 'AAAAA' ) );
+		$mid_id  = self::factory()->user->create( array( 'display_name' => 'NNNNN' ) );
+		$high_id = self::factory()->user->create( array( 'display_name' => 'ZZZZ' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'orderby', 'name' );
@@ -451,8 +456,8 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_orderby_url() {
 		wp_set_current_user( self::$user );
 
-		$low_id  = $this->factory->user->create( array( 'user_url' => 'http://a.com' ) );
-		$high_id = $this->factory->user->create( array( 'user_url' => 'http://b.com' ) );
+		$low_id  = self::factory()->user->create( array( 'user_url' => 'http://a.com' ) );
+		$high_id = self::factory()->user->create( array( 'user_url' => 'http://b.com' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'orderby', 'url' );
@@ -476,8 +481,8 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_orderby_slug() {
 		wp_set_current_user( self::$user );
 
-		$high_id = $this->factory->user->create( array( 'user_nicename' => 'blogin' ) );
-		$low_id  = $this->factory->user->create( array( 'user_nicename' => 'alogin' ) );
+		$high_id = self::factory()->user->create( array( 'user_nicename' => 'blogin' ) );
+		$low_id  = self::factory()->user->create( array( 'user_nicename' => 'alogin' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'orderby', 'slug' );
@@ -501,9 +506,9 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_orderby_slugs() {
 		wp_set_current_user( self::$user );
 
-		$this->factory->user->create( array( 'user_nicename' => 'burrito' ) );
-		$this->factory->user->create( array( 'user_nicename' => 'taco' ) );
-		$this->factory->user->create( array( 'user_nicename' => 'chalupa' ) );
+		self::factory()->user->create( array( 'user_nicename' => 'burrito' ) );
+		self::factory()->user->create( array( 'user_nicename' => 'taco' ) );
+		self::factory()->user->create( array( 'user_nicename' => 'chalupa' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'orderby', 'include_slugs' );
@@ -519,8 +524,8 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_orderby_email() {
 		wp_set_current_user( self::$user );
 
-		$high_id = $this->factory->user->create( array( 'user_email' => 'bemail@gmail.com' ) );
-		$low_id  = $this->factory->user->create( array( 'user_email' => 'aemail@gmail.com' ) );
+		$high_id = self::factory()->user->create( array( 'user_email' => 'bemail@gmail.com' ) );
+		$low_id  = self::factory()->user->create( array( 'user_email' => 'aemail@gmail.com' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'orderby', 'email' );
@@ -599,8 +604,8 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_include_query() {
 		wp_set_current_user( self::$user );
 
-		$id1 = $this->factory->user->create();
-		$id2 = $this->factory->user->create();
+		$id1 = self::factory()->user->create();
+		$id2 = self::factory()->user->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 
@@ -635,8 +640,8 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_exclude_query() {
 		wp_set_current_user( self::$user );
 
-		$id1 = $this->factory->user->create();
-		$id2 = $this->factory->user->create();
+		$id1 = self::factory()->user->create();
+		$id2 = self::factory()->user->create();
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'per_page', self::$per_page ); // There are >10 users at this point.
@@ -667,14 +672,14 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertCount( 0, $response->get_data() );
 
-		$yolo_id = $this->factory->user->create( array( 'display_name' => 'yololololo' ) );
+		$yolo_id = self::factory()->user->create( array( 'display_name' => 'yololololo' ) );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/users' );
 		$request->set_param( 'search', 'yololololo' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertCount( 1, $response->get_data() );
 		// Default to wildcard search.
-		$adam_id = $this->factory->user->create(
+		$adam_id = self::factory()->user->create(
 			array(
 				'role'          => 'author',
 				'user_nicename' => 'adam',
@@ -692,13 +697,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_slug_query() {
 		wp_set_current_user( self::$user );
 
-		$this->factory->user->create(
+		self::factory()->user->create(
 			array(
 				'display_name' => 'foo',
 				'user_login'   => 'bar',
 			)
 		);
-		$id2 = $this->factory->user->create(
+		$id2 = self::factory()->user->create(
 			array(
 				'display_name' => 'Moo',
 				'user_login'   => 'foo',
@@ -716,25 +721,25 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_slug_array_query() {
 		wp_set_current_user( self::$user );
 
-		$id1 = $this->factory->user->create(
+		$id1 = self::factory()->user->create(
 			array(
 				'display_name' => 'Taco',
 				'user_login'   => 'taco',
 			)
 		);
-		$id2 = $this->factory->user->create(
+		$id2 = self::factory()->user->create(
 			array(
 				'display_name' => 'Enchilada',
 				'user_login'   => 'enchilada',
 			)
 		);
-		$id3 = $this->factory->user->create(
+		$id3 = self::factory()->user->create(
 			array(
 				'display_name' => 'Burrito',
 				'user_login'   => 'burrito',
 			)
 		);
-		$this->factory->user->create(
+		self::factory()->user->create(
 			array(
 				'display_name' => 'Hon Pizza',
 				'user_login'   => 'pizza',
@@ -762,25 +767,25 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	public function test_get_items_slug_csv_query() {
 		wp_set_current_user( self::$user );
 
-		$id1 = $this->factory->user->create(
+		$id1 = self::factory()->user->create(
 			array(
 				'display_name' => 'Taco',
 				'user_login'   => 'taco',
 			)
 		);
-		$id2 = $this->factory->user->create(
+		$id2 = self::factory()->user->create(
 			array(
 				'display_name' => 'Enchilada',
 				'user_login'   => 'enchilada',
 			)
 		);
-		$id3 = $this->factory->user->create(
+		$id3 = self::factory()->user->create(
 			array(
 				'display_name' => 'Burrito',
 				'user_login'   => 'burrito',
 			)
 		);
-		$this->factory->user->create(
+		self::factory()->user->create(
 			array(
 				'display_name' => 'Hon Pizza',
 				'user_login'   => 'pizza',
@@ -957,7 +962,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_item() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		wp_set_current_user( self::$user );
 
@@ -1024,7 +1029,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 
 		$this->allow_user_to_manage_multisite();
 
-		$lolz = $this->factory->user->create(
+		$lolz = self::factory()->user->create(
 			array(
 				'display_name' => 'lolz',
 				'roles'        => '',
@@ -1109,27 +1114,27 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_item_published_author_post() {
-		$this->author_id = $this->factory->user->create(
+		$author_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
 		);
 
-		$this->post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
-				'post_author' => $this->author_id,
+				'post_author' => $author_id,
 			)
 		);
 
 		wp_set_current_user( 0 );
 
-		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/users/%d', $this->author_id ) );
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/users/%d', $author_id ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->check_get_user_response( $response, 'embed' );
 	}
 
 	public function test_get_item_published_author_pages() {
-		$this->author_id = $this->factory->user->create(
+		$author_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -1137,13 +1142,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 
 		wp_set_current_user( 0 );
 
-		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/users/%d', $this->author_id ) );
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/users/%d', $author_id ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertSame( 401, $response->get_status() );
 
-		$this->post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
-				'post_author' => $this->author_id,
+				'post_author' => $author_id,
 				'post_type'   => 'page',
 			)
 		);
@@ -1153,7 +1158,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_user_with_edit_context() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
@@ -1164,21 +1169,21 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_get_item_published_author_wrong_context() {
-		$this->author_id = $this->factory->user->create(
+		$author_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
 		);
 
-		$this->post_id = $this->factory->post->create(
+		$post_id = self::factory()->post->create(
 			array(
-				'post_author' => $this->author_id,
+				'post_author' => $author_id,
 			)
 		);
 
 		wp_set_current_user( 0 );
 
-		$request = new WP_REST_Request( 'GET', sprintf( '/wp/v2/users/%d', $this->author_id ) );
+		$request = new WP_REST_Request( 'GET', sprintf( '/wp/v2/users/%d', $author_id ) );
 		$request->set_param( 'context', 'edit' );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_user_cannot_view', $response, 401 );
@@ -1549,7 +1554,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_item() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'user_email' => 'test@example.com',
 				'user_pass'  => 'sjflsfls',
@@ -1615,13 +1620,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_item_existing_email() {
-		$user1 = $this->factory->user->create(
+		$user1 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user',
 				'user_email' => 'testjson@example.com',
 			)
 		);
-		$user2 = $this->factory->user->create(
+		$user2 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user2',
 				'user_email' => 'testjson2@example.com',
@@ -1679,7 +1684,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_item_invalid_locale() {
-		$user1 = $this->factory->user->create(
+		$user1 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user',
 				'user_email' => 'testjson@example.com',
@@ -1698,7 +1703,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_item_en_US_locale() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user',
 				'user_email' => 'testjson@example.com',
@@ -1722,7 +1727,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 38632
 	 */
 	public function test_update_item_empty_locale() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user',
 				'user_email' => 'testjson@example.com',
@@ -1746,13 +1751,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_item_username_attempt() {
-		$user1 = $this->factory->user->create(
+		$user1 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user',
 				'user_email' => 'testjson@example.com',
 			)
 		);
-		$user2 = $this->factory->user->create(
+		$user2 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user2',
 				'user_email' => 'testjson2@example.com',
@@ -1771,13 +1776,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_item_existing_nicename() {
-		$user1 = $this->factory->user->create(
+		$user1 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user',
 				'user_email' => 'testjson@example.com',
 			)
 		);
-		$user2 = $this->factory->user->create(
+		$user2 = self::factory()->user->create(
 			array(
 				'user_login' => 'test_json_user2',
 				'user_email' => 'testjson2@example.com',
@@ -1796,7 +1801,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_json_update_user() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'user_email' => 'testjson2@example.com',
 				'user_pass'  => 'sjflsfl3sdjls',
@@ -1841,7 +1846,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_user_role() {
-		$user_id = $this->factory->user->create( array( 'role' => 'administrator' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'administrator' ) );
 
 		wp_set_current_user( self::$user );
 
@@ -1862,7 +1867,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_update_user_multiple_roles() {
-		$user_id = $this->factory->user->create( array( 'role' => 'administrator' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'administrator' ) );
 
 		wp_set_current_user( self::$user );
 
@@ -1908,7 +1913,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @group ms-excluded
 	 */
 	public function test_update_user_role_invalid_privilege_deescalation() {
-		$user_id = $this->factory->user->create( array( 'role' => 'administrator' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'administrator' ) );
 
 		wp_set_current_user( $user_id );
 
@@ -1937,7 +1942,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @group ms-required
 	 */
 	public function test_update_user_role_privilege_deescalation_multisite() {
-		$user_id = $this->factory->user->create( array( 'role' => 'administrator' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'administrator' ) );
 
 		wp_set_current_user( $user_id );
 		$user = wp_get_current_user();
@@ -1951,7 +1956,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertSame( 'editor', $new_data['roles'][0] );
 		$this->assertNotEquals( 'administrator', $new_data['roles'][0] );
 
-		$user_id = $this->factory->user->create( array( 'role' => 'administrator' ) );
+		$user_id = self::factory()->user->create( array( 'role' => 'administrator' ) );
 
 		wp_set_current_user( $user_id );
 		$user = wp_get_current_user();
@@ -2041,7 +2046,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 40263
 	 */
 	public function test_update_item_only_roles_as_editor() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2059,7 +2064,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 40263
 	 */
 	public function test_update_item_only_roles_as_site_administrator() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2080,7 +2085,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 * @ticket 40263
 	 */
 	public function test_update_item_including_roles_and_other_params() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2336,7 +2341,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_item() {
-		$user_id = $this->factory->user->create( array( 'display_name' => 'Deleted User' ) );
+		$user_id = self::factory()->user->create( array( 'display_name' => 'Deleted User' ) );
 
 		$this->allow_user_to_manage_multisite();
 
@@ -2361,7 +2366,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_item_no_trash() {
-		$user_id = $this->factory->user->create( array( 'display_name' => 'Deleted User' ) );
+		$user_id = self::factory()->user->create( array( 'display_name' => 'Deleted User' ) );
 
 		$this->allow_user_to_manage_multisite();
 
@@ -2391,7 +2396,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_current_item() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role'         => 'administrator',
 				'display_name' => 'Deleted User',
@@ -2420,7 +2425,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_current_item_no_trash() {
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role'         => 'administrator',
 				'display_name' => 'Deleted User',
@@ -2453,7 +2458,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_without_permission() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
@@ -2491,9 +2496,9 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->allow_user_to_manage_multisite();
 
 		// Test with a new user, to avoid any complications.
-		$user_id     = $this->factory->user->create();
-		$reassign_id = $this->factory->user->create();
-		$test_post   = $this->factory->post->create(
+		$user_id     = self::factory()->user->create();
+		$reassign_id = self::factory()->user->create();
+		$test_post   = self::factory()->post->create(
 			array(
 				'post_author' => $user_id,
 			)
@@ -2525,7 +2530,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_invalid_reassign_id() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
@@ -2546,7 +2551,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_invalid_reassign_passed_as_string() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
@@ -2561,13 +2566,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_reassign_passed_as_boolean_false_trashes_post() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
 		wp_set_current_user( self::$user );
 
-		$test_post = $this->factory->post->create(
+		$test_post = self::factory()->post->create(
 			array(
 				'post_author' => $user_id,
 			)
@@ -2589,13 +2594,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_reassign_passed_as_string_false_trashes_post() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
 		wp_set_current_user( self::$user );
 
-		$test_post = $this->factory->post->create(
+		$test_post = self::factory()->post->create(
 			array(
 				'post_author' => $user_id,
 			)
@@ -2617,13 +2622,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_reassign_passed_as_empty_string_trashes_post() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
 		wp_set_current_user( self::$user );
 
-		$test_post = $this->factory->post->create(
+		$test_post = self::factory()->post->create(
 			array(
 				'post_author' => $user_id,
 			)
@@ -2645,13 +2650,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	public function test_delete_user_reassign_passed_as_0_reassigns_author() {
-		$user_id = $this->factory->user->create();
+		$user_id = self::factory()->user->create();
 
 		$this->allow_user_to_manage_multisite();
 
 		wp_set_current_user( self::$user );
 
-		$test_post = $this->factory->post->create(
+		$test_post = self::factory()->post->create(
 			array(
 				'post_author' => $user_id,
 			)
@@ -2826,7 +2831,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 */
 	public function test_get_item_from_different_site_as_site_administrator() {
 		switch_to_blog( self::$site );
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2846,7 +2851,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 */
 	public function test_get_item_from_different_site_as_network_administrator() {
 		switch_to_blog( self::$site );
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2866,7 +2871,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 */
 	public function test_update_item_from_different_site_as_site_administrator() {
 		switch_to_blog( self::$site );
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2888,7 +2893,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 */
 	public function test_update_item_from_different_site_as_network_administrator() {
 		switch_to_blog( self::$site );
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2910,7 +2915,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 */
 	public function test_delete_item_from_different_site_as_site_administrator() {
 		switch_to_blog( self::$site );
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
@@ -2932,7 +2937,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 	 */
 	public function test_delete_item_from_different_site_as_network_administrator() {
 		switch_to_blog( self::$site );
-		$user_id = $this->factory->user->create(
+		$user_id = self::factory()->user->create(
 			array(
 				'role' => 'author',
 			)
diff --git a/tests/rest-api/rest-widget-types-controller.php b/tests/rest-api/rest-widget-types-controller.php
index a7d1d47d61..5c6f22bfee 100644
--- a/tests/rest-api/rest-widget-types-controller.php
+++ b/tests/rest-api/rest-widget-types-controller.php
@@ -531,17 +531,29 @@ class WP_Test_REST_Widget_Types_Controller extends WP_Test_REST_Controller_Testc
 	}
 
 	/**
-	 * The test_create_item() method does not exist for widget types.
+	 * The create_item() method does not exist for widget types.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_create_item() {}
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
 
 	/**
-	 * The test_update_item() method does not exist for widget types.
+	 * The update_item() method does not exist for widget types.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_update_item() {}
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
 
 	/**
-	 * The test_delete_item() method does not exist for widget types.
+	 * The delete_item() method does not exist for widget types.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_delete_item() {}
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
 }
diff --git a/tests/rest-api/rest-widgets-controller.php b/tests/rest-api/rest-widgets-controller.php
index a548ab79e1..28ac8bc6e3 100644
--- a/tests/rest-api/rest-widgets-controller.php
+++ b/tests/rest-api/rest-widgets-controller.php
@@ -214,9 +214,10 @@ class WP_Test_REST_Widgets_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	/**
-	 * @ticket 41683
+	 * @doesNotPerformAssertions
 	 */
 	public function test_context_param() {
+		// Controller does not use get_context_param().
 	}
 
 	/**
@@ -1508,9 +1509,12 @@ class WP_Test_REST_Widgets_Controller extends WP_Test_REST_Controller_Testcase {
 	}
 
 	/**
-	 * The test_prepare_item() method does not exist for sidebar.
+	 * The prepare_item() method does not exist for sidebar.
+	 *
+	 * @doesNotPerformAssertions
 	 */
 	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
 	}
 
 	/**
diff --git a/tests/rest-api/wpRestBlockPatternCategoriesController.php b/tests/rest-api/wpRestBlockPatternCategoriesController.php
new file mode 100644
index 0000000000..bd9dd9a0dd
--- /dev/null
+++ b/tests/rest-api/wpRestBlockPatternCategoriesController.php
@@ -0,0 +1,196 @@
+<?php
+/**
+ * Unit tests covering WP_Block_Pattern_Categories_Registry functionality.
+ *
+ * @package    WordPress
+ * @subpackage REST_API
+ * @since      6.0.0
+ */
+
+/**
+ * Tests for REST API for Block Pattern Categories Registry.
+ *
+ * @since 6.0.0
+ *
+ * @ticket 55505
+ *
+ * @covers WP_REST_Block_Pattern_Categories_Controller
+ *
+ * @group restapi
+ */
+class Tests_REST_WpRestBlockPatternCategoriesController extends WP_Test_REST_Controller_Testcase {
+
+	/**
+	 * Admin user ID.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var int
+	 */
+	protected static $admin_id;
+
+	/**
+	 * Original instance of WP_Block_Patterns_Registry.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var WP_Block_Patterns_Registry
+	 */
+	protected static $orig_registry;
+
+	/**
+	 * Instance of the reflected `instance` property.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var ReflectionProperty
+	 */
+	private static $registry_instance_property;
+
+	/**
+	 * The REST API route.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var string
+	 */
+	const REQUEST_ROUTE = '/wp/v2/block-patterns/categories';
+
+	/**
+	 * Set up class test fixtures.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @param WP_UnitTest_Factory $factory WordPress unit test factory.
+	 */
+	public static function wpSetupBeforeClass( $factory ) {
+		self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
+
+		// Setup an empty testing instance of `WP_Block_Pattern_Categories_Registry` and save the original.
+		self::$orig_registry              = WP_Block_Pattern_Categories_Registry::get_instance();
+		self::$registry_instance_property = new ReflectionProperty( 'WP_Block_Pattern_Categories_Registry', 'instance' );
+		self::$registry_instance_property->setAccessible( true );
+		$test_registry = new WP_Block_Pattern_Categories_Registry();
+		self::$registry_instance_property->setValue( $test_registry );
+
+		// Register some categories in the test registry.
+		$test_registry->register( 'test', array( 'label' => 'Test' ) );
+		$test_registry->register( 'query', array( 'label' => 'Query' ) );
+	}
+
+	public static function wpTearDownAfterClass() {
+		self::delete_user( self::$admin_id );
+
+		// Restore the original registry instance.
+		self::$registry_instance_property->setValue( self::$orig_registry );
+		self::$registry_instance_property->setAccessible( false );
+		self::$registry_instance_property = null;
+		self::$orig_registry              = null;
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		switch_theme( 'emptytheme' );
+	}
+
+	public function test_register_routes() {
+		$routes = rest_get_server()->get_routes();
+		$this->assertArrayHasKey( static::REQUEST_ROUTE, $routes );
+	}
+
+	public function test_get_items() {
+		wp_set_current_user( self::$admin_id );
+
+		$expected_names  = array( 'test', 'query' );
+		$expected_fields = array( 'name', 'label' );
+
+		$request            = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$request['_fields'] = 'name,label';
+		$response           = rest_get_server()->dispatch( $request );
+		$data               = $response->get_data();
+
+		$this->assertCount( count( $expected_names ), $data );
+		foreach ( $data as $idx => $item ) {
+			$this->assertSame( $expected_names[ $idx ], $item['name'] );
+			$this->assertSame( $expected_fields, array_keys( $item ) );
+		}
+	}
+
+	/**
+	 * Verify capability check for unauthorized request (not logged in).
+	 */
+	public function test_get_items_unauthorized() {
+		// Ensure current user is logged out.
+		wp_logout();
+
+		$request  = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$response = rest_do_request( $request );
+
+		$this->assertWPError( $response->as_error() );
+		$this->assertSame( 401, $response->get_status() );
+	}
+
+	/**
+	 * Verify capability check for forbidden request (insufficient capability).
+	 */
+	public function test_get_items_forbidden() {
+		// Set current user without `edit_posts` capability.
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'subscriber' ) ) );
+
+		$request  = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$response = rest_do_request( $request );
+
+		$this->assertWPError( $response->as_error() );
+		$this->assertSame( 403, $response->get_status() );
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_context_param() {
+		// Controller does not use get_context_param().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_get_item() {
+		// Controller does not implement get_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_get_item_schema() {
+		// Controller does not implement get_item_schema().
+	}
+}
diff --git a/tests/rest-api/wpRestBlockPatternsController.php b/tests/rest-api/wpRestBlockPatternsController.php
new file mode 100644
index 0000000000..f49c658ae5
--- /dev/null
+++ b/tests/rest-api/wpRestBlockPatternsController.php
@@ -0,0 +1,222 @@
+<?php
+/**
+ * Unit tests covering WP_REST_Block_Patterns_Controller functionality.
+ *
+ * @package    WordPress
+ * @subpackage REST_API
+ * @since      6.0.0
+ */
+
+/**
+ * Tests for REST API for Block Patterns.
+ *
+ * @since 6.0.0
+ *
+ * @ticket 55505
+ *
+ * @covers WP_REST_Block_Patterns_Controller
+ *
+ * @group restapi
+ */
+class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_Testcase {
+
+	/**
+	 * Admin user ID.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var int
+	 */
+	protected static $admin_id;
+
+	/**
+	 * Original instance of WP_Block_Patterns_Registry.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var WP_Block_Patterns_Registry
+	 */
+	protected static $orig_registry;
+
+	/**
+	 * Instance of the reflected `instance` property.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var ReflectionProperty
+	 */
+	private static $registry_instance_property;
+
+	/**
+	 * The REST API route.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var string
+	 */
+	const REQUEST_ROUTE = '/wp/v2/block-patterns/patterns';
+
+	/**
+	 * Set up class test fixtures.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @param WP_UnitTest_Factory $factory WordPress unit test factory.
+	 */
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
+
+		// Setup an empty testing instance of `WP_Block_Patterns_Registry` and save the original.
+		self::$orig_registry              = WP_Block_Patterns_Registry::get_instance();
+		self::$registry_instance_property = new ReflectionProperty( 'WP_Block_Patterns_Registry', 'instance' );
+		self::$registry_instance_property->setAccessible( true );
+		$test_registry = new WP_Block_Pattern_Categories_Registry();
+		self::$registry_instance_property->setValue( $test_registry );
+
+		// Register some patterns in the test registry.
+		$test_registry->register(
+			'test/one',
+			array(
+				'title'         => 'Pattern One',
+				'categories'    => array( 'test' ),
+				'viewportWidth' => 1440,
+				'content'       => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+			)
+		);
+
+		$test_registry->register(
+			'test/two',
+			array(
+				'title'      => 'Pattern Two',
+				'categories' => array( 'test' ),
+				'content'    => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+			)
+		);
+	}
+
+	public static function wpTearDownAfterClass() {
+		self::delete_user( self::$admin_id );
+
+		// Restore the original registry instance.
+		self::$registry_instance_property->setValue( self::$orig_registry );
+		self::$registry_instance_property->setAccessible( false );
+		self::$registry_instance_property = null;
+		self::$orig_registry              = null;
+	}
+
+	public function set_up() {
+		parent::set_up();
+
+		switch_theme( 'emptytheme' );
+	}
+
+	public function test_register_routes() {
+		$routes = rest_get_server()->get_routes();
+		$this->assertArrayHasKey( static::REQUEST_ROUTE, $routes );
+	}
+
+	public function test_get_items() {
+		wp_set_current_user( self::$admin_id );
+
+		$request            = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$request['_fields'] = 'name,content';
+		$response           = rest_get_server()->dispatch( $request );
+		$data               = $response->get_data();
+
+		$this->assertIsArray( $data, 'WP_REST_Block_Patterns_Controller::get_items() should return an array' );
+		$this->assertGreaterThanOrEqual( 2, count( $data ), 'WP_REST_Block_Patterns_Controller::get_items() should return at least 2 items' );
+		$this->assertSame(
+			array(
+				'name'    => 'test/one',
+				'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+			),
+			$data[0],
+			'WP_REST_Block_Patterns_Controller::get_items() should return test/one'
+		);
+		$this->assertSame(
+			array(
+				'name'    => 'test/two',
+				'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+			),
+			$data[1],
+			'WP_REST_Block_Patterns_Controller::get_items() should return test/two'
+		);
+	}
+
+	/**
+	 * Verify capability check for unauthorized request (not logged in).
+	 */
+	public function test_get_items_unauthorized() {
+		// Ensure current user is logged out.
+		wp_logout();
+
+		$request  = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$response = rest_do_request( $request );
+
+		$this->assertWPError( $response->as_error() );
+		$this->assertSame( 401, $response->get_status() );
+	}
+
+	/**
+	 * Verify capability check for forbidden request (insufficient capability).
+	 */
+	public function test_get_items_forbidden() {
+		// Set current user without `edit_posts` capability.
+		wp_set_current_user( self::factory()->user->create( array( 'role' => 'subscriber' ) ) );
+
+		$request  = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$response = rest_do_request( $request );
+
+		$this->assertWPError( $response->as_error() );
+		$this->assertSame( 403, $response->get_status() );
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_context_param() {
+		// Controller does not use get_context_param().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_get_item() {
+		// Controller does not implement get_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
+	}
+
+	/**
+	 * @doesNotPerformAssertions
+	 */
+	public function test_get_item_schema() {
+		// Controller does not implement get_item_schema().
+	}
+}
diff --git a/tests/rest-api/wpRestEditSiteExportController.php b/tests/rest-api/wpRestEditSiteExportController.php
index 4683d68fed..c32ea170b8 100644
--- a/tests/rest-api/wpRestEditSiteExportController.php
+++ b/tests/rest-api/wpRestEditSiteExportController.php
@@ -99,58 +99,58 @@ class Tests_REST_WpRestEditSiteExportController extends WP_Test_REST_Controller_
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_context_param() {
-		$this->markTestSkipped( 'Controller does not implement context_param().' );
+		// Controller does not use get_context_param().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_get_item() {
-		$this->markTestSkipped( 'Controller does not implement get_item().' );
+		// Controller does not implement get_item().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_get_items() {
-		$this->markTestSkipped( 'Controller does not implement get_items().' );
+		// Controller does not implement get_items().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_create_item() {
-		$this->markTestSkipped( 'Controller does not implement create_item().' );
+		// Controller does not implement create_item().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_update_item() {
-		$this->markTestSkipped( 'Controller does not implement update_item().' );
+		// Controller does not implement update_item().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_delete_item() {
-		$this->markTestSkipped( 'Controller does not implement delete_item().' );
+		// Controller does not implement delete_item().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_prepare_item() {
-		$this->markTestSkipped( 'Controller does not implement prepare_item().' );
+		// Controller does not implement prepare_item().
 	}
 
 	/**
-	 * @ticket 54448
+	 * @doesNotPerformAssertions
 	 */
 	public function test_get_item_schema() {
-		$this->markTestSkipped( 'Controller does not implement get_item_schema().' );
+		// Controller does not implement get_item_schema().
 	}
 }
diff --git a/tests/rest-api/wpRestMenuLocationsController.php b/tests/rest-api/wpRestMenuLocationsController.php
index 9f100719ff..c24714ea93 100644
--- a/tests/rest-api/wpRestMenuLocationsController.php
+++ b/tests/rest-api/wpRestMenuLocationsController.php
@@ -140,24 +140,40 @@ class Tests_REST_WpRestMenuLocationsController extends WP_Test_REST_Controller_T
 	}
 
 	/**
-	 * The test_create_item() method does not exist for menu locations.
+	 * The create_item() method does not exist for menu locations.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_create_item() {}
+	public function test_create_item() {
+		// Controller does not implement create_item().
+	}
 
 	/**
-	 * The test_update_item() method does not exist for menu locations.
+	 * The update_item() method does not exist for menu locations.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_update_item() {}
+	public function test_update_item() {
+		// Controller does not implement update_item().
+	}
 
 	/**
-	 * The test_delete_item() method does not exist for menu locations.
+	 * The delete_item() method does not exist for menu locations.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_delete_item() {}
+	public function test_delete_item() {
+		// Controller does not implement delete_item().
+	}
 
 	/**
-	 * The test_prepare_item() method does not exist for menu locations.
+	 * The prepare_item() method does not exist for menu locations.
+	 *
+	 * @doesNotPerformAssertions
 	 */
-	public function test_prepare_item() {}
+	public function test_prepare_item() {
+		// Controller does not implement prepare_item().
+	}
 
 	/**
 	 * @ticket 40878
diff --git a/tests/rest-api/wpRestMenusController.php b/tests/rest-api/wpRestMenusController.php
index 4b2384c1a7..3db23f2d45 100644
--- a/tests/rest-api/wpRestMenusController.php
+++ b/tests/rest-api/wpRestMenusController.php
@@ -85,7 +85,7 @@ class Tests_REST_WpRestMenusController extends WP_Test_REST_Controller_Testcase
 			'taxonomy'    => 'nav_menu',
 		);
 
-		$this->menu_id = $this->factory->term->create( $orig_args );
+		$this->menu_id = self::factory()->term->create( $orig_args );
 
 		register_meta(
 			'term',
@@ -133,7 +133,7 @@ class Tests_REST_WpRestMenusController extends WP_Test_REST_Controller_Testcase
 		$this->assertSameSets( array( 'view', 'embed', 'edit' ), $data['endpoints'][0]['args']['context']['enum'] );
 		$this->assertSame( array( 'v1' => true ), $data['endpoints'][0]['allow_batch'] );
 		// Single.
-		$tag1     = $this->factory->tag->create( array( 'name' => 'Season 5' ) );
+		$tag1     = self::factory()->tag->create( array( 'name' => 'Season 5' ) );
 		$request  = new WP_REST_Request( 'OPTIONS', '/wp/v2/menus/' . $tag1 );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
diff --git a/tests/rest-api/wpRestTemplatesController.php b/tests/rest-api/wpRestTemplatesController.php
index 36f59374d6..c53701f9b6 100644
--- a/tests/rest-api/wpRestTemplatesController.php
+++ b/tests/rest-api/wpRestTemplatesController.php
@@ -53,10 +53,22 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		wp_delete_post( self::$post->ID );
 	}
 
+	/**
+	 * @covers WP_REST_Templates_Controller::register_routes
+	 * @ticket 54596
+	 */
 	public function test_register_routes() {
 		$routes = rest_get_server()->get_routes();
-		$this->assertArrayHasKey( '/wp/v2/templates', $routes );
-		$this->assertArrayHasKey( '/wp/v2/templates/(?P<id>[\/\w-]+)', $routes );
+		$this->assertArrayHasKey(
+			'/wp/v2/templates',
+			$routes,
+			'Templates route does not exist'
+		);
+		$this->assertArrayHasKey(
+			'/wp/v2/templates/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w-]+)',
+			$routes,
+			'Single template based on the given ID route does not exist'
+		);
 	}
 
 	/**
@@ -196,6 +208,129 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 	}
 
+	/**
+	 * @dataProvider data_get_item_with_valid_theme_dirname
+	 * @covers WP_REST_Templates_Controller::get_item
+	 * @ticket 54596
+	 *
+	 * @param string $theme_dir Theme directory to test.
+	 * @param string $template  Template to test.
+	 * @param array  $args      Arguments to create the 'wp_template" post.
+	 */
+	public function test_get_item_with_valid_theme_dirname( $theme_dir, $template, array $args ) {
+		wp_set_current_user( self::$admin_id );
+		switch_theme( $theme_dir );
+
+		// Set up template post.
+		$args['post_type'] = 'wp_template';
+		$args['tax_input'] = array(
+			'wp_theme' => array(
+				get_stylesheet(),
+			),
+		);
+		$post              = self::factory()->post->create_and_get( $args );
+		wp_set_post_terms( $post->ID, get_stylesheet(), 'wp_theme' );
+
+		$request  = new WP_REST_Request( 'GET', "/wp/v2/templates/{$theme_dir}//{$template}" );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+		unset( $data['content'] );
+		unset( $data['_links'] );
+
+		$this->assertSameSetsWithIndex(
+			array(
+				'id'             => "{$theme_dir}//{$template}",
+				'theme'          => $theme_dir,
+				'slug'           => $template,
+				'source'         => 'custom',
+				'origin'         => null,
+				'type'           => 'wp_template',
+				'description'    => $args['post_excerpt'],
+				'title'          => array(
+					'raw'      => $args['post_title'],
+					'rendered' => $args['post_title'],
+				),
+				'status'         => 'publish',
+				'wp_id'          => $post->ID,
+				'has_theme_file' => false,
+				'is_custom'      => true,
+				'author'         => self::$admin_id,
+			),
+			$data
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_item_with_valid_theme_dirname() {
+		$theme_root_dir = DIR_TESTDATA . '/themedir1/';
+		return array(
+			'template parts: parent theme'                => array(
+				'theme_dir' => 'themedir1/block-theme',
+				'template'  => 'small-header',
+				'args'      => array(
+					'post_name'    => 'small-header',
+					'post_title'   => 'Small Header Template',
+					'post_content' => file_get_contents( $theme_root_dir . '/block-theme/parts/small-header.html' ),
+					'post_excerpt' => 'Description of small header template.',
+				),
+			),
+			'template: parent theme'                      => array(
+				'theme_dir' => 'themedir1/block-theme',
+				'template'  => 'page-home',
+				'args'      => array(
+					'post_name'    => 'page-home',
+					'post_title'   => 'Home Page Template',
+					'post_content' => file_get_contents( $theme_root_dir . 'block-theme/templates/page-home.html' ),
+					'post_excerpt' => 'Description of page home template.',
+				),
+			),
+			'template: parent theme deprecated path'      => array(
+				'theme_dir' => 'themedir1/block-theme-deprecated-path',
+				'template'  => 'page-home',
+				'args'      => array(
+					'post_name'    => 'page-home',
+					'post_title'   => 'Home Page Template',
+					'post_content' => file_get_contents( $theme_root_dir . 'block-theme-deprecated-path/block-templates/page-home.html' ),
+					'post_excerpt' => 'Description of page home template.',
+				),
+			),
+			'template: child theme'                       => array(
+				'theme_dir' => 'themedir1/block-theme-child',
+				'template'  => 'page-1',
+				'args'      => array(
+					'post_name'    => 'page-1',
+					'post_title'   => 'Page 1 Template',
+					'post_content' => file_get_contents( $theme_root_dir . 'block-theme-child/templates/page-1.html' ),
+					'post_excerpt' => 'Description of page 1 template.',
+				),
+			),
+			'template part: subdir with _-[]. characters' => array(
+				'theme_dir' => 'themedir1/block_theme-[0.4.0]',
+				'template'  => 'large-header',
+				'args'      => array(
+					'post_name'    => 'large-header',
+					'post_title'   => 'Large Header Template Part',
+					'post_content' => file_get_contents( $theme_root_dir . 'block_theme-[0.4.0]/parts/large-header.html' ),
+					'post_excerpt' => 'Description of large header template.',
+				),
+			),
+			'template: subdir with _-[]. characters'      => array(
+				'theme_dir' => 'themedir1/block_theme-[0.4.0]',
+				'template'  => 'page-large-header',
+				'args'      => array(
+					'post_name'    => 'page-large-header',
+					'post_title'   => 'Page Large Template',
+					'post_content' => file_get_contents( $theme_root_dir . 'block_theme-[0.4.0]/templates/page-large-header.html' ),
+					'post_excerpt' => 'Description of page large template.',
+				),
+			),
+		);
+	}
+
 	/**
 	 * @ticket 54507
 	 * @dataProvider get_template_ids_to_sanitize
@@ -264,6 +399,52 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 	}
 
+	/**
+	 * @ticket 54680
+	 * @covers WP_REST_Templates_Controller::create_item
+	 * @covers WP_REST_Templates_Controller::get_item_schema
+	 */
+	public function test_create_item_with_numeric_slug() {
+		wp_set_current_user( self::$admin_id );
+		$request = new WP_REST_Request( 'POST', '/wp/v2/templates' );
+		$request->set_body_params(
+			array(
+				'slug'        => '404',
+				'description' => 'Template shown when no content is found.',
+				'title'       => '404',
+				'author'      => self::$admin_id,
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+		unset( $data['_links'] );
+		unset( $data['wp_id'] );
+
+		$this->assertSame(
+			array(
+				'id'             => 'default//404',
+				'theme'          => 'default',
+				'content'        => array(
+					'raw' => '',
+				),
+				'slug'           => '404',
+				'source'         => 'custom',
+				'origin'         => null,
+				'type'           => 'wp_template',
+				'description'    => 'Template shown when no content is found.',
+				'title'          => array(
+					'raw'      => '404',
+					'rendered' => '404',
+				),
+				'status'         => 'publish',
+				'has_theme_file' => false,
+				'is_custom'      => false,
+				'author'         => self::$admin_id,
+			),
+			$data
+		);
+	}
+
 	/**
 	 * @ticket 54422
 	 * @covers WP_REST_Templates_Controller::create_item
@@ -433,8 +614,11 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		$this->assertErrorResponse( 'rest_template_not_found', $response, 404 );
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_prepare_item() {
-		// TODO: Implement test_prepare_item() method.
+		// Controller does not implement prepare_item().
 	}
 
 	public function test_prepare_item_limit_fields() {
diff --git a/tests/rest-api/wpRestUrlDetailsController.php b/tests/rest-api/wpRestUrlDetailsController.php
index 642e51235d..6e2dc1f1f6 100644
--- a/tests/rest-api/wpRestUrlDetailsController.php
+++ b/tests/rest-api/wpRestUrlDetailsController.php
@@ -102,7 +102,7 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 	}
 
 	/**
-	 * @covers WP_REST_URL_Details_Controller::get_routes
+	 * @covers WP_REST_URL_Details_Controller::register_routes
 	 *
 	 * @ticket 54358
 	 */
@@ -1048,28 +1048,46 @@ class Tests_REST_WpRestUrlDetailsController extends WP_Test_REST_Controller_Test
 		);
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_context_param() {
-		$this->markTestSkipped( 'Controller does not use context_param.' );
+		// Controller does not use get_context_param().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_get_item() {
-		$this->markTestSkipped( 'Controller does not have get_item route.' );
+		// Controller does not implement get_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_create_item() {
-		$this->markTestSkipped( 'Controller does not have create_item route.' );
+		// Controller does not implement create_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_update_item() {
-		$this->markTestSkipped( 'Controller does not have update_item route.' );
+		// Controller does not implement update_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_delete_item() {
-		$this->markTestSkipped( 'Controller does not have delete_item route.' );
+		// Controller does not implement delete_item().
 	}
 
+	/**
+	 * @doesNotPerformAssertions
+	 */
 	public function test_prepare_item() {
-		$this->markTestSkipped( 'Controller does not have prepare_item route.' );
+		// Controller does not implement prepare_item().
 	}
 
 	/**
diff --git a/tests/rewrite.php b/tests/rewrite.php
index 62697800cc..bee61dc66c 100644
--- a/tests/rewrite.php
+++ b/tests/rewrite.php
@@ -8,6 +8,15 @@
 class Tests_Rewrite extends WP_UnitTestCase {
 	private $home_url;
 
+	/**
+	 * Temporary storage for blog id for use with filters.
+	 *
+	 * Used in the `test_url_to_postid_of_http_site_when_current_site_uses_https()` method.
+	 *
+	 * @var int
+	 */
+	private $blog_id_35531;
+
 	public function set_up() {
 		parent::set_up();
 
@@ -22,6 +31,7 @@ class Tests_Rewrite extends WP_UnitTestCase {
 		$wp_rewrite->init();
 
 		update_option( 'home', $this->home_url );
+		unset( $this->blog_id_35531 );
 		parent::tear_down();
 	}
 
@@ -173,7 +183,7 @@ class Tests_Rewrite extends WP_UnitTestCase {
 	public function test_url_to_postid_custom_post_type() {
 		delete_option( 'rewrite_rules' );
 
-		$post_type = rand_str( 12 );
+		$post_type = 'url_to_postid';
 		register_post_type( $post_type, array( 'public' => true ) );
 
 		$id = self::factory()->post->create( array( 'post_type' => $post_type ) );
diff --git a/tests/rewrite/numericSlugs.php b/tests/rewrite/numericSlugs.php
index e11c6b2a46..c174ce4875 100644
--- a/tests/rewrite/numericSlugs.php
+++ b/tests/rewrite/numericSlugs.php
@@ -6,6 +6,7 @@
  */
 class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 	private $old_current_user;
+	private $author_id;
 
 	public function set_up() {
 		parent::set_up();
@@ -23,7 +24,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '2015',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -53,7 +54,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '2015',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -80,7 +81,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '2015',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -98,7 +99,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '2015',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -114,7 +115,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '02',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -133,7 +134,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '02',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -150,7 +151,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '2',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -169,7 +170,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '2',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -186,7 +187,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '02',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -204,7 +205,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '02',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -220,7 +221,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '2',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -238,7 +239,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '2',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -254,7 +255,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '01',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -273,7 +274,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '',
 				'post_name'    => '01',
 				'post_date'    => '2015-02-01 01:00:00',
@@ -290,7 +291,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '01',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -308,7 +309,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '01',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
@@ -324,7 +325,7 @@ class Tests_Rewrite_NumericSlugs extends WP_UnitTestCase {
 			array(
 				'post_author'  => $this->author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
+				'post_content' => 'content',
 				'post_title'   => '01',
 				'post_date'    => '2015-02-01 01:00:00',
 			)
diff --git a/tests/rewrite/oldDateRedirect.php b/tests/rewrite/oldDateRedirect.php
index 7f4519875d..963f103a4f 100644
--- a/tests/rewrite/oldDateRedirect.php
+++ b/tests/rewrite/oldDateRedirect.php
@@ -2,6 +2,7 @@
 
 /**
  * @group rewrite
+ * @covers wp_old_slug_redirect
  */
 class Tests_Rewrite_OldDateRedirect extends WP_UnitTestCase {
 	protected $old_date_redirect_url;
@@ -86,6 +87,75 @@ class Tests_Rewrite_OldDateRedirect extends WP_UnitTestCase {
 		$this->assertSame( $permalink, $this->old_date_redirect_url );
 	}
 
+	/**
+	 * @ticket 36723
+	 */
+	public function test_old_date_slug_redirect_cache() {
+		$old_permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$time = '2004-01-03 00:00:00';
+		wp_update_post(
+			array(
+				'ID'            => self::$post_id,
+				'post_date'     => $time,
+				'post_date_gmt' => get_gmt_from_date( $time ),
+				'post_name'     => 'bar-baz',
+			)
+		);
+
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$this->go_to( $old_permalink );
+
+		wp_old_slug_redirect();
+		$num_queries = get_num_queries();
+		$this->assertSame( $permalink, $this->old_date_redirect_url );
+
+		wp_old_slug_redirect();
+		$this->assertSame( $permalink, $this->old_date_redirect_url );
+		$this->assertSame( $num_queries, get_num_queries() );
+	}
+
+	/**
+	 * @ticket 36723
+	 */
+	public function test_old_date_redirect_cache_invalidation() {
+		$old_permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$time = '2004-01-03 00:00:00';
+		wp_update_post(
+			array(
+				'ID'            => self::$post_id,
+				'post_date'     => $time,
+				'post_date_gmt' => get_gmt_from_date( $time ),
+				'post_name'     => 'bar-baz',
+			)
+		);
+
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$this->go_to( $old_permalink );
+		wp_old_slug_redirect();
+		$this->assertSame( $permalink, $this->old_date_redirect_url );
+
+		$time = '2014-02-01 00:00:00';
+		wp_update_post(
+			array(
+				'ID'            => self::$post_id,
+				'post_date'     => $time,
+				'post_date_gmt' => get_gmt_from_date( $time ),
+				'post_name'     => 'foo-bar-baz',
+			)
+		);
+
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$num_queries = get_num_queries();
+		wp_old_slug_redirect();
+		$this->assertSame( $permalink, $this->old_date_redirect_url );
+		$this->assertGreaterThan( $num_queries, get_num_queries() );
+	}
+
 	public function test_old_date_redirect_attachment() {
 		$old_permalink = get_attachment_link( self::$attachment_id );
 
diff --git a/tests/rewrite/oldSlugRedirect.php b/tests/rewrite/oldSlugRedirect.php
index 2083f9bcce..cf38ba452e 100644
--- a/tests/rewrite/oldSlugRedirect.php
+++ b/tests/rewrite/oldSlugRedirect.php
@@ -3,21 +3,24 @@
 /**
  * @group rewrite
  * @ticket 33920
+ * @covers wp_old_slug_redirect
  */
 class Tests_Rewrite_OldSlugRedirect extends WP_UnitTestCase {
 	protected $old_slug_redirect_url;
 
-	protected $post_id;
+	protected static $post_id;
 
-	public function set_up() {
-		parent::set_up();
-
-		$this->post_id = self::factory()->post->create(
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$post_id = $factory->post->create(
 			array(
 				'post_title' => 'Foo Bar',
 				'post_name'  => 'foo-bar',
 			)
 		);
+	}
+
+	public function set_up() {
+		parent::set_up();
 
 		add_filter( 'old_slug_redirect_url', array( $this, 'filter_old_slug_redirect_url' ), 10, 1 );
 
@@ -36,27 +39,88 @@ class Tests_Rewrite_OldSlugRedirect extends WP_UnitTestCase {
 	}
 
 	public function test_old_slug_redirect() {
-		$old_permalink = user_trailingslashit( get_permalink( $this->post_id ) );
+		$old_permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		wp_update_post(
+			array(
+				'ID'        => self::$post_id,
+				'post_name' => 'bar-baz',
+			)
+		);
+
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$this->go_to( $old_permalink );
+		wp_old_slug_redirect();
+		$this->assertSame( $permalink, $this->old_slug_redirect_url );
+	}
+
+	/**
+	 * @ticket 36723
+	 */
+	public function test_old_slug_redirect_cache() {
+		$old_permalink = user_trailingslashit( get_permalink( self::$post_id ) );
 
 		wp_update_post(
 			array(
-				'ID'        => $this->post_id,
+				'ID'        => self::$post_id,
 				'post_name' => 'bar-baz',
 			)
 		);
 
-		$permalink = user_trailingslashit( get_permalink( $this->post_id ) );
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
 
 		$this->go_to( $old_permalink );
+
+		wp_old_slug_redirect();
+		$num_queries = get_num_queries();
+		$this->assertSame( $permalink, $this->old_slug_redirect_url );
+
+		wp_old_slug_redirect();
+		$this->assertSame( $permalink, $this->old_slug_redirect_url );
+		$this->assertSame( $num_queries, get_num_queries() );
+	}
+
+	/**
+	 * @ticket 36723
+	 */
+	public function test_old_slug_redirect_cache_invalidation() {
+		$old_permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		wp_update_post(
+			array(
+				'ID'        => self::$post_id,
+				'post_name' => 'bar-baz',
+			)
+		);
+
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$this->go_to( $old_permalink );
+
+		wp_old_slug_redirect();
+		$this->assertSame( $permalink, $this->old_slug_redirect_url );
+
+		wp_update_post(
+			array(
+				'ID'        => self::$post_id,
+				'post_name' => 'foo-bar-baz',
+			)
+		);
+
+		$permalink = user_trailingslashit( get_permalink( self::$post_id ) );
+
+		$num_queries = get_num_queries();
 		wp_old_slug_redirect();
 		$this->assertSame( $permalink, $this->old_slug_redirect_url );
+		$this->assertSame( $num_queries + 1, get_num_queries() );
 	}
 
 	public function test_old_slug_redirect_attachment() {
 		$file          = DIR_TESTDATA . '/images/canola.jpg';
 		$attachment_id = self::factory()->attachment->create_object(
 			$file,
-			$this->post_id,
+			self::$post_id,
 			array(
 				'post_mime_type' => 'image/jpeg',
 				'post_name'      => 'my-attachment',
@@ -67,7 +131,7 @@ class Tests_Rewrite_OldSlugRedirect extends WP_UnitTestCase {
 
 		wp_update_post(
 			array(
-				'ID'        => $this->post_id,
+				'ID'        => self::$post_id,
 				'post_name' => 'bar-baz',
 			)
 		);
@@ -86,7 +150,7 @@ class Tests_Rewrite_OldSlugRedirect extends WP_UnitTestCase {
 			)
 		);
 
-		$permalink = user_trailingslashit( trailingslashit( get_permalink( $this->post_id ) ) . 'the-attachment' );
+		$permalink = user_trailingslashit( trailingslashit( get_permalink( self::$post_id ) ) . 'the-attachment' );
 
 		$this->go_to( $old_permalink );
 		wp_old_slug_redirect();
@@ -96,21 +160,21 @@ class Tests_Rewrite_OldSlugRedirect extends WP_UnitTestCase {
 	public function test_old_slug_redirect_paged() {
 		wp_update_post(
 			array(
-				'ID'           => $this->post_id,
+				'ID'           => self::$post_id,
 				'post_content' => 'Test<!--nextpage-->Test',
 			)
 		);
 
-		$old_permalink = user_trailingslashit( trailingslashit( get_permalink( $this->post_id ) ) . 'page/2' );
+		$old_permalink = user_trailingslashit( trailingslashit( get_permalink( self::$post_id ) ) . 'page/2' );
 
 		wp_update_post(
 			array(
-				'ID'        => $this->post_id,
+				'ID'        => self::$post_id,
 				'post_name' => 'bar-baz',
 			)
 		);
 
-		$permalink = user_trailingslashit( trailingslashit( get_permalink( $this->post_id ) ) . 'page/2' );
+		$permalink = user_trailingslashit( trailingslashit( get_permalink( self::$post_id ) ) . 'page/2' );
 
 		$this->go_to( $old_permalink );
 		wp_old_slug_redirect();
@@ -121,11 +185,11 @@ class Tests_Rewrite_OldSlugRedirect extends WP_UnitTestCase {
 	 * @ticket 35031
 	 */
 	public function test_old_slug_doesnt_redirect_when_reused() {
-		$old_permalink = user_trailingslashit( get_permalink( $this->post_id ) );
+		$old_permalink = user_trailingslashit( get_permalink( self::$post_id ) );
 
 		wp_update_post(
 			array(
-				'ID'        => $this->post_id,
+				'ID'        => self::$post_id,
 				'post_name' => 'bar-baz',
 			)
 		);
diff --git a/tests/rewrite/wpResolveNumericSlugConflicts.php b/tests/rewrite/wpResolveNumericSlugConflicts.php
new file mode 100644
index 0000000000..7a5232bc86
--- /dev/null
+++ b/tests/rewrite/wpResolveNumericSlugConflicts.php
@@ -0,0 +1,71 @@
+<?php
+
+/**
+ * @group rewrite
+ * @covers ::wp_resolve_numeric_slug_conflicts
+ */
+class Tests_Rewrite_wpResolveNumericSlugConflicts extends WP_UnitTestCase {
+
+	/**
+	 * Fixed date post ID.
+	 *
+	 * @var int
+	 */
+	public static $post_with_date;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$post_with_date = $factory->post->create(
+			array(
+				'post_date' => '2020-01-05 12:00:00',
+				'post_name' => 'post-with-date',
+			)
+		);
+	}
+
+	/**
+	 * @ticket 52252
+	 * @dataProvider data_should_not_throw_warning_for_malformed_date_queries
+	 *
+	 * @param string $permalink_structure Permalink structure.
+	 * @param array  $query_vars          Query string parameters.
+	 */
+	public function test_should_not_throw_warning_for_malformed_date_queries( $permalink_structure, $query_vars ) {
+		$this->set_permalink_structure( $permalink_structure );
+
+		/*
+		 * For malformed date queries, the function is unable to identify the requested post,
+		 * and just returns the initial query vars.
+		 */
+		$this->assertSame( $query_vars, wp_resolve_numeric_slug_conflicts( $query_vars ) );
+	}
+
+	/**
+	 * Data provider for test_should_not_throw_warning_for_malformed_date_queries().
+	 *
+	 * @return array Test data.
+	 */
+	public function data_should_not_throw_warning_for_malformed_date_queries() {
+		return array(
+			'/%postname%/ with missing year'         => array(
+				'permalink_structure' => '/%postname%/',
+				'query'               => array(
+					'monthnum' => 1,
+					'day'      => 15,
+				),
+			),
+			'/%postname%/ with month only'           => array(
+				'permalink_structure' => '/%postname%/',
+				'query'               => array(
+					'monthnum' => 1,
+				),
+			),
+			'/%year%/%postname%/ with missing month' => array(
+				'permalink_structure' => '/%year%/%postname%/',
+				'query'               => array(
+					'year' => 2020,
+					'day'  => 15,
+				),
+			),
+		);
+	}
+}
diff --git a/tests/shortcode.php b/tests/shortcode.php
index ce0b3f858d..7ee36d7cbc 100644
--- a/tests/shortcode.php
+++ b/tests/shortcode.php
@@ -6,6 +6,14 @@ class Tests_Shortcode extends WP_UnitTestCase {
 
 	protected $shortcodes = array( 'test-shortcode-tag', 'footag', 'bartag', 'baztag', 'dumptag', 'hyphen', 'hyphen-foo', 'hyphen-foo-bar', 'url', 'img' );
 
+	private $atts    = null;
+	private $content = null;
+	private $tagname = null;
+
+	private $filter_atts_out   = null;
+	private $filter_atts_pairs = null;
+	private $filter_atts_atts  = null;
+
 	public function set_up() {
 		parent::set_up();
 
@@ -13,10 +21,12 @@ class Tests_Shortcode extends WP_UnitTestCase {
 			add_shortcode( $shortcode, array( $this, 'shortcode_' . str_replace( '-', '_', $shortcode ) ) );
 		}
 
-		$this->atts    = null;
-		$this->content = null;
-		$this->tagname = null;
-
+		$this->atts              = null;
+		$this->content           = null;
+		$this->tagname           = null;
+		$this->filter_atts_out   = null;
+		$this->filter_atts_pairs = null;
+		$this->filter_atts_atts  = null;
 	}
 
 	public function tear_down() {
diff --git a/tests/site-health.php b/tests/site-health.php
deleted file mode 100644
index 956160361a..0000000000
--- a/tests/site-health.php
+++ /dev/null
@@ -1,110 +0,0 @@
-<?php
-
-/**
- * @group site-health
- */
-class Tests_Site_Health extends WP_UnitTestCase {
-	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
-		// Include the `WP_Site_Health` file.
-		require_once ABSPATH . 'wp-admin/includes/class-wp-site-health.php';
-	}
-
-	/**
-	 * Ensure Site Health reports correctly cron job reports.
-	 *
-	 * @ticket 47223
-	 */
-	public function test_cron_health_checks_critical() {
-		$wp_site_health = new WP_Site_Health();
-
-		// Clear the cron array.
-		_set_cron_array( array() );
-
-		$cron_health = $wp_site_health->get_test_scheduled_events();
-
-		$this->assertSame( 'critical', $cron_health['status'] );
-		$this->assertSame( __( 'It was not possible to check your scheduled events' ), $cron_health['label'] );
-		$this->assertWPError( $wp_site_health->has_late_cron() );
-		$this->assertWPError( $wp_site_health->has_missed_cron() );
-	}
-
-	/**
-	 * Ensure Site Health reports correctly cron job reports.
-	 *
-	 * @dataProvider data_cron_health_checks
-	 * @ticket 47223
-	 */
-	public function test_cron_health_checks( $times, $expected_status, $expected_label, $expected_late, $expected_missed ) {
-		$wp_site_health = new WP_Site_Health();
-
-		/*
-		 * Clear the cron array.
-		 *
-		 * The core jobs may register as late/missed in the test suite as they
-		 * are not run. Clearing the array ensures the site health tests are only
-		 * reported based on the jobs set in the test.
-		 */
-		_set_cron_array( array() );
-		$times = (array) $times;
-		foreach ( $times as $job => $time ) {
-			$timestamp = strtotime( $time );
-			wp_schedule_event( $timestamp, 'daily', __FUNCTION__ . "_{$job}" );
-		}
-
-		$cron_health = $wp_site_health->get_test_scheduled_events();
-
-		$this->assertSame( $expected_status, $cron_health['status'] );
-		$this->assertSame( $expected_label, $cron_health['label'] );
-		$this->assertSame( $expected_late, $wp_site_health->has_late_cron() );
-		$this->assertSame( $expected_missed, $wp_site_health->has_missed_cron() );
-	}
-
-	/**
-	 * Data provider for Site Health cron reports.
-	 *
-	 * The test suite runs with `DISABLE_WP_CRON === true` so the
-	 * missed and late tests need to account for the extended periods
-	 * allowed for with this flag enabled.
-	 *
-	 * 1. string|array Times to schedule (run through strtotime())
-	 * 2. string       Expected status
-	 * 3. string       Expected label
-	 * 4. bool         Expected outcome has_late_cron()
-	 * 5. bool         Expected outcome has_missed_cron()
-	 */
-	public function data_cron_health_checks() {
-		return array(
-			array(
-				'+5 minutes',
-				'good',
-				__( 'Scheduled events are running' ),
-				false,
-				false,
-			),
-			array(
-				'-50 minutes',
-				'recommended',
-				__( 'A scheduled event is late' ),
-				true,
-				false,
-			),
-			array(
-				'-500 minutes',
-				'recommended',
-				__( 'A scheduled event has failed' ),
-				false,
-				true,
-			),
-			array(
-				array(
-					'-50 minutes',
-					'-500 minutes',
-				),
-				'recommended',
-				__( 'A scheduled event has failed' ),
-				true,
-				true,
-			),
-		);
-	}
-}
diff --git a/tests/sitemaps/wpSitemapsPosts.php b/tests/sitemaps/wpSitemapsPosts.php
index b60903e18a..2bdeb92e8e 100644
--- a/tests/sitemaps/wpSitemapsPosts.php
+++ b/tests/sitemaps/wpSitemapsPosts.php
@@ -29,7 +29,7 @@ class Tests_Sitemaps_wpSitemapsPosts extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test ability to filter object subtypes.
+	 * Tests ability to filter object subtypes.
 	 */
 	public function test_filter_sitemaps_post_types() {
 		$posts_provider = new WP_Sitemaps_Posts();
@@ -42,7 +42,7 @@ class Tests_Sitemaps_wpSitemapsPosts extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test `wp_sitemaps_posts_show_on_front_entry` filter.
+	 * Tests `wp_sitemaps_posts_show_on_front_entry` filter.
 	 */
 	public function test_posts_show_on_front_entry() {
 		$posts_provider = new WP_Sitemaps_Posts();
@@ -70,4 +70,33 @@ class Tests_Sitemaps_wpSitemapsPosts extends WP_UnitTestCase {
 
 		return $sitemap_entry;
 	}
+
+	/**
+	 * Tests that sticky posts are not moved to the front of the first page of the post sitemap.
+	 *
+	 * @ticket 55633
+	 */
+	public function test_posts_sticky_posts_not_moved_to_front() {
+		$factory = self::factory();
+
+		// Create 4 posts, and stick the last one.
+		$post_ids     = $factory->post->create_many( 4 );
+		$last_post_id = end( $post_ids );
+		stick_post( $last_post_id );
+
+		$posts_provider = new WP_Sitemaps_Posts();
+
+		$url_list = $posts_provider->get_url_list( 1, 'post' );
+
+		$this->assertCount( count( $post_ids ), $url_list, 'The post count did not match.' );
+
+		$expected = array();
+
+		foreach ( $post_ids as $post_id ) {
+			$expected[] = array( 'loc' => home_url( "?p={$post_id}" ) );
+		}
+
+		// Check that the URL list is still in the order of the post IDs (i.e., sticky post wasn't moved to the front).
+		$this->assertSame( $expected, $url_list, 'The post order did not match.' );
+	}
 }
diff --git a/tests/sitemaps/wpSitemapsRegistry.php b/tests/sitemaps/wpSitemapsRegistry.php
index 8032a38dcc..51d9c19d6c 100644
--- a/tests/sitemaps/wpSitemapsRegistry.php
+++ b/tests/sitemaps/wpSitemapsRegistry.php
@@ -31,4 +31,40 @@ class Tests_Sitemaps_wpSitemapsRegistry extends WP_UnitTestCase {
 		$this->assertCount( 1, $providers );
 		$this->assertSame( $providers['foo'], $provider1, 'Can not confirm sitemap registration is working.' );
 	}
+
+	/**
+	 * Tests that `WP_Sitemaps_Registry::get_provider()` returns `null` when
+	 * the `$name` argument is not a string.
+	 *
+	 * @ticket 56336
+	 *
+	 * @covers WP_Sitemaps_Registry::get_provider
+	 *
+	 * @dataProvider data_get_provider_should_return_null_with_non_string_name
+	 *
+	 * @param mixed $name The non-string name.
+	 */
+	public function test_get_provider_should_return_null_with_non_string_name( $name ) {
+		$registry = new WP_Sitemaps_Registry();
+		$this->assertNull( $registry->get_provider( $name ) );
+	}
+
+	/**
+	 * Data provider with non-string values.
+	 *
+	 * @return array
+	 */
+	public function data_get_provider_should_return_null_with_non_string_name() {
+		return array(
+			'array'        => array( array() ),
+			'object'       => array( new stdClass() ),
+			'bool (true)'  => array( true ),
+			'bool (false)' => array( false ),
+			'null'         => array( null ),
+			'integer (0)'  => array( 0 ),
+			'integer (1)'  => array( 1 ),
+			'float (0.0)'  => array( 0.0 ),
+			'float (1.1)'  => array( 1.1 ),
+		);
+	}
 }
diff --git a/tests/style-engine/styleEngine.php b/tests/style-engine/styleEngine.php
new file mode 100644
index 0000000000..7095140a43
--- /dev/null
+++ b/tests/style-engine/styleEngine.php
@@ -0,0 +1,670 @@
+<?php
+/**
+ * Tests the Style Engine global functions that interact with the WP_Style_Engine class.
+ *
+ * @package WordPress
+ * @subpackage StyleEngine
+ * @since 6.1.0
+ *
+ * @group style-engine
+ */
+
+/**
+ * Tests for registering, storing and generating styles.
+ */
+class Tests_wpStyleEngine extends WP_UnitTestCase {
+	/**
+	 * Cleans up stores after each test.
+	 */
+	public function tear_down() {
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests generating block styles and classnames based on various manifestations of the $block_styles argument.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_style_engine_get_styles
+	 *
+	 * @dataProvider data_wp_style_engine_get_styles
+	 *
+	 * @param array  $block_styles    The incoming block styles object.
+	 * @param array  $options         {
+	 *     An array of options to pass to `wp_style_engine_get_styles()`.
+	 *
+	 *     @type string|null $context                    An identifier describing the origin of the style object, e.g., 'block-supports' or 'global-styles'. Default is `null`.
+	 *                                                   When set, the style engine will attempt to store the CSS rules, where a selector is also passed.
+	 *     @type bool        $convert_vars_to_classnames Whether to skip converting incoming CSS var patterns, e.g., `var:preset|<PRESET_TYPE>|<PRESET_SLUG>`, to var( --wp--preset--* ) values. Default `false`.
+	 *     @type string      $selector                   Optional. When a selector is passed, the value of `$css` in the return value will comprise a full CSS rule `$selector { ...$css_declarations }`,
+	 *                                                   otherwise, the value will be a concatenated string of CSS declarations.
+	 * }
+	 * @param string $expected_output The expected output.
+	 */
+	public function test_wp_style_engine_get_styles( $block_styles, $options, $expected_output ) {
+		$generated_styles = wp_style_engine_get_styles( $block_styles, $options );
+
+		$this->assertSame( $expected_output, $generated_styles );
+	}
+
+	/**
+	 * Data provider for test_wp_style_engine_get_styles().
+	 *
+	 * @return array
+	 */
+	public function data_wp_style_engine_get_styles() {
+		return array(
+			'default_return_value'                         => array(
+				'block_styles'    => array(),
+				'options'         => null,
+				'expected_output' => array(),
+			),
+
+			'inline_invalid_block_styles_empty'            => array(
+				'block_styles'    => 'hello world!',
+				'options'         => null,
+				'expected_output' => array(),
+			),
+
+			'inline_invalid_block_styles_unknown_style'    => array(
+				'block_styles'    => array(
+					'pageBreakAfter' => 'verso',
+				),
+				'options'         => null,
+				'expected_output' => array(),
+			),
+
+			'inline_invalid_block_styles_unknown_definition' => array(
+				'block_styles'    => array(
+					'pageBreakAfter' => 'verso',
+				),
+				'options'         => null,
+				'expected_output' => array(),
+			),
+
+			'inline_invalid_block_styles_unknown_property' => array(
+				'block_styles'    => array(
+					'spacing' => array(
+						'gap' => '1000vw',
+					),
+				),
+				'options'         => null,
+				'expected_output' => array(),
+			),
+
+			'valid_inline_css_and_classnames_as_default_context' => array(
+				'block_styles'    => array(
+					'color'   => array(
+						'text' => 'var:preset|color|texas-flood',
+					),
+					'spacing' => array(
+						'margin'  => '111px',
+						'padding' => '0',
+					),
+					'border'  => array(
+						'color' => 'var:preset|color|cool-caramel',
+						'width' => '2rem',
+						'style' => 'dotted',
+					),
+				),
+				'options'         => array( 'convert_vars_to_classnames' => true ),
+				'expected_output' => array(
+					'css'          => 'border-style:dotted;border-width:2rem;padding:0;margin:111px;',
+					'declarations' => array(
+						'border-style' => 'dotted',
+						'border-width' => '2rem',
+						'padding'      => '0',
+						'margin'       => '111px',
+					),
+					'classnames'   => 'has-text-color has-texas-flood-color has-border-color has-cool-caramel-border-color',
+				),
+			),
+
+			'inline_valid_box_model_style'                 => array(
+				'block_styles'    => array(
+					'spacing' => array(
+						'padding' => array(
+							'top'    => '42px',
+							'left'   => '2%',
+							'bottom' => '44px',
+							'right'  => '5rem',
+						),
+						'margin'  => array(
+							'top'    => '12rem',
+							'left'   => '2vh',
+							'bottom' => '2px',
+							'right'  => '10em',
+						),
+					),
+					'border'  => array(
+						'radius' => array(
+							'topLeft'     => '99px',
+							'topRight'    => '98px',
+							'bottomLeft'  => '97px',
+							'bottomRight' => '96px',
+						),
+					),
+				),
+				'options'         => null,
+				'expected_output' => array(
+					'css'          => 'border-top-left-radius:99px;border-top-right-radius:98px;border-bottom-left-radius:97px;border-bottom-right-radius:96px;padding-top:42px;padding-left:2%;padding-bottom:44px;padding-right:5rem;margin-top:12rem;margin-left:2vh;margin-bottom:2px;margin-right:10em;',
+					'declarations' => array(
+						'border-top-left-radius'     => '99px',
+						'border-top-right-radius'    => '98px',
+						'border-bottom-left-radius'  => '97px',
+						'border-bottom-right-radius' => '96px',
+						'padding-top'                => '42px',
+						'padding-left'               => '2%',
+						'padding-bottom'             => '44px',
+						'padding-right'              => '5rem',
+						'margin-top'                 => '12rem',
+						'margin-left'                => '2vh',
+						'margin-bottom'              => '2px',
+						'margin-right'               => '10em',
+					),
+				),
+			),
+
+			'inline_valid_typography_style'                => array(
+				'block_styles'    => array(
+					'typography' => array(
+						'fontSize'       => 'clamp(2em, 2vw, 4em)',
+						'fontFamily'     => 'Roboto,Oxygen-Sans,Ubuntu,sans-serif',
+						'fontStyle'      => 'italic',
+						'fontWeight'     => '800',
+						'lineHeight'     => '1.3',
+						'textDecoration' => 'underline',
+						'textTransform'  => 'uppercase',
+						'letterSpacing'  => '2',
+					),
+				),
+				'options'         => null,
+				'expected_output' => array(
+					'css'          => 'font-size:clamp(2em, 2vw, 4em);font-family:Roboto,Oxygen-Sans,Ubuntu,sans-serif;font-style:italic;font-weight:800;line-height:1.3;text-decoration:underline;text-transform:uppercase;letter-spacing:2;',
+					'declarations' => array(
+						'font-size'       => 'clamp(2em, 2vw, 4em)',
+						'font-family'     => 'Roboto,Oxygen-Sans,Ubuntu,sans-serif',
+						'font-style'      => 'italic',
+						'font-weight'     => '800',
+						'line-height'     => '1.3',
+						'text-decoration' => 'underline',
+						'text-transform'  => 'uppercase',
+						'letter-spacing'  => '2',
+					),
+				),
+			),
+
+			'style_block_with_selector'                    => array(
+				'block_styles'    => array(
+					'spacing' => array(
+						'padding' => array(
+							'top'    => '42px',
+							'left'   => '2%',
+							'bottom' => '44px',
+							'right'  => '5rem',
+						),
+					),
+				),
+				'options'         => array( 'selector' => '.wp-selector > p' ),
+				'expected_output' => array(
+					'css'          => '.wp-selector > p{padding-top:42px;padding-left:2%;padding-bottom:44px;padding-right:5rem;}',
+					'declarations' => array(
+						'padding-top'    => '42px',
+						'padding-left'   => '2%',
+						'padding-bottom' => '44px',
+						'padding-right'  => '5rem',
+					),
+				),
+			),
+
+			'elements_with_css_var_value'                  => array(
+				'block_styles'    => array(
+					'color' => array(
+						'text' => 'var:preset|color|my-little-pony',
+					),
+				),
+				'options'         => array(
+					'selector' => '.wp-selector',
+				),
+				'expected_output' => array(
+					'css'          => '.wp-selector{color:var(--wp--preset--color--my-little-pony);}',
+					'declarations' => array(
+						'color' => 'var(--wp--preset--color--my-little-pony)',
+					),
+					'classnames'   => 'has-text-color has-my-little-pony-color',
+				),
+			),
+
+			'elements_with_invalid_preset_style_property'  => array(
+				'block_styles'    => array(
+					'color' => array(
+						'text' => 'var:preset|invalid_property|my-little-pony',
+					),
+				),
+				'options'         => array( 'selector' => '.wp-selector' ),
+				'expected_output' => array(
+					'classnames' => 'has-text-color',
+				),
+			),
+
+			'valid_classnames_deduped'                     => array(
+				'block_styles'    => array(
+					'color'      => array(
+						'text'       => 'var:preset|color|copper-socks',
+						'background' => 'var:preset|color|splendid-carrot',
+						'gradient'   => 'var:preset|gradient|like-wow-dude',
+					),
+					'typography' => array(
+						'fontSize'   => 'var:preset|font-size|fantastic',
+						'fontFamily' => 'var:preset|font-family|totally-awesome',
+					),
+				),
+				'options'         => array( 'convert_vars_to_classnames' => true ),
+				'expected_output' => array(
+					'classnames' => 'has-text-color has-copper-socks-color has-background has-splendid-carrot-background-color has-like-wow-dude-gradient-background has-fantastic-font-size has-totally-awesome-font-family',
+				),
+			),
+
+			'valid_classnames_and_css_vars'                => array(
+				'block_styles'    => array(
+					'color' => array(
+						'text' => 'var:preset|color|teal-independents',
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'color:var(--wp--preset--color--teal-independents);',
+					'declarations' => array(
+						'color' => 'var(--wp--preset--color--teal-independents)',
+					),
+					'classnames'   => 'has-text-color has-teal-independents-color',
+				),
+			),
+
+			'valid_classnames_with_null_style_values'      => array(
+				'block_styles'    => array(
+					'color' => array(
+						'text'       => '#fff',
+						'background' => null,
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'color:#fff;',
+					'declarations' => array(
+						'color' => '#fff',
+					),
+					'classnames'   => 'has-text-color',
+				),
+			),
+
+			'invalid_classnames_preset_value'              => array(
+				'block_styles'    => array(
+					'color'   => array(
+						'text'       => 'var:cheese|color|fantastic',
+						'background' => 'var:preset|fromage|fantastic',
+					),
+					'spacing' => array(
+						'margin'  => 'var:cheese|spacing|margin',
+						'padding' => 'var:preset|spacing|padding',
+					),
+				),
+				'options'         => array( 'convert_vars_to_classnames' => true ),
+				'expected_output' => array(
+					'classnames' => 'has-text-color has-background',
+				),
+			),
+
+			'valid_spacing_single_preset_values'           => array(
+				'block_styles'    => array(
+					'spacing' => array(
+						'margin'  => 'var:preset|spacing|10',
+						'padding' => 'var:preset|spacing|20',
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'padding:var(--wp--preset--spacing--20);margin:var(--wp--preset--spacing--10);',
+					'declarations' => array(
+						'padding' => 'var(--wp--preset--spacing--20)',
+						'margin'  => 'var(--wp--preset--spacing--10)',
+					),
+				),
+			),
+
+			'valid_spacing_multi_preset_values'            => array(
+				'block_styles'    => array(
+					'spacing' => array(
+						'margin'  => array(
+							'left'   => 'var:preset|spacing|10',
+							'right'  => 'var:preset|spacing|20',
+							'top'    => '1rem',
+							'bottom' => '1rem',
+						),
+						'padding' => array(
+							'left'   => 'var:preset|spacing|30',
+							'right'  => 'var:preset|spacing|40',
+							'top'    => '14px',
+							'bottom' => '14px',
+						),
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'padding-left:var(--wp--preset--spacing--30);padding-right:var(--wp--preset--spacing--40);padding-top:14px;padding-bottom:14px;margin-left:var(--wp--preset--spacing--10);margin-right:var(--wp--preset--spacing--20);margin-top:1rem;margin-bottom:1rem;',
+					'declarations' => array(
+						'padding-left'   => 'var(--wp--preset--spacing--30)',
+						'padding-right'  => 'var(--wp--preset--spacing--40)',
+						'padding-top'    => '14px',
+						'padding-bottom' => '14px',
+						'margin-left'    => 'var(--wp--preset--spacing--10)',
+						'margin-right'   => 'var(--wp--preset--spacing--20)',
+						'margin-top'     => '1rem',
+						'margin-bottom'  => '1rem',
+					),
+				),
+			),
+
+			'invalid_spacing_multi_preset_values'          => array(
+				'block_styles'    => array(
+					'spacing' => array(
+						'margin' => array(
+							'left'   => 'var:preset|spaceman|10',
+							'right'  => 'var:preset|spaceman|20',
+							'top'    => '1rem',
+							'bottom' => '0',
+						),
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'margin-top:1rem;margin-bottom:0;',
+					'declarations' => array(
+						'margin-top'    => '1rem',
+						'margin-bottom' => '0',
+					),
+				),
+			),
+
+			'invalid_classnames_options'                   => array(
+				'block_styles'    => array(
+					'typography' => array(
+						'fontSize'   => array(
+							'tomodachi' => 'friends',
+						),
+						'fontFamily' => array(
+							'oishii' => 'tasty',
+						),
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(),
+			),
+
+			'inline_valid_box_model_style_with_sides'      => array(
+				'block_styles'    => array(
+					'border' => array(
+						'top'    => array(
+							'color' => '#fe1',
+							'width' => '1.5rem',
+							'style' => 'dashed',
+						),
+						'right'  => array(
+							'color' => '#fe2',
+							'width' => '1.4rem',
+							'style' => 'solid',
+						),
+						'bottom' => array(
+							'color' => '#fe3',
+							'width' => '1.3rem',
+						),
+						'left'   => array(
+							'color' => 'var:preset|color|swampy-yellow',
+							'width' => '0.5rem',
+							'style' => 'dotted',
+						),
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'border-top-color:#fe1;border-top-width:1.5rem;border-top-style:dashed;border-right-color:#fe2;border-right-width:1.4rem;border-right-style:solid;border-bottom-color:#fe3;border-bottom-width:1.3rem;border-left-color:var(--wp--preset--color--swampy-yellow);border-left-width:0.5rem;border-left-style:dotted;',
+					'declarations' => array(
+						'border-top-color'    => '#fe1',
+						'border-top-width'    => '1.5rem',
+						'border-top-style'    => 'dashed',
+						'border-right-color'  => '#fe2',
+						'border-right-width'  => '1.4rem',
+						'border-right-style'  => 'solid',
+						'border-bottom-color' => '#fe3',
+						'border-bottom-width' => '1.3rem',
+						'border-left-color'   => 'var(--wp--preset--color--swampy-yellow)',
+						'border-left-width'   => '0.5rem',
+						'border-left-style'   => 'dotted',
+					),
+				),
+			),
+
+			'inline_invalid_box_model_style_with_sides'    => array(
+				'block_styles'    => array(
+					'border' => array(
+						'top'    => array(
+							'top'    => '#fe1',
+							'right'  => '1.5rem',
+							'cheese' => 'dashed',
+						),
+						'right'  => array(
+							'right' => '#fe2',
+							'top'   => '1.4rem',
+							'bacon' => 'solid',
+						),
+						'bottom' => array(
+							'color'  => 'var:preset|color|terrible-lizard',
+							'bottom' => '1.3rem',
+						),
+						'left'   => array(
+							'left'  => null,
+							'width' => null,
+							'top'   => 'dotted',
+						),
+					),
+				),
+				'options'         => array(),
+				'expected_output' => array(
+					'css'          => 'border-bottom-color:var(--wp--preset--color--terrible-lizard);',
+					'declarations' => array(
+						'border-bottom-color' => 'var(--wp--preset--color--terrible-lizard)',
+					),
+				),
+			),
+		);
+	}
+
+	/**
+	 * Tests adding rules to a store and retrieving a generated stylesheet.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_style_engine_get_styles
+	 */
+	public function test_should_store_block_styles_using_context() {
+		$block_styles = array(
+			'spacing' => array(
+				'padding' => array(
+					'top'    => '42px',
+					'left'   => '2%',
+					'bottom' => '44px',
+					'right'  => '5rem',
+				),
+			),
+		);
+
+		$generated_styles = wp_style_engine_get_styles(
+			$block_styles,
+			array(
+				'context'  => 'block-supports',
+				'selector' => 'article',
+			)
+		);
+		$store            = WP_Style_Engine::get_store( 'block-supports' );
+		$rule             = $store->get_all_rules()['article'];
+
+		$this->assertSame( $generated_styles['css'], $rule->get_css() );
+	}
+
+	/**
+	 * Tests that passing no context does not store styles.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_style_engine_get_styles
+	 */
+	public function test_should_not_store_block_styles_without_context() {
+		$block_styles = array(
+			'typography' => array(
+				'fontSize' => '999px',
+			),
+		);
+
+		wp_style_engine_get_styles(
+			$block_styles,
+			array(
+				'selector' => '#font-size-rulez',
+			)
+		);
+
+		$all_stores = WP_Style_Engine_CSS_Rules_Store::get_stores();
+
+		$this->assertEmpty( $all_stores );
+	}
+
+	/**
+	 * Tests adding rules to a store and retrieving a generated stylesheet.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_style_engine_get_stylesheet_from_context
+	 */
+	public function test_should_get_stored_stylesheet_from_context() {
+		$css_rules           = array(
+			array(
+				'selector'     => '.frodo',
+				'declarations' => array(
+					'color'        => 'brown',
+					'height'       => '10px',
+					'width'        => '30px',
+					'border-style' => 'dotted',
+				),
+			),
+			array(
+				'selector'     => '.samwise',
+				'declarations' => array(
+					'color'        => 'brown',
+					'height'       => '20px',
+					'width'        => '50px',
+					'border-style' => 'solid',
+				),
+			),
+		);
+		$compiled_stylesheet = wp_style_engine_get_stylesheet_from_css_rules(
+			$css_rules,
+			array(
+				'context' => 'test-store',
+			)
+		);
+
+		$this->assertSame( $compiled_stylesheet, wp_style_engine_get_stylesheet_from_context( 'test-store' ) );
+	}
+
+	/**
+	 * Tests returning a generated stylesheet from a set of rules.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_style_engine_get_stylesheet_from_css_rules
+	 */
+	public function test_should_return_stylesheet_from_css_rules() {
+		$css_rules = array(
+			array(
+				'selector'     => '.saruman',
+				'declarations' => array(
+					'color'        => 'white',
+					'height'       => '100px',
+					'border-style' => 'solid',
+					'align-self'   => 'unset',
+				),
+			),
+			array(
+				'selector'     => '.gandalf',
+				'declarations' => array(
+					'color'        => 'grey',
+					'height'       => '90px',
+					'border-style' => 'dotted',
+					'align-self'   => 'safe center',
+				),
+			),
+			array(
+				'selector'     => '.radagast',
+				'declarations' => array(
+					'color'        => 'brown',
+					'height'       => '60px',
+					'border-style' => 'dashed',
+					'align-self'   => 'stretch',
+				),
+			),
+		);
+
+		$compiled_stylesheet = wp_style_engine_get_stylesheet_from_css_rules( $css_rules, array( 'prettify' => false ) );
+
+		$this->assertSame( '.saruman{color:white;height:100px;border-style:solid;align-self:unset;}.gandalf{color:grey;height:90px;border-style:dotted;align-self:safe center;}.radagast{color:brown;height:60px;border-style:dashed;align-self:stretch;}', $compiled_stylesheet );
+	}
+
+	/**
+	 * Tests that incoming styles are deduped and merged.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_style_engine_get_stylesheet_from_css_rules
+	 */
+	public function test_should_dedupe_and_merge_css_rules() {
+		$css_rules = array(
+			array(
+				'selector'     => '.gandalf',
+				'declarations' => array(
+					'color'        => 'grey',
+					'height'       => '90px',
+					'border-style' => 'dotted',
+				),
+			),
+			array(
+				'selector'     => '.gandalf',
+				'declarations' => array(
+					'color'         => 'white',
+					'height'        => '190px',
+					'padding'       => '10px',
+					'margin-bottom' => '100px',
+				),
+			),
+			array(
+				'selector'     => '.dumbledore',
+				'declarations' => array(
+					'color'        => 'grey',
+					'height'       => '90px',
+					'border-style' => 'dotted',
+				),
+			),
+			array(
+				'selector'     => '.rincewind',
+				'declarations' => array(
+					'color'        => 'grey',
+					'height'       => '90px',
+					'border-style' => 'dotted',
+				),
+			),
+		);
+
+		$compiled_stylesheet = wp_style_engine_get_stylesheet_from_css_rules( $css_rules, array( 'prettify' => false ) );
+
+		$this->assertSame( '.gandalf{color:white;height:190px;border-style:dotted;padding:10px;margin-bottom:100px;}.dumbledore,.rincewind{color:grey;height:90px;border-style:dotted;}', $compiled_stylesheet );
+	}
+}
diff --git a/tests/style-engine/wpStyleEngineCssDeclarations.php b/tests/style-engine/wpStyleEngineCssDeclarations.php
new file mode 100644
index 0000000000..b1f6203e6b
--- /dev/null
+++ b/tests/style-engine/wpStyleEngineCssDeclarations.php
@@ -0,0 +1,293 @@
+<?php
+/**
+ * Tests the Style Engine CSS declarations class.
+ *
+ * @package WordPress
+ * @subpackage StyleEngine
+ * @since 6.1.0
+ *
+ * @group style-engine
+ */
+
+/**
+ * Tests registering, storing and generating CSS declarations.
+ *
+ * @coversDefaultClass WP_Style_Engine_CSS_Declarations
+ */
+class Tests_Style_Engine_wpStyleEngineCSSDeclarations extends WP_UnitTestCase {
+	/**
+	 * Tests setting declarations on instantiation.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::__construct
+	 */
+	public function test_should_set_declarations_on_instantiation() {
+		$input_declarations = array(
+			'margin-top' => '10px',
+			'font-size'  => '2rem',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+
+		$this->assertSame( $input_declarations, $css_declarations->get_declarations() );
+	}
+
+	/**
+	 * Tests that declarations are added.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_declarations
+	 * @covers ::add_declaration
+	 */
+	public function test_should_add_declarations() {
+		$input_declarations = array(
+			'padding' => '20px',
+			'color'   => 'var(--wp--preset--elbow-patches)',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations();
+		$css_declarations->add_declarations( $input_declarations );
+
+		$this->assertSame( $input_declarations, $css_declarations->get_declarations() );
+	}
+
+	/**
+	 * Tests that new declarations are added to existing declarations.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_declarations
+	 * @covers ::add_declaration
+	 */
+	public function test_should_add_new_declarations_to_existing() {
+		$input_declarations = array(
+			'border-width'     => '1%',
+			'background-color' => 'var(--wp--preset--english-mustard)',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$extra_declaration  = array(
+			'letter-spacing' => '1.5px',
+		);
+		$css_declarations->add_declarations( $extra_declaration );
+
+		$this->assertSame( array_merge( $input_declarations, $extra_declaration ), $css_declarations->get_declarations() );
+	}
+
+	/**
+	 * Tests that properties are sanitized before storing.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::sanitize_property
+	 */
+	public function test_should_sanitize_properties() {
+		$input_declarations = array(
+			'^--wp--style--sleepy-potato$' => '40px',
+			'<background-//color>'         => 'var(--wp--preset--english-mustard)',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+
+		$this->assertSame(
+			array(
+				'--wp--style--sleepy-potato' => '40px',
+				'background-color'           => 'var(--wp--preset--english-mustard)',
+			),
+			$css_declarations->get_declarations()
+		);
+	}
+
+	/**
+	 * Test that values with HTML tags are escaped, and CSS properties are run through safecss_filter_attr().
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_declarations_string
+	 * @covers ::filter_declaration
+	 */
+	public function test_should_strip_html_tags_and_remove_unsafe_css_properties() {
+		$input_declarations         = array(
+			'font-size'    => '<red/>',
+			'padding'      => '</style>',
+			'potato'       => 'uppercase',
+			'cheese'       => '10px',
+			'margin-right' => '10em',
+		);
+		$css_declarations           = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$safe_style_css_mock_action = new MockAction();
+
+		// filter_declaration() is called in get_declarations_string().
+		add_filter( 'safe_style_css', array( $safe_style_css_mock_action, 'filter' ) );
+		$css_declarations_string = $css_declarations->get_declarations_string();
+
+		$this->assertSame(
+			3, // Values with HTML tags are removed first by wp_strip_all_tags().
+			$safe_style_css_mock_action->get_call_count(),
+			'"safe_style_css" filters were not applied to CSS declaration properties.'
+		);
+
+		$this->assertSame(
+			'margin-right:10em;',
+			$css_declarations_string,
+			'Unallowed CSS properties or values with HTML tags were not removed.'
+		);
+	}
+
+	/**
+	 * Tests that calc, clamp, min, max, and minmax CSS functions are allowed.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_declarations_string
+	 * @covers ::filter_declaration
+	 */
+	public function test_should_allow_css_functions_and_strip_unsafe_css_values() {
+		$input_declarations                        = array(
+			'background'       => 'var(--wp--preset--color--primary, 10px)', // Simple var().
+			'font-size'        => 'clamp(36.00rem, calc(32.00rem + 10.00vw), 40.00rem)', // Nested clamp().
+			'width'            => 'min(150vw, 100px)',
+			'min-width'        => 'max(150vw, 100px)',
+			'max-width'        => 'minmax(400px, 50%)',
+			'padding'          => 'calc(80px * -1)',
+			'background-image' => 'url("https://wordpress.org")',
+			'line-height'      => 'url("https://wordpress.org")',
+			'margin'           => 'illegalfunction(30px)',
+		);
+		$css_declarations                          = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$safecss_filter_attr_allow_css_mock_action = new MockAction();
+
+		// filter_declaration() is called in get_declarations_string().
+		add_filter( 'safecss_filter_attr_allow_css', array( $safecss_filter_attr_allow_css_mock_action, 'filter' ) );
+		$css_declarations_string = $css_declarations->get_declarations_string();
+
+		$this->assertSame(
+			9,
+			$safecss_filter_attr_allow_css_mock_action->get_call_count(),
+			'"safecss_filter_attr_allow_css" filters were not applied to CSS declaration values.'
+		);
+
+		$this->assertSame(
+			'background:var(--wp--preset--color--primary, 10px);font-size:clamp(36.00rem, calc(32.00rem + 10.00vw), 40.00rem);width:min(150vw, 100px);min-width:max(150vw, 100px);max-width:minmax(400px, 50%);padding:calc(80px * -1);background-image:url("https://wordpress.org");',
+			$css_declarations_string,
+			'Unsafe values were not removed'
+		);
+	}
+
+	/**
+	 * Tests that CSS declarations are compiled into a CSS declarations block string.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_declarations_string
+	 *
+	 * @dataProvider data_should_compile_css_declarations_to_css_declarations_string
+	 *
+	 * @param string $expected        The expected declarations block string.
+	 * @param bool   $should_prettify Optional. Whether to pretty the string. Default false.
+	 * @param int    $indent_count    Optional. The number of tab indents. Default false.
+	 */
+	public function test_should_compile_css_declarations_to_css_declarations_string( $expected, $should_prettify = false, $indent_count = 0 ) {
+		$input_declarations = array(
+			'color'                  => 'red',
+			'border-top-left-radius' => '99px',
+			'text-decoration'        => 'underline',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+
+		$this->assertSame(
+			$expected,
+			$css_declarations->get_declarations_string( $should_prettify, $indent_count )
+		);
+	}
+
+	/**
+	 * Data provider for test_should_compile_css_declarations_to_css_declarations_string().
+	 *
+	 * @return array
+	 */
+	public function data_should_compile_css_declarations_to_css_declarations_string() {
+		return array(
+			'unprettified, no indent'  => array(
+				'expected' => 'color:red;border-top-left-radius:99px;text-decoration:underline;',
+			),
+			'unprettified, one indent' => array(
+				'expected'        => 'color:red;border-top-left-radius:99px;text-decoration:underline;',
+				'should_prettify' => false,
+				'indent_count'    => 1,
+			),
+			'prettified, no indent'    => array(
+				'expected'        => 'color: red; border-top-left-radius: 99px; text-decoration: underline;',
+				'should_prettify' => true,
+			),
+			'prettified, one indent'   => array(
+				'expected'        => "\tcolor: red;\n\tborder-top-left-radius: 99px;\n\ttext-decoration: underline;",
+				'should_prettify' => true,
+				'indent_count'    => 1,
+			),
+			'prettified, two indents'  => array(
+				'expected'        => "\t\tcolor: red;\n\t\tborder-top-left-radius: 99px;\n\t\ttext-decoration: underline;",
+				'should_prettify' => true,
+				'indent_count'    => 2,
+			),
+		);
+	}
+
+	/**
+	 * Tests removing a single declaration.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::remove_declaration
+	 */
+	public function test_should_remove_single_declaration() {
+		$input_declarations = array(
+			'color'       => 'tomato',
+			'margin'      => '10em 10em 20em 1px',
+			'font-family' => 'Happy Font serif',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+
+		$this->assertSame(
+			'color:tomato;margin:10em 10em 20em 1px;font-family:Happy Font serif;',
+			$css_declarations->get_declarations_string(),
+			'CSS declarations string does not match the values of `$declarations` passed to the constructor.'
+		);
+
+		$css_declarations->remove_declaration( 'color' );
+
+		$this->assertSame(
+			'margin:10em 10em 20em 1px;font-family:Happy Font serif;',
+			$css_declarations->get_declarations_string(),
+			'Output after removing "color" declaration via `remove_declaration()` does not match expectations'
+		);
+	}
+
+	/**
+	 * Tests that multiple declarations are removed.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::remove_declarations
+	 */
+	public function test_should_remove_multiple_declarations() {
+		$input_declarations = array(
+			'color'       => 'cucumber',
+			'margin'      => '10em 10em 20em 1px',
+			'font-family' => 'Happy Font serif',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+
+		$this->assertSame(
+			'color:cucumber;margin:10em 10em 20em 1px;font-family:Happy Font serif;',
+			$css_declarations->get_declarations_string(),
+			'CSS declarations string does not match the values of `$declarations` passed to the constructor.'
+		);
+
+		$css_declarations->remove_declarations( array( 'color', 'margin' ) );
+
+		$this->assertSame(
+			'font-family:Happy Font serif;',
+			$css_declarations->get_declarations_string(),
+			'Output after removing "color" and "margin" declarations via `remove_declarations()` does not match expectations'
+		);
+	}
+}
diff --git a/tests/style-engine/wpStyleEngineCssRule.php b/tests/style-engine/wpStyleEngineCssRule.php
new file mode 100644
index 0000000000..959f4092a9
--- /dev/null
+++ b/tests/style-engine/wpStyleEngineCssRule.php
@@ -0,0 +1,161 @@
+<?php
+/**
+ * Tests the Style Engine CSS Rule class.
+ *
+ * @package WordPress
+ * @subpackage StyleEngine
+ * @since 6.1.0
+ *
+ * @group style-engine
+ */
+
+/**
+ * Tests for registering, storing and generating CSS rules.
+ *
+ * @coversDefaultClass WP_Style_Engine_CSS_Rule
+ */
+class Tests_Style_Engine_wpStyleEngineCSSRule extends WP_UnitTestCase {
+	/**
+	 * Tests that declarations are set on instantiation.
+	 *
+	 * @ticket 56467
+	 * @covers ::__construct
+	 */
+	public function test_should_instantiate_with_selector_and_rules() {
+		$selector           = '.law-and-order';
+		$input_declarations = array(
+			'margin-top' => '10px',
+			'font-size'  => '2rem',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$css_rule           = new WP_Style_Engine_CSS_Rule( $selector, $css_declarations );
+
+		$this->assertSame( $selector, $css_rule->get_selector(), 'Return value of get_selector() does not match value passed to constructor.' );
+
+		$expected = "$selector{{$css_declarations->get_declarations_string()}}";
+
+		$this->assertSame( $expected, $css_rule->get_css(), 'Value returned by get_css() does not match expected declarations string.' );
+	}
+
+	/**
+	 * Tests that declaration properties are deduplicated.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_declarations
+	 * @covers ::get_css
+	 */
+	public function test_should_dedupe_properties_in_rules() {
+		$selector                    = '.taggart';
+		$first_declaration           = array(
+			'font-size' => '2rem',
+		);
+		$overwrite_first_declaration = array(
+			'font-size' => '4px',
+		);
+		$css_rule                    = new WP_Style_Engine_CSS_Rule( $selector, $first_declaration );
+		$css_rule->add_declarations( new WP_Style_Engine_CSS_Declarations( $overwrite_first_declaration ) );
+
+		$expected = '.taggart{font-size:4px;}';
+
+		$this->assertSame( $expected, $css_rule->get_css() );
+	}
+
+	/**
+	 * Tests that declarations can be added to existing rules.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_declarations
+	 * @covers ::get_css
+	 */
+	public function test_should_add_declarations_to_existing_rules() {
+		// Declarations using a WP_Style_Engine_CSS_Declarations object.
+		$some_css_declarations = new WP_Style_Engine_CSS_Declarations( array( 'margin-top' => '10px' ) );
+		// Declarations using a property => value array.
+		$some_more_css_declarations = array( 'font-size' => '1rem' );
+		$css_rule                   = new WP_Style_Engine_CSS_Rule( '.hill-street-blues', $some_css_declarations );
+		$css_rule->add_declarations( $some_more_css_declarations );
+
+		$expected = '.hill-street-blues{margin-top:10px;font-size:1rem;}';
+
+		$this->assertSame( $expected, $css_rule->get_css() );
+	}
+
+	/**
+	 * Tests setting a selector to a rule.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::set_selector
+	 */
+	public function test_should_set_selector() {
+		$selector = '.taggart';
+		$css_rule = new WP_Style_Engine_CSS_Rule( $selector );
+
+		$this->assertSame( $selector, $css_rule->get_selector(), 'Return value of get_selector() does not match value passed to constructor.' );
+
+		$css_rule->set_selector( '.law-and-order' );
+
+		$this->assertSame( '.law-and-order', $css_rule->get_selector(), 'Return value of get_selector() does not match value passed to set_selector().' );
+	}
+
+	/**
+	 * Tests generating a CSS rule string.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_css
+	 */
+	public function test_should_generate_css_rule_string() {
+		$selector           = '.chips';
+		$input_declarations = array(
+			'margin-top' => '10px',
+			'font-size'  => '2rem',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$css_rule           = new WP_Style_Engine_CSS_Rule( $selector, $css_declarations );
+		$expected           = "$selector{{$css_declarations->get_declarations_string()}}";
+
+		$this->assertSame( $expected, $css_rule->get_css() );
+	}
+
+	/**
+	 * Tests that an empty string will be returned where there are no declarations in a CSS rule.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_css
+	 */
+	public function test_should_return_empty_string_with_no_declarations() {
+		$selector           = '.holmes';
+		$input_declarations = array();
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$css_rule           = new WP_Style_Engine_CSS_Rule( $selector, $css_declarations );
+
+		$this->assertSame( '', $css_rule->get_css() );
+	}
+
+	/**
+	 * Tests that CSS rules are prettified.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_css
+	 */
+	public function test_should_prettify_css_rule_output() {
+		$selector           = '.baptiste';
+		$input_declarations = array(
+			'margin-left' => '0',
+			'font-family' => 'Detective Sans',
+		);
+		$css_declarations   = new WP_Style_Engine_CSS_Declarations( $input_declarations );
+		$css_rule           = new WP_Style_Engine_CSS_Rule( $selector, $css_declarations );
+		$expected           = '.baptiste {
+	margin-left: 0;
+	font-family: Detective Sans;
+}';
+
+		$this->assertSame( $expected, $css_rule->get_css( true ) );
+	}
+}
diff --git a/tests/style-engine/wpStyleEngineCssRulesStore.php b/tests/style-engine/wpStyleEngineCssRulesStore.php
new file mode 100644
index 0000000000..559c0b3492
--- /dev/null
+++ b/tests/style-engine/wpStyleEngineCssRulesStore.php
@@ -0,0 +1,190 @@
+<?php
+/**
+ * Tests the Style Engine CSS Rules Store class.
+ *
+ * @package WordPress
+ * @subpackage StyleEngine
+ * @since 6.1.0
+ *
+ * @group style-engine
+ */
+
+/**
+ * Tests for registering, storing and retrieving a collection of CSS Rules (a store).
+ *
+ * @coversDefaultClass WP_Style_Engine_CSS_Rules_Store
+ */
+class Tests_Style_Engine_wpStyleEngineCSSRulesStore extends WP_UnitTestCase {
+	/**
+	 * Cleans up stores after each test.
+	 */
+	public function tear_down() {
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests creating a new store on instantiation.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::__construct
+	 */
+	public function test_should_create_new_store_on_instantiation() {
+		$new_pancakes_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'pancakes-with-strawberries' );
+
+		$this->assertInstanceOf( 'WP_Style_Engine_CSS_Rules_Store', $new_pancakes_store );
+	}
+
+	/**
+	 * Tests that a `$store_name` argument is required and no store will be created without one.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_store
+	 */
+	public function test_should_not_create_store_without_a_store_name() {
+		$not_a_store = WP_Style_Engine_CSS_Rules_Store::get_store( '' );
+
+		$this->assertEmpty( $not_a_store, 'get_store() did not return an empty value with empty string as argument.' );
+
+		$also_not_a_store = WP_Style_Engine_CSS_Rules_Store::get_store( 123 );
+
+		$this->assertEmpty( $also_not_a_store, 'get_store() did not return an empty value with number as argument.' );
+
+		$definitely_not_a_store = WP_Style_Engine_CSS_Rules_Store::get_store( null );
+
+		$this->assertEmpty( $definitely_not_a_store, 'get_store() did not return an empty value with `null` as argument.' );
+	}
+
+	/**
+	 * Tests returning a previously created store when the same selector key is passed.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_store
+	 */
+	public function test_should_return_existing_store() {
+		$new_fish_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'fish-n-chips' );
+		$selector       = '.haddock';
+
+		$new_fish_store->add_rule( $selector );
+
+		$this->assertSame( $selector, $new_fish_store->add_rule( $selector )->get_selector(), 'Selector string of store rule does not match expected value' );
+
+		$the_same_fish_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'fish-n-chips' );
+
+		$this->assertSame( $selector, $the_same_fish_store->add_rule( $selector )->get_selector(), 'Selector string of existing store rule does not match expected value' );
+	}
+
+	/**
+	 * Tests returning all previously created stores.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_stores
+	 */
+	public function test_should_get_all_existing_stores() {
+		$burrito_store    = WP_Style_Engine_CSS_Rules_Store::get_store( 'burrito' );
+		$quesadilla_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'quesadilla' );
+
+		$this->assertEquals(
+			array(
+				'burrito'    => $burrito_store,
+				'quesadilla' => $quesadilla_store,
+			),
+			WP_Style_Engine_CSS_Rules_Store::get_stores()
+		);
+	}
+
+	/**
+	 * Tests that all previously created stores are deleted.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::remove_all_stores
+	 */
+	public function test_should_remove_all_stores() {
+		$dolmades_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'dolmades' );
+		$tzatziki_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'tzatziki' );
+
+		$this->assertEquals(
+			array(
+				'dolmades' => $dolmades_store,
+				'tzatziki' => $tzatziki_store,
+			),
+			WP_Style_Engine_CSS_Rules_Store::get_stores(),
+			'Return value of get_stores() does not match expectation'
+		);
+
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+
+		$this->assertEquals(
+			array(),
+			WP_Style_Engine_CSS_Rules_Store::get_stores(),
+			'Return value of get_stores() is not an empty array after remove_all_stores() called.'
+		);
+	}
+
+	/**
+	 * Tests adding rules to an existing store.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_rule
+	 */
+	public function test_should_add_rule_to_existing_store() {
+		$new_pie_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'meat-pie' );
+		$selector      = '.wp-block-sauce a:hover';
+		$store_rule    = $new_pie_store->add_rule( $selector );
+		$expected      = '';
+
+		$this->assertSame( $expected, $store_rule->get_css(), 'Return value of get_css() is not a empty string where a rule has no CSS declarations.' );
+
+		$pie_declarations = array(
+			'color'         => 'brown',
+			'border-color'  => 'yellow',
+			'border-radius' => '10rem',
+		);
+		$css_declarations = new WP_Style_Engine_CSS_Declarations( $pie_declarations );
+		$store_rule->add_declarations( $css_declarations );
+		$store_rule = $new_pie_store->add_rule( $selector );
+
+		$expected = "$selector{{$css_declarations->get_declarations_string()}}";
+
+		$this->assertSame( $expected, $store_rule->get_css(), 'Return value of get_css() does not match expected CSS from existing store rules.' );
+	}
+
+	/**
+	 * Tests that all stored rule objects are returned.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_all_rules
+	 */
+	public function test_should_get_all_rule_objects_for_a_store() {
+		$new_pizza_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'pizza-with-mozzarella' );
+		$selector        = '.wp-block-anchovies a:hover';
+		$store_rule      = $new_pizza_store->add_rule( $selector );
+		$expected        = array(
+			$selector => $store_rule,
+		);
+
+		$this->assertSame( $expected, $new_pizza_store->get_all_rules(), 'Return value for get_all_rules() does not match expectations.' );
+
+		$new_selector             = '.wp-block-mushroom a:hover';
+		$newer_pizza_declarations = array(
+			'padding' => '100px',
+		);
+		$new_store_rule           = $new_pizza_store->add_rule( $new_selector );
+		$css_declarations         = new WP_Style_Engine_CSS_Declarations( $newer_pizza_declarations );
+		$new_store_rule->add_declarations( array( $css_declarations ) );
+
+		$expected = array(
+			$selector     => $store_rule,
+			$new_selector => $new_store_rule,
+		);
+
+		$this->assertSame( $expected, $new_pizza_store->get_all_rules(), 'Return value for get_all_rules() does not match expectations after adding new rules to store.' );
+	}
+}
diff --git a/tests/style-engine/wpStyleEngineProcessor.php b/tests/style-engine/wpStyleEngineProcessor.php
new file mode 100644
index 0000000000..05acdc6db5
--- /dev/null
+++ b/tests/style-engine/wpStyleEngineProcessor.php
@@ -0,0 +1,315 @@
+<?php
+/**
+ * Tests the Style Engine Processor class.
+ *
+ * @package WordPress
+ * @subpackage StyleEngine
+ * @since 6.1.0
+ *
+ * @group style-engine
+ */
+
+/**
+ * Tests for compiling and rendering styles from a store of CSS rules.
+ *
+ * @coversDefaultClass WP_Style_Engine_Processor
+ */
+class Tests_Style_Engine_wpStyleEngineProcessor extends WP_UnitTestCase {
+	/**
+	 * Tests adding rules and returning compiled CSS rules.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_rules
+	 * @covers ::get_css
+	 */
+	public function test_should_return_rules_as_compiled_css() {
+		$a_nice_css_rule = new WP_Style_Engine_CSS_Rule( '.a-nice-rule' );
+		$a_nice_css_rule->add_declarations(
+			array(
+				'color'            => 'var(--nice-color)',
+				'background-color' => 'purple',
+			)
+		);
+		$a_nicer_css_rule = new WP_Style_Engine_CSS_Rule( '.a-nicer-rule' );
+		$a_nicer_css_rule->add_declarations(
+			array(
+				'font-family'      => 'Nice sans',
+				'font-size'        => '1em',
+				'background-color' => 'purple',
+			)
+		);
+		$a_nice_processor = new WP_Style_Engine_Processor();
+		$a_nice_processor->add_rules( array( $a_nice_css_rule, $a_nicer_css_rule ) );
+
+		$this->assertSame(
+			'.a-nice-rule{color:var(--nice-color);background-color:purple;}.a-nicer-rule{font-family:Nice sans;font-size:1em;background-color:purple;}',
+			$a_nice_processor->get_css( array( 'prettify' => false ) )
+		);
+	}
+
+	/**
+	 * Tests compiling CSS rules and formatting them with new lines and indents.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_css
+	 */
+	public function test_should_return_prettified_css_rules() {
+		$a_wonderful_css_rule = new WP_Style_Engine_CSS_Rule( '.a-wonderful-rule' );
+		$a_wonderful_css_rule->add_declarations(
+			array(
+				'color'            => 'var(--wonderful-color)',
+				'background-color' => 'orange',
+			)
+		);
+		$a_very_wonderful_css_rule = new WP_Style_Engine_CSS_Rule( '.a-very_wonderful-rule' );
+		$a_very_wonderful_css_rule->add_declarations(
+			array(
+				'color'            => 'var(--wonderful-color)',
+				'background-color' => 'orange',
+			)
+		);
+		$a_more_wonderful_css_rule = new WP_Style_Engine_CSS_Rule( '.a-more-wonderful-rule' );
+		$a_more_wonderful_css_rule->add_declarations(
+			array(
+				'font-family'      => 'Wonderful sans',
+				'font-size'        => '1em',
+				'background-color' => 'orange',
+			)
+		);
+		$a_wonderful_processor = new WP_Style_Engine_Processor();
+		$a_wonderful_processor->add_rules( array( $a_wonderful_css_rule, $a_very_wonderful_css_rule, $a_more_wonderful_css_rule ) );
+
+		$expected = '.a-more-wonderful-rule {
+	font-family: Wonderful sans;
+	font-size: 1em;
+	background-color: orange;
+}
+.a-wonderful-rule,
+.a-very_wonderful-rule {
+	color: var(--wonderful-color);
+	background-color: orange;
+}
+';
+		$this->assertSame(
+			$expected,
+			$a_wonderful_processor->get_css( array( 'prettify' => true ) )
+		);
+	}
+
+	/**
+	 * Tests adding a store and compiling CSS rules from that store.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_store
+	 */
+	public function test_should_return_store_rules_as_css() {
+		$a_nice_store = WP_Style_Engine_CSS_Rules_Store::get_store( 'nice' );
+		$a_nice_store->add_rule( '.a-nice-rule' )->add_declarations(
+			array(
+				'color'            => 'var(--nice-color)',
+				'background-color' => 'purple',
+			)
+		);
+		$a_nice_store->add_rule( '.a-nicer-rule' )->add_declarations(
+			array(
+				'font-family'      => 'Nice sans',
+				'font-size'        => '1em',
+				'background-color' => 'purple',
+			)
+		);
+		$a_nice_renderer = new WP_Style_Engine_Processor();
+		$a_nice_renderer->add_store( $a_nice_store );
+
+		$this->assertSame(
+			'.a-nice-rule{color:var(--nice-color);background-color:purple;}.a-nicer-rule{font-family:Nice sans;font-size:1em;background-color:purple;}',
+			$a_nice_renderer->get_css( array( 'prettify' => false ) )
+		);
+	}
+
+	/**
+	 * Tests that CSS declarations are merged and deduped in the final CSS rules output.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_rules
+	 * @covers ::get_css
+	 */
+	public function test_should_dedupe_and_merge_css_declarations() {
+		$an_excellent_rule      = new WP_Style_Engine_CSS_Rule( '.an-excellent-rule' );
+		$an_excellent_processor = new WP_Style_Engine_Processor();
+		$an_excellent_rule->add_declarations(
+			array(
+				'color'        => 'var(--excellent-color)',
+				'border-style' => 'dotted',
+			)
+		);
+		$an_excellent_processor->add_rules( $an_excellent_rule );
+
+		$another_excellent_rule = new WP_Style_Engine_CSS_Rule( '.an-excellent-rule' );
+		$another_excellent_rule->add_declarations(
+			array(
+				'color'        => 'var(--excellent-color)',
+				'border-style' => 'dotted',
+				'border-color' => 'brown',
+			)
+		);
+		$an_excellent_processor->add_rules( $another_excellent_rule );
+
+		$this->assertSame(
+			'.an-excellent-rule{color:var(--excellent-color);border-style:dotted;border-color:brown;}',
+			$an_excellent_processor->get_css( array( 'prettify' => false ) ),
+			'Return value of get_css() does not match expectations with new, deduped and merged declarations.'
+		);
+
+		$yet_another_excellent_rule = new WP_Style_Engine_CSS_Rule( '.an-excellent-rule' );
+		$yet_another_excellent_rule->add_declarations(
+			array(
+				'color'        => 'var(--excellent-color)',
+				'border-style' => 'dashed',
+				'border-width' => '2px',
+			)
+		);
+		$an_excellent_processor->add_rules( $yet_another_excellent_rule );
+
+		$this->assertSame(
+			'.an-excellent-rule{color:var(--excellent-color);border-style:dashed;border-color:brown;border-width:2px;}',
+			$an_excellent_processor->get_css( array( 'prettify' => false ) ),
+			'Return value of get_css() does not match expectations with deduped and merged declarations.'
+		);
+	}
+
+	/**
+	 * Tests printing out 'unoptimized' CSS, that is, uncombined selectors and duplicate CSS rules.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_css
+	 */
+	public function test_should_not_optimize_css_output() {
+		$a_sweet_rule = new WP_Style_Engine_CSS_Rule(
+			'.a-sweet-rule',
+			array(
+				'color'            => 'var(--sweet-color)',
+				'background-color' => 'purple',
+			)
+		);
+
+		$a_sweeter_rule = new WP_Style_Engine_CSS_Rule(
+			'#an-even-sweeter-rule > marquee',
+			array(
+				'color'            => 'var(--sweet-color)',
+				'background-color' => 'purple',
+			)
+		);
+
+		$the_sweetest_rule = new WP_Style_Engine_CSS_Rule(
+			'.the-sweetest-rule-of-all a',
+			array(
+				'color'            => 'var(--sweet-color)',
+				'background-color' => 'purple',
+			)
+		);
+
+		$a_sweet_processor = new WP_Style_Engine_Processor();
+		$a_sweet_processor->add_rules( array( $a_sweet_rule, $a_sweeter_rule, $the_sweetest_rule ) );
+
+		$this->assertSame(
+			'.a-sweet-rule{color:var(--sweet-color);background-color:purple;}#an-even-sweeter-rule > marquee{color:var(--sweet-color);background-color:purple;}.the-sweetest-rule-of-all a{color:var(--sweet-color);background-color:purple;}',
+			$a_sweet_processor->get_css(
+				array(
+					'optimize' => false,
+					'prettify' => false,
+				)
+			)
+		);
+	}
+
+	/**
+	 * Tests that 'optimized' CSS is output, that is, that duplicate CSS rules are combined under their corresponding selectors.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::get_css
+	 */
+	public function test_should_optimize_css_output_by_default() {
+		$a_sweet_rule = new WP_Style_Engine_CSS_Rule(
+			'.a-sweet-rule',
+			array(
+				'color'            => 'var(--sweet-color)',
+				'background-color' => 'purple',
+			)
+		);
+
+		$a_sweeter_rule = new WP_Style_Engine_CSS_Rule(
+			'#an-even-sweeter-rule > marquee',
+			array(
+				'color'            => 'var(--sweet-color)',
+				'background-color' => 'purple',
+			)
+		);
+
+		$a_sweet_processor = new WP_Style_Engine_Processor();
+		$a_sweet_processor->add_rules( array( $a_sweet_rule, $a_sweeter_rule ) );
+
+		$this->assertSame(
+			'.a-sweet-rule,#an-even-sweeter-rule > marquee{color:var(--sweet-color);background-color:purple;}',
+			$a_sweet_processor->get_css( array( 'prettify' => false ) )
+		);
+	}
+
+	/**
+	 * Tests that incoming CSS rules are merged with existing CSS rules.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::add_rules
+	 */
+	public function test_should_combine_previously_added_css_rules() {
+		$a_lovely_processor = new WP_Style_Engine_Processor();
+		$a_lovely_rule      = new WP_Style_Engine_CSS_Rule(
+			'.a-lovely-rule',
+			array(
+				'border-color' => 'purple',
+			)
+		);
+		$a_lovely_processor->add_rules( $a_lovely_rule );
+		$a_lovelier_rule = new WP_Style_Engine_CSS_Rule(
+			'.a-lovelier-rule',
+			array(
+				'border-color' => 'purple',
+			)
+		);
+		$a_lovely_processor->add_rules( $a_lovelier_rule );
+
+		$this->assertSame(
+			'.a-lovely-rule,.a-lovelier-rule{border-color:purple;}',
+			$a_lovely_processor->get_css( array( 'prettify' => false ) ),
+			'Return value of get_css() does not match expectations when combining 2 CSS rules'
+		);
+
+		$a_most_lovely_rule = new WP_Style_Engine_CSS_Rule(
+			'.a-most-lovely-rule',
+			array(
+				'border-color' => 'purple',
+			)
+		);
+		$a_lovely_processor->add_rules( $a_most_lovely_rule );
+
+		$a_perfectly_lovely_rule = new WP_Style_Engine_CSS_Rule(
+			'.a-perfectly-lovely-rule',
+			array(
+				'border-color' => 'purple',
+			)
+		);
+		$a_lovely_processor->add_rules( $a_perfectly_lovely_rule );
+
+		$this->assertSame(
+			'.a-lovely-rule,.a-lovelier-rule,.a-most-lovely-rule,.a-perfectly-lovely-rule{border-color:purple;}',
+			$a_lovely_processor->get_css( array( 'prettify' => false ) ),
+			'Return value of get_css() does not match expectations when combining 4 CSS rules'
+		);
+	}
+}
diff --git a/tests/taxonomy.php b/tests/taxonomy.php
index 6d7cc06602..9b31b573a2 100644
--- a/tests/taxonomy.php
+++ b/tests/taxonomy.php
@@ -17,7 +17,7 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 	 */
 	public function test_get_unknown_taxonomies() {
 		// Taxonomies for an unknown object type.
-		$this->assertSame( array(), get_object_taxonomies( rand_str() ) );
+		$this->assertSame( array(), get_object_taxonomies( 'unknown' ) );
 		$this->assertSame( array(), get_object_taxonomies( '' ) );
 		$this->assertSame( array(), get_object_taxonomies( 0 ) );
 		$this->assertSame( array(), get_object_taxonomies( null ) );
@@ -128,6 +128,41 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 		$this->assertFalse( taxonomy_exists( null ) );
 	}
 
+	/**
+	 * Tests that `taxonomy_exists()` returns `false` when the `$taxonomy`
+	 * argument is not a string.
+	 *
+	 * @ticket 56338
+	 *
+	 * @covers ::taxonomy_exists
+	 *
+	 * @dataProvider data_taxonomy_exists_should_return_false_with_non_string_taxonomy
+	 *
+	 * @param mixed $taxonomy The non-string taxonomy.
+	 */
+	public function test_taxonomy_exists_should_return_false_with_non_string_taxonomy( $taxonomy ) {
+		$this->assertFalse( taxonomy_exists( $taxonomy ) );
+	}
+
+	/**
+	 * Data provider with non-string values.
+	 *
+	 * @return array
+	 */
+	public function data_taxonomy_exists_should_return_false_with_non_string_taxonomy() {
+		return array(
+			'array'        => array( array() ),
+			'object'       => array( new stdClass() ),
+			'bool (true)'  => array( true ),
+			'bool (false)' => array( false ),
+			'null'         => array( null ),
+			'integer (0)'  => array( 0 ),
+			'integer (1)'  => array( 1 ),
+			'float (0.0)'  => array( 0.0 ),
+			'float (1.1)'  => array( 1.1 ),
+		);
+	}
+
 	public function test_is_taxonomy_hierarchical() {
 		$this->assertTrue( is_taxonomy_hierarchical( 'category' ) );
 		$this->assertFalse( is_taxonomy_hierarchical( 'post_tag' ) );
@@ -144,7 +179,7 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 	public function test_register_taxonomy() {
 
 		// Make up a new taxonomy name, and ensure it's unused.
-		$tax = rand_str();
+		$tax = 'tax_new';
 		$this->assertFalse( taxonomy_exists( $tax ) );
 
 		register_taxonomy( $tax, 'post' );
@@ -158,7 +193,7 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 	public function test_register_hierarchical_taxonomy() {
 
 		// Make up a new taxonomy name, and ensure it's unused.
-		$tax = rand_str();
+		$tax = 'tax_new';
 		$this->assertFalse( taxonomy_exists( $tax ) );
 
 		register_taxonomy( $tax, 'post', array( 'hierarchical' => true ) );
@@ -221,6 +256,22 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 		$this->assertFalse( $tax_2->show_in_quick_edit );
 	}
 
+	/**
+	 * @ticket 53212
+	 */
+	public function test_register_taxonomy_fires_registered_actions() {
+		$taxonomy = 'taxonomy53212';
+		$action   = new MockAction();
+
+		add_action( 'registered_taxonomy', array( $action, 'action' ) );
+		add_action( "registered_taxonomy_{$taxonomy}", array( $action, 'action' ) );
+
+		register_taxonomy( $taxonomy, 'post' );
+		register_taxonomy( 'random', 'post' );
+
+		$this->assertSame( 3, $action->get_call_count() );
+	}
+
 	/**
 	 * @ticket 11058
 	 */
@@ -630,13 +681,13 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 				'publicly_queryable' => false,
 			)
 		);
-		$t = $this->factory->term->create_and_get(
+		$t = self::factory()->term->create_and_get(
 			array(
 				'taxonomy' => 'wptests_tax',
 			)
 		);
 
-		$p = $this->factory->post->create();
+		$p = self::factory()->post->create();
 		wp_set_object_terms( $p, $t->slug, 'wptests_tax' );
 
 		add_filter( 'do_parse_request', array( $this, 'register_query_var' ) );
@@ -1028,9 +1079,6 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 		wp_set_object_terms( $post_id, array(), $tax );
 		$term = wp_get_post_terms( $post_id, $tax );
 		$this->assertSame( array(), $term );
-
-		unregister_taxonomy( $tax );
-		$this->assertSame( get_option( 'default_term_' . $tax ), false );
 	}
 
 	/**
diff --git a/tests/term.php b/tests/term.php
index 61fbb3a397..3e9c0a25f5 100644
--- a/tests/term.php
+++ b/tests/term.php
@@ -51,14 +51,17 @@ class Tests_Term extends WP_UnitTestCase {
 	 */
 	public function test_is_term_type() {
 		// Insert a term.
-		$term = rand_str();
+		$term = 'term_new';
 		$t    = wp_insert_term( $term, $this->taxonomy );
 		$this->assertIsArray( $t );
 		$term_obj = get_term_by( 'name', $term, $this->taxonomy );
-		$this->assertEquals( $t['term_id'], term_exists( $term_obj->slug ) );
 
+		$exists = term_exists( $term_obj->slug );
 		// Clean up.
-		$this->assertTrue( wp_delete_term( $t['term_id'], $this->taxonomy ) );
+		$deleted = wp_delete_term( $t['term_id'], $this->taxonomy );
+
+		$this->assertEquals( $t['term_id'], $exists );
+		$this->assertTrue( $deleted );
 	}
 
 	/**
@@ -120,7 +123,7 @@ class Tests_Term extends WP_UnitTestCase {
 		}
 
 		foreach ( $posts as $post_id ) {
-			$this->assertTrue( (bool) wp_delete_post( $post_id ) );
+			$this->assertInstanceOf( 'WP_Post', wp_delete_post( $post_id ) );
 		}
 	}
 
@@ -135,10 +138,10 @@ class Tests_Term extends WP_UnitTestCase {
 		$this->assertIsArray( $t );
 		$t2 = wp_insert_term( $term, 'category', array( 'parent' => $t['term_id'] ) );
 		$this->assertIsArray( $t2 );
-		if ( function_exists( 'term_is_ancestor_of' ) ) {
-			$this->assertTrue( term_is_ancestor_of( $t['term_id'], $t2['term_id'], 'category' ) );
-			$this->assertFalse( term_is_ancestor_of( $t2['term_id'], $t['term_id'], 'category' ) );
-		}
+
+		$this->assertTrue( term_is_ancestor_of( $t['term_id'], $t2['term_id'], 'category' ) );
+		$this->assertFalse( term_is_ancestor_of( $t2['term_id'], $t['term_id'], 'category' ) );
+
 		$this->assertTrue( cat_is_ancestor_of( $t['term_id'], $t2['term_id'] ) );
 		$this->assertFalse( cat_is_ancestor_of( $t2['term_id'], $t['term_id'] ) );
 
@@ -249,6 +252,51 @@ class Tests_Term extends WP_UnitTestCase {
 		$this->assertSame( 0, sanitize_term_field( 'parent', '', $term['term_id'], $this->taxonomy, 'raw' ) );
 	}
 
+	/**
+	 * @ticket 53152
+	 * @dataProvider data_wp_set_term_objects_finds_term_name_with_special_characters
+	 *
+	 * @param string $name  A term name containing special characters.
+	 */
+	public function test_wp_set_term_objects_finds_term_name_with_special_characters( $name ) {
+		$post_id  = self::$post_ids[0];
+		$expected = wp_set_object_terms( $post_id, $name, 'category', false );
+		$actual   = wp_set_object_terms( $post_id, $name, 'category', false );
+		$this->assertEquals( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_set_term_objects_finds_term_name_with_special_characters() {
+		return array(
+			'ampersand'               => array( 'name' => 'Foo & Bar' ),
+			'ndash and mdash'         => array( 'name' => 'Foo – Bar' ),
+			'trademark'               => array( 'name' => 'Foo Bar™' ),
+			'copyright'               => array( 'name' => 'Foo Bar©' ),
+			'registered'              => array( 'name' => 'Foo Bar®' ),
+			'degree'                  => array( 'name' => 'Foo ° Bar' ),
+			'forward slash'           => array( 'name' => 'Fo/o Ba/r' ),
+			'back slash'              => array( 'name' => 'F\oo \Bar' ),
+			'multiply'                => array( 'name' => 'Foo × Bar' ),
+			'standalone diacritic'    => array( 'name' => 'Foo Bāáǎàr' ),
+			'acute accents'           => array( 'name' => 'ááa´aˊ' ),
+			'iexcel and iquest'       => array( 'name' => '¡Foo ¿Bar' ),
+			'angle quotes'            => array( 'name' => '‹Foo« »Bar›' ),
+			'curly quotes'            => array( 'name' => '“F‘o„o‚ „ ‟ ‛B“a’r”' ),
+			'bullet'                  => array( 'name' => 'Foo • Bar' ),
+			'unencoded percent'       => array( 'name' => 'Foo % Bar' ),
+			'encoded ampersand'       => array( 'name' => 'Foo &amp; Bar' ),
+			'encoded ndash and mdash' => array( 'name' => 'Foo &mdash; &ndash; Bar' ),
+			'encoded trademark'       => array( 'name' => 'Foo Bar &trade;' ),
+			'encoded copyright'       => array( 'name' => 'Foo Bar &copy;' ),
+			'encoded registered'      => array( 'name' => 'Foo Bar &reg;' ),
+			'encoded bullet'          => array( 'name' => 'Foo &bullet; Bar' ),
+		);
+	}
+
 	/**
 	 * @ticket 19205
 	 */
diff --git a/tests/term/cache.php b/tests/term/cache.php
index 13e2f720cd..3a12bc1b04 100644
--- a/tests/term/cache.php
+++ b/tests/term/cache.php
@@ -244,7 +244,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	public function test_get_term_by_slug_cache() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'slug'     => 'burrito',
 				'name'     => 'Taco',
@@ -255,8 +255,8 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		clean_term_cache( $term_id, 'post_tag' );
 		$num_queries = $wpdb->num_queries;
 
-		$term = get_term_by( 'slug', 'burrito', 'post_tag' );
-		$num_queries++;
+		$term        = get_term_by( 'slug', 'burrito', 'post_tag' );
+		$num_queries = $num_queries + 2;
 		$this->assertSame( 'Taco', $term->name );
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 
@@ -275,7 +275,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	public function test_get_term_by_slug_cache_update() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'slug'     => 'burrito',
 				'name'     => 'Taco',
@@ -286,8 +286,8 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		clean_term_cache( $term_id, 'post_tag' );
 		$num_queries = $wpdb->num_queries;
 
-		$term = get_term_by( 'slug', 'burrito', 'post_tag' );
-		$num_queries++;
+		$term        = get_term_by( 'slug', 'burrito', 'post_tag' );
+		$num_queries = $num_queries + 2;
 		$this->assertSame( 'Taco', $term->name );
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 
@@ -301,8 +301,8 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		$num_queries = $wpdb->num_queries;
 
 		// This should not hit cache.
-		$term = get_term_by( 'slug', 'burrito', 'post_tag' );
-		$num_queries++;
+		$term        = get_term_by( 'slug', 'burrito', 'post_tag' );
+		$num_queries = $num_queries + 2;
 		$this->assertSame( 'No Taco', $term->name );
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 	}
@@ -313,7 +313,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	public function test_get_term_by_name_cache() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
 				'slug'     => 'noburrito',
@@ -325,7 +325,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		$num_queries = $wpdb->num_queries;
 
 		get_term_by( 'name', 'Burrito', 'post_tag' );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 
 		// This should now hit cache.
@@ -342,7 +342,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	public function test_get_term_by_name_cache_update() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
 				'slug'     => 'noburrito',
@@ -354,7 +354,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		$num_queries = $wpdb->num_queries;
 
 		get_term_by( 'name', 'Burrito', 'post_tag' );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 
 		// This should now hit cache.
@@ -367,7 +367,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 
 		// This should not hit cache.
 		get_term_by( 'name', 'burrito', 'post_tag' );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 	}
 
@@ -377,7 +377,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	public function test_invalidating_term_caches_should_fail_when_invalidation_is_suspended() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
 				'taxonomy' => 'post_tag',
@@ -388,8 +388,8 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		$num_queries  = $wpdb->num_queries;
 		$last_changed = wp_cache_get( 'last_changed', 'terms' );
 
-		$term1 = get_term_by( 'name', 'Burrito', 'post_tag' );
-		$num_queries++;
+		$term1       = get_term_by( 'name', 'Burrito', 'post_tag' );
+		$num_queries = $num_queries + 2;
 
 		// Verify the term is cached.
 		$term2 = get_term_by( 'name', 'Burrito', 'post_tag' );
@@ -420,7 +420,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 	public function test_get_term_by_does_not_prime_term_meta_cache() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'Burrito',
 				'taxonomy' => 'post_tag',
@@ -431,8 +431,8 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 		clean_term_cache( $term_id, 'post_tag' );
 		$num_queries = $wpdb->num_queries;
 
-		$term = get_term_by( 'name', 'Burrito', 'post_tag' );
-		$num_queries++;
+		$term        = get_term_by( 'name', 'Burrito', 'post_tag' );
+		$num_queries = $num_queries + 2;
 		$this->assertInstanceOf( 'WP_Term', $term );
 		$this->assertSame( $term_id, $term->term_id );
 		$this->assertSame( $num_queries, $wpdb->num_queries );
diff --git a/tests/term/getEditTermLink.php b/tests/term/getEditTermLink.php
deleted file mode 100644
index 8d52cf3f88..0000000000
--- a/tests/term/getEditTermLink.php
+++ /dev/null
@@ -1,103 +0,0 @@
-<?php
-
-/**
- * @group taxonomy
- */
-class Tests_Term_GetEditTermLink extends WP_UnitTestCase {
-	public function set_up() {
-		parent::set_up();
-		wp_set_current_user( self::factory()->user->create( array( 'role' => 'administrator' ) ) );
-		register_taxonomy( 'wptests_tax', 'post' );
-	}
-
-	public function test_get_edit_term_link_default() {
-		$term1 = self::factory()->term->create(
-			array(
-				'taxonomy' => 'wptests_tax',
-				'name'     => 'foo',
-			)
-		);
-
-		$actual   = get_edit_term_link( $term1, 'wptests_tax' );
-		$expected = 'http://' . WP_TESTS_DOMAIN . '/wp-admin/term.php?taxonomy=wptests_tax&tag_ID=' . $term1 . '&post_type=post';
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * @ticket 32786
-	 */
-	public function test_get_edit_term_link_invalid_id() {
-		$term1 = self::factory()->term->create(
-			array(
-				'taxonomy' => 'wptests_tax',
-				'name'     => 'foo',
-			)
-		);
-
-		$actual = get_edit_term_link( 12345, 'wptests_tax' );
-		$this->assertNull( $actual );
-	}
-
-	/**
-	 * @ticket 32786
-	 */
-	public function test_get_edit_term_link_empty_id() {
-		$actual = get_edit_term_link( '', 'wptests_tax' );
-		$this->assertNull( $actual );
-	}
-
-	/**
-	 * @ticket 32786
-	 */
-	public function test_get_edit_term_link_bad_tax() {
-		$actual = get_edit_term_link( '', 'bad_tax' );
-		$this->assertNull( $actual );
-	}
-
-	/**
-	 * @ticket 35922
-	 */
-	public function test_taxonomy_should_not_be_required() {
-		$t = self::factory()->term->create(
-			array(
-				'taxonomy' => 'wptests_tax',
-				'name'     => 'foo',
-			)
-		);
-
-		$actual = get_edit_term_link( $t );
-		$this->assertNotNull( $actual );
-	}
-
-	/**
-	 * @ticket 35922
-	 */
-	public function test_cap_check_should_use_correct_taxonomy_when_taxonomy_is_not_specified() {
-		register_taxonomy(
-			'wptests_tax_subscriber',
-			'post',
-			array(
-				'capabilities' => array(
-					'edit_terms' => 'read',
-				),
-			)
-		);
-
-		$t = self::factory()->term->create(
-			array(
-				'taxonomy' => 'wptests_tax_subscriber',
-				'name'     => 'foo',
-			)
-		);
-
-		$u = self::factory()->user->create(
-			array(
-				'role' => 'subscriber',
-			)
-		);
-		wp_set_current_user( $u );
-
-		$actual = get_edit_term_link( $t );
-		$this->assertNotNull( $actual );
-	}
-}
diff --git a/tests/term/getTerm.php b/tests/term/getTerm.php
index 39e661bbe8..ec618e190d 100644
--- a/tests/term/getTerm.php
+++ b/tests/term/getTerm.php
@@ -31,6 +31,8 @@ class Tests_Term_GetTerm extends WP_UnitTestCase {
 			array( '%d' )
 		);
 
+		clean_term_cache( $t1['term_id'] );
+
 		return array(
 			array(
 				'term_id'          => $t1['term_id'],
diff --git a/tests/term/getTermBy.php b/tests/term/getTermBy.php
index a7f19ead6c..6422e44f0a 100644
--- a/tests/term/getTermBy.php
+++ b/tests/term/getTermBy.php
@@ -5,6 +5,8 @@
  */
 class Tests_Term_GetTermBy extends WP_UnitTestCase {
 
+	protected $query = '';
+
 	public function test_get_term_by_slug() {
 		$term1 = wp_insert_term( 'Foo', 'category', array( 'slug' => 'foo' ) );
 		$term2 = get_term_by( 'slug', 'foo', 'category' );
@@ -123,7 +125,7 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 
 		$num_queries = $wpdb->num_queries;
 		$found       = get_term_by( 'slug', 'foo', 'wptests_tax' );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 
 		$this->assertInstanceOf( 'WP_Term', $found );
 		$this->assertSame( $t, $found->term_id );
@@ -194,7 +196,7 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 	public function test_query_should_not_contain_order_by_clause() {
 		global $wpdb;
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'burrito',
 				'taxonomy' => 'post_tag',
@@ -209,17 +211,16 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 	 * @ticket 21760
 	 */
 	public function test_query_should_contain_limit_clause() {
-		global $wpdb;
-
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => 'burrito',
 				'taxonomy' => 'post_tag',
 			)
 		);
-		$found   = get_term_by( 'name', 'burrito', 'post_tag' );
+		add_filter( 'terms_pre_query', array( $this, 'get_query_from_filter' ), 10, 2 );
+		$found = get_term_by( 'name', 'burrito', 'post_tag' );
 		$this->assertSame( $term_id, $found->term_id );
-		$this->assertStringContainsString( 'LIMIT 1', $wpdb->last_query );
+		$this->assertStringContainsString( 'LIMIT 1', $this->query );
 	}
 
 	/**
@@ -241,7 +242,7 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 	public function test_get_term_by_name_with_string_0() {
 		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'name'     => '0',
 				'taxonomy' => 'wptests_tax',
@@ -258,7 +259,7 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 	public function test_get_term_by_slug_with_string_0() {
 		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
 
-		$term_id = $this->factory->term->create(
+		$term_id = self::factory()->term->create(
 			array(
 				'taxonomy' => 'wptests_tax',
 				'name'     => '0',
@@ -282,4 +283,10 @@ class Tests_Term_GetTermBy extends WP_UnitTestCase {
 		$this->assertFalse( $found_by_slug );
 		$this->assertFalse( $found_by_name );
 	}
+
+	public function get_query_from_filter( $terms, $wp_term_query ) {
+		$this->query = $wp_term_query->request;
+
+		return $terms;
+	}
 }
diff --git a/tests/term/getTermField.php b/tests/term/getTermField.php
index a5a132a9b4..c69044564c 100644
--- a/tests/term/getTermField.php
+++ b/tests/term/getTermField.php
@@ -91,7 +91,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_field_name() {
-		$name = rand_str( 15 );
+		$name = 'baz';
 
 		$term = self::factory()->term->create_and_get(
 			array(
@@ -106,7 +106,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_field_slug_when_slug_is_set() {
-		$slug = rand_str( 15 );
+		$slug = 'baz';
 
 		$term = self::factory()->term->create_and_get(
 			array(
@@ -121,7 +121,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_field_slug_when_slug_falls_back_from_name() {
-		$name = rand_str( 15 );
+		$name = 'baz';
 
 		$term = self::factory()->term->create_and_get(
 			array(
@@ -156,7 +156,7 @@ class Tests_Term_getTermField extends WP_UnitTestCase {
 	}
 
 	public function test_get_term_field_description() {
-		$desc = wpautop( rand_str() );
+		$desc = wpautop( 'baz' );
 
 		$term = self::factory()->term->create_and_get(
 			array(
diff --git a/tests/term/getTermLink.php b/tests/term/getTermLink.php
index 3522464cd1..2a92d8afee 100644
--- a/tests/term/getTermLink.php
+++ b/tests/term/getTermLink.php
@@ -22,6 +22,33 @@ class Tests_Term_GetTermLink extends WP_UnitTestCase {
 		self::register_custom_taxonomy();
 	}
 
+	/**
+	 * Helper to register a custom taxonomy for use in tests.
+	 *
+	 * @since 5.9.0
+	 */
+	private static function register_custom_taxonomy() {
+		register_taxonomy( 'wptests_tax', 'post' );
+	}
+
+	/**
+	 * Helper to get the term for the given taxonomy.
+	 *
+	 * @since 5.9.0
+	 *
+	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
+	 * @param bool   $use_id   Whether to return term ID or term object.
+	 * @return WP_Term|int Term ID if `$use_id` is true, WP_Term instance otherwise.
+	 */
+	private function get_term( $taxonomy, $use_id ) {
+		$term = self::$terms[ $taxonomy ];
+		if ( $use_id ) {
+			$term = $term->term_id;
+		}
+
+		return $term;
+	}
+
 	public function test_integer_should_be_interpreted_as_term_id() {
 		$t1 = self::factory()->term->create(
 			array(
@@ -220,14 +247,14 @@ class Tests_Term_GetTermLink extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_get_term_link
+	 * @dataProvider data_term_link_filter_should_receive_term_object
 	 *
 	 * @ticket 50225
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
+	 * @param string $taxonomy Taxonomy being tested.
+	 * @param bool   $use_id   Whether to pass term ID or term object to `get_term_link()`.
 	 */
-	public function test_get_term_link_filter_is_object_by_term_id( $taxonomy, $use_id ) {
+	public function test_term_link_filter_should_receive_term_object( $taxonomy, $use_id ) {
 		$term = $this->get_term( $taxonomy, $use_id );
 
 		add_filter(
@@ -242,110 +269,65 @@ class Tests_Term_GetTermLink extends WP_UnitTestCase {
 		get_term_link( $term, $taxonomy );
 	}
 
-	/**
-	 * @dataProvider data_get_term_link
-	 *
-	 * @ticket 50225
-	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
-	 */
-	public function test_get_term_link_filter_is_object_by_term_object( $taxonomy, $use_id ) {
-		$term = $this->get_term( $taxonomy, $use_id );
-
-		add_filter(
-			'term_link',
-			function( $location, $term ) {
-				$this->assertInstanceOf( 'WP_Term', $term );
-			},
-			10,
-			2
-		);
-
-		get_term_link( get_term( $term, $taxonomy ), $taxonomy );
-	}
-
-	/**
-	 * @dataProvider data_get_term_link
-	 *
-	 * @ticket 50225
-	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, skip the test.
-	 */
-	public function test_get_term_feed_link_backward_compatibility( $taxonomy, $use_id ) {
-		if ( $use_id ) {
-			$term = $this->get_term( $taxonomy, $use_id );
-
-			$term_feed_link = get_term_feed_link( $term, $taxonomy );
-			$this->assertIsString( $term_feed_link );
-
-			$term_feed_link = get_term_feed_link( $term, '' );
-			$this->assertIsString( $term_feed_link );
-		} else {
-			$this->markTestSkipped( 'This test requires to pass an ID to get_term_feed_link()' );
-		}
-	}
-
 	/**
 	 * Data provider.
 	 *
 	 * @return array
 	 */
-	public function data_get_term_link() {
+	public function data_term_link_filter_should_receive_term_object() {
 		return array(
-			'category passing term_id'          => array(
-				'taxonomy' => 'category',
-				'use_id'   => false,
-			),
-			'category passing term object'      => array(
+			'category passing term_id'              => array(
 				'taxonomy' => 'category',
 				'use_id'   => true,
 			),
-			'post_tag passing term_id'          => array(
-				'taxonomy' => 'post_tag',
+			'category passing term object'          => array(
+				'taxonomy' => 'category',
 				'use_id'   => false,
 			),
-			'post_tag passing term object'      => array(
+			'post_tag passing term_id'              => array(
 				'taxonomy' => 'post_tag',
 				'use_id'   => true,
 			),
-			'a custom taxonomy passing term_id' => array(
-				'taxonomy' => 'wptests_tax',
+			'post_tag passing term object'          => array(
+				'taxonomy' => 'post_tag',
 				'use_id'   => false,
 			),
-			'a custom taxonomy passing term_id' => array(
+			'a custom taxonomy passing term_id'     => array(
 				'taxonomy' => 'wptests_tax',
 				'use_id'   => true,
-				'expected' => 'term.php?taxonomy=custom_taxonomy&tag_ID=%ID%&post_type=post',
+			),
+			'a custom taxonomy passing term object' => array(
+				'taxonomy' => 'wptests_tax',
+				'use_id'   => false,
 			),
 		);
 	}
 
 	/**
-	 * Helper to register a custom taxonomy for use in tests.
+	 * @dataProvider data_get_term_feed_link_should_use_term_taxonomy_when_term_id_is_passed
 	 *
-	 * @since 5.9.0
+	 * @ticket 50225
+	 *
+	 * @param string $taxonomy Taxonomy being tested.
 	 */
-	private static function register_custom_taxonomy() {
-		register_taxonomy( 'wptests_tax', 'post' );
+	public function test_get_term_feed_link_should_use_term_taxonomy_when_term_id_is_passed( $taxonomy ) {
+		$term = $this->get_term( $taxonomy, true );
+
+		$term_feed_link = get_term_feed_link( $term, $taxonomy );
+		$this->assertIsString( $term_feed_link );
+
+		$term_feed_link = get_term_feed_link( $term, '' );
+		$this->assertIsString( $term_feed_link );
 	}
 
 	/**
-	 * Helper to get the term for the given taxonomy.
-	 *
-	 * @since 5.9.0
+	 * Data provider.
 	 *
-	 * @param string $taxonomy Taxonomy being tested (used for index of term keys).
-	 * @param bool   $use_id   When true, pass term ID. Else, pass term object.
-	 * @return WP_Term|int If $use_id is true, term ID is returned; else instance of WP_Term.
+	 * @return array
 	 */
-	private function get_term( $taxonomy, $use_id ) {
-		$term = self::$terms[ $taxonomy ];
-		if ( $use_id ) {
-			$term = $term->term_id;
-		}
+	public function data_get_term_feed_link_should_use_term_taxonomy_when_term_id_is_passed() {
+		$taxonomies = array( 'category', 'post_tag', 'wptests_tax' );
 
-		return $term;
+		return $this->text_array_to_dataprovider( $taxonomies );
 	}
 }
diff --git a/tests/term/getTerms.php b/tests/term/getTerms.php
index 70ead58e51..9b4bc16640 100644
--- a/tests/term/getTerms.php
+++ b/tests/term/getTerms.php
@@ -4,13 +4,40 @@
  * @group taxonomy
  */
 class Tests_Term_getTerms extends WP_UnitTestCase {
+
+	protected static $taxonomy = 'wptests_tax_3';
+
 	public function set_up() {
 		parent::set_up();
 
+		register_taxonomy( self::$taxonomy, 'post', array( 'hierarchical' => true ) );
+
 		_clean_term_filters();
 		wp_cache_delete( 'last_changed', 'terms' );
 	}
 
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		register_taxonomy( self::$taxonomy, 'page', array( 'hierarchical' => true ) );
+		$term_id1 = $factory->term->create(
+			array(
+				'name'     => 'Foo',
+				'slug'     => 'Foo',
+				'taxonomy' => self::$taxonomy,
+			)
+		);
+		$term_id2 = $factory->term->create(
+			array(
+				'name'     => 'Bar',
+				'slug'     => 'bar',
+				'taxonomy' => self::$taxonomy,
+			)
+		);
+		$posts    = $factory->post->create_many( 3, array( 'post_type' => 'page' ) );
+		foreach ( $posts as $i => $post ) {
+			wp_set_object_terms( $post, array( $term_id1, $term_id2 ), self::$taxonomy );
+		}
+	}
+
 	/**
 	 * @ticket 37568
 	 */
@@ -118,7 +145,7 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$this->assertCount( 3, $terms );
 		$time1 = wp_cache_get( 'last_changed', 'terms' );
 		$this->assertNotEmpty( $time1 );
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		$this->assertSame( $num_queries + 2, $wpdb->num_queries );
 
 		$num_queries = $wpdb->num_queries;
 
@@ -719,6 +746,27 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$this->assertCount( 1, $terms );
 	}
 
+	/**
+	 * @ticket 55837
+	 * @covers ::get_terms
+	 */
+	public function test_get_terms_child_of_cache() {
+		$parent = self::factory()->category->create();
+		self::factory()->category->create( array( 'parent' => $parent ) );
+
+		$args  = array(
+			'fields'     => 'ids',
+			'child_of'   => $parent,
+			'hide_empty' => false,
+		);
+		$terms = get_terms( 'category', $args );
+		$this->assertCount( 1, $terms, 'The first call to get_terms() did not return 1 term' );
+
+		$terms2 = get_terms( 'category', $args );
+		$this->assertCount( 1, $terms2, 'The second call to get_terms() did not return 1 term' );
+		$this->assertSameSets( $terms, $terms2, 'Results are not the same after caching' );
+	}
+
 	/**
 	 * @ticket 46768
 	 */
@@ -2562,6 +2610,76 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @ticket 55837
+	 * @covers ::get_terms
+	 */
+	public function test_pad_counts_cached() {
+		register_taxonomy( 'wptests_tax_1', 'post', array( 'hierarchical' => true ) );
+
+		$posts = self::factory()->post->create_many( 3 );
+
+		$t1 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax_1',
+			)
+		);
+		$t2 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax_1',
+				'parent'   => $t1,
+			)
+		);
+		$t3 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax_1',
+				'parent'   => $t2,
+			)
+		);
+
+		wp_set_object_terms( $posts[0], array( $t1 ), 'wptests_tax_1' );
+		wp_set_object_terms( $posts[1], array( $t2 ), 'wptests_tax_1' );
+		wp_set_object_terms( $posts[2], array( $t3 ), 'wptests_tax_1' );
+
+		$found = get_terms(
+			'wptests_tax_1',
+			array(
+				'pad_counts' => true,
+			)
+		);
+
+		$this->assertSameSets( array( $t1, $t2, $t3 ), wp_list_pluck( $found, 'term_id' ), 'Check to see if results are as expected' );
+
+		foreach ( $found as $f ) {
+			if ( $t1 === $f->term_id ) {
+				$this->assertSame( 3, $f->count, 'Check to see if term 1, has the correct count' );
+			} elseif ( $t2 === $f->term_id ) {
+				$this->assertSame( 2, $f->count, 'Check to see if term 2, has the correct count' );
+			} else {
+				$this->assertSame( 1, $f->count, 'Check to see if term 3, has the correct count' );
+			}
+		}
+
+		$found = get_terms(
+			'wptests_tax_1',
+			array(
+				'pad_counts' => true,
+			)
+		);
+
+		$this->assertSameSets( array( $t1, $t2, $t3 ), wp_list_pluck( $found, 'term_id' ), 'Check to see if results are as expected on second run' );
+
+		foreach ( $found as $f ) {
+			if ( $t1 === $f->term_id ) {
+				$this->assertSame( 3, $f->count, 'Check to see if term 1, has the correct count on second run' );
+			} elseif ( $t2 === $f->term_id ) {
+				$this->assertSame( 2, $f->count, 'Check to see if term 2, has the correct count on second run' );
+			} else {
+				$this->assertSame( 1, $f->count, 'Check to see if term 3, has the correct count on second run' );
+			}
+		}
+	}
+
 	/**
 	 * @ticket 20635
 	 */
@@ -2988,6 +3106,273 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$this->assertSameSets( array( $term_id ), wp_list_pluck( $found, 'term_id' ) );
 	}
 
+
+	/**
+	 * @ticket 55352
+	 */
+	public function test_cache_key_generation_cache_domain() {
+		$args_1        = array(
+			'taxonomy' => self::$taxonomy,
+			'fields'   => 'ids',
+		);
+		$args_2        = array_merge( $args_1, array( 'cache_domain' => microtime() ) );
+		$query1        = get_terms( $args_1 );
+		$num_queries_1 = get_num_queries();
+		$query2        = get_terms( $args_2 );
+		$this->assertNotSame( $num_queries_1, get_num_queries() );
+		$this->assertSameSets( $query1, $query2 );
+	}
+
+	/**
+	 * @ticket 55352
+	 */
+	public function test_cache_key_generation_all_with_object_id() {
+		$args_1        = array(
+			'taxonomy' => self::$taxonomy,
+			'fields'   => 'ids',
+		);
+		$args_2        = array_merge( $args_1, array( 'fields' => 'all_with_object_id' ) );
+		$query1        = get_terms( $args_1 );
+		$num_queries_1 = get_num_queries();
+		$query2        = get_terms( $args_2 );
+		$this->assertNotSame( $num_queries_1, get_num_queries() );
+		$this->assertSameSets( $query1, wp_list_pluck( $query2, 'term_id' ) );
+	}
+
+
+	/**
+	 * @ticket 55352
+	 *
+	 * @dataProvider data_same_term_args
+	 */
+	public function test_cache_key_generation( $args_1, $args_2 ) {
+		$query1        = get_terms( $args_1 );
+		$num_queries_1 = get_num_queries();
+		$query2        = get_terms( $args_2 );
+		$this->assertSame( $num_queries_1, get_num_queries() );
+		$this->assertSame( count( $query1 ), count( $query2 ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_same_term_args() {
+		return array(
+			'all fields vs ids'                        => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+				),
+			),
+			'array taxonomy vs string taxonomy'        => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+				),
+				array(
+					'taxonomy' => array( self::$taxonomy ),
+					'fields'   => 'all',
+				),
+			),
+			'slug fields vs names fields'              => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'names',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'slugs',
+				),
+			),
+			'array slug vs string slug'                => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'slug'     => '',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'slug'     => array(),
+				),
+			),
+			'array object_ids vs string object_ids'    => array(
+				array(
+					'taxonomy'   => self::$taxonomy,
+					'fields'     => 'all',
+					'object_ids' => '',
+				),
+				array(
+					'taxonomy'   => self::$taxonomy,
+					'fields'     => 'all',
+					'object_ids' => array(),
+				),
+			),
+			'array term_taxonomy_id vs string term_taxonomy_id' => array(
+				array(
+					'taxonomy'         => self::$taxonomy,
+					'fields'           => 'ids',
+					'term_taxonomy_id' => '',
+				),
+				array(
+					'taxonomy'         => self::$taxonomy,
+					'fields'           => 'all',
+					'term_taxonomy_id' => array(),
+				),
+			),
+			'array exclude vs no exclude'              => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'exclude'  => array(),
+				),
+			),
+			'array exclude vs zero exclude'            => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+					'exclude'  => 0,
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'exclude'  => array(),
+				),
+			),
+			'array exclude vs string exclude'          => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+					'exclude'  => '',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'exclude'  => array(),
+				),
+			),
+			'array include vs no include'              => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'include'  => array(),
+				),
+			),
+			'array include vs zero include'            => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+					'include'  => 0,
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'include'  => array(),
+				),
+			),
+			'array include vs string include'          => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+					'include'  => '',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'include'  => array(),
+				),
+			),
+			'array 1 slug vs string slug'              => array(
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'ids',
+					'slug'     => 'bar',
+				),
+				array(
+					'taxonomy' => self::$taxonomy,
+					'fields'   => 'all',
+					'slug'     => array( 'bar' ),
+				),
+			),
+			'int object_ids vs array object_ids'       => array(
+				array(
+					'taxonomy'   => self::$taxonomy,
+					'fields'     => 'ids',
+					'object_ids' => 1,
+				),
+				array(
+					'taxonomy'   => self::$taxonomy,
+					'fields'     => 'all',
+					'object_ids' => array( 1 ),
+				),
+			),
+			'string object_ids vs array object_ids'    => array(
+				array(
+					'taxonomy'   => self::$taxonomy,
+					'fields'     => 'ids',
+					'object_ids' => '1',
+				),
+				array(
+					'taxonomy'   => self::$taxonomy,
+					'fields'     => 'all',
+					'object_ids' => array( 1 ),
+				),
+			),
+			'int term_taxonomy_id vs array term_taxonomy_id and fields different' => array(
+				array(
+					'taxonomy'         => self::$taxonomy,
+					'fields'           => 'ids',
+					'term_taxonomy_id' => 1,
+				),
+				array(
+					'taxonomy'         => self::$taxonomy,
+					'fields'           => 'all',
+					'term_taxonomy_id' => array( 1 ),
+				),
+			),
+			'same arguments in a different order'      => array(
+				array(
+					'fields'           => 'ids',
+					'taxonomy'         => self::$taxonomy,
+					'term_taxonomy_id' => 1,
+				),
+				array(
+					'term_taxonomy_id' => 1,
+					'taxonomy'         => self::$taxonomy,
+					'fields'           => 'ids',
+				),
+			),
+			'invalid arguments discarded in cache key' => array(
+				array(
+					'fields'           => 'ids',
+					'taxonomy'         => self::$taxonomy,
+					'term_taxonomy_id' => 1,
+					'ticket_number'    => '55352',
+				),
+				array(
+					'fields'           => 'all',
+					'taxonomy'         => self::$taxonomy,
+					'term_taxonomy_id' => array( 1 ),
+					'focus'            => 'performance',
+				),
+			),
+		);
+	}
+
 	/**
 	 * @ticket 21760
 	 */
diff --git a/tests/term/isObjectInTerm.php b/tests/term/isObjectInTerm.php
index 9e4937fd6e..457b0e528c 100644
--- a/tests/term/isObjectInTerm.php
+++ b/tests/term/isObjectInTerm.php
@@ -145,7 +145,7 @@ class Tests_IsObjectInTerm extends WP_UnitTestCase {
 
 		$num_queries = $wpdb->num_queries;
 		$this->assertTrue( is_object_in_term( $o, 'wptests_tax', $terms[0] ) );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 
 		$this->assertFalse( is_object_in_term( $o, 'wptests_tax', $terms[1] ) );
@@ -166,14 +166,14 @@ class Tests_IsObjectInTerm extends WP_UnitTestCase {
 
 		$num_queries = $wpdb->num_queries;
 		$this->assertTrue( is_object_in_term( $o, 'wptests_tax', $terms[0] ) );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 
 		wp_set_object_terms( $o, $terms[1], 'wptests_tax' );
 
 		$num_queries = $wpdb->num_queries;
 		$this->assertTrue( is_object_in_term( $o, 'wptests_tax', $terms[1] ) );
-		$num_queries++;
+		$num_queries = $num_queries + 2;
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 	}
 
diff --git a/tests/term/isTermPubliclyViewable.php b/tests/term/isTermPubliclyViewable.php
new file mode 100644
index 0000000000..0ddddf137c
--- /dev/null
+++ b/tests/term/isTermPubliclyViewable.php
@@ -0,0 +1,56 @@
+<?php
+
+/**
+ * @group term
+ *
+ * @covers ::is_term_publicly_viewable
+ */
+class Tests_Term_IsTermPubliclyViewable extends WP_UnitTestCase {
+	/**
+	 * Unit tests for is_term_publicly_viewable().
+	 *
+	 * @ticket 56215
+	 */
+	public function test_non_existent_term_is_not_publicly_viewable() {
+		$this->assertFalse( is_term_publicly_viewable( 123 ) );
+	}
+
+	/**
+	 * Unit tests for is_term_publicly_viewable().
+	 *
+	 * @dataProvider data_is_term_publicly_viewable
+	 * @ticket 56215
+	 *
+	 * @param string $taxonomy The taxonomy name.
+	 * @param bool   $expected The expected result of the function call.
+	 */
+	public function test_is_term_publicly_viewable( $taxonomy, $expected ) {
+		$term_id = self::factory()->term->create(
+			array(
+				'taxonomy' => $taxonomy,
+			)
+		);
+
+		$this->assertSame( $expected, is_term_publicly_viewable( $term_id ) );
+	}
+
+	/**
+	 * Data provider for test_is_term_publicly_viewable().
+	 *
+	 * return array[] {
+	 *     @type string $taxonomy The taxonomy.
+	 *     @type bool   $expected The expected result of the function call.
+	 * }
+	 */
+	public function data_is_term_publicly_viewable() {
+		return array(
+			array( 'category', true ),
+			array( 'post_tag', true ),
+			array( 'post_format', true ),
+
+			array( 'nav_menu', false ),
+			array( 'wp_theme', false ),
+			array( 'wp_template_part_area', false ),
+		);
+	}
+}
diff --git a/tests/term/query.php b/tests/term/query.php
index a34a3027a9..ca0e21b09c 100644
--- a/tests/term/query.php
+++ b/tests/term/query.php
@@ -4,6 +4,27 @@
  * @group taxonomy
  */
 class Tests_Term_Query extends WP_UnitTestCase {
+
+	/**
+	 * Temporary storage for a term ID for tests using filter callbacks.
+	 *
+	 * Used in the following tests:
+	 * - `test_null_term_object_should_be_discarded()`
+	 * - `test_error_term_object_should_be_discarded()`
+	 *
+	 * @var int
+	 */
+	private $term_id;
+
+	/**
+	 * Clean up after each test.
+	 */
+	public function tear_down() {
+		unset( $this->term_id );
+
+		parent::tear_down();
+	}
+
 	/**
 	 * @ticket 37545
 	 */
diff --git a/tests/term/slashes.php b/tests/term/slashes.php
index 79944a3157..ffe5bf74d9 100644
--- a/tests/term/slashes.php
+++ b/tests/term/slashes.php
@@ -6,6 +6,20 @@
  * @ticket 21767
  */
 class Tests_Term_Slashes extends WP_Ajax_UnitTestCase {
+
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
+
 	protected static $author_id;
 
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
@@ -16,14 +30,6 @@ class Tests_Term_Slashes extends WP_Ajax_UnitTestCase {
 		parent::set_up();
 
 		wp_set_current_user( self::$author_id );
-
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 	}
 
 	/**
@@ -36,40 +42,40 @@ class Tests_Term_Slashes extends WP_Ajax_UnitTestCase {
 		);
 		foreach ( $taxonomies as $taxonomy ) {
 			$insert = wp_insert_term(
-				$this->slash_1,
+				self::SLASH_1,
 				$taxonomy,
 				array(
 					'slug'        => 'slash_test_1_' . $taxonomy,
-					'description' => $this->slash_3,
+					'description' => self::SLASH_3,
 				)
 			);
 			$term   = get_term( $insert['term_id'], $taxonomy );
-			$this->assertSame( wp_unslash( $this->slash_1 ), $term->name );
-			$this->assertSame( wp_unslash( $this->slash_3 ), $term->description );
+			$this->assertSame( wp_unslash( self::SLASH_1 ), $term->name );
+			$this->assertSame( wp_unslash( self::SLASH_3 ), $term->description );
 
 			$insert = wp_insert_term(
-				$this->slash_3,
+				self::SLASH_3,
 				$taxonomy,
 				array(
 					'slug'        => 'slash_test_2_' . $taxonomy,
-					'description' => $this->slash_5,
+					'description' => self::SLASH_5,
 				)
 			);
 			$term   = get_term( $insert['term_id'], $taxonomy );
-			$this->assertSame( wp_unslash( $this->slash_3 ), $term->name );
-			$this->assertSame( wp_unslash( $this->slash_5 ), $term->description );
+			$this->assertSame( wp_unslash( self::SLASH_3 ), $term->name );
+			$this->assertSame( wp_unslash( self::SLASH_5 ), $term->description );
 
 			$insert = wp_insert_term(
-				$this->slash_2,
+				self::SLASH_2,
 				$taxonomy,
 				array(
 					'slug'        => 'slash_test_3_' . $taxonomy,
-					'description' => $this->slash_4,
+					'description' => self::SLASH_4,
 				)
 			);
 			$term   = get_term( $insert['term_id'], $taxonomy );
-			$this->assertSame( wp_unslash( $this->slash_2 ), $term->name );
-			$this->assertSame( wp_unslash( $this->slash_4 ), $term->description );
+			$this->assertSame( wp_unslash( self::SLASH_2 ), $term->name );
+			$this->assertSame( wp_unslash( self::SLASH_4 ), $term->description );
 		}
 	}
 
@@ -92,38 +98,38 @@ class Tests_Term_Slashes extends WP_Ajax_UnitTestCase {
 				$term_id,
 				$taxonomy,
 				array(
-					'name'        => $this->slash_1,
-					'description' => $this->slash_3,
+					'name'        => self::SLASH_1,
+					'description' => self::SLASH_3,
 				)
 			);
 
 			$term = get_term( $term_id, $taxonomy );
-			$this->assertSame( wp_unslash( $this->slash_1 ), $term->name );
-			$this->assertSame( wp_unslash( $this->slash_3 ), $term->description );
+			$this->assertSame( wp_unslash( self::SLASH_1 ), $term->name );
+			$this->assertSame( wp_unslash( self::SLASH_3 ), $term->description );
 
 			$update = wp_update_term(
 				$term_id,
 				$taxonomy,
 				array(
-					'name'        => $this->slash_3,
-					'description' => $this->slash_5,
+					'name'        => self::SLASH_3,
+					'description' => self::SLASH_5,
 				)
 			);
 			$term   = get_term( $term_id, $taxonomy );
-			$this->assertSame( wp_unslash( $this->slash_3 ), $term->name );
-			$this->assertSame( wp_unslash( $this->slash_5 ), $term->description );
+			$this->assertSame( wp_unslash( self::SLASH_3 ), $term->name );
+			$this->assertSame( wp_unslash( self::SLASH_5 ), $term->description );
 
 			$update = wp_update_term(
 				$term_id,
 				$taxonomy,
 				array(
-					'name'        => $this->slash_2,
-					'description' => $this->slash_4,
+					'name'        => self::SLASH_2,
+					'description' => self::SLASH_4,
 				)
 			);
 			$term   = get_term( $term_id, $taxonomy );
-			$this->assertSame( wp_unslash( $this->slash_2 ), $term->name );
-			$this->assertSame( wp_unslash( $this->slash_4 ), $term->description );
+			$this->assertSame( wp_unslash( self::SLASH_2 ), $term->name );
+			$this->assertSame( wp_unslash( self::SLASH_4 ), $term->description );
 		}
 	}
 }
diff --git a/tests/term/splitSharedTerm.php b/tests/term/splitSharedTerm.php
index 65cefe8c4a..ece1d534ad 100644
--- a/tests/term/splitSharedTerm.php
+++ b/tests/term/splitSharedTerm.php
@@ -54,6 +54,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 			array( '%d' ),
 			array( '%d' )
 		);
+		clean_term_cache( $t1['term_id'], 'category' );
 
 		$t2_child = wp_insert_term(
 			'Foo Child',
@@ -151,6 +152,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 			array( '%d' ),
 			array( '%d' )
 		);
+		clean_term_cache( $t1['term_id'], 'category' );
 		$th = _get_term_hierarchy( 'wptests_tax_4' );
 
 		$new_term_id = _split_shared_term( $t1['term_id'], $t3['term_taxonomy_id'] );
@@ -179,6 +181,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 			array( '%d' ),
 			array( '%d' )
 		);
+		clean_term_cache( $t1['term_id'], 'category' );
 
 		$this->assertSame( $t1['term_id'], get_option( 'default_category', -1 ) );
 
@@ -207,8 +210,9 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 			array( '%d' ),
 			array( '%d' )
 		);
+		clean_term_cache( $t1['term_id'], 'category' );
 
-		$menu_id       = wp_create_nav_menu( rand_str() );
+		$menu_id       = wp_create_nav_menu( 'Nav Menu Bar' );
 		$cat_menu_item = wp_update_nav_menu_item(
 			$menu_id,
 			0,
@@ -245,6 +249,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 			array( 'term_id' => $shared_term_id ),
 			array( 'term_taxonomy_id' => $nav_term->term_taxonomy_id )
 		);
+		clean_term_cache( $shared_term_id, 'category' );
 
 		set_theme_mod( 'nav_menu_locations', array( 'foo' => $shared_term_id ) );
 
@@ -274,6 +279,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 			array( 'term_id' => $shared_term_id ),
 			array( 'term_taxonomy_id' => $nav_term->term_taxonomy_id )
 		);
+		clean_term_cache( $shared_term_id, 'category' );
 
 		$t1            = wp_insert_term( 'Random term', 'category' );
 		$cat_menu_item = wp_update_nav_menu_item(
diff --git a/tests/term/termCounts.php b/tests/term/termCounts.php
index 34cc032cda..a0df17eb34 100644
--- a/tests/term/termCounts.php
+++ b/tests/term/termCounts.php
@@ -90,7 +90,7 @@ class Tests_Term_termCount extends WP_UnitTestCase {
 	public function test_term_count_changes_for_post_statuses( $post_status, $change ) {
 		$term_count = get_term( get_option( 'default_category' ) )->count;
 		// Do not use shared fixture for this test as it relies on a new post.
-		$post_id = $this->factory()->post->create( array( 'post_status' => $post_status ) );
+		$post_id = self::factory()->post->create( array( 'post_status' => $post_status ) );
 
 		$expected = $term_count + $change;
 		$this->assertSame( $expected, get_term( get_option( 'default_category' ) )->count );
@@ -244,7 +244,7 @@ class Tests_Term_termCount extends WP_UnitTestCase {
 
 		add_filter( 'update_post_term_count_statuses', array( $this, 'add_custom_status_to_counted_statuses' ) );
 
-		$post_id = $this->factory()->post->create( array( 'post_status' => $post_status ) );
+		$post_id = self::factory()->post->create( array( 'post_status' => $post_status ) );
 		wp_add_object_terms( $post_id, self::$attachment_term, 'wp_test_tax_counts' );
 		$attachment_id = self::factory()->attachment->create_object(
 			array(
@@ -296,7 +296,7 @@ class Tests_Term_termCount extends WP_UnitTestCase {
 	public function test_term_count_changes_for_post_statuses_with_attachments( $post_status, $change ) {
 		$term_count = get_term( self::$attachment_term )->count;
 		// Do not use shared fixture for this test as it relies on a new post.
-		$post_id = $this->factory()->post->create( array( 'post_status' => $post_status ) );
+		$post_id = self::factory()->post->create( array( 'post_status' => $post_status ) );
 		wp_add_object_terms( $post_id, self::$attachment_term, 'wp_test_tax_counts' );
 		$attachment_id = self::factory()->attachment->create_object(
 			array(
diff --git a/tests/term/termExists.php b/tests/term/termExists.php
index bb4381036b..c50cf7086d 100644
--- a/tests/term/termExists.php
+++ b/tests/term/termExists.php
@@ -260,7 +260,7 @@ class Tests_TermExists extends WP_UnitTestCase {
 		register_taxonomy( 'wptests_tax', 'post' );
 
 		// Insert a term.
-		$term = rand_str();
+		$term = __FUNCTION__;
 		$t    = wp_insert_term( $term, 'wptests_tax' );
 		$this->assertIsArray( $t );
 		$this->assertEquals( $t['term_id'], term_exists( $t['term_id'] ) );
@@ -271,6 +271,132 @@ class Tests_TermExists extends WP_UnitTestCase {
 		_unregister_taxonomy( 'wptests_tax' );
 	}
 
+	/**
+	 * @ticket 36949
+	 * @covers ::term_exists()
+	 */
+	public function test_term_lookup_by_id_and_update() {
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$slug = __FUNCTION__;
+		$t    = self::factory()->term->create(
+			array(
+				'slug'     => $slug,
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+		$this->assertEquals( $t, term_exists( $t ) );
+		$this->assertTrue( wp_delete_term( $t, 'wptests_tax' ) );
+		$this->assertNull( term_exists( $t ) );
+
+		// Clean up.
+		_unregister_taxonomy( 'wptests_tax' );
+	}
+
+	/**
+	 * @ticket 36949
+	 * @covers ::term_exists()
+	 */
+	public function test_term_lookup_by_slug_and_update() {
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$slug = __FUNCTION__;
+		$t    = self::factory()->term->create(
+			array(
+				'slug'     => $slug,
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+		$this->assertEquals( $t, term_exists( $slug ) );
+		$this->assertTrue( wp_delete_term( $t, 'wptests_tax' ) );
+		$this->assertNull( term_exists( $slug ) );
+
+		// Clean up.
+		_unregister_taxonomy( 'wptests_tax' );
+	}
+
+	/**
+	 * @ticket 36949
+	 * @covers ::term_exists()
+	 */
+	public function test_term_exists_caching() {
+		global $wpdb;
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$slug = __FUNCTION__;
+		$t    = self::factory()->term->create(
+			array(
+				'slug'     => $slug,
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+		$this->assertEquals( $t, term_exists( $slug ) );
+		$num_queries = $wpdb->num_queries;
+		$this->assertEquals( $t, term_exists( $slug ) );
+		$this->assertSame( $num_queries, $wpdb->num_queries );
+
+		$this->assertTrue( wp_delete_term( $t, 'wptests_tax' ) );
+		$num_queries = $wpdb->num_queries;
+		$this->assertNull( term_exists( $slug ) );
+		$this->assertSame( $num_queries + 2, $wpdb->num_queries );
+
+		// Clean up.
+		_unregister_taxonomy( 'wptests_tax' );
+	}
+
+	/**
+	 * @ticket 36949
+	 * @covers ::term_exists()
+	 */
+	public function test_term_exists_caching_suspend_cache_invalidation() {
+		global $wpdb;
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		wp_suspend_cache_invalidation( true );
+		$slug = __FUNCTION__;
+		$t    = self::factory()->term->create(
+			array(
+				'slug'     => $slug,
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+
+		$this->assertEquals( $t, term_exists( $slug ) );
+		$num_queries = $wpdb->num_queries;
+		$this->assertEquals( $t, term_exists( $slug ) );
+		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+		wp_suspend_cache_invalidation( false );
+
+		// Clean up.
+		_unregister_taxonomy( 'wptests_tax' );
+	}
+
+	/**
+	 * @ticket 36949
+	 * @covers ::term_exists()
+	 */
+	public function test_term_exists_caching_by_int_suspend_cache_invalidation() {
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$slug = __FUNCTION__;
+		$t    = self::factory()->term->create(
+			array(
+				'slug'     => $slug,
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+
+		// Warm cache in get_term() via term_exists().
+		term_exists( $t );
+		wp_suspend_cache_invalidation( true );
+		wp_delete_term( $t, 'wptests_tax' );
+		$this->assertNull( term_exists( $t ) );
+
+		// Reneable cache invalidation.
+		wp_suspend_cache_invalidation( false );
+		_unregister_taxonomy( 'wptests_tax' );
+	}
+
 	public function test_term_exists_unknown() {
 		$this->assertNull( term_exists( rand_str() ) );
 		$this->assertSame( 0, term_exists( 0 ) );
diff --git a/tests/term/wpGenerateTagCloud.php b/tests/term/wpGenerateTagCloud.php
index eff3a3d6bb..d1b02bb04d 100644
--- a/tests/term/wpGenerateTagCloud.php
+++ b/tests/term/wpGenerateTagCloud.php
@@ -295,8 +295,6 @@ class Tests_WP_Generate_Tag_Cloud extends WP_UnitTestCase {
 	/**
 	 * Helper method retrieve the created terms.
 	 *
-	 * @uses get_terms
-	 *
 	 * @param array $get_terms_args Options passed to get_terms()
 	 *
 	 * @return array
diff --git a/tests/term/wpGetObjectTerms.php b/tests/term/wpGetObjectTerms.php
index 429086e2c2..f246fccf71 100644
--- a/tests/term/wpGetObjectTerms.php
+++ b/tests/term/wpGetObjectTerms.php
@@ -7,11 +7,29 @@
 class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 	private $taxonomy = 'wptests_tax';
 
+	/**
+	 * Temporary storage for taxonomies for tests using filter callbacks.
+	 *
+	 * Used in the `test_taxonomies_passed_to_wp_get_object_terms_filter_should_be_quoted()` method.
+	 *
+	 * @var array
+	 */
+	private $taxonomies;
+
 	public function set_up() {
 		parent::set_up();
 		register_taxonomy( 'wptests_tax', 'post' );
 	}
 
+	/**
+	 * Clean up after each test.
+	 */
+	public function tear_down() {
+		unset( $this->taxonomies );
+
+		parent::tear_down();
+	}
+
 	public function test_get_object_terms_by_slug() {
 		$post_id = self::factory()->post->create();
 
@@ -447,6 +465,8 @@ class Tests_Term_WpGetObjectTerms extends WP_UnitTestCase {
 		$wpdb->update( $wpdb->term_taxonomy, array( 'term_taxonomy_id' => 100006 ), array( 'term_taxonomy_id' => $term_2->term_taxonomy_id ) );
 		$wpdb->update( $wpdb->term_taxonomy, array( 'term_taxonomy_id' => 100005 ), array( 'term_taxonomy_id' => $term_3->term_taxonomy_id ) );
 
+		clean_term_cache( array( $t1, $t2, $t3 ), $this->taxonomy );
+
 		$set = wp_set_object_terms( $p, array( $t1, $t2, $t3 ), $this->taxonomy );
 
 		$found = wp_get_object_terms(
diff --git a/tests/term/wpSetObjectTerms.php b/tests/term/wpSetObjectTerms.php
index b0da2fa3d6..8032a50e79 100644
--- a/tests/term/wpSetObjectTerms.php
+++ b/tests/term/wpSetObjectTerms.php
@@ -133,9 +133,9 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 		$ids = self::$post_ids;
 
 		$terms = array(
-			rand_str(),
-			rand_str(),
-			rand_str(),
+			'term0',
+			'term1',
+			'term2',
 		);
 
 		foreach ( $ids as $id ) {
@@ -164,7 +164,7 @@ class Tests_Term_WpSetObjectTerms extends WP_UnitTestCase {
 
 	public function test_set_object_terms_invalid() {
 		// Bogus taxonomy.
-		$result = wp_set_object_terms( self::$post_ids[0], array( rand_str() ), rand_str() );
+		$result = wp_set_object_terms( self::$post_ids[0], array( 'foo' ), 'invalid-taxonomy' );
 		$this->assertWPError( $result );
 	}
 
diff --git a/tests/term/wpTaxonomy.php b/tests/term/wpTaxonomy.php
index a8689284c2..8914228dc4 100644
--- a/tests/term/wpTaxonomy.php
+++ b/tests/term/wpTaxonomy.php
@@ -18,7 +18,7 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		/* @var WP $wp */
 		global $wp;
 
-		$taxonomy        = rand_str();
+		$taxonomy        = 'taxonomy1';
 		$taxonomy_object = new WP_Taxonomy( $taxonomy, 'post' );
 
 		$taxonomy_object->add_rewrite_rules();
@@ -31,7 +31,7 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		/* @var WP $wp */
 		global $wp;
 
-		$taxonomy        = rand_str();
+		$taxonomy        = 'taxonomy2';
 		$taxonomy_object = new WP_Taxonomy(
 			$taxonomy,
 			'post',
@@ -58,7 +58,7 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		/* @var WP_Rewrite $wp_rewrite */
 		global $wp_rewrite;
 
-		$taxonomy        = rand_str();
+		$taxonomy        = 'taxonomy3';
 		$taxonomy_object = new WP_Taxonomy(
 			$taxonomy,
 			'post',
@@ -79,7 +79,7 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 	}
 
 	public function test_adds_ajax_callback() {
-		$taxonomy        = rand_str();
+		$taxonomy        = 'taxonomy4';
 		$taxonomy_object = new WP_Taxonomy(
 			$taxonomy,
 			'post',
@@ -99,4 +99,17 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		$this->assertFalse( $has_action_after );
 
 	}
+
+	public function test_applies_registration_args_filters() {
+		$taxonomy = 'taxonomy5';
+		$action   = new MockAction();
+
+		add_filter( 'register_taxonomy_args', array( $action, 'filter' ) );
+		add_filter( "register_{$taxonomy}_taxonomy_args", array( $action, 'filter' ) );
+
+		new WP_Taxonomy( $taxonomy, 'post' );
+		new WP_Taxonomy( 'random', 'post' );
+
+		$this->assertSame( 3, $action->get_call_count() );
+	}
 }
diff --git a/tests/theme.php b/tests/theme.php
index 32ca5dae36..10871c8a2b 100644
--- a/tests/theme.php
+++ b/tests/theme.php
@@ -23,13 +23,20 @@ class Tests_Theme extends WP_UnitTestCase {
 		'twentytwentytwo',
 	);
 
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string[]
+	 */
+	private $orig_theme_dir;
+
 	public function set_up() {
 		global $wp_theme_directories;
 
 		parent::set_up();
 
-		$backup_wp_theme_directories = $wp_theme_directories;
-		$wp_theme_directories        = array( WP_CONTENT_DIR . '/themes' );
+		$this->orig_theme_dir = $wp_theme_directories;
+		$wp_theme_directories = array( WP_CONTENT_DIR . '/themes' );
 
 		add_filter( 'extra_theme_headers', array( $this, 'theme_data_extra_headers' ) );
 		wp_clean_themes_cache();
@@ -39,7 +46,7 @@ class Tests_Theme extends WP_UnitTestCase {
 	public function tear_down() {
 		global $wp_theme_directories;
 
-		$wp_theme_directories = $this->wp_theme_directories;
+		$wp_theme_directories = $this->orig_theme_dir;
 
 		remove_filter( 'extra_theme_headers', array( $this, 'theme_data_extra_headers' ) );
 		wp_clean_themes_cache();
@@ -213,7 +220,7 @@ class Tests_Theme extends WP_UnitTestCase {
 	 * @ticket 48566
 	 */
 	public function test_year_in_readme() {
-		// This test is designed to only run on trunk/master.
+		// This test is designed to only run on trunk.
 		$this->skipOnAutomatedBranches();
 
 		foreach ( $this->default_themes as $theme ) {
@@ -221,17 +228,22 @@ class Tests_Theme extends WP_UnitTestCase {
 
 			$path_to_readme_txt = $wp_theme->get_theme_root() . '/' . $wp_theme->get_stylesheet() . '/readme.txt';
 			$this->assertFileExists( $path_to_readme_txt );
+
 			$readme    = file_get_contents( $path_to_readme_txt );
 			$this_year = gmdate( 'Y' );
 
 			preg_match( '#Copyright (\d+) WordPress.org#', $readme, $matches );
 			if ( $matches ) {
-				$this->assertSame( $this_year, trim( $matches[1] ), "Bundled themes readme.txt's year needs to be updated to $this_year." );
+				$readme_year = trim( $matches[1] );
+
+				$this->assertSame( $this_year, $readme_year, "Bundled themes readme.txt's year needs to be updated to $this_year." );
 			}
 
 			preg_match( '#Copyright 20\d\d-(\d+) WordPress.org#', $readme, $matches );
 			if ( $matches ) {
-				$this->assertSame( $this_year, trim( $matches[1] ), "Bundled themes readme.txt's year needs to be updated to $this_year." );
+				$readme_year = trim( $matches[1] );
+
+				$this->assertSame( $this_year, $readme_year, "Bundled themes readme.txt's year needs to be updated to $this_year." );
 			}
 		}
 	}
@@ -299,7 +311,7 @@ class Tests_Theme extends WP_UnitTestCase {
 				// get_query_template()
 
 				// Template file that doesn't exist.
-				$this->assertSame( '', get_query_template( rand_str() ) );
+				$this->assertSame( '', get_query_template( 'nonexistant' ) );
 
 				// Template files that do exist.
 				/*
@@ -333,8 +345,8 @@ class Tests_Theme extends WP_UnitTestCase {
 
 	public function test_switch_theme_bogus() {
 		// Try switching to a theme that doesn't exist.
-		$template = rand_str();
-		$style    = rand_str();
+		$template = 'some_template';
+		$style    = 'some_style';
 		update_option( 'template', $template );
 		update_option( 'stylesheet', $style );
 
@@ -354,7 +366,7 @@ class Tests_Theme extends WP_UnitTestCase {
 	 * @covers ::_wp_keep_alive_customize_changeset_dependent_auto_drafts
 	 */
 	public function test_wp_keep_alive_customize_changeset_dependent_auto_drafts() {
-		$nav_created_post_ids = $this->factory()->post->create_many(
+		$nav_created_post_ids = self::factory()->post->create_many(
 			2,
 			array(
 				'post_status' => 'auto-draft',
@@ -700,4 +712,168 @@ class Tests_Theme extends WP_UnitTestCase {
 			),
 		);
 	}
+
+
+	/**
+	 * Tests that block themes support a feature by default.
+	 *
+	 * @ticket 54597
+	 * @ticket 54731
+	 *
+	 * @dataProvider data_block_theme_has_default_support
+	 *
+	 * @covers ::_add_default_theme_supports
+	 *
+	 * @param array $support {
+	 *     The feature to check.
+	 *
+	 *     @type string $feature     The feature to check.
+	 *     @type string $sub_feature Optional. The sub-feature to check.
+	 * }
+	 */
+	public function test_block_theme_has_default_support( $support ) {
+		$this->helper_requires_block_theme();
+
+		$support_data     = array_values( $support );
+		$support_data_str = implode( ': ', $support_data );
+
+		// Remove existing support.
+		if ( current_theme_supports( ...$support_data ) ) {
+			remove_theme_support( ...$support_data );
+		}
+
+		$this->assertFalse(
+			current_theme_supports( ...$support_data ),
+			"Could not remove support for $support_data_str."
+		);
+
+		do_action( 'setup_theme' );
+
+		$this->assertTrue(
+			current_theme_supports( ...$support_data ),
+			"Does not have default support for $support_data_str."
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_block_theme_has_default_support() {
+		return array(
+			'post-thumbnails'      => array(
+				'support' => array(
+					'feature' => 'post-thumbnails',
+				),
+			),
+			'responsive-embeds'    => array(
+				'support' => array(
+					'feature' => 'responsive-embeds',
+				),
+			),
+			'editor-styles'        => array(
+				'support' => array(
+					'feature' => 'editor-styles',
+				),
+			),
+			'html5: comment-list'  => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'comment-list',
+				),
+			),
+			'html5: comment-form'  => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'comment-form',
+				),
+			),
+			'html5: search-form'   => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'search-form',
+				),
+			),
+			'html5: gallery'       => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'gallery',
+				),
+			),
+			'html5: caption'       => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'caption',
+				),
+			),
+			'html5: style'         => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'style',
+				),
+			),
+			'html5: script'        => array(
+				'support' => array(
+					'feature'     => 'html5',
+					'sub_feature' => 'script',
+				),
+			),
+			'automatic-feed-links' => array(
+				'support' => array(
+					'feature' => 'automatic-feed-links',
+				),
+			),
+		);
+	}
+
+	/**
+	 * Tests that block themes load separate core block assets by default.
+	 *
+	 * @ticket 54597
+	 *
+	 * @covers ::_add_default_theme_supports
+	 * @covers ::wp_should_load_separate_core_block_assets
+	 */
+	public function test_block_theme_should_load_separate_core_block_assets_by_default() {
+		$this->helper_requires_block_theme();
+
+		add_filter( 'should_load_separate_core_block_assets', '__return_false' );
+
+		$this->assertFalse(
+			wp_should_load_separate_core_block_assets(),
+			'Could not disable loading separate core block assets.'
+		);
+
+		do_action( 'setup_theme' );
+
+		$this->assertTrue(
+			wp_should_load_separate_core_block_assets(),
+			'Block themes do not load separate core block assets by default.'
+		);
+	}
+
+	/**
+	 * Helper function to ensure that a block theme is available and active.
+	 */
+	private function helper_requires_block_theme() {
+		// No need to switch if we're already on a block theme.
+		if ( wp_is_block_theme() ) {
+			return;
+		}
+
+		$block_theme = 'twentytwentytwo';
+
+		// Skip if the block theme is not available.
+		if ( ! wp_get_theme( $block_theme )->exists() ) {
+			$this->markTestSkipped( "$block_theme must be available." );
+		}
+
+		switch_theme( $block_theme );
+
+		// Skip if we could not switch to the block theme.
+		if ( wp_get_theme()->stylesheet !== $block_theme ) {
+			$this->markTestSkipped( "Could not switch to $block_theme." );
+		}
+	}
 }
diff --git a/tests/theme/customHeader.php b/tests/theme/customHeader.php
index 958462afef..21350deeda 100644
--- a/tests/theme/customHeader.php
+++ b/tests/theme/customHeader.php
@@ -8,6 +8,8 @@ class Tests_Theme_CustomHeader extends WP_UnitTestCase {
 
 	protected static $header_video_id;
 
+	private $customize_manager = null;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$post = self::factory()->post->create(
 			array(
@@ -81,6 +83,59 @@ class Tests_Theme_CustomHeader extends WP_UnitTestCase {
 		$this->assertFalse( $image );
 	}
 
+	/**
+	 * Tests the "get_header_image" filter.
+	 *
+	 * @ticket 56180
+	 *
+	 * @covers get_header_image
+	 *
+	 * @dataProvider data_filter_header_image
+	 *
+	 * @param mixed  $header_image The header image.
+	 * @param string $expected     The expected return value from get_header_image().
+	 */
+	public function test_filter_header_image( $header_image, $expected ) {
+		add_filter(
+			'get_header_image',
+			static function() use ( $header_image ) {
+				return $header_image;
+			}
+		);
+
+		$this->assertSame( $expected, get_header_image() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_filter_header_image() {
+		return array(
+			'an image url'         => array(
+				'header_image' => 'http://example.org/image.png',
+				'expected'     => 'http://example.org/image.png',
+			),
+			'an empty string'      => array(
+				'header_image' => '',
+				'expected'     => '',
+			),
+			'a string with spaces' => array(
+				'header_image' => ' ',
+				'expected'     => '',
+			),
+			'null'                 => array(
+				'header_image' => null,
+				'expected'     => false,
+			),
+			'false'                => array(
+				'header_image' => false,
+				'expected'     => false,
+			),
+		);
+	}
+
 	public function test_get_header_image_tag_without_registered_default_image() {
 		$this->add_theme_support();
 		$html = get_header_image_tag();
diff --git a/tests/theme/support.php b/tests/theme/support.php
index e8e41d257c..aed9d94d3c 100644
--- a/tests/theme/support.php
+++ b/tests/theme/support.php
@@ -76,11 +76,18 @@ class Tests_Theme_Support extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 24932
+	 *
+	 * @expectedIncorrectUsage add_theme_support( 'html5' )
 	 */
 	public function test_supports_html5() {
 		remove_theme_support( 'html5' );
 		$this->assertFalse( current_theme_supports( 'html5' ) );
 		$this->assertFalse( current_theme_supports( 'html5', 'comment-form' ) );
+
+		/*
+		 * If the second parameter is not specified, it should throw a _doing_it_wrong() notice
+		 * and fall back to `array( 'comment-list', 'comment-form', 'search-form' )` for back-compat.
+		 */
 		$this->assertNotFalse( add_theme_support( 'html5' ) );
 		$this->assertTrue( current_theme_supports( 'html5' ) );
 		$this->assertTrue( current_theme_supports( 'html5', 'comment-form' ) );
@@ -98,6 +105,8 @@ class Tests_Theme_Support extends WP_UnitTestCase {
 		remove_theme_support( 'html5' );
 		$this->assertFalse( current_theme_supports( 'html5' ) );
 		$this->assertFalse( current_theme_supports( 'html5', 'comment-form' ) );
+
+		// The second parameter should be an array.
 		$this->assertFalse( add_theme_support( 'html5', 'comment-form' ) );
 		$this->assertNotFalse( add_theme_support( 'html5', array( 'comment-form' ) ) );
 		$this->assertTrue( current_theme_supports( 'html5', 'comment-form' ) );
@@ -149,6 +158,9 @@ class Tests_Theme_Support extends WP_UnitTestCase {
 		return false;
 	}
 
+	/**
+	 * @ticket 11611
+	 */
 	public function test_plugin_hook() {
 		$this->assertFalse( current_theme_supports( 'foobar' ) );
 		add_theme_support( 'foobar' );
@@ -164,6 +176,17 @@ class Tests_Theme_Support extends WP_UnitTestCase {
 		$this->assertFalse( current_theme_supports( 'foobar', 'bar' ) );
 	}
 
+	/**
+	 * @ticket 55219
+	 */
+	public function test_plugin_hook_with_no_args() {
+		add_theme_support( 'foobar' );
+
+		add_filter( 'current_theme_supports-foobar', '__return_false' );
+
+		$this->assertFalse( current_theme_supports( 'foobar' ) );
+	}
+
 	/**
 	 * @ticket 26900
 	 */
diff --git a/tests/theme/themeDir.php b/tests/theme/themeDir.php
index 5255037866..8de4f4189d 100644
--- a/tests/theme/themeDir.php
+++ b/tests/theme/themeDir.php
@@ -7,14 +7,27 @@
  */
 class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	const THEME_ROOT = DIR_TESTDATA . '/themedir1';
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
 	public function set_up() {
 		parent::set_up();
-		$this->theme_root = DIR_TESTDATA . '/themedir1';
 
 		$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
 
 		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
-		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', self::THEME_ROOT );
 
 		add_filter( 'theme_root', array( $this, 'filter_theme_root' ) );
 		add_filter( 'stylesheet_root', array( $this, 'filter_theme_root' ) );
@@ -33,7 +46,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 
 	// Replace the normal theme root directory with our premade test directory.
 	public function filter_theme_root( $dir ) {
-		return $this->theme_root;
+		return self::THEME_ROOT;
 	}
 
 	/**
@@ -57,12 +70,12 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 		$this->assertSame( 'default', $theme['Template'] );
 		$this->assertSame( 'default', $theme['Stylesheet'] );
 
-		$this->assertContains( $this->theme_root . '/default/functions.php', $theme['Template Files'] );
-		$this->assertContains( $this->theme_root . '/default/index.php', $theme['Template Files'] );
-		$this->assertContains( $this->theme_root . '/default/style.css', $theme['Stylesheet Files'] );
+		$this->assertContains( self::THEME_ROOT . '/default/functions.php', $theme['Template Files'] );
+		$this->assertContains( self::THEME_ROOT . '/default/index.php', $theme['Template Files'] );
+		$this->assertContains( self::THEME_ROOT . '/default/style.css', $theme['Stylesheet Files'] );
 
-		$this->assertSame( $this->theme_root . '/default', $theme['Template Dir'] );
-		$this->assertSame( $this->theme_root . '/default', $theme['Stylesheet Dir'] );
+		$this->assertSame( self::THEME_ROOT . '/default', $theme['Template Dir'] );
+		$this->assertSame( self::THEME_ROOT . '/default', $theme['Stylesheet Dir'] );
 		$this->assertSame( 'publish', $theme['Status'] );
 		$this->assertSame( '', $theme['Parent Theme'] );
 	}
@@ -88,15 +101,15 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 
 		$template_files = $theme['Template Files'];
 
-		$this->assertSame( $this->theme_root . '/sandbox/functions.php', reset( $template_files ) );
-		$this->assertSame( $this->theme_root . '/sandbox/index.php', next( $template_files ) );
+		$this->assertSame( self::THEME_ROOT . '/sandbox/functions.php', reset( $template_files ) );
+		$this->assertSame( self::THEME_ROOT . '/sandbox/index.php', next( $template_files ) );
 
 		$stylesheet_files = $theme['Stylesheet Files'];
 
-		$this->assertSame( $this->theme_root . '/sandbox/style.css', reset( $stylesheet_files ) );
+		$this->assertSame( self::THEME_ROOT . '/sandbox/style.css', reset( $stylesheet_files ) );
 
-		$this->assertSame( $this->theme_root . '/sandbox', $theme['Template Dir'] );
-		$this->assertSame( $this->theme_root . '/sandbox', $theme['Stylesheet Dir'] );
+		$this->assertSame( self::THEME_ROOT . '/sandbox', $theme['Template Dir'] );
+		$this->assertSame( self::THEME_ROOT . '/sandbox', $theme['Stylesheet Dir'] );
 		$this->assertSame( 'publish', $theme['Status'] );
 		$this->assertSame( '', $theme['Parent Theme'] );
 
@@ -122,13 +135,13 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 		$this->assertSame( '1.0', $theme['Version'] );
 		$this->assertSame( 'sandbox', $theme['Template'] );
 		$this->assertSame( 'stylesheetonly', $theme['Stylesheet'] );
-		$this->assertContains( $this->theme_root . '/sandbox/functions.php', $theme['Template Files'] );
-		$this->assertContains( $this->theme_root . '/sandbox/index.php', $theme['Template Files'] );
+		$this->assertContains( self::THEME_ROOT . '/sandbox/functions.php', $theme['Template Files'] );
+		$this->assertContains( self::THEME_ROOT . '/sandbox/index.php', $theme['Template Files'] );
 
-		$this->assertContains( $this->theme_root . '/stylesheetonly/style.css', $theme['Stylesheet Files'] );
+		$this->assertContains( self::THEME_ROOT . '/stylesheetonly/style.css', $theme['Stylesheet Files'] );
 
-		$this->assertSame( $this->theme_root . '/sandbox', $theme['Template Dir'] );
-		$this->assertSame( $this->theme_root . '/stylesheetonly', $theme['Stylesheet Dir'] );
+		$this->assertSame( self::THEME_ROOT . '/sandbox', $theme['Template Dir'] );
+		$this->assertSame( self::THEME_ROOT . '/stylesheetonly', $theme['Stylesheet Dir'] );
 		$this->assertSame( 'publish', $theme['Status'] );
 		$this->assertSame( 'Sandbox', $theme['Parent Theme'] );
 
@@ -142,7 +155,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 
 		// Ignore themes in the default /themes directory.
 		foreach ( $themes as $theme_name => $theme ) {
-			if ( $theme->get_theme_root() !== $this->theme_root ) {
+			if ( $theme->get_theme_root() !== self::THEME_ROOT ) {
 				unset( $themes[ $theme_name ] );
 			}
 		}
@@ -159,18 +172,20 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 			'Page Template Theme',                // Theme with page templates for other test code.
 			'Theme with Spaces in the Directory',
 			'Internationalized Theme',
+			'Custom Internationalized Theme',
 			'camelCase',
 			'REST Theme',
 			'Block Theme',
 			'Block Theme Child Theme',
-			'Test Block Theme',
-			'Test Block Child Theme',
+			'Block Theme [0.4.0]',
+			'Block Theme [1.0.0] in subdirectory',
+			'Block Theme Deprecated Path',
+			'Webfonts theme',
+			'Empty `fontFace` in theme.json - no webfonts defined',
+			'A theme with the Update URI header',
 		);
 
-		sort( $theme_names );
-		sort( $expected );
-
-		$this->assertSame( $expected, $theme_names );
+		$this->assertSameSets( $expected, $theme_names );
 	}
 
 	/**
@@ -197,7 +212,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 	}
 
 	public function test_wp_get_theme_with_non_default_theme_root() {
-		$this->assertFalse( wp_get_theme( 'sandbox', $this->theme_root )->errors() );
+		$this->assertFalse( wp_get_theme( 'sandbox', self::THEME_ROOT )->errors() );
 		$this->assertFalse( wp_get_theme( 'sandbox' )->errors() );
 	}
 
@@ -211,7 +226,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 		$this->assertNotEmpty( $theme );
 
 		$templates = $theme['Template Files'];
-		$this->assertContains( $this->theme_root . '/page-templates/template-top-level.php', $templates );
+		$this->assertContains( self::THEME_ROOT . '/page-templates/template-top-level.php', $templates );
 	}
 
 	/**
@@ -237,7 +252,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 	 * @expectedDeprecated get_theme_data
 	 */
 	public function test_get_theme_data_subdir() {
-		$theme_data = get_theme_data( $this->theme_root . '/subdir/theme2/style.css' );
+		$theme_data = get_theme_data( self::THEME_ROOT . '/subdir/theme2/style.css' );
 
 		$this->assertSame( 'My Subdir Theme', $theme_data['Name'] );
 		$this->assertSame( 'http://example.org/', $theme_data['URI'] );
diff --git a/tests/theme/wpGetGlobalStylesheet.php b/tests/theme/wpGetGlobalStylesheet.php
new file mode 100644
index 0000000000..710f77d0ca
--- /dev/null
+++ b/tests/theme/wpGetGlobalStylesheet.php
@@ -0,0 +1,273 @@
+<?php
+
+/**
+ * Tests wp_get_global_stylesheet().
+ *
+ * @group themes
+ */
+class Tests_Theme_wpGetGlobalStylesheet extends WP_UnitTestCase {
+
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
+	public function set_up() {
+		parent::set_up();
+
+		$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
+		$this->theme_root     = realpath( DIR_TESTDATA . '/themedir1' );
+
+		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+
+		// Set up the new root.
+		add_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		// Clear caches.
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+	}
+
+	public function tear_down() {
+		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
+
+		// Clear up the filters to modify the theme root.
+		remove_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+
+		parent::tear_down();
+	}
+
+	/**
+	 * Cleans up global scope.
+	 *
+	 * @global WP_Styles $wp_styles
+	 */
+	public function clean_up_global_scope() {
+		global $wp_styles;
+		parent::clean_up_global_scope();
+		$wp_styles = null;
+	}
+
+	public function filter_set_theme_root() {
+		return $this->theme_root;
+	}
+
+	public function test_block_theme_using_variables() {
+		switch_theme( 'block-theme' );
+
+		$styles = wp_get_global_stylesheet( array( 'variables' ) );
+		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--custom: 100px;', $styles, 'custom font size is 100px' );
+
+		switch_theme( WP_DEFAULT_THEME );
+	}
+
+	public function test_block_theme_using_presets() {
+		switch_theme( 'block-theme' );
+
+		$styles = wp_get_global_stylesheet( array( 'presets' ) );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--custom: 100px;', $styles, 'custom font size is not present' );
+
+		switch_theme( WP_DEFAULT_THEME );
+	}
+
+	public function test_block_theme_using_defaults() {
+		switch_theme( 'block-theme' );
+
+		$styles = wp_get_global_stylesheet();
+		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--custom: 100px;', $styles, 'custom font size is 100px' );
+
+		switch_theme( WP_DEFAULT_THEME );
+	}
+
+	public function test_variables_in_classic_theme_with_no_presets_using_variables() {
+		$styles = wp_get_global_stylesheet( array( 'variables' ) );
+		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
+	}
+
+	public function test_variables_in_classic_theme_with_no_presets_using_presets() {
+		$styles = wp_get_global_stylesheet( array( 'presets' ) );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is not present' );
+	}
+
+	public function test_variables_in_classic_theme_with_no_presets_using_defaults() {
+		$styles = wp_get_global_stylesheet();
+		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
+	}
+
+	public function test_variables_in_classic_theme_with_presets_using_variables() {
+		add_theme_support(
+			'editor-font-sizes',
+			array(
+				array(
+					'name' => 'Small',
+					'size' => 18,
+					'slug' => 'small',
+				),
+				array(
+					'name' => 'Large',
+					'size' => 26.25,
+					'slug' => 'large',
+				),
+			)
+		);
+
+		$styles = wp_get_global_stylesheet( array( 'variables' ) );
+		$this->assertStringContainsString( '--wp--preset--font-size--small: 18px', $styles, 'small font size is 18px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--large: 26.25px', $styles, 'large font size is 26.25px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
+
+		remove_theme_support( 'editor-font-sizes' );
+	}
+
+	public function test_variables_in_classic_theme_with_presets_using_presets() {
+		add_theme_support(
+			'editor-font-sizes',
+			array(
+				array(
+					'name' => 'Small',
+					'size' => 18,
+					'slug' => 'small',
+				),
+				array(
+					'name' => 'Large',
+					'size' => 26.25,
+					'slug' => 'large',
+				),
+			)
+		);
+
+		$styles = wp_get_global_stylesheet( array( 'presets' ) );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--small: 18px', $styles, 'small font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--large: 26.25px', $styles, 'large font size is not present' );
+		$this->assertStringNotContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is not present' );
+
+		remove_theme_support( 'editor-font-sizes' );
+	}
+
+	public function test_variables_in_classic_theme_with_presets_using_defaults() {
+		add_theme_support(
+			'editor-font-sizes',
+			array(
+				array(
+					'name' => 'Small',
+					'size' => 18,
+					'slug' => 'small',
+				),
+				array(
+					'name' => 'Large',
+					'size' => 26.25,
+					'slug' => 'large',
+				),
+			)
+		);
+
+		$styles = wp_get_global_stylesheet();
+		$this->assertStringContainsString( '--wp--preset--font-size--small: 18px', $styles, 'small font size is 18px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--large: 26.25px', $styles, 'large font size is 26.25px' );
+		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'small font size is 42px' );
+
+		remove_theme_support( 'editor-font-sizes' );
+	}
+
+	/**
+	 * Tests that stored CSS is enqueued.
+	 *
+	 * @ticket 56467
+	 *
+	 * @covers ::wp_enqueue_stored_styles
+	 */
+	public function test_should_enqueue_stored_styles() {
+		$core_styles_to_enqueue = array(
+			array(
+				'selector'     => '.saruman',
+				'declarations' => array(
+					'color'        => 'white',
+					'height'       => '100px',
+					'border-style' => 'solid',
+				),
+			),
+		);
+
+		// Enqueues a block supports (core styles).
+		wp_style_engine_get_stylesheet_from_css_rules(
+			$core_styles_to_enqueue,
+			array(
+				'context' => 'block-supports',
+			)
+		);
+
+		$my_styles_to_enqueue = array(
+			array(
+				'selector'     => '.gandalf',
+				'declarations' => array(
+					'color'        => 'grey',
+					'height'       => '90px',
+					'border-style' => 'dotted',
+				),
+			),
+		);
+
+		// Enqueues some other styles.
+		wp_style_engine_get_stylesheet_from_css_rules(
+			$my_styles_to_enqueue,
+			array(
+				'context' => 'my-styles',
+			)
+		);
+
+		wp_enqueue_stored_styles( array( 'prettify' => false ) );
+
+		$this->assertSame(
+			array( '.saruman{color:white;height:100px;border-style:solid;}' ),
+			wp_styles()->registered['core-block-supports']->extra['after'],
+			'Registered styles with handle of "core-block-supports" do not match expected value from Style Engine store.'
+		);
+
+		$this->assertSame(
+			array( '.gandalf{color:grey;height:90px;border-style:dotted;}' ),
+			wp_styles()->registered['wp-style-engine-my-styles']->extra['after'],
+			'Registered styles with handle of "wp-style-engine-my-styles" do not match expected value from the Style Engine store.'
+		);
+	}
+}
diff --git a/tests/theme/wpTheme.php b/tests/theme/wpTheme.php
index 20e960bf3e..0ded32d77b 100644
--- a/tests/theme/wpTheme.php
+++ b/tests/theme/wpTheme.php
@@ -10,6 +10,20 @@
  */
 class Tests_Theme_wpTheme extends WP_UnitTestCase {
 
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
 	public function set_up() {
 		parent::set_up();
 		$this->theme_root = realpath( DIR_TESTDATA . '/themedir1' );
@@ -261,6 +275,35 @@ class Tests_Theme_wpTheme extends WP_UnitTestCase {
 		$this->assertSame( $expected, $theme->is_block_theme() );
 	}
 
+	/**
+	 * Test get_files for an existing theme.
+	 *
+	 * @ticket 53599
+	 */
+	public function test_get_files_theme() {
+		$theme = new WP_Theme( 'theme1', $this->theme_root );
+		$files = $theme->get_files();
+
+		$this->assertIsArray( $files );
+		$this->assertCount( 3, $files );
+		$this->assertArrayHasKey( 'functions.php', $files );
+		$this->assertArrayHasKey( 'index.php', $files );
+		$this->assertArrayHasKey( 'style.css', $files );
+	}
+
+	/**
+	 * Test get_files for a non-existing theme.
+	 *
+	 * @ticket 53599
+	 */
+	public function test_get_files_nonexistent_theme() {
+		$theme = new WP_Theme( 'nonexistent', $this->theme_root );
+		$files = $theme->get_files();
+
+		$this->assertIsArray( $files );
+		$this->assertEmpty( $files );
+	}
+
 	/**
 	 * Data provider.
 	 *
@@ -273,11 +316,15 @@ class Tests_Theme_wpTheme extends WP_UnitTestCase {
 				'expected'  => false,
 			),
 			'parent block theme'        => array(
-				'theme_dir' => 'test-block-theme',
+				'theme_dir' => 'block-theme',
 				'expected'  => true,
 			),
 			'child block theme'         => array(
-				'theme_dir' => 'test-block-child-theme',
+				'theme_dir' => 'block-theme-child',
+				'expected'  => true,
+			),
+			'deprecated block theme'    => array(
+				'theme_dir' => 'block-theme-deprecated-path',
 				'expected'  => true,
 			),
 		);
@@ -306,51 +353,102 @@ class Tests_Theme_wpTheme extends WP_UnitTestCase {
 	 */
 	public function data_get_file_path() {
 		return array(
-			'no theme: no file given'           => array(
+			'no theme: no file given'              => array(
 				'theme_dir' => 'nonexistent',
 				'file'      => '',
 				'expected'  => '/nonexistent',
 			),
-			'parent theme: no file given'       => array(
-				'theme_dir' => 'test-block-theme',
+			'parent theme: no file given'          => array(
+				'theme_dir' => 'block-theme',
 				'file'      => '',
-				'expected'  => '/test-block-theme',
+				'expected'  => '/block-theme',
 			),
-			'child theme: no file given'        => array(
-				'theme_dir' => 'test-block-child-theme',
+			'child theme: no file given'           => array(
+				'theme_dir' => 'block-theme-child',
 				'file'      => '',
-				'expected'  => '/test-block-child-theme',
+				'expected'  => '/block-theme-child',
 			),
-			'nonexistent theme: file given'     => array(
+			'nonexistent theme: file given'        => array(
 				'theme_dir' => 'nonexistent',
 				'file'      => '/templates/page.html',
 				'expected'  => '/nonexistent/templates/page.html',
 			),
-			'parent theme: file exists'         => array(
-				'theme_dir' => 'test-block-theme',
+			'parent theme: file exists'            => array(
+				'theme_dir' => 'block-theme',
 				'file'      => '/templates/page-home.html',
-				'expected'  => '/test-block-theme/templates/page-home.html',
+				'expected'  => '/block-theme/templates/page-home.html',
+			),
+			'parent theme: deprecated file exists' => array(
+				'theme_dir' => 'block-theme-deprecated-path',
+				'file'      => '/block-templates/page-home.html',
+				'expected'  => '/block-theme-deprecated-path/block-templates/page-home.html',
 			),
-			'parent theme: file does not exist' => array(
-				'theme_dir' => 'test-block-theme',
+			'parent theme: file does not exist'    => array(
+				'theme_dir' => 'block-theme',
 				'file'      => '/templates/nonexistent.html',
-				'expected'  => '/test-block-theme/templates/nonexistent.html',
+				'expected'  => '/block-theme/templates/nonexistent.html',
 			),
-			'child theme: file exists'          => array(
-				'theme_dir' => 'test-block-child-theme',
+			'child theme: file exists'             => array(
+				'theme_dir' => 'block-theme-child',
 				'file'      => '/templates/page-1.html',
-				'expected'  => '/test-block-child-theme/templates/page-1.html',
+				'expected'  => '/block-theme-child/templates/page-1.html',
 			),
-			'child theme: file does not exist'  => array(
-				'theme_dir' => 'test-block-child-theme',
+			'child theme: file does not exist'     => array(
+				'theme_dir' => 'block-theme-child',
 				'file'      => '/templates/nonexistent.html',
-				'expected'  => '/test-block-theme/templates/nonexistent.html',
+				'expected'  => '/block-theme/templates/nonexistent.html',
 			),
 			'child theme: file exists in parent, not in child' => array(
-				'theme_dir' => 'test-block-child-theme',
+				'theme_dir' => 'block-theme-child',
 				'file'      => '/templates/page.html',
-				'expected'  => '/test-block-theme/templates/page.html',
+				'expected'  => '/block-theme/templates/page.html',
 			),
 		);
 	}
+
+	/**
+	 * Tests that the UpdateURI header is retrieved.
+	 *
+	 * @ticket 14179
+	 *
+	 * @covers WP_Theme::get
+	 */
+	public function test_theme_get_update_uri_header() {
+		$theme = new WP_Theme( 'update-uri-theme', $this->theme_root );
+
+		$this->assertTrue(
+			$theme->exists(),
+			'The update-uri-theme does not exist.'
+		);
+
+		$update_uri = $theme->get( 'UpdateURI' );
+
+		$this->assertIsString(
+			$update_uri,
+			'The UpdateURI header was not returned as a string.'
+		);
+
+		$this->assertSame(
+			'http://example.org/update-uri-theme/',
+			$update_uri,
+			'The UpdateURI header did not match the expected value.'
+		);
+	}
+
+	/**
+	 * Tests that WP_Theme::sanitize_header() strips tags from the UpdateURI header.
+	 *
+	 * @ticket 14179
+	 *
+	 * @covers WP_Theme::sanitize_header
+	 */
+	public function test_should_strip_tags_from_update_uri_header() {
+		$theme           = new WP_Theme( 'twentytwentytwo', $this->theme_root );
+		$sanitize_header = new ReflectionMethod( $theme, 'sanitize_header' );
+		$sanitize_header->setAccessible( true );
+
+		$actual = $sanitize_header->invoke( $theme, 'UpdateURI', '<?php?><a href="http://example.org">http://example.org</a>' );
+
+		$this->assertSame( 'http://example.org', $actual );
+	}
 }
diff --git a/tests/theme/wpThemeJson.php b/tests/theme/wpThemeJson.php
index 60c6d16ede..f1e3e1ae8b 100644
--- a/tests/theme/wpThemeJson.php
+++ b/tests/theme/wpThemeJson.php
@@ -200,12 +200,15 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected_no_origin, $actual_no_origin );
 	}
 
-	function test_get_settings_using_opt_in_key() {
+	function test_get_settings_appearance_true_opts_in() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
 					'appearanceTools' => true,
+					'spacing'         => array(
+						'blockGap' => false, // This should override appearanceTools.
+					),
 					'blocks'          => array(
 						'core/paragraph' => array(
 							'typography' => array(
@@ -217,6 +220,9 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 							'typography'      => array(
 								'lineHeight' => false, // This should override appearanceTools.
 							),
+							'spacing'         => array(
+								'blockGap' => null,
+							),
 						),
 					),
 				),
@@ -235,7 +241,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 				'link' => true,
 			),
 			'spacing'    => array(
-				'blockGap' => true,
+				'blockGap' => false,
 				'margin'   => true,
 				'padding'  => true,
 			),
@@ -259,7 +265,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'link' => true,
 					),
 					'spacing'    => array(
-						'blockGap' => true,
+						'blockGap' => false,
 						'margin'   => true,
 						'padding'  => true,
 					),
@@ -273,6 +279,54 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, $actual );
 	}
 
+	function test_get_settings_appearance_false_does_not_opt_in() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'appearanceTools' => false,
+					'border'          => array(
+						'width' => true,
+					),
+					'blocks'          => array(
+						'core/paragraph' => array(
+							'typography' => array(
+								'lineHeight' => false,
+							),
+						),
+						'core/group'     => array(
+							'typography' => array(
+								'lineHeight' => false,
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$actual   = $theme_json->get_settings();
+		$expected = array(
+			'appearanceTools' => false,
+			'border'          => array(
+				'width' => true,
+			),
+			'blocks'          => array(
+				'core/paragraph' => array(
+					'typography' => array(
+						'lineHeight' => false,
+					),
+				),
+				'core/group'     => array(
+					'typography' => array(
+						'lineHeight' => false,
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
 	/**
 	 * @ticket 54336
 	 */
@@ -313,8 +367,8 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		);
 
 		$styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-block-group{border-radius: 10px;margin: 1em;padding: 24px;}.wp-block-image{border-top-left-radius: 10px;border-bottom-right-radius: 1em;margin-bottom: 30px;padding-top: 15px;}';
-		$this->assertEquals( $styles, $theme_json->get_stylesheet() );
-		$this->assertEquals( $styles, $theme_json->get_stylesheet( array( 'styles' ) ) );
+		$this->assertSame( $styles, $theme_json->get_stylesheet() );
+		$this->assertSame( $styles, $theme_json->get_stylesheet( array( 'styles' ) ) );
 	}
 
 	/**
@@ -345,8 +399,8 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		);
 
 		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
-		$this->assertEquals( $expected, $theme_json->get_stylesheet() );
-		$this->assertEquals( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
 	}
 
 	/**
@@ -365,18 +419,11 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 					'spacing' => array(
 						'blockGap' => '1em',
 					),
-					'blocks'  => array(
-						'core/columns' => array(
-							'spacing' => array(
-								'blockGap' => '24px',
-							),
-						),
-					),
 				),
 			)
 		);
 
-		$expected = 'body { margin: 0; }body{--wp--style--block-gap: 1em;}.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-top: 0; margin-bottom: 0; }.wp-site-blocks > * + * { margin-top: var( --wp--style--block-gap ); }.wp-block-columns{--wp--style--block-gap: 24px;}';
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: 1em; }body { --wp--style--block-gap: 1em; }';
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
 	}
@@ -411,9 +458,6 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 							),
 						),
 					),
-					'spacing'    => array(
-						'blockGap' => false,
-					),
 					'misc'       => 'value',
 					'blocks'     => array(
 						'core/group' => array(
@@ -500,13 +544,16 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 							),
 						),
 					),
+					'spacing'  => array(
+						'blockGap' => '24px',
+					),
 				),
 				'misc'     => 'value',
 			)
 		);
 
 		$variables = 'body{--wp--preset--color--grey: grey;--wp--preset--font-family--small: 14px;--wp--preset--font-family--big: 41px;}.wp-block-group{--wp--custom--base-font: 16;--wp--custom--line-height--small: 1.2;--wp--custom--line-height--medium: 1.4;--wp--custom--line-height--large: 1.8;}';
-		$styles    = 'body { margin: 0; }body{color: var(--wp--preset--color--grey);}.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-top: 0; margin-bottom: 0; }.wp-site-blocks > * + * { margin-top: var( --wp--style--block-gap ); }a{background-color: #333;color: #111;}.wp-block-group{border-radius: 10px;padding: 24px;}.wp-block-group a{color: #111;}h1,h2,h3,h4,h5,h6{color: #123456;}h1 a,h2 a,h3 a,h4 a,h5 a,h6 a{background-color: #333;color: #111;font-size: 60px;}.wp-block-post-date{color: #123456;}.wp-block-post-date a{background-color: #777;color: #555;}.wp-block-image{border-top-left-radius: 10px;border-bottom-right-radius: 1em;margin-bottom: 30px;}';
+		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{color: var(--wp--preset--color--grey);}a:where(:not(.wp-element-button)){background-color: #333;color: #111;}.wp-block-group{border-radius: 10px;padding: 24px;}.wp-block-group a:where(:not(.wp-element-button)){color: #111;}h1,h2,h3,h4,h5,h6{color: #123456;}h1 a:where(:not(.wp-element-button)),h2 a:where(:not(.wp-element-button)),h3 a:where(:not(.wp-element-button)),h4 a:where(:not(.wp-element-button)),h5 a:where(:not(.wp-element-button)),h6 a:where(:not(.wp-element-button)){background-color: #333;color: #111;font-size: 60px;}.wp-block-post-date{color: #123456;}.wp-block-post-date a:where(:not(.wp-element-button)){background-color: #777;color: #555;}.wp-block-image{border-top-left-radius: 10px;border-bottom-right-radius: 1em;margin-bottom: 30px;}';
 		$presets   = '.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}.has-small-font-family{font-family: var(--wp--preset--font-family--small) !important;}.has-big-font-family{font-family: var(--wp--preset--font-family--big) !important;}';
 		$all       = $variables . $styles . $presets;
 		$this->assertSame( $all, $theme_json->get_stylesheet() );
@@ -540,7 +587,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertEquals(
+		$this->assertSame(
 			'h1.has-white-color,h2.has-white-color,h3.has-white-color,h4.has-white-color,h5.has-white-color,h6.has-white-color{color: var(--wp--preset--color--white) !important;}h1.has-white-background-color,h2.has-white-background-color,h3.has-white-background-color,h4.has-white-background-color,h5.has-white-background-color,h6.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}h1.has-white-border-color,h2.has-white-border-color,h3.has-white-border-color,h4.has-white-border-color,h5.has-white-border-color,h6.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}',
 			$theme_json->get_stylesheet( array( 'presets' ) )
 		);
@@ -584,21 +631,21 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$presets   = '.wp-block-group.has-grey-color{color: var(--wp--preset--color--grey) !important;}.wp-block-group.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.wp-block-group.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}';
 		$variables = '.wp-block-group{--wp--preset--color--grey: grey;}';
 		$all       = $variables . $styles . $presets;
-		$this->assertEquals( $all, $theme_json->get_stylesheet() );
-		$this->assertEquals( $styles, $theme_json->get_stylesheet( array( 'styles' ) ) );
-		$this->assertEquals( $presets, $theme_json->get_stylesheet( array( 'presets' ) ) );
-		$this->assertEquals( $variables, $theme_json->get_stylesheet( array( 'variables' ) ) );
+		$this->assertSame( $all, $theme_json->get_stylesheet() );
+		$this->assertSame( $styles, $theme_json->get_stylesheet( array( 'styles' ) ) );
+		$this->assertSame( $presets, $theme_json->get_stylesheet( array( 'presets' ) ) );
+		$this->assertSame( $variables, $theme_json->get_stylesheet( array( 'variables' ) ) );
 	}
 
 	/**
 	 * @ticket 54336
 	 */
-	public function test_get_stylesheet_generates_proper_classes_from_slugs() {
+	public function test_get_stylesheet_generates_proper_classes_and_css_vars_from_slugs() {
 		$theme_json = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
-					'color' => array(
+					'color'  => array(
 						'palette' => array(
 							array(
 								'slug'  => 'grey',
@@ -618,16 +665,19 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 							),
 						),
 					),
+					'custom' => array(
+						'white2black' => 'value',
+					),
 				),
 			)
 		);
 
-		$this->assertEquals(
+		$this->assertSame(
 			'.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-dark-grey-color{color: var(--wp--preset--color--dark-grey) !important;}.has-light-grey-color{color: var(--wp--preset--color--light-grey) !important;}.has-white-2-black-color{color: var(--wp--preset--color--white-2-black) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-dark-grey-background-color{background-color: var(--wp--preset--color--dark-grey) !important;}.has-light-grey-background-color{background-color: var(--wp--preset--color--light-grey) !important;}.has-white-2-black-background-color{background-color: var(--wp--preset--color--white-2-black) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}.has-dark-grey-border-color{border-color: var(--wp--preset--color--dark-grey) !important;}.has-light-grey-border-color{border-color: var(--wp--preset--color--light-grey) !important;}.has-white-2-black-border-color{border-color: var(--wp--preset--color--white-2-black) !important;}',
 			$theme_json->get_stylesheet( array( 'presets' ) )
 		);
-		$this->assertEquals(
-			'body{--wp--preset--color--grey: grey;--wp--preset--color--dark-grey: grey;--wp--preset--color--light-grey: grey;--wp--preset--color--white-2-black: grey;}',
+		$this->assertSame(
+			'body{--wp--preset--color--grey: grey;--wp--preset--color--dark-grey: grey;--wp--preset--color--light-grey: grey;--wp--preset--color--white-2-black: grey;--wp--custom--white-2-black: value;}',
 			$theme_json->get_stylesheet( array( 'variables' ) )
 		);
 
@@ -669,12 +719,285 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'default'
 		);
 
-		$this->assertEquals(
+		$this->assertSame(
 			'body{--wp--preset--color--grey: grey;}body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }p{background-color: blue;color: red;font-size: 12px;line-height: 1.3;}.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}',
 			$theme_json->get_stylesheet()
 		);
 	}
 
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_stylesheet_handles_whitelisted_element_pseudo_selectors() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'elements' => array(
+						'link' => array(
+							'color'  => array(
+								'text'       => 'green',
+								'background' => 'red',
+							),
+							':hover' => array(
+								'color'      => array(
+									'text'       => 'red',
+									'background' => 'green',
+								),
+								'typography' => array(
+									'textTransform' => 'uppercase',
+									'fontSize'      => '10em',
+								),
+							),
+							':focus' => array(
+								'color' => array(
+									'text'       => 'yellow',
+									'background' => 'black',
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+
+		$element_styles = 'a:where(:not(.wp-element-button)){background-color: red;color: green;}a:where(:not(.wp-element-button)):hover{background-color: green;color: red;font-size: 10em;text-transform: uppercase;}a:where(:not(.wp-element-button)):focus{background-color: black;color: yellow;}';
+
+		$expected = $base_styles . $element_styles;
+
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_stylesheet_handles_only_pseudo_selector_rules_for_given_property() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'elements' => array(
+						'link' => array(
+							':hover' => array(
+								'color'      => array(
+									'text'       => 'red',
+									'background' => 'green',
+								),
+								'typography' => array(
+									'textTransform' => 'uppercase',
+									'fontSize'      => '10em',
+								),
+							),
+							':focus' => array(
+								'color' => array(
+									'text'       => 'yellow',
+									'background' => 'black',
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+
+		$element_styles = 'a:where(:not(.wp-element-button)):hover{background-color: green;color: red;font-size: 10em;text-transform: uppercase;}a:where(:not(.wp-element-button)):focus{background-color: black;color: yellow;}';
+
+		$expected = $base_styles . $element_styles;
+
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_stylesheet_ignores_pseudo_selectors_on_non_whitelisted_elements() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'elements' => array(
+						'h4' => array(
+							'color'  => array(
+								'text'       => 'green',
+								'background' => 'red',
+							),
+							':hover' => array(
+								'color' => array(
+									'text'       => 'red',
+									'background' => 'green',
+								),
+							),
+							':focus' => array(
+								'color' => array(
+									'text'       => 'yellow',
+									'background' => 'black',
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+
+		$element_styles = 'h4{background-color: red;color: green;}';
+
+		$expected = $base_styles . $element_styles;
+
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_stylesheet_ignores_non_whitelisted_pseudo_selectors() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'elements' => array(
+						'link' => array(
+							'color'     => array(
+								'text'       => 'green',
+								'background' => 'red',
+							),
+							':hover'    => array(
+								'color' => array(
+									'text'       => 'red',
+									'background' => 'green',
+								),
+							),
+							':levitate' => array(
+								'color' => array(
+									'text'       => 'yellow',
+									'background' => 'black',
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+
+		$element_styles = 'a:where(:not(.wp-element-button)){background-color: red;color: green;}a:where(:not(.wp-element-button)):hover{background-color: green;color: red;}';
+
+		$expected = $base_styles . $element_styles;
+
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+		$this->assertStringNotContainsString( 'a:levitate{', $theme_json->get_stylesheet( array( 'styles' ) ) );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_stylesheet_handles_priority_of_elements_vs_block_elements_pseudo_selectors() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'blocks' => array(
+						'core/group' => array(
+							'elements' => array(
+								'link' => array(
+									'color'  => array(
+										'text'       => 'green',
+										'background' => 'red',
+									),
+									':hover' => array(
+										'color'      => array(
+											'text'       => 'red',
+											'background' => 'green',
+										),
+										'typography' => array(
+											'textTransform' => 'uppercase',
+											'fontSize' => '10em',
+										),
+									),
+									':focus' => array(
+										'color' => array(
+											'text'       => 'yellow',
+											'background' => 'black',
+										),
+									),
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+
+		$element_styles = '.wp-block-group a:where(:not(.wp-element-button)){background-color: red;color: green;}.wp-block-group a:where(:not(.wp-element-button)):hover{background-color: green;color: red;font-size: 10em;text-transform: uppercase;}.wp-block-group a:where(:not(.wp-element-button)):focus{background-color: black;color: yellow;}';
+
+		$expected = $base_styles . $element_styles;
+
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_stylesheet_handles_whitelisted_block_level_element_pseudo_selectors() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'elements' => array(
+						'link' => array(
+							'color'  => array(
+								'text'       => 'green',
+								'background' => 'red',
+							),
+							':hover' => array(
+								'color' => array(
+									'text'       => 'red',
+									'background' => 'green',
+								),
+							),
+						),
+					),
+					'blocks'   => array(
+						'core/group' => array(
+							'elements' => array(
+								'link' => array(
+									':hover' => array(
+										'color' => array(
+											'text'       => 'yellow',
+											'background' => 'black',
+										),
+									),
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$base_styles = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+
+		$element_styles = 'a:where(:not(.wp-element-button)){background-color: red;color: green;}a:where(:not(.wp-element-button)):hover{background-color: green;color: red;}.wp-block-group a:where(:not(.wp-element-button)):hover{background-color: black;color: yellow;}';
+
+		$expected = $base_styles . $element_styles;
+
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+		$this->assertSame( $expected, $theme_json->get_stylesheet( array( 'styles' ) ) );
+	}
+
 	/**
 	 * @ticket 52991
 	 * @ticket 54336
@@ -1133,13 +1456,14 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, $actual );
 	}
 
-	public function test_merge_incoming_data_removes_theme_presets_with_slugs_as_default_presets() {
+	public function test_merge_incoming_data_color_presets_with_same_slugs_as_default_are_removed() {
 		$defaults = new WP_Theme_JSON(
 			array(
 				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 				'settings' => array(
 					'color'  => array(
-						'palette' => array(
+						'defaultPalette' => true,
+						'palette'        => array(
 							array(
 								'slug'  => 'red',
 								'color' => 'red',
@@ -1218,7 +1542,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'version'  => WP_Theme_JSON::LATEST_SCHEMA,
 			'settings' => array(
 				'color'  => array(
-					'palette' => array(
+					'palette'        => array(
 						'default' => array(
 							array(
 								'slug'  => 'red',
@@ -1239,6 +1563,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 							),
 						),
 					),
+					'defaultPalette' => true,
 				),
 				'blocks' => array(
 					'core/paragraph' => array(
@@ -1271,14 +1596,264 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, $actual );
 	}
 
-	/**
-	 * @ticket 54336
-	 */
-	public function test_remove_insecure_properties_removes_unsafe_styles() {
-		$actual = WP_Theme_JSON::remove_insecure_properties(
+	public function test_merge_incoming_data_color_presets_with_same_slugs_as_default_are_not_removed_if_defaults_are_disabled() {
+		$defaults = new WP_Theme_JSON(
 			array(
-				'version' => WP_Theme_JSON::LATEST_SCHEMA,
-				'styles'  => array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'color'  => array(
+						'defaultPalette' => true, // Emulate the defaults from core theme.json.
+						'palette'        => array(
+							array(
+								'slug'  => 'red',
+								'color' => 'red',
+								'name'  => 'Red',
+							),
+							array(
+								'slug'  => 'green',
+								'color' => 'green',
+								'name'  => 'Green',
+							),
+						),
+					),
+					'blocks' => array(
+						'core/paragraph' => array(
+							'color' => array(
+								'palette' => array(
+									array(
+										'slug'  => 'blue',
+										'color' => 'blue',
+										'name'  => 'Blue',
+									),
+								),
+							),
+						),
+					),
+				),
+			),
+			'default'
+		);
+		$theme    = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'color'  => array(
+						'defaultPalette' => false,
+						'palette'        => array(
+							array(
+								'slug'  => 'pink',
+								'color' => 'pink',
+								'name'  => 'Pink',
+							),
+							array(
+								'slug'  => 'green',
+								'color' => 'green',
+								'name'  => 'Greenish',
+							),
+						),
+					),
+					'blocks' => array(
+						'core/paragraph' => array(
+							'color' => array(
+								'palette' => array(
+									array(
+										'slug'  => 'blue',
+										'color' => 'blue',
+										'name'  => 'Bluish',
+									),
+									array(
+										'slug'  => 'yellow',
+										'color' => 'yellow',
+										'name'  => 'Yellow',
+									),
+									array(
+										'slug'  => 'green',
+										'color' => 'green',
+										'name'  => 'Block Green',
+									),
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$expected = array(
+			'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+			'settings' => array(
+				'color'  => array(
+					'defaultPalette' => false,
+					'palette'        => array(
+						'default' => array(
+							array(
+								'slug'  => 'red',
+								'color' => 'red',
+								'name'  => 'Red',
+							),
+							array(
+								'slug'  => 'green',
+								'color' => 'green',
+								'name'  => 'Green',
+							),
+						),
+						'theme'   => array(
+							array(
+								'slug'  => 'pink',
+								'color' => 'pink',
+								'name'  => 'Pink',
+							),
+							array(
+								'slug'  => 'green',
+								'color' => 'green',
+								'name'  => 'Greenish',
+							),
+						),
+					),
+				),
+				'blocks' => array(
+					'core/paragraph' => array(
+						'color' => array(
+							'palette' => array(
+								'default' => array(
+									array(
+										'slug'  => 'blue',
+										'color' => 'blue',
+										'name'  => 'Blue',
+									),
+								),
+								'theme'   => array(
+									array(
+										'slug'  => 'blue',
+										'color' => 'blue',
+										'name'  => 'Bluish',
+									),
+									array(
+										'slug'  => 'yellow',
+										'color' => 'yellow',
+										'name'  => 'Yellow',
+									),
+									array(
+										'slug'  => 'green',
+										'color' => 'green',
+										'name'  => 'Block Green',
+									),
+								),
+							),
+						),
+					),
+				),
+			),
+		);
+
+		$defaults->merge( $theme );
+		$actual = $defaults->get_raw_data();
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 54640
+	 */
+	public function test_merge_incoming_data_presets_use_default_names() {
+		$defaults   = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'typography' => array(
+						'fontSizes' => array(
+							array(
+								'name' => 'Small',
+								'slug' => 'small',
+								'size' => '12px',
+							),
+							array(
+								'name' => 'Large',
+								'slug' => 'large',
+								'size' => '20px',
+							),
+						),
+					),
+				),
+			),
+			'default'
+		);
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'typography' => array(
+						'fontSizes' => array(
+							array(
+								'slug' => 'small',
+								'size' => '1.1rem',
+							),
+							array(
+								'slug' => 'large',
+								'size' => '1.75rem',
+							),
+							array(
+								'name' => 'Huge',
+								'slug' => 'huge',
+								'size' => '3rem',
+							),
+						),
+					),
+				),
+			),
+			'theme'
+		);
+		$expected   = array(
+			'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+			'settings' => array(
+				'typography' => array(
+					'fontSizes' => array(
+						'default' => array(
+							array(
+								'name' => 'Small',
+								'slug' => 'small',
+								'size' => '12px',
+							),
+							array(
+								'name' => 'Large',
+								'slug' => 'large',
+								'size' => '20px',
+							),
+						),
+						'theme'   => array(
+							array(
+								'slug' => 'small',
+								'size' => '1.1rem',
+								'name' => 'Small',
+							),
+							array(
+								'slug' => 'large',
+								'size' => '1.75rem',
+								'name' => 'Large',
+							),
+							array(
+								'name' => 'Huge',
+								'slug' => 'huge',
+								'size' => '3rem',
+							),
+						),
+					),
+				),
+			),
+		);
+		$defaults->merge( $theme_json );
+		$actual = $defaults->get_raw_data();
+		$this->assertSameSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 54336
+	 */
+	public function test_remove_insecure_properties_removes_unsafe_styles() {
+		$actual = WP_Theme_JSON::remove_insecure_properties(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
 					'color'    => array(
 						'gradient' => 'url(\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+PHNjcmlwdD5hbGVydCgnb2snKTwvc2NyaXB0PjxsaW5lYXJHcmFkaWVudCBpZD0nZ3JhZGllbnQnPjxzdG9wIG9mZnNldD0nMTAlJyBzdG9wLWNvbG9yPScjRjAwJy8+PHN0b3Agb2Zmc2V0PSc5MCUnIHN0b3AtY29sb3I9JyNmY2MnLz4gPC9saW5lYXJHcmFkaWVudD48cmVjdCBmaWxsPSd1cmwoI2dyYWRpZW50KScgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCUnIGhlaWdodD0nMTAwJScvPjwvc3ZnPg==\')',
 						'text'     => 'var:preset|color|dark-red',
@@ -1300,7 +1875,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						),
 						'core/cover'  => array(
 							'filter' => array(
-								'duotone' => 'var(--wp--preset--duotone--blue-red, var(--fallback-unsafe))',
+								'duotone' => 'var(--invalid',
 							),
 						),
 						'core/group'  => array(
@@ -1374,7 +1949,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 					'border'   => array(
 						'radius' => array(
 							'topLeft'     => '6px',
-							'topRight'    => 'var(--top-right, var(--unsafe-fallback))',
+							'topRight'    => 'var(--invalid',
 							'bottomRight' => '6px',
 							'bottomLeft'  => '6px',
 						),
@@ -1383,7 +1958,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 						'padding' => array(
 							'top'    => '1px',
 							'right'  => '1px',
-							'bottom' => 'var(--bottom, var(--unsafe-fallback))',
+							'bottom' => 'var(--invalid',
 							'left'   => '1px',
 						),
 					),
@@ -1393,7 +1968,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								'padding' => array(
 									'top'    => '2px',
 									'right'  => '2px',
-									'bottom' => 'var(--bottom, var(--unsafe-fallback))',
+									'bottom' => 'var(--invalid',
 									'left'   => '2px',
 								),
 							),
@@ -1404,7 +1979,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 							'border'   => array(
 								'radius' => array(
 									'topLeft'     => '5px',
-									'topRight'    => 'var(--top-right, var(--unsafe-fallback))',
+									'topRight'    => 'var(--invalid',
 									'bottomRight' => '5px',
 									'bottomLeft'  => '5px',
 								),
@@ -1413,7 +1988,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								'padding' => array(
 									'top'    => '3px',
 									'right'  => '3px',
-									'bottom' => 'var(bottom, var(--unsafe-fallback))',
+									'bottom' => 'var(--invalid',
 									'left'   => '3px',
 								),
 							),
@@ -1423,7 +1998,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 										'padding' => array(
 											'top'    => '4px',
 											'right'  => '4px',
-											'bottom' => 'var(--bottom, var(--unsafe-fallback))',
+											'bottom' => 'var(--invalid',
 											'left'   => '4px',
 										),
 									),
@@ -1642,7 +2217,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								array(
 									'name'  => 'Blue',
 									'slug'  => 'blue',
-									'color' => 'var(--color, var(--unsafe-fallback))',
+									'color' => 'var(--invalid',
 								),
 								array(
 									'name'  => 'Pink',
@@ -1673,7 +2248,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 								array(
 									'name'       => 'Helvetica Arial',
 									'slug'       => 'helvetica-arial',
-									'fontFamily' => 'var(--fontFamily, var(--unsafe-fallback))',
+									'fontFamily' => 'var(--invalid',
 								),
 							),
 						),
@@ -1696,7 +2271,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 										array(
 											'name'  => 'Blue',
 											'slug'  => 'blue',
-											'color' => 'var(--color, var(--unsafe--fallback))',
+											'color' => 'var(--invalid',
 										),
 										array(
 											'name'  => 'Pink',
@@ -1784,6 +2359,56 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, $actual );
 	}
 
+	/**
+	 * @ticket 56467
+	 */
+	public function test_remove_invalid_element_pseudo_selectors() {
+		$actual = WP_Theme_JSON::remove_insecure_properties(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'elements' => array(
+						'link' => array(
+							'color'  => array(
+								'text'       => 'hotpink',
+								'background' => 'yellow',
+							),
+							':hover' => array(
+								'color' => array(
+									'text'       => 'red',
+									'background' => 'blue',
+								),
+							),
+						),
+					),
+				),
+			),
+			true
+		);
+
+		$expected = array(
+			'version' => WP_Theme_JSON::LATEST_SCHEMA,
+			'styles'  => array(
+				'elements' => array(
+					'link' => array(
+						'color'  => array(
+							'text'       => 'hotpink',
+							'background' => 'yellow',
+						),
+						':hover' => array(
+							'color' => array(
+								'text'       => 'red',
+								'background' => 'blue',
+							),
+						),
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
 	/**
 	 * @ticket 54336
 	 */
@@ -2039,4 +2664,833 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, $actual['settings']['spacing'] );
 	}
 
+	/**
+	 * @ticket 54487
+	 */
+	public function test_sanitization() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'spacing' => array(
+						'blockGap' => 'valid value',
+					),
+					'blocks'  => array(
+						'core/group' => array(
+							'spacing' => array(
+								'margin'  => 'valid value',
+								'display' => 'none',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$actual   = $theme_json->get_raw_data();
+		$expected = array(
+			'version' => 2,
+			'styles'  => array(
+				'spacing' => array(
+					'blockGap' => 'valid value',
+				),
+				'blocks'  => array(
+					'core/group' => array(
+						'spacing' => array(
+							'margin' => 'valid value',
+						),
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_export_data() {
+		$theme = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'settings' => array(
+					'color' => array(
+						'palette' => array(
+							array(
+								'slug'  => 'white',
+								'color' => 'white',
+								'label' => 'White',
+							),
+							array(
+								'slug'  => 'black',
+								'color' => 'black',
+								'label' => 'Black',
+							),
+						),
+					),
+				),
+			)
+		);
+		$user  = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'settings' => array(
+					'color' => array(
+						'palette' => array(
+							array(
+								'slug'  => 'white',
+								'color' => '#fff',
+								'label' => 'User White',
+							),
+							array(
+								'slug'  => 'hotpink',
+								'color' => 'hotpink',
+								'label' => 'hotpink',
+							),
+						),
+					),
+				),
+			),
+			'custom'
+		);
+
+		$theme->merge( $user );
+		$actual   = $theme->get_data();
+		$expected = array(
+			'version'  => 2,
+			'settings' => array(
+				'color' => array(
+					'palette' => array(
+						array(
+							'slug'  => 'white',
+							'color' => '#fff',
+							'label' => 'User White',
+						),
+						array(
+							'slug'  => 'black',
+							'color' => 'black',
+							'label' => 'Black',
+						),
+						array(
+							'slug'  => 'hotpink',
+							'color' => 'hotpink',
+							'label' => 'hotpink',
+						),
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_export_data_deals_with_empty_user_data() {
+		$theme = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'settings' => array(
+					'color' => array(
+						'palette' => array(
+							array(
+								'slug'  => 'white',
+								'color' => 'white',
+								'label' => 'White',
+							),
+							array(
+								'slug'  => 'black',
+								'color' => 'black',
+								'label' => 'Black',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$actual   = $theme->get_data();
+		$expected = array(
+			'version'  => 2,
+			'settings' => array(
+				'color' => array(
+					'palette' => array(
+						array(
+							'slug'  => 'white',
+							'color' => 'white',
+							'label' => 'White',
+						),
+						array(
+							'slug'  => 'black',
+							'color' => 'black',
+							'label' => 'Black',
+						),
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_export_data_deals_with_empty_theme_data() {
+		$user = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'settings' => array(
+					'color' => array(
+						'palette' => array(
+							array(
+								'slug'  => 'white',
+								'color' => '#fff',
+								'label' => 'User White',
+							),
+							array(
+								'slug'  => 'hotpink',
+								'color' => 'hotpink',
+								'label' => 'hotpink',
+							),
+						),
+					),
+				),
+			),
+			'custom'
+		);
+
+		$actual   = $user->get_data();
+		$expected = array(
+			'version'  => 2,
+			'settings' => array(
+				'color' => array(
+					'palette' => array(
+						array(
+							'slug'  => 'white',
+							'color' => '#fff',
+							'label' => 'User White',
+						),
+						array(
+							'slug'  => 'hotpink',
+							'color' => 'hotpink',
+							'label' => 'hotpink',
+						),
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_export_data_deals_with_empty_data() {
+		$theme_v2    = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+			),
+			'theme'
+		);
+		$actual_v2   = $theme_v2->get_data();
+		$expected_v2 = array( 'version' => 2 );
+		$this->assertEqualSetsWithIndex( $expected_v2, $actual_v2 );
+
+		$theme_v1    = new WP_Theme_JSON(
+			array(
+				'version' => 1,
+			),
+			'theme'
+		);
+		$actual_v1   = $theme_v1->get_data();
+		$expected_v1 = array( 'version' => 2 );
+		$this->assertEqualSetsWithIndex( $expected_v1, $actual_v1 );
+	}
+
+	/**
+	 * @ticket 55505
+	 */
+	function test_export_data_sets_appearance_tools() {
+		$theme = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'settings' => array(
+					'appearanceTools' => true,
+					'blocks'          => array(
+						'core/paragraph' => array(
+							'appearanceTools' => true,
+						),
+					),
+				),
+			)
+		);
+
+		$actual   = $theme->get_data();
+		$expected = array(
+			'version'  => 2,
+			'settings' => array(
+				'appearanceTools' => true,
+				'blocks'          => array(
+					'core/paragraph' => array(
+						'appearanceTools' => true,
+					),
+				),
+			),
+		);
+
+		$this->assertEqualSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_element_class_name_button() {
+		$expected = 'wp-element-button';
+		$actual   = WP_Theme_JSON::get_element_class_name( 'button' );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	public function test_get_element_class_name_invalid() {
+		$expected = '';
+		$actual   = WP_Theme_JSON::get_element_class_name( 'unknown-element' );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing that dynamic properties in theme.json return the value they refrence,
+	 * e.g. array( 'ref' => 'styles.color.background' ) => "#ffffff".
+	 *
+	 * @ticket 56467
+	 */
+	public function test_get_property_value_valid() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'color'    => array(
+						'background' => '#ffffff',
+						'text'       => '#000000',
+					),
+					'elements' => array(
+						'button' => array(
+							'color' => array(
+								'background' => array( 'ref' => 'styles.color.text' ),
+								'text'       => array( 'ref' => 'styles.color.background' ),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;color: #000000;}.wp-element-button, .wp-block-button__link{background-color: #000000;color: #ffffff;}';
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+	}
+
+	/**
+	 * Testing that dynamic properties in theme.json that refer to other dynamic properties in a loop
+	 * should be left untouched.
+	 *
+	 * @ticket 56467
+	 * @expectedIncorrectUsage get_property_value
+	 */
+	public function test_get_property_value_loop() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'color'    => array(
+						'background' => '#ffffff',
+						'text'       => array( 'ref' => 'styles.elements.button.color.background' ),
+					),
+					'elements' => array(
+						'button' => array(
+							'color' => array(
+								'background' => array( 'ref' => 'styles.color.text' ),
+								'text'       => array( 'ref' => 'styles.color.background' ),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;}.wp-element-button, .wp-block-button__link{color: #ffffff;}';
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+	}
+
+	/**
+	 * Testing that dynamic properties in theme.json that refer to other dynamic properties
+	 * should be left unprocessed.
+	 *
+	 * @ticket 56467
+	 * @expectedIncorrectUsage get_property_value
+	 */
+	public function test_get_property_value_recursion() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'color'    => array(
+						'background' => '#ffffff',
+						'text'       => array( 'ref' => 'styles.color.background' ),
+					),
+					'elements' => array(
+						'button' => array(
+							'color' => array(
+								'background' => array( 'ref' => 'styles.color.text' ),
+								'text'       => array( 'ref' => 'styles.color.background' ),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;color: #ffffff;}.wp-element-button, .wp-block-button__link{color: #ffffff;}';
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+	}
+
+	/**
+	 * Testing that dynamic properties in theme.json that refer to themselves
+	 * should be left unprocessed.
+	 *
+	 * @ticket 56467
+	 * @expectedIncorrectUsage get_property_value
+	 */
+	public function test_get_property_value_self() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'color' => array(
+						'background' => '#ffffff',
+						'text'       => array( 'ref' => 'styles.color.text' ),
+					),
+				),
+			)
+		);
+
+		$expected = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{background-color: #ffffff;}';
+		$this->assertSame( $expected, $theme_json->get_stylesheet() );
+	}
+
+
+	/**
+	 * @dataProvider data_get_layout_definitions
+	 *
+	 * @ticket 56467
+	 *
+	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 */
+	public function test_get_stylesheet_generates_layout_styles( $layout_definitions ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'layout'  => array(
+						'definitions' => $layout_definitions,
+					),
+					'spacing' => array(
+						'blockGap' => true,
+					),
+				),
+				'styles'   => array(
+					'spacing' => array(
+						'blockGap' => '1em',
+					),
+				),
+			),
+			'default'
+		);
+
+		// Results also include root site blocks styles.
+		$this->assertSame(
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: 1em; }body { --wp--style--block-gap: 1em; }body .is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}body .is-layout-flow > * + *{margin-block-start: 1em;margin-block-end: 0;}body .is-layout-flex{gap: 1em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}',
+			$theme_json->get_stylesheet( array( 'styles' ) )
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_layout_definitions
+	 *
+	 * @ticket 56467
+	 *
+	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 */
+	public function test_get_stylesheet_generates_layout_styles_with_spacing_presets( $layout_definitions ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'layout'  => array(
+						'definitions' => $layout_definitions,
+					),
+					'spacing' => array(
+						'blockGap' => true,
+					),
+				),
+				'styles'   => array(
+					'spacing' => array(
+						'blockGap' => 'var:preset|spacing|60',
+					),
+				),
+			),
+			'default'
+		);
+
+		// Results also include root site blocks styles.
+		$this->assertSame(
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: var(--wp--preset--spacing--60); }body { --wp--style--block-gap: var(--wp--preset--spacing--60); }body .is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}body .is-layout-flow > * + *{margin-block-start: var(--wp--preset--spacing--60);margin-block-end: 0;}body .is-layout-flex{gap: var(--wp--preset--spacing--60);}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}',
+			$theme_json->get_stylesheet( array( 'styles' ) )
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_layout_definitions
+	 *
+	 * @ticket 56467
+	 *
+	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 */
+	public function test_get_stylesheet_generates_fallback_gap_layout_styles( $layout_definitions ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'layout'  => array(
+						'definitions' => $layout_definitions,
+					),
+					'spacing' => array(
+						'blockGap' => null,
+					),
+				),
+				'styles'   => array(
+					'spacing' => array(
+						'blockGap' => '1em',
+					),
+				),
+			),
+			'default'
+		);
+		$stylesheet = $theme_json->get_stylesheet( array( 'styles' ) );
+
+		// Results also include root site blocks styles.
+		$this->assertSame(
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }:where(.is-layout-flex){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}',
+			$stylesheet
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_layout_definitions
+	 *
+	 * @ticket 56467
+	 *
+	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 */
+	public function test_get_stylesheet_generates_base_fallback_gap_layout_styles( $layout_definitions ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'layout'  => array(
+						'definitions' => $layout_definitions,
+					),
+					'spacing' => array(
+						'blockGap' => null,
+					),
+				),
+			),
+			'default'
+		);
+		$stylesheet = $theme_json->get_stylesheet( array( 'base-layout-styles' ) );
+
+		// Note the `base-layout-styles` includes a fallback gap for the Columns block for backwards compatibility.
+		$this->assertSame(
+			':where(.is-layout-flex){gap: 0.5em;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}:where(.wp-block-columns.is-layout-flex){gap: 2em;}',
+			$stylesheet
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_layout_definitions
+	 *
+	 * @ticket 56467
+	 *
+	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 */
+	public function test_get_stylesheet_skips_layout_styles( $layout_definitions ) {
+		add_theme_support( 'disable-layout-styles' );
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'layout'  => array(
+						'definitions' => $layout_definitions,
+					),
+					'spacing' => array(
+						'blockGap' => null,
+					),
+				),
+			),
+			'default'
+		);
+		$stylesheet = $theme_json->get_stylesheet( array( 'base-layout-styles' ) );
+		remove_theme_support( 'disable-layout-styles' );
+
+		// All Layout styles should be skipped.
+		$this->assertSame(
+			'',
+			$stylesheet
+		);
+	}
+
+	/**
+	 * @dataProvider data_get_layout_definitions
+	 *
+	 * @ticket 56467
+	 *
+	 * @param array $layout_definitions Layout definitions as stored in core theme.json.
+	 */
+	public function test_get_stylesheet_generates_valid_block_gap_values_and_skips_null_or_false_values( $layout_definitions ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'layout'  => array(
+						'definitions' => $layout_definitions,
+					),
+					'spacing' => array(
+						'blockGap' => true,
+					),
+				),
+				'styles'   => array(
+					'spacing' => array(
+						'blockGap' => '1rem',
+					),
+					'blocks'  => array(
+						'core/post-content' => array(
+							'color' => array(
+								'text' => 'gray', // This value should not render block layout styles.
+							),
+						),
+						'core/social-links' => array(
+							'spacing' => array(
+								'blockGap' => '0', // This value should render block layout gap as zero.
+							),
+						),
+						'core/buttons'      => array(
+							'spacing' => array(
+								'blockGap' => 0, // This value should render block layout gap as zero.
+							),
+						),
+						'core/columns'      => array(
+							'spacing' => array(
+								'blockGap' => false, // This value should be ignored. The block will use the global layout value.
+							),
+						),
+					),
+				),
+			),
+			'default'
+		);
+
+		$this->assertEquals(
+			'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }.wp-site-blocks > * { margin-block-start: 0; margin-block-end: 0; }.wp-site-blocks > * + * { margin-block-start: 1rem; }body { --wp--style--block-gap: 1rem; }body .is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}body .is-layout-flow > * + *{margin-block-start: 1rem;margin-block-end: 0;}body .is-layout-flex{gap: 1rem;}body .is-layout-flow > .alignleft{float: left;margin-inline-start: 0;margin-inline-end: 2em;}body .is-layout-flow > .alignright{float: right;margin-inline-start: 2em;margin-inline-end: 0;}body .is-layout-flow > .aligncenter{margin-left: auto !important;margin-right: auto !important;}body .is-layout-flex{display: flex;}body .is-layout-flex{flex-wrap: wrap;align-items: center;}.wp-block-post-content{color: gray;}.wp-block-social-links.is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-social-links.is-layout-flow > * + *{margin-block-start: 0;margin-block-end: 0;}.wp-block-social-links.is-layout-flex{gap: 0;}.wp-block-buttons.is-layout-flow > *{margin-block-start: 0;margin-block-end: 0;}.wp-block-buttons.is-layout-flow > * + *{margin-block-start: 0;margin-block-end: 0;}.wp-block-buttons.is-layout-flex{gap: 0;}',
+			$theme_json->get_stylesheet()
+		);
+	}
+
+	/**
+	 * Data provider for layout tests.
+	 *
+	 * @ticket 56467
+	 *
+	 * @return array
+	 */
+	public function data_get_layout_definitions() {
+		return array(
+			'layout definitions' => array(
+				array(
+					'default' => array(
+						'name'          => 'default',
+						'slug'          => 'flow',
+						'className'     => 'is-layout-flow',
+						'baseStyles'    => array(
+							array(
+								'selector' => ' > .alignleft',
+								'rules'    => array(
+									'float'               => 'left',
+									'margin-inline-start' => '0',
+									'margin-inline-end'   => '2em',
+								),
+							),
+							array(
+								'selector' => ' > .alignright',
+								'rules'    => array(
+									'float'               => 'right',
+									'margin-inline-start' => '2em',
+									'margin-inline-end'   => '0',
+								),
+							),
+							array(
+								'selector' => ' > .aligncenter',
+								'rules'    => array(
+									'margin-left'  => 'auto !important',
+									'margin-right' => 'auto !important',
+								),
+							),
+						),
+						'spacingStyles' => array(
+							array(
+								'selector' => ' > *',
+								'rules'    => array(
+									'margin-block-start' => '0',
+									'margin-block-end'   => '0',
+								),
+							),
+							array(
+								'selector' => ' > * + *',
+								'rules'    => array(
+									'margin-block-start' => null,
+									'margin-block-end'   => '0',
+								),
+							),
+						),
+					),
+					'flex'    => array(
+						'name'          => 'flex',
+						'slug'          => 'flex',
+						'className'     => 'is-layout-flex',
+						'displayMode'   => 'flex',
+						'baseStyles'    => array(
+							array(
+								'selector' => '',
+								'rules'    => array(
+									'flex-wrap'   => 'wrap',
+									'align-items' => 'center',
+								),
+							),
+						),
+						'spacingStyles' => array(
+							array(
+								'selector' => '',
+								'rules'    => array(
+									'gap' => null,
+								),
+							),
+						),
+					),
+				),
+			),
+		);
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	function test_get_styles_for_block_with_padding_aware_alignments() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'styles'   => array(
+					'spacing' => array(
+						'padding' => array(
+							'top'    => '10px',
+							'right'  => '12px',
+							'bottom' => '10px',
+							'left'   => '12px',
+						),
+					),
+				),
+				'settings' => array(
+					'useRootPaddingAwareAlignments' => true,
+				),
+			)
+		);
+
+		$metadata = array(
+			'path'     => array(
+				'0' => 'styles',
+			),
+			'selector' => 'body',
+		);
+
+		$expected    = 'body { margin: 0; }.wp-site-blocks { padding-top: var(--wp--style--root--padding-top); padding-bottom: var(--wp--style--root--padding-bottom); }.has-global-padding { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding :where(.has-global-padding) { padding-right: 0; padding-left: 0; }.has-global-padding > .alignfull { margin-right: calc(var(--wp--style--root--padding-right) * -1); margin-left: calc(var(--wp--style--root--padding-left) * -1); }.has-global-padding :where(.has-global-padding) > .alignfull { margin-right: 0; margin-left: 0; }.has-global-padding > .alignfull:where(:not(.has-global-padding)) > :where([class*="wp-block-"]:not(.alignfull):not([class*="__"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: var(--wp--style--root--padding-right); padding-left: var(--wp--style--root--padding-left); }.has-global-padding :where(.has-global-padding) > .alignfull:where(:not(.has-global-padding)) > :where([class*="wp-block-"]:not(.alignfull):not([class*="__"]),p,h1,h2,h3,h4,h5,h6,ul,ol) { padding-right: 0; padding-left: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{--wp--style--root--padding-top: 10px;--wp--style--root--padding-right: 12px;--wp--style--root--padding-bottom: 10px;--wp--style--root--padding-left: 12px;}';
+		$root_rules  = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
+		$style_rules = $theme_json->get_styles_for_block( $metadata );
+		$this->assertSame( $expected, $root_rules . $style_rules );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	function test_get_styles_for_block_without_padding_aware_alignments() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'spacing' => array(
+						'padding' => array(
+							'top'    => '10px',
+							'right'  => '12px',
+							'bottom' => '10px',
+							'left'   => '12px',
+						),
+					),
+				),
+			)
+		);
+
+		$metadata = array(
+			'path'     => array(
+				'0' => 'styles',
+			),
+			'selector' => 'body',
+		);
+
+		$expected    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{padding-top: 10px;padding-right: 12px;padding-bottom: 10px;padding-left: 12px;}';
+		$root_rules  = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
+		$style_rules = $theme_json->get_styles_for_block( $metadata );
+		$this->assertSame( $expected, $root_rules . $style_rules );
+	}
+
+	/**
+	 * @ticket 56467
+	 */
+	function test_get_styles_for_block_with_content_width() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => 2,
+				'settings' => array(
+					'layout' => array(
+						'contentSize' => '800px',
+						'wideSize'    => '1000px',
+					),
+				),
+			)
+		);
+
+		$metadata = array(
+			'path'     => array(
+				'0' => 'settings',
+			),
+			'selector' => 'body',
+		);
+
+		$expected    = 'body { margin: 0;--wp--style--global--content-size: 800px;--wp--style--global--wide-size: 1000px; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$root_rules  = $theme_json->get_root_layout_rules( WP_Theme_JSON::ROOT_BLOCK_SELECTOR, $metadata );
+		$style_rules = $theme_json->get_styles_for_block( $metadata );
+		$this->assertSame( $expected, $root_rules . $style_rules );
+	}
 }
diff --git a/tests/theme/wpThemeJsonResolver.php b/tests/theme/wpThemeJsonResolver.php
index b2c7d8c09b..aa9c339e58 100644
--- a/tests/theme/wpThemeJsonResolver.php
+++ b/tests/theme/wpThemeJsonResolver.php
@@ -12,6 +12,27 @@
  */
 class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
+	/**
+	 * Queries.
+	 *
+	 * @var array
+	 */
+	private $queries = array();
+
 	public function set_up() {
 		parent::set_up();
 		$this->theme_root = realpath( DIR_TESTDATA . '/themedir1' );
@@ -61,13 +82,15 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		load_textdomain( 'block-theme', realpath( DIR_TESTDATA . '/languages/themes/block-theme-pl_PL.mo' ) );
 
 		switch_theme( 'block-theme' );
-		$actual = WP_Theme_JSON_Resolver::get_theme_data();
+		$theme_data       = WP_Theme_JSON_Resolver::get_theme_data();
+		$style_variations = WP_Theme_JSON_Resolver::get_style_variations();
 
 		unload_textdomain( 'block-theme' );
 		remove_filter( 'locale', array( $this, 'filter_set_locale_to_polish' ) );
 
-		$this->assertSame( wp_get_theme()->get( 'TextDomain' ), 'block-theme' );
-		$this->assertSame(
+		$this->assertSame( 'block-theme', wp_get_theme()->get( 'TextDomain' ) );
+		$this->assertSame( 'Motyw blokowy', $theme_data->get_data()['title'] );
+		$this->assertSameSets(
 			array(
 				'color'      => array(
 					'custom'         => false,
@@ -129,25 +152,30 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 					),
 				),
 			),
-			$actual->get_settings()
+			$theme_data->get_settings()
 		);
+
+		$custom_templates = $theme_data->get_custom_templates();
+		$this->assertArrayHasKey( 'page-home', $custom_templates );
 		$this->assertSame(
-			$actual->get_custom_templates(),
+			$custom_templates['page-home'],
 			array(
-				'page-home' => array(
-					'title'     => 'Szablon strony głównej',
-					'postTypes' => array( 'page' ),
-				),
+				'title'     => 'Szablon strony głównej',
+				'postTypes' => array( 'page' ),
 			)
 		);
-		$this->assertSame(
-			$actual->get_template_parts(),
+		$this->assertSameSets(
 			array(
 				'small-header' => array(
 					'title' => 'Mały nagłówek',
 					'area'  => 'header',
 				),
-			)
+			),
+			$theme_data->get_template_parts()
+		);
+		$this->assertSame(
+			'Wariant motywu blokowego',
+			$style_variations[0]['title']
 		);
 	}
 
@@ -313,37 +341,93 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		$this->assertSame(
 			WP_Theme_JSON_Resolver::get_theme_data()->get_custom_templates(),
 			array(
-				'page-home' => array(
+				'page-home'                   => array(
 					'title'     => 'Homepage',
 					'postTypes' => array( 'page' ),
 				),
+				'custom-single-post-template' => array(
+					'title'     => 'Custom Single Post template',
+					'postTypes' => array( 'post' ),
+				),
 			)
 		);
 	}
 
-	function test_get_user_data_from_custom_post_type_does_not_use_uncached_queries() {
+	/**
+	 * @covers WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles
+	 */
+	function test_get_user_data_from_wp_global_styles_does_not_use_uncached_queries() {
+		$theme = wp_get_theme();
+		WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme );
 		add_filter( 'query', array( $this, 'filter_db_query' ) );
 		$query_count = count( $this->queries );
 		for ( $i = 0; $i < 3; $i++ ) {
-			WP_Theme_JSON_Resolver::get_user_data_from_custom_post_type( wp_get_theme() );
+			WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme );
 			WP_Theme_JSON_Resolver::clean_cached_data();
 		}
 		$query_count = count( $this->queries ) - $query_count;
-		$this->assertEquals( 1, $query_count, 'Only one SQL query should be peformed for multiple invocations of WP_Theme_JSON_Resolver::get_user_data_from_custom_post_type()' );
+		$this->assertEquals( 0, $query_count, 'Unexpected SQL queries detected for the wp_global_style post type' );
 
-		$user_cpt = WP_Theme_JSON_Resolver::get_user_data_from_custom_post_type( wp_get_theme() );
+		$user_cpt = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme );
 		$this->assertEmpty( $user_cpt );
 
-		$user_cpt = WP_Theme_JSON_Resolver::get_user_data_from_custom_post_type( wp_get_theme(), true );
+		$user_cpt = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme, true );
 		$this->assertNotEmpty( $user_cpt );
 
 		$query_count = count( $this->queries );
-		for ( $i = 0; $i < 3; $i++ ) {
-			WP_Theme_JSON_Resolver::get_user_data_from_custom_post_type( wp_get_theme() );
+		for ( $i = 0; $i < 3; $i ++ ) {
+			$new_user_cpt = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme );
 			WP_Theme_JSON_Resolver::clean_cached_data();
+			$this->assertSameSets( $user_cpt, $new_user_cpt );
 		}
 		$query_count = count( $this->queries ) - $query_count;
 		$this->assertEquals( 0, $query_count, 'Unexpected SQL queries detected for the wp_global_style post type' );
 		remove_filter( 'query', array( $this, 'filter_db_query' ) );
 	}
+
+	/**
+	 * @ticket 55392
+	 * @covers WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles
+	 */
+	function test_get_user_data_from_wp_global_styles_does_exist() {
+		$theme = wp_get_theme();
+		$post1 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme, true );
+		$this->assertIsArray( $post1 );
+		$this->assertArrayHasKey( 'ID', $post1 );
+		wp_delete_post( $post1['ID'], true );
+		$post2 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme, true );
+		$this->assertIsArray( $post2 );
+		$this->assertArrayHasKey( 'ID', $post2 );
+	}
+
+	/**
+	 * @ticket 55392
+	 * @covers WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles
+	 */
+	function test_get_user_data_from_wp_global_styles_create_post() {
+		$theme = wp_get_theme( 'testing' );
+		$post1 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme );
+		$this->assertIsArray( $post1 );
+		$this->assertSameSets( array(), $post1 );
+		$post2 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme );
+		$this->assertIsArray( $post2 );
+		$this->assertSameSets( array(), $post2 );
+		$post3 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme, true );
+		$this->assertIsArray( $post3 );
+		$this->assertArrayHasKey( 'ID', $post3 );
+	}
+
+	/**
+	 * @ticket 55392
+	 * @covers WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles
+	 */
+	function test_get_user_data_from_wp_global_styles_filter_state() {
+		$theme = wp_get_theme( 'foo' );
+		$post1 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme, true, array( 'publish' ) );
+		$this->assertIsArray( $post1 );
+		$this->assertArrayHasKey( 'ID', $post1 );
+		$post2 = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( $theme, false, array( 'draft' ) );
+		$this->assertIsArray( $post2 );
+		$this->assertSameSets( array(), $post2 );
+	}
 }
diff --git a/tests/url.php b/tests/url.php
index ff360fdea4..1561d3a03c 100644
--- a/tests/url.php
+++ b/tests/url.php
@@ -14,6 +14,8 @@ class Tests_URL extends WP_UnitTestCase {
 
 	/**
 	 * @dataProvider data_is_ssl
+	 *
+	 * @covers ::is_ssl
 	 */
 	public function test_is_ssl( $value, $expected ) {
 		$_SERVER['HTTPS'] = $value;
@@ -47,6 +49,9 @@ class Tests_URL extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @covers ::is_ssl
+	 */
 	public function test_is_ssl_by_port() {
 		unset( $_SERVER['HTTPS'] );
 		$_SERVER['SERVER_PORT'] = '443';
@@ -55,6 +60,9 @@ class Tests_URL extends WP_UnitTestCase {
 		$this->assertTrue( $is_ssl );
 	}
 
+	/**
+	 * @covers ::is_ssl
+	 */
 	public function test_is_ssl_with_no_value() {
 		unset( $_SERVER['HTTPS'] );
 
@@ -67,6 +75,8 @@ class Tests_URL extends WP_UnitTestCase {
 	 *
 	 * @param string $url      Test URL.
 	 * @param string $expected Expected result.
+	 *
+	 * @covers ::admin_url
 	 */
 	public function test_admin_url( $url, $expected ) {
 		$siteurl_http   = get_option( 'siteurl' );
@@ -135,6 +145,8 @@ class Tests_URL extends WP_UnitTestCase {
 	 *
 	 * @param string $url      Test URL.
 	 * @param string $expected Expected result.
+	 *
+	 * @covers ::home_url
 	 */
 	public function test_home_url( $url, $expected ) {
 		$homeurl_http  = get_option( 'home' );
@@ -198,6 +210,9 @@ class Tests_URL extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @covers ::home_url
+	 */
 	public function test_home_url_from_admin() {
 		// Pretend to be in the site admin.
 		set_current_screen( 'dashboard' );
@@ -243,6 +258,9 @@ class Tests_URL extends WP_UnitTestCase {
 		update_option( 'home', set_url_scheme( $home, 'http' ) );
 	}
 
+	/**
+	 * @covers ::network_home_url
+	 */
 	public function test_network_home_url_from_admin() {
 		// Pretend to be in the site admin.
 		set_current_screen( 'dashboard' );
@@ -264,6 +282,9 @@ class Tests_URL extends WP_UnitTestCase {
 		$this->assertSame( $home_https, network_home_url() );
 	}
 
+	/**
+	 * @covers ::set_url_scheme
+	 */
 	public function test_set_url_scheme() {
 		$links = array(
 			'http://wordpress.org/',
@@ -324,6 +345,9 @@ class Tests_URL extends WP_UnitTestCase {
 		force_ssl_admin( $forced_admin );
 	}
 
+	/**
+	 * @covers ::get_adjacent_post
+	 */
 	public function test_get_adjacent_post() {
 		$now      = time();
 		$post_id  = self::factory()->post->create( array( 'post_date' => gmdate( 'Y-m-d H:i:s', $now - 1 ) ) );
@@ -358,6 +382,8 @@ class Tests_URL extends WP_UnitTestCase {
 	 * Test get_adjacent_post returns the next private post when the author is the currently logged in user.
 	 *
 	 * @ticket 30287
+	 *
+	 * @covers ::get_adjacent_post
 	 */
 	public function test_get_adjacent_post_should_return_private_posts_belonging_to_the_current_user() {
 		$u       = self::factory()->user->create( array( 'role' => 'author' ) );
@@ -395,6 +421,8 @@ class Tests_URL extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30287
+	 *
+	 * @covers ::get_adjacent_post
 	 */
 	public function test_get_adjacent_post_should_return_private_posts_belonging_to_other_users_if_the_current_user_can_read_private_posts() {
 		$u1      = self::factory()->user->create( array( 'role' => 'author' ) );
@@ -433,6 +461,8 @@ class Tests_URL extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 30287
+	 *
+	 * @covers ::get_adjacent_post
 	 */
 	public function test_get_adjacent_post_should_not_return_private_posts_belonging_to_other_users_if_the_current_user_cannot_read_private_posts() {
 		$u1      = self::factory()->user->create( array( 'role' => 'author' ) );
@@ -479,6 +509,17 @@ class Tests_URL extends WP_UnitTestCase {
 	 * Test that *_url functions handle paths with ".."
 	 *
 	 * @ticket 19032
+	 *
+	 * @covers ::site_url
+	 * @covers ::home_url
+	 * @covers ::admin_url
+	 * @covers ::network_admin_url
+	 * @covers ::user_admin_url
+	 * @covers ::includes_url
+	 * @covers ::network_site_url
+	 * @covers ::network_home_url
+	 * @covers ::content_url
+	 * @covers ::plugins_url
 	 */
 	public function test_url_functions_for_dots_in_paths() {
 		$functions = array(
diff --git a/tests/url/getPrivacyPolicyUrl.php b/tests/url/getPrivacyPolicyUrl.php
index 7c06cf4fda..ad0c9c1f00 100644
--- a/tests/url/getPrivacyPolicyUrl.php
+++ b/tests/url/getPrivacyPolicyUrl.php
@@ -12,9 +12,10 @@
  *
  * @group url
  * @group privacy
- * @covers ::get_privacy_policy_url
  *
  * @since 4.9.6
+ *
+ * @covers ::get_privacy_policy_url
  */
 class Tests_Url_GetPrivacyPolicyUrl extends WP_UnitTestCase {
 	/**
@@ -64,13 +65,6 @@ class Tests_Url_GetPrivacyPolicyUrl extends WP_UnitTestCase {
 		$this->assertSame( $privacy_policy_url, get_privacy_policy_url() );
 	}
 
-	/**
-	 * The function should return an empty string when `wp_page_for_privacy_policy` is _not_ set.
-	 */
-	public function test_get_privacy_policy_url_should_return_empty_when_privacy_policy_page_not_set() {
-		$this->assertSame( '', get_privacy_policy_url() );
-	}
-
 	/**
 	 * The function should return an empty string for an invalid `wp_page_for_privacy_policy` value.
 	 */
diff --git a/tests/user.php b/tests/user.php
index caa9a5e24d..4efb134c05 100644
--- a/tests/user.php
+++ b/tests/user.php
@@ -104,7 +104,7 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertSame( $val, get_user_option( $key, self::$author_id ) );
 
 		// Change and get again.
-		$val2 = rand_str();
+		$val2 = 'baz';
 		update_user_option( self::$author_id, $key, $val2 );
 		$this->assertSame( $val2, get_user_option( $key, self::$author_id ) );
 	}
@@ -135,7 +135,7 @@ class Tests_User extends WP_UnitTestCase {
 		// Delete by key AND value.
 		update_user_meta( self::$author_id, $key, $val );
 		// Incorrect key: key still exists.
-		delete_user_meta( self::$author_id, $key, rand_str() );
+		delete_user_meta( self::$author_id, $key, 'foo' );
 		$this->assertSame( $val, get_user_meta( self::$author_id, $key, true ) );
 		// Correct key: deleted.
 		delete_user_meta( self::$author_id, $key, $val );
@@ -149,9 +149,9 @@ class Tests_User extends WP_UnitTestCase {
 	public function test_usermeta_array() {
 		// Some values to set.
 		$vals = array(
-			rand_str() => 'val-' . rand_str(),
-			rand_str() => 'val-' . rand_str(),
-			rand_str() => 'val-' . rand_str(),
+			'key0' => 'val0',
+			'key1' => 'val1',
+			'key2' => 'val2',
 		);
 
 		// There is already some stuff in the array.
@@ -475,8 +475,8 @@ class Tests_User extends WP_UnitTestCase {
 		$post = array(
 			'post_author'  => self::$author_id,
 			'post_status'  => 'publish',
-			'post_content' => rand_str(),
-			'post_title'   => rand_str(),
+			'post_content' => 'content',
+			'post_title'   => 'title',
 			'post_type'    => 'post',
 		);
 
@@ -636,7 +636,7 @@ class Tests_User extends WP_UnitTestCase {
 	public function test_user_meta_error() {
 		$id1 = wp_insert_user(
 			array(
-				'user_login' => rand_str(),
+				'user_login' => 'taco_burrito',
 				'user_pass'  => 'password',
 				'user_email' => 'taco@burrito.com',
 			)
@@ -645,7 +645,7 @@ class Tests_User extends WP_UnitTestCase {
 
 		$id2 = wp_insert_user(
 			array(
-				'user_login' => rand_str(),
+				'user_login' => 'taco_burrito2',
 				'user_pass'  => 'password',
 				'user_email' => 'taco@burrito.com',
 			)
@@ -826,9 +826,9 @@ class Tests_User extends WP_UnitTestCase {
 	 */
 	public function test_wp_insert_user_should_not_wipe_existing_password() {
 		$user_details = array(
-			'user_login' => rand_str(),
+			'user_login' => 'jonsnow',
 			'user_pass'  => 'password',
-			'user_email' => rand_str() . '@example.com',
+			'user_email' => 'jonsnow@example.com',
 		);
 
 		$user_id = wp_insert_user( $user_details );
@@ -1000,6 +1000,24 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertSame( $expected, $user->user_nicename );
 	}
 
+	/**
+	 * @ticket 44107
+	 */
+	public function test_wp_insert_user_should_reject_user_url_over_100_characters() {
+		$user_url = str_repeat( 'a', 101 );
+		$u        = wp_insert_user(
+			array(
+				'user_login' => 'test',
+				'user_email' => 'test@example.com',
+				'user_pass'  => 'password',
+				'user_url'   => $user_url,
+			)
+		);
+
+		$this->assertWPError( $u );
+		$this->assertSame( 'user_url_too_long', $u->get_error_code() );
+	}
+
 	/**
 	 * @ticket 28004
 	 */
@@ -1325,6 +1343,129 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertFalse( $was_user_email_sent );
 	}
 
+	/**
+	 * Test that admin notification of a new user registration is dependent
+	 * on the 'wp_send_new_user_notification_to_admin' filter.
+	 *
+	 * @dataProvider data_wp_send_new_user_notification_filters
+	 *
+	 * @ticket 54874
+	 *
+	 * @covers ::wp_new_user_notification
+	 *
+	 * @param bool   $expected Whether the email should be sent.
+	 * @param string $callback The callback to pass to the filter.
+	 */
+	public function test_wp_send_new_user_notification_to_admin_filter( $expected, $callback ) {
+		reset_phpmailer_instance();
+
+		add_filter( 'wp_send_new_user_notification_to_admin', $callback );
+
+		wp_new_user_notification( self::$contrib_id, null, 'admin' );
+
+		$mailer    = tests_retrieve_phpmailer_instance();
+		$recipient = $mailer->get_recipient( 'to' );
+		$actual    = $recipient ? WP_TESTS_EMAIL === $recipient->address : false;
+
+		$this->assertSame( $expected, $actual, 'Admin email result was not as expected in test_wp_send_new_user_notification_to_admin_filter' );
+	}
+
+	/**
+	 * Test that user notification of a new user registration is dependent
+	 * on the 'wp_send_new_user_notification_to_user' filter.
+	 *
+	 * @dataProvider data_wp_send_new_user_notification_filters
+	 *
+	 * @ticket 54874
+	 *
+	 * @covers ::wp_new_user_notification
+	 *
+	 * @param bool   $expected Whether the email should be sent.
+	 * @param string $callback The callback to pass to the filter.
+	 */
+	public function test_wp_send_new_user_notification_to_user_filter( $expected, $callback ) {
+		reset_phpmailer_instance();
+
+		add_filter( 'wp_send_new_user_notification_to_user', $callback );
+
+		wp_new_user_notification( self::$contrib_id, null, 'user' );
+
+		$mailer    = tests_retrieve_phpmailer_instance();
+		$recipient = $mailer->get_recipient( 'to' );
+		$actual    = $recipient ? 'blackburn@battlefield3.com' === $recipient->address : false;
+
+		$this->assertSame( $expected, $actual, 'User email result was not as expected in test_wp_send_new_user_notification_to_user_filter' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_wp_send_new_user_notification_filters() {
+		return array(
+			'true'          => array(
+				'expected' => true,
+				'callback' => '__return_true',
+			),
+			'false'         => array(
+				'expected' => false,
+				'callback' => '__return_false',
+			),
+			'null'          => array(
+				'expected' => false,
+				'callback' => '__return_null',
+			),
+			'empty array'   => array(
+				'expected' => false,
+				'callback' => '__return_empty_array',
+			),
+			'zero int'      => array(
+				'expected' => false,
+				'callback' => '__return_zero',
+			),
+			'zero float'    => array(
+				'expected' => false,
+				'callback' => array( $this, 'cb_return_zero_float' ),
+			),
+			'zero string'   => array(
+				'expected' => false,
+				'callback' => array( $this, 'cb_return_zero_string' ),
+			),
+			'array( true )' => array(
+				'expected' => false,
+				'callback' => array( $this, 'cb_return_array_true' ),
+			),
+		);
+	}
+
+	/**
+	 * Callback that returns 0.0.
+	 *
+	 * @return float 0.0.
+	 */
+	public function cb_return_zero_float() {
+		return 0.0;
+	}
+
+	/**
+	 * Callback that returns '0'.
+	 *
+	 * @return string '0'.
+	 */
+	public function cb_return_zero_string() {
+		return '0';
+	}
+
+	/**
+	 * Callback that returns array( true ).
+	 *
+	 * @return array array( true )
+	 */
+	public function cb_return_array_true() {
+		return array( true );
+	}
+
 	/**
 	 * Ensure blog's admin email change notification emails do not contain encoded HTML entities
 	 *
@@ -1555,7 +1696,7 @@ class Tests_User extends WP_UnitTestCase {
 		reset_phpmailer_instance();
 		$was_confirmation_email_sent = false;
 
-		$user = $this->factory()->user->create_and_get(
+		$user = self::factory()->user->create_and_get(
 			array(
 				'user_email' => 'before@example.com',
 			)
@@ -1592,7 +1733,7 @@ class Tests_User extends WP_UnitTestCase {
 		reset_phpmailer_instance();
 		$was_confirmation_email_sent = false;
 
-		$user = $this->factory()->user->create_and_get(
+		$user = self::factory()->user->create_and_get(
 			array(
 				'user_email' => 'before@example.com',
 			)
@@ -1869,6 +2010,7 @@ class Tests_User extends WP_UnitTestCase {
 		$update_data = array(
 			'ID'         => $create_user,
 			'user_login' => 'test_user',
+			'user_email' => 'user@example.com',
 			'meta_input' => array(
 				'test_meta_key' => 'test_meta_updated',
 				'custom_meta'   => 'updated_value',
@@ -1909,9 +2051,9 @@ class Tests_User extends WP_UnitTestCase {
 	 * This hook is used in `test_wp_insert_user_with_meta()`.
 	 */
 	public function filter_custom_meta( $meta_input ) {
-		// Update some meta inputs
+		// Update some meta inputs.
 		$meta_input['test_meta_key'] = 'update_from_filter';
-		// Add a new meta
+		// Add a new meta.
 		$meta_input['new_meta_from_filter'] = 'new_from_filter';
 
 		return $meta_input;
@@ -1956,7 +2098,7 @@ class Tests_User extends WP_UnitTestCase {
 			)
 		);
 
-		// _doing_wrong() should be called because the filter callback
+		// _doing_it_wrong() should be called because the filter callback
 		// adds a item with a 'name' that is the same as one generated by core.
 		$this->setExpectedIncorrectUsage( 'wp_user_personal_data_exporter' );
 		add_filter( 'wp_privacy_additional_user_profile_data', array( $this, 'export_additional_user_profile_data_with_dup_name' ) );
diff --git a/tests/user/author.php b/tests/user/author.php
index 5786578855..311bbcd6f2 100644
--- a/tests/user/author.php
+++ b/tests/user/author.php
@@ -19,6 +19,7 @@ class Tests_User_Author_Template extends WP_UnitTestCase {
 				'user_login'   => 'test_author',
 				'display_name' => 'Test Author',
 				'description'  => 'test_author',
+				'user_url'     => 'http://example.com',
 			)
 		);
 
@@ -26,8 +27,8 @@ class Tests_User_Author_Template extends WP_UnitTestCase {
 			array(
 				'post_author'  => self::$author_id,
 				'post_status'  => 'publish',
-				'post_content' => rand_str(),
-				'post_title'   => rand_str(),
+				'post_content' => 'content',
+				'post_title'   => 'title',
 				'post_type'    => 'post',
 			)
 		);
@@ -144,4 +145,34 @@ class Tests_User_Author_Template extends WP_UnitTestCase {
 		unset( $GLOBALS['authordata'] );
 	}
 
+	/**
+	 * @ticket 51859
+	 *
+	 * @covers ::get_the_author_link
+	 */
+	public function test_get_the_author_link() {
+		$author_url          = get_the_author_meta( 'url' );
+		$author_display_name = get_the_author();
+
+		$link = get_the_author_link();
+
+		$this->assertStringContainsString( $author_url, $link, 'The link does not contain the author URL' );
+		$this->assertStringContainsString( $author_display_name, $link, 'The link does not contain the author display name' );
+	}
+
+	/**
+	 * @ticket 51859
+	 *
+	 * @covers ::get_the_author_link
+	 */
+	public function test_filtered_get_the_author_link() {
+		$filter = new MockAction();
+
+		add_filter( 'the_author_link', array( &$filter, 'filter' ) );
+
+		get_the_author_link();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+		$this->assertSame( array( 'the_author_link' ), $filter->get_hook_names() );
+	}
 }
diff --git a/tests/user/capabilities.php b/tests/user/capabilities.php
index 496de9487a..3e49adc39d 100644
--- a/tests/user/capabilities.php
+++ b/tests/user/capabilities.php
@@ -30,6 +30,15 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 	 */
 	protected static $block_id;
 
+	/**
+	 * Temporary storage for roles for tests using filter callbacks.
+	 *
+	 * Used in the `test_wp_roles_init_action()` method.
+	 *
+	 * @var array
+	 */
+	private $role_test_wp_roles_init;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$users       = array(
 			'anonymous'     => new WP_User( 0 ),
@@ -60,6 +69,15 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 	}
 
+	/**
+	 * Clean up after each test.
+	 */
+	public function tear_down() {
+		unset( $this->role_test_wp_roles_init );
+
+		parent::tear_down();
+	}
+
 	public static function wpTearDownAfterClass() {
 		wp_delete_post( self::$block_id, true );
 	}
@@ -980,6 +998,461 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$this->assertFalse( $wp_roles->is_role( $role_name ) );
 	}
 
+	/**
+	 * @dataProvider data_update_role_unhappy_paths
+	 *
+	 * @ticket 54572
+	 *
+	 * @covers WP_Roles::update_role
+	 * @covers ::update_role
+	 *
+	 * @param mixed $role         The role to update.
+	 * @param mixed $display_name The display name for the role.
+	 * @param mixed $capabilities The capabilities for the role.
+	 */
+	public function test_update_role_unhappy_paths( $role, $display_name, $capabilities ) {
+		global $wp_roles;
+
+		// Create role if it does not exist.
+		$role_name     = 'janitor';
+		$expected_caps = array(
+			'edit_posts' => true,
+			'edit_pages' => true,
+			'level_0'    => true,
+			'level_1'    => true,
+			'level_2'    => true,
+		);
+		add_role( $role_name, 'Janitor', $expected_caps );
+		$this->flush_roles();
+
+		$this->assertTrue(
+			$wp_roles->is_role( $role_name ),
+			"The $role_name role was not created"
+		);
+
+		$this->assertNotInstanceOf(
+			'WP_Role',
+			update_role( $role, $display_name, $capabilities ),
+			"The $role_name role was updated"
+		);
+
+		// Clean up.
+		remove_role( $role_name );
+		$this->flush_roles();
+		$this->assertFalse(
+			$wp_roles->is_role( $role_name ),
+			"The $role_name role was not removed"
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_update_role_unhappy_paths() {
+		return array(
+			'true as the role'                       => array(
+				'role'         => true,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'false as the role'                      => array(
+				'role'         => false,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'null as the role'                       => array(
+				'role'         => null,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(int) 1 as the role'                    => array(
+				'role'         => 1,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(float) 1.0 as the role'                => array(
+				'role'         => 1.0,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(int) 0 as the role'                    => array(
+				'role'         => 0,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(float) 0.0 as the role'                => array(
+				'role'         => 0.0,
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'an empty string as the role'            => array(
+				'role'         => '',
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'a string with only a space as the role' => array(
+				'role'         => ' ',
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'an empty array as the role'             => array(
+				'role'         => array(),
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'a non-empty array as the role'          => array(
+				'role'         => array( 'janitor' ),
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'an object as the role'                  => array(
+				'role'         => (object) array( 'janitor' ),
+				'display_name' => 'Janitor',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'true as the display name'               => array(
+				'role'         => 'janitor',
+				'display_name' => true,
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'false as the display name'              => array(
+				'role'         => 'janitor',
+				'display_name' => false,
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(int) 1 as the display name'            => array(
+				'role'         => 'janitor',
+				'display_name' => 1,
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(float) 1.0 as the display name'        => array(
+				'role'         => 'janitor',
+				'display_name' => 1.0,
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(int) 0 as the display name'            => array(
+				'role'         => 'janitor',
+				'display_name' => 0,
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'(float) 0.0 as the display name'        => array(
+				'role'         => 'janitor',
+				'display_name' => 0.0,
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'an empty string as the display name'    => array(
+				'role'         => 'janitor',
+				'display_name' => '',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'a string with only a space as the display name' => array(
+				'role'         => 'janitor',
+				'display_name' => ' ',
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'an empty array as the display name'     => array(
+				'role'         => 'janitor',
+				'display_name' => array(),
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'a non-empty array as the display name'  => array(
+				'role'         => 'janitor',
+				'display_name' => array( 'Janitor' ),
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'an object as the display name'          => array(
+				'role'         => 'janitor',
+				'display_name' => (object) array( 'Janitor' ),
+				'capabilities' => array(
+					'level_1' => true,
+				),
+			),
+			'true as the capabilities'               => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => true,
+			),
+			'false as the capabilities'              => array(
+				'role'         => (object) array( 'janitor' ),
+				'display_name' => 'Janitor',
+				'capabilities' => false,
+			),
+			'(int) 1 as the capabilities'            => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => 1,
+			),
+			'(float) 1.0 as the capabilities'        => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => 1.0,
+			),
+			'(int) 0 as the capabilities'            => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => 0,
+			),
+			'(float) 0.0 as the capabilities'        => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => 0.0,
+			),
+			'an empty string as the capabilities'    => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => '',
+			),
+			'a string with only a space as the capabilities' => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => ' ',
+			),
+			'an object as the capabilities'          => array(
+				'role'         => 'janitor',
+				'display_name' => 'Janitor',
+				'capabilities' => (object) array( 'level_1' => true ),
+			),
+		);
+	}
+
+	/**
+	 * @ticket 54572
+	 *
+	 * @covers WP_Roles::update_role
+	 * @covers ::update_role
+	 */
+	public function test_update_role_should_create_a_role_if_it_does_not_exist() {
+		global $wp_roles;
+
+		// Create role if it does not exist.
+		$role_name     = 'janitor';
+		$expected_caps = array(
+			'edit_posts' => true,
+			'edit_pages' => true,
+			'level_0'    => true,
+			'level_1'    => true,
+			'level_2'    => true,
+		);
+		update_role( $role_name, 'Janitor', $expected_caps );
+		$this->flush_roles();
+		$this->assertTrue( $wp_roles->is_role( $role_name ) );
+	}
+
+	/**
+	 * @ticket 54572
+	 *
+	 * @covers WP_Roles::update_role
+	 * @covers ::update_role
+	 */
+	public function test_update_role_should_change_the_display_name_of_a_role() {
+		global $wp_roles;
+		$role_name = 'janitor';
+
+		add_role( $role_name, 'Janitor', array( 'level_1' => true ) );
+		$this->flush_roles();
+
+		$expected_display_name = 'Janitor Executive';
+		update_role( $role_name, $expected_display_name );
+		$this->flush_roles();
+
+		$this->assertSame(
+			$expected_display_name,
+			$wp_roles->roles[ $role_name ]['name'],
+			'The expected display name was not correct'
+		);
+		$this->assertSame(
+			array( 'level_1' => true ),
+			$wp_roles->roles[ $role_name ]['capabilities'],
+			'The expected capabilities were not correct'
+		);
+
+		// Clean up.
+		remove_role( $role_name );
+		$this->flush_roles();
+		$this->assertFalse(
+			$wp_roles->is_role( $role_name ),
+			"The $role_name role was not removed"
+		);
+	}
+
+	/**
+	 * @dataProvider data_update_role_should_change_the_capabilities_of_a_role
+	 *
+	 * @ticket 54572
+	 *
+	 * @covers WP_Roles::update_role
+	 * @covers ::update_role
+	 *
+	 * @param array $capabilities An array of capabilities.
+	 */
+	public function test_update_role_should_change_the_capabilities_of_a_role( $capabilities ) {
+		global $wp_roles;
+		$role_name = 'janitor';
+
+		add_role( $role_name, 'Janitor', array( 'level_1' => true ) );
+		$this->flush_roles();
+
+		update_role( $role_name, null, $capabilities );
+		$this->flush_roles();
+
+		$this->assertSame(
+			'Janitor',
+			$wp_roles->roles[ $role_name ]['name'],
+			'The display name was changed'
+		);
+		$this->assertSame(
+			$capabilities,
+			$wp_roles->roles[ $role_name ]['capabilities'],
+			'The expected capabilities were not correct'
+		);
+
+		// Clean up.
+		remove_role( $role_name );
+		$this->flush_roles();
+		$this->assertFalse(
+			$wp_roles->is_role( $role_name ),
+			"The $role_name role was not removed"
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_update_role_should_change_the_capabilities_of_a_role() {
+		return array(
+			'an empty array'           => array( 'capabilities' => array() ),
+			'an array of capabilities' => array( 'capabilities' => array( 'level_2' => true ) ),
+		);
+	}
+
+	/**
+	 * @ticket 54572
+	 *
+	 * @covers WP_Roles::update_role
+	 * @covers ::update_role
+	 */
+	public function test_update_role_should_change_display_name_and_capabilities_of_role() {
+		global $wp_roles;
+		$role_name = 'janitor';
+
+		add_role( $role_name, 'Janitor', array( 'level_1' => true ) );
+		$this->flush_roles();
+
+		$expected_display_name = 'Janitor Manager';
+		$new_expected_caps     = array(
+			'level_3' => true,
+			'level_4' => true,
+		);
+		update_role( $role_name, $expected_display_name, $new_expected_caps );
+		$this->flush_roles();
+
+		$this->assertSame(
+			$expected_display_name,
+			$wp_roles->roles[ $role_name ]['name'],
+			'The expected display name was not correct'
+		);
+
+		$this->assertSame(
+			$new_expected_caps,
+			$wp_roles->roles[ $role_name ]['capabilities'],
+			'The expected capabilities were not correct'
+		);
+
+		// Clean up.
+		remove_role( $role_name );
+		$this->flush_roles();
+		$this->assertFalse(
+			$wp_roles->is_role( $role_name ),
+			"The $role_name role was not removed"
+		);
+	}
+
+	/**
+	 * @ticket 54572
+	 *
+	 * @covers WP_Roles::update_role
+	 * @covers ::update_role
+	 */
+	public function test_update_role_should_change_capabilities_of_a_user() {
+		global $wp_roles;
+		$role_name = 'janitor';
+
+		add_role( $role_name, 'Janitor', array( 'level_1' => true ) );
+		$this->flush_roles();
+
+		// Assign a user to the role.
+		$id = self::factory()->user->create( array( 'role' => $role_name ) );
+
+		// Update empty capabilities.
+		update_role( $role_name, null, array( 'level_2' => true ) );
+		$this->flush_roles();
+
+		$this->assertTrue(
+			user_can( $id, 'level_2' ),
+			'The user does not have level_2 capabilities'
+		);
+		$this->assertFalse(
+			user_can( $id, 'level_1' ),
+			'The user has level_1 capabilities'
+		);
+
+		// Clean up.
+		remove_role( $role_name );
+		$this->flush_roles();
+		$this->assertFalse(
+			$wp_roles->is_role( $role_name ),
+			"The $role_name role was not removed"
+		);
+	}
+
 	/**
 	 * Change the capabilites associated with a role and make sure the change
 	 * is reflected in has_cap().
@@ -1595,6 +2068,7 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 		$editor = self::$users['editor'];
 
+		$this->setExpectedIncorrectUsage( 'map_meta_cap' );
 		foreach ( $caps as $cap ) {
 			// `null` represents a non-existent term ID.
 			$this->assertFalse( user_can( $editor->ID, $cap, null ) );
@@ -1623,11 +2097,29 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$user = self::$users['administrator'];
 		$caps = $user->caps;
 		$this->assertNotEmpty( $user->caps );
+
 		$user->set_role( 'administrator' );
 		$this->assertNotEmpty( $user->caps );
 		$this->assertSame( $caps, $user->caps );
 	}
 
+	/**
+	 * @ticket 54164
+	 */
+	public function test_set_role_fires_remove_user_role_and_add_user_role_hooks() {
+		$user = self::$users['administrator'];
+
+		$remove_user_role = new MockAction();
+		$add_user_role    = new MockAction();
+		add_action( 'remove_user_role', array( $remove_user_role, 'action' ) );
+		add_action( 'add_user_role', array( $add_user_role, 'action' ) );
+
+		$user->set_role( 'editor' );
+		$user->set_role( 'administrator' );
+		$this->assertSame( 2, $remove_user_role->get_call_count() );
+		$this->assertSame( 2, $add_user_role->get_call_count() );
+	}
+
 	public function test_current_user_can_for_blog() {
 		global $wpdb;
 
@@ -1791,7 +2283,7 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$contributor = self::$users['contributor'];
 
 		// Give them a scheduled post.
-		$post = $this->factory->post->create_and_get(
+		$post = self::factory()->post->create_and_get(
 			array(
 				'post_author' => $contributor->ID,
 				'post_status' => 'future',
@@ -1977,13 +2469,11 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 	}
 
-
-	protected $_role_test_wp_roles_role;
 	/**
 	 * @ticket 23016
 	 */
 	public function test_wp_roles_init_action() {
-		$this->_role_test_wp_roles_init = array(
+		$this->role_test_wp_roles_init = array(
 			'role' => 'test_wp_roles_init',
 			'info' => array(
 				'name'         => 'Test WP Roles Init',
@@ -1996,16 +2486,16 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 		remove_action( 'wp_roles_init', array( $this, '_hook_wp_roles_init' ) );
 
-		$expected = new WP_Role( $this->_role_test_wp_roles_init['role'], $this->_role_test_wp_roles_init['info']['capabilities'] );
+		$expected = new WP_Role( $this->role_test_wp_roles_init['role'], $this->role_test_wp_roles_init['info']['capabilities'] );
 
-		$role = $wp_roles->get_role( $this->_role_test_wp_roles_init['role'] );
+		$role = $wp_roles->get_role( $this->role_test_wp_roles_init['role'] );
 
 		$this->assertEquals( $expected, $role );
-		$this->assertContains( $this->_role_test_wp_roles_init['info']['name'], $wp_roles->role_names );
+		$this->assertContains( $this->role_test_wp_roles_init['info']['name'], $wp_roles->role_names );
 	}
 
 	public function _hook_wp_roles_init( $wp_roles ) {
-		$wp_roles->add_role( $this->_role_test_wp_roles_init['role'], $this->_role_test_wp_roles_init['info']['name'], $this->_role_test_wp_roles_init['info']['capabilities'] );
+		$wp_roles->add_role( $this->role_test_wp_roles_init['role'], $this->role_test_wp_roles_init['info']['name'], $this->role_test_wp_roles_init['info']['capabilities'] );
 	}
 
 	/**
diff --git a/tests/user/getActiveBlogForUser.php b/tests/user/getActiveBlogForUser.php
index 2abb726e2f..423d71927c 100644
--- a/tests/user/getActiveBlogForUser.php
+++ b/tests/user/getActiveBlogForUser.php
@@ -9,7 +9,7 @@ if ( is_multisite() ) :
 	 * @group ms-user
 	 * @group multisite
 	 */
-	class Tests_Multisite_getActiveBlogForUser extends WP_UnitTestCase {
+	class Tests_User_GetActiveBlogForUser extends WP_UnitTestCase {
 		public static $user_id = false;
 
 		public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
diff --git a/tests/user/getUserCount.php b/tests/user/getUserCount.php
new file mode 100644
index 0000000000..f6a94d5624
--- /dev/null
+++ b/tests/user/getUserCount.php
@@ -0,0 +1,171 @@
+<?php
+
+/**
+ * @group user
+ * @covers ::get_user_count
+ */
+class Tests_User_GetUserCount extends WP_UnitTestCase {
+	/**
+	 * @ticket 40386
+	 * @group multisite
+	 * @group ms-required
+	 */
+	public function test_wp_update_network_counts_on_different_network() {
+		$this->skipWithoutMultisite();
+		$different_network_id = self::factory()->network->create(
+			array(
+				'domain' => 'wordpress.org',
+				'path'   => '/',
+			)
+		);
+
+		delete_network_option( $different_network_id, 'user_count' );
+
+		wp_update_network_counts( $different_network_id );
+
+		$user_count = get_user_count( $different_network_id );
+
+		$this->assertGreaterThan( 0, $user_count );
+	}
+
+	/**
+	 * @ticket 37866
+	 * @group multisite
+	 * @group ms-required
+	 */
+	public function test_get_user_count_on_different_network() {
+		$this->skipWithoutMultisite();
+		$different_network_id = self::factory()->network->create(
+			array(
+				'domain' => 'wordpress.org',
+				'path'   => '/',
+			)
+		);
+		wp_update_network_user_counts();
+		$current_network_user_count = get_user_count();
+
+		// Add another user to fake the network user count to be different.
+		wpmu_create_user( 'user', 'pass', 'user@example.com' );
+
+		wp_update_network_user_counts( $different_network_id );
+
+		$user_count = get_user_count( $different_network_id );
+
+		$this->assertSame( $current_network_user_count + 1, $user_count );
+	}
+
+	/**
+	 * @ticket 22917
+	 * @group multisite
+	 * @group ms-required
+	 */
+	public function test_enable_live_network_user_counts_filter() {
+		$this->skipWithoutMultisite();
+		// False for large networks by default.
+		add_filter( 'enable_live_network_counts', '__return_false' );
+
+		// Refresh the cache.
+		wp_update_network_counts();
+		$start_count = get_user_count();
+
+		wpmu_create_user( 'user', 'pass', 'user@example.com' );
+
+		// No change, cache not refreshed.
+		$count = get_user_count();
+
+		$this->assertSame( $start_count, $count );
+
+		wp_update_network_counts();
+		$start_count = get_user_count();
+
+		add_filter( 'enable_live_network_counts', '__return_true' );
+
+		self::factory()->user->create( array( 'role' => 'administrator' ) );
+
+		$count = get_user_count();
+		$this->assertSame( $start_count + 1, $count );
+
+	}
+
+	/**
+	 * @ticket 38741
+	 */
+	public function test_get_user_count_update() {
+		wp_update_user_counts();
+		$current_network_user_count = get_user_count();
+
+		self::factory()->user->create( array( 'role' => 'administrator' ) );
+
+		$user_count = get_user_count();
+
+		$this->assertSame( $current_network_user_count + 1, $user_count );
+	}
+
+	/**
+	 * @group ms-excluded
+	 * @ticket 38741
+	 */
+	public function test_get_user_count_update_on_delete() {
+		$this->skipWithMultisite();
+		wp_update_user_counts();
+		$current_network_user_count = get_user_count();
+
+		$u1 = self::factory()->user->create( array( 'role' => 'administrator' ) );
+
+		$user_count = get_user_count();
+
+		$this->assertSame( $current_network_user_count + 1, $user_count );
+
+		wp_delete_user( $u1 );
+
+		$user_count_after_delete = get_user_count();
+
+		$this->assertSame( $user_count - 1, $user_count_after_delete );
+	}
+
+	/**
+	 * @group ms-required
+	 * @ticket 38741
+	 */
+	public function test_get_user_count_update_on_delete_multisite() {
+		$this->skipWithoutMultisite();
+		wp_update_user_counts();
+		$current_network_user_count = get_user_count();
+
+		$u1 = wpmu_create_user( 'user', 'pass', 'user@example.com' );
+
+		$user_count = get_user_count();
+
+		$this->assertSame( $current_network_user_count + 1, $user_count );
+
+		wpmu_delete_user( $u1 );
+
+		$user_count_after_delete = get_user_count();
+
+		$this->assertSame( $user_count - 1, $user_count_after_delete );
+	}
+
+	/**
+	 * @group multisite
+	 * @group ms-required
+	 * @ticket 38741
+	 */
+	public function test_get_user_count() {
+		$this->skipWithoutMultisite();
+		// Refresh the cache.
+		wp_update_network_counts();
+		$start_count = get_user_count();
+
+		// Only false for large networks as of 3.7.
+		add_filter( 'enable_live_network_counts', '__return_false' );
+		self::factory()->user->create( array( 'role' => 'administrator' ) );
+
+		$count = get_user_count(); // No change, cache not refreshed.
+		$this->assertSame( $start_count, $count );
+
+		wp_update_network_counts(); // Magic happens here.
+
+		$count = get_user_count();
+		$this->assertSame( $start_count + 1, $count );
+	}
+}
diff --git a/tests/user/mapMetaCap.php b/tests/user/mapMetaCap.php
index b45e6260a2..fb26eca8b5 100644
--- a/tests/user/mapMetaCap.php
+++ b/tests/user/mapMetaCap.php
@@ -3,6 +3,7 @@
 /**
  * @group user
  * @group capabilities
+ * @covers ::map_meta_cap
  */
 class Tests_User_MapMetaCap extends WP_UnitTestCase {
 
@@ -410,4 +411,51 @@ class Tests_User_MapMetaCap extends WP_UnitTestCase {
 
 		$this->assertSame( array( 'manage_options' ), $caps );
 	}
+
+	/**
+	 * @dataProvider data_meta_caps_throw_doing_it_wrong_without_required_argument_provided
+	 * @ticket 44591
+	 *
+	 * @param string $cap The meta capability requiring an argument.
+	 */
+	public function test_meta_caps_throw_doing_it_wrong_without_required_argument_provided( $cap ) {
+		$admin_user = self::$user_id;
+		$this->setExpectedIncorrectUsage( 'map_meta_cap' );
+		$this->assertContains( 'do_not_allow', map_meta_cap( $cap, $admin_user ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[] Test parameters {
+	 *     @type string $cap The meta capability requiring an argument.
+	 * }
+	 */
+	public function data_meta_caps_throw_doing_it_wrong_without_required_argument_provided() {
+		return array(
+			array( 'delete_post' ),
+			array( 'delete_page' ),
+			array( 'edit_post' ),
+			array( 'edit_page' ),
+			array( 'read_post' ),
+			array( 'read_page' ),
+			array( 'publish_post' ),
+			array( 'edit_post_meta' ),
+			array( 'delete_post_meta' ),
+			array( 'add_post_meta' ),
+			array( 'edit_comment_meta' ),
+			array( 'delete_comment_meta' ),
+			array( 'add_comment_meta' ),
+			array( 'edit_term_meta' ),
+			array( 'delete_term_meta' ),
+			array( 'add_term_meta' ),
+			array( 'edit_user_meta' ),
+			array( 'delete_user_meta' ),
+			array( 'add_user_meta' ),
+			array( 'edit_comment' ),
+			array( 'edit_term' ),
+			array( 'delete_term' ),
+			array( 'assign_term' ),
+		);
+	}
 }
diff --git a/tests/user/multisite.php b/tests/user/multisite.php
index adccd60442..23079f4799 100644
--- a/tests/user/multisite.php
+++ b/tests/user/multisite.php
@@ -9,7 +9,7 @@ if ( is_multisite() ) :
 	 * @group ms-user
 	 * @group multisite
 	 */
-	class Tests_Multisite_User extends WP_UnitTestCase {
+	class Tests_User_Multisite extends WP_UnitTestCase {
 
 		public function test_remove_user_from_blog() {
 			$user1 = self::factory()->user->create_and_get();
diff --git a/tests/user/query.php b/tests/user/query.php
index 1c17d3d09c..3626156c01 100644
--- a/tests/user/query.php
+++ b/tests/user/query.php
@@ -155,6 +155,26 @@ class Tests_User_Query extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @ticket 55594
+	 */
+	public function test_get_all_primed_users() {
+		$filter = new MockAction();
+		add_filter( 'update_user_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+		new WP_User_Query(
+			array(
+				'include' => self::$author_ids,
+				'fields'  => 'all',
+			)
+		);
+
+		$args      = $filter->get_args();
+		$last_args = end( $args );
+		$this->assertIsArray( $last_args[1] );
+		$this->assertSameSets( self::$author_ids, $last_args[1], 'Ensure that user meta is primed' );
+	}
+
 	/**
 	 * @ticket 39297
 	 */
@@ -198,7 +218,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 				'include'  => self::$author_ids,
 				'meta_key' => 'last_name',
 				'orderby'  => 'meta_value',
-				'fields'   => 'ids',
+				'fields'   => 'ID',
 			)
 		);
 
@@ -220,7 +240,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 				'include'  => self::$author_ids,
 				'meta_key' => 'user_age',
 				'orderby'  => 'meta_value_num',
-				'fields'   => 'ids',
+				'fields'   => 'ID',
 			)
 		);
 
@@ -242,7 +262,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 				'include'  => self::$author_ids,
 				'meta_key' => 'foo',
 				'orderby'  => 'foo',
-				'fields'   => 'ids',
+				'fields'   => 'ID',
 			)
 		);
 
@@ -261,7 +281,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 
 		$q = new WP_User_Query(
 			array(
-				'fields'     => 'ids',
+				'fields'     => 'ID',
 				'meta_query' => array(
 					'foo_key' => array(
 						'key'     => 'foo',
@@ -302,7 +322,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 
 		$q = new WP_User_Query(
 			array(
-				'fields'     => 'ids',
+				'fields'     => 'ID',
 				'meta_query' => array(
 					'foo_key' => array(
 						'key'     => 'foo',
@@ -332,7 +352,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 
 		$q = new WP_User_Query(
 			array(
-				'fields'     => 'ids',
+				'fields'     => 'ID',
 				'meta_query' => array(
 					'foo_key' => array(
 						'key'     => 'foo',
@@ -1281,7 +1301,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 				'paged'   => 2,
 				'orderby' => 'ID',
 				'order'   => 'DESC', // Avoid funkiness with user 1.
-				'fields'  => 'ids',
+				'fields'  => 'ID',
 			)
 		);
 
@@ -1357,7 +1377,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 		$users = get_users(
 			array(
 				'role'   => 'editor',
-				'fields' => 'ids',
+				'fields' => 'ID',
 			)
 		);
 
@@ -1645,7 +1665,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 	 */
 	public function test_search_by_display_name_only() {
 
-		$new_user1          = $this->factory->user->create(
+		$new_user1          = self::factory()->user->create(
 			array(
 				'user_login'   => 'name1',
 				'display_name' => 'Sophia Andresen',
@@ -1673,7 +1693,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 	 */
 	public function test_search_by_display_name_only_ignore_others() {
 
-		$new_user1          = $this->factory->user->create(
+		$new_user1          = self::factory()->user->create(
 			array(
 				'user_login'   => 'Sophia Andresen',
 				'display_name' => 'name1',
@@ -1966,4 +1986,247 @@ class Tests_User_Query extends WP_UnitTestCase {
 		$this->assertContains( self::$author_ids[1], $found );
 		$this->assertContains( self::$author_ids[2], $found );
 	}
+
+	/**
+	 * @ticket 53177
+	 * @dataProvider data_returning_field_subset_as_string
+	 *
+	 * @param string $field
+	 * @param mixed  $expected
+	 */
+	public function test_returning_field_subset_as_string( $field, $expected ) {
+		$q       = new WP_User_Query(
+			array(
+				'fields'  => $field,
+				'include' => array( '1' ),
+			)
+		);
+		$results = $q->get_results();
+
+		$this->assertSameSets( $expected, $results );
+	}
+
+	/**
+	 * Data provider
+	 *
+	 * @return array
+	 */
+	function data_returning_field_subset_as_string() {
+		$data = array(
+			'id'            => array(
+				'fields'   => 'id',
+				'expected' => array( '1' ),
+			),
+			'ID'            => array(
+				'fields'   => 'ID',
+				'expected' => array( '1' ),
+			),
+			'user_login'    => array(
+				'fields'   => 'user_login',
+				'expected' => array( 'admin' ),
+			),
+			'user_nicename' => array(
+				'fields'   => 'user_nicename',
+				'expected' => array( 'admin' ),
+			),
+			'user_email'    => array(
+				'fields'   => 'user_email',
+				'expected' => array( WP_TESTS_EMAIL ),
+			),
+			'user_url'      => array(
+				'fields'   => 'user_url',
+				'expected' => array( wp_guess_url() ),
+			),
+			'user_status'   => array(
+				'fields'   => 'user_status',
+				'expected' => array( '0' ),
+			),
+			'display_name'  => array(
+				'fields'   => 'display_name',
+				'expected' => array( 'admin' ),
+			),
+			'invalid_field' => array(
+				'fields'   => 'invalid_field',
+				'expected' => array( '1' ),
+			),
+		);
+
+		if ( is_multisite() ) {
+			$data['spam']    = array(
+				'fields'   => 'spam',
+				'expected' => array( '0' ),
+			);
+			$data['deleted'] = array(
+				'fields'   => 'deleted',
+				'expected' => array( '0' ),
+			);
+		}
+
+		return $data;
+	}
+
+	/**
+	 * @ticket 53177
+	 * @dataProvider data_returning_field_subset_as_array
+	 *
+	 * @param array $field
+	 * @param mixed $expected
+	 */
+	public function test_returning_field_subset_as_array( $field, $expected ) {
+		$q       = new WP_User_Query(
+			array(
+				'fields'  => $field,
+				'include' => array( '1' ),
+			)
+		);
+		$results = $q->get_results();
+
+		if ( isset( $results[0] ) && is_object( $results[0] ) ) {
+			$results = (array) $results[0];
+		}
+
+		$this->assertSameSetsWithIndex( $expected, $results );
+	}
+
+	/**
+	 * Data provider
+	 *
+	 * @return array
+	 */
+	function data_returning_field_subset_as_array() {
+		$data = array(
+			'id'                 => array(
+				'fields'   => array( 'id' ),
+				'expected' => array(
+					'ID' => '1',
+					'id' => '1',
+				),
+			),
+			'ID'                 => array(
+				'fields'   => array( 'ID' ),
+				'expected' => array(
+					'ID' => '1',
+					'id' => '1',
+				),
+			),
+			'user_login'         => array(
+				'fields'   => array( 'user_login' ),
+				'expected' => array( 'user_login' => 'admin' ),
+			),
+			'user_nicename'      => array(
+				'fields'   => array( 'user_nicename' ),
+				'expected' => array( 'user_nicename' => 'admin' ),
+			),
+			'user_email'         => array(
+				'fields'   => array( 'user_email' ),
+				'expected' => array( 'user_email' => WP_TESTS_EMAIL ),
+			),
+			'user_url'           => array(
+				'fields'   => array( 'user_url' ),
+				'expected' => array( 'user_url' => wp_guess_url() ),
+			),
+			'user_status'        => array(
+				'fields'   => array( 'user_status' ),
+				'expected' => array( 'user_status' => '0' ),
+			),
+			'display_name'       => array(
+				'fields'   => array( 'display_name' ),
+				'expected' => array( 'display_name' => 'admin' ),
+			),
+			'invalid_field'      => array(
+				'fields'   => array( 'invalid_field' ),
+				'expected' => array(
+					'ID' => '1',
+					'id' => '1',
+				),
+			),
+			'valid array inc id' => array(
+				'fields'   => array( 'display_name', 'user_email', 'id' ),
+				'expected' => array(
+					'display_name' => 'admin',
+					'user_email'   => WP_TESTS_EMAIL,
+					'ID'           => '1',
+					'id'           => '1',
+				),
+			),
+			'valid array inc ID' => array(
+				'fields'   => array( 'display_name', 'user_email', 'ID' ),
+				'expected' => array(
+					'display_name' => 'admin',
+					'user_email'   => WP_TESTS_EMAIL,
+					'ID'           => '1',
+					'id'           => '1',
+				),
+			),
+			'partly valid array' => array(
+				'fields'   => array( 'display_name', 'invalid_field' ),
+				'expected' => array( 'display_name' => 'admin' ),
+			),
+		);
+
+		if ( is_multisite() ) {
+			$data['spam']    = array(
+				'fields'   => array( 'spam' ),
+				'expected' => array( 'spam' => '0' ),
+			);
+			$data['deleted'] = array(
+				'fields'   => array( 'deleted' ),
+				'expected' => array( 'deleted' => '0' ),
+			);
+		}
+
+		return $data;
+	}
+
+	/**
+	 * @ticket 53177
+	 */
+	public function test_returning_field_all() {
+		$q         = new WP_User_Query(
+			array(
+				'fields'  => 'all',
+				'include' => array( '1' ),
+			)
+		);
+		$results   = $q->get_results();
+		$user_data = (array) $results[0]->data;
+
+		$expected_results = array(
+			'ID'                  => '1',
+			'user_login'          => 'admin',
+			'user_nicename'       => 'admin',
+			'user_url'            => wp_guess_url(),
+			'user_email'          => WP_TESTS_EMAIL,
+			'user_activation_key' => '',
+			'user_status'         => '0',
+			'display_name'        => 'admin',
+		);
+
+		if ( is_multisite() ) {
+			$expected_results['spam']    = '0';
+			$expected_results['deleted'] = '0';
+		}
+
+		// These change for each run.
+		unset( $user_data['user_pass'], $user_data['user_registered'] );
+
+		$this->assertSameSetsWithIndex( $expected_results, $user_data );
+		$this->assertInstanceOf( 'WP_User', $results[0] );
+	}
+
+	/**
+	 * @ticket 53177
+	 *
+	 * @covers WP_User_Query::prepare_query
+	 */
+	public function test_returning_field_user_registered() {
+		$q       = new WP_User_Query(
+			array(
+				'fields'  => 'user_registered',
+				'include' => array( self::$admin_ids[0] ),
+			)
+		);
+		$results = $q->get_results();
+		$this->assertNotFalse( DateTime::createFromFormat( 'Y-m-d H:i:s', $results[0] ) );
+	}
 }
diff --git a/tests/user/retrievePassword.php b/tests/user/retrievePassword.php
new file mode 100644
index 0000000000..5a0e1d638e
--- /dev/null
+++ b/tests/user/retrievePassword.php
@@ -0,0 +1,70 @@
+<?php
+/**
+ * Test cases for the `retrieve_password()` function.
+ *
+ * @package WordPress
+ * @since 6.0.0
+ */
+
+/**
+ * Test retrieve_password(), in wp-includes/user.php.
+ *
+ * @since 6.0.0
+ *
+ * @group user
+ * @covers ::retrieve_password
+ */
+class Tests_User_RetrievePassword extends WP_UnitTestCase {
+	/**
+	 * Test user.
+	 *
+	 * @since 6.0.0
+	 *
+	 * @var WP_User $user
+	 */
+	protected $user;
+
+	/**
+	 * Create users for tests.
+	 *
+	 * @since 6.0.0
+	 */
+	public function set_up() {
+		parent::set_up();
+
+		// Create the user.
+		$this->user = self::factory()->user->create_and_get(
+			array(
+				'user_login' => 'jane',
+				'user_email' => 'r.jane@example.com',
+			)
+		);
+	}
+
+	/**
+	 * The function should not error when the email was sent.
+	 *
+	 * @ticket 54690
+	 */
+	public function test_retrieve_password_reset_notification_email() {
+		$message = 'Sending password reset notification email failed.';
+		$this->assertNotWPError( retrieve_password( $this->user->user_login ), $message );
+	}
+
+	/**
+	 * The function should error when the email was not sent.
+	 *
+	 * @ticket 54690
+	 */
+	public function test_retrieve_password_should_return_wp_error_on_failed_email() {
+		add_filter(
+			'retrieve_password_notification_email',
+			static function() {
+				return array( 'message' => '' );
+			}
+		);
+
+		$message = 'Sending password reset notification email succeeded.';
+		$this->assertWPError( retrieve_password( $this->user->user_login ), $message );
+	}
+}
diff --git a/tests/user/session.php b/tests/user/session.php
index 574c75ef4a..7bc1c39cbe 100644
--- a/tests/user/session.php
+++ b/tests/user/session.php
@@ -7,6 +7,11 @@
  */
 class Tests_User_Session extends WP_UnitTestCase {
 
+	/**
+	 * @var WP_User_Meta_Session_Tokens
+	 */
+	private $manager;
+
 	public function set_up() {
 		parent::set_up();
 		remove_all_filters( 'session_token_manager' );
diff --git a/tests/user/slashes.php b/tests/user/slashes.php
index 91fc62b321..40eb2b176b 100644
--- a/tests/user/slashes.php
+++ b/tests/user/slashes.php
@@ -6,6 +6,20 @@
  * @ticket 21767
  */
 class Tests_User_Slashes extends WP_UnitTestCase {
+
+	/*
+	 * It is important to test with both even and odd numbered slashes,
+	 * as KSES does a strip-then-add slashes in some of its function calls.
+	 */
+
+	const SLASH_1 = 'String with 1 slash \\';
+	const SLASH_2 = 'String with 2 slashes \\\\';
+	const SLASH_3 = 'String with 3 slashes \\\\\\';
+	const SLASH_4 = 'String with 4 slashes \\\\\\\\';
+	const SLASH_5 = 'String with 5 slashes \\\\\\\\\\';
+	const SLASH_6 = 'String with 6 slashes \\\\\\\\\\\\';
+	const SLASH_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
+
 	protected static $author_id;
 	protected static $user_id;
 
@@ -18,16 +32,6 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		parent::set_up();
 
 		wp_set_current_user( self::$author_id );
-
-		// It is important to test with both even and odd numbered slashes,
-		// as KSES does a strip-then-add slashes in some of its function calls.
-		$this->slash_1 = 'String with 1 slash \\';
-		$this->slash_2 = 'String with 2 slashes \\\\';
-		$this->slash_3 = 'String with 3 slashes \\\\\\';
-		$this->slash_4 = 'String with 4 slashes \\\\\\\\';
-		$this->slash_5 = 'String with 5 slashes \\\\\\\\\\';
-		$this->slash_6 = 'String with 6 slashes \\\\\\\\\\\\';
-		$this->slash_7 = 'String with 7 slashes \\\\\\\\\\\\\\';
 	}
 
 	/**
@@ -42,22 +46,22 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		$_POST['pass2']        = 'password';
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user1@example.com';
-		$_POST['first_name']   = $this->slash_1;
-		$_POST['last_name']    = $this->slash_3;
-		$_POST['nickname']     = $this->slash_5;
-		$_POST['display_name'] = $this->slash_7;
-		$_POST['description']  = $this->slash_3;
+		$_POST['first_name']   = self::SLASH_1;
+		$_POST['last_name']    = self::SLASH_3;
+		$_POST['nickname']     = self::SLASH_5;
+		$_POST['display_name'] = self::SLASH_7;
+		$_POST['description']  = self::SLASH_3;
 
 		$_POST = add_magic_quotes( $_POST ); // The add_user() function will strip slashes.
 
 		$user_id = add_user();
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( $this->slash_1, $user->first_name );
-		$this->assertSame( $this->slash_3, $user->last_name );
-		$this->assertSame( $this->slash_5, $user->nickname );
-		$this->assertSame( $this->slash_7, $user->display_name );
-		$this->assertSame( $this->slash_3, $user->description );
+		$this->assertSame( self::SLASH_1, $user->first_name );
+		$this->assertSame( self::SLASH_3, $user->last_name );
+		$this->assertSame( self::SLASH_5, $user->nickname );
+		$this->assertSame( self::SLASH_7, $user->display_name );
+		$this->assertSame( self::SLASH_3, $user->description );
 
 		$_POST                 = array();
 		$_GET                  = array();
@@ -67,22 +71,22 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		$_POST['pass2']        = 'password';
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user2@example.com';
-		$_POST['first_name']   = $this->slash_2;
-		$_POST['last_name']    = $this->slash_4;
-		$_POST['nickname']     = $this->slash_6;
-		$_POST['display_name'] = $this->slash_2;
-		$_POST['description']  = $this->slash_4;
+		$_POST['first_name']   = self::SLASH_2;
+		$_POST['last_name']    = self::SLASH_4;
+		$_POST['nickname']     = self::SLASH_6;
+		$_POST['display_name'] = self::SLASH_2;
+		$_POST['description']  = self::SLASH_4;
 
 		$_POST = add_magic_quotes( $_POST ); // The add_user() function will strip slashes.
 
 		$user_id = add_user();
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( $this->slash_2, $user->first_name );
-		$this->assertSame( $this->slash_4, $user->last_name );
-		$this->assertSame( $this->slash_6, $user->nickname );
-		$this->assertSame( $this->slash_2, $user->display_name );
-		$this->assertSame( $this->slash_4, $user->description );
+		$this->assertSame( self::SLASH_2, $user->first_name );
+		$this->assertSame( self::SLASH_4, $user->last_name );
+		$this->assertSame( self::SLASH_6, $user->nickname );
+		$this->assertSame( self::SLASH_2, $user->display_name );
+		$this->assertSame( self::SLASH_4, $user->description );
 	}
 
 	/**
@@ -96,44 +100,44 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		$_REQUEST              = array();
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user1@example.com';
-		$_POST['first_name']   = $this->slash_1;
-		$_POST['last_name']    = $this->slash_3;
-		$_POST['nickname']     = $this->slash_5;
-		$_POST['display_name'] = $this->slash_7;
-		$_POST['description']  = $this->slash_3;
+		$_POST['first_name']   = self::SLASH_1;
+		$_POST['last_name']    = self::SLASH_3;
+		$_POST['nickname']     = self::SLASH_5;
+		$_POST['display_name'] = self::SLASH_7;
+		$_POST['description']  = self::SLASH_3;
 
 		$_POST = add_magic_quotes( $_POST ); // The edit_user() function will strip slashes.
 
 		$user_id = edit_user( $user_id );
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( $this->slash_1, $user->first_name );
-		$this->assertSame( $this->slash_3, $user->last_name );
-		$this->assertSame( $this->slash_5, $user->nickname );
-		$this->assertSame( $this->slash_7, $user->display_name );
-		$this->assertSame( $this->slash_3, $user->description );
+		$this->assertSame( self::SLASH_1, $user->first_name );
+		$this->assertSame( self::SLASH_3, $user->last_name );
+		$this->assertSame( self::SLASH_5, $user->nickname );
+		$this->assertSame( self::SLASH_7, $user->display_name );
+		$this->assertSame( self::SLASH_3, $user->description );
 
 		$_POST                 = array();
 		$_GET                  = array();
 		$_REQUEST              = array();
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user2@example.com';
-		$_POST['first_name']   = $this->slash_2;
-		$_POST['last_name']    = $this->slash_4;
-		$_POST['nickname']     = $this->slash_6;
-		$_POST['display_name'] = $this->slash_2;
-		$_POST['description']  = $this->slash_4;
+		$_POST['first_name']   = self::SLASH_2;
+		$_POST['last_name']    = self::SLASH_4;
+		$_POST['nickname']     = self::SLASH_6;
+		$_POST['display_name'] = self::SLASH_2;
+		$_POST['description']  = self::SLASH_4;
 
 		$_POST = add_magic_quotes( $_POST ); // The edit_user() function will strip slashes.
 
 		$user_id = edit_user( $user_id );
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( $this->slash_2, $user->first_name );
-		$this->assertSame( $this->slash_4, $user->last_name );
-		$this->assertSame( $this->slash_6, $user->nickname );
-		$this->assertSame( $this->slash_2, $user->display_name );
-		$this->assertSame( $this->slash_4, $user->description );
+		$this->assertSame( self::SLASH_2, $user->first_name );
+		$this->assertSame( self::SLASH_4, $user->last_name );
+		$this->assertSame( self::SLASH_6, $user->nickname );
+		$this->assertSame( self::SLASH_2, $user->display_name );
+		$this->assertSame( self::SLASH_4, $user->description );
 	}
 
 	/**
@@ -144,43 +148,43 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 			array(
 				'user_login'   => 'slash_example_user_3',
 				'role'         => 'subscriber',
-				'email'        => 'user3@example.com',
-				'first_name'   => $this->slash_1,
-				'last_name'    => $this->slash_3,
-				'nickname'     => $this->slash_5,
-				'display_name' => $this->slash_7,
-				'description'  => $this->slash_3,
+				'user_email'   => 'user3@example.com',
+				'first_name'   => self::SLASH_1,
+				'last_name'    => self::SLASH_3,
+				'nickname'     => self::SLASH_5,
+				'display_name' => self::SLASH_7,
+				'description'  => self::SLASH_3,
 				'user_pass'    => '',
 			)
 		);
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $user->first_name );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $user->last_name );
-		$this->assertSame( wp_unslash( $this->slash_5 ), $user->nickname );
-		$this->assertSame( wp_unslash( $this->slash_7 ), $user->display_name );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $user->description );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $user->first_name );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $user->last_name );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), $user->nickname );
+		$this->assertSame( wp_unslash( self::SLASH_7 ), $user->display_name );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $user->description );
 
 		$user_id = wp_insert_user(
 			array(
 				'user_login'   => 'slash_example_user_4',
 				'role'         => 'subscriber',
-				'email'        => 'user3@example.com',
-				'first_name'   => $this->slash_2,
-				'last_name'    => $this->slash_4,
-				'nickname'     => $this->slash_6,
-				'display_name' => $this->slash_2,
-				'description'  => $this->slash_4,
+				'user_email'   => 'user4@example.com',
+				'first_name'   => self::SLASH_2,
+				'last_name'    => self::SLASH_4,
+				'nickname'     => self::SLASH_6,
+				'display_name' => self::SLASH_2,
+				'description'  => self::SLASH_4,
 				'user_pass'    => '',
 			)
 		);
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $user->first_name );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $user->last_name );
-		$this->assertSame( wp_unslash( $this->slash_6 ), $user->nickname );
-		$this->assertSame( wp_unslash( $this->slash_2 ), $user->display_name );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $user->description );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $user->first_name );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $user->last_name );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), $user->nickname );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $user->display_name );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $user->description );
 	}
 
 	/**
@@ -192,39 +196,39 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 			array(
 				'ID'           => $user_id,
 				'role'         => 'subscriber',
-				'first_name'   => $this->slash_1,
-				'last_name'    => $this->slash_3,
-				'nickname'     => $this->slash_5,
-				'display_name' => $this->slash_7,
-				'description'  => $this->slash_3,
+				'first_name'   => self::SLASH_1,
+				'last_name'    => self::SLASH_3,
+				'nickname'     => self::SLASH_5,
+				'display_name' => self::SLASH_7,
+				'description'  => self::SLASH_3,
 			)
 		);
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( wp_unslash( $this->slash_1 ), $user->first_name );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $user->last_name );
-		$this->assertSame( wp_unslash( $this->slash_5 ), $user->nickname );
-		$this->assertSame( wp_unslash( $this->slash_7 ), $user->display_name );
-		$this->assertSame( wp_unslash( $this->slash_3 ), $user->description );
+		$this->assertSame( wp_unslash( self::SLASH_1 ), $user->first_name );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $user->last_name );
+		$this->assertSame( wp_unslash( self::SLASH_5 ), $user->nickname );
+		$this->assertSame( wp_unslash( self::SLASH_7 ), $user->display_name );
+		$this->assertSame( wp_unslash( self::SLASH_3 ), $user->description );
 
 		$user_id = wp_update_user(
 			array(
 				'ID'           => $user_id,
 				'role'         => 'subscriber',
-				'first_name'   => $this->slash_2,
-				'last_name'    => $this->slash_4,
-				'nickname'     => $this->slash_6,
-				'display_name' => $this->slash_2,
-				'description'  => $this->slash_4,
+				'first_name'   => self::SLASH_2,
+				'last_name'    => self::SLASH_4,
+				'nickname'     => self::SLASH_6,
+				'display_name' => self::SLASH_2,
+				'description'  => self::SLASH_4,
 			)
 		);
 		$user    = get_user_to_edit( $user_id );
 
-		$this->assertSame( wp_unslash( $this->slash_2 ), $user->first_name );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $user->last_name );
-		$this->assertSame( wp_unslash( $this->slash_6 ), $user->nickname );
-		$this->assertSame( wp_unslash( $this->slash_2 ), $user->display_name );
-		$this->assertSame( wp_unslash( $this->slash_4 ), $user->description );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $user->first_name );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $user->last_name );
+		$this->assertSame( wp_unslash( self::SLASH_6 ), $user->nickname );
+		$this->assertSame( wp_unslash( self::SLASH_2 ), $user->display_name );
+		$this->assertSame( wp_unslash( self::SLASH_4 ), $user->description );
 	}
 
 }
diff --git a/tests/user/wpAuthenticateSpamCheck.php b/tests/user/wpAuthenticateSpamCheck.php
index fef983ddcf..81ce98ff1d 100644
--- a/tests/user/wpAuthenticateSpamCheck.php
+++ b/tests/user/wpAuthenticateSpamCheck.php
@@ -3,7 +3,7 @@
 /**
  * @group user
  */
-class Tests_User_WpAuthenticateSpamCheck extends WP_UnitTestCase {
+class Tests_User_wpAuthenticateSpamCheck extends WP_UnitTestCase {
 
 	/**
 	 * @group ms-excluded
diff --git a/tests/user/wpDeleteUser.php b/tests/user/wpDeleteUser.php
index a654678174..e37fa43ba6 100644
--- a/tests/user/wpDeleteUser.php
+++ b/tests/user/wpDeleteUser.php
@@ -3,7 +3,7 @@
 /**
  * @group user
  */
-class Tests_User_WpDeleteUser extends WP_UnitTestCase {
+class Tests_User_wpDeleteUser extends WP_UnitTestCase {
 
 	/**
 	 * Test that usermeta cache is cleared after user deletion.
diff --git a/tests/user/wpDropdownUsers.php b/tests/user/wpDropdownUsers.php
index 98e9b76df6..a0b6501eb9 100644
--- a/tests/user/wpDropdownUsers.php
+++ b/tests/user/wpDropdownUsers.php
@@ -5,7 +5,7 @@
  *
  * @group user
  */
-class Tests_User_WpDropdownUsers extends WP_UnitTestCase {
+class Tests_User_wpDropdownUsers extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 31251
@@ -13,7 +13,7 @@ class Tests_User_WpDropdownUsers extends WP_UnitTestCase {
 	public function test_default_value_of_show_should_be_display_name() {
 
 		// Create a user with a different display_name.
-		$u = $this->factory->user->create(
+		$u = self::factory()->user->create(
 			array(
 				'user_login'   => 'foo',
 				'display_name' => 'Foo Person',
@@ -37,7 +37,7 @@ class Tests_User_WpDropdownUsers extends WP_UnitTestCase {
 	public function test_show_should_display_display_name_show_is_specified_as_empty() {
 
 		// Create a user with a different display_name.
-		$u = $this->factory->user->create(
+		$u = self::factory()->user->create(
 			array(
 				'user_login'   => 'foo',
 				'display_name' => 'Foo Person',
@@ -63,7 +63,7 @@ class Tests_User_WpDropdownUsers extends WP_UnitTestCase {
 	public function test_show_should_display_user_property_when_the_value_of_show_is_a_valid_user_property() {
 
 		// Create a user with a different display_name.
-		$u = $this->factory->user->create(
+		$u = self::factory()->user->create(
 			array(
 				'user_login'   => 'foo',
 				'display_name' => 'Foo Person',
@@ -89,7 +89,7 @@ class Tests_User_WpDropdownUsers extends WP_UnitTestCase {
 	public function test_show_display_name_with_login() {
 
 		// Create a user with a different display_name.
-		$u = $this->factory->user->create(
+		$u = self::factory()->user->create(
 			array(
 				'user_login'   => 'foo',
 				'display_name' => 'Foo Person',
diff --git a/tests/user/wpGetUsersWithNoRole.php b/tests/user/wpGetUsersWithNoRole.php
index 1165307aed..f853e0e78b 100644
--- a/tests/user/wpGetUsersWithNoRole.php
+++ b/tests/user/wpGetUsersWithNoRole.php
@@ -3,7 +3,7 @@
 /**
  * @group user
  */
-class Tests_User_GetUsersWithNoRole extends WP_UnitTestCase {
+class Tests_User_wpGetUsersWithNoRole extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 22993
diff --git a/tests/user/listAuthors.php b/tests/user/wpListAuthors.php
similarity index 92%
rename from tests/user/listAuthors.php
rename to tests/user/wpListAuthors.php
index b5daacfe50..ebf557157a 100644
--- a/tests/user/listAuthors.php
+++ b/tests/user/wpListAuthors.php
@@ -2,28 +2,33 @@
 /**
  * @group author
  * @group user
+ * @covers ::wp_list_authors
  */
-class Tests_User_ListAuthors extends WP_UnitTestCase {
+class Tests_User_wpListAuthors extends WP_UnitTestCase {
 	public static $user_ids = array();
 	public static $fred_id;
 	public static $posts     = array();
 	public static $user_urls = array();
-		/* Defaults
-		'orderby'       => 'name',
-		'order'         => 'ASC',
-		'number'        => null,
-		'optioncount'   => false,
-		'exclude_admin' => true,
-		'show_fullname' => false,
-		'hide_empty'    => true,
-		'echo'          => true,
-		'feed'          => [empty string],
-		'feed_image'    => [empty string],
-		'feed_type'     => [empty string],
-		'style'         => 'list',
-		'html'          => true );
-		*/
+
+	/*
+	 * Defaults:
+	 * 'orderby'       => 'name',
+	 * 'order'         => 'ASC',
+	 * 'number'        => null,
+	 * 'optioncount'   => false,
+	 * 'exclude_admin' => true,
+	 * 'show_fullname' => false,
+	 * 'hide_empty'    => true,
+	 * 'echo'          => true,
+	 * 'feed'          => [empty string],
+	 * 'feed_image'    => [empty string],
+	 * 'feed_type'     => [empty string],
+	 * 'style'         => 'list',
+	 * 'html'          => true,
+	 */
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		global $wp_rewrite;
+
 		self::$user_ids[] = $factory->user->create(
 			array(
 				'user_login'   => 'zack',
@@ -58,6 +63,12 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 			)
 		);
 
+		/*
+		 * Re-initialize WP_Rewrite, so that get_author_posts_url() uses
+		 * the default permalink structure, not affected by other tests.
+		 */
+		$wp_rewrite->init();
+
 		$count = 0;
 		foreach ( self::$user_ids as $userid ) {
 			$count = $count + 1;
diff --git a/tests/user/wpListUsers.php b/tests/user/wpListUsers.php
index 32d30699c1..2d76ad16b2 100644
--- a/tests/user/wpListUsers.php
+++ b/tests/user/wpListUsers.php
@@ -4,7 +4,7 @@
  *
  * @covers ::wp_list_users
  */
-class Tests_Functions_wpListUsers extends WP_UnitTestCase {
+class Tests_User_wpListUsers extends WP_UnitTestCase {
 	private static $user_ids = array();
 
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
diff --git a/tests/user/wpRegisterPersistedPreferencesMeta.php b/tests/user/wpRegisterPersistedPreferencesMeta.php
new file mode 100644
index 0000000000..5c136070d5
--- /dev/null
+++ b/tests/user/wpRegisterPersistedPreferencesMeta.php
@@ -0,0 +1,61 @@
+<?php
+
+/**
+ * @group user
+ *
+ * @covers ::wp_register_persisted_preferences_meta
+ */
+class Tests_User_WpRegisterPersistedPreferencesMeta extends WP_UnitTestCase {
+
+	/**
+	 * Test that user persisted preferences meta is registered.
+	 *
+	 * @ticket 56467
+	 */
+	public function test_should_register_persisted_preferences_meta() {
+		global $wpdb, $wp_meta_keys;
+		$meta_key = $wpdb->get_blog_prefix() . 'persisted_preferences';
+
+		// Test that meta key is registered.
+		unregister_meta_key( 'user', $meta_key );
+		wp_register_persisted_preferences_meta();
+
+		$this->assertIsArray( $wp_meta_keys, 'No meta keys exist' );
+		$this->assertArrayHasKey(
+			$meta_key,
+			$wp_meta_keys['user'][''],
+			'The expected meta key was not registered'
+		);
+
+		// Test to detect changes in meta key structure.
+		$this->assertSame(
+			array(
+				'type'              => 'object',
+				'description'       => '',
+				'single'            => true,
+				'sanitize_callback' => null,
+				'auth_callback'     => '__return_true',
+				'show_in_rest'      => array(
+					'name'    => 'persisted_preferences',
+					'type'    => 'object',
+					'context' => array( 'edit' ),
+					'schema'  => array(
+						'type'                 => 'object',
+						'properties'           => array(
+							'_modified' => array(
+								'description' => __( 'The date and time the preferences were updated.' ),
+								'type'        => 'string',
+								'format'      => 'date-time',
+								'readonly'    => false,
+							),
+						),
+						'additionalProperties' => true,
+					),
+				),
+			),
+			$wp_meta_keys['user'][''][ $meta_key ],
+			'The registered metadata did not have the expected structure'
+		);
+	}
+
+}
diff --git a/tests/user/wpSendUserRequest.php b/tests/user/wpSendUserRequest.php
index cb0c41fe69..f36304bad4 100644
--- a/tests/user/wpSendUserRequest.php
+++ b/tests/user/wpSendUserRequest.php
@@ -15,7 +15,7 @@
  * @group user
  * @covers ::wp_send_user_request
  */
-class Tests_User_WpSendUserRequest extends WP_UnitTestCase {
+class Tests_User_wpSendUserRequest extends WP_UnitTestCase {
 
 	/**
 	 * Test administrator user.
diff --git a/tests/user/wpSetCurrentUser.php b/tests/user/wpSetCurrentUser.php
index b451a5298b..559aa2fbf4 100644
--- a/tests/user/wpSetCurrentUser.php
+++ b/tests/user/wpSetCurrentUser.php
@@ -3,7 +3,7 @@
 /**
  * @group user
  */
-class Tests_User_WpSetCurrentUser extends WP_UnitTestCase {
+class Tests_User_wpSetCurrentUser extends WP_UnitTestCase {
 	protected static $user_id;
 	protected static $user_id2;
 	protected static $user_ids = array();
diff --git a/tests/utils.php b/tests/utils.php
new file mode 100644
index 0000000000..3146f645c4
--- /dev/null
+++ b/tests/utils.php
@@ -0,0 +1,59 @@
+<?php
+
+/**
+ * Test some helper utility functions of the test framework.
+ *
+ * @group testsuite
+ */
+class Tests_Utils extends WP_UnitTestCase {
+
+	/**
+	 * @covers ::strip_ws
+	 */
+	public function test_strip_ws() {
+		$this->assertSame( '', strip_ws( '' ) );
+		$this->assertSame( 'foo', strip_ws( 'foo' ) );
+		$this->assertSame( '', strip_ws( "\r\n\t  \n\r\t" ) );
+
+		$in  = "asdf\n";
+		$in .= "asdf asdf\n";
+		$in .= "asdf     asdf\n";
+		$in .= "\tasdf\n";
+		$in .= "\tasdf\t\n";
+		$in .= "\t\tasdf\n";
+		$in .= "foo bar\n\r\n";
+		$in .= "foo\n";
+
+		$expected  = "asdf\n";
+		$expected .= "asdf asdf\n";
+		$expected .= "asdf     asdf\n";
+		$expected .= "asdf\n";
+		$expected .= "asdf\n";
+		$expected .= "asdf\n";
+		$expected .= "foo bar\n";
+		$expected .= 'foo';
+
+		$this->assertSame( $expected, strip_ws( $in ) );
+
+	}
+
+	/**
+	 * @covers ::mask_input_value
+	 */
+	public function test_mask_input_value() {
+		$in = <<<EOF
+<h2>Assign Authors</h2>
+<p>To make it easier for you to edit and save the imported posts and drafts, you may want to change the name of the author of the posts. For example, you may want to import all the entries as <code>admin</code>s entries.</p>
+<p>If a new user is created by WordPress, the password will be set, by default, to "changeme". Quite suggestive, eh? ;)</p>
+        <ol id="authors"><form action="?import=wordpress&amp;step=2&amp;id=" method="post"><input type="hidden" name="_wpnonce" value="855ae98911" /><input type="hidden" name="_wp_http_referer" value="wp-test.php" /><li>Current author: <strong>Alex Shiels</strong><br />Create user  <input type="text" value="Alex Shiels" name="user[]" maxlength="30"> <br /> or map to existing<select name="userselect[0]">
+EOF;
+		// _wpnonce value should be replaced with 'xxx'.
+		$expected = <<<EOF
+<h2>Assign Authors</h2>
+<p>To make it easier for you to edit and save the imported posts and drafts, you may want to change the name of the author of the posts. For example, you may want to import all the entries as <code>admin</code>s entries.</p>
+<p>If a new user is created by WordPress, the password will be set, by default, to "changeme". Quite suggestive, eh? ;)</p>
+        <ol id="authors"><form action="?import=wordpress&amp;step=2&amp;id=" method="post"><input type="hidden" name="_wpnonce" value="***" /><input type="hidden" name="_wp_http_referer" value="wp-test.php" /><li>Current author: <strong>Alex Shiels</strong><br />Create user  <input type="text" value="Alex Shiels" name="user[]" maxlength="30"> <br /> or map to existing<select name="userselect[0]">
+EOF;
+		$this->assertSame( $expected, mask_input_value( $in ) );
+	}
+}
diff --git a/tests/walker.php b/tests/walker.php
index 3e812dfd7c..e2e9e1aba2 100644
--- a/tests/walker.php
+++ b/tests/walker.php
@@ -8,6 +8,11 @@
  */
 class Tests_Walker extends WP_UnitTestCase {
 
+	/**
+	 * @var Walker
+	 */
+	private $walker;
+
 	public function set_up() {
 		parent::set_up();
 
diff --git a/tests/webfonts/wpThemeJsonWebfontsHandler.php b/tests/webfonts/wpThemeJsonWebfontsHandler.php
new file mode 100644
index 0000000000..5c609923d7
--- /dev/null
+++ b/tests/webfonts/wpThemeJsonWebfontsHandler.php
@@ -0,0 +1,136 @@
+<?php
+/**
+ * Enqueue only webfonts listed in theme.json
+ *
+ * @package WordPress
+ */
+
+/**
+ * Integration tests for the theme.json webfonts handler.
+ *
+ * @group webfonts
+ * @group themes
+ * @covers _wp_theme_json_webfonts_handler
+ */
+class Tests_Webfonts_wpThemeJsonWebfontsHandler extends WP_UnitTestCase {
+
+	/**
+	 * WP_Styles instance reference
+	 *
+	 * @var WP_Styles
+	 */
+	private $orig_wp_styles;
+
+	/**
+	 * Theme root path.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * The old theme root path.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
+	public function set_up() {
+		parent::set_up();
+
+		global $wp_styles;
+		$this->orig_wp_styles = $wp_styles;
+		$wp_styles            = null;
+
+		$this->theme_root     = realpath( DIR_TESTDATA . '/themedir1' );
+		$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
+
+		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+
+		$theme_root_callback = function () {
+			return $this->theme_root;
+		};
+
+		add_filter( 'theme_root', $theme_root_callback );
+		add_filter( 'stylesheet_root', $theme_root_callback );
+		add_filter( 'template_root', $theme_root_callback );
+
+		// Clear caches.
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+	}
+
+	public function tear_down() {
+		global $wp_styles;
+		$wp_styles = $this->orig_wp_styles;
+
+		// Restore the original theme directory setup.
+		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+
+		parent::tear_down();
+	}
+
+	/**
+	 * @ticket 55567
+	 * @ticket 46370
+	 */
+	public function test_font_face_generated_from_themejson() {
+		$this->setup_theme_and_test( 'webfonts-theme' );
+
+		$expected = <<<EOF
+<style id='wp-webfonts-inline-css' type='text/css'>
+@font-face{font-family:"Source Serif Pro";font-style:normal;font-weight:200 900;font-display:fallback;src:local("Source Serif Pro"), url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Roman.ttf.woff2') format('woff2');font-stretch:normal;}@font-face{font-family:"Source Serif Pro";font-style:italic;font-weight:200 900;font-display:fallback;src:local("Source Serif Pro"), url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Italic.ttf.woff2') format('woff2');font-stretch:normal;}
+</style>
+EOF;
+		$expected = str_replace( 'THEME_ROOT_URL', get_stylesheet_directory_uri(), $expected );
+		$expected = str_replace( "\r\n", "\n", $expected );
+
+		$this->assertStringContainsString(
+			$expected,
+			get_echo( 'wp_print_styles' )
+		);
+	}
+
+	/**
+	 * @dataProvider data_font_face_not_generated
+	 *
+	 * @ticket 55567
+	 * @ticket 46370
+	 */
+	public function test_font_face_not_generated( $theme_name ) {
+		$this->setup_theme_and_test( $theme_name );
+
+		$actual = get_echo( 'wp_print_styles' );
+		$this->assertStringNotContainsString( "<style id='wp-webfonts-inline-css", $actual );
+		$this->assertStringNotContainsString( '@font-face', $actual );
+	}
+
+	/**
+	 * Data provider for unhappy paths.
+	 *
+	 * @return string[][]
+	 */
+	public function data_font_face_not_generated() {
+		return array(
+			'classic theme with no theme.json' => array( 'default' ),
+			'no "fontFace" in theme.json'      => array( 'block-theme' ),
+			'empty "fontFace" in theme.json'   => array( 'empty-fontface-theme' ),
+		);
+	}
+
+	/**
+	 * Sets up the theme and test.
+	 *
+	 * @param string $theme_name Name of the theme to switch to for the test.
+	 */
+	private function setup_theme_and_test( $theme_name ) {
+		switch_theme( $theme_name );
+		do_action( 'after_setup_theme' );
+		WP_Theme_JSON_Resolver::clean_cached_data();
+		do_action( 'wp_loaded' );
+		do_action( 'wp_enqueue_scripts' );
+	}
+}
diff --git a/tests/widgets.php b/tests/widgets.php
index 7cfce4719b..527798f7a4 100644
--- a/tests/widgets.php
+++ b/tests/widgets.php
@@ -686,6 +686,61 @@ class Tests_Widgets extends WP_UnitTestCase {
 		$this->assertArrayNotHasKey( 0, $never_used );
 	}
 
+	/**
+	 * @ticket 54677
+	 *
+	 * @covers WP_Widget::get_settings
+	 */
+	public function test_wp_widget_initializes_widget_with_alt_option() {
+		/*
+		 * Emulate a new the recent posts widget.
+		 *
+		 * The widget contains an alternative (legacy) option so both the
+		 * current and the alternative option need to be deleted.
+		 */
+		delete_option( 'widget_recent-posts' );
+		delete_option( 'widget_recent_entries' );
+
+		$this->assertFalse( get_option( 'widget_recent-posts' ), 'The option widget_recent-posts was not deleted.' );
+		$this->assertFalse( get_option( 'widget_recent_entries' ), 'The option widget_recent_entries was not deleted.' );
+
+		wp_widgets_init();
+		$this->assertSameSetsWithIndex( array( '_multiwidget' => 1 ), get_option( 'widget_recent-posts' ), 'Option failed to be initialized.' );
+		$this->assertFalse( get_option( 'widget_recent_entries' ), 'Alternative option is set.' );
+	}
+
+	/**
+	 * @ticket 54677
+	 *
+	 * @covers WP_Widget::get_settings
+	 */
+	public function test_wp_widget_migrates_widget_with_alt_option() {
+		$option = array(
+			2              => array(
+				'title'     => 'Recent Posts',
+				'number'    => 5,
+				'show_date' => false,
+			),
+			'_multiwidget' => 1,
+		);
+
+		/*
+		 * Emulate the recent posts widget with an alternative option.
+		 *
+		 * The widget contains an alternative (legacy) option so the
+		 * current option is deleted while the alternative option is created.
+		 */
+		delete_option( 'widget_recent-posts' );
+		update_option( 'widget_recent_entries', $option );
+
+		$this->assertFalse( get_option( 'widget_recent-posts' ), 'The option widget_recent-posts was not deleted.' );
+		$this->assertSameSetsWithIndex( $option, get_option( 'widget_recent_entries' ), 'The option widget_recent_entries was not set to the default.' );
+
+		wp_widgets_init();
+		$this->assertSameSetsWithIndex( $option, get_option( 'widget_recent-posts' ), 'Option failed to be converted to new name.' );
+		$this->assertFalse( get_option( 'widget_recent_entries' ), 'Alternative option was not deleted.' );
+	}
+
 	/**
 	 * @see WP_Widget::save_settings()
 	 */
diff --git a/tests/widgets/wpWidgetCustomHtml.php b/tests/widgets/wpWidgetCustomHtml.php
index a2ef5c35a7..8b48b2cb9c 100644
--- a/tests/widgets/wpWidgetCustomHtml.php
+++ b/tests/widgets/wpWidgetCustomHtml.php
@@ -172,7 +172,7 @@ class Tests_Widgets_wpWidgetCustomHtml extends WP_UnitTestCase {
 		);
 
 		wp_set_current_user(
-			$this->factory()->user->create(
+			self::factory()->user->create(
 				array(
 					'role' => 'administrator',
 				)
@@ -241,7 +241,7 @@ class Tests_Widgets_wpWidgetCustomHtml extends WP_UnitTestCase {
 	 * @covers WP_Widget_Custom_HTML::enqueue_admin_scripts
 	 */
 	public function test_enqueue_admin_scripts_when_logged_in_and_syntax_highlighting_on() {
-		$user = $this->factory()->user->create();
+		$user = self::factory()->user->create();
 		wp_set_current_user( $user );
 		wp_get_current_user()->syntax_highlighting = 'true';
 		set_current_screen( 'widgets.php' );
@@ -262,7 +262,7 @@ class Tests_Widgets_wpWidgetCustomHtml extends WP_UnitTestCase {
 	 * @covers WP_Widget_Custom_HTML::enqueue_admin_scripts
 	 */
 	public function test_enqueue_admin_scripts_when_logged_in_and_syntax_highlighting_off() {
-		$user = $this->factory()->user->create();
+		$user = self::factory()->user->create();
 		wp_set_current_user( $user );
 		update_user_meta( $user, 'syntax_highlighting', 'false' );
 		set_current_screen( 'widgets.php' );
diff --git a/tests/widgets/wpWidgetMedia.php b/tests/widgets/wpWidgetMedia.php
index fd85f37714..a61026bec9 100644
--- a/tests/widgets/wpWidgetMedia.php
+++ b/tests/widgets/wpWidgetMedia.php
@@ -116,7 +116,7 @@ class Tests_Widgets_wpWidgetMedia extends WP_UnitTestCase {
 	public function test_constructor_in_customize_preview() {
 		global $wp_customize;
 		wp_set_current_user(
-			$this->factory()->user->create(
+			self::factory()->user->create(
 				array(
 					'role' => 'administrator',
 				)
@@ -159,7 +159,7 @@ class Tests_Widgets_wpWidgetMedia extends WP_UnitTestCase {
 		$this->assertFalse( $widget->is_attachment_with_mime_type( 0, 'image' ) );
 		$this->assertFalse( $widget->is_attachment_with_mime_type( -123, 'image' ) );
 
-		$post_id = $this->factory()->post->create();
+		$post_id = self::factory()->post->create();
 		$this->assertFalse( $widget->is_attachment_with_mime_type( $post_id, 'image' ) );
 		$this->assertFalse( $widget->is_attachment_with_mime_type( $attachment_id, 'video' ) );
 		$this->assertTrue( $widget->is_attachment_with_mime_type( $attachment_id, 'image' ) );
diff --git a/tests/widgets/wpWidgetText.php b/tests/widgets/wpWidgetText.php
index 5a53e2b84f..b35fa02e0e 100644
--- a/tests/widgets/wpWidgetText.php
+++ b/tests/widgets/wpWidgetText.php
@@ -81,7 +81,7 @@ class Tests_Widgets_wpWidgetText extends WP_UnitTestCase {
 	public function test__register_in_customize_preview() {
 		global $wp_customize;
 		wp_set_current_user(
-			$this->factory()->user->create(
+			self::factory()->user->create(
 				array(
 					'role' => 'administrator',
 				)
@@ -315,7 +315,7 @@ class Tests_Widgets_wpWidgetText extends WP_UnitTestCase {
 	 */
 	public function test_widget_shortcodes() {
 		global $post;
-		$post_id = $this->factory()->post->create();
+		$post_id = self::factory()->post->create();
 		$post    = get_post( $post_id );
 
 		$args   = array(
@@ -716,7 +716,7 @@ class Tests_Widgets_wpWidgetText extends WP_UnitTestCase {
 		);
 
 		wp_set_current_user(
-			$this->factory()->user->create(
+			self::factory()->user->create(
 				array(
 					'role' => 'administrator',
 				)
diff --git a/tests/wp/parseRequest.php b/tests/wp/parseRequest.php
index 2f022d7d2d..edf65cb660 100644
--- a/tests/wp/parseRequest.php
+++ b/tests/wp/parseRequest.php
@@ -16,7 +16,22 @@ class Tests_WP_ParseRequest extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Test that PHP 8.1 "passing null to non-nullable" deprecation notice
+	 * Tests the return value of the parse_request() method.
+	 *
+	 * @ticket 10886
+	 */
+	public function test_parse_request_returns_bool() {
+		// Check that parse_request() returns true by default.
+		$this->assertTrue( $this->wp->parse_request() );
+
+		add_filter( 'do_parse_request', '__return_false' );
+
+		// Check that parse_request() returns false if the request was not parsed.
+		$this->assertFalse( $this->wp->parse_request() );
+	}
+
+	/**
+	 * Tests that PHP 8.1 "passing null to non-nullable" deprecation notice
 	 * is not thrown when the home URL has no path/trailing slash (default setup).
 	 *
 	 * Note: This does not test the actual functioning of the parse_request() method.
diff --git a/tests/xmlrpc/wp/editProfile.php b/tests/xmlrpc/wp/editProfile.php
index 7c00626908..2789dbe460 100644
--- a/tests/xmlrpc/wp/editProfile.php
+++ b/tests/xmlrpc/wp/editProfile.php
@@ -16,13 +16,13 @@ class Tests_XMLRPC_wp_editProfile extends WP_XMLRPC_UnitTestCase {
 		$subscriber_id = $this->make_user_by_role( 'subscriber' );
 
 		$new_data = array(
-			'first_name'   => rand_str(),
-			'last_name'    => rand_str(),
+			'first_name'   => 'firstname',
+			'last_name'    => 'lastname',
 			'url'          => 'http://www.example.org/subscriber',
-			'display_name' => rand_str(),
-			'nickname'     => rand_str(),
-			'nicename'     => rand_str(),
-			'bio'          => rand_str( 200 ),
+			'display_name' => 'displayname',
+			'nickname'     => 'nickname',
+			'nicename'     => 'nicename',
+			'bio'          => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
 		);
 		$result   = $this->myxmlrpcserver->wp_editProfile( array( 1, 'subscriber', 'subscriber', $new_data ) );
 		$this->assertNotIXRError( $result );
diff --git a/tests/xmlrpc/wp/getComment.php b/tests/xmlrpc/wp/getComment.php
index e43a733910..08cd4a5b00 100644
--- a/tests/xmlrpc/wp/getComment.php
+++ b/tests/xmlrpc/wp/getComment.php
@@ -18,7 +18,7 @@ class Tests_XMLRPC_wp_getComment extends WP_XMLRPC_UnitTestCase {
 			'comment_author'       => 'Test commenter',
 			'comment_author_url'   => 'http://example.com/',
 			'comment_author_email' => 'example@example.com',
-			'comment_content'      => rand_str( 100 ),
+			'comment_content'      => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
 		);
 		self::$parent_comment_id   = wp_insert_comment( self::$parent_comment_data );
 
@@ -28,7 +28,7 @@ class Tests_XMLRPC_wp_getComment extends WP_XMLRPC_UnitTestCase {
 			'comment_author_url'   => 'http://example.org/',
 			'comment_author_email' => 'example@example.org',
 			'comment_parent'       => self::$parent_comment_id,
-			'comment_content'      => rand_str( 100 ),
+			'comment_content'      => 'Duis non neque cursus, commodo massa in, bibendum nisl.',
 		);
 		self::$child_comment_id   = wp_insert_comment( self::$child_comment_data );
 	}
diff --git a/tests/xmlrpc/wp/getPost.php b/tests/xmlrpc/wp/getPost.php
index 0fd81ada8a..be25ca2770 100644
--- a/tests/xmlrpc/wp/getPost.php
+++ b/tests/xmlrpc/wp/getPost.php
@@ -14,9 +14,9 @@ class Tests_XMLRPC_wp_getPost extends WP_XMLRPC_UnitTestCase {
 
 		$this->post_date_ts            = strtotime( '+1 day' );
 		$this->post_data               = array(
-			'post_title'   => rand_str(),
-			'post_content' => rand_str( 2000 ),
-			'post_excerpt' => rand_str( 100 ),
+			'post_title'   => 'Post Title',
+			'post_content' => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
+			'post_excerpt' => 'Post Excerpt',
 			'post_author'  => $this->make_user_by_role( 'author' ),
 			'post_date'    => date_format( date_create( "@{$this->post_date_ts}" ), 'Y-m-d H:i:s' ),
 		);
diff --git a/tests/xmlrpc/wp/newComment.php b/tests/xmlrpc/wp/newComment.php
index 6cc6c30160..7c2eacc6b1 100644
--- a/tests/xmlrpc/wp/newComment.php
+++ b/tests/xmlrpc/wp/newComment.php
@@ -55,7 +55,7 @@ class Tests_XMLRPC_wp_newComment extends WP_XMLRPC_UnitTestCase {
 				'administrator',
 				self::$posts['publish']->ID,
 				array(
-					'content' => rand_str( 100 ),
+					'content' => 'Content',
 				),
 			)
 		);
@@ -155,7 +155,7 @@ class Tests_XMLRPC_wp_newComment extends WP_XMLRPC_UnitTestCase {
 				'administrator',
 				$post->ID,
 				array(
-					'content' => rand_str( 100 ),
+					'content' => 'Content',
 				),
 			)
 		);
@@ -171,7 +171,7 @@ class Tests_XMLRPC_wp_newComment extends WP_XMLRPC_UnitTestCase {
 			'administrator',
 			self::$posts['publish']->ID,
 			array(
-				'content' => rand_str( 100 ),
+				'content' => 'Content',
 			),
 		);
 
