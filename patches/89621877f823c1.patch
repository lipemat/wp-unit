diff --git a/data/blocks/fixtures/core__latest-posts.server.html b/data/blocks/fixtures/core__latest-posts.server.html
index b671f3d6ab..c4de7cc996 100644
--- a/data/blocks/fixtures/core__latest-posts.server.html
+++ b/data/blocks/fixtures/core__latest-posts.server.html
@@ -1 +1 @@
-<ul class="wp-block-latest-posts"></ul>
+<ul class="wp-block-latest-posts wp-block-latest-posts__list"></ul>
diff --git a/data/blocks/fixtures/core__latest-posts__displayPostDate.server.html b/data/blocks/fixtures/core__latest-posts__displayPostDate.server.html
index 72e50931f0..7c074451d9 100644
--- a/data/blocks/fixtures/core__latest-posts__displayPostDate.server.html
+++ b/data/blocks/fixtures/core__latest-posts__displayPostDate.server.html
@@ -1 +1 @@
-<ul class="wp-block-latest-posts has-dates"></ul>
+<ul class="wp-block-latest-posts wp-block-latest-posts__list has-dates"></ul>
diff --git a/data/export/valid-wxr-1.1.xml b/data/export/valid-wxr-1.1.xml
index f389741f1b..cd039e8efd 100644
--- a/data/export/valid-wxr-1.1.xml
+++ b/data/export/valid-wxr-1.1.xml
@@ -1,112 +1,112 @@
-<?xml version="1.0" encoding="UTF-8" ?>
-<!-- This is a WordPress eXtended RSS file generated by WordPress as an export of your site. -->
-<!-- It contains information about your site's posts, pages, comments, categories, and other content. -->
-<!-- You may use this file to transfer that content from one site to another. -->
-<!-- NB: This file is not intended to serve as a complete backup of your blog. -->
-
-<!-- To import this information into a WordPress site follow these steps: -->
-<!-- 1. Log in to that site as an administrator. -->
-<!-- 2. Go to Tools: Import in the WordPress admin panel. -->
-<!-- 3. Install the "WordPress" importer from the list. -->
-<!-- 4. Activate & Run Importer. -->
-<!-- 5. Upload this file using the form provided on that page. -->
-<!-- 6. You will first be asked to map the authors in this export file to users -->
-<!--    on the site. For each author, you may choose to map to an -->
-<!--    existing user on the site or to create a new user. -->
-<!-- 7. WordPress will then import each of the posts, pages comments, categories, etc. -->
-<!--    contained in this file into your blog. -->
-
-<!-- generator="WordPress/3.1-alpha" created="2010-10-17 09:54" -->
-<rss version="2.0"
-	xmlns:excerpt="http://wordpress.org/export/1.1/excerpt/"
-	xmlns:content="http://purl.org/rss/1.0/modules/content/"
-	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
-	xmlns:dc="http://purl.org/dc/elements/1.1/"
-	xmlns:wp="http://wordpress.org/export/1.1/"
->
-
-<channel>
-	<title>Export Datasets</title>
-	<link>http://localhost/</link>
-	<description>Just another WordPress site</description>
-	<pubDate>Sat, 16 Oct 2010 20:53:18 +0000</pubDate>
-	<language>en</language>
-	<wp:wxr_version>1.1</wp:wxr_version>
-	<wp:base_site_url>http://localhost/</wp:base_site_url>
-	<wp:base_blog_url>http://localhost/</wp:base_blog_url>
-
-	<wp:author><wp:author_id>2</wp:author_id><wp:author_login>john</wp:author_login><wp:author_email>johndoe@example.org</wp:author_email><wp:author_display_name><![CDATA[John Doe]]></wp:author_display_name><wp:author_first_name><![CDATA[John]]></wp:author_first_name><wp:author_last_name><![CDATA[Doe]]></wp:author_last_name></wp:author>
-
-	<wp:category><wp:term_id>3</wp:term_id><wp:category_nicename>alpha</wp:category_nicename><wp:category_parent></wp:category_parent><wp:cat_name><![CDATA[alpha]]></wp:cat_name><wp:category_description><![CDATA[The alpha category]]></wp:category_description></wp:category>
-	<wp:tag><wp:term_id>22</wp:term_id><wp:tag_slug>clippable</wp:tag_slug><wp:tag_name><![CDATA[Clippable]]></wp:tag_name><wp:tag_description><![CDATA[The Clippable post_tag]]></wp:tag_description></wp:tag>
-	<wp:term><wp:term_id>40</wp:term_id><wp:term_taxonomy>post_tax</wp:term_taxonomy><wp:term_slug>bieup</wp:term_slug><wp:term_parent></wp:term_parent><wp:term_name><![CDATA[bieup]]></wp:term_name><wp:term_description><![CDATA[The bieup post_tax]]></wp:term_description></wp:term>
-
-	<generator>http://wordpress.org/?v=3.1-alpha</generator>
-
-	<item>
-		<title>Hello world!</title>
-		<link>http://localhost/?p=1</link>
-		<pubDate>Sat, 16 Oct 2010 20:53:18 +0000</pubDate>
-		<dc:creator>john</dc:creator>
-		<guid isPermaLink="false">http://localhost/?p=1</guid>
-		<description></description>
-		<content:encoded><![CDATA[Welcome to WordPress. This is your first post. Edit or delete it, then start blogging!]]></content:encoded>
-		<excerpt:encoded><![CDATA[]]></excerpt:encoded>
-		<wp:post_id>1</wp:post_id>
-		<wp:post_date>2010-10-16 20:53:18</wp:post_date>
-		<wp:post_date_gmt>2010-10-16 20:53:18</wp:post_date_gmt>
-		<wp:comment_status>open</wp:comment_status>
-		<wp:ping_status>open</wp:ping_status>
-		<wp:post_name>hello-world</wp:post_name>
-		<wp:status>publish</wp:status>
-		<wp:post_parent>0</wp:post_parent>
-		<wp:menu_order>0</wp:menu_order>
-		<wp:post_type>post</wp:post_type>
-		<wp:post_password></wp:post_password>
-		<wp:is_sticky>0</wp:is_sticky>
-		<category domain="category" nicename="alpha"><![CDATA[alpha]]></category>
-		<category domain="post_tag" nicename="clippable"><![CDATA[Clippable]]></category>
-		<category domain="post_tax" nicename="bieup"><![CDATA[bieup]]></category>
-		<wp:comment>
-			<wp:comment_id>1</wp:comment_id>
-			<wp:comment_author><![CDATA[Mr WordPress]]></wp:comment_author>
-			<wp:comment_author_email></wp:comment_author_email>
-			<wp:comment_author_url>http://wordpress.org/</wp:comment_author_url>
-			<wp:comment_author_IP></wp:comment_author_IP>
-			<wp:comment_date>2010-10-16 20:53:18</wp:comment_date>
-			<wp:comment_date_gmt>2010-10-16 20:53:18</wp:comment_date_gmt>
-			<wp:comment_content><![CDATA[Hi, this is a comment.<br />To delete a comment, just log in and view the post&#039;s comments. There you will have the option to edit or delete them.]]></wp:comment_content>
-			<wp:comment_approved>1</wp:comment_approved>
-			<wp:comment_type></wp:comment_type>
-			<wp:comment_parent>0</wp:comment_parent>
-			<wp:comment_user_id>0</wp:comment_user_id>
-		</wp:comment>
-	</item>
-	<item>
-		<title>About</title>
-		<link>http://localhost/?page_id=2</link>
-		<pubDate>Sat, 16 Oct 2010 20:53:18 +0000</pubDate>
-		<dc:creator>john</dc:creator>
-		<guid isPermaLink="false">http://localhost/?page_id=2</guid>
-		<description></description>
-		<content:encoded><![CDATA[This is an example of a WordPress page. You could edit this to put information about yourself or your site so readers know where you are coming from. You can create as many pages like this one or sub-pages as you like and manage all of your content inside of WordPress.]]></content:encoded>
-		<excerpt:encoded><![CDATA[]]></excerpt:encoded>
-		<wp:post_id>2</wp:post_id>
-		<wp:post_date>2010-10-16 20:53:18</wp:post_date>
-		<wp:post_date_gmt>2010-10-16 20:53:18</wp:post_date_gmt>
-		<wp:comment_status>open</wp:comment_status>
-		<wp:ping_status>open</wp:ping_status>
-		<wp:post_name>about</wp:post_name>
-		<wp:status>publish</wp:status>
-		<wp:post_parent>0</wp:post_parent>
-		<wp:menu_order>0</wp:menu_order>
-		<wp:post_type>page</wp:post_type>
-		<wp:post_password></wp:post_password>
-		<wp:is_sticky>0</wp:is_sticky>
-		<wp:postmeta>
-			<wp:meta_key>_wp_page_template</wp:meta_key>
-			<wp:meta_value><![CDATA[default]]></wp:meta_value>
-		</wp:postmeta>
-	</item>
-</channel>
-</rss>
+<?xml version="1.0" encoding="UTF-8" ?>
+<!-- This is a WordPress eXtended RSS file generated by WordPress as an export of your site. -->
+<!-- It contains information about your site's posts, pages, comments, categories, and other content. -->
+<!-- You may use this file to transfer that content from one site to another. -->
+<!-- NB: This file is not intended to serve as a complete backup of your blog. -->
+
+<!-- To import this information into a WordPress site follow these steps: -->
+<!-- 1. Log in to that site as an administrator. -->
+<!-- 2. Go to Tools: Import in the WordPress admin panel. -->
+<!-- 3. Install the "WordPress" importer from the list. -->
+<!-- 4. Activate & Run Importer. -->
+<!-- 5. Upload this file using the form provided on that page. -->
+<!-- 6. You will first be asked to map the authors in this export file to users -->
+<!--    on the site. For each author, you may choose to map to an -->
+<!--    existing user on the site or to create a new user. -->
+<!-- 7. WordPress will then import each of the posts, pages comments, categories, etc. -->
+<!--    contained in this file into your blog. -->
+
+<!-- generator="WordPress/3.1-alpha" created="2010-10-17 09:54" -->
+<rss version="2.0"
+	xmlns:excerpt="http://wordpress.org/export/1.1/excerpt/"
+	xmlns:content="http://purl.org/rss/1.0/modules/content/"
+	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
+	xmlns:dc="http://purl.org/dc/elements/1.1/"
+	xmlns:wp="http://wordpress.org/export/1.1/"
+>
+
+<channel>
+	<title>Export Datasets</title>
+	<link>http://localhost/</link>
+	<description>Just another WordPress site</description>
+	<pubDate>Sat, 16 Oct 2010 20:53:18 +0000</pubDate>
+	<language>en</language>
+	<wp:wxr_version>1.1</wp:wxr_version>
+	<wp:base_site_url>http://localhost/</wp:base_site_url>
+	<wp:base_blog_url>http://localhost/</wp:base_blog_url>
+
+	<wp:author><wp:author_id>2</wp:author_id><wp:author_login>john</wp:author_login><wp:author_email>johndoe@example.org</wp:author_email><wp:author_display_name><![CDATA[John Doe]]></wp:author_display_name><wp:author_first_name><![CDATA[John]]></wp:author_first_name><wp:author_last_name><![CDATA[Doe]]></wp:author_last_name></wp:author>
+
+	<wp:category><wp:term_id>3</wp:term_id><wp:category_nicename>alpha</wp:category_nicename><wp:category_parent></wp:category_parent><wp:cat_name><![CDATA[alpha]]></wp:cat_name><wp:category_description><![CDATA[The alpha category]]></wp:category_description></wp:category>
+	<wp:tag><wp:term_id>22</wp:term_id><wp:tag_slug>clippable</wp:tag_slug><wp:tag_name><![CDATA[Clippable]]></wp:tag_name><wp:tag_description><![CDATA[The Clippable post_tag]]></wp:tag_description></wp:tag>
+	<wp:term><wp:term_id>40</wp:term_id><wp:term_taxonomy>post_tax</wp:term_taxonomy><wp:term_slug>bieup</wp:term_slug><wp:term_parent></wp:term_parent><wp:term_name><![CDATA[bieup]]></wp:term_name><wp:term_description><![CDATA[The bieup post_tax]]></wp:term_description></wp:term>
+
+	<generator>http://wordpress.org/?v=3.1-alpha</generator>
+
+	<item>
+		<title>Hello world!</title>
+		<link>http://localhost/?p=1</link>
+		<pubDate>Sat, 16 Oct 2010 20:53:18 +0000</pubDate>
+		<dc:creator>john</dc:creator>
+		<guid isPermaLink="false">http://localhost/?p=1</guid>
+		<description></description>
+		<content:encoded><![CDATA[Welcome to WordPress. This is your first post. Edit or delete it, then start blogging!]]></content:encoded>
+		<excerpt:encoded><![CDATA[]]></excerpt:encoded>
+		<wp:post_id>1</wp:post_id>
+		<wp:post_date>2010-10-16 20:53:18</wp:post_date>
+		<wp:post_date_gmt>2010-10-16 20:53:18</wp:post_date_gmt>
+		<wp:comment_status>open</wp:comment_status>
+		<wp:ping_status>open</wp:ping_status>
+		<wp:post_name>hello-world</wp:post_name>
+		<wp:status>publish</wp:status>
+		<wp:post_parent>0</wp:post_parent>
+		<wp:menu_order>0</wp:menu_order>
+		<wp:post_type>post</wp:post_type>
+		<wp:post_password></wp:post_password>
+		<wp:is_sticky>0</wp:is_sticky>
+		<category domain="category" nicename="alpha"><![CDATA[alpha]]></category>
+		<category domain="post_tag" nicename="clippable"><![CDATA[Clippable]]></category>
+		<category domain="post_tax" nicename="bieup"><![CDATA[bieup]]></category>
+		<wp:comment>
+			<wp:comment_id>1</wp:comment_id>
+			<wp:comment_author><![CDATA[Mr WordPress]]></wp:comment_author>
+			<wp:comment_author_email></wp:comment_author_email>
+			<wp:comment_author_url>http://wordpress.org/</wp:comment_author_url>
+			<wp:comment_author_IP></wp:comment_author_IP>
+			<wp:comment_date>2010-10-16 20:53:18</wp:comment_date>
+			<wp:comment_date_gmt>2010-10-16 20:53:18</wp:comment_date_gmt>
+			<wp:comment_content><![CDATA[Hi, this is a comment.<br />To delete a comment, just log in and view the post&#039;s comments. There you will have the option to edit or delete them.]]></wp:comment_content>
+			<wp:comment_approved>1</wp:comment_approved>
+			<wp:comment_type></wp:comment_type>
+			<wp:comment_parent>0</wp:comment_parent>
+			<wp:comment_user_id>0</wp:comment_user_id>
+		</wp:comment>
+	</item>
+	<item>
+		<title>About</title>
+		<link>http://localhost/?page_id=2</link>
+		<pubDate>Sat, 16 Oct 2010 20:53:18 +0000</pubDate>
+		<dc:creator>john</dc:creator>
+		<guid isPermaLink="false">http://localhost/?page_id=2</guid>
+		<description></description>
+		<content:encoded><![CDATA[This is an example of a WordPress page. You could edit this to put information about yourself or your site so readers know where you are coming from. You can create as many pages like this one or sub-pages as you like and manage all of your content inside of WordPress.]]></content:encoded>
+		<excerpt:encoded><![CDATA[]]></excerpt:encoded>
+		<wp:post_id>2</wp:post_id>
+		<wp:post_date>2010-10-16 20:53:18</wp:post_date>
+		<wp:post_date_gmt>2010-10-16 20:53:18</wp:post_date_gmt>
+		<wp:comment_status>open</wp:comment_status>
+		<wp:ping_status>open</wp:ping_status>
+		<wp:post_name>about</wp:post_name>
+		<wp:status>publish</wp:status>
+		<wp:post_parent>0</wp:post_parent>
+		<wp:menu_order>0</wp:menu_order>
+		<wp:post_type>page</wp:post_type>
+		<wp:post_password></wp:post_password>
+		<wp:is_sticky>0</wp:is_sticky>
+		<wp:postmeta>
+			<wp:meta_key>_wp_page_template</wp:meta_key>
+			<wp:meta_value><![CDATA[default]]></wp:meta_value>
+		</wp:postmeta>
+	</item>
+</channel>
+</rss>
diff --git a/data/formatting/big5.txt b/data/formatting/big5.txt
index a0ab6e4537..e599bb2821 100644
--- a/data/formatting/big5.txt
+++ b/data/formatting/big5.txt
@@ -1,5 +1,5 @@
-版本
-分類
-環境
-性質
-首頁
+版本
+分類
+環境
+性質
+首頁
diff --git a/data/formatting/entities.txt b/data/formatting/entities.txt
index 02edb54508..358a9b8a00 100644
--- a/data/formatting/entities.txt
+++ b/data/formatting/entities.txt
@@ -1,255 +1,255 @@
-### Named HTML character entities, their numeric reference 
-### (e.g. for &#[0-9]+; entity form), and their use.
-### From: http://www.w3.org/TR/html401/sgml/entities.html
-###
-nbsp	| 160	### no-break space 
-iexcl	| 161	### inverted exclamation mark 
-cent	| 162	### cent sign 
-pound	| 163	### pound sterling sign 
-curren	| 164	### general currency sign 
-yen	    | 165	### yen sign 
-brvbar	| 166	### broken (vertical) bar 
-sect	| 167	### section sign 
-uml	    | 168	### umlaut (dieresis) 
-copy	| 169	### copyright sign 
-ordf	| 170	### ordinal indicator, feminine 
-laquo	| 171	### angle quotation mark, left 
-not	    | 172	### not sign 
-shy	    | 173	### soft hyphen 
-reg	    | 174	### registered sign 
-macr	| 175	### macron 
-deg	    | 176	### degree sign 
-plusmn	| 177	### plus-or-minus sign 
-sup2	| 178	### superscript two 
-sup3	| 179	### superscript three 
-acute	| 180	### acute accent 
-micro	| 181	### micro sign 
-para	| 182	### pilcrow (paragraph sign) 
-middot	| 183	### middle dot 
-cedil	| 184	### cedilla 
-sup1	| 185	### superscript one 
-ordm	| 186	### ordinal indicator, masculine 
-raquo	| 187	### angle quotation mark, right 
-frac14	| 188	### fraction one-quarter 
-frac12	| 189	### fraction one-half 
-frac34	| 190	### fraction three-quarters 
-iquest	| 191	### inverted question mark 
-Agrave	| 192	### capital A, grave accent 
-Aacute	| 193	### capital A, acute accent 
-Acirc	| 194	### capital A, circumflex accent 
-Atilde	| 195	### capital A, tilde 
-Auml	| 196	### capital A, dieresis or umlaut mark 
-Aring	| 197	### capital A, ring 
-AElig	| 198	### capital AE diphthong (ligature) 
-Ccedil	| 199	### capital C, cedilla 
-Egrave	| 200	### capital E, grave accent 
-Eacute	| 201	### capital E, acute accent 
-Ecirc	| 202	### capital E, circumflex accent 
-Euml	| 203	### capital E, dieresis or umlaut mark 
-Igrave	| 204	### capital I, grave accent 
-Iacute	| 205	### capital I, acute accent 
-Icirc	| 206	### capital I, circumflex accent 
-Iuml	| 207	### capital I, dieresis or umlaut mark 
-ETH	    | 208	### capital Eth, Icelandic 
-Ntilde	| 209	### capital N, tilde 
-Ograve	| 210	### capital O, grave accent 
-Oacute	| 211	### capital O, acute accent 
-Ocirc	| 212	### capital O, circumflex accent 
-Otilde	| 213	### capital O, tilde 
-Ouml	| 214	### capital O, dieresis or umlaut mark 
-times	| 215	### multiply sign 
-Oslash	| 216	### capital O, slash 
-Ugrave	| 217	### capital U, grave accent 
-Uacute	| 218	### capital U, acute accent 
-Ucirc	| 219	### capital U, circumflex accent 
-Uuml	| 220	### capital U, dieresis or umlaut mark 
-Yacute	| 221	### capital Y, acute accent 
-THORN	| 222	### capital THORN, Icelandic 
-szlig	| 223	### small sharp s, German (sz ligature) 
-agrave	| 224	### small a, grave accent 
-aacute	| 225	### small a, acute accent 
-acirc	| 226	### small a, circumflex accent 
-atilde	| 227	### small a, tilde 
-auml	| 228	### small a, dieresis or umlaut mark 
-aring	| 229	### small a, ring 
-aelig	| 230	### small ae diphthong (ligature) 
-ccedil	| 231	### small c, cedilla 
-egrave	| 232	### small e, grave accent 
-eacute	| 233	### small e, acute accent 
-ecirc	| 234	### small e, circumflex accent 
-euml	| 235	### small e, dieresis or umlaut mark 
-igrave	| 236	### small i, grave accent 
-iacute	| 237	### small i, acute accent 
-icirc	| 238	### small i, circumflex accent 
-iuml	| 239	### small i, dieresis or umlaut mark 
-eth	    | 240	### small eth, Icelandic 
-ntilde	| 241	### small n, tilde 
-ograve	| 242	### small o, grave accent 
-oacute	| 243	### small o, acute accent 
-ocirc	| 244	### small o, circumflex accent 
-otilde	| 245	### small o, tilde 
-ouml	| 246	### small o, dieresis or umlaut mark 
-divide	| 247	### divide sign 
-oslash	| 248	### small o, slash 
-ugrave	| 249	### small u, grave accent 
-uacute	| 250	### small u, acute accent 
-ucirc	| 251	### small u, circumflex accent 
-uuml	| 252	### small u, dieresis or umlaut mark 
-yacute	| 253	### small y, acute accent 
-thorn	| 254	### small thorn, Icelandic 
-yuml	| 255	### small y, dieresis or umlaut mark 
-fnof	| 402	### latin small f with hook, =function, =florin, u+0192 ISOtech 
-Alpha	| 913	### greek capital letter alpha,  u+0391 
-Beta	| 914	### greek capital letter beta,  u+0392 
-Gamma	| 915	### greek capital letter gamma,  u+0393 ISOgrk3 
-Delta	| 916	### greek capital letter delta,  u+0394 ISOgrk3 
-Epsilon	| 917	### greek capital letter epsilon,  u+0395 
-Zeta	| 918	### greek capital letter zeta,  u+0396 
-Eta	    | 919	### greek capital letter eta,  u+0397 
-Theta	| 920	### greek capital letter theta,  u+0398 ISOgrk3 
-Iota	| 921	### greek capital letter iota,  u+0399 
-Kappa	| 922	### greek capital letter kappa,  u+039A 
-Lambda	| 923	### greek capital letter lambda,  u+039B ISOgrk3 
-Mu	    | 924	### greek capital letter mu,  u+039C 
-Nu	    | 925	### greek capital letter nu,  u+039D 
-Xi	    | 926	### greek capital letter xi,  u+039E ISOgrk3 
-Omicron	| 927	### greek capital letter omicron,  u+039F 
-Pi	    | 928	### greek capital letter pi,  u+03A0 ISOgrk3 
-Rho	    | 929	### greek capital letter rho,  u+03A1 
-Sigma	| 931	### greek capital letter sigma,  u+03A3 ISOgrk3 
-Tau	    | 932	### greek capital letter tau,  u+03A4 
-Upsilon	| 933	### greek capital letter upsilon,  u+03A5 ISOgrk3 
-Phi	    | 934	### greek capital letter phi,  u+03A6 ISOgrk3 
-Chi	    | 935	### greek capital letter chi,  u+03A7 
-Psi	    | 936	### greek capital letter psi,  u+03A8 ISOgrk3 
-Omega	| 937	### greek capital letter omega,  u+03A9 ISOgrk3 
-alpha	| 945	### greek small letter alpha, u+03B1 ISOgrk3 
-beta	| 946	### greek small letter beta,  u+03B2 ISOgrk3 
-gamma	| 947	### greek small letter gamma,  u+03B3 ISOgrk3 
-delta	| 948	### greek small letter delta,  u+03B4 ISOgrk3 
-epsilon	| 949	### greek small letter epsilon,  u+03B5 ISOgrk3 
-zeta	| 950	### greek small letter zeta,  u+03B6 ISOgrk3 
-eta	    | 951	### greek small letter eta,  u+03B7 ISOgrk3 
-theta	| 952	### greek small letter theta,  u+03B8 ISOgrk3 
-iota	| 953	### greek small letter iota,  u+03B9 ISOgrk3 
-kappa	| 954	### greek small letter kappa,  u+03BA ISOgrk3 
-lambda	| 955	### greek small letter lambda,  u+03BB ISOgrk3 
-mu	    | 956	### greek small letter mu,  u+03BC ISOgrk3 
-nu	    | 957	### greek small letter nu,  u+03BD ISOgrk3 
-xi	    | 958	### greek small letter xi,  u+03BE ISOgrk3 
-omicron	| 959	### greek small letter omicron,  u+03BF NEW 
-pi	    | 960	### greek small letter pi,  u+03C0 ISOgrk3 
-rho	    | 961	### greek small letter rho,  u+03C1 ISOgrk3 
-sigmaf	| 962	### greek small letter final sigma,  u+03C2 ISOgrk3 
-sigma	| 963	### greek small letter sigma,  u+03C3 ISOgrk3 
-tau	    | 964	### greek small letter tau,  u+03C4 ISOgrk3 
-upsilon	| 965	### greek small letter upsilon,  u+03C5 ISOgrk3 
-phi	    | 966	### greek small letter phi,  u+03C6 ISOgrk3 
-chi	    | 967	### greek small letter chi,  u+03C7 ISOgrk3 
-psi	    | 968	### greek small letter psi,  u+03C8 ISOgrk3 
-omega	| 969	### greek small letter omega,  u+03C9 ISOgrk3 
-thetasym| 977	### greek small letter theta symbol,  u+03D1 NEW 
-upsih	| 978	### greek upsilon with hook symbol,  u+03D2 NEW 
-piv	    | 982	### greek pi symbol,  u+03D6 ISOgrk3 
-bull	| 8226	### bullet, =black small circle, u+2022 ISOpub  
-hellip	| 8230	### horizontal ellipsis, =three dot leader, u+2026 ISOpub  
-prime	| 8242	### prime, =minutes, =feet, u+2032 ISOtech 
-Prime	| 8243	### double prime, =seconds, =inches, u+2033 ISOtech 
-oline	| 8254	### overline, =spacing overscore, u+203E NEW 
-frasl	| 8260	### fraction slash, u+2044 NEW 
-weierp	| 8472	### script capital P, =power set, =Weierstrass p, u+2118 ISOamso 
-image	| 8465	### blackletter capital I, =imaginary part, u+2111 ISOamso 
-real	| 8476	### blackletter capital R, =real part symbol, u+211C ISOamso 
-trade	| 8482	### trade mark sign, u+2122 ISOnum 
-alefsym	| 8501	### alef symbol, =first transfinite cardinal, u+2135 NEW 
-larr	| 8592	### leftwards arrow, u+2190 ISOnum 
-uarr	| 8593	### upwards arrow, u+2191 ISOnum
-rarr	| 8594	### rightwards arrow, u+2192 ISOnum 
-darr	| 8595	### downwards arrow, u+2193 ISOnum 
-harr	| 8596	### left right arrow, u+2194 ISOamsa 
-crarr	| 8629	### downwards arrow with corner leftwards, =carriage return, u+21B5 NEW 
-lArr	| 8656	### leftwards double arrow, u+21D0 ISOtech 
-uArr	| 8657	### upwards double arrow, u+21D1 ISOamsa 
-rArr	| 8658	### rightwards double arrow, u+21D2 ISOtech 
-dArr	| 8659	### downwards double arrow, u+21D3 ISOamsa 
-hArr	| 8660	### left right double arrow, u+21D4 ISOamsa 
-forall	| 8704	### for all, u+2200 ISOtech 
-part	| 8706	### partial differential, u+2202 ISOtech  
-exist	| 8707	### there exists, u+2203 ISOtech 
-empty	| 8709	### empty set, =null set, =diameter, u+2205 ISOamso 
-nabla	| 8711	### nabla, =backward difference, u+2207 ISOtech 
-isin	| 8712	### element of, u+2208 ISOtech 
-notin	| 8713	### not an element of, u+2209 ISOtech 
-ni	    | 8715	### contains as member, u+220B ISOtech 
-prod	| 8719	### n-ary product, =product sign, u+220F ISOamsb 
-sum	    | 8721	### n-ary sumation, u+2211 ISOamsb 
-minus	| 8722	### minus sign, u+2212 ISOtech 
-lowast	| 8727	### asterisk operator, u+2217 ISOtech 
-radic	| 8730	### square root, =radical sign, u+221A ISOtech 
-prop	| 8733	### proportional to, u+221D ISOtech 
-infin	| 8734	### infinity, u+221E ISOtech 
-ang	    | 8736	### angle, u+2220 ISOamso 
-and	    | 8743	### logical and, =wedge, u+2227 ISOtech 
-or	    | 8744	### logical or, =vee, u+2228 ISOtech 
-cap	    | 8745	### intersection, =cap, u+2229 ISOtech 
-cup	    | 8746	### union, =cup, u+222A ISOtech 
-int	    | 8747	### integral, u+222B ISOtech 
-there4	| 8756	### therefore, u+2234 ISOtech 
-sim	    | 8764	### tilde operator, =varies with, =similar to, u+223C ISOtech 
-cong	| 8773	### approximately equal to, u+2245 ISOtech 
-asymp	| 8776	### almost equal to, =asymptotic to, u+2248 ISOamsr 
-ne	    | 8800	### not equal to, u+2260 ISOtech 
-equiv	| 8801	### identical to, u+2261 ISOtech 
-le	    | 8804	### less-than or equal to, u+2264 ISOtech 
-ge	    | 8805	### greater-than or equal to, u+2265 ISOtech 
-sub	    | 8834	### subset of, u+2282 ISOtech 
-sup	    | 8835	### superset of, u+2283 ISOtech 
-nsub	| 8836	### not a subset of, u+2284 ISOamsn 
-sube	| 8838	### subset of or equal to, u+2286 ISOtech 
-supe	| 8839	### superset of or equal to, u+2287 ISOtech 
-oplus	| 8853	### circled plus, =direct sum, u+2295 ISOamsb 
-otimes	| 8855	### circled times, =vector product, u+2297 ISOamsb 
-perp	| 8869	### up tack, =orthogonal to, =perpendicular, u+22A5 ISOtech 
-sdot	| 8901	### dot operator, u+22C5 ISOamsb 
-lceil	| 8968	### left ceiling, =apl upstile, u+2308, ISOamsc  
-rceil	| 8969	### right ceiling, u+2309, ISOamsc  
-lfloor	| 8970	### left floor, =apl downstile, u+230A, ISOamsc  
-rfloor	| 8971	### right floor, u+230B, ISOamsc  
-lang	| 9001	### left-pointing angle bracket, =bra, u+2329 ISOtech 
-rang	| 9002	### right-pointing angle bracket, =ket, u+232A ISOtech 
-loz	    | 9674	### lozenge, u+25CA ISOpub 
-spades	| 9824	### black spade suit, u+2660 ISOpub 
-clubs	| 9827	### black club suit, =shamrock, u+2663 ISOpub 
-hearts	| 9829	### black heart suit, =valentine, u+2665 ISOpub 
-diams	| 9830	### black diamond suit, u+2666 ISOpub 
-quot	| 34	### quotation mark, =apl quote, u+0022 ISOnum 
-amp	    | 38	### ampersand, u+0026 ISOnum 
-lt	    | 60	### less-than sign, u+003C ISOnum 
-gt	    | 62	### greater-than sign, u+003E ISOnum 
-OElig	| 338	### latin capital ligature oe, u+0152 ISOlat2 
-oelig	| 339	### latin small ligature oe, u+0153 ISOlat2 
-Scaron	| 352	### latin capital letter s with caron, u+0160 ISOlat2 
-scaron	| 353	### latin small letter s with caron, u+0161 ISOlat2 
-Yuml	| 376	### latin capital letter y with diaeresis, u+0178 ISOlat2 
-circ	| 710	### modifier letter circumflex accent, u+02C6 ISOpub 
-tilde	| 732	### small tilde, u+02DC ISOdia 
-ensp	| 8194	### en space, u+2002 ISOpub 
-emsp	| 8195	### em space, u+2003 ISOpub 
-thinsp	| 8201	### thin space, u+2009 ISOpub 
-zwnj	| 8204	### zero width non-joiner, u+200C NEW RFC 2070 
-zwj	    | 8205	### zero width joiner, u+200D NEW RFC 2070 
-lrm	    | 8206	### left-to-right mark, u+200E NEW RFC 2070 
-rlm	    | 8207	### right-to-left mark, u+200F NEW RFC 2070 
-ndash	| 8211	### en dash, u+2013 ISOpub 
-mdash	| 8212	### em dash, u+2014 ISOpub 
-lsquo	| 8216	### left single quotation mark, u+2018 ISOnum 
-rsquo	| 8217	### right single quotation mark, u+2019 ISOnum 
-sbquo	| 8218	### single low-9 quotation mark, u+201A NEW 
-ldquo	| 8220	### left double quotation mark, u+201C ISOnum 
-rdquo	| 8221	### right double quotation mark, u+201D ISOnum 
-bdquo	| 8222	### double low-9 quotation mark, u+201E NEW 
-dagger	| 8224	### dagger, u+2020 ISOpub 
-Dagger	| 8225	### double dagger, u+2021 ISOpub 
-permil	| 8240	### per mille sign, u+2030 ISOtech 
-lsaquo	| 8249	### single left-pointing angle quotation mark; proposed but not yet standardised
-rsaquo	| 8250	### single right-pointing angle quotation mark; proposed but not yet standardised
+### Named HTML character entities, their numeric reference 
+### (e.g. for &#[0-9]+; entity form), and their use.
+### From: http://www.w3.org/TR/html401/sgml/entities.html
+###
+nbsp	| 160	### no-break space 
+iexcl	| 161	### inverted exclamation mark 
+cent	| 162	### cent sign 
+pound	| 163	### pound sterling sign 
+curren	| 164	### general currency sign 
+yen	    | 165	### yen sign 
+brvbar	| 166	### broken (vertical) bar 
+sect	| 167	### section sign 
+uml	    | 168	### umlaut (dieresis) 
+copy	| 169	### copyright sign 
+ordf	| 170	### ordinal indicator, feminine 
+laquo	| 171	### angle quotation mark, left 
+not	    | 172	### not sign 
+shy	    | 173	### soft hyphen 
+reg	    | 174	### registered sign 
+macr	| 175	### macron 
+deg	    | 176	### degree sign 
+plusmn	| 177	### plus-or-minus sign 
+sup2	| 178	### superscript two 
+sup3	| 179	### superscript three 
+acute	| 180	### acute accent 
+micro	| 181	### micro sign 
+para	| 182	### pilcrow (paragraph sign) 
+middot	| 183	### middle dot 
+cedil	| 184	### cedilla 
+sup1	| 185	### superscript one 
+ordm	| 186	### ordinal indicator, masculine 
+raquo	| 187	### angle quotation mark, right 
+frac14	| 188	### fraction one-quarter 
+frac12	| 189	### fraction one-half 
+frac34	| 190	### fraction three-quarters 
+iquest	| 191	### inverted question mark 
+Agrave	| 192	### capital A, grave accent 
+Aacute	| 193	### capital A, acute accent 
+Acirc	| 194	### capital A, circumflex accent 
+Atilde	| 195	### capital A, tilde 
+Auml	| 196	### capital A, dieresis or umlaut mark 
+Aring	| 197	### capital A, ring 
+AElig	| 198	### capital AE diphthong (ligature) 
+Ccedil	| 199	### capital C, cedilla 
+Egrave	| 200	### capital E, grave accent 
+Eacute	| 201	### capital E, acute accent 
+Ecirc	| 202	### capital E, circumflex accent 
+Euml	| 203	### capital E, dieresis or umlaut mark 
+Igrave	| 204	### capital I, grave accent 
+Iacute	| 205	### capital I, acute accent 
+Icirc	| 206	### capital I, circumflex accent 
+Iuml	| 207	### capital I, dieresis or umlaut mark 
+ETH	    | 208	### capital Eth, Icelandic 
+Ntilde	| 209	### capital N, tilde 
+Ograve	| 210	### capital O, grave accent 
+Oacute	| 211	### capital O, acute accent 
+Ocirc	| 212	### capital O, circumflex accent 
+Otilde	| 213	### capital O, tilde 
+Ouml	| 214	### capital O, dieresis or umlaut mark 
+times	| 215	### multiply sign 
+Oslash	| 216	### capital O, slash 
+Ugrave	| 217	### capital U, grave accent 
+Uacute	| 218	### capital U, acute accent 
+Ucirc	| 219	### capital U, circumflex accent 
+Uuml	| 220	### capital U, dieresis or umlaut mark 
+Yacute	| 221	### capital Y, acute accent 
+THORN	| 222	### capital THORN, Icelandic 
+szlig	| 223	### small sharp s, German (sz ligature) 
+agrave	| 224	### small a, grave accent 
+aacute	| 225	### small a, acute accent 
+acirc	| 226	### small a, circumflex accent 
+atilde	| 227	### small a, tilde 
+auml	| 228	### small a, dieresis or umlaut mark 
+aring	| 229	### small a, ring 
+aelig	| 230	### small ae diphthong (ligature) 
+ccedil	| 231	### small c, cedilla 
+egrave	| 232	### small e, grave accent 
+eacute	| 233	### small e, acute accent 
+ecirc	| 234	### small e, circumflex accent 
+euml	| 235	### small e, dieresis or umlaut mark 
+igrave	| 236	### small i, grave accent 
+iacute	| 237	### small i, acute accent 
+icirc	| 238	### small i, circumflex accent 
+iuml	| 239	### small i, dieresis or umlaut mark 
+eth	    | 240	### small eth, Icelandic 
+ntilde	| 241	### small n, tilde 
+ograve	| 242	### small o, grave accent 
+oacute	| 243	### small o, acute accent 
+ocirc	| 244	### small o, circumflex accent 
+otilde	| 245	### small o, tilde 
+ouml	| 246	### small o, dieresis or umlaut mark 
+divide	| 247	### divide sign 
+oslash	| 248	### small o, slash 
+ugrave	| 249	### small u, grave accent 
+uacute	| 250	### small u, acute accent 
+ucirc	| 251	### small u, circumflex accent 
+uuml	| 252	### small u, dieresis or umlaut mark 
+yacute	| 253	### small y, acute accent 
+thorn	| 254	### small thorn, Icelandic 
+yuml	| 255	### small y, dieresis or umlaut mark 
+fnof	| 402	### latin small f with hook, =function, =florin, u+0192 ISOtech 
+Alpha	| 913	### greek capital letter alpha,  u+0391 
+Beta	| 914	### greek capital letter beta,  u+0392 
+Gamma	| 915	### greek capital letter gamma,  u+0393 ISOgrk3 
+Delta	| 916	### greek capital letter delta,  u+0394 ISOgrk3 
+Epsilon	| 917	### greek capital letter epsilon,  u+0395 
+Zeta	| 918	### greek capital letter zeta,  u+0396 
+Eta	    | 919	### greek capital letter eta,  u+0397 
+Theta	| 920	### greek capital letter theta,  u+0398 ISOgrk3 
+Iota	| 921	### greek capital letter iota,  u+0399 
+Kappa	| 922	### greek capital letter kappa,  u+039A 
+Lambda	| 923	### greek capital letter lambda,  u+039B ISOgrk3 
+Mu	    | 924	### greek capital letter mu,  u+039C 
+Nu	    | 925	### greek capital letter nu,  u+039D 
+Xi	    | 926	### greek capital letter xi,  u+039E ISOgrk3 
+Omicron	| 927	### greek capital letter omicron,  u+039F 
+Pi	    | 928	### greek capital letter pi,  u+03A0 ISOgrk3 
+Rho	    | 929	### greek capital letter rho,  u+03A1 
+Sigma	| 931	### greek capital letter sigma,  u+03A3 ISOgrk3 
+Tau	    | 932	### greek capital letter tau,  u+03A4 
+Upsilon	| 933	### greek capital letter upsilon,  u+03A5 ISOgrk3 
+Phi	    | 934	### greek capital letter phi,  u+03A6 ISOgrk3 
+Chi	    | 935	### greek capital letter chi,  u+03A7 
+Psi	    | 936	### greek capital letter psi,  u+03A8 ISOgrk3 
+Omega	| 937	### greek capital letter omega,  u+03A9 ISOgrk3 
+alpha	| 945	### greek small letter alpha, u+03B1 ISOgrk3 
+beta	| 946	### greek small letter beta,  u+03B2 ISOgrk3 
+gamma	| 947	### greek small letter gamma,  u+03B3 ISOgrk3 
+delta	| 948	### greek small letter delta,  u+03B4 ISOgrk3 
+epsilon	| 949	### greek small letter epsilon,  u+03B5 ISOgrk3 
+zeta	| 950	### greek small letter zeta,  u+03B6 ISOgrk3 
+eta	    | 951	### greek small letter eta,  u+03B7 ISOgrk3 
+theta	| 952	### greek small letter theta,  u+03B8 ISOgrk3 
+iota	| 953	### greek small letter iota,  u+03B9 ISOgrk3 
+kappa	| 954	### greek small letter kappa,  u+03BA ISOgrk3 
+lambda	| 955	### greek small letter lambda,  u+03BB ISOgrk3 
+mu	    | 956	### greek small letter mu,  u+03BC ISOgrk3 
+nu	    | 957	### greek small letter nu,  u+03BD ISOgrk3 
+xi	    | 958	### greek small letter xi,  u+03BE ISOgrk3 
+omicron	| 959	### greek small letter omicron,  u+03BF NEW 
+pi	    | 960	### greek small letter pi,  u+03C0 ISOgrk3 
+rho	    | 961	### greek small letter rho,  u+03C1 ISOgrk3 
+sigmaf	| 962	### greek small letter final sigma,  u+03C2 ISOgrk3 
+sigma	| 963	### greek small letter sigma,  u+03C3 ISOgrk3 
+tau	    | 964	### greek small letter tau,  u+03C4 ISOgrk3 
+upsilon	| 965	### greek small letter upsilon,  u+03C5 ISOgrk3 
+phi	    | 966	### greek small letter phi,  u+03C6 ISOgrk3 
+chi	    | 967	### greek small letter chi,  u+03C7 ISOgrk3 
+psi	    | 968	### greek small letter psi,  u+03C8 ISOgrk3 
+omega	| 969	### greek small letter omega,  u+03C9 ISOgrk3 
+thetasym| 977	### greek small letter theta symbol,  u+03D1 NEW 
+upsih	| 978	### greek upsilon with hook symbol,  u+03D2 NEW 
+piv	    | 982	### greek pi symbol,  u+03D6 ISOgrk3 
+bull	| 8226	### bullet, =black small circle, u+2022 ISOpub  
+hellip	| 8230	### horizontal ellipsis, =three dot leader, u+2026 ISOpub  
+prime	| 8242	### prime, =minutes, =feet, u+2032 ISOtech 
+Prime	| 8243	### double prime, =seconds, =inches, u+2033 ISOtech 
+oline	| 8254	### overline, =spacing overscore, u+203E NEW 
+frasl	| 8260	### fraction slash, u+2044 NEW 
+weierp	| 8472	### script capital P, =power set, =Weierstrass p, u+2118 ISOamso 
+image	| 8465	### blackletter capital I, =imaginary part, u+2111 ISOamso 
+real	| 8476	### blackletter capital R, =real part symbol, u+211C ISOamso 
+trade	| 8482	### trade mark sign, u+2122 ISOnum 
+alefsym	| 8501	### alef symbol, =first transfinite cardinal, u+2135 NEW 
+larr	| 8592	### leftwards arrow, u+2190 ISOnum 
+uarr	| 8593	### upwards arrow, u+2191 ISOnum
+rarr	| 8594	### rightwards arrow, u+2192 ISOnum 
+darr	| 8595	### downwards arrow, u+2193 ISOnum 
+harr	| 8596	### left right arrow, u+2194 ISOamsa 
+crarr	| 8629	### downwards arrow with corner leftwards, =carriage return, u+21B5 NEW 
+lArr	| 8656	### leftwards double arrow, u+21D0 ISOtech 
+uArr	| 8657	### upwards double arrow, u+21D1 ISOamsa 
+rArr	| 8658	### rightwards double arrow, u+21D2 ISOtech 
+dArr	| 8659	### downwards double arrow, u+21D3 ISOamsa 
+hArr	| 8660	### left right double arrow, u+21D4 ISOamsa 
+forall	| 8704	### for all, u+2200 ISOtech 
+part	| 8706	### partial differential, u+2202 ISOtech  
+exist	| 8707	### there exists, u+2203 ISOtech 
+empty	| 8709	### empty set, =null set, =diameter, u+2205 ISOamso 
+nabla	| 8711	### nabla, =backward difference, u+2207 ISOtech 
+isin	| 8712	### element of, u+2208 ISOtech 
+notin	| 8713	### not an element of, u+2209 ISOtech 
+ni	    | 8715	### contains as member, u+220B ISOtech 
+prod	| 8719	### n-ary product, =product sign, u+220F ISOamsb 
+sum	    | 8721	### n-ary sumation, u+2211 ISOamsb 
+minus	| 8722	### minus sign, u+2212 ISOtech 
+lowast	| 8727	### asterisk operator, u+2217 ISOtech 
+radic	| 8730	### square root, =radical sign, u+221A ISOtech 
+prop	| 8733	### proportional to, u+221D ISOtech 
+infin	| 8734	### infinity, u+221E ISOtech 
+ang	    | 8736	### angle, u+2220 ISOamso 
+and	    | 8743	### logical and, =wedge, u+2227 ISOtech 
+or	    | 8744	### logical or, =vee, u+2228 ISOtech 
+cap	    | 8745	### intersection, =cap, u+2229 ISOtech 
+cup	    | 8746	### union, =cup, u+222A ISOtech 
+int	    | 8747	### integral, u+222B ISOtech 
+there4	| 8756	### therefore, u+2234 ISOtech 
+sim	    | 8764	### tilde operator, =varies with, =similar to, u+223C ISOtech 
+cong	| 8773	### approximately equal to, u+2245 ISOtech 
+asymp	| 8776	### almost equal to, =asymptotic to, u+2248 ISOamsr 
+ne	    | 8800	### not equal to, u+2260 ISOtech 
+equiv	| 8801	### identical to, u+2261 ISOtech 
+le	    | 8804	### less-than or equal to, u+2264 ISOtech 
+ge	    | 8805	### greater-than or equal to, u+2265 ISOtech 
+sub	    | 8834	### subset of, u+2282 ISOtech 
+sup	    | 8835	### superset of, u+2283 ISOtech 
+nsub	| 8836	### not a subset of, u+2284 ISOamsn 
+sube	| 8838	### subset of or equal to, u+2286 ISOtech 
+supe	| 8839	### superset of or equal to, u+2287 ISOtech 
+oplus	| 8853	### circled plus, =direct sum, u+2295 ISOamsb 
+otimes	| 8855	### circled times, =vector product, u+2297 ISOamsb 
+perp	| 8869	### up tack, =orthogonal to, =perpendicular, u+22A5 ISOtech 
+sdot	| 8901	### dot operator, u+22C5 ISOamsb 
+lceil	| 8968	### left ceiling, =apl upstile, u+2308, ISOamsc  
+rceil	| 8969	### right ceiling, u+2309, ISOamsc  
+lfloor	| 8970	### left floor, =apl downstile, u+230A, ISOamsc  
+rfloor	| 8971	### right floor, u+230B, ISOamsc  
+lang	| 9001	### left-pointing angle bracket, =bra, u+2329 ISOtech 
+rang	| 9002	### right-pointing angle bracket, =ket, u+232A ISOtech 
+loz	    | 9674	### lozenge, u+25CA ISOpub 
+spades	| 9824	### black spade suit, u+2660 ISOpub 
+clubs	| 9827	### black club suit, =shamrock, u+2663 ISOpub 
+hearts	| 9829	### black heart suit, =valentine, u+2665 ISOpub 
+diams	| 9830	### black diamond suit, u+2666 ISOpub 
+quot	| 34	### quotation mark, =apl quote, u+0022 ISOnum 
+amp	    | 38	### ampersand, u+0026 ISOnum 
+lt	    | 60	### less-than sign, u+003C ISOnum 
+gt	    | 62	### greater-than sign, u+003E ISOnum 
+OElig	| 338	### latin capital ligature oe, u+0152 ISOlat2 
+oelig	| 339	### latin small ligature oe, u+0153 ISOlat2 
+Scaron	| 352	### latin capital letter s with caron, u+0160 ISOlat2 
+scaron	| 353	### latin small letter s with caron, u+0161 ISOlat2 
+Yuml	| 376	### latin capital letter y with diaeresis, u+0178 ISOlat2 
+circ	| 710	### modifier letter circumflex accent, u+02C6 ISOpub 
+tilde	| 732	### small tilde, u+02DC ISOdia 
+ensp	| 8194	### en space, u+2002 ISOpub 
+emsp	| 8195	### em space, u+2003 ISOpub 
+thinsp	| 8201	### thin space, u+2009 ISOpub 
+zwnj	| 8204	### zero width non-joiner, u+200C NEW RFC 2070 
+zwj	    | 8205	### zero width joiner, u+200D NEW RFC 2070 
+lrm	    | 8206	### left-to-right mark, u+200E NEW RFC 2070 
+rlm	    | 8207	### right-to-left mark, u+200F NEW RFC 2070 
+ndash	| 8211	### en dash, u+2013 ISOpub 
+mdash	| 8212	### em dash, u+2014 ISOpub 
+lsquo	| 8216	### left single quotation mark, u+2018 ISOnum 
+rsquo	| 8217	### right single quotation mark, u+2019 ISOnum 
+sbquo	| 8218	### single low-9 quotation mark, u+201A NEW 
+ldquo	| 8220	### left double quotation mark, u+201C ISOnum 
+rdquo	| 8221	### right double quotation mark, u+201D ISOnum 
+bdquo	| 8222	### double low-9 quotation mark, u+201E NEW 
+dagger	| 8224	### dagger, u+2020 ISOpub 
+Dagger	| 8225	### double dagger, u+2021 ISOpub 
+permil	| 8240	### per mille sign, u+2030 ISOtech 
+lsaquo	| 8249	### single left-pointing angle quotation mark; proposed but not yet standardised
+rsaquo	| 8250	### single right-pointing angle quotation mark; proposed but not yet standardised
diff --git a/data/formatting/sizzle.js b/data/formatting/sizzle.js
index 58c2219cf1..6816c435de 100644
--- a/data/formatting/sizzle.js
+++ b/data/formatting/sizzle.js
@@ -1,1445 +1,1445 @@
-/*!
- * Sizzle CSS Selector Engine
- *  Copyright 2011, The Dojo Foundation
- *  Released under the MIT, BSD, and GPL Licenses.
- *  More information: http://sizzlejs.com/
- */
-(function(){
-
-var chunker = /((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,
-	expando = "sizcache" + (Math.random() + '').replace('.', ''),
-	done = 0,
-	toString = Object.prototype.toString,
-	hasDuplicate = false,
-	baseHasDuplicate = true,
-	rBackslash = /\\/g,
-	rReturn = /\r\n/g,
-	rNonWord = /\W/;
-
-// Here we check if the JavaScript engine is using some sort of
-// optimization where it does not always call our comparision
-// function. If that is the case, discard the hasDuplicate value.
-//   Thus far that includes Google Chrome.
-[0, 0].sort(function() {
-	baseHasDuplicate = false;
-	return 0;
-});
-
-var Sizzle = function( selector, context, results, seed ) {
-	results = results || [];
-	context = context || document;
-
-	var origContext = context;
-
-	if ( context.nodeType !== 1 && context.nodeType !== 9 ) {
-		return [];
-	}
-
-	if ( !selector || typeof selector !== "string" ) {
-		return results;
-	}
-
-	var m, set, checkSet, extra, ret, cur, pop, i,
-		prune = true,
-		contextXML = Sizzle.isXML( context ),
-		parts = [],
-		soFar = selector;
-
-	// Reset the position of the chunker regexp (start from head)
-	do {
-		chunker.exec( "" );
-		m = chunker.exec( soFar );
-
-		if ( m ) {
-			soFar = m[3];
-
-			parts.push( m[1] );
-
-			if ( m[2] ) {
-				extra = m[3];
-				break;
-			}
-		}
-	} while ( m );
-
-	if ( parts.length > 1 && origPOS.exec( selector ) ) {
-
-		if ( parts.length === 2 && Expr.relative[ parts[0] ] ) {
-			set = posProcess( parts[0] + parts[1], context, seed );
-
-		} else {
-			set = Expr.relative[ parts[0] ] ?
-				[ context ] :
-				Sizzle( parts.shift(), context );
-
-			while ( parts.length ) {
-				selector = parts.shift();
-
-				if ( Expr.relative[ selector ] ) {
-					selector += parts.shift();
-				}
-
-				set = posProcess( selector, set, seed );
-			}
-		}
-
-	} else {
-		// Take a shortcut and set the context if the root selector is an ID
-		// (but not if it'll be faster if the inner selector is an ID)
-		if ( !seed && parts.length > 1 && context.nodeType === 9 && !contextXML &&
-				Expr.match.ID.test(parts[0]) && !Expr.match.ID.test(parts[parts.length - 1]) ) {
-
-			ret = Sizzle.find( parts.shift(), context, contextXML );
-			context = ret.expr ?
-				Sizzle.filter( ret.expr, ret.set )[0] :
-				ret.set[0];
-		}
-
-		if ( context ) {
-			ret = seed ?
-				{ expr: parts.pop(), set: makeArray(seed) } :
-				Sizzle.find( parts.pop(), parts.length === 1 && (parts[0] === "~" || parts[0] === "+") && context.parentNode ? context.parentNode : context, contextXML );
-
-			set = ret.expr ?
-				Sizzle.filter( ret.expr, ret.set ) :
-				ret.set;
-
-			if ( parts.length > 0 ) {
-				checkSet = makeArray( set );
-
-			} else {
-				prune = false;
-			}
-
-			while ( parts.length ) {
-				cur = parts.pop();
-				pop = cur;
-
-				if ( !Expr.relative[ cur ] ) {
-					cur = "";
-				} else {
-					pop = parts.pop();
-				}
-
-				if ( pop == null ) {
-					pop = context;
-				}
-
-				Expr.relative[ cur ]( checkSet, pop, contextXML );
-			}
-
-		} else {
-			checkSet = parts = [];
-		}
-	}
-
-	if ( !checkSet ) {
-		checkSet = set;
-	}
-
-	if ( !checkSet ) {
-		Sizzle.error( cur || selector );
-	}
-
-	if ( toString.call(checkSet) === "[object Array]" ) {
-		if ( !prune ) {
-			results.push.apply( results, checkSet );
-
-		} else if ( context && context.nodeType === 1 ) {
-			for ( i = 0; checkSet[i] != null; i++ ) {
-				if ( checkSet[i] && (checkSet[i] === true || checkSet[i].nodeType === 1 && Sizzle.contains(context, checkSet[i])) ) {
-					results.push( set[i] );
-				}
-			}
-
-		} else {
-			for ( i = 0; checkSet[i] != null; i++ ) {
-				if ( checkSet[i] && checkSet[i].nodeType === 1 ) {
-					results.push( set[i] );
-				}
-			}
-		}
-
-	} else {
-		makeArray( checkSet, results );
-	}
-
-	if ( extra ) {
-		Sizzle( extra, origContext, results, seed );
-		Sizzle.uniqueSort( results );
-	}
-
-	return results;
-};
-
-Sizzle.uniqueSort = function( results ) {
-	if ( sortOrder ) {
-		hasDuplicate = baseHasDuplicate;
-		results.sort( sortOrder );
-
-		if ( hasDuplicate ) {
-			for ( var i = 1; i < results.length; i++ ) {
-				if ( results[i] === results[ i - 1 ] ) {
-					results.splice( i--, 1 );
-				}
-			}
-		}
-	}
-
-	return results;
-};
-
-Sizzle.matches = function( expr, set ) {
-	return Sizzle( expr, null, null, set );
-};
-
-Sizzle.matchesSelector = function( node, expr ) {
-	return Sizzle( expr, null, null, [node] ).length > 0;
-};
-
-Sizzle.find = function( expr, context, isXML ) {
-	var set, i, len, match, type, left;
-
-	if ( !expr ) {
-		return [];
-	}
-
-	for ( i = 0, len = Expr.order.length; i < len; i++ ) {
-		type = Expr.order[i];
-
-		if ( (match = Expr.leftMatch[ type ].exec( expr )) ) {
-			left = match[1];
-			match.splice( 1, 1 );
-
-			if ( left.substr( left.length - 1 ) !== "\\" ) {
-				match[1] = (match[1] || "").replace( rBackslash, "" );
-				set = Expr.find[ type ]( match, context, isXML );
-
-				if ( set != null ) {
-					expr = expr.replace( Expr.match[ type ], "" );
-					break;
-				}
-			}
-		}
-	}
-
-	if ( !set ) {
-		set = typeof context.getElementsByTagName !== "undefined" ?
-			context.getElementsByTagName( "*" ) :
-			[];
-	}
-
-	return { set: set, expr: expr };
-};
-
-Sizzle.filter = function( expr, set, inplace, not ) {
-	var match, anyFound,
-		type, found, item, filter, left,
-		i, pass,
-		old = expr,
-		result = [],
-		curLoop = set,
-		isXMLFilter = set && set[0] && Sizzle.isXML( set[0] );
-
-	while ( expr && set.length ) {
-		for ( type in Expr.filter ) {
-			if ( (match = Expr.leftMatch[ type ].exec( expr )) != null && match[2] ) {
-				filter = Expr.filter[ type ];
-				left = match[1];
-
-				anyFound = false;
-
-				match.splice(1,1);
-
-				if ( left.substr( left.length - 1 ) === "\\" ) {
-					continue;
-				}
-
-				if ( curLoop === result ) {
-					result = [];
-				}
-
-				if ( Expr.preFilter[ type ] ) {
-					match = Expr.preFilter[ type ]( match, curLoop, inplace, result, not, isXMLFilter );
-
-					if ( !match ) {
-						anyFound = found = true;
-
-					} else if ( match === true ) {
-						continue;
-					}
-				}
-
-				if ( match ) {
-					for ( i = 0; (item = curLoop[i]) != null; i++ ) {
-						if ( item ) {
-							found = filter( item, match, i, curLoop );
-							pass = not ^ found;
-
-							if ( inplace && found != null ) {
-								if ( pass ) {
-									anyFound = true;
-
-								} else {
-									curLoop[i] = false;
-								}
-
-							} else if ( pass ) {
-								result.push( item );
-								anyFound = true;
-							}
-						}
-					}
-				}
-
-				if ( found !== undefined ) {
-					if ( !inplace ) {
-						curLoop = result;
-					}
-
-					expr = expr.replace( Expr.match[ type ], "" );
-
-					if ( !anyFound ) {
-						return [];
-					}
-
-					break;
-				}
-			}
-		}
-
-		// Improper expression
-		if ( expr === old ) {
-			if ( anyFound == null ) {
-				Sizzle.error( expr );
-
-			} else {
-				break;
-			}
-		}
-
-		old = expr;
-	}
-
-	return curLoop;
-};
-
-Sizzle.error = function( msg ) {
-	throw new Error( "Syntax error, unrecognized expression: " + msg );
-};
-
-/**
- * Utility function for retreiving the text value of an array of DOM nodes
- * @param {Array|Element} elem
- */
-var getText = Sizzle.getText = function( elem ) {
-    var i, node,
-		nodeType = elem.nodeType,
-		ret = "";
-
-	if ( nodeType ) {
-		if ( nodeType === 1 || nodeType === 9 || nodeType === 11 ) {
-			// Use textContent || innerText for elements
-			if ( typeof elem.textContent === 'string' ) {
-				return elem.textContent;
-			} else if ( typeof elem.innerText === 'string' ) {
-				// Replace IE's carriage returns
-				return elem.innerText.replace( rReturn, '' );
-			} else {
-				// Traverse it's children
-				for ( elem = elem.firstChild; elem; elem = elem.nextSibling) {
-					ret += getText( elem );
-				}
-			}
-		} else if ( nodeType === 3 || nodeType === 4 ) {
-			return elem.nodeValue;
-		}
-	} else {
-
-		// If no nodeType, this is expected to be an array
-		for ( i = 0; (node = elem[i]); i++ ) {
-			// Do not traverse comment nodes
-			if ( node.nodeType !== 8 ) {
-				ret += getText( node );
-			}
-		}
-	}
-	return ret;
-};
-
-var Expr = Sizzle.selectors = {
-	order: [ "ID", "NAME", "TAG" ],
-
-	match: {
-		ID: /#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,
-		CLASS: /\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,
-		NAME: /\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,
-		ATTR: /\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,
-		TAG: /^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,
-		CHILD: /:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,
-		POS: /:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,
-		PSEUDO: /:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/
-	},
-
-	leftMatch: {},
-
-	attrMap: {
-		"class": "className",
-		"for": "htmlFor"
-	},
-
-	attrHandle: {
-		href: function( elem ) {
-			return elem.getAttribute( "href" );
-		},
-		type: function( elem ) {
-			return elem.getAttribute( "type" );
-		}
-	},
-
-	relative: {
-		"+": function(checkSet, part){
-			var isPartStr = typeof part === "string",
-				isTag = isPartStr && !rNonWord.test( part ),
-				isPartStrNotTag = isPartStr && !isTag;
-
-			if ( isTag ) {
-				part = part.toLowerCase();
-			}
-
-			for ( var i = 0, l = checkSet.length, elem; i < l; i++ ) {
-				if ( (elem = checkSet[i]) ) {
-					while ( (elem = elem.previousSibling) && elem.nodeType !== 1 ) {}
-
-					checkSet[i] = isPartStrNotTag || elem && elem.nodeName.toLowerCase() === part ?
-						elem || false :
-						elem === part;
-				}
-			}
-
-			if ( isPartStrNotTag ) {
-				Sizzle.filter( part, checkSet, true );
-			}
-		},
-
-		">": function( checkSet, part ) {
-			var elem,
-				isPartStr = typeof part === "string",
-				i = 0,
-				l = checkSet.length;
-
-			if ( isPartStr && !rNonWord.test( part ) ) {
-				part = part.toLowerCase();
-
-				for ( ; i < l; i++ ) {
-					elem = checkSet[i];
-
-					if ( elem ) {
-						var parent = elem.parentNode;
-						checkSet[i] = parent.nodeName.toLowerCase() === part ? parent : false;
-					}
-				}
-
-			} else {
-				for ( ; i < l; i++ ) {
-					elem = checkSet[i];
-
-					if ( elem ) {
-						checkSet[i] = isPartStr ?
-							elem.parentNode :
-							elem.parentNode === part;
-					}
-				}
-
-				if ( isPartStr ) {
-					Sizzle.filter( part, checkSet, true );
-				}
-			}
-		},
-
-		"": function(checkSet, part, isXML){
-			var nodeCheck,
-				doneName = done++,
-				checkFn = dirCheck;
-
-			if ( typeof part === "string" && !rNonWord.test( part ) ) {
-				part = part.toLowerCase();
-				nodeCheck = part;
-				checkFn = dirNodeCheck;
-			}
-
-			checkFn( "parentNode", part, doneName, checkSet, nodeCheck, isXML );
-		},
-
-		"~": function( checkSet, part, isXML ) {
-			var nodeCheck,
-				doneName = done++,
-				checkFn = dirCheck;
-
-			if ( typeof part === "string" && !rNonWord.test( part ) ) {
-				part = part.toLowerCase();
-				nodeCheck = part;
-				checkFn = dirNodeCheck;
-			}
-
-			checkFn( "previousSibling", part, doneName, checkSet, nodeCheck, isXML );
-		}
-	},
-
-	find: {
-		ID: function( match, context, isXML ) {
-			if ( typeof context.getElementById !== "undefined" && !isXML ) {
-				var m = context.getElementById(match[1]);
-				// Check parentNode to catch when Blackberry 4.6 returns
-				// nodes that are no longer in the document #6963
-				return m && m.parentNode ? [m] : [];
-			}
-		},
-
-		NAME: function( match, context ) {
-			if ( typeof context.getElementsByName !== "undefined" ) {
-				var ret = [],
-					results = context.getElementsByName( match[1] );
-
-				for ( var i = 0, l = results.length; i < l; i++ ) {
-					if ( results[i].getAttribute("name") === match[1] ) {
-						ret.push( results[i] );
-					}
-				}
-
-				return ret.length === 0 ? null : ret;
-			}
-		},
-
-		TAG: function( match, context ) {
-			if ( typeof context.getElementsByTagName !== "undefined" ) {
-				return context.getElementsByTagName( match[1] );
-			}
-		}
-	},
-	preFilter: {
-		CLASS: function( match, curLoop, inplace, result, not, isXML ) {
-			match = " " + match[1].replace( rBackslash, "" ) + " ";
-
-			if ( isXML ) {
-				return match;
-			}
-
-			for ( var i = 0, elem; (elem = curLoop[i]) != null; i++ ) {
-				if ( elem ) {
-					if ( not ^ (elem.className && (" " + elem.className + " ").replace(/[\t\n\r]/g, " ").indexOf(match) >= 0) ) {
-						if ( !inplace ) {
-							result.push( elem );
-						}
-
-					} else if ( inplace ) {
-						curLoop[i] = false;
-					}
-				}
-			}
-
-			return false;
-		},
-
-		ID: function( match ) {
-			return match[1].replace( rBackslash, "" );
-		},
-
-		TAG: function( match, curLoop ) {
-			return match[1].replace( rBackslash, "" ).toLowerCase();
-		},
-
-		CHILD: function( match ) {
-			if ( match[1] === "nth" ) {
-				if ( !match[2] ) {
-					Sizzle.error( match[0] );
-				}
-
-				match[2] = match[2].replace(/^\+|\s*/g, '');
-
-				// parse equations like 'even', 'odd', '5', '2n', '3n+2', '4n-1', '-n+6'
-				var test = /(-?)(\d*)(?:n([+\-]?\d*))?/.exec(
-					match[2] === "even" && "2n" || match[2] === "odd" && "2n+1" ||
-					!/\D/.test( match[2] ) && "0n+" + match[2] || match[2]);
-
-				// calculate the numbers (first)n+(last) including if they are negative
-				match[2] = (test[1] + (test[2] || 1)) - 0;
-				match[3] = test[3] - 0;
-			}
-			else if ( match[2] ) {
-				Sizzle.error( match[0] );
-			}
-
-			// TODO: Move to normal caching system
-			match[0] = done++;
-
-			return match;
-		},
-
-		ATTR: function( match, curLoop, inplace, result, not, isXML ) {
-			var name = match[1] = match[1].replace( rBackslash, "" );
-
-			if ( !isXML && Expr.attrMap[name] ) {
-				match[1] = Expr.attrMap[name];
-			}
-
-			// Handle if an un-quoted value was used
-			match[4] = ( match[4] || match[5] || "" ).replace( rBackslash, "" );
-
-			if ( match[2] === "~=" ) {
-				match[4] = " " + match[4] + " ";
-			}
-
-			return match;
-		},
-
-		PSEUDO: function( match, curLoop, inplace, result, not ) {
-			if ( match[1] === "not" ) {
-				// If we're dealing with a complex expression, or a simple one
-				if ( ( chunker.exec(match[3]) || "" ).length > 1 || /^\w/.test(match[3]) ) {
-					match[3] = Sizzle(match[3], null, null, curLoop);
-
-				} else {
-					var ret = Sizzle.filter(match[3], curLoop, inplace, true ^ not);
-
-					if ( !inplace ) {
-						result.push.apply( result, ret );
-					}
-
-					return false;
-				}
-
-			} else if ( Expr.match.POS.test( match[0] ) || Expr.match.CHILD.test( match[0] ) ) {
-				return true;
-			}
-
-			return match;
-		},
-
-		POS: function( match ) {
-			match.unshift( true );
-
-			return match;
-		}
-	},
-
-	filters: {
-		enabled: function( elem ) {
-			return elem.disabled === false && elem.type !== "hidden";
-		},
-
-		disabled: function( elem ) {
-			return elem.disabled === true;
-		},
-
-		checked: function( elem ) {
-			return elem.checked === true;
-		},
-
-		selected: function( elem ) {
-			// Accessing this property makes selected-by-default
-			// options in Safari work properly
-			if ( elem.parentNode ) {
-				elem.parentNode.selectedIndex;
-			}
-
-			return elem.selected === true;
-		},
-
-		parent: function( elem ) {
-			return !!elem.firstChild;
-		},
-
-		empty: function( elem ) {
-			return !elem.firstChild;
-		},
-
-		has: function( elem, i, match ) {
-			return !!Sizzle( match[3], elem ).length;
-		},
-
-		header: function( elem ) {
-			return (/h\d/i).test( elem.nodeName );
-		},
-
-		text: function( elem ) {
-			var attr = elem.getAttribute( "type" ), type = elem.type;
-			// IE6 and 7 will map elem.type to 'text' for new HTML5 types (search, etc)
-			// use getAttribute instead to test this case
-			return elem.nodeName.toLowerCase() === "input" && "text" === type && ( attr === type || attr === null );
-		},
-
-		radio: function( elem ) {
-			return elem.nodeName.toLowerCase() === "input" && "radio" === elem.type;
-		},
-
-		checkbox: function( elem ) {
-			return elem.nodeName.toLowerCase() === "input" && "checkbox" === elem.type;
-		},
-
-		file: function( elem ) {
-			return elem.nodeName.toLowerCase() === "input" && "file" === elem.type;
-		},
-
-		password: function( elem ) {
-			return elem.nodeName.toLowerCase() === "input" && "password" === elem.type;
-		},
-
-		submit: function( elem ) {
-			var name = elem.nodeName.toLowerCase();
-			return (name === "input" || name === "button") && "submit" === elem.type;
-		},
-
-		image: function( elem ) {
-			return elem.nodeName.toLowerCase() === "input" && "image" === elem.type;
-		},
-
-		reset: function( elem ) {
-			var name = elem.nodeName.toLowerCase();
-			return (name === "input" || name === "button") && "reset" === elem.type;
-		},
-
-		button: function( elem ) {
-			var name = elem.nodeName.toLowerCase();
-			return name === "input" && "button" === elem.type || name === "button";
-		},
-
-		input: function( elem ) {
-			return (/input|select|textarea|button/i).test( elem.nodeName );
-		},
-
-		focus: function( elem ) {
-			return elem === elem.ownerDocument.activeElement;
-		}
-	},
-	setFilters: {
-		first: function( elem, i ) {
-			return i === 0;
-		},
-
-		last: function( elem, i, match, array ) {
-			return i === array.length - 1;
-		},
-
-		even: function( elem, i ) {
-			return i % 2 === 0;
-		},
-
-		odd: function( elem, i ) {
-			return i % 2 === 1;
-		},
-
-		lt: function( elem, i, match ) {
-			return i < match[3] - 0;
-		},
-
-		gt: function( elem, i, match ) {
-			return i > match[3] - 0;
-		},
-
-		nth: function( elem, i, match ) {
-			return match[3] - 0 === i;
-		},
-
-		eq: function( elem, i, match ) {
-			return match[3] - 0 === i;
-		}
-	},
-	filter: {
-		PSEUDO: function( elem, match, i, array ) {
-			var name = match[1],
-				filter = Expr.filters[ name ];
-
-			if ( filter ) {
-				return filter( elem, i, match, array );
-
-			} else if ( name === "contains" ) {
-				return (elem.textContent || elem.innerText || getText([ elem ]) || "").indexOf(match[3]) >= 0;
-
-			} else if ( name === "not" ) {
-				var not = match[3];
-
-				for ( var j = 0, l = not.length; j < l; j++ ) {
-					if ( not[j] === elem ) {
-						return false;
-					}
-				}
-
-				return true;
-
-			} else {
-				Sizzle.error( name );
-			}
-		},
-
-		CHILD: function( elem, match ) {
-			var first, last,
-				doneName, parent, cache,
-				count, diff,
-				type = match[1],
-				node = elem;
-
-			switch ( type ) {
-				case "only":
-				case "first":
-					while ( (node = node.previousSibling) ) {
-						if ( node.nodeType === 1 ) {
-							return false;
-						}
-					}
-
-					if ( type === "first" ) {
-						return true;
-					}
-
-					node = elem;
-
-					/* falls through */
-				case "last":
-					while ( (node = node.nextSibling) ) {
-						if ( node.nodeType === 1 ) {
-							return false;
-						}
-					}
-
-					return true;
-
-				case "nth":
-					first = match[2];
-					last = match[3];
-
-					if ( first === 1 && last === 0 ) {
-						return true;
-					}
-
-					doneName = match[0];
-					parent = elem.parentNode;
-
-					if ( parent && (parent[ expando ] !== doneName || !elem.nodeIndex) ) {
-						count = 0;
-
-						for ( node = parent.firstChild; node; node = node.nextSibling ) {
-							if ( node.nodeType === 1 ) {
-								node.nodeIndex = ++count;
-							}
-						}
-
-						parent[ expando ] = doneName;
-					}
-
-					diff = elem.nodeIndex - last;
-
-					if ( first === 0 ) {
-						return diff === 0;
-
-					} else {
-						return ( diff % first === 0 && diff / first >= 0 );
-					}
-			}
-		},
-
-		ID: function( elem, match ) {
-			return elem.nodeType === 1 && elem.getAttribute("id") === match;
-		},
-
-		TAG: function( elem, match ) {
-			return (match === "*" && elem.nodeType === 1) || !!elem.nodeName && elem.nodeName.toLowerCase() === match;
-		},
-
-		CLASS: function( elem, match ) {
-			return (" " + (elem.className || elem.getAttribute("class")) + " ")
-				.indexOf( match ) > -1;
-		},
-
-		ATTR: function( elem, match ) {
-			var name = match[1],
-				result = Sizzle.attr ?
-					Sizzle.attr( elem, name ) :
-					Expr.attrHandle[ name ] ?
-					Expr.attrHandle[ name ]( elem ) :
-					elem[ name ] != null ?
-						elem[ name ] :
-						elem.getAttribute( name ),
-				value = result + "",
-				type = match[2],
-				check = match[4];
-
-			return result == null ?
-				type === "!=" :
-				!type && Sizzle.attr ?
-				result != null :
-				type === "=" ?
-				value === check :
-				type === "*=" ?
-				value.indexOf(check) >= 0 :
-				type === "~=" ?
-				(" " + value + " ").indexOf(check) >= 0 :
-				!check ?
-				value && result !== false :
-				type === "!=" ?
-				value !== check :
-				type === "^=" ?
-				value.indexOf(check) === 0 :
-				type === "$=" ?
-				value.substr(value.length - check.length) === check :
-				type === "|=" ?
-				value === check || value.substr(0, check.length + 1) === check + "-" :
-				false;
-		},
-
-		POS: function( elem, match, i, array ) {
-			var name = match[2],
-				filter = Expr.setFilters[ name ];
-
-			if ( filter ) {
-				return filter( elem, i, match, array );
-			}
-		}
-	}
-};
-
-var origPOS = Expr.match.POS,
-	fescape = function(all, num){
-		return "\\" + (num - 0 + 1);
-	};
-
-for ( var type in Expr.match ) {
-	Expr.match[ type ] = new RegExp( Expr.match[ type ].source + (/(?![^\[]*\])(?![^\(]*\))/.source) );
-	Expr.leftMatch[ type ] = new RegExp( /(^(?:.|\r|\n)*?)/.source + Expr.match[ type ].source.replace(/\\(\d+)/g, fescape) );
-}
-// Expose origPOS
-// "global" as in regardless of relation to brackets/parens
-Expr.match.globalPOS = origPOS;
-
-var makeArray = function( array, results ) {
-	array = Array.prototype.slice.call( array, 0 );
-
-	if ( results ) {
-		results.push.apply( results, array );
-		return results;
-	}
-
-	return array;
-};
-
-// Perform a simple check to determine if the browser is capable of
-// converting a NodeList to an array using builtin methods.
-// Also verifies that the returned array holds DOM nodes
-// (which is not the case in the Blackberry browser)
-try {
-	Array.prototype.slice.call( document.documentElement.childNodes, 0 )[0].nodeType;
-
-// Provide a fallback method if it does not work
-} catch( e ) {
-	makeArray = function( array, results ) {
-		var i = 0,
-			ret = results || [];
-
-		if ( toString.call(array) === "[object Array]" ) {
-			Array.prototype.push.apply( ret, array );
-
-		} else {
-			if ( typeof array.length === "number" ) {
-				for ( var l = array.length; i < l; i++ ) {
-					ret.push( array[i] );
-				}
-
-			} else {
-				for ( ; array[i]; i++ ) {
-					ret.push( array[i] );
-				}
-			}
-		}
-
-		return ret;
-	};
-}
-
-var sortOrder, siblingCheck;
-
-if ( document.documentElement.compareDocumentPosition ) {
-	sortOrder = function( a, b ) {
-		if ( a === b ) {
-			hasDuplicate = true;
-			return 0;
-		}
-
-		if ( !a.compareDocumentPosition || !b.compareDocumentPosition ) {
-			return a.compareDocumentPosition ? -1 : 1;
-		}
-
-		return a.compareDocumentPosition(b) & 4 ? -1 : 1;
-	};
-
-} else {
-	sortOrder = function( a, b ) {
-		// The nodes are identical, we can exit early
-		if ( a === b ) {
-			hasDuplicate = true;
-			return 0;
-
-		// Fallback to using sourceIndex (in IE) if it's available on both nodes
-		} else if ( a.sourceIndex && b.sourceIndex ) {
-			return a.sourceIndex - b.sourceIndex;
-		}
-
-		var al, bl,
-			ap = [],
-			bp = [],
-			aup = a.parentNode,
-			bup = b.parentNode,
-			cur = aup;
-
-		// If the nodes are siblings (or identical) we can do a quick check
-		if ( aup === bup ) {
-			return siblingCheck( a, b );
-
-		// If no parents were found then the nodes are disconnected
-		} else if ( !aup ) {
-			return -1;
-
-		} else if ( !bup ) {
-			return 1;
-		}
-
-		// Otherwise they're somewhere else in the tree so we need
-		// to build up a full list of the parentNodes for comparison
-		while ( cur ) {
-			ap.unshift( cur );
-			cur = cur.parentNode;
-		}
-
-		cur = bup;
-
-		while ( cur ) {
-			bp.unshift( cur );
-			cur = cur.parentNode;
-		}
-
-		al = ap.length;
-		bl = bp.length;
-
-		// Start walking down the tree looking for a discrepancy
-		for ( var i = 0; i < al && i < bl; i++ ) {
-			if ( ap[i] !== bp[i] ) {
-				return siblingCheck( ap[i], bp[i] );
-			}
-		}
-
-		// We ended someplace up the tree so do a sibling check
-		return i === al ?
-			siblingCheck( a, bp[i], -1 ) :
-			siblingCheck( ap[i], b, 1 );
-	};
-
-	siblingCheck = function( a, b, ret ) {
-		if ( a === b ) {
-			return ret;
-		}
-
-		var cur = a.nextSibling;
-
-		while ( cur ) {
-			if ( cur === b ) {
-				return -1;
-			}
-
-			cur = cur.nextSibling;
-		}
-
-		return 1;
-	};
-}
-
-// Check to see if the browser returns elements by name when
-// querying by getElementById (and provide a workaround)
-(function(){
-	// We're going to inject a fake input element with a specified name
-	var form = document.createElement("div"),
-		id = "script" + (new Date()).getTime(),
-		root = document.documentElement;
-
-	form.innerHTML = "<a name='" + id + "'/>";
-
-	// Inject it into the root element, check its status, and remove it quickly
-	root.insertBefore( form, root.firstChild );
-
-	// The workaround has to do additional checks after a getElementById
-	// Which slows things down for other browsers (hence the branching)
-	if ( document.getElementById( id ) ) {
-		Expr.find.ID = function( match, context, isXML ) {
-			if ( typeof context.getElementById !== "undefined" && !isXML ) {
-				var m = context.getElementById(match[1]);
-
-				return m ?
-					m.id === match[1] || typeof m.getAttributeNode !== "undefined" && m.getAttributeNode("id").nodeValue === match[1] ?
-						[m] :
-						undefined :
-					[];
-			}
-		};
-
-		Expr.filter.ID = function( elem, match ) {
-			var node = typeof elem.getAttributeNode !== "undefined" && elem.getAttributeNode("id");
-
-			return elem.nodeType === 1 && node && node.nodeValue === match;
-		};
-	}
-
-	root.removeChild( form );
-
-	// release memory in IE
-	root = form = null;
-})();
-
-(function(){
-	// Check to see if the browser returns only elements
-	// when doing getElementsByTagName("*")
-
-	// Create a fake element
-	var div = document.createElement("div");
-	div.appendChild( document.createComment("") );
-
-	// Make sure no comments are found
-	if ( div.getElementsByTagName("*").length > 0 ) {
-		Expr.find.TAG = function( match, context ) {
-			var results = context.getElementsByTagName( match[1] );
-
-			// Filter out possible comments
-			if ( match[1] === "*" ) {
-				var tmp = [];
-
-				for ( var i = 0; results[i]; i++ ) {
-					if ( results[i].nodeType === 1 ) {
-						tmp.push( results[i] );
-					}
-				}
-
-				results = tmp;
-			}
-
-			return results;
-		};
-	}
-
-	// Check to see if an attribute returns normalized href attributes
-	div.innerHTML = "<a href='#'></a>";
-
-	if ( div.firstChild && typeof div.firstChild.getAttribute !== "undefined" &&
-			div.firstChild.getAttribute("href") !== "#" ) {
-
-		Expr.attrHandle.href = function( elem ) {
-			return elem.getAttribute( "href", 2 );
-		};
-	}
-
-	// release memory in IE
-	div = null;
-})();
-
-if ( document.querySelectorAll ) {
-	(function(){
-		var oldSizzle = Sizzle,
-			div = document.createElement("div"),
-			id = "__sizzle__";
-
-		div.innerHTML = "<p class='TEST'></p>";
-
-		// Safari can't handle uppercase or unicode characters when
-		// in quirks mode.
-		if ( div.querySelectorAll && div.querySelectorAll(".TEST").length === 0 ) {
-			return;
-		}
-
-		Sizzle = function( query, context, extra, seed ) {
-			context = context || document;
-
-			// Only use querySelectorAll on non-XML documents
-			// (ID selectors don't work in non-HTML documents)
-			if ( !seed && !Sizzle.isXML(context) ) {
-				// See if we find a selector to speed up
-				var match = /^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec( query );
-
-				if ( match && (context.nodeType === 1 || context.nodeType === 9) ) {
-					// Speed-up: Sizzle("TAG")
-					if ( match[1] ) {
-						return makeArray( context.getElementsByTagName( query ), extra );
-
-					// Speed-up: Sizzle(".CLASS")
-					} else if ( match[2] && Expr.find.CLASS && context.getElementsByClassName ) {
-						return makeArray( context.getElementsByClassName( match[2] ), extra );
-					}
-				}
-
-				if ( context.nodeType === 9 ) {
-					// Speed-up: Sizzle("body")
-					// The body element only exists once, optimize finding it
-					if ( query === "body" && context.body ) {
-						return makeArray( [ context.body ], extra );
-
-					// Speed-up: Sizzle("#ID")
-					} else if ( match && match[3] ) {
-						var elem = context.getElementById( match[3] );
-
-						// Check parentNode to catch when Blackberry 4.6 returns
-						// nodes that are no longer in the document #6963
-						if ( elem && elem.parentNode ) {
-							// Handle the case where IE and Opera return items
-							// by name instead of ID
-							if ( elem.id === match[3] ) {
-								return makeArray( [ elem ], extra );
-							}
-
-						} else {
-							return makeArray( [], extra );
-						}
-					}
-
-					try {
-						return makeArray( context.querySelectorAll(query), extra );
-					} catch(qsaError) {}
-
-				// qSA works strangely on Element-rooted queries
-				// We can work around this by specifying an extra ID on the root
-				// and working up from there (Thanks to Andrew Dupont for the technique)
-				// IE 8 doesn't work on object elements
-				} else if ( context.nodeType === 1 && context.nodeName.toLowerCase() !== "object" ) {
-					var oldContext = context,
-						old = context.getAttribute( "id" ),
-						nid = old || id,
-						hasParent = context.parentNode,
-						relativeHierarchySelector = /^\s*[+~]/.test( query );
-
-					if ( !old ) {
-						context.setAttribute( "id", nid );
-					} else {
-						nid = nid.replace( /'/g, "\\$&" );
-					}
-					if ( relativeHierarchySelector && hasParent ) {
-						context = context.parentNode;
-					}
-
-					try {
-						if ( !relativeHierarchySelector || hasParent ) {
-							return makeArray( context.querySelectorAll( "[id='" + nid + "'] " + query ), extra );
-						}
-
-					} catch(pseudoError) {
-					} finally {
-						if ( !old ) {
-							oldContext.removeAttribute( "id" );
-						}
-					}
-				}
-			}
-
-			return oldSizzle(query, context, extra, seed);
-		};
-
-		for ( var prop in oldSizzle ) {
-			Sizzle[ prop ] = oldSizzle[ prop ];
-		}
-
-		// release memory in IE
-		div = null;
-	})();
-}
-
-(function(){
-	var html = document.documentElement,
-		matches = html.matchesSelector || html.mozMatchesSelector || html.webkitMatchesSelector || html.msMatchesSelector;
-
-	if ( matches ) {
-		// Check to see if it's possible to do matchesSelector
-		// on a disconnected node (IE 9 fails this)
-		var disconnectedMatch = !matches.call( document.createElement( "div" ), "div" ),
-			pseudoWorks = false;
-
-		try {
-			// This should fail with an exception
-			// Gecko does not error, returns false instead
-			matches.call( document.documentElement, "[test!='']:sizzle" );
-
-		} catch( pseudoError ) {
-			pseudoWorks = true;
-		}
-
-		Sizzle.matchesSelector = function( node, expr ) {
-			// Make sure that attribute selectors are quoted
-			expr = expr.replace(/\=\s*([^'"\]]*)\s*\]/g, "='$1']");
-
-			if ( !Sizzle.isXML( node ) ) {
-				try {
-					if ( pseudoWorks || !Expr.match.PSEUDO.test( expr ) && !/!=/.test( expr ) ) {
-						var ret = matches.call( node, expr );
-
-						// IE 9's matchesSelector returns false on disconnected nodes
-						if ( ret || !disconnectedMatch ||
-								// As well, disconnected nodes are said to be in a document
-								// fragment in IE 9, so check for that
-								node.document && node.document.nodeType !== 11 ) {
-							return ret;
-						}
-					}
-				} catch(e) {}
-			}
-
-			return Sizzle(expr, null, null, [node]).length > 0;
-		};
-	}
-})();
-
-(function(){
-	var div = document.createElement("div");
-
-	div.innerHTML = "<div class='test e'></div><div class='test'></div>";
-
-	// Opera can't find a second classname (in 9.6)
-	// Also, make sure that getElementsByClassName actually exists
-	if ( !div.getElementsByClassName || div.getElementsByClassName("e").length === 0 ) {
-		return;
-	}
-
-	// Safari caches class attributes, doesn't catch changes (in 3.2)
-	div.lastChild.className = "e";
-
-	if ( div.getElementsByClassName("e").length === 1 ) {
-		return;
-	}
-
-	Expr.order.splice(1, 0, "CLASS");
-	Expr.find.CLASS = function( match, context, isXML ) {
-		if ( typeof context.getElementsByClassName !== "undefined" && !isXML ) {
-			return context.getElementsByClassName(match[1]);
-		}
-	};
-
-	// release memory in IE
-	div = null;
-})();
-
-function dirNodeCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {
-	for ( var i = 0, l = checkSet.length; i < l; i++ ) {
-		var elem = checkSet[i];
-
-		if ( elem ) {
-			var match = false;
-
-			elem = elem[dir];
-
-			while ( elem ) {
-				if ( elem[ expando ] === doneName ) {
-					match = checkSet[elem.sizset];
-					break;
-				}
-
-				if ( elem.nodeType === 1 && !isXML ){
-					elem[ expando ] = doneName;
-					elem.sizset = i;
-				}
-
-				if ( elem.nodeName.toLowerCase() === cur ) {
-					match = elem;
-					break;
-				}
-
-				elem = elem[dir];
-			}
-
-			checkSet[i] = match;
-		}
-	}
-}
-
-function dirCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {
-	for ( var i = 0, l = checkSet.length; i < l; i++ ) {
-		var elem = checkSet[i];
-
-		if ( elem ) {
-			var match = false;
-
-			elem = elem[dir];
-
-			while ( elem ) {
-				if ( elem[ expando ] === doneName ) {
-					match = checkSet[elem.sizset];
-					break;
-				}
-
-				if ( elem.nodeType === 1 ) {
-					if ( !isXML ) {
-						elem[ expando ] = doneName;
-						elem.sizset = i;
-					}
-
-					if ( typeof cur !== "string" ) {
-						if ( elem === cur ) {
-							match = true;
-							break;
-						}
-
-					} else if ( Sizzle.filter( cur, [elem] ).length > 0 ) {
-						match = elem;
-						break;
-					}
-				}
-
-				elem = elem[dir];
-			}
-
-			checkSet[i] = match;
-		}
-	}
-}
-
-if ( document.documentElement.contains ) {
-	Sizzle.contains = function( a, b ) {
-		return a !== b && (a.contains ? a.contains(b) : true);
-	};
-
-} else if ( document.documentElement.compareDocumentPosition ) {
-	Sizzle.contains = function( a, b ) {
-		return !!(a.compareDocumentPosition(b) & 16);
-	};
-
-} else {
-	Sizzle.contains = function() {
-		return false;
-	};
-}
-
-Sizzle.isXML = function( elem ) {
-	// documentElement is verified for cases where it doesn't yet exist
-	// (such as loading iframes in IE - #4833)
-	var documentElement = (elem ? elem.ownerDocument || elem : 0).documentElement;
-
-	return documentElement ? documentElement.nodeName !== "HTML" : false;
-};
-
-var posProcess = function( selector, context, seed ) {
-	var match,
-		tmpSet = [],
-		later = "",
-		root = context.nodeType ? [context] : context;
-
-	// Position selectors must be done after the filter
-	// And so must :not(positional) so we move all PSEUDOs to the end
-	while ( (match = Expr.match.PSEUDO.exec( selector )) ) {
-		later += match[0];
-		selector = selector.replace( Expr.match.PSEUDO, "" );
-	}
-
-	selector = Expr.relative[selector] ? selector + "*" : selector;
-
-	for ( var i = 0, l = root.length; i < l; i++ ) {
-		Sizzle( selector, root[i], tmpSet, seed );
-	}
-
-	return Sizzle.filter( later, tmpSet );
-};
-
-// EXPOSE
-
-window.Sizzle = Sizzle;
-
+/*!
+ * Sizzle CSS Selector Engine
+ *  Copyright 2011, The Dojo Foundation
+ *  Released under the MIT, BSD, and GPL Licenses.
+ *  More information: http://sizzlejs.com/
+ */
+(function(){
+
+var chunker = /((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,
+	expando = "sizcache" + (Math.random() + '').replace('.', ''),
+	done = 0,
+	toString = Object.prototype.toString,
+	hasDuplicate = false,
+	baseHasDuplicate = true,
+	rBackslash = /\\/g,
+	rReturn = /\r\n/g,
+	rNonWord = /\W/;
+
+// Here we check if the JavaScript engine is using some sort of
+// optimization where it does not always call our comparision
+// function. If that is the case, discard the hasDuplicate value.
+//   Thus far that includes Google Chrome.
+[0, 0].sort(function() {
+	baseHasDuplicate = false;
+	return 0;
+});
+
+var Sizzle = function( selector, context, results, seed ) {
+	results = results || [];
+	context = context || document;
+
+	var origContext = context;
+
+	if ( context.nodeType !== 1 && context.nodeType !== 9 ) {
+		return [];
+	}
+
+	if ( !selector || typeof selector !== "string" ) {
+		return results;
+	}
+
+	var m, set, checkSet, extra, ret, cur, pop, i,
+		prune = true,
+		contextXML = Sizzle.isXML( context ),
+		parts = [],
+		soFar = selector;
+
+	// Reset the position of the chunker regexp (start from head)
+	do {
+		chunker.exec( "" );
+		m = chunker.exec( soFar );
+
+		if ( m ) {
+			soFar = m[3];
+
+			parts.push( m[1] );
+
+			if ( m[2] ) {
+				extra = m[3];
+				break;
+			}
+		}
+	} while ( m );
+
+	if ( parts.length > 1 && origPOS.exec( selector ) ) {
+
+		if ( parts.length === 2 && Expr.relative[ parts[0] ] ) {
+			set = posProcess( parts[0] + parts[1], context, seed );
+
+		} else {
+			set = Expr.relative[ parts[0] ] ?
+				[ context ] :
+				Sizzle( parts.shift(), context );
+
+			while ( parts.length ) {
+				selector = parts.shift();
+
+				if ( Expr.relative[ selector ] ) {
+					selector += parts.shift();
+				}
+
+				set = posProcess( selector, set, seed );
+			}
+		}
+
+	} else {
+		// Take a shortcut and set the context if the root selector is an ID
+		// (but not if it'll be faster if the inner selector is an ID)
+		if ( !seed && parts.length > 1 && context.nodeType === 9 && !contextXML &&
+				Expr.match.ID.test(parts[0]) && !Expr.match.ID.test(parts[parts.length - 1]) ) {
+
+			ret = Sizzle.find( parts.shift(), context, contextXML );
+			context = ret.expr ?
+				Sizzle.filter( ret.expr, ret.set )[0] :
+				ret.set[0];
+		}
+
+		if ( context ) {
+			ret = seed ?
+				{ expr: parts.pop(), set: makeArray(seed) } :
+				Sizzle.find( parts.pop(), parts.length === 1 && (parts[0] === "~" || parts[0] === "+") && context.parentNode ? context.parentNode : context, contextXML );
+
+			set = ret.expr ?
+				Sizzle.filter( ret.expr, ret.set ) :
+				ret.set;
+
+			if ( parts.length > 0 ) {
+				checkSet = makeArray( set );
+
+			} else {
+				prune = false;
+			}
+
+			while ( parts.length ) {
+				cur = parts.pop();
+				pop = cur;
+
+				if ( !Expr.relative[ cur ] ) {
+					cur = "";
+				} else {
+					pop = parts.pop();
+				}
+
+				if ( pop == null ) {
+					pop = context;
+				}
+
+				Expr.relative[ cur ]( checkSet, pop, contextXML );
+			}
+
+		} else {
+			checkSet = parts = [];
+		}
+	}
+
+	if ( !checkSet ) {
+		checkSet = set;
+	}
+
+	if ( !checkSet ) {
+		Sizzle.error( cur || selector );
+	}
+
+	if ( toString.call(checkSet) === "[object Array]" ) {
+		if ( !prune ) {
+			results.push.apply( results, checkSet );
+
+		} else if ( context && context.nodeType === 1 ) {
+			for ( i = 0; checkSet[i] != null; i++ ) {
+				if ( checkSet[i] && (checkSet[i] === true || checkSet[i].nodeType === 1 && Sizzle.contains(context, checkSet[i])) ) {
+					results.push( set[i] );
+				}
+			}
+
+		} else {
+			for ( i = 0; checkSet[i] != null; i++ ) {
+				if ( checkSet[i] && checkSet[i].nodeType === 1 ) {
+					results.push( set[i] );
+				}
+			}
+		}
+
+	} else {
+		makeArray( checkSet, results );
+	}
+
+	if ( extra ) {
+		Sizzle( extra, origContext, results, seed );
+		Sizzle.uniqueSort( results );
+	}
+
+	return results;
+};
+
+Sizzle.uniqueSort = function( results ) {
+	if ( sortOrder ) {
+		hasDuplicate = baseHasDuplicate;
+		results.sort( sortOrder );
+
+		if ( hasDuplicate ) {
+			for ( var i = 1; i < results.length; i++ ) {
+				if ( results[i] === results[ i - 1 ] ) {
+					results.splice( i--, 1 );
+				}
+			}
+		}
+	}
+
+	return results;
+};
+
+Sizzle.matches = function( expr, set ) {
+	return Sizzle( expr, null, null, set );
+};
+
+Sizzle.matchesSelector = function( node, expr ) {
+	return Sizzle( expr, null, null, [node] ).length > 0;
+};
+
+Sizzle.find = function( expr, context, isXML ) {
+	var set, i, len, match, type, left;
+
+	if ( !expr ) {
+		return [];
+	}
+
+	for ( i = 0, len = Expr.order.length; i < len; i++ ) {
+		type = Expr.order[i];
+
+		if ( (match = Expr.leftMatch[ type ].exec( expr )) ) {
+			left = match[1];
+			match.splice( 1, 1 );
+
+			if ( left.substr( left.length - 1 ) !== "\\" ) {
+				match[1] = (match[1] || "").replace( rBackslash, "" );
+				set = Expr.find[ type ]( match, context, isXML );
+
+				if ( set != null ) {
+					expr = expr.replace( Expr.match[ type ], "" );
+					break;
+				}
+			}
+		}
+	}
+
+	if ( !set ) {
+		set = typeof context.getElementsByTagName !== "undefined" ?
+			context.getElementsByTagName( "*" ) :
+			[];
+	}
+
+	return { set: set, expr: expr };
+};
+
+Sizzle.filter = function( expr, set, inplace, not ) {
+	var match, anyFound,
+		type, found, item, filter, left,
+		i, pass,
+		old = expr,
+		result = [],
+		curLoop = set,
+		isXMLFilter = set && set[0] && Sizzle.isXML( set[0] );
+
+	while ( expr && set.length ) {
+		for ( type in Expr.filter ) {
+			if ( (match = Expr.leftMatch[ type ].exec( expr )) != null && match[2] ) {
+				filter = Expr.filter[ type ];
+				left = match[1];
+
+				anyFound = false;
+
+				match.splice(1,1);
+
+				if ( left.substr( left.length - 1 ) === "\\" ) {
+					continue;
+				}
+
+				if ( curLoop === result ) {
+					result = [];
+				}
+
+				if ( Expr.preFilter[ type ] ) {
+					match = Expr.preFilter[ type ]( match, curLoop, inplace, result, not, isXMLFilter );
+
+					if ( !match ) {
+						anyFound = found = true;
+
+					} else if ( match === true ) {
+						continue;
+					}
+				}
+
+				if ( match ) {
+					for ( i = 0; (item = curLoop[i]) != null; i++ ) {
+						if ( item ) {
+							found = filter( item, match, i, curLoop );
+							pass = not ^ found;
+
+							if ( inplace && found != null ) {
+								if ( pass ) {
+									anyFound = true;
+
+								} else {
+									curLoop[i] = false;
+								}
+
+							} else if ( pass ) {
+								result.push( item );
+								anyFound = true;
+							}
+						}
+					}
+				}
+
+				if ( found !== undefined ) {
+					if ( !inplace ) {
+						curLoop = result;
+					}
+
+					expr = expr.replace( Expr.match[ type ], "" );
+
+					if ( !anyFound ) {
+						return [];
+					}
+
+					break;
+				}
+			}
+		}
+
+		// Improper expression
+		if ( expr === old ) {
+			if ( anyFound == null ) {
+				Sizzle.error( expr );
+
+			} else {
+				break;
+			}
+		}
+
+		old = expr;
+	}
+
+	return curLoop;
+};
+
+Sizzle.error = function( msg ) {
+	throw new Error( "Syntax error, unrecognized expression: " + msg );
+};
+
+/**
+ * Utility function for retreiving the text value of an array of DOM nodes
+ * @param {Array|Element} elem
+ */
+var getText = Sizzle.getText = function( elem ) {
+    var i, node,
+		nodeType = elem.nodeType,
+		ret = "";
+
+	if ( nodeType ) {
+		if ( nodeType === 1 || nodeType === 9 || nodeType === 11 ) {
+			// Use textContent || innerText for elements
+			if ( typeof elem.textContent === 'string' ) {
+				return elem.textContent;
+			} else if ( typeof elem.innerText === 'string' ) {
+				// Replace IE's carriage returns
+				return elem.innerText.replace( rReturn, '' );
+			} else {
+				// Traverse it's children
+				for ( elem = elem.firstChild; elem; elem = elem.nextSibling) {
+					ret += getText( elem );
+				}
+			}
+		} else if ( nodeType === 3 || nodeType === 4 ) {
+			return elem.nodeValue;
+		}
+	} else {
+
+		// If no nodeType, this is expected to be an array
+		for ( i = 0; (node = elem[i]); i++ ) {
+			// Do not traverse comment nodes
+			if ( node.nodeType !== 8 ) {
+				ret += getText( node );
+			}
+		}
+	}
+	return ret;
+};
+
+var Expr = Sizzle.selectors = {
+	order: [ "ID", "NAME", "TAG" ],
+
+	match: {
+		ID: /#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,
+		CLASS: /\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,
+		NAME: /\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,
+		ATTR: /\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,
+		TAG: /^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,
+		CHILD: /:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,
+		POS: /:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,
+		PSEUDO: /:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/
+	},
+
+	leftMatch: {},
+
+	attrMap: {
+		"class": "className",
+		"for": "htmlFor"
+	},
+
+	attrHandle: {
+		href: function( elem ) {
+			return elem.getAttribute( "href" );
+		},
+		type: function( elem ) {
+			return elem.getAttribute( "type" );
+		}
+	},
+
+	relative: {
+		"+": function(checkSet, part){
+			var isPartStr = typeof part === "string",
+				isTag = isPartStr && !rNonWord.test( part ),
+				isPartStrNotTag = isPartStr && !isTag;
+
+			if ( isTag ) {
+				part = part.toLowerCase();
+			}
+
+			for ( var i = 0, l = checkSet.length, elem; i < l; i++ ) {
+				if ( (elem = checkSet[i]) ) {
+					while ( (elem = elem.previousSibling) && elem.nodeType !== 1 ) {}
+
+					checkSet[i] = isPartStrNotTag || elem && elem.nodeName.toLowerCase() === part ?
+						elem || false :
+						elem === part;
+				}
+			}
+
+			if ( isPartStrNotTag ) {
+				Sizzle.filter( part, checkSet, true );
+			}
+		},
+
+		">": function( checkSet, part ) {
+			var elem,
+				isPartStr = typeof part === "string",
+				i = 0,
+				l = checkSet.length;
+
+			if ( isPartStr && !rNonWord.test( part ) ) {
+				part = part.toLowerCase();
+
+				for ( ; i < l; i++ ) {
+					elem = checkSet[i];
+
+					if ( elem ) {
+						var parent = elem.parentNode;
+						checkSet[i] = parent.nodeName.toLowerCase() === part ? parent : false;
+					}
+				}
+
+			} else {
+				for ( ; i < l; i++ ) {
+					elem = checkSet[i];
+
+					if ( elem ) {
+						checkSet[i] = isPartStr ?
+							elem.parentNode :
+							elem.parentNode === part;
+					}
+				}
+
+				if ( isPartStr ) {
+					Sizzle.filter( part, checkSet, true );
+				}
+			}
+		},
+
+		"": function(checkSet, part, isXML){
+			var nodeCheck,
+				doneName = done++,
+				checkFn = dirCheck;
+
+			if ( typeof part === "string" && !rNonWord.test( part ) ) {
+				part = part.toLowerCase();
+				nodeCheck = part;
+				checkFn = dirNodeCheck;
+			}
+
+			checkFn( "parentNode", part, doneName, checkSet, nodeCheck, isXML );
+		},
+
+		"~": function( checkSet, part, isXML ) {
+			var nodeCheck,
+				doneName = done++,
+				checkFn = dirCheck;
+
+			if ( typeof part === "string" && !rNonWord.test( part ) ) {
+				part = part.toLowerCase();
+				nodeCheck = part;
+				checkFn = dirNodeCheck;
+			}
+
+			checkFn( "previousSibling", part, doneName, checkSet, nodeCheck, isXML );
+		}
+	},
+
+	find: {
+		ID: function( match, context, isXML ) {
+			if ( typeof context.getElementById !== "undefined" && !isXML ) {
+				var m = context.getElementById(match[1]);
+				// Check parentNode to catch when Blackberry 4.6 returns
+				// nodes that are no longer in the document #6963
+				return m && m.parentNode ? [m] : [];
+			}
+		},
+
+		NAME: function( match, context ) {
+			if ( typeof context.getElementsByName !== "undefined" ) {
+				var ret = [],
+					results = context.getElementsByName( match[1] );
+
+				for ( var i = 0, l = results.length; i < l; i++ ) {
+					if ( results[i].getAttribute("name") === match[1] ) {
+						ret.push( results[i] );
+					}
+				}
+
+				return ret.length === 0 ? null : ret;
+			}
+		},
+
+		TAG: function( match, context ) {
+			if ( typeof context.getElementsByTagName !== "undefined" ) {
+				return context.getElementsByTagName( match[1] );
+			}
+		}
+	},
+	preFilter: {
+		CLASS: function( match, curLoop, inplace, result, not, isXML ) {
+			match = " " + match[1].replace( rBackslash, "" ) + " ";
+
+			if ( isXML ) {
+				return match;
+			}
+
+			for ( var i = 0, elem; (elem = curLoop[i]) != null; i++ ) {
+				if ( elem ) {
+					if ( not ^ (elem.className && (" " + elem.className + " ").replace(/[\t\n\r]/g, " ").indexOf(match) >= 0) ) {
+						if ( !inplace ) {
+							result.push( elem );
+						}
+
+					} else if ( inplace ) {
+						curLoop[i] = false;
+					}
+				}
+			}
+
+			return false;
+		},
+
+		ID: function( match ) {
+			return match[1].replace( rBackslash, "" );
+		},
+
+		TAG: function( match, curLoop ) {
+			return match[1].replace( rBackslash, "" ).toLowerCase();
+		},
+
+		CHILD: function( match ) {
+			if ( match[1] === "nth" ) {
+				if ( !match[2] ) {
+					Sizzle.error( match[0] );
+				}
+
+				match[2] = match[2].replace(/^\+|\s*/g, '');
+
+				// parse equations like 'even', 'odd', '5', '2n', '3n+2', '4n-1', '-n+6'
+				var test = /(-?)(\d*)(?:n([+\-]?\d*))?/.exec(
+					match[2] === "even" && "2n" || match[2] === "odd" && "2n+1" ||
+					!/\D/.test( match[2] ) && "0n+" + match[2] || match[2]);
+
+				// calculate the numbers (first)n+(last) including if they are negative
+				match[2] = (test[1] + (test[2] || 1)) - 0;
+				match[3] = test[3] - 0;
+			}
+			else if ( match[2] ) {
+				Sizzle.error( match[0] );
+			}
+
+			// TODO: Move to normal caching system
+			match[0] = done++;
+
+			return match;
+		},
+
+		ATTR: function( match, curLoop, inplace, result, not, isXML ) {
+			var name = match[1] = match[1].replace( rBackslash, "" );
+
+			if ( !isXML && Expr.attrMap[name] ) {
+				match[1] = Expr.attrMap[name];
+			}
+
+			// Handle if an un-quoted value was used
+			match[4] = ( match[4] || match[5] || "" ).replace( rBackslash, "" );
+
+			if ( match[2] === "~=" ) {
+				match[4] = " " + match[4] + " ";
+			}
+
+			return match;
+		},
+
+		PSEUDO: function( match, curLoop, inplace, result, not ) {
+			if ( match[1] === "not" ) {
+				// If we're dealing with a complex expression, or a simple one
+				if ( ( chunker.exec(match[3]) || "" ).length > 1 || /^\w/.test(match[3]) ) {
+					match[3] = Sizzle(match[3], null, null, curLoop);
+
+				} else {
+					var ret = Sizzle.filter(match[3], curLoop, inplace, true ^ not);
+
+					if ( !inplace ) {
+						result.push.apply( result, ret );
+					}
+
+					return false;
+				}
+
+			} else if ( Expr.match.POS.test( match[0] ) || Expr.match.CHILD.test( match[0] ) ) {
+				return true;
+			}
+
+			return match;
+		},
+
+		POS: function( match ) {
+			match.unshift( true );
+
+			return match;
+		}
+	},
+
+	filters: {
+		enabled: function( elem ) {
+			return elem.disabled === false && elem.type !== "hidden";
+		},
+
+		disabled: function( elem ) {
+			return elem.disabled === true;
+		},
+
+		checked: function( elem ) {
+			return elem.checked === true;
+		},
+
+		selected: function( elem ) {
+			// Accessing this property makes selected-by-default
+			// options in Safari work properly
+			if ( elem.parentNode ) {
+				elem.parentNode.selectedIndex;
+			}
+
+			return elem.selected === true;
+		},
+
+		parent: function( elem ) {
+			return !!elem.firstChild;
+		},
+
+		empty: function( elem ) {
+			return !elem.firstChild;
+		},
+
+		has: function( elem, i, match ) {
+			return !!Sizzle( match[3], elem ).length;
+		},
+
+		header: function( elem ) {
+			return (/h\d/i).test( elem.nodeName );
+		},
+
+		text: function( elem ) {
+			var attr = elem.getAttribute( "type" ), type = elem.type;
+			// IE6 and 7 will map elem.type to 'text' for new HTML5 types (search, etc)
+			// use getAttribute instead to test this case
+			return elem.nodeName.toLowerCase() === "input" && "text" === type && ( attr === type || attr === null );
+		},
+
+		radio: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "radio" === elem.type;
+		},
+
+		checkbox: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "checkbox" === elem.type;
+		},
+
+		file: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "file" === elem.type;
+		},
+
+		password: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "password" === elem.type;
+		},
+
+		submit: function( elem ) {
+			var name = elem.nodeName.toLowerCase();
+			return (name === "input" || name === "button") && "submit" === elem.type;
+		},
+
+		image: function( elem ) {
+			return elem.nodeName.toLowerCase() === "input" && "image" === elem.type;
+		},
+
+		reset: function( elem ) {
+			var name = elem.nodeName.toLowerCase();
+			return (name === "input" || name === "button") && "reset" === elem.type;
+		},
+
+		button: function( elem ) {
+			var name = elem.nodeName.toLowerCase();
+			return name === "input" && "button" === elem.type || name === "button";
+		},
+
+		input: function( elem ) {
+			return (/input|select|textarea|button/i).test( elem.nodeName );
+		},
+
+		focus: function( elem ) {
+			return elem === elem.ownerDocument.activeElement;
+		}
+	},
+	setFilters: {
+		first: function( elem, i ) {
+			return i === 0;
+		},
+
+		last: function( elem, i, match, array ) {
+			return i === array.length - 1;
+		},
+
+		even: function( elem, i ) {
+			return i % 2 === 0;
+		},
+
+		odd: function( elem, i ) {
+			return i % 2 === 1;
+		},
+
+		lt: function( elem, i, match ) {
+			return i < match[3] - 0;
+		},
+
+		gt: function( elem, i, match ) {
+			return i > match[3] - 0;
+		},
+
+		nth: function( elem, i, match ) {
+			return match[3] - 0 === i;
+		},
+
+		eq: function( elem, i, match ) {
+			return match[3] - 0 === i;
+		}
+	},
+	filter: {
+		PSEUDO: function( elem, match, i, array ) {
+			var name = match[1],
+				filter = Expr.filters[ name ];
+
+			if ( filter ) {
+				return filter( elem, i, match, array );
+
+			} else if ( name === "contains" ) {
+				return (elem.textContent || elem.innerText || getText([ elem ]) || "").indexOf(match[3]) >= 0;
+
+			} else if ( name === "not" ) {
+				var not = match[3];
+
+				for ( var j = 0, l = not.length; j < l; j++ ) {
+					if ( not[j] === elem ) {
+						return false;
+					}
+				}
+
+				return true;
+
+			} else {
+				Sizzle.error( name );
+			}
+		},
+
+		CHILD: function( elem, match ) {
+			var first, last,
+				doneName, parent, cache,
+				count, diff,
+				type = match[1],
+				node = elem;
+
+			switch ( type ) {
+				case "only":
+				case "first":
+					while ( (node = node.previousSibling) ) {
+						if ( node.nodeType === 1 ) {
+							return false;
+						}
+					}
+
+					if ( type === "first" ) {
+						return true;
+					}
+
+					node = elem;
+
+					/* falls through */
+				case "last":
+					while ( (node = node.nextSibling) ) {
+						if ( node.nodeType === 1 ) {
+							return false;
+						}
+					}
+
+					return true;
+
+				case "nth":
+					first = match[2];
+					last = match[3];
+
+					if ( first === 1 && last === 0 ) {
+						return true;
+					}
+
+					doneName = match[0];
+					parent = elem.parentNode;
+
+					if ( parent && (parent[ expando ] !== doneName || !elem.nodeIndex) ) {
+						count = 0;
+
+						for ( node = parent.firstChild; node; node = node.nextSibling ) {
+							if ( node.nodeType === 1 ) {
+								node.nodeIndex = ++count;
+							}
+						}
+
+						parent[ expando ] = doneName;
+					}
+
+					diff = elem.nodeIndex - last;
+
+					if ( first === 0 ) {
+						return diff === 0;
+
+					} else {
+						return ( diff % first === 0 && diff / first >= 0 );
+					}
+			}
+		},
+
+		ID: function( elem, match ) {
+			return elem.nodeType === 1 && elem.getAttribute("id") === match;
+		},
+
+		TAG: function( elem, match ) {
+			return (match === "*" && elem.nodeType === 1) || !!elem.nodeName && elem.nodeName.toLowerCase() === match;
+		},
+
+		CLASS: function( elem, match ) {
+			return (" " + (elem.className || elem.getAttribute("class")) + " ")
+				.indexOf( match ) > -1;
+		},
+
+		ATTR: function( elem, match ) {
+			var name = match[1],
+				result = Sizzle.attr ?
+					Sizzle.attr( elem, name ) :
+					Expr.attrHandle[ name ] ?
+					Expr.attrHandle[ name ]( elem ) :
+					elem[ name ] != null ?
+						elem[ name ] :
+						elem.getAttribute( name ),
+				value = result + "",
+				type = match[2],
+				check = match[4];
+
+			return result == null ?
+				type === "!=" :
+				!type && Sizzle.attr ?
+				result != null :
+				type === "=" ?
+				value === check :
+				type === "*=" ?
+				value.indexOf(check) >= 0 :
+				type === "~=" ?
+				(" " + value + " ").indexOf(check) >= 0 :
+				!check ?
+				value && result !== false :
+				type === "!=" ?
+				value !== check :
+				type === "^=" ?
+				value.indexOf(check) === 0 :
+				type === "$=" ?
+				value.substr(value.length - check.length) === check :
+				type === "|=" ?
+				value === check || value.substr(0, check.length + 1) === check + "-" :
+				false;
+		},
+
+		POS: function( elem, match, i, array ) {
+			var name = match[2],
+				filter = Expr.setFilters[ name ];
+
+			if ( filter ) {
+				return filter( elem, i, match, array );
+			}
+		}
+	}
+};
+
+var origPOS = Expr.match.POS,
+	fescape = function(all, num){
+		return "\\" + (num - 0 + 1);
+	};
+
+for ( var type in Expr.match ) {
+	Expr.match[ type ] = new RegExp( Expr.match[ type ].source + (/(?![^\[]*\])(?![^\(]*\))/.source) );
+	Expr.leftMatch[ type ] = new RegExp( /(^(?:.|\r|\n)*?)/.source + Expr.match[ type ].source.replace(/\\(\d+)/g, fescape) );
+}
+// Expose origPOS
+// "global" as in regardless of relation to brackets/parens
+Expr.match.globalPOS = origPOS;
+
+var makeArray = function( array, results ) {
+	array = Array.prototype.slice.call( array, 0 );
+
+	if ( results ) {
+		results.push.apply( results, array );
+		return results;
+	}
+
+	return array;
+};
+
+// Perform a simple check to determine if the browser is capable of
+// converting a NodeList to an array using builtin methods.
+// Also verifies that the returned array holds DOM nodes
+// (which is not the case in the Blackberry browser)
+try {
+	Array.prototype.slice.call( document.documentElement.childNodes, 0 )[0].nodeType;
+
+// Provide a fallback method if it does not work
+} catch( e ) {
+	makeArray = function( array, results ) {
+		var i = 0,
+			ret = results || [];
+
+		if ( toString.call(array) === "[object Array]" ) {
+			Array.prototype.push.apply( ret, array );
+
+		} else {
+			if ( typeof array.length === "number" ) {
+				for ( var l = array.length; i < l; i++ ) {
+					ret.push( array[i] );
+				}
+
+			} else {
+				for ( ; array[i]; i++ ) {
+					ret.push( array[i] );
+				}
+			}
+		}
+
+		return ret;
+	};
+}
+
+var sortOrder, siblingCheck;
+
+if ( document.documentElement.compareDocumentPosition ) {
+	sortOrder = function( a, b ) {
+		if ( a === b ) {
+			hasDuplicate = true;
+			return 0;
+		}
+
+		if ( !a.compareDocumentPosition || !b.compareDocumentPosition ) {
+			return a.compareDocumentPosition ? -1 : 1;
+		}
+
+		return a.compareDocumentPosition(b) & 4 ? -1 : 1;
+	};
+
+} else {
+	sortOrder = function( a, b ) {
+		// The nodes are identical, we can exit early
+		if ( a === b ) {
+			hasDuplicate = true;
+			return 0;
+
+		// Fallback to using sourceIndex (in IE) if it's available on both nodes
+		} else if ( a.sourceIndex && b.sourceIndex ) {
+			return a.sourceIndex - b.sourceIndex;
+		}
+
+		var al, bl,
+			ap = [],
+			bp = [],
+			aup = a.parentNode,
+			bup = b.parentNode,
+			cur = aup;
+
+		// If the nodes are siblings (or identical) we can do a quick check
+		if ( aup === bup ) {
+			return siblingCheck( a, b );
+
+		// If no parents were found then the nodes are disconnected
+		} else if ( !aup ) {
+			return -1;
+
+		} else if ( !bup ) {
+			return 1;
+		}
+
+		// Otherwise they're somewhere else in the tree so we need
+		// to build up a full list of the parentNodes for comparison
+		while ( cur ) {
+			ap.unshift( cur );
+			cur = cur.parentNode;
+		}
+
+		cur = bup;
+
+		while ( cur ) {
+			bp.unshift( cur );
+			cur = cur.parentNode;
+		}
+
+		al = ap.length;
+		bl = bp.length;
+
+		// Start walking down the tree looking for a discrepancy
+		for ( var i = 0; i < al && i < bl; i++ ) {
+			if ( ap[i] !== bp[i] ) {
+				return siblingCheck( ap[i], bp[i] );
+			}
+		}
+
+		// We ended someplace up the tree so do a sibling check
+		return i === al ?
+			siblingCheck( a, bp[i], -1 ) :
+			siblingCheck( ap[i], b, 1 );
+	};
+
+	siblingCheck = function( a, b, ret ) {
+		if ( a === b ) {
+			return ret;
+		}
+
+		var cur = a.nextSibling;
+
+		while ( cur ) {
+			if ( cur === b ) {
+				return -1;
+			}
+
+			cur = cur.nextSibling;
+		}
+
+		return 1;
+	};
+}
+
+// Check to see if the browser returns elements by name when
+// querying by getElementById (and provide a workaround)
+(function(){
+	// We're going to inject a fake input element with a specified name
+	var form = document.createElement("div"),
+		id = "script" + (new Date()).getTime(),
+		root = document.documentElement;
+
+	form.innerHTML = "<a name='" + id + "'/>";
+
+	// Inject it into the root element, check its status, and remove it quickly
+	root.insertBefore( form, root.firstChild );
+
+	// The workaround has to do additional checks after a getElementById
+	// Which slows things down for other browsers (hence the branching)
+	if ( document.getElementById( id ) ) {
+		Expr.find.ID = function( match, context, isXML ) {
+			if ( typeof context.getElementById !== "undefined" && !isXML ) {
+				var m = context.getElementById(match[1]);
+
+				return m ?
+					m.id === match[1] || typeof m.getAttributeNode !== "undefined" && m.getAttributeNode("id").nodeValue === match[1] ?
+						[m] :
+						undefined :
+					[];
+			}
+		};
+
+		Expr.filter.ID = function( elem, match ) {
+			var node = typeof elem.getAttributeNode !== "undefined" && elem.getAttributeNode("id");
+
+			return elem.nodeType === 1 && node && node.nodeValue === match;
+		};
+	}
+
+	root.removeChild( form );
+
+	// release memory in IE
+	root = form = null;
+})();
+
+(function(){
+	// Check to see if the browser returns only elements
+	// when doing getElementsByTagName("*")
+
+	// Create a fake element
+	var div = document.createElement("div");
+	div.appendChild( document.createComment("") );
+
+	// Make sure no comments are found
+	if ( div.getElementsByTagName("*").length > 0 ) {
+		Expr.find.TAG = function( match, context ) {
+			var results = context.getElementsByTagName( match[1] );
+
+			// Filter out possible comments
+			if ( match[1] === "*" ) {
+				var tmp = [];
+
+				for ( var i = 0; results[i]; i++ ) {
+					if ( results[i].nodeType === 1 ) {
+						tmp.push( results[i] );
+					}
+				}
+
+				results = tmp;
+			}
+
+			return results;
+		};
+	}
+
+	// Check to see if an attribute returns normalized href attributes
+	div.innerHTML = "<a href='#'></a>";
+
+	if ( div.firstChild && typeof div.firstChild.getAttribute !== "undefined" &&
+			div.firstChild.getAttribute("href") !== "#" ) {
+
+		Expr.attrHandle.href = function( elem ) {
+			return elem.getAttribute( "href", 2 );
+		};
+	}
+
+	// release memory in IE
+	div = null;
+})();
+
+if ( document.querySelectorAll ) {
+	(function(){
+		var oldSizzle = Sizzle,
+			div = document.createElement("div"),
+			id = "__sizzle__";
+
+		div.innerHTML = "<p class='TEST'></p>";
+
+		// Safari can't handle uppercase or unicode characters when
+		// in quirks mode.
+		if ( div.querySelectorAll && div.querySelectorAll(".TEST").length === 0 ) {
+			return;
+		}
+
+		Sizzle = function( query, context, extra, seed ) {
+			context = context || document;
+
+			// Only use querySelectorAll on non-XML documents
+			// (ID selectors don't work in non-HTML documents)
+			if ( !seed && !Sizzle.isXML(context) ) {
+				// See if we find a selector to speed up
+				var match = /^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec( query );
+
+				if ( match && (context.nodeType === 1 || context.nodeType === 9) ) {
+					// Speed-up: Sizzle("TAG")
+					if ( match[1] ) {
+						return makeArray( context.getElementsByTagName( query ), extra );
+
+					// Speed-up: Sizzle(".CLASS")
+					} else if ( match[2] && Expr.find.CLASS && context.getElementsByClassName ) {
+						return makeArray( context.getElementsByClassName( match[2] ), extra );
+					}
+				}
+
+				if ( context.nodeType === 9 ) {
+					// Speed-up: Sizzle("body")
+					// The body element only exists once, optimize finding it
+					if ( query === "body" && context.body ) {
+						return makeArray( [ context.body ], extra );
+
+					// Speed-up: Sizzle("#ID")
+					} else if ( match && match[3] ) {
+						var elem = context.getElementById( match[3] );
+
+						// Check parentNode to catch when Blackberry 4.6 returns
+						// nodes that are no longer in the document #6963
+						if ( elem && elem.parentNode ) {
+							// Handle the case where IE and Opera return items
+							// by name instead of ID
+							if ( elem.id === match[3] ) {
+								return makeArray( [ elem ], extra );
+							}
+
+						} else {
+							return makeArray( [], extra );
+						}
+					}
+
+					try {
+						return makeArray( context.querySelectorAll(query), extra );
+					} catch(qsaError) {}
+
+				// qSA works strangely on Element-rooted queries
+				// We can work around this by specifying an extra ID on the root
+				// and working up from there (Thanks to Andrew Dupont for the technique)
+				// IE 8 doesn't work on object elements
+				} else if ( context.nodeType === 1 && context.nodeName.toLowerCase() !== "object" ) {
+					var oldContext = context,
+						old = context.getAttribute( "id" ),
+						nid = old || id,
+						hasParent = context.parentNode,
+						relativeHierarchySelector = /^\s*[+~]/.test( query );
+
+					if ( !old ) {
+						context.setAttribute( "id", nid );
+					} else {
+						nid = nid.replace( /'/g, "\\$&" );
+					}
+					if ( relativeHierarchySelector && hasParent ) {
+						context = context.parentNode;
+					}
+
+					try {
+						if ( !relativeHierarchySelector || hasParent ) {
+							return makeArray( context.querySelectorAll( "[id='" + nid + "'] " + query ), extra );
+						}
+
+					} catch(pseudoError) {
+					} finally {
+						if ( !old ) {
+							oldContext.removeAttribute( "id" );
+						}
+					}
+				}
+			}
+
+			return oldSizzle(query, context, extra, seed);
+		};
+
+		for ( var prop in oldSizzle ) {
+			Sizzle[ prop ] = oldSizzle[ prop ];
+		}
+
+		// release memory in IE
+		div = null;
+	})();
+}
+
+(function(){
+	var html = document.documentElement,
+		matches = html.matchesSelector || html.mozMatchesSelector || html.webkitMatchesSelector || html.msMatchesSelector;
+
+	if ( matches ) {
+		// Check to see if it's possible to do matchesSelector
+		// on a disconnected node (IE 9 fails this)
+		var disconnectedMatch = !matches.call( document.createElement( "div" ), "div" ),
+			pseudoWorks = false;
+
+		try {
+			// This should fail with an exception
+			// Gecko does not error, returns false instead
+			matches.call( document.documentElement, "[test!='']:sizzle" );
+
+		} catch( pseudoError ) {
+			pseudoWorks = true;
+		}
+
+		Sizzle.matchesSelector = function( node, expr ) {
+			// Make sure that attribute selectors are quoted
+			expr = expr.replace(/\=\s*([^'"\]]*)\s*\]/g, "='$1']");
+
+			if ( !Sizzle.isXML( node ) ) {
+				try {
+					if ( pseudoWorks || !Expr.match.PSEUDO.test( expr ) && !/!=/.test( expr ) ) {
+						var ret = matches.call( node, expr );
+
+						// IE 9's matchesSelector returns false on disconnected nodes
+						if ( ret || !disconnectedMatch ||
+								// As well, disconnected nodes are said to be in a document
+								// fragment in IE 9, so check for that
+								node.document && node.document.nodeType !== 11 ) {
+							return ret;
+						}
+					}
+				} catch(e) {}
+			}
+
+			return Sizzle(expr, null, null, [node]).length > 0;
+		};
+	}
+})();
+
+(function(){
+	var div = document.createElement("div");
+
+	div.innerHTML = "<div class='test e'></div><div class='test'></div>";
+
+	// Opera can't find a second classname (in 9.6)
+	// Also, make sure that getElementsByClassName actually exists
+	if ( !div.getElementsByClassName || div.getElementsByClassName("e").length === 0 ) {
+		return;
+	}
+
+	// Safari caches class attributes, doesn't catch changes (in 3.2)
+	div.lastChild.className = "e";
+
+	if ( div.getElementsByClassName("e").length === 1 ) {
+		return;
+	}
+
+	Expr.order.splice(1, 0, "CLASS");
+	Expr.find.CLASS = function( match, context, isXML ) {
+		if ( typeof context.getElementsByClassName !== "undefined" && !isXML ) {
+			return context.getElementsByClassName(match[1]);
+		}
+	};
+
+	// release memory in IE
+	div = null;
+})();
+
+function dirNodeCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {
+	for ( var i = 0, l = checkSet.length; i < l; i++ ) {
+		var elem = checkSet[i];
+
+		if ( elem ) {
+			var match = false;
+
+			elem = elem[dir];
+
+			while ( elem ) {
+				if ( elem[ expando ] === doneName ) {
+					match = checkSet[elem.sizset];
+					break;
+				}
+
+				if ( elem.nodeType === 1 && !isXML ){
+					elem[ expando ] = doneName;
+					elem.sizset = i;
+				}
+
+				if ( elem.nodeName.toLowerCase() === cur ) {
+					match = elem;
+					break;
+				}
+
+				elem = elem[dir];
+			}
+
+			checkSet[i] = match;
+		}
+	}
+}
+
+function dirCheck( dir, cur, doneName, checkSet, nodeCheck, isXML ) {
+	for ( var i = 0, l = checkSet.length; i < l; i++ ) {
+		var elem = checkSet[i];
+
+		if ( elem ) {
+			var match = false;
+
+			elem = elem[dir];
+
+			while ( elem ) {
+				if ( elem[ expando ] === doneName ) {
+					match = checkSet[elem.sizset];
+					break;
+				}
+
+				if ( elem.nodeType === 1 ) {
+					if ( !isXML ) {
+						elem[ expando ] = doneName;
+						elem.sizset = i;
+					}
+
+					if ( typeof cur !== "string" ) {
+						if ( elem === cur ) {
+							match = true;
+							break;
+						}
+
+					} else if ( Sizzle.filter( cur, [elem] ).length > 0 ) {
+						match = elem;
+						break;
+					}
+				}
+
+				elem = elem[dir];
+			}
+
+			checkSet[i] = match;
+		}
+	}
+}
+
+if ( document.documentElement.contains ) {
+	Sizzle.contains = function( a, b ) {
+		return a !== b && (a.contains ? a.contains(b) : true);
+	};
+
+} else if ( document.documentElement.compareDocumentPosition ) {
+	Sizzle.contains = function( a, b ) {
+		return !!(a.compareDocumentPosition(b) & 16);
+	};
+
+} else {
+	Sizzle.contains = function() {
+		return false;
+	};
+}
+
+Sizzle.isXML = function( elem ) {
+	// documentElement is verified for cases where it doesn't yet exist
+	// (such as loading iframes in IE - #4833)
+	var documentElement = (elem ? elem.ownerDocument || elem : 0).documentElement;
+
+	return documentElement ? documentElement.nodeName !== "HTML" : false;
+};
+
+var posProcess = function( selector, context, seed ) {
+	var match,
+		tmpSet = [],
+		later = "",
+		root = context.nodeType ? [context] : context;
+
+	// Position selectors must be done after the filter
+	// And so must :not(positional) so we move all PSEUDOs to the end
+	while ( (match = Expr.match.PSEUDO.exec( selector )) ) {
+		later += match[0];
+		selector = selector.replace( Expr.match.PSEUDO, "" );
+	}
+
+	selector = Expr.relative[selector] ? selector + "*" : selector;
+
+	for ( var i = 0, l = root.length; i < l; i++ ) {
+		Sizzle( selector, root[i], tmpSet, seed );
+	}
+
+	return Sizzle.filter( later, tmpSet );
+};
+
+// EXPOSE
+
+window.Sizzle = Sizzle;
+
 })();
\ No newline at end of file
diff --git a/data/formatting/utf-8/entitize.py b/data/formatting/utf-8/entitize.py
deleted file mode 100644
index efa7cb18d5..0000000000
--- a/data/formatting/utf-8/entitize.py
+++ /dev/null
@@ -1,24 +0,0 @@
-# Generates entitized.txt from utf-8.txt
-#
-# entitized.txt is used by Tests_Formatting_UrlEncodedToEntities
-
-import codecs
-import sys
-
-def entitize(line):
-    """Convert text to &#[dec]; entities."""
-    line = line.strip();
-    line = ["&#%d;" % ord(s) for s in line]
-    return "".join(line)
-
-if __name__ == "__main__":
-    args = sys.argv[1:]
-    if args and args[0] in ("-h", "--help"):
-        print "Usage: python entitize.py < utf-8.txt > entitized.txt"
-        sys.exit(2)
-
-    sys.stdin = codecs.getreader("utf-8")(sys.stdin)
-    sys.stdout = codecs.getwriter("ascii")(sys.stdout)    
-    
-    lines = sys.stdin.readlines()
-    sys.stdout.write( "\n".join(map(entitize, lines)) )
diff --git a/data/formatting/utf-8/entitized.txt b/data/formatting/utf-8/entitized.txt
deleted file mode 100644
index 93d897585f..0000000000
--- a/data/formatting/utf-8/entitized.txt
+++ /dev/null
@@ -1,6 +0,0 @@
-&#31456;&#23376;&#24609;
-&#70;&#114;&#97;&#110;&#231;&#111;&#105;&#115;&#32;&#84;&#114;&#117;&#102;&#102;&#97;&#117;&#116;
-&#4321;&#4304;&#4325;&#4304;&#4320;&#4311;&#4309;&#4308;&#4314;&#4317;
-&#66;&#106;&#246;&#114;&#107;&#32;&#71;&#117;&#240;&#109;&#117;&#110;&#100;&#115;&#100;&#243;&#116;&#116;&#105;&#114;
-&#23470;&#23822;&#12288;&#39423;
-&#128077;
\ No newline at end of file
diff --git a/data/formatting/utf-8/u-urlencode.py b/data/formatting/utf-8/u-urlencode.py
deleted file mode 100644
index c20a14f1f8..0000000000
--- a/data/formatting/utf-8/u-urlencode.py
+++ /dev/null
@@ -1,24 +0,0 @@
-# Generates u-urlencoded.txt from utf-8.txt
-#
-# u-urlencoded.txt is used by Tests_Formatting_UrlEncodedToEntities
-
-import codecs
-import sys
-
-def uurlencode(line):
-    """Use %u[hexvalue] percent encoding."""
-    line = line.strip()
-    line = ["%%u%04X" % ord(s) for s in line]
-    return "".join(line)
-
-if __name__ == "__main__":
-    args = sys.argv[1:]
-    if args and args[0] in ("-h", "--help"):
-        print "Usage: python u-urlencode.py < utf-8.txt > u-urlencoded.txt"
-        sys.exit(2)
-
-    sys.stdin = codecs.getreader("utf-8")(sys.stdin)
-    sys.stdout = codecs.getwriter("ascii")(sys.stdout)    
-    
-    lines = sys.stdin.readlines()
-    sys.stdout.write( "\n".join(map(uurlencode, lines)) )
diff --git a/data/formatting/utf-8/u-urlencoded.txt b/data/formatting/utf-8/u-urlencoded.txt
deleted file mode 100644
index d6f77fdc3f..0000000000
--- a/data/formatting/utf-8/u-urlencoded.txt
+++ /dev/null
@@ -1,6 +0,0 @@
-%u7AE0%u5B50%u6021
-%u0046%u0072%u0061%u006E%u00E7%u006F%u0069%u0073%u0020%u0054%u0072%u0075%u0066%u0066%u0061%u0075%u0074
-%u10E1%u10D0%u10E5%u10D0%u10E0%u10D7%u10D5%u10D4%u10DA%u10DD
-%u0042%u006A%u00F6%u0072%u006B%u0020%u0047%u0075%u00F0%u006D%u0075%u006E%u0064%u0073%u0064%u00F3%u0074%u0074%u0069%u0072
-%u5BAE%u5D0E%u3000%u99FF
-%u1F44D
\ No newline at end of file
diff --git a/data/formatting/utf-8/urlencode.py b/data/formatting/utf-8/urlencode.py
index d29907f24b..910b796f80 100644
--- a/data/formatting/utf-8/urlencode.py
+++ b/data/formatting/utf-8/urlencode.py
@@ -1,33 +1,33 @@
-# Generates urlencoded.txt from utf-8.txt
-#
-# urlencoded.txt is used by Tests_Formatting_Utf8UriEncode
-
-import urllib, codecs, re
-import sys
-
-# uncapitalize pct-encoded values, leave the rest alone
-capfix = re.compile("%([0-9A-Z]{2})");
-def fix(match):
-    octet = match.group(1)
-    intval = int(octet, 16)
-    if intval < 128:
-        return chr(intval).lower()
-    return '%' + octet.lower()
-
-def urlencode(line):
-    """Percent-encode each byte of non-ASCII unicode characters."""
-    line = urllib.quote(line.strip().encode("utf-8"))
-    line = capfix.sub(fix, line)
-    return line
-
-if __name__ == "__main__":
-    args = sys.argv[1:]
-    if args and args[0] in ("-h", "--help"):
-        print "Usage: python urlencode.py < utf-8.txt > urlencoded.txt"
-        sys.exit(2)
-
-    sys.stdin = codecs.getreader("utf-8")(sys.stdin)
-    sys.stdout = codecs.getwriter("ascii")(sys.stdout)    
-    
-    lines = sys.stdin.readlines()
-    sys.stdout.write( "\n".join(map(urlencode, lines)) )
+# Generates urlencoded.txt from utf-8.txt
+#
+# urlencoded.txt is used by Tests_Formatting_Utf8UriEncode
+
+import urllib, codecs, re
+import sys
+
+# uncapitalize pct-encoded values, leave the rest alone
+capfix = re.compile("%([0-9A-Z]{2})");
+def fix(match):
+    octet = match.group(1)
+    intval = int(octet, 16)
+    if intval < 128:
+        return chr(intval).lower()
+    return '%' + octet.lower()
+
+def urlencode(line):
+    """Percent-encode each byte of non-ASCII unicode characters."""
+    line = urllib.quote(line.strip().encode("utf-8"))
+    line = capfix.sub(fix, line)
+    return line
+
+if __name__ == "__main__":
+    args = sys.argv[1:]
+    if args and args[0] in ("-h", "--help"):
+        print "Usage: python urlencode.py < utf-8.txt > urlencoded.txt"
+        sys.exit(2)
+
+    sys.stdin = codecs.getreader("utf-8")(sys.stdin)
+    sys.stdout = codecs.getwriter("ascii")(sys.stdout)    
+    
+    lines = sys.stdin.readlines()
+    sys.stdout.write( "\n".join(map(urlencode, lines)) )
diff --git a/data/formatting/utf-8/utf-8.txt b/data/formatting/utf-8/utf-8.txt
index a2df260b1e..aaedae7c6c 100644
--- a/data/formatting/utf-8/utf-8.txt
+++ b/data/formatting/utf-8/utf-8.txt
@@ -1,6 +1,6 @@
-蝡摮
-Fran癟ois Truffaut
-﹥丟
-Bj繹rk Gu簸mundsd籀ttir
-摰桀擏
-
+蝡摮
+Fran癟ois Truffaut
+﹥丟
+Bj繹rk Gu簸mundsd籀ttir
+摰桀擏
+
diff --git a/data/formatting/windows1252.py b/data/formatting/windows1252.py
index a4fe402703..bca7499b9c 100644
--- a/data/formatting/windows1252.py
+++ b/data/formatting/windows1252.py
@@ -1,27 +1,27 @@
-# Generates test data for functions converting between
-# dodgy windows-1252-only values and their unicode counterparts
-
-unichars = ["201A", "0192", "201E", "2026", "2020", "2021", 
-            "02C6", "2030", "0160", "2039", "0152", "2018", 
-            "2019", "201C", "201D", "2022", "2013", "2014", 
-            "02DC", "2122", "0161", "203A", "0153", "0178"];
-
-winpoints = []
-unipoints = []
-
-for char in unichars:
-    char = unichr(int(char, 16))
-    dec = ord(char)
-    win = ord(char.encode("windows-1252"))
-    
-    unipoints.append(dec)
-    winpoints.append(win)
-
-def entitize(s):
-    return "&#%s;" % s
-
-winpoints = map(entitize, winpoints)
-unipoints = map(entitize, unipoints)
-
-print "".join(winpoints), "".join(unipoints)
-    
+# Generates test data for functions converting between
+# dodgy windows-1252-only values and their unicode counterparts
+
+unichars = ["201A", "0192", "201E", "2026", "2020", "2021", 
+            "02C6", "2030", "0160", "2039", "0152", "2018", 
+            "2019", "201C", "201D", "2022", "2013", "2014", 
+            "02DC", "2122", "0161", "203A", "0153", "0178"];
+
+winpoints = []
+unipoints = []
+
+for char in unichars:
+    char = unichr(int(char, 16))
+    dec = ord(char)
+    win = ord(char.encode("windows-1252"))
+    
+    unipoints.append(dec)
+    winpoints.append(win)
+
+def entitize(s):
+    return "&#%s;" % s
+
+winpoints = map(entitize, winpoints)
+unipoints = map(entitize, unipoints)
+
+print "".join(winpoints), "".join(unipoints)
+    
diff --git a/data/images/one-blue-pixel-100x100.png b/data/images/one-blue-pixel-100x100.png
new file mode 100644
index 0000000000..1aff0e0ca0
Binary files /dev/null and b/data/images/one-blue-pixel-100x100.png differ
diff --git a/data/languages/de_DE.mo b/data/languages/de_DE.mo
index b65a14e19c..dcfef58f48 100644
Binary files a/data/languages/de_DE.mo and b/data/languages/de_DE.mo differ
diff --git a/data/languages/de_DE.po b/data/languages/de_DE.po
index 4d66b76c10..aa97af62e9 100644
--- a/data/languages/de_DE.po
+++ b/data/languages/de_DE.po
@@ -1,14 +1,14 @@
-# Translation of 4.9.x in German
-# This file is distributed under the same license as the 4.9.x package.
+# Translation of 5.2.x in German
+# This file is distributed under the same license as the 5.2.x package.
 msgid ""
 msgstr ""
-"PO-Revision-Date: 2018-08-13 19:19+0300\n"
+"PO-Revision-Date: 2019-03-28 19:42+0300\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 "Plural-Forms: nplurals=2; plural=n != 1;\n"
-"X-Generator: Poedit 2.1.1\n"
-"Project-Id-Version: Development (4.9.x)\n"
+"X-Generator: Poedit 2.2.1\n"
+"Project-Id-Version: Development (5.2.x)\n"
 "Language: de_DE\n"
 "POT-Creation-Date: \n"
 "Last-Translator: \n"
@@ -48,3 +48,12 @@ msgstr "Jetzt %s aktualisieren"
 #: wp-includes/user.php:3445
 msgid "[%1$s] Confirm Action: %2$s"
 msgstr "[%1$s] Aktion best瓣tigen: %2$s"
+
+#. translators: %s: Site name.
+#: wp-includes/user.php:3175
+msgid "[%s] Erasure Request Fulfilled"
+msgstr "[%s] L繹schauftrag ausgef羹hrt"
+
+#: wp-admin/includes/file.php:2415
+msgid "[%s] Personal Data Export"
+msgstr "[%s] Export personenbezogener Daten"
diff --git a/data/languages/es_ES.mo b/data/languages/es_ES.mo
index d4c5767eaf..bd56b36d4c 100644
Binary files a/data/languages/es_ES.mo and b/data/languages/es_ES.mo differ
diff --git a/data/languages/es_ES.po b/data/languages/es_ES.po
index 6e03a32de2..511874825e 100644
--- a/data/languages/es_ES.po
+++ b/data/languages/es_ES.po
@@ -1,14 +1,14 @@
-# Translation of Development (4.9.x) in Spanish (Spain)
-# This file is distributed under the same license as the Development (4.9.x) package.
+# Translation of Development (5.2.x) in Spanish (Spain)
+# This file is distributed under the same license as the Development (5.2.x) package.
 msgid ""
 msgstr ""
-"PO-Revision-Date: 2018-08-13 19:19+0300\n"
+"PO-Revision-Date: 2019-03-28 19:43+0300\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 "Plural-Forms: nplurals=2; plural=n != 1;\n"
-"X-Generator: Poedit 2.1.1\n"
-"Project-Id-Version: Development (4.9.x)\n"
+"X-Generator: Poedit 2.2.1\n"
+"Project-Id-Version: Development (5.2.x)\n"
 "Language: es_ES\n"
 "POT-Creation-Date: \n"
 "Last-Translator: \n"
@@ -44,3 +44,12 @@ msgstr "(Actualmente fijado en: %s)"
 #: wp-includes/user.php:3445
 msgid "[%1$s] Confirm Action: %2$s"
 msgstr "[%1$s] Confirma la acci籀n: %2$s"
+
+#. translators: %s: Site name.
+#: wp-includes/user.php:3175
+msgid "[%s] Erasure Request Fulfilled"
+msgstr "[%s] Solicitud de borrado completada"
+
+#: wp-admin/includes/file.php:2415
+msgid "[%s] Personal Data Export"
+msgstr "[%s] Exportaci籀n de datos personales"
diff --git a/data/languages/ja_JP.mo b/data/languages/ja_JP.mo
index 1399898aa7..da1681326c 100644
Binary files a/data/languages/ja_JP.mo and b/data/languages/ja_JP.mo differ
diff --git a/data/languages/ja_JP.po b/data/languages/ja_JP.po
index f71a737714..bd9cd17a95 100644
--- a/data/languages/ja_JP.po
+++ b/data/languages/ja_JP.po
@@ -40,3 +40,30 @@ msgstr "number_format_thousands_sep"
 #: wp-includes/script-loader.php:620
 msgid "Update %s now"
 msgstr "隞 %s 湔"
+
+#. translators: If your word count is based on single characters (e.g. East
+#. Asian characters), enter 'characters_excluding_spaces' or
+#. 'characters_including_spaces'. Otherwise, enter 'words'. Do not translate
+#. into your own language.
+#: wp-includes/formatting.php:3372 wp-includes/script-loader.php:1100
+msgctxt "Word count type. Do not translate!"
+msgid "words"
+msgstr "characters_including_spaces"
+
+#. translators: Maximum number of words used in a post excerpt.
+#: wp-includes/formatting.php:3640
+msgctxt "excerpt_length"
+msgid "55"
+msgstr "110"
+
+#. translators: Maximum number of words used in a comment excerpt.
+#: wp-includes/comment-template.ph:599
+msgctxt "comment_excerpt_length"
+msgid "20"
+msgstr "40"
+
+#. translators: Maximum number of words used in a preview of a draft on the dashboard.
+#: wp-admin/includes/dashboard.php:591
+msgctxt "draft_length"
+msgid "10"
+msgstr "40"
diff --git a/data/themedir1/default/template-part.php b/data/themedir1/default/template-part.php
new file mode 100644
index 0000000000..05c759fcbb
--- /dev/null
+++ b/data/themedir1/default/template-part.php
@@ -0,0 +1 @@
+Template Part
diff --git a/data/uploads/test.dfxp b/data/uploads/test.dfxp
index c3f7cde405..7fd7e3840e 100644
--- a/data/uploads/test.dfxp
+++ b/data/uploads/test.dfxp
@@ -1,164 +1,164 @@
-<?xml version="1.0" encoding="utf-8"?>
-<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
-	xmlns:tts="http://www.w3.org/ns/ttml#styling"
-	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
-	<head>
-		<styling>
-			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
-			tts:fontWeight="normal" tts:fontStyle="normal"
-			tts:textDecoration="none" tts:color="white"
-			tts:backgroundColor="black" />
-		</styling>
-
-	</head>
-	<body>
-		<div style="defaultCaption" xml:lang="en">
-			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
-			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
-			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
-			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
-			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
-			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
-			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
-			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
-			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
-			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
-			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
-			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
-			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
-			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
-			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
-			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
-			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
-			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
-			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
-			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
-			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
-			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
-			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
-		</div>
-	</body>
-</tt>
-<?xml version="1.0" encoding="utf-8"?>
-<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
-	xmlns:tts="http://www.w3.org/ns/ttml#styling"
-	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
-	<head>
-		<styling>
-			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
-			tts:fontWeight="normal" tts:fontStyle="normal"
-			tts:textDecoration="none" tts:color="white"
-			tts:backgroundColor="black" />
-		</styling>
-
-	</head>
-	<body>
-		<div style="defaultCaption" xml:lang="en">
-			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
-			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
-			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
-			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
-			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
-			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
-			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
-			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
-			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
-			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
-			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
-			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
-			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
-			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
-			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
-			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
-			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
-			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
-			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
-			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
-			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
-			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
-			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
-		</div>
-	</body>
-</tt>
-<?xml version="1.0" encoding="utf-8"?>
-<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
-	xmlns:tts="http://www.w3.org/ns/ttml#styling"
-	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
-	<head>
-		<styling>
-			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
-			tts:fontWeight="normal" tts:fontStyle="normal"
-			tts:textDecoration="none" tts:color="white"
-			tts:backgroundColor="black" />
-		</styling>
-
-	</head>
-	<body>
-		<div style="defaultCaption" xml:lang="en">
-			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
-			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
-			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
-			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
-			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
-			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
-			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
-			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
-			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
-			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
-			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
-			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
-			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
-			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
-			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
-			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
-			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
-			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
-			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
-			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
-			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
-			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
-			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
-		</div>
-	</body>
-</tt>
-<?xml version="1.0" encoding="utf-8"?>
-<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
-	xmlns:tts="http://www.w3.org/ns/ttml#styling"
-	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
-	<head>
-		<styling>
-			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
-			tts:fontWeight="normal" tts:fontStyle="normal"
-			tts:textDecoration="none" tts:color="white"
-			tts:backgroundColor="black" />
-		</styling>
-
-	</head>
-	<body>
-		<div style="defaultCaption" xml:lang="en">
-			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
-			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
-			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
-			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
-			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
-			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
-			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
-			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
-			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
-			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
-			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
-			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
-			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
-			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
-			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
-			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
-			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
-			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
-			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
-			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
-			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
-			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
-			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
-		</div>
-	</body>
-</tt>
+<?xml version="1.0" encoding="utf-8"?>
+<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
+	xmlns:tts="http://www.w3.org/ns/ttml#styling"
+	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
+	<head>
+		<styling>
+			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
+			tts:fontWeight="normal" tts:fontStyle="normal"
+			tts:textDecoration="none" tts:color="white"
+			tts:backgroundColor="black" />
+		</styling>
+
+	</head>
+	<body>
+		<div style="defaultCaption" xml:lang="en">
+			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
+			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
+			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
+			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
+			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
+			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
+			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
+			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
+			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
+			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
+			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
+			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
+			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
+			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
+			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
+			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
+			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
+			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
+			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
+			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
+			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
+			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
+			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
+		</div>
+	</body>
+</tt>
+<?xml version="1.0" encoding="utf-8"?>
+<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
+	xmlns:tts="http://www.w3.org/ns/ttml#styling"
+	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
+	<head>
+		<styling>
+			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
+			tts:fontWeight="normal" tts:fontStyle="normal"
+			tts:textDecoration="none" tts:color="white"
+			tts:backgroundColor="black" />
+		</styling>
+
+	</head>
+	<body>
+		<div style="defaultCaption" xml:lang="en">
+			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
+			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
+			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
+			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
+			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
+			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
+			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
+			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
+			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
+			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
+			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
+			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
+			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
+			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
+			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
+			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
+			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
+			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
+			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
+			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
+			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
+			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
+			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
+		</div>
+	</body>
+</tt>
+<?xml version="1.0" encoding="utf-8"?>
+<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
+	xmlns:tts="http://www.w3.org/ns/ttml#styling"
+	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
+	<head>
+		<styling>
+			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
+			tts:fontWeight="normal" tts:fontStyle="normal"
+			tts:textDecoration="none" tts:color="white"
+			tts:backgroundColor="black" />
+		</styling>
+
+	</head>
+	<body>
+		<div style="defaultCaption" xml:lang="en">
+			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
+			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
+			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
+			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
+			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
+			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
+			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
+			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
+			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
+			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
+			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
+			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
+			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
+			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
+			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
+			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
+			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
+			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
+			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
+			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
+			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
+			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
+			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
+		</div>
+	</body>
+</tt>
+<?xml version="1.0" encoding="utf-8"?>
+<tt xml:lang="en" xmlns="http://www.w3.org/ns/ttml"
+	xmlns:tts="http://www.w3.org/ns/ttml#styling"
+	xmlns:ttm="http://www.w3.org/ns/ttml#metadata">
+	<head>
+		<styling>
+			<style xml:id="defaultCaption" tts:fontSize="10" tts:fontFamily="SansSerif"
+			tts:fontWeight="normal" tts:fontStyle="normal"
+			tts:textDecoration="none" tts:color="white"
+			tts:backgroundColor="black" />
+		</styling>
+
+	</head>
+	<body>
+		<div style="defaultCaption" xml:lang="en">
+			<p begin="00:00:03.400" end="00:00:06.177">In this lesson, we're going to<br />be talking about finance. And</p>
+			<p begin="00:00:06.177" end="00:00:10.009">one of the most important aspects<br />of finance is interest.</p>
+			<p begin="00:00:10.009" end="00:00:13.655">When I go to a bank or some<br />other lending institution</p>
+			<p begin="00:00:13.655" end="00:00:17.720">to borrow money, the bank is happy<br />to give me that money. But then I'm</p>
+			<p begin="00:00:17.900" end="00:00:21.480">going to be paying the bank for the<br />privilege of using their money. And that</p>
+			<p begin="00:00:21.660" end="00:00:26.440">amount of money that I pay the bank is<br />called interest. Likewise, if I put money</p>
+			<p begin="00:00:26.620" end="00:00:31.220">in a savings account or I purchase a<br />certificate of deposit, the bank just</p>
+			<p begin="00:00:31.300" end="00:00:35.800">doesn't put my money in a little box<br />and leave it there until later. They take</p>
+			<p begin="00:00:35.800" end="00:00:40.822">my money and lend it to someone<br />else. So they are using my money.</p>
+			<p begin="00:00:40.822" end="00:00:44.400">The bank has to pay me for the privilege<br />of using my money.</p>
+			<p begin="00:00:44.400" end="00:00:48.700">Now what makes banks<br />profitable is the rate</p>
+			<p begin="00:00:48.700" end="00:00:53.330">that they charge people to use the bank's<br />money is higher than the rate that they</p>
+			<p begin="00:00:53.510" end="00:01:00.720">pay people like me to use my money. The<br />amount of interest that a person pays or</p>
+			<p begin="00:01:00.800" end="00:01:06.640">earns is dependent on three things. It's<br />dependent on how much money is involved.</p>
+			<p begin="00:01:06.820" end="00:01:11.300">It's dependent upon the rate of interest<br />being paid or the rate of interest being</p>
+			<p begin="00:01:11.480" end="00:01:17.898">charged. And it's also dependent upon<br />how much time is involved. If I have</p>
+			<p begin="00:01:17.898" end="00:01:22.730">a loan and I want to decrease the amount<br />of interest that I'm going to pay, then</p>
+			<p begin="00:01:22.800" end="00:01:28.040">I'm either going to have to decrease how<br />much money I borrow, I'm going to have</p>
+			<p begin="00:01:28.220" end="00:01:32.420">to borrow the money over a shorter period<br />of time, or I'm going to have to find a</p>
+			<p begin="00:01:32.600" end="00:01:37.279">lending institution that charges a lower<br />interest rate. On the other hand, if I</p>
+			<p begin="00:01:37.279" end="00:01:41.480">want to earn more interest on my<br />investment, I'm going to have to invest</p>
+			<p begin="00:01:41.480" end="00:01:46.860">more money, leave the money in the<br />account for a longer period of time, or</p>
+			<p begin="00:01:46.860" end="00:01:49.970">find an institution that will pay<br />me a higher interest rate.</p>
+		</div>
+	</body>
+</tt>
diff --git a/includes/abstract-testcase.php b/includes/abstract-testcase.php
index c90a1614e8..749803dffc 100644
--- a/includes/abstract-testcase.php
+++ b/includes/abstract-testcase.php
@@ -23,11 +23,11 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	protected static $hooks_saved = array();
 	protected static $ignore_files;
 
-	function __isset( $name ) {
+	public function __isset( $name ) {
 		return 'factory' === $name;
 	}
 
-	function __get( $name ) {
+	public function __get( $name ) {
 		if ( 'factory' === $name ) {
 			return self::factory();
 		}
@@ -46,21 +46,20 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		return $factory;
 	}
 
+	/**
+	 * Retrieves the name of the class the static method is called in.
+	 *
+	 * @deprecated 5.3.0 Use the PHP native get_called_class() function instead.
+	 *
+	 * @return string The class name.
+	 */
 	public static function get_called_class() {
-		if ( function_exists( 'get_called_class' ) ) {
-			return get_called_class();
-		}
-
-		// PHP 5.2 only
-		$backtrace = debug_backtrace();
-		// [0] WP_UnitTestCase::get_called_class()
-		// [1] WP_UnitTestCase::setUpBeforeClass()
-		if ( 'call_user_func' === $backtrace[2]['function'] ) {
-			return $backtrace[2]['args'][0][0];
-		}
-		return $backtrace[2]['class'];
+		return get_called_class();
 	}
 
+	/**
+	 * Runs the routine before setting up all tests.
+	 */
 	public static function setUpBeforeClass() {
 		global $wpdb;
 
@@ -71,7 +70,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 
 		parent::setUpBeforeClass();
 
-		$c = self::get_called_class();
+		$c = get_called_class();
 		if ( ! method_exists( $c, 'wpSetUpBeforeClass' ) ) {
 			self::commit_transaction();
 			return;
@@ -82,13 +81,16 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		self::commit_transaction();
 	}
 
+	/**
+	 * Runs the routine after all tests have been run.
+	 */
 	public static function tearDownAfterClass() {
 		parent::tearDownAfterClass();
 
 		_delete_all_data();
 		self::flush_cache();
 
-		$c = self::get_called_class();
+		$c = get_called_class();
 		if ( ! method_exists( $c, 'wpTearDownAfterClass' ) ) {
 			self::commit_transaction();
 			return;
@@ -99,7 +101,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		self::commit_transaction();
 	}
 
-	function setUp() {
+	/**
+	 * Runs the routine before each test is executed.
+	 */
+	public function setUp() {
 		set_time_limit( 0 );
 
 		if ( ! self::$ignore_files ) {
@@ -139,7 +144,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	/**
 	 * After a test method runs, reset any state in WordPress the test method might have changed.
 	 */
-	function tearDown() {
+	public function tearDown() {
 		global $wpdb, $wp_query, $wp;
 		$wpdb->query( 'ROLLBACK' );
 		if ( is_multisite() ) {
@@ -165,7 +170,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		wp_set_current_user( 0 );
 	}
 
-	function clean_up_global_scope() {
+	/**
+	 * Cleans the global scope (e.g `$_GET` and `$_POST`).
+	 */
+	public function clean_up_global_scope() {
 		$_GET  = array();
 		$_POST = array();
 		self::flush_cache();
@@ -269,7 +277,6 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @global array $wp_actions
 	 * @global array $wp_current_filter
 	 * @global array $wp_filter
-	 * @return void
 	 */
 	protected function _backup_hooks() {
 		$globals = array( 'wp_actions', 'wp_current_filter' );
@@ -289,7 +296,6 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @global array $wp_actions
 	 * @global array $wp_current_filter
 	 * @global array $wp_filter
-	 * @return void
 	 */
 	protected function _restore_hooks() {
 		$globals = array( 'wp_actions', 'wp_current_filter' );
@@ -306,7 +312,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		}
 	}
 
-	static function flush_cache() {
+	/**
+	 * Flushes the WordPress object cache.
+	 */
+	public static function flush_cache() {
 		global $wp_object_cache;
 		$wp_object_cache->group_ops      = array();
 		$wp_object_cache->stats          = array();
@@ -327,7 +336,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @global array $wp_meta_keys
 	 */
-	function unregister_all_meta_keys() {
+	public function unregister_all_meta_keys() {
 		global $wp_meta_keys;
 		if ( ! is_array( $wp_meta_keys ) ) {
 			return;
@@ -341,7 +350,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		}
 	}
 
-	function start_transaction() {
+	/**
+	 * Starts a database transaction.
+	 */
+	public function start_transaction() {
 		global $wpdb;
 		$wpdb->query( 'SET autocommit = 0;' );
 		$wpdb->query( 'START TRANSACTION;' );
@@ -359,25 +371,54 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		$wpdb->query( 'COMMIT;' );
 	}
 
-	function _create_temporary_tables( $query ) {
-		if ( 'CREATE TABLE' === substr( trim( $query ), 0, 12 ) ) {
+	/**
+	 * Replaces the `CREATE TABLE` statement with a `CREATE TEMPORARY TABLE` statement.
+	 *
+	 * @param string $query The query to replace the statement for.
+	 * @return string The altered query.
+	 */
+	public function _create_temporary_tables( $query ) {
+		if ( 0 === strpos( trim( $query ), 'CREATE TABLE' ) ) {
 			return substr_replace( trim( $query ), 'CREATE TEMPORARY TABLE', 0, 12 );
 		}
 		return $query;
 	}
 
-	function _drop_temporary_tables( $query ) {
-		if ( 'DROP TABLE' === substr( trim( $query ), 0, 10 ) ) {
+	/**
+	 * Replaces the `DROP TABLE` statement with a `DROP TEMPORARY TABLE` statement.
+	 *
+	 * @param string $query The query to replace the statement for.
+	 * @return string The altered query.
+	 */
+	public function _drop_temporary_tables( $query ) {
+		if ( 0 === strpos( trim( $query ), 'DROP TABLE' ) ) {
 			return substr_replace( trim( $query ), 'DROP TEMPORARY TABLE', 0, 10 );
 		}
 		return $query;
 	}
 
-	function get_wp_die_handler( $handler ) {
+	/**
+	 * Retrieves the `wp_die()` handler.
+	 *
+	 * @param callable $handler The current die handler.
+	 * @return callable The test die handler.
+	 */
+	public function get_wp_die_handler( $handler ) {
 		return array( $this, 'wp_die_handler' );
 	}
 
-	function wp_die_handler( $message ) {
+	/**
+	 * Throws an exception when called.
+	 *
+	 * @throws WPDieException Exception containing the message.
+	 *
+	 * @param string $message The `wp_die()` message.
+	 */
+	public function wp_die_handler( $message ) {
+		if ( is_wp_error( $message ) ) {
+			$message = $message->get_error_message();
+		}
+
 		if ( ! is_scalar( $message ) ) {
 			$message = '0';
 		}
@@ -385,7 +426,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		throw new WPDieException( $message );
 	}
 
-	function expectDeprecated() {
+	/**
+	 * Sets up the expectations for testing a deprecated call.
+	 */
+	public function expectDeprecated() {
 		$annotations = $this->getAnnotations();
 		foreach ( array( 'class', 'method' ) as $depth ) {
 			if ( ! empty( $annotations[ $depth ]['expectedDeprecated'] ) ) {
@@ -405,7 +449,12 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		add_action( 'doing_it_wrong_trigger_error', '__return_false' );
 	}
 
-	function expectedDeprecated() {
+	/**
+	 * Handles a deprecated expectation.
+	 *
+	 * The DocBlock should contain `@expectedDeprecated` to trigger this.
+	 */
+	public function expectedDeprecated() {
 		$errors = array();
 
 		$not_caught_deprecated = array_diff( $this->expected_deprecated, $this->caught_deprecated );
@@ -454,10 +503,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @since 4.2.0
 	 *
 	 * @param string $deprecated Name of the function, method, class, or argument that is deprecated. Must match
-	 *                           first parameter of the `_deprecated_function()` or `_deprecated_argument()` call.
+	 *                           the first parameter of the `_deprecated_function()` or `_deprecated_argument()` call.
 	 */
 	public function setExpectedDeprecated( $deprecated ) {
-		array_push( $this->expected_deprecated, $deprecated );
+		$this->expected_deprecated[] = $deprecated;
 	}
 
 	/**
@@ -465,11 +514,11 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @since 4.2.0
 	 *
-	 * @param string $deprecated Name of the function, method, or class that appears in the first argument of the
-	 *                           source `_doing_it_wrong()` call.
+	 * @param string $doing_it_wrong Name of the function, method, or class that appears in the first argument
+	 *                               of the source `_doing_it_wrong()` call.
 	 */
 	public function setExpectedIncorrectUsage( $doing_it_wrong ) {
-		array_push( $this->expected_doing_it_wrong, $doing_it_wrong );
+		$this->expected_doing_it_wrong[] = $doing_it_wrong;
 	}
 
 	/**
@@ -493,52 +542,111 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		}
 	}
 
-	function deprecated_function_run( $function ) {
-		if ( ! in_array( $function, $this->caught_deprecated ) ) {
+	/**
+	 * Adds a deprecated function to the list of caught deprecated calls.
+	 *
+	 * @param string $function The deprecated function.
+	 */
+	public function deprecated_function_run( $function ) {
+		if ( ! in_array( $function, $this->caught_deprecated, true ) ) {
 			$this->caught_deprecated[] = $function;
 		}
 	}
 
-	function doing_it_wrong_run( $function ) {
-		if ( ! in_array( $function, $this->caught_doing_it_wrong ) ) {
+	/**
+	 * Adds a function called in a wrong way to the list of `_doing_it_wrong()` calls.
+	 *
+	 * @param string $function The function to add.
+	 */
+	public function doing_it_wrong_run( $function ) {
+		if ( ! in_array( $function, $this->caught_doing_it_wrong, true ) ) {
 			$this->caught_doing_it_wrong[] = $function;
 		}
 	}
 
-	function assertWPError( $actual, $message = '' ) {
+	/**
+	 * Asserts that the given value is an instance of WP_Error.
+	 *
+	 * @param mixed  $actual  The value to check.
+	 * @param string $message Optional. Message to display when the assertion fails.
+	 */
+	public function assertWPError( $actual, $message = '' ) {
 		$this->assertInstanceOf( 'WP_Error', $actual, $message );
 	}
 
-	function assertNotWPError( $actual, $message = '' ) {
-		if ( is_wp_error( $actual ) && '' === $message ) {
+	/**
+	 * Asserts that the given value is not an instance of WP_Error.
+	 *
+	 * @param mixed  $actual  The value to check.
+	 * @param string $message Optional. Message to display when the assertion fails.
+	 */
+	public function assertNotWPError( $actual, $message = '' ) {
+		if ( '' === $message && is_wp_error( $actual ) ) {
 			$message = $actual->get_error_message();
 		}
 		$this->assertNotInstanceOf( 'WP_Error', $actual, $message );
 	}
 
-	function assertIXRError( $actual, $message = '' ) {
+
+	/**
+	 * Asserts that the given value is an instance of IXR_Error.
+	 *
+	 * @param mixed  $actual  The value to check.
+	 * @param string $message Optional. Message to display when the assertion fails.
+	 */
+	public function assertIXRError( $actual, $message = '' ) {
 		$this->assertInstanceOf( 'IXR_Error', $actual, $message );
 	}
 
-	function assertNotIXRError( $actual, $message = '' ) {
+	/**
+	 * Asserts that the given value is not an instance of IXR_Error.
+	 *
+	 * @param mixed  $actual  The value to check.
+	 * @param string $message Optional. Message to display when the assertion fails.
+	 */
+	public function assertNotIXRError( $actual, $message = '' ) {
 		if ( $actual instanceof IXR_Error && '' === $message ) {
 			$message = $actual->message;
 		}
 		$this->assertNotInstanceOf( 'IXR_Error', $actual, $message );
 	}
 
-	function assertEqualFields( $object, $fields ) {
+	/**
+	 * Asserts that the given fields are present in the given object.
+	 *
+	 * @param object $object The object to check.
+	 * @param array  $fields The fields to check.
+	 */
+	public function assertEqualFields( $object, $fields ) {
 		foreach ( $fields as $field_name => $field_value ) {
-			if ( $object->$field_name != $field_value ) {
+			if ( $object->$field_name !== $field_value ) {
 				$this->fail();
 			}
 		}
 	}
 
-	function assertDiscardWhitespace( $expected, $actual ) {
+	/**
+	 * Asserts that two values are equal, with whitespace differences discarded.
+	 *
+	 * @param string $expected The expected value.
+	 * @param string $actual   The actual value.
+	 */
+	public function assertDiscardWhitespace( $expected, $actual ) {
 		$this->assertEquals( preg_replace( '/\s*/', '', $expected ), preg_replace( '/\s*/', '', $actual ) );
 	}
 
+	/**
+	 * Asserts that two values are equal, with EOL differences discarded.
+	 *
+	 * @since 5.4.0
+	 *
+	 * @param string $expected The expected value.
+	 * @param string $actual   The actual value.
+	 */
+	public function assertEqualsIgnoreEOL( $expected, $actual ) {
+		$this->assertEquals( str_replace( "\r\n", "\n", $expected ), str_replace( "\r\n", "\n", $actual ) );
+	}
+
 	/**
 	 * Asserts that the contents of two un-keyed, single arrays are equal, without accounting for the order of elements.
 	 *
@@ -547,7 +655,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @param array $expected Expected array.
 	 * @param array $actual   Array to check.
 	 */
-	function assertEqualSets( $expected, $actual ) {
+	public function assertEqualSets( $expected, $actual ) {
 		sort( $expected );
 		sort( $actual );
 		$this->assertEquals( $expected, $actual );
@@ -561,7 +669,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @param array $expected Expected array.
 	 * @param array $actual   Array to check.
 	 */
-	function assertEqualSetsWithIndex( $expected, $actual ) {
+	public function assertEqualSetsWithIndex( $expected, $actual ) {
 		ksort( $expected );
 		ksort( $actual );
 		$this->assertEquals( $expected, $actual );
@@ -574,7 +682,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param array $array Array to check.
 	 */
-	function assertNonEmptyMultidimensionalArray( $array ) {
+	public function assertNonEmptyMultidimensionalArray( $array ) {
 		$this->assertTrue( is_array( $array ) );
 		$this->assertNotEmpty( $array );
 
@@ -597,12 +705,13 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param string $url The URL for the request.
 	 */
-	function go_to( $url ) {
+	public function go_to( $url ) {
 		// note: the WP and WP_Query classes like to silently fetch parameters
 		// from all over the place (globals, GET, etc), which makes it tricky
 		// to run them more than once without very carefully clearing everything
-		$_GET = $_POST = array();
-		foreach ( array( 'query_string', 'id', 'postdata', 'authordata', 'day', 'currentmonth', 'page', 'pages', 'multipage', 'more', 'numpages', 'pagenow' ) as $v ) {
+		$_GET  = array();
+		$_POST = array();
+		foreach ( array( 'query_string', 'id', 'postdata', 'authordata', 'day', 'currentmonth', 'page', 'pages', 'multipage', 'more', 'numpages', 'pagenow', 'current_screen' ) as $v ) {
 			if ( isset( $GLOBALS[ $v ] ) ) {
 				unset( $GLOBALS[ $v ] );
 			}
@@ -687,7 +796,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		foreach ( $tickets as $ticket ) {
 			if ( is_numeric( $ticket ) ) {
 				$this->knownWPBug( $ticket );
-			} elseif ( 'Plugin' == substr( $ticket, 0, 6 ) ) {
+			} elseif ( 0 === strpos( $ticket, 'Plugin' ) ) {
 				$ticket = substr( $ticket, 6 );
 				if ( $ticket && is_numeric( $ticket ) ) {
 					$this->knownPluginBug( $ticket );
@@ -703,8 +812,8 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param int $ticket_id Ticket number.
 	 */
-	function knownWPBug( $ticket_id ) {
-		if ( WP_TESTS_FORCE_KNOWN_BUGS || in_array( $ticket_id, self::$forced_tickets ) ) {
+	public function knownWPBug( $ticket_id ) {
+		if ( WP_TESTS_FORCE_KNOWN_BUGS || in_array( $ticket_id, self::$forced_tickets, true ) ) {
 			return;
 		}
 		if ( ! TracTickets::isTracTicketClosed( 'https://core.trac.wordpress.org', $ticket_id ) ) {
@@ -721,7 +830,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param int $ticket_id Ticket number.
 	 */
-	function knownUTBug( $ticket_id ) {
+	public function knownUTBug( $ticket_id ) {
 		return;
 	}
 
@@ -732,8 +841,8 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param int $ticket_id Ticket number.
 	 */
-	function knownPluginBug( $ticket_id ) {
-		if ( WP_TESTS_FORCE_KNOWN_BUGS || in_array( 'Plugin' . $ticket_id, self::$forced_tickets ) ) {
+	public function knownPluginBug( $ticket_id ) {
+		if ( WP_TESTS_FORCE_KNOWN_BUGS || in_array( 'Plugin' . $ticket_id, self::$forced_tickets, true ) ) {
 			return;
 		}
 		if ( ! TracTickets::isTracTicketClosed( 'https://plugins.trac.wordpress.org', $ticket_id ) ) {
@@ -760,9 +869,9 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * This method defines the constants after including files.
 	 *
-	 * @param Text_Template $template
+	 * @param Text_Template $template The template to prepare.
 	 */
-	function prepareTemplate( Text_Template $template ) {
+	public function prepareTemplate( Text_Template $template ) {
 		$template->setVar( array( 'constants' => '' ) );
 		$template->setVar( array( 'wp_constants' => PHPUnit_Util_GlobalState::getConstantsAsString() ) );
 		parent::prepareTemplate( $template );
@@ -777,7 +886,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @return string|bool Path on success, else false.
 	 */
-	function temp_filename() {
+	public function temp_filename() {
 		$tmp_dir = '';
 		$dirs    = array( 'TMP', 'TMPDIR', 'TEMP' );
 		foreach ( $dirs as $dir ) {
@@ -797,17 +906,20 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * Checks each of the WP_Query is_* functions/properties against expected boolean value.
 	 *
 	 * Any properties that are listed by name as parameters will be expected to be true; all others are
-	 * expected to be false. For example, assertQueryTrue('is_single', 'is_feed') means is_single()
+	 * expected to be false. For example, assertQueryTrue( 'is_single', 'is_feed' ) means is_single()
 	 * and is_feed() must be true and everything else must be false to pass.
 	 *
 	 * @since 2.5.0
 	 * @since 3.8.0 Moved from `Tests_Query_Conditionals` to `WP_UnitTestCase`.
+	 * @since 5.3.0 Formalized the existing `...$prop` parameter by adding it
+	 *              to the function signature.
 	 *
-	 * @param string $prop,... Any number of WP_Query properties that are expected to be true for the current request.
+	 * @param string ...$prop Any number of WP_Query properties that are expected to be true for the current request.
 	 */
-	function assertQueryTrue() {
+	public function assertQueryTrue( ...$prop ) {
 		global $wp_query;
-		$all  = array(
+
+		$all = array(
 			'is_404',
 			'is_admin',
 			'is_archive',
@@ -821,6 +933,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 			'is_feed',
 			'is_front_page',
 			'is_home',
+			'is_privacy_policy',
 			'is_month',
 			'is_page',
 			'is_paged',
@@ -837,9 +950,8 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 			'is_trackback',
 			'is_year',
 		);
-		$true = func_get_args();
 
-		foreach ( $true as $true_thing ) {
+		foreach ( $prop as $true_thing ) {
 			$this->assertContains( $true_thing, $all, "Unknown conditional: {$true_thing}." );
 		}
 
@@ -849,7 +961,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		foreach ( $all as $query_thing ) {
 			$result = is_callable( $query_thing ) ? call_user_func( $query_thing ) : $wp_query->$query_thing;
 
-			if ( in_array( $query_thing, $true ) ) {
+			if ( in_array( $query_thing, $prop, true ) ) {
 				if ( ! $result ) {
 					$message .= $query_thing . ' is false but is expected to be true. ' . PHP_EOL;
 					$passed   = false;
@@ -872,9 +984,9 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param string $file File path.
 	 */
-	function unlink( $file ) {
+	public function unlink( $file ) {
 		$exists = is_file( $file );
-		if ( $exists && ! in_array( $file, self::$ignore_files ) ) {
+		if ( $exists && ! in_array( $file, self::$ignore_files, true ) ) {
 			//error_log( $file );
 			unlink( $file );
 		} elseif ( ! $exists ) {
@@ -889,10 +1001,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param string $path Directory path.
 	 */
-	function rmdir( $path ) {
+	public function rmdir( $path ) {
 		$files = $this->files_in_dir( $path );
 		foreach ( $files as $file ) {
-			if ( ! in_array( $file, self::$ignore_files ) ) {
+			if ( ! in_array( $file, self::$ignore_files, true ) ) {
 				$this->unlink( $file );
 			}
 		}
@@ -907,7 +1019,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * - `rmdir()` and its helper methods only delete files that are not listed in the `$ignore_files` property. If
 	 *   called during `tearDown()` in tests, this will only delete files added during the previously run test.
 	 */
-	function remove_added_uploads() {
+	public function remove_added_uploads() {
 		$uploads = wp_upload_dir();
 		$this->rmdir( $uploads['basedir'] );
 	}
@@ -918,10 +1030,9 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @since 4.0.0
 	 *
 	 * @param string $dir Path to the directory to scan.
-	 *
 	 * @return array List of file paths.
 	 */
-	function files_in_dir( $dir ) {
+	public function files_in_dir( $dir ) {
 		$files = array();
 
 		$iterator = new RecursiveDirectoryIterator( $dir );
@@ -942,7 +1053,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @return array List of file paths.
 	 */
-	function scan_user_uploads() {
+	public function scan_user_uploads() {
 		static $files = array();
 		if ( ! empty( $files ) ) {
 			return $files;
@@ -960,7 +1071,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param string $path Path to the directory to scan.
 	 */
-	function delete_folders( $path ) {
+	public function delete_folders( $path ) {
 		$this->matched_dirs = array();
 		if ( ! is_dir( $path ) ) {
 			return;
@@ -983,7 +1094,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param string $dir Path to the directory to scan.
 	 */
-	function scandir( $dir ) {
+	public function scandir( $dir ) {
 		foreach ( scandir( $dir ) as $path ) {
 			if ( 0 !== strpos( $path, '.' ) && is_dir( $dir . '/' . $path ) ) {
 				$this->matched_dirs[] = $dir . '/' . $path;
@@ -998,7 +1109,6 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @since 4.1.0
 	 *
 	 * @param string $microtime Time string generated by `microtime()`.
-	 *
 	 * @return float `microtime()` output as a float.
 	 */
 	protected function _microtime_to_float( $microtime ) {
@@ -1012,15 +1122,14 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 * @since 4.3.0
 	 *
 	 * @param int $user_id User ID.
-	 *
 	 * @return bool True if the user was deleted.
 	 */
 	public static function delete_user( $user_id ) {
 		if ( is_multisite() ) {
 			return wpmu_delete_user( $user_id );
-		} else {
-			return wp_delete_user( $user_id );
 		}
+
+		return wp_delete_user( $user_id );
 	}
 
 	/**
@@ -1047,10 +1156,9 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param array $upload         Array of information about the uploaded file, provided by wp_upload_bits().
 	 * @param int   $parent_post_id Optional. Parent post ID.
-	 *
 	 * @return int|WP_Error The attachment ID on success. The value 0 or WP_Error on failure.
 	 */
-	function _make_attachment( $upload, $parent_post_id = 0 ) {
+	public function _make_attachment( $upload, $parent_post_id = 0 ) {
 		$type = '';
 		if ( ! empty( $upload['type'] ) ) {
 			$type = $upload['type'];
@@ -1062,7 +1170,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 		}
 
 		$attachment = array(
-			'post_title'     => basename( $upload['file'] ),
+			'post_title'     => wp_basename( $upload['file'] ),
 			'post_content'   => '',
 			'post_type'      => 'attachment',
 			'post_parent'    => $parent_post_id,
@@ -1084,7 +1192,6 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Framework_TestCase {
 	 *
 	 * @param int    $post_id Post ID.
 	 * @param string $date    Post date, in the format YYYY-MM-DD HH:MM:SS.
-	 *
 	 * @return int|false 1 on success, or false on error.
 	 */
 	protected function update_post_modified( $post_id, $date ) {
diff --git a/includes/bootstrap.php b/includes/bootstrap.php
index 0390d62312..97003ae7ff 100644
--- a/includes/bootstrap.php
+++ b/includes/bootstrap.php
@@ -24,7 +24,7 @@ if ( defined( 'WP_TESTS_CONFIG_FILE_PATH' ) ) {
 }
 
 /*
- * Globalize some WordPress variables, because PHPUnit loads this file inside a function
+ * Globalize some WordPress variables, because PHPUnit loads this file inside a function.
  * See: https://github.com/sebastianbergmann/phpunit/issues/325
  */
 global $wpdb, $current_site, $current_blog, $wp_rewrite, $shortcode_tags, $wp, $phpmailer, $wp_theme_directories;
@@ -33,6 +33,7 @@ if ( ! is_readable( $config_file_path ) ) {
 	echo "ERROR: wp-tests-config.php is missing! Please use wp-tests-config-sample.php to create a config file.\n";
 	exit( 1 );
 }
+
 require_once $config_file_path;
 require_once dirname( __FILE__ ) . '/functions.php';
 
@@ -45,6 +46,11 @@ if ( version_compare( tests_get_phpunit_version(), '8.0', '>=' ) ) {
 	exit( 1 );
 }
 
+if ( defined( 'WP_RUN_CORE_TESTS' ) && WP_RUN_CORE_TESTS && ! is_dir( ABSPATH ) ) {
+	echo "ERROR: The /build/ directory is missing! Please run `npm run build` prior to running PHPUnit.\n";
+	exit( 1 );
+}
+
 tests_reset__SERVER();
 
 define( 'WP_TESTS_TABLE_PREFIX', $table_prefix );
@@ -57,7 +63,10 @@ if ( ! defined( 'WP_TESTS_FORCE_KNOWN_BUGS' ) ) {
 	define( 'WP_TESTS_FORCE_KNOWN_BUGS', false );
 }
 
-// Cron tries to make an HTTP request to the blog, which always fails, because tests are run in CLI mode only
+/*
+ * Cron tries to make an HTTP request to the site, which always fails,
+ * because tests are run in CLI mode only.
+ */
 define( 'DISABLE_WP_CRON', true );
 
 define( 'WP_MEMORY_LIMIT', -1 );
@@ -65,10 +74,12 @@ define( 'WP_MAX_MEMORY_LIMIT', -1 );
 
 define( 'REST_TESTS_IMPOSSIBLY_HIGH_NUMBER', 99999999 );
 
-$PHP_SELF = $GLOBALS['PHP_SELF'] = $_SERVER['PHP_SELF'] = '/index.php';
+$PHP_SELF            = '/index.php';
+$GLOBALS['PHP_SELF'] = '/index.php';
+$_SERVER['PHP_SELF'] = '/index.php';
 
 // Should we run in multisite mode?
-$multisite = '1' == getenv( 'WP_MULTISITE' );
+$multisite = ( '1' === getenv( 'WP_MULTISITE' ) );
 $multisite = $multisite || ( defined( 'WP_TESTS_MULTISITE' ) && WP_TESTS_MULTISITE );
 $multisite = $multisite || ( defined( 'MULTISITE' ) && MULTISITE );
 
@@ -183,7 +194,7 @@ class WP_PHPUnit_Util_Getopt {
 					}
 
 					foreach ( $skipped_groups as $group_name => $skipped ) {
-						if ( in_array( $group_name, $groups ) ) {
+						if ( in_array( $group_name, $groups, true ) ) {
 							$skipped_groups[ $group_name ] = false;
 						}
 					}
diff --git a/includes/class-basic-object.php b/includes/class-basic-object.php
index f773c94ca1..6165344bde 100644
--- a/includes/class-basic-object.php
+++ b/includes/class-basic-object.php
@@ -7,8 +7,6 @@
  * @since 4.7.0
  */
 
-trigger_error( __FILE__ . ' is deprecated since version 5.0.0 with no alternative available.' );
-
 /**
  * Class used to test accessing methods and properties
  *
@@ -37,6 +35,7 @@ class Basic_Object {
 		return call_user_func_array( array( $this, $name ), $arguments );
 	}
 
+	// phpcs:ignore WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
 	private function callMe() {
 		return 'maybe';
 	}
diff --git a/includes/class-jsonserializable-object.php b/includes/class-jsonserializable-object.php
new file mode 100644
index 0000000000..eb4ae5c3af
--- /dev/null
+++ b/includes/class-jsonserializable-object.php
@@ -0,0 +1,21 @@
+<?php
+/**
+ * Unit Tests: JsonSerializable_Object
+ *
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 5.3.0
+ */
+
+class JsonSerializable_Object implements JsonSerializable {
+
+	private $data;
+
+	public function __construct( $data ) {
+		$this->data = $data;
+	}
+
+	public function jsonSerialize() {
+		return $this->data;
+	}
+}
diff --git a/includes/factory/class-wp-unittest-factory-callback-after-create.php b/includes/factory/class-wp-unittest-factory-callback-after-create.php
index 9b00e7279a..8becb3239f 100644
--- a/includes/factory/class-wp-unittest-factory-callback-after-create.php
+++ b/includes/factory/class-wp-unittest-factory-callback-after-create.php
@@ -5,14 +5,14 @@ class WP_UnitTest_Factory_Callback_After_Create {
 	/**
 	 * @var callable
 	 */
-	var $callback;
+	public $callback;
 
 	/**
 	 * WP_UnitTest_Factory_Callback_After_Create constructor.
 	 *
 	 * @param callable $callback A callback function.
 	 */
-	function __construct( $callback ) {
+	public function __construct( $callback ) {
 		$this->callback = $callback;
 	}
 
@@ -23,7 +23,7 @@ class WP_UnitTest_Factory_Callback_After_Create {
 	 *
 	 * @return mixed The possibly altered object.
 	 */
-	function call( $object ) {
+	public function call( $object ) {
 		return call_user_func( $this->callback, $object );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory-for-attachment.php b/includes/factory/class-wp-unittest-factory-for-attachment.php
index d9072fcb9d..98f1be8fde 100644
--- a/includes/factory/class-wp-unittest-factory-for-attachment.php
+++ b/includes/factory/class-wp-unittest-factory-for-attachment.php
@@ -16,7 +16,7 @@ class WP_UnitTest_Factory_For_Attachment extends WP_UnitTest_Factory_For_Post {
 	 *
 	 * @return  int|WP_Error The attachment ID on success. The value 0 or WP_Error on failure.
 	 */
-	function create_object( $args, $legacy_parent = 0, $legacy_args = array() ) {
+	public function create_object( $args, $legacy_parent = 0, $legacy_args = array() ) {
 		// Backward compatibility for legacy argument format.
 		if ( is_string( $args ) ) {
 			$file                = $args;
@@ -44,9 +44,9 @@ class WP_UnitTest_Factory_For_Attachment extends WP_UnitTest_Factory_For_Post {
 	 *
 	 * @return int|WP_Error The attachment ID on success. The value 0 or WP_Error on failure.
 	 */
-	function create_upload_object( $file, $parent = 0 ) {
+	public function create_upload_object( $file, $parent = 0 ) {
 		$contents = file_get_contents( $file );
-		$upload   = wp_upload_bits( basename( $file ), null, $contents );
+		$upload   = wp_upload_bits( wp_basename( $file ), null, $contents );
 
 		$type = '';
 		if ( ! empty( $upload['type'] ) ) {
@@ -59,7 +59,7 @@ class WP_UnitTest_Factory_For_Attachment extends WP_UnitTest_Factory_For_Post {
 		}
 
 		$attachment = array(
-			'post_title'     => basename( $upload['file'] ),
+			'post_title'     => wp_basename( $upload['file'] ),
 			'post_content'   => '',
 			'post_type'      => 'attachment',
 			'post_parent'    => $parent,
diff --git a/includes/factory/class-wp-unittest-factory-for-blog.php b/includes/factory/class-wp-unittest-factory-for-blog.php
index 5a5b5d3718..68d24d30bb 100644
--- a/includes/factory/class-wp-unittest-factory-for-blog.php
+++ b/includes/factory/class-wp-unittest-factory-for-blog.php
@@ -12,7 +12,7 @@
  */
 class WP_UnitTest_Factory_For_Blog extends WP_UnitTest_Factory_For_Thing {
 
-	function __construct( $factory = null ) {
+	public function __construct( $factory = null ) {
 		global $current_site, $base;
 		parent::__construct( $factory );
 		$this->default_generation_definitions = array(
@@ -30,7 +30,7 @@ class WP_UnitTest_Factory_For_Blog extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int|WP_Error Returns WP_Error object on failure, the site ID on success.
 	 */
-	function create_object( $args ) {
+	public function create_object( $args ) {
 		global $wpdb;
 		$meta    = isset( $args['meta'] ) ? $args['meta'] : array( 'public' => 1 );
 		$user_id = isset( $args['user_id'] ) ? $args['user_id'] : get_current_user_id();
@@ -53,7 +53,7 @@ class WP_UnitTest_Factory_For_Blog extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return void
 	 */
-	function update_object( $blog_id, $fields ) {}
+	public function update_object( $blog_id, $fields ) {}
 
 	/**
 	 * Retrieves a site by given blog id.
@@ -62,7 +62,7 @@ class WP_UnitTest_Factory_For_Blog extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return null|WP_Site The site object or null if not found.
 	 */
-	function get_object_by_id( $blog_id ) {
+	public function get_object_by_id( $blog_id ) {
 		return get_site( $blog_id );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory-for-comment.php b/includes/factory/class-wp-unittest-factory-for-comment.php
index 4ca3b2fd6d..dcec0439aa 100644
--- a/includes/factory/class-wp-unittest-factory-for-comment.php
+++ b/includes/factory/class-wp-unittest-factory-for-comment.php
@@ -12,7 +12,7 @@
  */
 class WP_UnitTest_Factory_For_Comment extends WP_UnitTest_Factory_For_Thing {
 
-	function __construct( $factory = null ) {
+	public function __construct( $factory = null ) {
 		parent::__construct( $factory );
 		$this->default_generation_definitions = array(
 			'comment_author'     => new WP_UnitTest_Generator_Sequence( 'Commenter %s' ),
@@ -29,7 +29,7 @@ class WP_UnitTest_Factory_For_Comment extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return false|int The comment's ID on success, false on failure.
 	 */
-	function create_object( $args ) {
+	public function create_object( $args ) {
 		return wp_insert_comment( $this->addslashes_deep( $args ) );
 	}
 
@@ -41,7 +41,7 @@ class WP_UnitTest_Factory_For_Comment extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int When updated 1, not update 0.
 	 */
-	function update_object( $comment_id, $fields ) {
+	public function update_object( $comment_id, $fields ) {
 		$fields['comment_ID'] = $comment_id;
 		return wp_update_comment( $this->addslashes_deep( $fields ) );
 	}
@@ -56,7 +56,7 @@ class WP_UnitTest_Factory_For_Comment extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int[] Array with the comment ids.
 	 */
-	function create_post_comments( $post_id, $count = 1, $args = array(), $generation_definitions = null ) {
+	public function create_post_comments( $post_id, $count = 1, $args = array(), $generation_definitions = null ) {
 		$args['comment_post_ID'] = $post_id;
 		return $this->create_many( $count, $args, $generation_definitions );
 	}
@@ -68,7 +68,7 @@ class WP_UnitTest_Factory_For_Comment extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return null|WP_Comment WP_Comment when found, null when not found.
 	 */
-	function get_object_by_id( $comment_id ) {
+	public function get_object_by_id( $comment_id ) {
 		return get_comment( $comment_id );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory-for-network.php b/includes/factory/class-wp-unittest-factory-for-network.php
index c10faf51dd..419957e0f9 100644
--- a/includes/factory/class-wp-unittest-factory-for-network.php
+++ b/includes/factory/class-wp-unittest-factory-for-network.php
@@ -12,7 +12,7 @@
  */
 class WP_UnitTest_Factory_For_Network extends WP_UnitTest_Factory_For_Thing {
 
-	function __construct( $factory = null ) {
+	public function __construct( $factory = null ) {
 		parent::__construct( $factory );
 		$this->default_generation_definitions = array(
 			'domain'            => WP_TESTS_DOMAIN,
@@ -23,7 +23,7 @@ class WP_UnitTest_Factory_For_Network extends WP_UnitTest_Factory_For_Thing {
 		);
 	}
 
-	function create_object( $args ) {
+	public function create_object( $args ) {
 		require_once ABSPATH . 'wp-admin/includes/upgrade.php';
 
 		if ( ! isset( $args['user'] ) ) {
@@ -36,9 +36,9 @@ class WP_UnitTest_Factory_For_Network extends WP_UnitTest_Factory_For_Thing {
 		return $args['network_id'];
 	}
 
-	function update_object( $network_id, $fields ) {}
+	public function update_object( $network_id, $fields ) {}
 
-	function get_object_by_id( $network_id ) {
+	public function get_object_by_id( $network_id ) {
 		return get_network( $network_id );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory-for-post.php b/includes/factory/class-wp-unittest-factory-for-post.php
index e56ca0f191..af71802d5f 100644
--- a/includes/factory/class-wp-unittest-factory-for-post.php
+++ b/includes/factory/class-wp-unittest-factory-for-post.php
@@ -12,7 +12,7 @@
  */
 class WP_UnitTest_Factory_For_Post extends WP_UnitTest_Factory_For_Thing {
 
-	function __construct( $factory = null ) {
+	public function __construct( $factory = null ) {
 		parent::__construct( $factory );
 		$this->default_generation_definitions = array(
 			'post_status'  => 'publish',
@@ -30,7 +30,7 @@ class WP_UnitTest_Factory_For_Post extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int|WP_Error The post ID on success. The value 0 or WP_Error on failure.
 	 */
-	function create_object( $args ) {
+	public function create_object( $args ) {
 		return wp_insert_post( $args );
 	}
 
@@ -42,7 +42,7 @@ class WP_UnitTest_Factory_For_Post extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int|WP_Error The value 0 or WP_Error on failure. The post ID on success.
 	 */
-	function update_object( $post_id, $fields ) {
+	public function update_object( $post_id, $fields ) {
 		$fields['ID'] = $post_id;
 		return wp_update_post( $fields );
 	}
@@ -54,7 +54,7 @@ class WP_UnitTest_Factory_For_Post extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return null|WP_Post WP_Post on success or null on failure.
 	 */
-	function get_object_by_id( $post_id ) {
+	public function get_object_by_id( $post_id ) {
 		return get_post( $post_id );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory-for-term.php b/includes/factory/class-wp-unittest-factory-for-term.php
index 76c1aac14b..06340c852b 100644
--- a/includes/factory/class-wp-unittest-factory-for-term.php
+++ b/includes/factory/class-wp-unittest-factory-for-term.php
@@ -14,7 +14,7 @@ class WP_UnitTest_Factory_For_Term extends WP_UnitTest_Factory_For_Thing {
 	private $taxonomy;
 	const DEFAULT_TAXONOMY = 'post_tag';
 
-	function __construct( $factory = null, $taxonomy = null ) {
+	public function __construct( $factory = null, $taxonomy = null ) {
 		parent::__construct( $factory );
 		$this->taxonomy                       = $taxonomy ? $taxonomy : self::DEFAULT_TAXONOMY;
 		$this->default_generation_definitions = array(
@@ -31,7 +31,7 @@ class WP_UnitTest_Factory_For_Term extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return array|WP_Error
 	 */
-	function create_object( $args ) {
+	public function create_object( $args ) {
 		$args         = array_merge( array( 'taxonomy' => $this->taxonomy ), $args );
 		$term_id_pair = wp_insert_term( $args['name'], $args['taxonomy'], $args );
 		if ( is_wp_error( $term_id_pair ) ) {
@@ -48,7 +48,7 @@ class WP_UnitTest_Factory_For_Term extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int The term id.
 	 */
-	function update_object( $term, $fields ) {
+	public function update_object( $term, $fields ) {
 		$fields = array_merge( array( 'taxonomy' => $this->taxonomy ), $fields );
 		if ( is_object( $term ) ) {
 			$taxonomy = $term->taxonomy;
@@ -71,7 +71,7 @@ class WP_UnitTest_Factory_For_Term extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return array|false|WP_Error Array of term taxonomy IDs of affected terms. WP_Error or false on failure.
 	 */
-	function add_post_terms( $post_id, $terms, $taxonomy, $append = true ) {
+	public function add_post_terms( $post_id, $terms, $taxonomy, $append = true ) {
 		return wp_set_post_terms( $post_id, $terms, $taxonomy, $append );
 	}
 
@@ -83,8 +83,13 @@ class WP_UnitTest_Factory_For_Term extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return null|WP_Error|WP_Term WP_Term on success. WP_error if taxonomy does not exist. Null for miscellaneous failure.
 	 */
-	function create_and_get( $args = array(), $generation_definitions = null ) {
-		$term_id  = $this->create( $args, $generation_definitions );
+	public function create_and_get( $args = array(), $generation_definitions = null ) {
+		$term_id = $this->create( $args, $generation_definitions );
+
+		if ( is_wp_error( $term_id ) ) {
+			return $term_id;
+		}
+
 		$taxonomy = isset( $args['taxonomy'] ) ? $args['taxonomy'] : $this->taxonomy;
 		return get_term( $term_id, $taxonomy );
 	}
@@ -96,7 +101,7 @@ class WP_UnitTest_Factory_For_Term extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return null|WP_Error|WP_Term WP_Term on success. WP_error if taxonomy does not exist. Null for miscellaneous failure.
 	 */
-	function get_object_by_id( $term_id ) {
+	public function get_object_by_id( $term_id ) {
 		return get_term( $term_id, $this->taxonomy );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory-for-thing.php b/includes/factory/class-wp-unittest-factory-for-thing.php
index 5ae495967d..2ae24a1f95 100644
--- a/includes/factory/class-wp-unittest-factory-for-thing.php
+++ b/includes/factory/class-wp-unittest-factory-for-thing.php
@@ -5,8 +5,8 @@
  */
 abstract class WP_UnitTest_Factory_For_Thing {
 
-	var $default_generation_definitions;
-	var $factory;
+	public $default_generation_definitions;
+	public $factory;
 
 	/**
 	 * Creates a new factory, which will create objects of a specific Thing
@@ -16,7 +16,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 * can be generators -- an object with next() method. There are some default generators: {@link WP_UnitTest_Generator_Sequence},
 	 * {@link WP_UnitTest_Generator_Locale_Name}, {@link WP_UnitTest_Factory_Callback_After_Create}.
 	 */
-	function __construct( $factory, $default_generation_definitions = array() ) {
+	public function __construct( $factory, $default_generation_definitions = array() ) {
 		$this->factory                        = $factory;
 		$this->default_generation_definitions = $default_generation_definitions;
 	}
@@ -28,7 +28,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return mixed The result. Can be anything.
 	 */
-	abstract function create_object( $args );
+	abstract public function create_object( $args );
 
 	/**
 	 * Updates an existing object.
@@ -38,7 +38,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return mixed The result. Can be anything.
 	 */
-	abstract function update_object( $object, $fields );
+	abstract public function update_object( $object, $fields );
 
 	/**
 	 * Creates an object.
@@ -48,7 +48,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return mixed The result. Can be anything.
 	 */
-	function create( $args = array(), $generation_definitions = null ) {
+	public function create( $args = array(), $generation_definitions = null ) {
 		if ( is_null( $generation_definitions ) ) {
 			$generation_definitions = $this->default_generation_definitions;
 		}
@@ -77,8 +77,13 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return mixed The created object. Can be anything.
 	 */
-	function create_and_get( $args = array(), $generation_definitions = null ) {
+	public function create_and_get( $args = array(), $generation_definitions = null ) {
 		$object_id = $this->create( $args, $generation_definitions );
+
+		if ( is_wp_error( $object_id ) ) {
+			return $object_id;
+		}
+
 		return $this->get_object_by_id( $object_id );
 	}
 
@@ -89,7 +94,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return mixed The object. Can be anything.
 	 */
-	abstract function get_object_by_id( $object_id );
+	abstract public function get_object_by_id( $object_id );
 
 	/**
 	 * Creates multiple objects.
@@ -100,7 +105,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return array
 	 */
-	function create_many( $count, $args = array(), $generation_definitions = null ) {
+	public function create_many( $count, $args = array(), $generation_definitions = null ) {
 		$results = array();
 		for ( $i = 0; $i < $count; $i++ ) {
 			$results[] = $this->create( $args, $generation_definitions );
@@ -118,7 +123,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return array|WP_Error Combined array on success. WP_Error when default value is incorrent.
 	 */
-	function generate_args( $args = array(), $generation_definitions = null, &$callbacks = null ) {
+	public function generate_args( $args = array(), $generation_definitions = null, &$callbacks = null ) {
 		$callbacks = array();
 		if ( is_null( $generation_definitions ) ) {
 			$generation_definitions = $this->default_generation_definitions;
@@ -155,7 +160,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return array The altered fields.
 	 */
-	function apply_callbacks( $callbacks, $created ) {
+	public function apply_callbacks( $callbacks, $created ) {
 		$updated_fields = array();
 
 		foreach ( $callbacks as $field_name => $generator ) {
@@ -171,7 +176,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return WP_UnitTest_Factory_Callback_After_Create
 	 */
-	function callback( $function ) {
+	public function callback( $function ) {
 		return new WP_UnitTest_Factory_Callback_After_Create( $function );
 	}
 
@@ -182,7 +187,7 @@ abstract class WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return array|string The value with the possibly applied slashes.
 	 */
-	function addslashes_deep( $value ) {
+	public function addslashes_deep( $value ) {
 		if ( is_array( $value ) ) {
 			$value = array_map( array( $this, 'addslashes_deep' ), $value );
 		} elseif ( is_object( $value ) ) {
diff --git a/includes/factory/class-wp-unittest-factory-for-user.php b/includes/factory/class-wp-unittest-factory-for-user.php
index 2b32a33c09..3a22ba08d7 100644
--- a/includes/factory/class-wp-unittest-factory-for-user.php
+++ b/includes/factory/class-wp-unittest-factory-for-user.php
@@ -12,7 +12,7 @@
  */
 class WP_UnitTest_Factory_For_User extends WP_UnitTest_Factory_For_Thing {
 
-	function __construct( $factory = null ) {
+	public function __construct( $factory = null ) {
 		parent::__construct( $factory );
 		$this->default_generation_definitions = array(
 			'user_login' => new WP_UnitTest_Generator_Sequence( 'User %s' ),
@@ -28,7 +28,7 @@ class WP_UnitTest_Factory_For_User extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int|WP_Error
 	 */
-	function create_object( $args ) {
+	public function create_object( $args ) {
 		return wp_insert_user( $args );
 	}
 
@@ -40,7 +40,7 @@ class WP_UnitTest_Factory_For_User extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return int|WP_Error User id on success. WP_Error on failure.
 	 */
-	function update_object( $user_id, $fields ) {
+	public function update_object( $user_id, $fields ) {
 		$fields['ID'] = $user_id;
 		return wp_update_user( $fields );
 	}
@@ -52,7 +52,7 @@ class WP_UnitTest_Factory_For_User extends WP_UnitTest_Factory_For_Thing {
 	 *
 	 * @return WP_User The user.
 	 */
-	function get_object_by_id( $user_id ) {
+	public function get_object_by_id( $user_id ) {
 		return new WP_User( $user_id );
 	}
 }
diff --git a/includes/factory/class-wp-unittest-factory.php b/includes/factory/class-wp-unittest-factory.php
index 268013d899..3b74092e62 100644
--- a/includes/factory/class-wp-unittest-factory.php
+++ b/includes/factory/class-wp-unittest-factory.php
@@ -58,7 +58,7 @@ class WP_UnitTest_Factory {
 	 */
 	public $network;
 
-	function __construct() {
+	public function __construct() {
 		$this->post       = new WP_UnitTest_Factory_For_Post( $this );
 		$this->attachment = new WP_UnitTest_Factory_For_Attachment( $this );
 		$this->comment    = new WP_UnitTest_Factory_For_Comment( $this );
diff --git a/includes/factory/class-wp-unittest-generator-sequence.php b/includes/factory/class-wp-unittest-generator-sequence.php
index 5323c610d1..5c0778f3d4 100644
--- a/includes/factory/class-wp-unittest-generator-sequence.php
+++ b/includes/factory/class-wp-unittest-generator-sequence.php
@@ -5,7 +5,7 @@ class WP_UnitTest_Generator_Sequence {
 	public $next;
 	public $template_string;
 
-	function __construct( $template_string = '%s', $start = null ) {
+	public function __construct( $template_string = '%s', $start = null ) {
 		if ( $start ) {
 			$this->next = $start;
 		} else {
@@ -15,7 +15,7 @@ class WP_UnitTest_Generator_Sequence {
 		$this->template_string = $template_string;
 	}
 
-	function next() {
+	public function next() {
 		$generated = sprintf( $this->template_string, $this->next );
 		$this->next++;
 		return $generated;
diff --git a/includes/functions.php b/includes/functions.php
index d9f1f95cac..f4491b7a77 100644
--- a/includes/functions.php
+++ b/includes/functions.php
@@ -1,7 +1,10 @@
 <?php
+require_once __DIR__ . '/class-basic-object.php';
 
 /**
  * Retrieves PHPUnit runner version.
+ *
+ * @return double The version number.
  */
 function tests_get_phpunit_version() {
 	if ( class_exists( 'PHPUnit_Runner_Version' ) ) {
@@ -19,7 +22,7 @@ function tests_get_phpunit_version() {
 /**
  * Resets various `$_SERVER` variables that can get altered during tests.
  */
-function tests_reset__SERVER() {
+function tests_reset__SERVER() { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName.FunctionNameInvalid
 	$_SERVER['HTTP_HOST']       = WP_TESTS_DOMAIN;
 	$_SERVER['REMOTE_ADDR']     = '127.0.0.1';
 	$_SERVER['REQUEST_METHOD']  = 'GET';
@@ -98,6 +101,7 @@ function _delete_all_data() {
 		$wpdb->term_relationships,
 		$wpdb->termmeta,
 	) as $table ) {
+		//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DELETE FROM {$table}" );
 	}
 
@@ -105,6 +109,7 @@ function _delete_all_data() {
 		$wpdb->terms,
 		$wpdb->term_taxonomy,
 	) as $table ) {
+		//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DELETE FROM {$table} WHERE term_id != 1" );
 	}
 
@@ -134,6 +139,13 @@ function _delete_all_posts() {
 	}
 }
 
+/**
+ * Handles the WP die handler by outputting the given values as text.
+ *
+ * @param string $message The message.
+ * @param string $title   The title.
+ * @param array  $args    Array with arguments.
+ */
 function _wp_die_handler( $message, $title = '', $args = array() ) {
 	if ( ! $GLOBALS['_wp_die_disabled'] ) {
 		_wp_die_handler_txt( $message, $title, $args );
@@ -142,22 +154,45 @@ function _wp_die_handler( $message, $title = '', $args = array() ) {
 	}
 }
 
+/**
+ * Disables the WP die handler.
+ */
 function _disable_wp_die() {
 	$GLOBALS['_wp_die_disabled'] = true;
 }
 
+/**
+ * Enables the WP die handler.
+ */
 function _enable_wp_die() {
 	$GLOBALS['_wp_die_disabled'] = false;
 }
 
+/**
+ * Returns the die handler.
+ *
+ * @return string The die handler.
+ */
 function _wp_die_handler_filter() {
 	return '_wp_die_handler';
 }
 
+/**
+ * Returns the die handler.
+ *
+ * @return string The die handler.
+ */
 function _wp_die_handler_filter_exit() {
 	return '_wp_die_handler_exit';
 }
 
+/**
+ * Dies without an exit.
+ *
+ * @param string $message The message.
+ * @param string $title   The title.
+ * @param array  $args    Array with arguments.
+ */
 function _wp_die_handler_txt( $message, $title, $args ) {
 	echo "\nwp_die called\n";
 	echo "Message : $message\n";
@@ -170,6 +205,13 @@ function _wp_die_handler_txt( $message, $title, $args ) {
 	}
 }
 
+/**
+ * Dies with an exit.
+ *
+ * @param string $message The message.
+ * @param string $title   The title.
+ * @param array  $args    Array with arguments.
+ */
 function _wp_die_handler_exit( $message, $title, $args ) {
 	echo "\nwp_die called\n";
 	echo "Message : $message\n";
@@ -197,6 +239,8 @@ function _set_default_permalink_structure_for_tests() {
 
 /**
  * Helper used with the `upload_dir` filter to remove the /year/month sub directories from the uploads path and URL.
+ *
+ * @return array The altered array.
  */
 function _upload_dir_no_subdir( $uploads ) {
 	$subdir = $uploads['subdir'];
@@ -210,6 +254,8 @@ function _upload_dir_no_subdir( $uploads ) {
 
 /**
  * Helper used with the `upload_dir` filter to set https upload URL.
+ *
+ * @return array The altered array.
  */
 function _upload_dir_https( $uploads ) {
 	$uploads['url']     = str_replace( 'http://', 'https://', $uploads['url'] );
@@ -220,6 +266,8 @@ function _upload_dir_https( $uploads ) {
 
 /**
  * Use the Spy_REST_Server class for the REST server.
+ *
+ * @return string The server class name.
  */
 function _wp_rest_server_class_filter() {
 	return 'Spy_REST_Server';
@@ -237,8 +285,15 @@ tests_add_filter( 'send_auth_cookies', '__return_false' );
  */
 function _unhook_block_registration() {
 	remove_action( 'init', 'register_block_core_archives' );
+	remove_action( 'init', 'register_block_core_block' );
+	remove_action( 'init', 'register_block_core_calendar' );
 	remove_action( 'init', 'register_block_core_categories' );
+	remove_action( 'init', 'register_block_core_latest_comments' );
 	remove_action( 'init', 'register_block_core_latest_posts' );
+	remove_action( 'init', 'register_block_core_rss' );
+	remove_action( 'init', 'register_block_core_search' );
 	remove_action( 'init', 'register_block_core_shortcode' );
+	remove_action( 'init', 'register_block_core_social_link' );
+	remove_action( 'init', 'register_block_core_tag_cloud' );
 }
 tests_add_filter( 'init', '_unhook_block_registration', 1000 );
diff --git a/includes/install.php b/includes/install.php
index 45c0d60f83..d07079e501 100644
--- a/includes/install.php
+++ b/includes/install.php
@@ -20,7 +20,9 @@ if ( ! defined( 'WP_DEFAULT_THEME' ) ) {
 
 tests_reset__SERVER();
 
-$PHP_SELF = $GLOBALS['PHP_SELF'] = $_SERVER['PHP_SELF'] = '/index.php';
+$PHP_SELF            = '/index.php';
+$GLOBALS['PHP_SELF'] = '/index.php';
+$_SERVER['PHP_SELF'] = '/index.php';
 
 tests_add_filter( 'wp_die_handler', '_wp_die_handler_filter_exit' );
 
@@ -51,10 +53,12 @@ echo 'Installing...' . PHP_EOL;
 
 $wpdb->query( 'SET foreign_key_checks = 0' );
 foreach ( $wpdb->tables() as $table => $prefixed_table ) {
+	//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 	$wpdb->query( "DROP TABLE IF EXISTS $prefixed_table" );
 }
 
 foreach ( $wpdb->tables( 'ms_global' ) as $table => $prefixed_table ) {
+	//phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 	$wpdb->query( "DROP TABLE IF EXISTS $prefixed_table" );
 
 	// We need to create references to ms global tables.
diff --git a/includes/mock-fs.php b/includes/mock-fs.php
index b0b24d1a24..8794c07257 100644
--- a/includes/mock-fs.php
+++ b/includes/mock-fs.php
@@ -61,12 +61,12 @@ class WP_Filesystem_MockFS extends WP_Filesystem_Base {
 
 		foreach ( $paths as $path ) {
 			// Allow for comments
-			if ( '#' == $path[0] ) {
+			if ( '#' === $path[0] ) {
 				continue;
 			}
 
 			// Directories
-			if ( '/' == $path[ strlen( $path ) - 1 ] ) {
+			if ( '/' === $path[ strlen( $path ) - 1 ] ) {
 				$this->mkdir( $path );
 			} else { // Files (with dummy content for now)
 				$this->put_contents( $path, 'This is a test file' );
@@ -161,7 +161,7 @@ class WP_Filesystem_MockFS extends WP_Filesystem_Base {
 
 	function dirlist( $path = '.', $include_hidden = true, $recursive = false ) {
 
-		if ( empty( $path ) || '.' == $path ) {
+		if ( empty( $path ) || '.' === $path ) {
 			$path = $this->cwd();
 		}
 
@@ -177,15 +177,15 @@ class WP_Filesystem_MockFS extends WP_Filesystem_Base {
 
 		$ret = array();
 		foreach ( $this->fs_map[ $path ]->children as $entry ) {
-			if ( '.' == $entry->name || '..' == $entry->name ) {
+			if ( '.' === $entry->name || '..' === $entry->name ) {
 				continue;
 			}
 
-			if ( ! $include_hidden && '.' == $entry->name ) {
+			if ( ! $include_hidden && '.' === $entry->name ) {
 				continue;
 			}
 
-			if ( $limit_file && $entry->name != $limit_file ) {
+			if ( $limit_file && $entry->name !== $limit_file ) {
 				continue;
 			}
 
@@ -193,7 +193,7 @@ class WP_Filesystem_MockFS extends WP_Filesystem_Base {
 			$struc['name'] = $entry->name;
 			$struc['type'] = $entry->type;
 
-			if ( 'd' == $struc['type'] ) {
+			if ( 'd' === $struc['type'] ) {
 				if ( $recursive ) {
 					$struc['files'] = $this->dirlist( trailingslashit( $path ) . trailingslashit( $struc['name'] ), $include_hidden, $recursive );
 				} else {
@@ -219,11 +219,11 @@ class MockFS_Node {
 	}
 
 	function is_file() {
-		return $this->type == 'f';
+		return 'f' === $this->type;
 	}
 
 	function is_dir() {
-		return $this->type == 'd';
+		return 'd' === $this->type;
 	}
 }
 
diff --git a/includes/object-cache.php b/includes/object-cache.php
index 025c32b608..c97ccb8d64 100644
--- a/includes/object-cache.php
+++ b/includes/object-cache.php
@@ -761,6 +761,7 @@ function wp_cache_add_non_persistent_groups( $groups ) {
 	$wp_object_cache->add_non_persistent_groups( $groups );
 }
 
+// phpcs:disable WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
 class WP_Object_Cache {
 
 	/**
@@ -834,7 +835,7 @@ class WP_Object_Cache {
 		if ( isset( $memcached_servers ) ) {
 			$this->servers = $memcached_servers;
 		} else {
-			$this->servers = array( array( '127.0.0.1', 11211 ) );
+			$this->servers = array( array( 'memcached', 11211 ) );
 		}
 
 		$this->addServers( $this->servers );
@@ -871,10 +872,10 @@ class WP_Object_Cache {
 	 * @param   string      $group          The group value appended to the $key.
 	 * @param   int         $expiration     The expiration time, defaults to 0.
 	 * @param   string      $server_key     The key identifying the server to store the value on.
-	 * @param   bool        $byKey          True to store in internal cache by key; false to not store by key
+	 * @param   bool        $by_key         True to store in internal cache by key; false to not store by key
 	 * @return  bool                        Returns TRUE on success or FALSE on failure.
 	 */
-	public function add( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $byKey = false ) {
+	public function add( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		/*
 		 * Ensuring that wp_suspend_cache_addition is defined before calling, because sometimes an advanced-cache.php
 		 * file will load object-cache.php before wp-includes/functions.php is loaded. In those cases, if wp_cache_add
@@ -889,7 +890,7 @@ class WP_Object_Cache {
 		$expiration  = $this->sanitize_expiration( $expiration );
 
 		// If group is a non-Memcached group, save to runtime cache, not Memcached
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 
 			// Add does not set the value if the key exists; mimic that here
 			if ( isset( $this->cache[ $derived_key ] ) ) {
@@ -902,7 +903,7 @@ class WP_Object_Cache {
 		}
 
 		// Save to Memcached
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->addByKey( $server_key, $derived_key, $value, $expiration );
 		} else {
 			$result = $this->m->add( $derived_key, $value, $expiration );
@@ -990,10 +991,10 @@ class WP_Object_Cache {
 	 * @param   mixed       $value          Must be string as appending mixed values is not well-defined.
 	 * @param   string      $group          The group value appended to the $key.
 	 * @param   string      $server_key     The key identifying the server to store the value on.
-	 * @param   bool        $byKey          True to store in internal cache by key; false to not store by key
+	 * @param   bool        $by_key         True to store in internal cache by key; false to not store by key
 	 * @return  bool                        Returns TRUE on success or FALSE on failure.
 	 */
-	public function append( $key, $value, $group = 'default', $server_key = '', $byKey = false ) {
+	public function append( $key, $value, $group = 'default', $server_key = '', $by_key = false ) {
 		if ( ! is_string( $value ) && ! is_int( $value ) && ! is_float( $value ) ) {
 			return false;
 		}
@@ -1001,7 +1002,7 @@ class WP_Object_Cache {
 		$derived_key = $this->buildKey( $key, $group );
 
 		// If group is a non-Memcached group, append to runtime cache value, not Memcached
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 			if ( ! isset( $this->cache[ $derived_key ] ) ) {
 				return false;
 			}
@@ -1012,7 +1013,7 @@ class WP_Object_Cache {
 		}
 
 		// Append to Memcached value
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->appendByKey( $server_key, $derived_key, $value );
 		} else {
 			$result = $this->m->append( $derived_key, $value );
@@ -1063,10 +1064,10 @@ class WP_Object_Cache {
 	 * @param   string      $group          The group value appended to the $key.
 	 * @param   int         $expiration     The expiration time, defaults to 0.
 	 * @param   string      $server_key     The key identifying the server to store the value on.
-	 * @param   bool        $byKey          True to store in internal cache by key; false to not store by key
+	 * @param   bool        $by_key         True to store in internal cache by key; false to not store by key
 	 * @return  bool                        Returns TRUE on success or FALSE on failure.
 	 */
-	public function cas( $cas_token, $key, $value, $group = 'default', $expiration = 0, $server_key = '', $byKey = false ) {
+	public function cas( $cas_token, $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
 		$expiration  = $this->sanitize_expiration( $expiration );
 
@@ -1075,13 +1076,13 @@ class WP_Object_Cache {
 		 * that since check and set cannot be emulated in the run time cache, this value
 		 * operation is treated as a normal "add" for no_mc_groups.
 		 */
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 			$this->add_to_internal_cache( $derived_key, $value );
 			return true;
 		}
 
 		// Save to Memcached
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->casByKey( $cas_token, $server_key, $derived_key, $value, $expiration );
 		} else {
 			$result = $this->m->cas( $cas_token, $derived_key, $value, $expiration );
@@ -1129,7 +1130,7 @@ class WP_Object_Cache {
 		$derived_key = $this->buildKey( $key, $group );
 
 		// Decrement values in no_mc_groups
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 
 			// Only decrement if the key already exists and value is 0 or greater (mimics memcached behavior)
 			if ( isset( $this->cache[ $derived_key ] ) && $this->cache[ $derived_key ] >= 0 ) {
@@ -1190,14 +1191,14 @@ class WP_Object_Cache {
 	 * @param   string      $group      The group value appended to the $key.
 	 * @param   int         $time       The amount of time the server will wait to delete the item in seconds.
 	 * @param   string      $server_key The key identifying the server to store the value on.
-	 * @param   bool        $byKey      True to store in internal cache by key; false to not store by key
+	 * @param   bool        $by_key     True to store in internal cache by key; false to not store by key
 	 * @return  bool                    Returns TRUE on success or FALSE on failure.
 	 */
-	public function delete( $key, $group = 'default', $time = 0, $server_key = '', $byKey = false ) {
+	public function delete( $key, $group = 'default', $time = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
 
 		// Remove from no_mc_groups array
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 			if ( isset( $this->cache[ $derived_key ] ) ) {
 				unset( $this->cache[ $derived_key ] );
 			}
@@ -1205,7 +1206,7 @@ class WP_Object_Cache {
 			return true;
 		}
 
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->deleteByKey( $server_key, $derived_key, $time );
 		} else {
 			$result = $this->m->delete( $derived_key, $time );
@@ -1298,20 +1299,20 @@ class WP_Object_Cache {
 	 * @param   bool            $force      Whether or not to force a cache invalidation.
 	 * @param   null|bool       $found      Variable passed by reference to determine if the value was found or not.
 	 * @param   string          $server_key The key identifying the server to store the value on.
-	 * @param   bool            $byKey      True to store in internal cache by key; false to not store by key
+	 * @param   bool            $by_key     True to store in internal cache by key; false to not store by key
 	 * @param   null|callable   $cache_cb   Read-through caching callback.
 	 * @param   null|float      $cas_token  The variable to store the CAS token in.
 	 * @return  bool|mixed                  Cached object value.
 	 */
-	public function get( $key, $group = 'default', $force = false, &$found = null, $server_key = '', $byKey = false, $cache_cb = null, &$cas_token = null ) {
+	public function get( $key, $group = 'default', $force = false, &$found = null, $server_key = '', $by_key = false, $cache_cb = null, &$cas_token = null ) {
 		$derived_key = $this->buildKey( $key, $group );
 
 		// Assume object is not found
 		$found = false;
 
 		// If either $cache_db, or $cas_token is set, must hit Memcached and bypass runtime cache
-		if ( func_num_args() > 6 && ! in_array( $group, $this->no_mc_groups ) ) {
-			if ( $byKey ) {
+		if ( func_num_args() > 6 && ! in_array( $group, $this->no_mc_groups, true ) ) {
+			if ( $by_key ) {
 				$value = $this->m->getByKey( $server_key, $derived_key, $cache_cb, $cas_token );
 			} else {
 				$value = $this->m->get( $derived_key, $cache_cb, $cas_token );
@@ -1320,10 +1321,10 @@ class WP_Object_Cache {
 			if ( isset( $this->cache[ $derived_key ] ) ) {
 				$found = true;
 				return is_object( $this->cache[ $derived_key ] ) ? clone $this->cache[ $derived_key ] : $this->cache[ $derived_key ];
-			} elseif ( in_array( $group, $this->no_mc_groups ) ) {
+			} elseif ( in_array( $group, $this->no_mc_groups, true ) ) {
 				return false;
 			} else {
-				if ( $byKey ) {
+				if ( $by_key ) {
 					$value = $this->m->getByKey( $server_key, $derived_key );
 				} else {
 					$value = $this->m->get( $derived_key );
@@ -1463,7 +1464,7 @@ class WP_Object_Cache {
 			}
 
 			// If order should be preserved, reorder now
-			if ( ! empty( $need_to_get ) && $flags === Memcached::GET_PRESERVE_ORDER ) {
+			if ( ! empty( $need_to_get ) && Memcached::GET_PRESERVE_ORDER === $flags ) {
 				$ordered_values = array();
 
 				foreach ( $derived_keys as $key ) {
@@ -1602,7 +1603,7 @@ class WP_Object_Cache {
 		$derived_key = $this->buildKey( $key, $group );
 
 		// Increment values in no_mc_groups
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 
 			// Only increment if the key already exists and the number is currently 0 or greater (mimics memcached behavior)
 			if ( isset( $this->cache[ $derived_key ] ) && $this->cache[ $derived_key ] >= 0 ) {
@@ -1667,10 +1668,10 @@ class WP_Object_Cache {
 	 * @param   string    $value        Must be string as prepending mixed values is not well-defined.
 	 * @param   string    $group        The group value prepended to the $key.
 	 * @param   string    $server_key   The key identifying the server to store the value on.
-	 * @param   bool      $byKey        True to store in internal cache by key; false to not store by key
+	 * @param   bool      $by_key       True to store in internal cache by key; false to not store by key
 	 * @return  bool                    Returns TRUE on success or FALSE on failure.
 	 */
-	public function prepend( $key, $value, $group = 'default', $server_key = '', $byKey = false ) {
+	public function prepend( $key, $value, $group = 'default', $server_key = '', $by_key = false ) {
 		if ( ! is_string( $value ) && ! is_int( $value ) && ! is_float( $value ) ) {
 			return false;
 		}
@@ -1678,7 +1679,7 @@ class WP_Object_Cache {
 		$derived_key = $this->buildKey( $key, $group );
 
 		// If group is a non-Memcached group, prepend to runtime cache value, not Memcached
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 			if ( ! isset( $this->cache[ $derived_key ] ) ) {
 				return false;
 			}
@@ -1689,7 +1690,7 @@ class WP_Object_Cache {
 		}
 
 		// Append to Memcached value
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->prependByKey( $server_key, $derived_key, $value );
 		} else {
 			$result = $this->m->prepend( $derived_key, $value );
@@ -1739,16 +1740,16 @@ class WP_Object_Cache {
 	 * @param   string      $key            The key under which to store the value.
 	 * @param   mixed       $value          The value to store.
 	 * @param   string      $group          The group value appended to the $key.
-	 * @param   bool        $byKey          True to store in internal cache by key; false to not store by key
+	 * @param   bool        $by_key         True to store in internal cache by key; false to not store by key
 	 * @param   int         $expiration     The expiration time, defaults to 0.
 	 * @return  bool                        Returns TRUE on success or FALSE on failure.
 	 */
-	public function replace( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $byKey = false ) {
+	public function replace( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
 		$expiration  = $this->sanitize_expiration( $expiration );
 
 		// If group is a non-Memcached group, save to runtime cache, not Memcached
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 
 			// Replace won't save unless the key already exists; mimic this behavior here
 			if ( ! isset( $this->cache[ $derived_key ] ) ) {
@@ -1760,7 +1761,7 @@ class WP_Object_Cache {
 		}
 
 		// Save to Memcached
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->replaceByKey( $server_key, $derived_key, $value, $expiration );
 		} else {
 			$result = $this->m->replace( $derived_key, $value, $expiration );
@@ -1805,21 +1806,21 @@ class WP_Object_Cache {
 	 * @param   string      $group      The group value appended to the $key.
 	 * @param   int         $expiration The expiration time, defaults to 0.
 	 * @param   string      $server_key The key identifying the server to store the value on.
-	 * @param   bool        $byKey      True to store in internal cache by key; false to not store by key
+	 * @param   bool        $by_key     True to store in internal cache by key; false to not store by key
 	 * @return  bool                    Returns TRUE on success or FALSE on failure.
 	 */
-	public function set( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $byKey = false ) {
+	public function set( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
 		$expiration  = $this->sanitize_expiration( $expiration );
 
 		// If group is a non-Memcached group, save to runtime cache, not Memcached
-		if ( in_array( $group, $this->no_mc_groups ) ) {
+		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 			$this->add_to_internal_cache( $derived_key, $value );
 			return true;
 		}
 
 		// Save to Memcached
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->setByKey( $server_key, $derived_key, $value, $expiration );
 		} else {
 			$result = $this->m->set( $derived_key, $value, $expiration );
@@ -1866,10 +1867,10 @@ class WP_Object_Cache {
 	 * @param   string|array    $groups         Group(s) to merge with key(s) in $items.
 	 * @param   int             $expiration     The expiration time, defaults to 0.
 	 * @param   string          $server_key     The key identifying the server to store the value on.
-	 * @param   bool            $byKey          True to store in internal cache by key; false to not store by key
+	 * @param   bool            $by_key         True to store in internal cache by key; false to not store by key
 	 * @return  bool                            Returns TRUE on success or FALSE on failure.
 	 */
-	public function setMulti( $items, $groups = 'default', $expiration = 0, $server_key = '', $byKey = false ) {
+	public function setMulti( $items, $groups = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		// Build final keys and replace $items keys with the new keys
 		$derived_keys  = $this->buildKeys( array_keys( $items ), $groups );
 		$expiration    = $this->sanitize_expiration( $expiration );
@@ -1882,14 +1883,14 @@ class WP_Object_Cache {
 			$key_pieces = explode( ':', $derived_key );
 
 			// If group is a non-Memcached group, save to runtime cache, not Memcached
-			if ( in_array( $key_pieces[1], $this->no_mc_groups ) ) {
+			if ( in_array( $key_pieces[1], $this->no_mc_groups, true ) ) {
 				$this->add_to_internal_cache( $derived_key, $value );
 				unset( $derived_items[ $derived_key ] );
 			}
 		}
 
 		// Save to memcached
-		if ( $byKey ) {
+		if ( $by_key ) {
 			$result = $this->m->setMultiByKey( $server_key, $derived_items, $expiration );
 		} else {
 			$result = $this->m->setMulti( $derived_items, $expiration );
@@ -1952,7 +1953,7 @@ class WP_Object_Cache {
 			$group = 'default';
 		}
 
-		if ( false !== array_search( $group, $this->global_groups ) ) {
+		if ( false !== array_search( $group, $this->global_groups, true ) ) {
 			$prefix = $this->global_prefix;
 		} else {
 			$prefix = $this->blog_prefix;
@@ -1990,7 +1991,7 @@ class WP_Object_Cache {
 		}
 
 		// If we have equal numbers of keys and groups, merge $keys[n] and $group[n]
-		if ( count( $keys ) == count( $groups ) ) {
+		if ( count( $keys ) === count( $groups ) ) {
 			for ( $i = 0; $i < count( $keys ); $i++ ) {
 				$derived_keys[] = $this->buildKey( $keys[ $i ], $groups[ $i ] );
 			}
@@ -2000,7 +2001,7 @@ class WP_Object_Cache {
 			for ( $i = 0; $i < count( $keys ); $i++ ) {
 				if ( isset( $groups[ $i ] ) ) {
 					$derived_keys[] = $this->buildKey( $keys[ $i ], $groups[ $i ] );
-				} elseif ( count( $groups ) == 1 ) {
+				} elseif ( count( $groups ) === 1 ) {
 					$derived_keys[] = $this->buildKey( $keys[ $i ], $groups[0] );
 				} else {
 					$derived_keys[] = $this->buildKey( $keys[ $i ], 'default' );
@@ -2045,7 +2046,7 @@ class WP_Object_Cache {
 		$type = gettype( $original );
 
 		// Combine the values based on direction of the "pend"
-		if ( 'pre' == $direction ) {
+		if ( 'pre' === $direction ) {
 			$combined = $pended . $original;
 		} else {
 			$combined = $original . $pended;
@@ -2079,7 +2080,7 @@ class WP_Object_Cache {
 	 */
 	public function contains_no_mc_group( $groups ) {
 		if ( is_scalar( $groups ) ) {
-			return in_array( $groups, $this->no_mc_groups );
+			return in_array( $groups, $this->no_mc_groups, true );
 		}
 
 		if ( ! is_array( $groups ) ) {
@@ -2087,7 +2088,7 @@ class WP_Object_Cache {
 		}
 
 		foreach ( $groups as $group ) {
-			if ( in_array( $group, $this->no_mc_groups ) ) {
+			if ( in_array( $group, $this->no_mc_groups, true ) ) {
 				return true;
 			}
 		}
@@ -2160,3 +2161,4 @@ class WP_Object_Cache {
 		$this->blog_prefix = ( is_multisite() ? $blog_id : $table_prefix ) . ':';
 	}
 }
+// phpcs:enable
diff --git a/includes/phpunit6/compat.php b/includes/phpunit6/compat.php
index 54bd40510e..dcc99e9a76 100644
--- a/includes/phpunit6/compat.php
+++ b/includes/phpunit6/compat.php
@@ -5,6 +5,7 @@ if ( class_exists( 'PHPUnit\Runner\Version' ) && version_compare( PHPUnit\Runner
 	class_alias( 'PHPUnit\Framework\TestCase', 'PHPUnit_Framework_TestCase' );
 	class_alias( 'PHPUnit\Framework\Exception', 'PHPUnit_Framework_Exception' );
 	class_alias( 'PHPUnit\Framework\ExpectationFailedException', 'PHPUnit_Framework_ExpectationFailedException' );
+	class_alias( 'PHPUnit\Framework\Error\Deprecated', 'PHPUnit_Framework_Error_Deprecated' );
 	class_alias( 'PHPUnit\Framework\Error\Notice', 'PHPUnit_Framework_Error_Notice' );
 	class_alias( 'PHPUnit\Framework\Error\Warning', 'PHPUnit_Framework_Error_Warning' );
 	class_alias( 'PHPUnit\Framework\Test', 'PHPUnit_Framework_Test' );
@@ -17,8 +18,9 @@ if ( class_exists( 'PHPUnit\Runner\Version' ) && version_compare( PHPUnit\Runner
 
 	class PHPUnit_Util_Test {
 
-		public static function getTickets( $className, $methodName ) {
-			$annotations = PHPUnit\Util\Test::parseTestMethodAnnotations( $className, $methodName );
+		// phpcs:ignore WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
+		public static function getTickets( $class_name, $method_name ) {
+			$annotations = PHPUnit\Util\Test::parseTestMethodAnnotations( $class_name, $method_name );
 
 			$tickets = array();
 
diff --git a/includes/phpunit7/speed-trap-listener.php b/includes/phpunit7/speed-trap-listener.php
index 60b61891dc..c27fbc21cd 100644
--- a/includes/phpunit7/speed-trap-listener.php
+++ b/includes/phpunit7/speed-trap-listener.php
@@ -22,14 +22,14 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 *
 	 * @var int
 	 */
-	protected $slowThreshold;
+	protected $slow_threshold;
 
 	/**
 	 * Number of tests to report on for slowness.
 	 *
 	 * @var int
 	 */
-	protected $reportLength;
+	protected $report_length;
 
 	/**
 	 * Collection of slow tests.
@@ -166,11 +166,11 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * Whether the given test execution time is considered slow.
 	 *
 	 * @param int $time          Test execution time in milliseconds
-	 * @param int $slowThreshold Test execution time at which a test should be considered slow (milliseconds)
+	 * @param int $slow_threshold Test execution time at which a test should be considered slow (milliseconds)
 	 * @return bool
 	 */
-	protected function isSlow( $time, $slowThreshold ) {
-		return $time >= $slowThreshold;
+	protected function isSlow( $time, $slow_threshold ) {
+		return $time >= $slow_threshold;
 	}
 
 	/**
@@ -220,7 +220,7 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * @return int
 	 */
 	protected function getReportLength() {
-		return min( count( $this->slow ), $this->reportLength );
+		return min( count( $this->slow ), $this->report_length );
 	}
 
 	/**
@@ -244,19 +244,19 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * Renders slow test report header.
 	 */
 	protected function renderHeader() {
-		echo sprintf( "\n\nYou should really fix these slow tests (>%sms)...\n", $this->slowThreshold );
+		echo sprintf( "\n\nYou should really fix these slow tests (>%sms)...\n", $this->slow_threshold );
 	}
 
 	/**
 	 * Renders slow test report body.
 	 */
 	protected function renderBody() {
-		$slowTests = $this->slow;
+		$slow_tests = $this->slow;
 
-		$length = $this->getReportLength( $slowTests );
+		$length = $this->getReportLength( $slow_tests );
 		for ( $i = 1; $i <= $length; ++$i ) {
-			$label = key( $slowTests );
-			$time  = array_shift( $slowTests );
+			$label = key( $slow_tests );
+			$time  = array_shift( $slow_tests );
 
 			echo sprintf( " %s. %sms to run %s\n", $i, $time, $label );
 		}
@@ -266,8 +266,9 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * Renders slow test report footer.
 	 */
 	protected function renderFooter() {
-		if ( $hidden = $this->getHiddenCount( $this->slow ) ) {
-			echo sprintf( '...and there %s %s more above your threshold hidden from view', $hidden == 1 ? 'is' : 'are', $hidden );
+		$hidden = $this->getHiddenCount( $this->slow );
+		if ( $hidden ) {
+			echo sprintf( '...and there %s %s more above your threshold hidden from view', 1 === $hidden ? 'is' : 'are', $hidden );
 		}
 	}
 
@@ -277,8 +278,8 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * @param array $options
 	 */
 	protected function loadOptions( array $options ) {
-		$this->slowThreshold = isset( $options['slowThreshold'] ) ? $options['slowThreshold'] : 500;
-		$this->reportLength  = isset( $options['reportLength'] ) ? $options['reportLength'] : 10;
+		$this->slow_threshold = isset( $options['slowThreshold'] ) ? $options['slowThreshold'] : 500;
+		$this->report_length  = isset( $options['reportLength'] ) ? $options['reportLength'] : 10;
 	}
 
 	/**
@@ -301,6 +302,6 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	protected function getSlowThreshold( PHPUnit_Framework_TestCase $test ) {
 		$ann = $test->getAnnotations();
 
-		return isset( $ann['method']['slowThreshold'][0] ) ? $ann['method']['slowThreshold'][0] : $this->slowThreshold;
+		return isset( $ann['method']['slowThreshold'][0] ) ? $ann['method']['slowThreshold'][0] : $this->slow_threshold;
 	}
 }
diff --git a/includes/speed-trap-listener.php b/includes/speed-trap-listener.php
index eaf738a25e..0de9d9ae86 100644
--- a/includes/speed-trap-listener.php
+++ b/includes/speed-trap-listener.php
@@ -22,14 +22,14 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 *
 	 * @var int
 	 */
-	protected $slowThreshold;
+	protected $slow_threshold;
 
 	/**
 	 * Number of tests to report on for slowness.
 	 *
 	 * @var int
 	 */
-	protected $reportLength;
+	protected $report_length;
 
 	/**
 	 * Collection of slow tests.
@@ -166,11 +166,11 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * Whether the given test execution time is considered slow.
 	 *
 	 * @param int $time          Test execution time in milliseconds
-	 * @param int $slowThreshold Test execution time at which a test should be considered slow (milliseconds)
+	 * @param int $slow_threshold Test execution time at which a test should be considered slow (milliseconds)
 	 * @return bool
 	 */
-	protected function isSlow( $time, $slowThreshold ) {
-		return $time >= $slowThreshold;
+	protected function isSlow( $time, $slow_threshold ) {
+		return $time >= $slow_threshold;
 	}
 
 	/**
@@ -220,7 +220,7 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * @return int
 	 */
 	protected function getReportLength() {
-		return min( count( $this->slow ), $this->reportLength );
+		return min( count( $this->slow ), $this->report_length );
 	}
 
 	/**
@@ -244,19 +244,19 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * Renders slow test report header.
 	 */
 	protected function renderHeader() {
-		echo sprintf( "\n\nYou should really fix these slow tests (>%sms)...\n", $this->slowThreshold );
+		echo sprintf( "\n\nYou should really fix these slow tests (>%sms)...\n", $this->slow_threshold );
 	}
 
 	/**
 	 * Renders slow test report body.
 	 */
 	protected function renderBody() {
-		$slowTests = $this->slow;
+		$slow_tests = $this->slow;
 
-		$length = $this->getReportLength( $slowTests );
+		$length = $this->getReportLength( $slow_tests );
 		for ( $i = 1; $i <= $length; ++$i ) {
-			$label = key( $slowTests );
-			$time  = array_shift( $slowTests );
+			$label = key( $slow_tests );
+			$time  = array_shift( $slow_tests );
 
 			echo sprintf( " %s. %sms to run %s\n", $i, $time, $label );
 		}
@@ -267,7 +267,7 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 */
 	protected function renderFooter() {
 		if ( $hidden = $this->getHiddenCount( $this->slow ) ) {
-			echo sprintf( '...and there %s %s more above your threshold hidden from view', $hidden == 1 ? 'is' : 'are', $hidden );
+			echo sprintf( '...and there %s %s more above your threshold hidden from view', 1 === $hidden ? 'is' : 'are', $hidden );
 		}
 	}
 
@@ -277,8 +277,8 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	 * @param array $options
 	 */
 	protected function loadOptions( array $options ) {
-		$this->slowThreshold = isset( $options['slowThreshold'] ) ? $options['slowThreshold'] : 500;
-		$this->reportLength  = isset( $options['reportLength'] ) ? $options['reportLength'] : 10;
+		$this->slow_threshold = isset( $options['slowThreshold'] ) ? $options['slowThreshold'] : 500;
+		$this->report_length  = isset( $options['reportLength'] ) ? $options['reportLength'] : 10;
 	}
 
 	/**
@@ -301,6 +301,6 @@ class SpeedTrapListener implements PHPUnit_Framework_TestListener {
 	protected function getSlowThreshold( PHPUnit_Framework_TestCase $test ) {
 		$ann = $test->getAnnotations();
 
-		return isset( $ann['method']['slowThreshold'][0] ) ? $ann['method']['slowThreshold'][0] : $this->slowThreshold;
+		return isset( $ann['method']['slowThreshold'][0] ) ? $ann['method']['slowThreshold'][0] : $this->slow_threshold;
 	}
 }
diff --git a/includes/testcase-ajax.php b/includes/testcase-ajax.php
index bf5a5bce91..736d362f76 100644
--- a/includes/testcase-ajax.php
+++ b/includes/testcase-ajax.php
@@ -119,6 +119,8 @@ abstract class WP_Ajax_UnitTestCase extends WP_UnitTestCase {
 		'delete-theme',
 		'install-theme',
 		'get-post-thumbnail-html',
+		'wp-privacy-export-personal-data',
+		'wp-privacy-erase-personal-data',
 	);
 
 	public static function setUpBeforeClass() {
diff --git a/includes/testcase-canonical.php b/includes/testcase-canonical.php
index 32da3eff54..9e0cb54c73 100644
--- a/includes/testcase-canonical.php
+++ b/includes/testcase-canonical.php
@@ -61,13 +61,14 @@ class WP_Canonical_UnitTestCase extends WP_UnitTestCase {
 				'post_date'  => '2008-06-02 00:00:00',
 			)
 		);
-		self::$post_ids[] = $post_id = $factory->post->create(
+		$post_id          = $factory->post->create(
 			array(
 				'post_title' => 'post-format-test-gallery',
 				'post_date'  => '2008-06-10 00:00:00',
 			)
 		);
-		self::$post_ids[] = $factory->post->create(
+		self::$post_ids[] = $post_id;
+		$factory->post->create(
 			array(
 				'import_id'   => 611,
 				'post_type'   => 'attachment',
@@ -75,6 +76,7 @@ class WP_Canonical_UnitTestCase extends WP_UnitTestCase {
 				'post_parent' => $post_id,
 			)
 		);
+		self::$post_ids[] = $post_id;
 
 		self::$post_ids[] = $factory->post->create(
 			array(
@@ -84,13 +86,14 @@ class WP_Canonical_UnitTestCase extends WP_UnitTestCase {
 			)
 		);
 
-		self::$post_ids[]  = $post_id = $factory->post->create(
+		$post_id           = $factory->post->create(
 			array(
 				'import_id'  => 149,
 				'post_title' => 'comment-test',
 				'post_date'  => '2008-03-03 00:00:00',
 			)
 		);
+		self::$post_ids[]  = $post_id;
 		self::$comment_ids = $factory->comment->create_post_comments( $post_id, 15 );
 
 		self::$post_ids[] = $factory->post->create( array( 'post_date' => '2008-09-05 00:00:00' ) );
@@ -111,12 +114,13 @@ class WP_Canonical_UnitTestCase extends WP_UnitTestCase {
 				'post_title' => 'about',
 			)
 		);
-		self::$post_ids[] = $post_id = $factory->post->create(
+		$post_id          = $factory->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => 'parent-page',
 			)
 		);
+		self::$post_ids[] = $post_id;
 		self::$post_ids[] = $factory->post->create(
 			array(
 				'import_id'   => 144,
@@ -126,40 +130,45 @@ class WP_Canonical_UnitTestCase extends WP_UnitTestCase {
 			)
 		);
 
-		self::$post_ids[] = $parent_id = $factory->post->create(
+		$parent_id        = $factory->post->create(
 			array(
 				'post_name' => 'parent',
 				'post_type' => 'page',
 			)
 		);
-		self::$post_ids[] = $child_id_1 = $factory->post->create(
+		self::$post_ids[] = $parent_id;
+		$child_id_1       = $factory->post->create(
 			array(
 				'post_name'   => 'child1',
 				'post_type'   => 'page',
 				'post_parent' => $parent_id,
 			)
 		);
-		self::$post_ids[] = $child_id_2 = $factory->post->create(
+		self::$post_ids[] = $child_id_1;
+		$child_id_2       = $factory->post->create(
 			array(
 				'post_name'   => 'child2',
 				'post_type'   => 'page',
 				'post_parent' => $parent_id,
 			)
 		);
-		self::$post_ids[] = $grandchild_id_1 = $factory->post->create(
+		self::$post_ids[] = $child_id_2;
+		$grandchild_id_1  = $factory->post->create(
 			array(
 				'post_name'   => 'grandchild',
 				'post_type'   => 'page',
 				'post_parent' => $child_id_1,
 			)
 		);
-		self::$post_ids[] = $grandchild_id_2 = $factory->post->create(
+		self::$post_ids[] = $grandchild_id_1;
+		$grandchild_id_2  = $factory->post->create(
 			array(
 				'post_name'   => 'grandchild',
 				'post_type'   => 'page',
 				'post_parent' => $child_id_2,
 			)
 		);
+		self::$post_ids[] = $grandchild_id_2;
 
 		$cat1                             = $factory->term->create(
 			array(
diff --git a/includes/testcase-rest-post-type-controller.php b/includes/testcase-rest-post-type-controller.php
index 832650855f..b25aed0fd2 100644
--- a/includes/testcase-rest-post-type-controller.php
+++ b/includes/testcase-rest-post-type-controller.php
@@ -10,7 +10,7 @@ abstract class WP_Test_REST_Post_Type_Controller_Testcase extends WP_Test_REST_C
 		$this->assertEquals( $post->post_name, $data['slug'] );
 		$this->assertEquals( get_permalink( $post->ID ), $data['link'] );
 		if ( '0000-00-00 00:00:00' === $post->post_date_gmt ) {
-			$post_date_gmt = date( 'Y-m-d H:i:s', strtotime( $post->post_date ) - ( get_option( 'gmt_offset' ) * 3600 ) );
+			$post_date_gmt = gmdate( 'Y-m-d H:i:s', strtotime( $post->post_date ) - ( get_option( 'gmt_offset' ) * 3600 ) );
 			$this->assertEquals( mysql_to_rfc3339( $post_date_gmt ), $data['date_gmt'] );
 		} else {
 			$this->assertEquals( mysql_to_rfc3339( $post->post_date_gmt ), $data['date_gmt'] );
@@ -18,7 +18,7 @@ abstract class WP_Test_REST_Post_Type_Controller_Testcase extends WP_Test_REST_C
 		$this->assertEquals( mysql_to_rfc3339( $post->post_date ), $data['date'] );
 
 		if ( '0000-00-00 00:00:00' === $post->post_modified_gmt ) {
-			$post_modified_gmt = date( 'Y-m-d H:i:s', strtotime( $post->post_modified ) - ( get_option( 'gmt_offset' ) * 3600 ) );
+			$post_modified_gmt = gmdate( 'Y-m-d H:i:s', strtotime( $post->post_modified ) - ( get_option( 'gmt_offset' ) * 3600 ) );
 			$this->assertEquals( mysql_to_rfc3339( $post_modified_gmt ), $data['modified_gmt'] );
 		} else {
 			$this->assertEquals( mysql_to_rfc3339( $post->post_modified_gmt ), $data['modified_gmt'] );
diff --git a/includes/trac.php b/includes/trac.php
index 7209978324..dd3783e7be 100644
--- a/includes/trac.php
+++ b/includes/trac.php
@@ -13,7 +13,7 @@ class TracTickets {
 	 *
 	 * @return bool|null true if the ticket is resolved, false if not resolved, null on error
 	 */
-	public static function isTracTicketClosed( $trac_url, $ticket_id ) {
+	public static function isTracTicketClosed( $trac_url, $ticket_id ) { // phpcs:ignore WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
 		if ( ! extension_loaded( 'openssl' ) ) {
 			$trac_url = preg_replace( '/^https:/', 'http:', $trac_url );
 		}
@@ -41,15 +41,17 @@ class TracTickets {
 			self::$trac_ticket_cache[ $trac_url ] = $tickets;
 		}
 
-		return ! in_array( $ticket_id, self::$trac_ticket_cache[ $trac_url ] );
+		return ! in_array( $ticket_id, self::$trac_ticket_cache[ $trac_url ], true );
 	}
 
+	// phpcs:ignore WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
 	public static function usingLocalCache() {
 		echo PHP_EOL . "\x1b[0m\x1b[30;43m\x1b[2K";
 		echo 'INFO: Trac was inaccessible, so a local ticket status cache was used.' . PHP_EOL;
 		echo "\x1b[0m\x1b[2K";
 	}
 
+	// phpcs:ignore WordPress.NamingConventions.ValidFunctionName.MethodNameInvalid
 	public static function forcingKnownBugs() {
 		echo PHP_EOL . "\x1b[0m\x1b[37;41m\x1b[2K";
 		echo "ERROR: Trac was inaccessible, so known bugs weren't able to be skipped." . PHP_EOL;
diff --git a/includes/utils.php b/includes/utils.php
index db1fac7229..6d45117368 100644
--- a/includes/utils.php
+++ b/includes/utils.php
@@ -128,17 +128,16 @@ class MockAction {
 		return $arg . '_append';
 	}
 
-	function filterall( $tag, $arg = null ) {
+	function filterall( $tag, ...$args ) {
 		// this one doesn't return the result, so it's safe to use with the new 'all' filter
 		if ( $this->debug ) {
 			dmp( __FUNCTION__, $this->current_filter() );
 		}
 
-		$args           = func_get_args();
 		$this->events[] = array(
 			'filter' => __FUNCTION__,
 			'tag'    => $tag,
-			'args'   => array_slice( $args, 1 ),
+			'args'   => $args,
 		);
 	}
 
@@ -152,7 +151,7 @@ class MockAction {
 		if ( $tag ) {
 			$count = 0;
 			foreach ( $this->events as $e ) {
-				if ( $e['action'] == $tag ) {
+				if ( $e['action'] === $tag ) {
 					++$count;
 				}
 			}
@@ -182,7 +181,7 @@ class MockAction {
 
 // convert valid xml to an array tree structure
 // kinda lame but it works with a default php 4 installation
-class testXMLParser {
+class TestXMLParser {
 	var $xml;
 	var $data = array();
 
@@ -193,8 +192,8 @@ class testXMLParser {
 		$this->xml = xml_parser_create();
 		xml_set_object( $this->xml, $this );
 		xml_parser_set_option( $this->xml, XML_OPTION_CASE_FOLDING, 0 );
-		xml_set_element_handler( $this->xml, array( $this, 'startHandler' ), array( $this, 'endHandler' ) );
-		xml_set_character_data_handler( $this->xml, array( $this, 'dataHandler' ) );
+		xml_set_element_handler( $this->xml, array( $this, 'start_handler' ), array( $this, 'end_handler' ) );
+		xml_set_character_data_handler( $this->xml, array( $this, 'data_handler' ) );
 		$this->parse( $in );
 	}
 
@@ -214,19 +213,23 @@ class testXMLParser {
 		return true;
 	}
 
-	function startHandler( $parser, $name, $attributes ) {
+	function start_handler( $parser, $name, $attributes ) {
 		$data['name'] = $name;
 		if ( $attributes ) {
 			$data['attributes'] = $attributes; }
 		$this->data[] = $data;
 	}
 
-	function dataHandler( $parser, $data ) {
-		$index                             = count( $this->data ) - 1;
-		@$this->data[ $index ]['content'] .= $data;
+	function data_handler( $parser, $data ) {
+		$index = count( $this->data ) - 1;
+
+		if ( ! isset( $this->data[ $index ]['content'] ) ) {
+			$this->data[ $index ]['content'] = '';
+		}
+		$this->data[ $index ]['content'] .= $data;
 	}
 
-	function endHandler( $parser, $name ) {
+	function end_handler( $parser, $name ) {
 		if ( count( $this->data ) > 1 ) {
 			$data                            = array_pop( $this->data );
 			$index                           = count( $this->data ) - 1;
@@ -236,14 +239,12 @@ class testXMLParser {
 }
 
 function xml_to_array( $in ) {
-	$p = new testXMLParser( $in );
+	$p = new TestXMLParser( $in );
 	return $p->data;
 }
 
-function xml_find( $tree /*, $el1, $el2, $el3, .. */ ) {
-	$a   = func_get_args();
-	$a   = array_slice( $a, 1 );
-	$n   = count( $a );
+function xml_find( $tree, ...$elements ) {
+	$n   = count( $elements );
 	$out = array();
 
 	if ( $n < 1 ) {
@@ -251,17 +252,15 @@ function xml_find( $tree /*, $el1, $el2, $el3, .. */ ) {
 	}
 
 	for ( $i = 0; $i < count( $tree ); $i++ ) {
-		#       echo "checking '{$tree[$i][name]}' == '{$a[0]}'\n";
-		#       var_dump($tree[$i]['name'], $a[0]);
-		if ( $tree[ $i ]['name'] == $a[0] ) {
+		#       echo "checking '{$tree[$i][name]}' == '{$elements[0]}'\n";
+		#       var_dump( $tree[$i]['name'], $elements[0] );
+		if ( $tree[ $i ]['name'] === $elements[0] ) {
 			#           echo "n == {$n}\n";
-			if ( $n == 1 ) {
+			if ( 1 === $n ) {
 				$out[] = $tree[ $i ];
 			} else {
-				$subtree   =& $tree[ $i ]['child'];
-				$call_args = array( $subtree );
-				$call_args = array_merge( $call_args, array_slice( $a, 1 ) );
-				$out       = array_merge( $out, call_user_func_array( 'xml_find', $call_args ) );
+				$subtree =& $tree[ $i ]['child'];
+				$out     = array_merge( $out, xml_find( $subtree, ...array_slice( $elements, 1 ) ) );
 			}
 		}
 	}
@@ -296,9 +295,7 @@ function xml_array_dumbdown( &$data ) {
 	return $out;
 }
 
-function dmp() {
-	$args = func_get_args();
-
+function dmp( ...$args ) {
 	foreach ( $args as $thing ) {
 		echo ( is_scalar( $thing ) ? strval( $thing ) : var_export( $thing, true ) ), "\n";
 	}
@@ -348,6 +345,7 @@ function drop_tables() {
 	global $wpdb;
 	$tables = $wpdb->get_col( 'SHOW TABLES;' );
 	foreach ( $tables as $table ) {
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DROP TABLE IF EXISTS {$table}" );
 	}
 }
@@ -374,17 +372,6 @@ function mask_input_value( $in, $name = '_wpnonce' ) {
 	return preg_replace( '@<input([^>]*) name="' . preg_quote( $name ) . '"([^>]*) value="[^>]*" />@', '<input$1 name="' . preg_quote( $name ) . '"$2 value="***" />', $in );
 }
 
-if ( ! function_exists( 'str_getcsv' ) ) {
-	function str_getcsv( $input, $delimiter = ',', $enclosure = '"', $escape = '\\' ) {
-		$fp = fopen( 'php://temp/', 'r+' );
-		fputs( $fp, $input );
-		rewind( $fp );
-		$data = fgetcsv( $fp, strlen( $input ), $delimiter, $enclosure );
-		fclose( $fp );
-		return $data;
-	}
-}
-
 /**
  * Removes the post type and its taxonomy associations.
  */
@@ -438,7 +425,7 @@ function _clean_term_filters() {
 /**
  * Special class for exposing protected wpdb methods we need to access
  */
-class wpdb_exposed_methods_for_testing extends wpdb {
+class WpdbExposedMethodsForTesting extends wpdb {
 	public function __construct() {
 		global $wpdb;
 		$this->dbh         = $wpdb->dbh;
@@ -467,12 +454,8 @@ class wpdb_exposed_methods_for_testing extends wpdb {
 function benchmark_pcre_backtracking( $pattern, $subject, $strategy ) {
 	$saved_config = ini_get( 'pcre.backtrack_limit' );
 
-	// Attempt to prevent PHP crashes.  Adjust these lower when needed.
-	if ( version_compare( phpversion(), '5.4.8', '>' ) ) {
-		$limit = 1000000;
-	} else {
-		$limit = 20000;  // 20,000 is a reasonable upper limit, but see also https://core.trac.wordpress.org/ticket/29557#comment:10
-	}
+	// Attempt to prevent PHP crashes. Adjust lower when needed.
+	$limit = 1000000;
 
 	// Start with small numbers, so if a crash is encountered at higher numbers we can still debug the problem.
 	for ( $i = 4; $i <= $limit; $i *= 2 ) {
diff --git a/includes/wp-profiler.php b/includes/wp-profiler.php
index e83de97c81..60628d2917 100644
--- a/includes/wp-profiler.php
+++ b/includes/wp-profiler.php
@@ -18,18 +18,18 @@ Multiple profile blocks are permitted, and they may be nested.
 */
 
 class WPProfiler {
-	var $stack;
-	var $profile;
+	public $stack;
+	public $profile;
 
 	/**
 	 * PHP5 constructor.
 	 */
-	function __construct() {
+	public function __construct() {
 		$this->stack   = array();
 		$this->profile = array();
 	}
 
-	function start( $name ) {
+	public function start( $name ) {
 		$time = $this->microtime();
 
 		if ( ! $this->stack ) {
@@ -60,7 +60,7 @@ class WPProfiler {
 
 	}
 
-	function stop() {
+	public function stop() {
 		$item = array_pop( $this->stack );
 		$time = $this->microtime( $item['start'] );
 		$name = $item['name'];
@@ -106,64 +106,64 @@ class WPProfiler {
 		}
 	}
 
-	function microtime( $since = 0.0 ) {
+	public function microtime( $since = 0.0 ) {
 		list($usec, $sec) = explode( ' ', microtime() );
 		return (float) $sec + (float) $usec - $since;
 	}
 
-	function log_filter( $tag ) {
+	public function log_filter( $tag ) {
 		if ( $this->stack ) {
 			global $wp_actions;
-			if ( $tag == end( $wp_actions ) ) {
-				@$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ] ++;
+			if ( end( $wp_actions ) === $tag ) {
+				$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ]++;
 			} else {
-				@$this->stack[ count( $this->stack ) - 1 ]['filters'][ $tag ] ++;
+				$this->stack[ count( $this->stack ) - 1 ]['filters'][ $tag ]++;
 			}
 		}
 		return $arg;
 	}
 
-	function log_action( $tag ) {
+	public function log_action( $tag ) {
 		if ( $this->stack ) {
-			@$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ] ++;
+			$this->stack[ count( $this->stack ) - 1 ]['actions'][ $tag ]++;
 		}
 	}
 
-	function _current_action() {
+	public function _current_action() {
 		global $wp_actions;
 		return $wp_actions[ count( $wp_actions ) - 1 ];
 	}
 
-	function results() {
+	public function results() {
 		return $this->profile;
 	}
 
-	function _query_summary( $queries, &$out ) {
+	public function _query_summary( $queries, &$out ) {
 		foreach ( $queries as $q ) {
 			$sql = $q[0];
 			$sql = preg_replace( '/(WHERE \w+ =) \d+/', '$1 x', $sql );
 			$sql = preg_replace( '/(WHERE \w+ =) \'\[-\w]+\'/', '$1 \'xxx\'', $sql );
 
-			@$out[ $sql ] ++;
+			$out[ $sql ] ++;
 		}
 		asort( $out );
 		return;
 	}
 
-	function _query_count( $queries ) {
+	public function _query_count( $queries ) {
 		// this requires the savequeries patch at https://core.trac.wordpress.org/ticket/5218
 		$out = array();
 		foreach ( $queries as $q ) {
 			if ( empty( $q[2] ) ) {
-				@$out['unknown'] ++;
+				$out['unknown']++;
 			} else {
-				@$out[ $q[2] ] ++;
+				$out[ $q[2] ]++;
 			}
 		}
 		return $out;
 	}
 
-	function _dirty_objects_count( $dirty_objects ) {
+	public function _dirty_objects_count( $dirty_objects ) {
 		$out = array();
 		foreach ( array_keys( $dirty_objects ) as $group ) {
 			$out[ $group ] = count( $dirty_objects[ $group ] );
@@ -171,7 +171,7 @@ class WPProfiler {
 		return $out;
 	}
 
-	function array_add( $a, $b ) {
+	public function array_add( $a, $b ) {
 		$out = $a;
 		foreach ( array_keys( $b ) as $key ) {
 			if ( array_key_exists( $key, $out ) ) {
@@ -183,7 +183,7 @@ class WPProfiler {
 		return $out;
 	}
 
-	function array_sub( $a, $b ) {
+	public function array_sub( $a, $b ) {
 		$out = $a;
 		foreach ( array_keys( $b ) as $key ) {
 			if ( array_key_exists( $key, $b ) ) {
@@ -193,7 +193,7 @@ class WPProfiler {
 		return $out;
 	}
 
-	function print_summary() {
+	public function print_summary() {
 		$results = $this->results();
 
 		printf( "\nname                      calls   time action filter   warm   cold misses  dirty\n" );
diff --git a/multisite.xml b/multisite.xml
index 0854ca4737..73934a7a90 100644
--- a/multisite.xml
+++ b/multisite.xml
@@ -6,19 +6,12 @@
 		>
 	<php>
 		<const name="WP_TESTS_MULTISITE" value="1" />
+		<const name="WP_RUN_CORE_TESTS" value="1" />
 	</php>
 	<testsuites>
 		<!-- Default test suite to run all tests -->
 		<testsuite name="default">
 			<directory suffix=".php">tests</directory>
-			<file phpVersion="5.3.0">tests/phpunit/tests/actions/closures.php</file>
-			<file phpVersion="5.3.0">tests/phpunit/tests/image/editor.php</file>
-			<file phpVersion="5.3.0">tests/phpunit/tests/image/editorGd.php</file>
-			<file phpVersion="5.3.0">tests/phpunit/tests/image/editorImagick.php</file>
-			<exclude>tests/phpunit/tests/actions/closures.php</exclude>
-			<exclude>tests/phpunit/tests/image/editor.php</exclude>
-			<exclude>tests/phpunit/tests/image/editorGd.php</exclude>
-			<exclude>tests/phpunit/tests/image/editorImagick.php</exclude>
 			<!-- Path relative to the checkout root, for PHPUnit 3.6.x -->
 			<exclude>tests/phpunit/tests/rest-api/rest-autosaves-controller.php</exclude>
 			<!-- Same path relative to the configuration file, for PHPUnit 4.0.0+ -->
@@ -41,9 +34,6 @@
 			<group>oembed-headers</group>
 		</exclude>
 	</groups>
-	<php>
-		<const name="WP_RUN_CORE_TESTS" value="1" />
-	</php>
 	<listeners>
 		<listener class="SpeedTrapListener" file="tests/phpunit/includes/listener-loader.php">
 			<arguments>
diff --git a/tests/actions.php b/tests/actions.php
index d23e6a63b2..e83b6bfc15 100644
--- a/tests/actions.php
+++ b/tests/actions.php
@@ -153,6 +153,25 @@ class Tests_Actions extends WP_UnitTestCase {
 		$this->assertEquals( array( $val1, $val2 ), array_pop( $argsvar3 ) );
 	}
 
+	/**
+	 * Tests PHP 4 notation for calling actions while passing in an object by reference.
+	 *
+	 * @ticket 48312
+	 */
+	function test_action_args_with_php4_syntax() {
+		$a   = new MockAction();
+		$tag = __FUNCTION__;
+		$val = new stdClass;
+
+		add_action( $tag, array( &$a, 'action' ) );
+		// 娗ll the action with PHP 4 notation for passing object by reference.
+		do_action( $tag, array( &$val ) );
+
+		$call_count = $a->get_call_count();
+		$argsvar    = $a->get_args();
+		$this->assertSame( array( $val ), array_pop( $argsvar ) );
+	}
+
 	function test_action_priority() {
 		$a   = new MockAction();
 		$tag = __FUNCTION__;
diff --git a/tests/admin/includesCommunityEvents.php b/tests/admin/includesCommunityEvents.php
index 911d052f3c..995c5a1288 100644
--- a/tests/admin/includesCommunityEvents.php
+++ b/tests/admin/includesCommunityEvents.php
@@ -164,7 +164,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 
 		$this->assertNotWPError( $response );
 		$this->assertEqualSetsWithIndex( $this->get_user_location(), $response['location'] );
-		$this->assertEquals( date( 'l, M j, Y', strtotime( 'next Sunday 1pm' ) ), $response['events'][0]['formatted_date'] );
+		$this->assertEquals( gmdate( 'l, M j, Y', strtotime( 'next Sunday 1pm' ) ), $response['events'][0]['formatted_date'] );
 		$this->assertEquals( '1:00 pm', $response['events'][0]['formatted_time'] );
 
 		remove_filter( 'pre_http_request', array( $this, '_http_request_valid_response' ) );
@@ -185,7 +185,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 
 		$this->assertNotWPError( $cached_events );
 		$this->assertEqualSetsWithIndex( $this->get_user_location(), $cached_events['location'] );
-		$this->assertEquals( date( 'l, M j, Y', strtotime( 'next Sunday 1pm' ) ), $cached_events['events'][0]['formatted_date'] );
+		$this->assertEquals( gmdate( 'l, M j, Y', strtotime( 'next Sunday 1pm' ) ), $cached_events['events'][0]['formatted_date'] );
 		$this->assertEquals( '1:00 pm', $cached_events['events'][0]['formatted_time'] );
 
 		remove_filter( 'pre_http_request', array( $this, '_http_request_valid_response' ) );
@@ -211,7 +211,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/Eastbay-WordPress-Meetup/events/236031233/',
 							'meetup'     => 'The East Bay WordPress Meetup Group',
 							'meetup_url' => 'https://www.meetup.com/Eastbay-WordPress-Meetup/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Sunday 1pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Sunday 1pm' ) ),
 							'location'   => array(
 								'location'  => 'Oakland, CA, USA',
 								'country'   => 'us',
@@ -225,7 +225,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/Wordpress-Bay-Area-CA-Foothills/events/237706839/',
 							'meetup'     => 'WordPress Bay Area Foothills Group',
 							'meetup_url' => 'https://www.meetup.com/Wordpress-Bay-Area-CA-Foothills/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Wednesday 1:30pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Wednesday 1:30pm' ) ),
 							'location'   => array(
 								'location'  => 'Milpitas, CA, USA',
 								'country'   => 'us',
@@ -239,7 +239,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://2017.kansascity.wordcamp.org',
 							'meetup'     => null,
 							'meetup_url' => null,
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Saturday' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Saturday' ) ),
 							'location'   => array(
 								'location'  => 'Kansas City, MO',
 								'country'   => 'US',
@@ -303,7 +303,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/Eastbay-WordPress-Meetup/events/236031233/',
 							'meetup'     => 'The East Bay WordPress Meetup Group',
 							'meetup_url' => 'https://www.meetup.com/Eastbay-WordPress-Meetup/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Monday 1pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Monday 1pm' ) ),
 							'location'   => array(
 								'location'  => 'Oakland, CA, USA',
 								'country'   => 'us',
@@ -317,7 +317,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/Wordpress-Bay-Area-CA-Foothills/events/237706839/',
 							'meetup'     => 'WordPress Bay Area Foothills Group',
 							'meetup_url' => 'https://www.meetup.com/Wordpress-Bay-Area-CA-Foothills/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Tuesday 1:30pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Tuesday 1:30pm' ) ),
 							'location'   => array(
 								'location'  => 'Milpitas, CA, USA',
 								'country'   => 'us',
@@ -331,7 +331,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/sanjosewp/events/245419844/',
 							'meetup'     => 'The San Jose WordPress Meetup',
 							'meetup_url' => 'https://www.meetup.com/sanjosewp/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Wednesday 5:30pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Wednesday 5:30pm' ) ),
 							'location'   => array(
 								'location'  => 'Milpitas, CA, USA',
 								'country'   => 'us',
@@ -345,7 +345,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://2018.sandiego.wordcamp.org',
 							'meetup'     => null,
 							'meetup_url' => null,
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Thursday 9am' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Thursday 9am' ) ),
 							'location'   => array(
 								'location'  => 'San Diego, CA',
 								'country'   => 'US',
@@ -406,7 +406,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/Eastbay-WordPress-Meetup/events/236031233/',
 							'meetup'     => 'The East Bay WordPress Meetup Group',
 							'meetup_url' => 'https://www.meetup.com/Eastbay-WordPress-Meetup/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( '2 days ago' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( '2 days ago' ) ),
 							'location'   => array(
 								'location'  => 'Oakland, CA, USA',
 								'country'   => 'us',
@@ -420,7 +420,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://2018.sandiego.wordcamp.org',
 							'meetup'     => null,
 							'meetup_url' => null,
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Tuesday 9am' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Tuesday 9am' ) ),
 							'location'   => array(
 								'location'  => 'San Diego, CA',
 								'country'   => 'US',
@@ -434,7 +434,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/Wordpress-Bay-Area-CA-Foothills/events/237706839/',
 							'meetup'     => 'WordPress Bay Area Foothills Group',
 							'meetup_url' => 'https://www.meetup.com/Wordpress-Bay-Area-CA-Foothills/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Wednesday 1:30pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Wednesday 1:30pm' ) ),
 							'location'   => array(
 								'location'  => 'Milpitas, CA, USA',
 								'country'   => 'us',
@@ -448,7 +448,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://www.meetup.com/sanjosewp/events/245419844/',
 							'meetup'     => 'The San Jose WordPress Meetup',
 							'meetup_url' => 'https://www.meetup.com/sanjosewp/',
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Thursday 5:30pm' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Thursday 5:30pm' ) ),
 							'location'   => array(
 								'location'  => 'Milpitas, CA, USA',
 								'country'   => 'us',
@@ -462,7 +462,7 @@ class Test_WP_Community_Events extends WP_UnitTestCase {
 							'url'        => 'https://2018.la.wordcamp.org',
 							'meetup'     => null,
 							'meetup_url' => null,
-							'date'       => date( 'Y-m-d H:i:s', strtotime( 'next Friday 9am' ) ),
+							'date'       => gmdate( 'Y-m-d H:i:s', strtotime( 'next Friday 9am' ) ),
 							'location'   => array(
 								'location'  => 'Los Angeles, CA',
 								'country'   => 'US',
diff --git a/tests/admin/includesPlugin.php b/tests/admin/includesPlugin.php
index 0526801417..233c6ea19f 100644
--- a/tests/admin/includesPlugin.php
+++ b/tests/admin/includesPlugin.php
@@ -57,6 +57,208 @@ class Tests_Admin_includesPlugin extends WP_UnitTestCase {
 		wp_set_current_user( $current_user );
 	}
 
+	/**
+	 * Tests the priority parameter.
+	 *
+	 * @ticket 39776
+	 *
+	 * @covers ::add_submenu_page
+	 *
+	 * @param int $priority          The position of the new item.
+	 * @param int $expected_position Where the new item is expected to appear.
+	 *
+	 * @dataProvider data_submenu_priority
+	 */
+	function test_submenu_priority( $priority, $expected_position ) {
+		global $submenu;
+		global $menu;
+		$current_user = get_current_user_id();
+		$admin_user   = self::factory()->user->create( array( 'role' => 'administrator' ) );
+		wp_set_current_user( $admin_user );
+		set_current_screen( 'dashboard' );
+
+		// Setup a menu with some items.
+		$parent = add_menu_page( 'Test Toplevel', 'Test Toplevel', 'manage_options', 'mt-top-level-handle', 'mt_toplevel_page' );
+		foreach ( $this->submenus_to_add() as $menu_to_add ) {
+			add_submenu_page( $parent, $menu_to_add[0], $menu_to_add[1], $menu_to_add[2], $menu_to_add[3], $menu_to_add[4] );
+		}
+
+		// Insert the new page.
+		add_submenu_page( $parent, 'New Page', 'New Page', 'manage_options', 'custom-position', 'custom_pos', $priority );
+		wp_set_current_user( $current_user );
+
+		// Clean up the temporary user.
+		wp_delete_user( $admin_user );
+
+		// Verify the menu was inserted at the expected position.
+		$this->assertSame( 'custom-position', $submenu[ $parent ][ $expected_position ][2] );
+	}
+
+	/**
+	 * Tests the priority parameter for menu helper functions.
+	 *
+	 * @ticket 39776
+	 *
+	 * @covers ::add_management_page
+	 * @covers ::add_options_page
+	 * @covers ::add_theme_page
+	 * @covers ::add_plugins_page
+	 * @covers ::add_users_page
+	 * @covers ::add_dashboard_page
+	 * @covers ::add_posts_page
+	 * @covers ::add_media_page
+	 * @covers ::add_links_page
+	 * @covers ::add_pages_page
+	 * @covers ::add_comments_page
+	 *
+	 * @param int $priority          The position of the new item.
+	 * @param int $expected_position Where the new item is expected to appear.
+	 *
+	 * @dataProvider data_submenu_priority
+	 */
+	function test_submenu_helpers_priority( $priority, $expected_position ) {
+		global $submenu;
+		global $menu;
+
+		// Skip for multisite.
+		if ( is_multisite() ) {
+			return;
+		}
+
+		// Reset menus.
+		$submenu = array();
+		$menu    = array();
+
+		$current_user = get_current_user_id();
+		$admin_user   = self::factory()->user->create( array( 'role' => 'administrator' ) );
+		wp_set_current_user( $admin_user );
+		set_current_screen( 'dashboard' );
+
+		// Test the helper functions that use `add_submenu_page`. Each helper adds to a specific menu root.
+		$helper_functions = array(
+			array(
+				'callback'  => 'add_management_page',
+				'menu_root' => 'tools.php',
+			),
+			array(
+				'callback'  => 'add_options_page',
+				'menu_root' => 'options-general.php',
+			),
+			array(
+				'callback'  => 'add_theme_page',
+				'menu_root' => 'themes.php',
+			),
+			array(
+				'callback'  => 'add_plugins_page',
+				'menu_root' => 'plugins.php',
+			),
+			array(
+				'callback'  => 'add_users_page',
+				'menu_root' => 'users.php',
+			),
+			array(
+				'callback'  => 'add_dashboard_page',
+				'menu_root' => 'index.php',
+			),
+			array(
+				'callback'  => 'add_posts_page',
+				'menu_root' => 'edit.php',
+			),
+			array(
+				'callback'  => 'add_media_page',
+				'menu_root' => 'upload.php',
+			),
+			array(
+				'callback'  => 'add_links_page',
+				'menu_root' => 'link-manager.php',
+			),
+			array(
+				'callback'  => 'add_pages_page',
+				'menu_root' => 'edit.php?post_type=page',
+			),
+			array(
+				'callback'  => 'add_comments_page',
+				'menu_root' => 'edit-comments.php',
+			),
+		);
+
+		$actual_positions = array();
+
+		foreach ( $helper_functions as $helper_function ) {
+
+			// Build up demo pages on the menu root.
+			foreach ( $this->submenus_to_add() as $menu_to_add ) {
+				add_menu_page( $menu_to_add[0], $menu_to_add[1], $menu_to_add[2], $helper_function['menu_root'], $helper_function['menu_root'] );
+			}
+
+			$test = 'test_' . $helper_function['callback'];
+
+			// Call the helper function, passing the desired priority.
+			call_user_func_array( $helper_function['callback'], array( $test, $test, 'manage_options', 'custom-position', '', $priority ) );
+
+			$actual_positions[ $test ] = $submenu[ $helper_function['menu_root'] ][ $expected_position ][2];
+		}
+
+		// Clean up the temporary user.
+		wp_delete_user( $admin_user );
+
+		foreach ( $actual_positions as $test => $actual_position ) {
+			// Verify the menu was inserted at the expected position.
+			$this->assertSame( 'custom-position', $actual_position, 'Menu not inserted at the expected position with ' . $test );
+		}
+	}
+
+	/**
+	 * Helper to store the menus that are to be added, so getting the length is programmatically done.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string Page title.
+	 *         @type string Menu_title.
+	 *         @type string Capability.
+	 *         @type string Menu slug.
+	 *         @type string Function.
+	 *     }
+	 * }
+	 */
+	function submenus_to_add() {
+		return array(
+			array( 'Submenu Priority', 'Submenu Priority', 'manage_options', 'sub-page', '' ),
+			array( 'Submenu Priority 2', 'Submenu Priority 2', 'manage_options', 'sub-page2', '' ),
+			array( 'Submenu Priority 3', 'Submenu Priority 3', 'manage_options', 'sub-page3', '' ),
+			array( 'Submenu Priority 4', 'Submenu Priority 4', 'manage_options', 'sub-page4', '' ),
+			array( 'Submenu Priority 5', 'Submenu Priority 5', 'manage_options', 'sub-page5', '' ),
+		);
+	}
+
+	/**
+	 * Data provider for test_submenu_helpers_priority().
+	 *
+	 * @since 5.3.0
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type int|null Priority.
+	 *         @type int      Expected position.
+	 *     }
+	 * }
+	 */
+	function data_submenu_priority() {
+		$menu_count = count( $this->submenus_to_add() );
+		return array(
+			array( null, $menu_count ),        // Insert at the end of the menu if null is passed. Default behavior.
+			array( 0, 0 ),                     // Insert at the beginning of the menu if 0 is passed.
+			array( -1, 0 ),                    // Negative numbers are treated the same as passing 0.
+			array( -7, 0 ),                    // Negative numbers are treated the same as passing 0.
+			array( 1, 1 ),                     // Insert as the second item.
+			array( 3, 3 ),                     // Insert as the 4th item.
+			array( $menu_count, $menu_count ), // Numbers equal to the number of items are added at the end.
+			array( 123456, $menu_count ),      // Numbers higher than the number of items are added at the end.
+		);
+	}
+
 	function test_is_plugin_active_true() {
 		activate_plugin( 'hello.php' );
 		$test = is_plugin_active( 'hello.php' );
@@ -102,8 +304,8 @@ class Tests_Admin_includesPlugin extends WP_UnitTestCase {
 		$plugin = $this->_create_plugin( null, 'list_files_test_plugin.php', $plugin_dir );
 
 		$sub_dir = trailingslashit( dirname( $plugin[1] ) ) . 'subdir';
-		@mkdir( $sub_dir );
-		@file_put_contents( $sub_dir . '/subfile.php', '<?php // Silence.' );
+		mkdir( $sub_dir );
+		file_put_contents( $sub_dir . '/subfile.php', '<?php // Silence.' );
 
 		$plugin_files = get_plugin_files( plugin_basename( $plugin[1] ) );
 		$expected     = array(
@@ -406,7 +608,8 @@ class Tests_Admin_includesPlugin extends WP_UnitTestCase {
 			}
 
 			$files_to_move = array();
-			if ( $mu_plugins = opendir( WPMU_PLUGIN_DIR ) ) {
+			$mu_plugins    = opendir( WPMU_PLUGIN_DIR );
+			if ( $mu_plugins ) {
 				while ( false !== $plugin = readdir( $mu_plugins ) ) {
 					if ( 0 !== strpos( $plugin, '.' ) ) {
 						$files_to_move[] = $plugin;
@@ -414,7 +617,7 @@ class Tests_Admin_includesPlugin extends WP_UnitTestCase {
 				}
 			}
 
-			@closedir( $mu_plugins );
+			closedir( $mu_plugins );
 
 			foreach ( $files_to_move as $file_to_move ) {
 				$f = rename( WPMU_PLUGIN_DIR . '/' . $file_to_move, $mu_bu_dir . '/' . $file_to_move );
@@ -432,7 +635,8 @@ class Tests_Admin_includesPlugin extends WP_UnitTestCase {
 	private function _restore_mu_plugins() {
 		$mu_bu_dir     = WP_CONTENT_DIR . '/mu-plugin-backup';
 		$files_to_move = array();
-		if ( is_dir( $mu_bu_dir ) && $mu_plugins = opendir( $mu_bu_dir ) ) {
+		$mu_plugins    = @opendir( $mu_bu_dir );
+		if ( $mu_plugins ) {
 			while ( false !== $plugin = readdir( $mu_plugins ) ) {
 				if ( 0 !== strpos( $plugin, '.' ) ) {
 					$files_to_move[] = $plugin;
@@ -440,7 +644,7 @@ class Tests_Admin_includesPlugin extends WP_UnitTestCase {
 			}
 		}
 
-		@closedir( $mu_plugins );
+		closedir( $mu_plugins );
 
 		foreach ( $files_to_move as $file_to_move ) {
 			rename( $mu_bu_dir . '/' . $file_to_move, WPMU_PLUGIN_DIR . '/' . $file_to_move );
diff --git a/tests/admin/includesPost.php b/tests/admin/includesPost.php
index d4cc606dcd..cad9742f8d 100644
--- a/tests/admin/includesPost.php
+++ b/tests/admin/includesPost.php
@@ -13,11 +13,15 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 	protected static $user_ids = array();
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$user_ids = self::$author_ids = $factory->user->create_many( 2, array( 'role' => 'author' ) );
+		self::$user_ids   = $factory->user->create_many( 2, array( 'role' => 'author' ) );
+		self::$author_ids = self::$user_ids;
 
-		self::$user_ids[] = self::$contributor_id = $factory->user->create( array( 'role' => 'contributor' ) );
-		self::$user_ids[] = self::$editor_id = $factory->user->create( array( 'role' => 'editor' ) );
-		self::$user_ids[] = self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$contributor_id = $factory->user->create( array( 'role' => 'contributor' ) );
+		self::$user_ids[]     = self::$contributor_id;
+		self::$editor_id      = $factory->user->create( array( 'role' => 'editor' ) );
+		self::$user_ids[]     = self::$editor_id;
+		self::$admin_id       = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$user_ids[]     = self::$admin_id;
 
 		self::$post_id = $factory->post->create();
 	}
@@ -355,7 +359,7 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 		$permalink_structure = '%postname%';
 		$this->set_permalink_structure( "/$permalink_structure/" );
 
-		$future_date = date( 'Y-m-d H:i:s', time() + 100 );
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 100 );
 		$p           = self::factory()->post->create(
 			array(
 				'post_status' => 'future',
@@ -377,7 +381,7 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 	public function test_get_sample_permalink_html_should_use_default_permalink_for_view_post_link_when_pretty_permalinks_are_disabled() {
 		wp_set_current_user( self::$admin_id );
 
-		$future_date = date( 'Y-m-d H:i:s', time() + 100 );
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 100 );
 		$p           = self::factory()->post->create(
 			array(
 				'post_status' => 'future',
@@ -400,7 +404,7 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 
 		wp_set_current_user( self::$admin_id );
 
-		$future_date = date( 'Y-m-d H:i:s', time() + 100 );
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 100 );
 		$p           = self::factory()->post->create(
 			array(
 				'post_status' => 'future',
@@ -464,7 +468,7 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 		$this->assertContains( '>new_slug-媯堭堜<', $found, $message );
 
 		// Scheduled posts should use published permalink
-		$future_date = date( 'Y-m-d H:i:s', time() + 100 );
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 100 );
 		$p           = self::factory()->post->create(
 			array(
 				'post_status' => 'future',
@@ -507,7 +511,7 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 
 		wp_set_current_user( self::$admin_id );
 
-		$future_date = date( 'Y-m-d H:i:s', time() + 100 );
+		$future_date = gmdate( 'Y-m-d H:i:s', time() + 100 );
 		$p           = self::factory()->post->create(
 			array(
 				'post_status' => 'pending',
@@ -851,4 +855,38 @@ class Tests_Admin_Includes_Post extends WP_UnitTestCase {
 		$this->assertNotFalse( add_meta( $p ) );
 		$this->assertEquals( '', get_post_meta( $p, 'testkey', true ) );
 	}
+
+	/**
+	 * Test the post type support in post_exists().
+	 *
+	 * @ticket 37406
+	 */
+	public function test_post_exists_should_support_post_type() {
+		$title     = 'Foo Bar';
+		$post_type = 'page';
+		$post_id   = self::factory()->post->create(
+			array(
+				'post_title' => $title,
+				'post_type'  => $post_type,
+			)
+		);
+		$this->assertSame( $post_id, post_exists( $title, null, null, $post_type ) );
+	}
+
+	/**
+	 * Test that post_exists() doesn't find an existing page as a post.
+	 *
+	 * @ticket 37406
+	 */
+	public function test_post_exists_should_not_match_a_page_for_post() {
+		$title     = 'Foo Bar';
+		$post_type = 'page';
+		$post_id   = self::factory()->post->create(
+			array(
+				'post_title' => $title,
+				'post_type'  => $post_type,
+			)
+		);
+		$this->assertSame( 0, post_exists( $title, null, null, 'post' ) );
+	}
 }
diff --git a/tests/admin/includesSchema.php b/tests/admin/includesSchema.php
index e11c4ecd8b..b873576dbf 100644
--- a/tests/admin/includesSchema.php
+++ b/tests/admin/includesSchema.php
@@ -28,6 +28,7 @@ class Tests_Admin_Includes_Schema extends WP_UnitTestCase {
 		$charset_collate  = $wpdb->get_charset_collate();
 		$max_index_length = 191;
 
+		// phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query(
 			"
 			CREATE TABLE {$options} (
@@ -66,6 +67,7 @@ class Tests_Admin_Includes_Schema extends WP_UnitTestCase {
 			) {$charset_collate}
 			"
 		);
+		// phpcs:enable
 	}
 
 	/**
@@ -78,9 +80,11 @@ class Tests_Admin_Includes_Schema extends WP_UnitTestCase {
 		$blogmeta = self::$blogmeta;
 		$sitemeta = self::$sitemeta;
 
+		// phpcs:disable WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DROP TABLE IF EXISTS {$options}" );
 		$wpdb->query( "DROP TABLE IF EXISTS {$blogmeta}" );
 		$wpdb->query( "DROP TABLE IF EXISTS {$sitemeta}" );
+		// phpcs:enable
 	}
 
 	/**
diff --git a/tests/admin/includesScreen.php b/tests/admin/includesScreen.php
index e576c60f44..b972944bb6 100644
--- a/tests/admin/includesScreen.php
+++ b/tests/admin/includesScreen.php
@@ -7,120 +7,151 @@
 class Tests_Admin_includesScreen extends WP_UnitTestCase {
 	var $core_screens = array(
 		'index.php'                            => array(
-			'base' => 'dashboard',
-			'id'   => 'dashboard',
+			'base'            => 'dashboard',
+			'id'              => 'dashboard',
+			'is_block_editor' => false,
 		),
 		'edit.php'                             => array(
-			'base'      => 'edit',
-			'id'        => 'edit-post',
-			'post_type' => 'post',
+			'base'            => 'edit',
+			'id'              => 'edit-post',
+			'post_type'       => 'post',
+			'is_block_editor' => false,
 		),
 		'post-new.php'                         => array(
-			'action'    => 'add',
-			'base'      => 'post',
-			'id'        => 'post',
-			'post_type' => 'post',
+			'action'          => 'add',
+			'base'            => 'post',
+			'id'              => 'post',
+			'post_type'       => 'post',
+			'is_block_editor' => true,
+		),
+		'post.php'                             => array(
+			'base'            => 'post',
+			'id'              => 'post',
+			'post_type'       => 'post',
+			'is_block_editor' => true,
 		),
 		'edit-tags.php'                        => array(
-			'base'      => 'edit-tags',
-			'id'        => 'edit-post_tag',
-			'post_type' => 'post',
-			'taxonomy'  => 'post_tag',
+			'base'            => 'edit-tags',
+			'id'              => 'edit-post_tag',
+			'post_type'       => 'post',
+			'taxonomy'        => 'post_tag',
+			'is_block_editor' => false,
 		),
 		'edit-tags.php?taxonomy=post_tag'      => array(
-			'base'      => 'edit-tags',
-			'id'        => 'edit-post_tag',
-			'post_type' => 'post',
-			'taxonomy'  => 'post_tag',
+			'base'            => 'edit-tags',
+			'id'              => 'edit-post_tag',
+			'post_type'       => 'post',
+			'taxonomy'        => 'post_tag',
+			'is_block_editor' => false,
 		),
 		'edit-tags.php?taxonomy=category'      => array(
-			'base'      => 'edit-tags',
-			'id'        => 'edit-category',
-			'post_type' => 'post',
-			'taxonomy'  => 'category',
+			'base'            => 'edit-tags',
+			'id'              => 'edit-category',
+			'post_type'       => 'post',
+			'taxonomy'        => 'category',
+			'is_block_editor' => false,
 		),
 		'upload.php'                           => array(
-			'base'      => 'upload',
-			'id'        => 'upload',
-			'post_type' => 'attachment',
+			'base'            => 'upload',
+			'id'              => 'upload',
+			'post_type'       => 'attachment',
+			'is_block_editor' => false,
 		),
 		'media-new.php'                        => array(
-			'action' => 'add',
-			'base'   => 'media',
-			'id'     => 'media',
+			'action'          => 'add',
+			'base'            => 'media',
+			'id'              => 'media',
+			'is_block_editor' => false,
 		),
 		'edit.php?post_type=page'              => array(
-			'base'      => 'edit',
-			'id'        => 'edit-page',
-			'post_type' => 'page',
+			'base'            => 'edit',
+			'id'              => 'edit-page',
+			'post_type'       => 'page',
+			'is_block_editor' => false,
 		),
 		'link-manager.php'                     => array(
-			'base' => 'link-manager',
-			'id'   => 'link-manager',
+			'base'            => 'link-manager',
+			'id'              => 'link-manager',
+			'is_block_editor' => false,
 		),
 		'link-add.php'                         => array(
-			'action' => 'add',
-			'base'   => 'link',
-			'id'     => 'link',
+			'action'          => 'add',
+			'base'            => 'link',
+			'id'              => 'link',
+			'is_block_editor' => false,
 		),
 		'edit-tags.php?taxonomy=link_category' => array(
-			'base'      => 'edit-tags',
-			'id'        => 'edit-link_category',
-			'taxonomy'  => 'link_category',
-			'post_type' => '',
+			'base'            => 'edit-tags',
+			'id'              => 'edit-link_category',
+			'taxonomy'        => 'link_category',
+			'post_type'       => '',
+			'is_block_editor' => false,
 		),
 		'edit-comments.php'                    => array(
-			'base' => 'edit-comments',
-			'id'   => 'edit-comments',
+			'base'            => 'edit-comments',
+			'id'              => 'edit-comments',
+			'is_block_editor' => false,
 		),
 		'themes.php'                           => array(
-			'base' => 'themes',
-			'id'   => 'themes',
+			'base'            => 'themes',
+			'id'              => 'themes',
+			'is_block_editor' => false,
 		),
 		'widgets.php'                          => array(
-			'base' => 'widgets',
-			'id'   => 'widgets',
+			'base'            => 'widgets',
+			'id'              => 'widgets',
+			'is_block_editor' => false,
 		),
 		'nav-menus.php'                        => array(
-			'base' => 'nav-menus',
-			'id'   => 'nav-menus',
+			'base'            => 'nav-menus',
+			'id'              => 'nav-menus',
+			'is_block_editor' => false,
 		),
 		'plugins.php'                          => array(
-			'base' => 'plugins',
-			'id'   => 'plugins',
+			'base'            => 'plugins',
+			'id'              => 'plugins',
+			'is_block_editor' => false,
 		),
 		'users.php'                            => array(
-			'base' => 'users',
-			'id'   => 'users',
+			'base'            => 'users',
+			'id'              => 'users',
+			'is_block_editor' => false,
 		),
 		'user-new.php'                         => array(
-			'action' => 'add',
-			'base'   => 'user',
-			'id'     => 'user',
+			'action'          => 'add',
+			'base'            => 'user',
+			'id'              => 'user',
+			'is_block_editor' => false,
 		),
 		'profile.php'                          => array(
-			'base' => 'profile',
-			'id'   => 'profile',
+			'base'            => 'profile',
+			'id'              => 'profile',
+			'is_block_editor' => false,
 		),
 		'tools.php'                            => array(
-			'base' => 'tools',
-			'id'   => 'tools',
+			'base'            => 'tools',
+			'id'              => 'tools',
+			'is_block_editor' => false,
 		),
 		'import.php'                           => array(
-			'base' => 'import',
-			'id'   => 'import',
+			'base'            => 'import',
+			'id'              => 'import',
+			'is_block_editor' => false,
 		),
 		'export.php'                           => array(
-			'base' => 'export',
-			'id'   => 'export',
+			'base'            => 'export',
+			'id'              => 'export',
+			'is_block_editor' => false,
 		),
 		'options-general.php'                  => array(
-			'base' => 'options-general',
-			'id'   => 'options-general',
+			'base'            => 'options-general',
+			'id'              => 'options-general',
+			'is_block_editor' => false,
 		),
 		'options-writing.php'                  => array(
-			'base' => 'options-writing',
-			'id'   => 'options-writing',
+			'base'            => 'options-writing',
+			'id'              => 'options-writing',
+			'is_block_editor' => false,
 		),
 	);
 
@@ -132,6 +163,7 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 	function tearDown() {
 		unset( $GLOBALS['wp_taxonomies']['old-or-new'] );
 		unset( $GLOBALS['screen'] );
+		unset( $GLOBALS['current_screen'] );
 		parent::tearDown();
 	}
 
@@ -139,20 +171,32 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 		global $current_screen;
 
 		foreach ( $this->core_screens as $hook_name => $screen ) {
-			$_GET              = $_POST = $_REQUEST = array();
-			$GLOBALS['taxnow'] = $GLOBALS['typenow'] = '';
-			$screen            = (object) $screen;
-			$hook              = parse_url( $hook_name );
+			$_GET               = array();
+			$_POST              = array();
+			$_REQUEST           = array();
+			$GLOBALS['taxnow']  = '';
+			$GLOBALS['typenow'] = '';
+			$screen             = (object) $screen;
+			$hook               = parse_url( $hook_name );
 
 			if ( ! empty( $hook['query'] ) ) {
 				$args = wp_parse_args( $hook['query'] );
 				if ( isset( $args['taxonomy'] ) ) {
-					$GLOBALS['taxnow'] = $_GET['taxonomy'] = $_POST['taxonomy'] = $_REQUEST['taxonomy'] = $args['taxonomy'];
+					$GLOBALS['taxnow']    = $args['taxonomy'];
+					$_GET['taxonomy']     = $args['taxonomy'];
+					$_POST['taxonomy']    = $args['taxonomy'];
+					$_REQUEST['taxonomy'] = $args['taxonomy'];
 				}
 				if ( isset( $args['post_type'] ) ) {
-					$GLOBALS['typenow'] = $_GET['post_type'] = $_POST['post_type'] = $_REQUEST['post_type'] = $args['post_type'];
+					$GLOBALS['typenow']    = $args['post_type'];
+					$_GET['post_type']     = $args['post_type'];
+					$_POST['post_type']    = $args['post_type'];
+					$_REQUEST['post_type'] = $args['post_type'];
 				} elseif ( isset( $screen->post_type ) ) {
-					$GLOBALS['typenow'] = $_GET['post_type'] = $_POST['post_type'] = $_REQUEST['post_type'] = $screen->post_type;
+					$GLOBALS['typenow']    = $screen->post_type;
+					$_GET['post_type']     = $screen->post_type;
+					$_POST['post_type']    = $screen->post_type;
+					$_REQUEST['post_type'] = $screen->post_type;
 				}
 			}
 
@@ -178,6 +222,7 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 			$this->assertFalse( $current_screen->in_admin( 'network' ) );
 			$this->assertFalse( $current_screen->in_admin( 'user' ) );
 			$this->assertFalse( $current_screen->in_admin( 'garbage' ) );
+			$this->assertSame( $screen->is_block_editor, $current_screen->is_block_editor );
 
 			// With convert_to_screen(), the same ID should return the exact $current_screen.
 			$this->assertSame( $current_screen, convert_to_screen( $screen->id ), $hook_name );
@@ -195,6 +240,7 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 		$this->assertEquals( $screen->post_type, 'page' );
 		$this->assertEquals( $screen->base, 'post' );
 		$this->assertEquals( $screen->id, 'page' );
+		$this->assertTrue( $screen->is_block_editor );
 	}
 
 	function test_post_type_with_special_suffix_as_hookname() {
@@ -203,11 +249,13 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 		$this->assertEquals( $screen->post_type, 'value-add' );
 		$this->assertEquals( $screen->base, 'post' );
 		$this->assertEquals( $screen->id, 'value-add' );
+		$this->assertFalse( $screen->is_block_editor ); // Post types do not support `show_in_rest` by default.
 
 		$screen = convert_to_screen( 'edit-value-add' ); // the -add part is key.
 		$this->assertEquals( $screen->post_type, 'value-add' );
 		$this->assertEquals( $screen->base, 'edit' );
 		$this->assertEquals( $screen->id, 'edit-value-add' );
+		$this->assertFalse( $screen->is_block_editor ); // Post types do not support `show_in_rest` by default.
 	}
 
 	function test_taxonomy_with_special_suffix_as_hookname() {
@@ -216,6 +264,7 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 		$this->assertEquals( $screen->taxonomy, 'old-or-new' );
 		$this->assertEquals( $screen->base, 'edit-tags' );
 		$this->assertEquals( $screen->id, 'edit-old-or-new' );
+		$this->assertFalse( $screen->is_block_editor );
 	}
 
 	function test_post_type_with_edit_prefix() {
@@ -224,11 +273,13 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 		$this->assertEquals( $screen->post_type, 'edit-some-thing' );
 		$this->assertEquals( $screen->base, 'post' );
 		$this->assertEquals( $screen->id, 'edit-some-thing' );
+		$this->assertFalse( $screen->is_block_editor ); // Post types do not support `show_in_rest` by default.
 
 		$screen = convert_to_screen( 'edit-edit-some-thing' );
 		$this->assertEquals( $screen->post_type, 'edit-some-thing' );
 		$this->assertEquals( $screen->base, 'edit' );
 		$this->assertEquals( $screen->id, 'edit-edit-some-thing' );
+		$this->assertFalse( $screen->is_block_editor ); // Post types do not support `show_in_rest` by default.
 	}
 
 	function test_post_type_edit_collisions() {
@@ -433,4 +484,145 @@ class Tests_Admin_includesScreen extends WP_UnitTestCase {
 
 		$GLOBALS['current_screen'] = $screen;
 	}
+
+	/**
+	 * Sets up a method for testing is_block_editor for a custom post type.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $hook Admin page hook.
+	 * @return WP_Screen Screen object.
+	 */
+	public function setup_block_editor_test( $hook = 'post.php' ) {
+		register_post_type( 'type_shows_in_rest', array( 'show_in_rest' => true ) );
+
+		$GLOBALS['typenow']     = 'type_shows_in_rest';
+		$_GET['post_type']      = 'type_shows_in_rest';
+		$_POST['post_type']     = 'type_shows_in_rest';
+		$_REQUEST['post_type']  = 'type_shows_in_rest';
+		$GLOBALS['hook_suffix'] = $hook;
+
+		if ( 'post.php' === $hook ) {
+			$post_id      = $this->factory->post->create(
+				array(
+					'post_type' => 'type_shows_in_rest',
+				)
+			);
+			$_GET['post'] = $post_id;
+		}
+
+		set_current_screen();
+
+		return get_current_screen();
+	}
+
+	/**
+	 * Data provider for testing is_block_editor.
+	 */
+	public function data_is_block_editor() {
+		return array(
+			array(
+				// Edit post: Post type supports `show_in_rest`, no filters.
+				'hook'     => 'post.php',
+				'filter'   => array(),
+				'expected' => true,
+			),
+			array(
+				// Edit post: Support is disabled using post specific filter.
+				'hook'     => 'post.php',
+				'filter'   => array(
+					'name'     => 'use_block_editor_for_post',
+					'function' => '__return_false',
+				),
+				'expected' => false,
+			),
+			array(
+				// Edit post: Support is disabled using post type specific filter.
+				'hook'     => 'post.php',
+				'filter'   => array(
+					'name'     => 'use_block_editor_for_post_type',
+					'function' => '__return_false',
+				),
+				'expected' => false,
+			),
+			array(
+				// Edit post: Support is disabled using global replace filter.
+				'hook'     => 'post.php',
+				'filter'   => array(
+					'name'     => 'replace_editor',
+					'function' => '__return_true',
+				),
+				'expected' => false,
+			),
+			array(
+				// Create post: Post type supports `show_in_rest`, no filters.
+				'hook'     => 'post-new.php',
+				'filter'   => array(),
+				'expected' => true,
+			),
+			array(
+				// Create post: Support is disabled using post type specific filter.
+				'hook'     => 'post-new.php',
+				'filter'   => array(
+					'name'     => 'use_block_editor_for_post_type',
+					'function' => '__return_false',
+				),
+				'expected' => false,
+			),
+
+			array(
+				// Create post: Support is not immediately disabled using post specific filter.
+				'hook'     => 'post-new.php',
+				'filter'   => array(
+					'name'     => 'use_block_editor_for_post',
+					'function' => '__return_false',
+				),
+				'expected' => true,
+			),
+
+			array(
+				// Create post: Support is not immediately disabled using global replace filter.
+				'hook'     => 'post-new.php',
+				'filter'   => array(
+					'name'     => 'replace_editor',
+					'function' => '__return_true',
+				),
+				'expected' => true,
+			),
+		);
+	}
+
+	/**
+	 * When editing a post type with `show_in_rest` support, the is_block_editor should indicate support.
+	 *
+	 * @ticket 46195
+	 * @dataProvider data_is_block_editor
+	 *
+	 * @param string $hook Admin hook.
+	 * @param array  $filter {
+	 *     Optional. Filter name and function to hook.
+	 *
+	 *     $name     string Filter name to hook a function.
+	 *     $function string Function name to hook to the filter.
+	 * }
+	 * @param bool   $expected The expected `is_block_editor` value.
+	 */
+	public function test_is_block_editor( $hook, $filter, $expected ) {
+		if ( ! empty( $filter['name'] ) && ! empty( $filter['function'] ) ) {
+			add_filter( $filter['name'], $filter['function'] );
+		}
+
+		$screen = $this->setup_block_editor_test( $hook );
+
+		$this->assertSame( 'post', $screen->base );
+		$this->assertSame( 'type_shows_in_rest', $screen->post_type );
+
+		if ( 'post.php' === $hook ) {
+			$this->assertEmpty( $screen->action );
+		} else {
+			$this->assertSame( 'add', $screen->action );
+		}
+
+		$this->assertSame( $expected, $screen->is_block_editor );
+	}
 }
diff --git a/tests/admin/includesTemplate.php b/tests/admin/includesTemplate.php
index c0bc3b8884..7e1745125f 100644
--- a/tests/admin/includesTemplate.php
+++ b/tests/admin/includesTemplate.php
@@ -108,4 +108,81 @@ class Tests_Admin_includesTemplate extends WP_UnitTestCase {
 		$this->assertFalse( $wp_meta_boxes['attachment']['advanced']['default']['testbox1'] );
 	}
 
+	/**
+	 * Test calling get_settings_errors() with variations on where it gets errors from.
+	 *
+	 * @ticket 42498
+	 * @covers ::get_settings_errors()
+	 * @global array $wp_settings_errors
+	 */
+	public function test_get_settings_errors_sources() {
+		global $wp_settings_errors;
+
+		$blogname_error        = array(
+			'setting' => 'blogname',
+			'code'    => 'blogname',
+			'message' => 'Capital P dangit!',
+			'type'    => 'error',
+		);
+		$blogdescription_error = array(
+			'setting' => 'blogdescription',
+			'code'    => 'blogdescription',
+			'message' => 'Too short',
+			'type'    => 'error',
+		);
+
+		$wp_settings_errors = null;
+		$this->assertSame( array(), get_settings_errors( 'blogname' ) );
+
+		// Test getting errors from transient.
+		$_GET['settings-updated'] = '1';
+		set_transient( 'settings_errors', array( $blogname_error ) );
+		$wp_settings_errors = null;
+		$this->assertSame( array( $blogname_error ), get_settings_errors( 'blogname' ) );
+
+		// Test getting errors from transient and from global.
+		$_GET['settings-updated'] = '1';
+		set_transient( 'settings_errors', array( $blogname_error ) );
+		$wp_settings_errors = null;
+		add_settings_error( $blogdescription_error['setting'], $blogdescription_error['code'], $blogdescription_error['message'], $blogdescription_error['type'] );
+		$this->assertEqualSets( array( $blogname_error, $blogdescription_error ), get_settings_errors() );
+
+		$wp_settings_errors = null;
+	}
+
+	/**
+	 * @ticket 44941
+	 * @covers ::settings_errors()
+	 * @global array $wp_settings_errors
+	 * @dataProvider settings_errors_css_classes_provider
+	 */
+	public function test_settings_errors_css_classes( $type, $expected ) {
+		global $wp_settings_errors;
+
+		add_settings_error( 'foo', 'bar', 'Capital P dangit!', $type );
+
+		ob_start();
+		settings_errors();
+		$output = ob_get_clean();
+
+		$wp_settings_errors = null;
+
+		$expected = sprintf( 'notice %s settings-error is-dismissible', $expected );
+
+		$this->assertContains( $expected, $output );
+		$this->assertNotContains( 'notice-notice-', $output );
+	}
+
+	public function settings_errors_css_classes_provider() {
+		return array(
+			array( 'error', 'notice-error' ),
+			array( 'success', 'notice-success' ),
+			array( 'warning', 'notice-warning' ),
+			array( 'info', 'notice-info' ),
+			array( 'updated', 'notice-success' ),
+			array( 'notice-error', 'notice-error' ),
+			array( 'error my-own-css-class hello world', 'error my-own-css-class hello world' ),
+		);
+	}
+
 }
diff --git a/tests/admin/wpPrivacyRequestsTable.php b/tests/admin/wpPrivacyRequestsTable.php
index 9c9be20f92..debe163862 100644
--- a/tests/admin/wpPrivacyRequestsTable.php
+++ b/tests/admin/wpPrivacyRequestsTable.php
@@ -24,10 +24,6 @@ class Tests_Admin_WpPrivacyRequestsTable extends WP_UnitTestCase {
 	 * @return PHPUnit_Framework_MockObject_MockObject|WP_Privacy_Requests_Table $instance Mocked class instance.
 	 */
 	public function get_mocked_class_instance() {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			$this->markTestSkipped( 'ReflectionMethod::setAccessible is only available in PHP 5.3+' );
-		}
-
 		$args = array(
 			'plural'   => 'privacy_requests',
 			'singular' => 'privacy_request',
diff --git a/tests/adminbar.php b/tests/adminbar.php
index fde88737bd..a9a2ed4564 100644
--- a/tests/adminbar.php
+++ b/tests/adminbar.php
@@ -21,9 +21,12 @@ class Tests_AdminBar extends WP_UnitTestCase {
 	}
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$user_ids[] = self::$editor_id = $factory->user->create( array( 'role' => 'editor' ) );
-		self::$user_ids[] = self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
-		self::$user_ids[] = self::$no_role_id = $factory->user->create( array( 'role' => '' ) );
+		self::$editor_id  = $factory->user->create( array( 'role' => 'editor' ) );
+		self::$user_ids[] = self::$editor_id;
+		self::$admin_id   = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$user_ids[] = self::$admin_id;
+		self::$no_role_id = $factory->user->create( array( 'role' => '' ) );
+		self::$user_ids[] = self::$no_role_id;
 	}
 
 	/**
@@ -741,7 +744,7 @@ class Tests_AdminBar extends WP_UnitTestCase {
 
 		$nodes = $wp_admin_bar->get_nodes();
 		foreach ( $this->get_my_sites_network_menu_items() as $id => $cap ) {
-			if ( in_array( $cap, $network_user_caps ) ) {
+			if ( in_array( $cap, $network_user_caps, true ) ) {
 				$this->assertTrue( isset( $nodes[ $id ] ), sprintf( 'Menu item %1$s must display for a user with the %2$s cap.', $id, $cap ) );
 			} else {
 				$this->assertFalse( isset( $nodes[ $id ] ), sprintf( 'Menu item %1$s must not display for a user without the %2$s cap.', $id, $cap ) );
diff --git a/tests/ajax/Attachments.php b/tests/ajax/Attachments.php
index cf11ddc5a0..79e78e7fd8 100644
--- a/tests/ajax/Attachments.php
+++ b/tests/ajax/Attachments.php
@@ -29,7 +29,7 @@ class Tests_Ajax_Attachments extends WP_Ajax_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/canola.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload     = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload     = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$attachment = $this->_make_attachment( $upload );
 
 		// Set up a default request
@@ -80,7 +80,7 @@ class Tests_Ajax_Attachments extends WP_Ajax_UnitTestCase {
 		$filename = DIR_TESTDATA . '/formatting/entities.txt';
 		$contents = file_get_contents( $filename );
 
-		$upload     = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload     = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$attachment = $this->_make_attachment( $upload );
 
 		// Set up a default request
diff --git a/tests/ajax/Autosave.php b/tests/ajax/Autosave.php
index 304e4b741d..14329c036d 100644
--- a/tests/ajax/Autosave.php
+++ b/tests/ajax/Autosave.php
@@ -29,8 +29,10 @@ class Tests_Ajax_Autosave extends WP_Ajax_UnitTestCase {
 	protected static $user_ids = array();
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$user_ids[] = self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
-		self::$user_ids[] = self::$editor_id = $factory->user->create( array( 'role' => 'editor' ) );
+		self::$admin_id   = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$user_ids[] = self::$admin_id;
+		self::$editor_id  = $factory->user->create( array( 'role' => 'editor' ) );
+		self::$user_ids[] = self::$editor_id;
 
 		self::$post_id = $factory->post->create( array( 'post_status' => 'draft' ) );
 		self::$post    = get_post( self::$post_id );
diff --git a/tests/ajax/CustomizeManager.php b/tests/ajax/CustomizeManager.php
index 873d017fc1..920ae3c9d5 100644
--- a/tests/ajax/CustomizeManager.php
+++ b/tests/ajax/CustomizeManager.php
@@ -119,9 +119,11 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 
 		// Unauthorized.
 		wp_set_current_user( self::$subscriber_user_id );
-		$nonce          = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
-		$_POST['nonce'] = $_GET['nonce'] = $_REQUEST['nonce'] = $nonce;
-		$exception      = null;
+		$nonce             = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
+		$_POST['nonce']    = $nonce;
+		$_GET['nonce']     = $nonce;
+		$_REQUEST['nonce'] = $nonce;
+		$exception         = null;
 		try {
 			ob_start();
 			$wp_customize->setup_theme();
@@ -133,14 +135,18 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 
 		// Not called setup_theme.
 		wp_set_current_user( self::$admin_user_id );
-		$nonce          = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
-		$_POST['nonce'] = $_GET['nonce'] = $_REQUEST['nonce'] = $nonce;
+		$nonce             = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
+		$_POST['nonce']    = $nonce;
+		$_GET['nonce']     = $nonce;
+		$_REQUEST['nonce'] = $nonce;
 		$this->make_ajax_call( 'customize_save' );
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'not_preview', $this->_last_response_parsed['data'] );
 
 		// Bad nonce.
-		$_POST['nonce'] = $_GET['nonce'] = $_REQUEST['nonce'] = 'bad';
+		$_POST['nonce']    = 'bad';
+		$_GET['nonce']     = 'bad';
+		$_REQUEST['nonce'] = 'bad';
 		$wp_customize->setup_theme();
 		$this->make_ajax_call( 'customize_save' );
 		$this->assertFalse( $this->_last_response_parsed['success'] );
@@ -148,7 +154,9 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 
 		// User cannot create.
 		$nonce                            = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
-		$_POST['nonce']                   = $_GET['nonce'] = $_REQUEST['nonce'] = $nonce;
+		$_POST['nonce']                   = $nonce;
+		$_GET['nonce']                    = $nonce;
+		$_REQUEST['nonce']                = $nonce;
 		$post_type_obj                    = get_post_type_object( 'customize_changeset' );
 		$post_type_obj->cap->create_posts = 'create_customize_changesets';
 		$this->make_ajax_call( 'customize_save' );
@@ -250,8 +258,10 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 			)
 		);
 		$wp_customize->register_controls();
-		$nonce          = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
-		$_POST['nonce'] = $_GET['nonce'] = $_REQUEST['nonce'] = $nonce;
+		$nonce             = wp_create_nonce( 'save-customize_' . $wp_customize->get_stylesheet() );
+		$_POST['nonce']    = $nonce;
+		$_GET['nonce']     = $nonce;
+		$_REQUEST['nonce'] = $nonce;
 		$wp_customize->setup_theme();
 		return $wp_customize;
 	}
@@ -482,8 +492,10 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'invalid_nonce', $this->_last_response_parsed['data']['code'] );
 
-		$nonce          = wp_create_nonce( 'trash_customize_changeset' );
-		$_POST['nonce'] = $_GET['nonce'] = $_REQUEST['nonce'] = $nonce;
+		$nonce             = wp_create_nonce( 'trash_customize_changeset' );
+		$_POST['nonce']    = $nonce;
+		$_GET['nonce']     = $nonce;
+		$_REQUEST['nonce'] = $nonce;
 		$this->make_ajax_call( 'customize_trash' );
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'non_existent_changeset', $this->_last_response_parsed['data']['code'] );
@@ -567,15 +579,21 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'invalid_nonce', $this->_last_response_parsed['data'] );
 
-		$nonce          = wp_create_nonce( 'customize_dismiss_autosave_or_lock' );
-		$_POST['nonce'] = $_GET['nonce'] = $_REQUEST['nonce'] = $nonce;
+		$nonce             = wp_create_nonce( 'customize_dismiss_autosave_or_lock' );
+		$_POST['nonce']    = $nonce;
+		$_GET['nonce']     = $nonce;
+		$_REQUEST['nonce'] = $nonce;
 
-		$_POST['dismiss_lock'] = $_GET['dismiss_lock'] = $_REQUEST['dismiss_lock'] = true;
+		$_POST['dismiss_lock']    = true;
+		$_GET['dismiss_lock']     = true;
+		$_REQUEST['dismiss_lock'] = true;
 		$this->make_ajax_call( 'customize_dismiss_autosave_or_lock' );
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'no_changeset_to_dismiss_lock', $this->_last_response_parsed['data'] );
 
-		$_POST['dismiss_autosave'] = $_GET['dismiss_autosave'] = $_REQUEST['dismiss_autosave'] = true;
+		$_POST['dismiss_autosave']    = true;
+		$_GET['dismiss_autosave']     = true;
+		$_REQUEST['dismiss_autosave'] = true;
 		$this->make_ajax_call( 'customize_dismiss_autosave_or_lock' );
 		$this->assertFalse( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'no_auto_draft_to_delete', $this->_last_response_parsed['data'] );
@@ -639,12 +657,16 @@ class Tests_Ajax_CustomizeManager extends WP_Ajax_UnitTestCase {
 			)
 		);
 
-		$_POST['dismiss_autosave'] = $_GET['dismiss_autosave'] = $_REQUEST['dismiss_autosave'] = false;
+		$_POST['dismiss_autosave']    = false;
+		$_GET['dismiss_autosave']     = false;
+		$_REQUEST['dismiss_autosave'] = false;
 		$this->make_ajax_call( 'customize_dismiss_autosave_or_lock' );
 		$this->assertTrue( $this->_last_response_parsed['success'] );
 		$this->assertEquals( 'changeset_lock_dismissed', $this->_last_response_parsed['data'] );
 
-		$_POST['dismiss_autosave'] = $_GET['dismiss_autosave'] = $_REQUEST['dismiss_autosave'] = true;
+		$_POST['dismiss_autosave']    = true;
+		$_GET['dismiss_autosave']     = true;
+		$_REQUEST['dismiss_autosave'] = true;
 		$this->assertNotWPError( $r );
 		$this->assertFalse( wp_get_post_autosave( $wp_customize->changeset_post_id() ) );
 		$this->assertContains( 'Foo', get_post( $wp_customize->changeset_post_id() )->post_content );
diff --git a/tests/ajax/CustomizeMenus.php b/tests/ajax/CustomizeMenus.php
index ca9ce84cc8..bb092cdad4 100644
--- a/tests/ajax/CustomizeMenus.php
+++ b/tests/ajax/CustomizeMenus.php
@@ -52,9 +52,9 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 */
 	function test_ajax_load_available_items_cap_check( $role, $expected_results ) {
 
-		if ( 'administrator' != $role ) {
+		if ( 'administrator' !== $role ) {
 			// If we're not an admin, we should get a wp_die(-1).
-			$this->setExpectedException( 'WPAjaxDieStopException' );
+			$this->setExpectedException( 'WPAjaxDieStopException', '-1' );
 		}
 
 		wp_set_current_user( self::factory()->user->create( array( 'role' => $role ) ) );
@@ -441,9 +441,9 @@ class Tests_Ajax_CustomizeMenus extends WP_Ajax_UnitTestCase {
 	 */
 	function test_ajax_search_available_items_caps_check( $role, $expected_results ) {
 
-		if ( 'administrator' != $role ) {
+		if ( 'administrator' !== $role ) {
 			// If we're not an admin, we should get a wp_die(-1).
-			$this->setExpectedException( 'WPAjaxDieStopException' );
+			$this->setExpectedException( 'WPAjaxDieStopException', '-1' );
 		}
 
 		wp_set_current_user( self::factory()->user->create( array( 'role' => $role ) ) );
diff --git a/tests/ajax/DeleteComment.php b/tests/ajax/DeleteComment.php
index 2da5228f71..6664b662ab 100644
--- a/tests/ajax/DeleteComment.php
+++ b/tests/ajax/DeleteComment.php
@@ -94,11 +94,11 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 		$this->assertLessThanOrEqual( time(), (int) $xml->response[0]->comment[0]->supplemental[0]->time[0] );
 
 		// trash, spam, delete should make the total go down
-		if ( in_array( $action, array( 'trash', 'spam', 'delete' ) ) ) {
+		if ( in_array( $action, array( 'trash', 'spam', 'delete' ), true ) ) {
 			$total = $_POST['_total'] - 1;
 
 			// unspam, untrash should make the total go up
-		} elseif ( in_array( $action, array( 'untrash', 'unspam' ) ) ) {
+		} elseif ( in_array( $action, array( 'untrash', 'unspam' ), true ) ) {
 			$total = $_POST['_total'] + 1;
 		}
 
@@ -108,7 +108,7 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 
 		// Check for either possible total
 		$message = sprintf( 'returned value: %1$d $total: %2$d  $recalc_total: %3$d', (int) $xml->response[0]->comment[0]->supplemental[0]->total[0], $total, $recalc_total );
-		$this->assertTrue( in_array( (int) $xml->response[0]->comment[0]->supplemental[0]->total[0], array( $total, $recalc_total ) ), $message );
+		$this->assertTrue( in_array( (int) $xml->response[0]->comment[0]->supplemental[0]->total[0], array( $total, $recalc_total ), true ), $message );
 	}
 
 	/**
@@ -243,7 +243,7 @@ class Tests_Ajax_DeleteComment extends WP_Ajax_UnitTestCase {
 		$this->_last_response = '';
 
 		// Force delete the comment
-		if ( 'delete' == $action ) {
+		if ( 'delete' === $action ) {
 			wp_delete_comment( $comment->comment_ID, true );
 		}
 
diff --git a/tests/ajax/DimComment.php b/tests/ajax/DimComment.php
index 40bb5b207d..a18e3d0e59 100644
--- a/tests/ajax/DimComment.php
+++ b/tests/ajax/DimComment.php
@@ -89,7 +89,7 @@ class Tests_Ajax_DimComment extends WP_Ajax_UnitTestCase {
 
 		// Check the status
 		$current = wp_get_comment_status( $comment->comment_ID );
-		if ( in_array( $prev_status, array( 'unapproved', 'spam' ) ) ) {
+		if ( in_array( $prev_status, array( 'unapproved', 'spam' ), true ) ) {
 			$this->assertEquals( 'approved', $current );
 		} else {
 			$this->assertEquals( 'unapproved', $current );
@@ -103,7 +103,7 @@ class Tests_Ajax_DimComment extends WP_Ajax_UnitTestCase {
 		$total = $_POST['_total'] - 1;
 
 		// Check for either possible total
-		$this->assertTrue( in_array( (int) $xml->response[0]->comment[0]->supplemental[0]->total[0], array( $total, $recalc_total ) ) );
+		$this->assertTrue( in_array( (int) $xml->response[0]->comment[0]->supplemental[0]->total[0], array( $total, $recalc_total ), true ) );
 	}
 
 	/**
diff --git a/tests/ajax/EditComment.php b/tests/ajax/EditComment.php
index b6c5dc0ffe..7fb58eff57 100644
--- a/tests/ajax/EditComment.php
+++ b/tests/ajax/EditComment.php
@@ -96,7 +96,7 @@ class Tests_Ajax_EditComment extends WP_Ajax_UnitTestCase {
 		$comment  = array_pop( $comments );
 
 		// Manually update the comment_post_ID, because wp_update_comment() will prevent it.
-		$wpdb->query( "UPDATE {$wpdb->comments} SET comment_post_ID=0 WHERE comment_ID={$comment->comment_ID}" );
+		$wpdb->update( $wpdb->comments, array( 'comment_post_ID' => 0 ), array( 'comment_ID' => $comment->comment_ID ) );
 		clean_comment_cache( $comment->comment_ID );
 
 		// Set up a default request
diff --git a/tests/ajax/MediaEdit.php b/tests/ajax/MediaEdit.php
index a55e3829a8..b36f342158 100644
--- a/tests/ajax/MediaEdit.php
+++ b/tests/ajax/MediaEdit.php
@@ -32,7 +32,7 @@ class Tests_Ajax_MediaEdit extends WP_Ajax_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/canola.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$id     = $this->_make_attachment( $upload );
 
 		$_REQUEST['action']  = 'image-editor';
@@ -63,7 +63,7 @@ class Tests_Ajax_MediaEdit extends WP_Ajax_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/canola.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$id     = $this->_make_attachment( $upload );
 
 		$_REQUEST['action']  = 'image-editor';
diff --git a/tests/ajax/PrivacyErasePersonalData.php b/tests/ajax/PrivacyErasePersonalData.php
new file mode 100644
index 0000000000..6bab7ca855
--- /dev/null
+++ b/tests/ajax/PrivacyErasePersonalData.php
@@ -0,0 +1,842 @@
+<?php
+/**
+ * Testing Ajax handler for erasing personal data.
+ *
+ * @package WordPress\UnitTests
+ * @since 5.2.0
+ */
+
+/**
+ * Tests_Ajax_PrivacyExportPersonalData class.
+ *
+ * @since 5.2.0
+ *
+ * @group ajax
+ * @group privacy
+ *
+ * @covers ::wp_ajax_wp_privacy_erase_personal_data
+ */
+class Tests_Ajax_PrivacyErasePersonalData extends WP_Ajax_UnitTestCase {
+
+	/**
+	 * User Request ID.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $request_id
+	 */
+	protected static $request_id;
+
+	/**
+	 * User Request Email.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $request_email
+	 */
+	protected static $request_email;
+
+	/**
+	 * Ajax Action.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $action
+	 */
+	protected static $action;
+
+	/**
+	 * Eraser Index.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $eraser
+	 */
+	protected static $eraser;
+
+	/**
+	 * Eraser Key.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $eraser_key
+	 */
+	protected static $eraser_key;
+
+	/**
+	 * Eraser Friendly Name.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $eraser_friendly_name
+	 */
+	protected static $eraser_friendly_name;
+
+	/**
+	 * Page Index.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $page
+	 */
+	protected static $page;
+
+	/**
+	 * Last response parsed.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var array $_last_response_parsed
+	 */
+	protected $_last_response_parsed;
+
+	/**
+	 * An array key in the test eraser to unset.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $key_to_unset
+	 */
+	protected $key_to_unset;
+
+	/**
+	 * A value to change the test eraser callback to.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $new_callback_value
+	 */
+	protected $new_callback_value;
+
+	/**
+	 * Create user erase request fixtures.
+	 *
+	 * @param WP_UnitTest_Factory $factory Factory.
+	 */
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$request_email        = 'requester@example.com';
+		self::$request_id           = wp_create_user_request( self::$request_email, 'remove_personal_data' );
+		self::$action               = 'wp-privacy-erase-personal-data';
+		self::$eraser               = 1;
+		self::$eraser_key           = 'custom-eraser';
+		self::$eraser_friendly_name = 'Custom Eraser';
+		self::$page                 = 1;
+	}
+
+	/**
+	 * Register a custom personal data eraser.
+	 */
+	public function setUp() {
+		parent::setUp();
+
+		$this->key_to_unset = '';
+
+		// Make sure the erasers response is not modified and avoid sending emails.
+		remove_all_filters( 'wp_privacy_personal_data_erasure_page' );
+		remove_all_actions( 'wp_privacy_personal_data_erased' );
+
+		// Only use our custom privacy personal data eraser.
+		remove_all_filters( 'wp_privacy_personal_data_erasers' );
+		add_filter( 'wp_privacy_personal_data_erasers', array( $this, 'register_custom_personal_data_eraser' ) );
+
+		$this->_setRole( 'administrator' );
+		// erase_others_personal_data meta cap in Multisite installation is only granted to those with `manage_network` capability.
+		if ( is_multisite() ) {
+			grant_super_admin( get_current_user_id() );
+		}
+	}
+
+	/**
+	 * Clean up after each test method.
+	 */
+	public function tearDown() {
+		remove_filter( 'wp_privacy_personal_data_erasers', array( $this, 'register_custom_personal_data_eraser' ) );
+		$this->new_callback_value = '';
+
+		if ( is_multisite() ) {
+			revoke_super_admin( get_current_user_id() );
+		}
+
+		parent::tearDown();
+	}
+
+	/**
+	 * Helper method for changing the test eraser's callback function.
+	 *
+	 * @param string|array $callback New test eraser callback index value.
+	 */
+	protected function _set_eraser_callback( $callback ) {
+		$this->new_callback_value = $callback;
+		add_filter( 'wp_privacy_personal_data_erasers', array( $this, 'filter_eraser_callback_value' ), 20 );
+	}
+
+	/**
+	 * Change the test eraser callback to a specified value.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $erasers List of data erasers.
+	 *
+	 * @return array $erasersList of data erasers.
+	 */
+	public function filter_eraser_callback_value( $erasers ) {
+		$erasers[ self::$eraser_key ]['callback'] = $this->new_callback_value;
+
+		return $erasers;
+	}
+
+	/**
+	 * Helper method for unsetting an array index in the test eraser.
+	 *
+	 * @param string|bool $key Test eraser key to unset.
+	 */
+	protected function _unset_eraser_key( $key ) {
+		$this->key_to_unset = $key;
+		add_filter( 'wp_privacy_personal_data_erasers', array( $this, 'filter_unset_eraser_index' ), 20 );
+	}
+
+	/**
+	 * Unsets an array key in the test eraser.
+	 *
+	 * If the key is false, the eraser is set to false.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $erasers Erasers.
+	 *
+	 * @return array $erasers Erasers.
+	 */
+	public function filter_unset_eraser_index( $erasers ) {
+		if ( false === $this->key_to_unset ) {
+			$erasers[ self::$eraser_key ] = false;
+		} elseif ( ! empty( $this->key_to_unset ) ) {
+			unset( $erasers[ self::$eraser_key ][ $this->key_to_unset ] );
+		}
+
+		return $erasers;
+	}
+
+	/**
+	 * Helper method for erasing a key from the eraser response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $key Response key to unset.
+	 */
+	protected function _unset_response_key( $key ) {
+		$this->key_to_unset = $key;
+		$this->_set_eraser_callback( array( $this, 'filter_unset_response_index' ) );
+	}
+
+	/**
+	 * Unsets an array index in a response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $email_address The requester's email address.
+	 * @param int    $page          Page number.
+	 *
+	 * @return array $return Export data.
+	 */
+	public function filter_unset_response_index( $email_address, $page = 1 ) {
+		$response = $this->callback_personal_data_eraser( $email_address, $page );
+
+		if ( ! empty( $this->key_to_unset ) ) {
+			unset( $response[ $this->key_to_unset ] );
+		}
+
+		return $response;
+	}
+
+	/**
+	 * The function should send an error when the request ID is missing.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @ticket 43438
+	 */
+	public function test_error_when_missing_request_id() {
+		$this->assertNotWPError( self::$request_id );
+
+		// Set up a request.
+		$this->_make_ajax_call(
+			array(
+				'id' => null, // Missing request ID.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Missing request ID.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the request ID is less than 1.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @ticket 43438
+	 */
+	public function test_error_when_request_id_invalid() {
+		$this->assertNotWPError( self::$request_id );
+
+		// Set up a request.
+		$this->_make_ajax_call(
+			array(
+				'id' => -1, // Invalid request ID.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Invalid request ID.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the current user is missing required capabilities.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @ticket 43438
+	 */
+	public function test_error_when_current_user_missing_required_capabilities() {
+		$this->_setRole( 'author' );
+
+		$this->assertFalse( current_user_can( 'erase_others_personal_data' ) );
+		$this->assertFalse( current_user_can( 'delete_users' ) );
+
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Sorry, you are not allowed to perform this action.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * Test requests do not succeed on multisite when the current user is not a network admin.
+	 *
+	 * @group multisite
+	 *
+	 * @ticket 43438
+	 */
+	public function test_error_when_current_user_missing_required_capabilities_multisite() {
+		if ( ! is_multisite() ) {
+			$this->markTestSkipped( 'This test only runs on multisite.' );
+		}
+
+		revoke_super_admin( get_current_user_id() );
+
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Sorry, you are not allowed to perform this action.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the nonce does not validate.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_failure_with_invalid_nonce() {
+		$this->setExpectedException( 'WPAjaxDieStopException', '-1' );
+
+		$this->_make_ajax_call(
+			array(
+				'security' => 'invalid-nonce',
+			)
+		);
+	}
+
+	/**
+	 * The function should send an error when the request type is incorrect.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_incorrect_request_type() {
+		$request_id = wp_create_user_request(
+			'export-request@example.com',
+			'export_personal_data' // Incorrect request type, expects 'remove_personal_data'.
+		);
+
+		$this->_make_ajax_call(
+			array(
+				'security' => wp_create_nonce( 'wp-privacy-erase-personal-data-' . $request_id ),
+				'id'       => $request_id,
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Invalid request type.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the request email is invalid.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_invalid_email() {
+		wp_update_post(
+			array(
+				'ID'         => self::$request_id,
+				'post_title' => '', // Invalid requester's email address.
+			)
+		);
+
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Invalid email address in request.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the eraser index is missing.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_missing_eraser_index() {
+		$this->_make_ajax_call(
+			array(
+				'eraser' => null, // Missing eraser index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Missing eraser index.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the page index is missing.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_missing_page_index() {
+		$this->_make_ajax_call(
+			array(
+				'page' => null, // Missing page index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Missing page index.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the eraser index is negative.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_negative_eraser_index() {
+		$this->_make_ajax_call(
+			array(
+				'eraser' => -1, // Negative eraser index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Eraser index cannot be less than one.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the eraser index is out of range.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_index_out_of_range() {
+		$this->_make_ajax_call(
+			array(
+				'eraser' => PHP_INT_MAX, // Out of range eraser index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Eraser index is out of range.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the page index is less than one.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_page_index_less_than_one() {
+		$this->_make_ajax_call(
+			array(
+				'page' => 0, // Page index less than one.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Page index cannot be less than one.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when an eraser is not an array.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_not_array() {
+		$this->_unset_eraser_key( false );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected an array describing the eraser at index %s.',
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an eraser is missing a friendly name.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_missing_friendly_name() {
+		$this->_unset_eraser_key( 'eraser_friendly_name' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Eraser array at index %s does not include a friendly name.',
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an eraser is missing a callback.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_missing_callback() {
+		$this->_unset_eraser_key( 'callback' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Eraser does not include a callback: %s.',
+				self::$eraser_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an eraser, at a given index, has an invalid callback.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_index_invalid_callback() {
+		$this->_set_eraser_callback( false );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Eraser callback is not valid: %s.',
+				self::$eraser_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an eraser, at a given index, is missing an array response.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_index_invalid_response() {
+		$this->_set_eraser_callback( '__return_null' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Did not receive array from %1$s eraser (index %2$d).',
+				self::$eraser_friendly_name,
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when missing an items_removed index.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_items_removed_missing() {
+		$this->_unset_response_key( 'items_removed' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected items_removed key in response array from %1$s eraser (index %2$d).',
+				self::$eraser_friendly_name,
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when missing an items_retained index.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_items_retained_missing() {
+		$this->_unset_response_key( 'items_retained' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected items_retained key in response array from %1$s eraser (index %2$d).',
+				self::$eraser_friendly_name,
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when missing a messages index.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_messages_missing() {
+		$this->_unset_response_key( 'messages' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected messages key in response array from %1$s eraser (index %2$d).',
+				self::$eraser_friendly_name,
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when the messages index is not an array.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_messages_not_array() {
+		$this->_set_eraser_callback( array( $this, 'filter_response_messages_invalid' ) );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected messages key to reference an array in response array from %1$s eraser (index %2$d).',
+				self::$eraser_friendly_name,
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * Change the messages index to an invalid value (not an array).
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $email_address The requester's email address.
+	 * @param int    $page          Page number.
+	 *
+	 * @return array $return Export data.
+	 */
+	public function filter_response_messages_invalid( $email_address, $page = 1 ) {
+		$response             = $this->callback_personal_data_eraser( $email_address, $page );
+		$response['messages'] = true;
+
+		return $response;
+	}
+
+	/**
+	 * The function should send an error when an eraser is missing 'done' in array response.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_eraser_missing_done_response() {
+		$this->_unset_response_key( 'done' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected done flag in response array from %1$s eraser (index %2$d).',
+				self::$eraser_friendly_name,
+				self::$eraser
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should successfully send erasers response data when the current user has the required
+	 * capabilities.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @ticket 43438
+	 */
+	public function test_success_when_current_user_has_required_capabilities() {
+		$this->assertTrue( current_user_can( 'erase_others_personal_data' ) );
+		$this->assertTrue( current_user_can( 'delete_users' ) );
+
+		$this->_make_ajax_call();
+
+		$this->assertSame(
+			sprintf( 'A message regarding retained data for %s.', self::$request_email ),
+			$this->_last_response_parsed['data']['messages'][0]
+		);
+		$this->assertTrue( $this->_last_response_parsed['success'] );
+		$this->assertTrue( $this->_last_response_parsed['data']['items_removed'] );
+		$this->assertTrue( $this->_last_response_parsed['data']['items_retained'] );
+		$this->assertTrue( $this->_last_response_parsed['data']['done'] );
+	}
+
+	/**
+	 * The function should successfully send erasers response data when no items to erase.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @ticket 43438
+	 */
+	public function test_success_when_no_items_to_erase() {
+
+		$this->_make_ajax_call( array( 'page' => 2 ) );
+
+		$this->assertTrue( $this->_last_response_parsed['success'] );
+		$this->assertFalse( $this->_last_response_parsed['data']['items_removed'] );
+		$this->assertFalse( $this->_last_response_parsed['data']['items_retained'] );
+		$this->assertEmpty( $this->_last_response_parsed['data']['messages'] );
+		$this->assertTrue( $this->_last_response_parsed['data']['done'] );
+	}
+
+	/**
+	 * Test that the function's output should be filterable with the `wp_privacy_personal_data_erasure_page` filter.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_output_should_be_filterable() {
+		add_filter( 'wp_privacy_personal_data_erasure_page', array( $this, 'filter_eraser_data_response' ), 20, 6 );
+		$this->_make_ajax_call();
+
+		$expected_new_index = self::$request_email . '-' . self::$request_id . '-' . self::$eraser_key;
+
+		$this->assertTrue( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'filtered removed', $this->_last_response_parsed['data']['items_removed'] );
+		$this->assertSame( 'filtered retained', $this->_last_response_parsed['data']['items_retained'] );
+		$this->assertSame( array( 'filtered messages' ), $this->_last_response_parsed['data']['messages'] );
+		$this->assertSame( 'filtered done', $this->_last_response_parsed['data']['done'] );
+		$this->assertSame( $expected_new_index, $this->_last_response_parsed['data']['new_index'] );
+	}
+
+	/**
+	 * Filters the eraser response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array  $response        The personal data for the given eraser and page.
+	 * @param int    $eraser_index    The index of the eraser that provided this data.
+	 * @param string $email_address   The email address associated with this personal data.
+	 * @param int    $page            The page for this response.
+	 * @param int    $request_id      The privacy request post ID associated with this request.
+	 * @param string $eraser_key      The key (slug) of the eraser that provided this data.
+	 *
+	 * @return array Filtered erase response.
+	 */
+	public function filter_eraser_data_response( $response, $eraser_index, $email_address, $page, $request_id, $eraser_key ) {
+		$response['items_removed']  = 'filtered removed';
+		$response['items_retained'] = 'filtered retained';
+		$response['messages']       = array( 'filtered messages' );
+		$response['done']           = 'filtered done';
+		$response['new_index']      = $email_address . '-' . $request_id . '-' . $eraser_key;
+
+		return $response;
+	}
+
+	/**
+	 * Register handler for a custom personal data eraser.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $erasers An array of personal data erasers.
+	 *
+	 * @return array $erasers An array of personal data erasers.
+	 */
+	public function register_custom_personal_data_eraser( $erasers ) {
+		$erasers[ self::$eraser_key ] = array(
+			'eraser_friendly_name' => self::$eraser_friendly_name,
+			'callback'             => array( $this, 'callback_personal_data_eraser' ),
+		);
+		return $erasers;
+	}
+
+	/**
+	 * Custom Personal Data Eraser.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param  string $email_address The comment author email address.
+	 * @param  int    $page          Page number.
+	 *
+	 * @return array  $return Erase data.
+	 */
+	public function callback_personal_data_eraser( $email_address, $page = 1 ) {
+		if ( 1 === $page ) {
+			return array(
+				'items_removed'  => true,
+				'items_retained' => true,
+				'messages'       => array( sprintf( 'A message regarding retained data for %s.', $email_address ) ),
+				'done'           => true,
+			);
+		}
+
+		return array(
+			'items_removed'  => false,
+			'items_retained' => false,
+			'messages'       => array(),
+			'done'           => true,
+		);
+	}
+
+	/**
+	 * Helper function for ajax handler.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $args Ajax request arguments.
+	 */
+	protected function _make_ajax_call( $args = array() ) {
+		$this->_last_response_parsed = null;
+		$this->_last_response        = '';
+
+		$defaults = array(
+			'action'   => self::$action,
+			'security' => wp_create_nonce( self::$action . '-' . self::$request_id ),
+			'page'     => self::$page,
+			'id'       => self::$request_id,
+			'eraser'   => self::$eraser,
+		);
+
+		$_POST = wp_parse_args( $args, $defaults );
+
+		try {
+			$this->_handleAjax( self::$action );
+		} catch ( WPAjaxDieContinueException $e ) {
+			unset( $e );
+		}
+
+		if ( $this->_last_response ) {
+			$this->_last_response_parsed = json_decode( $this->_last_response, true );
+		}
+	}
+}
diff --git a/tests/ajax/PrivacyExportPersonalData.php b/tests/ajax/PrivacyExportPersonalData.php
new file mode 100644
index 0000000000..0140654c0a
--- /dev/null
+++ b/tests/ajax/PrivacyExportPersonalData.php
@@ -0,0 +1,845 @@
+<?php
+/**
+ * Testing Ajax handler for exporting personal data.
+ *
+ * @package WordPress\UnitTests
+ * @since 5.2.0
+ */
+
+/**
+ * Tests_Ajax_PrivacyExportPersonalData class.
+ *
+ * @since 5.2.0
+ *
+ * @group ajax
+ * @group privacy
+ *
+ * @covers ::wp_ajax_wp_privacy_export_personal_data
+ */
+class Tests_Ajax_PrivacyExportPersonalData extends WP_Ajax_UnitTestCase {
+
+	/**
+	 * User Request ID.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $request_id
+	 */
+	protected static $request_id;
+
+	/**
+	 * User Request Email.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $request_email
+	 */
+	protected static $request_email;
+
+	/**
+	 * Ajax Action.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $action
+	 */
+	protected static $action;
+
+	/**
+	 * Exporter Index.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $exporter
+	 */
+	protected static $exporter;
+
+	/**
+	 * Exporter Key.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $exporter_key
+	 */
+	protected static $exporter_key;
+
+	/**
+	 * Exporter Friendly Name.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $exporter_friendly_name
+	 */
+	protected static $exporter_friendly_name;
+
+	/**
+	 * Page Index.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $page
+	 */
+	protected static $page;
+
+	/**
+	 * Send As Email.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var bool $send_as_email
+	 */
+	protected static $send_as_email;
+
+	/**
+	 * Last response parsed.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var array $_last_response_parsed
+	 */
+	protected $_last_response_parsed;
+
+	/**
+	 * An array key in the test exporter to unset.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $key_to_unset
+	 */
+	protected $key_to_unset;
+
+	/**
+	 * A value to change the test exporter callback to.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $new_callback_value
+	 */
+	protected $new_callback_value;
+
+	/**
+	 * Create user export request fixtures.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param WP_UnitTest_Factory $factory Factory.
+	 */
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$request_email          = 'requester@example.com';
+		self::$request_id             = wp_create_user_request( self::$request_email, 'export_personal_data' );
+		self::$action                 = 'wp-privacy-export-personal-data';
+		self::$exporter               = 1;
+		self::$exporter_key           = 'custom-exporter';
+		self::$exporter_friendly_name = 'Custom Exporter';
+		self::$page                   = 1;
+		self::$send_as_email          = false;
+	}
+
+	/**
+	 * Setup before each test method.
+	 *
+	 * @since 5.2.0
+	 */
+	public function setUp() {
+		parent::setUp();
+
+		$this->key_to_unset       = '';
+		$this->new_callback_value = '';
+
+		// Make sure the exporter response is not modified and avoid e.g. writing export file to disk.
+		remove_all_filters( 'wp_privacy_personal_data_export_page' );
+
+		// Only use our custom privacy personal data exporter.
+		remove_all_filters( 'wp_privacy_personal_data_exporters' );
+		add_filter( 'wp_privacy_personal_data_exporters', array( $this, 'filter_register_custom_personal_data_exporter' ) );
+
+		$this->_setRole( 'administrator' );
+		// export_others_personal_data meta cap in Multisite installation is only granted to those with `manage_network` capability.
+		if ( is_multisite() ) {
+			grant_super_admin( get_current_user_id() );
+		}
+	}
+
+	/**
+	 * Clean up after each test method.
+	 */
+	public function tearDown() {
+		remove_filter( 'wp_privacy_personal_data_exporters', array( $this, 'filter_register_custom_personal_data_exporter' ) );
+
+		if ( is_multisite() ) {
+			revoke_super_admin( get_current_user_id() );
+		}
+		parent::tearDown();
+	}
+
+	/**
+	 * Helper method for changing the test exporter's callback function.
+	 *
+	 * @param string|array $callback New test exporter callback function.
+	 */
+	protected function _set_exporter_callback( $callback ) {
+		$this->new_callback_value = $callback;
+		add_filter( 'wp_privacy_personal_data_exporters', array( $this, 'filter_exporter_callback_value' ), 20 );
+	}
+
+	/**
+	 * Change the test exporter callback to a specified value.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $exporters List of data exporters.
+	 * @return array $exporters List of data exporters.
+	 */
+	public function filter_exporter_callback_value( $exporters ) {
+		$exporters[ self::$exporter_key ]['callback'] = $this->new_callback_value;
+
+		return $exporters;
+	}
+
+	/**
+	 * Helper method for unsetting an array index in the test exporter.
+	 *
+	 * @param string $key Test exporter key to unset.
+	 */
+	protected function _unset_exporter_key( $key ) {
+		$this->key_to_unset = $key;
+		add_filter( 'wp_privacy_personal_data_exporters', array( $this, 'filter_unset_exporter_key' ), 20 );
+	}
+
+	/**
+	 * Unset a specified key in the test exporter array.
+	 *
+	 * @param array $exporters List of data exporters.
+	 *
+	 * @return array $exporters List of data exporters.
+	 */
+	public function filter_unset_exporter_key( $exporters ) {
+		if ( false === $this->key_to_unset ) {
+			$exporters[ self::$exporter_key ] = false;
+		} elseif ( ! empty( $this->key_to_unset ) ) {
+			unset( $exporters[ self::$exporter_key ][ $this->key_to_unset ] );
+		}
+
+		return $exporters;
+	}
+
+	/**
+	 * The function should send an error when the request ID is missing.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_missing_request_id() {
+		$this->_make_ajax_call(
+			array(
+				'id' => null, // Missing request ID.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Missing request ID.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the request ID is less than 1.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_invalid_id() {
+		$this->_make_ajax_call(
+			array(
+				'id' => -1, // Invalid request ID, less than 1.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Invalid request ID.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the current user is missing the required capability.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_current_user_missing_required_capability() {
+		$this->_setRole( 'author' );
+
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertFalse( current_user_can( 'export_others_personal_data' ) );
+		$this->assertSame( 'Sorry, you are not allowed to perform this action.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * Test requests do not succeed on multisite when the current user is not a network admin.
+	 *
+	 * @group multisite
+	 *
+	 * @ticket 43438
+	 */
+	public function test_error_when_current_user_missing_required_capability_multisite() {
+		if ( ! is_multisite() ) {
+			$this->markTestSkipped( 'This test only runs on multisite.' );
+		}
+
+		revoke_super_admin( get_current_user_id() );
+
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Sorry, you are not allowed to perform this action.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the nonce does not validate.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_failure_with_invalid_nonce() {
+		$this->setExpectedException( 'WPAjaxDieStopException', '-1' );
+
+		$this->_make_ajax_call(
+			array(
+				'security' => 'invalid-nonce',
+			)
+		);
+	}
+
+	/**
+	 * The function should send an error when the request type is incorrect.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_incorrect_request_type() {
+		$request_id = wp_create_user_request(
+			'erase-request@example.com',
+			'remove_personal_data' // Incorrect request type, expects 'export_personal_data'.
+		);
+
+		$this->_make_ajax_call(
+			array(
+				'security' => wp_create_nonce( 'wp-privacy-export-personal-data-' . $request_id ),
+				'id'       => $request_id,
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Invalid request type.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the requester's email address is invalid.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_invalid_email_address() {
+		wp_update_post(
+			array(
+				'ID'         => self::$request_id,
+				'post_title' => '', // Invalid requester's email address.
+			)
+		);
+
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'A valid email address must be given.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the exporter index is missing.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_missing_exporter_index() {
+		$this->_make_ajax_call(
+			array(
+				'exporter' => null, // Missing exporter index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Missing exporter index.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the page index is missing.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_missing_page_index() {
+		$this->_make_ajax_call(
+			array(
+				'page' => null, // Missing page index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Missing page index.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when an exporter has improperly used the `wp_privacy_personal_data_exporters` filter.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_has_improperly_used_exporters_filter() {
+		// Improper filter usage: returns false instead of an expected array.
+		add_filter( 'wp_privacy_personal_data_exporters', '__return_false', 999 );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'An exporter has improperly used the registration filter.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the exporter index is negative.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_negative_exporter_index() {
+		$this->_make_ajax_call(
+			array(
+				'exporter' => -1, // Negative exporter index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Exporter index cannot be negative.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the exporter index is out of range.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_index_out_of_range() {
+		$this->_make_ajax_call(
+			array(
+				'exporter' => PHP_INT_MAX, // Out of range exporter index.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Exporter index is out of range.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when the page index is less than one.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_page_index_less_than_one() {
+		$this->_make_ajax_call(
+			array(
+				'page' => 0, // Page index less than one.
+			)
+		);
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'Page index cannot be less than one.', $this->_last_response_parsed['data'] );
+	}
+
+	/**
+	 * The function should send an error when an exporter is not an array.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_not_array() {
+		$this->_unset_exporter_key( false );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected an array describing the exporter at index %s.',
+				self::$exporter_key
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an exporter is missing a friendly name.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_missing_friendly_name() {
+		$this->_unset_exporter_key( 'exporter_friendly_name' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Exporter array at index %s does not include a friendly name.',
+				self::$exporter_key
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an exporter is missing a callback.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_missing_callback() {
+		$this->_unset_exporter_key( 'callback' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Exporter does not include a callback: %s.',
+				self::$exporter_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an exporter, at a given index, has an invalid callback.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_index_invalid_callback() {
+		$this->_set_exporter_callback( false );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Exporter callback is not a valid callback: %s.',
+				self::$exporter_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * When an exporter callback returns a WP_Error, it should be passed as the error.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_callback_returns_wp_error() {
+		$this->_set_exporter_callback( array( $this, 'callback_return_wp_error' ) );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'passed_message', $this->_last_response_parsed['data'][0]['code'] );
+		$this->assertSame( 'This is a WP_Error message.', $this->_last_response_parsed['data'][0]['message'] );
+	}
+
+	/**
+	 * Callback for exporter's response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $email_address The requester's email address.
+	 * @param int    $page          Page number.
+	 * @return WP_Error WP_Error instance.
+	 */
+	public function callback_return_wp_error( $email_address, $page = 1 ) {
+		return new WP_Error( 'passed_message', 'This is a WP_Error message.' );
+	}
+
+	/**
+	 * The function should send an error when an exporter, at a given index, is missing an array response.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_index_invalid_response() {
+		$this->_set_exporter_callback( '__return_null' );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected response as an array from exporter: %s.',
+				self::$exporter_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * The function should send an error when an exporter is missing data in array response.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_missing_data_response() {
+		$this->_set_exporter_callback( array( $this, 'callback_missing_data_response' ) );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected data in response array from exporter: %s.',
+				self::$exporter_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * Callback for exporter's response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $email_address The requester's email address.
+	 * @param int    $page          Page number.
+	 *
+	 * @return array $return Export data.
+	 */
+	public function callback_missing_data_response( $email_address, $page = 1 ) {
+		$response = $this->callback_custom_personal_data_exporter( $email_address, $page );
+		unset( $response['data'] ); // Missing data part of response.
+
+		return $response;
+	}
+
+	/**
+	 * The function should send an error when an exporter is missing 'data' array in array response.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_function_should_error_when_exporter_missing_data_array_response() {
+		$this->_set_exporter_callback( array( $this, 'callback_missing_data_array_response' ) );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected data array in response array from exporter: %s.',
+				self::$exporter_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * Callback for exporter's response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param  string $email_address The requester's email address.
+	 * @param  int    $page          Page number.
+	 *
+	 * @return array $return Export data.
+	 */
+	public function callback_missing_data_array_response( $email_address, $page = 1 ) {
+		$response         = $this->callback_custom_personal_data_exporter( $email_address, $page );
+		$response['data'] = false; // Not an array.
+		return $response;
+	}
+
+	/**
+	 * The function should send an error when an exporter is missing 'done' in array response.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_error_when_exporter_missing_done_response() {
+		$this->_set_exporter_callback( array( $this, 'callback_missing_done_response' ) );
+		$this->_make_ajax_call();
+
+		$this->assertFalse( $this->_last_response_parsed['success'] );
+		$this->assertSame(
+			sprintf(
+				'Expected done (boolean) in response array from exporter: %s.',
+				self::$exporter_friendly_name
+			),
+			$this->_last_response_parsed['data']
+		);
+	}
+
+	/**
+	 * Remove the response's done flag.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $email_address The requester's email address.
+	 * @param int    $page          Page number.
+	 *
+	 * @return array $return Export data.
+	 */
+	public function callback_missing_done_response( $email_address, $page = 1 ) {
+		$response = $this->callback_custom_personal_data_exporter( $email_address, $page );
+		unset( $response['done'] );
+
+		return $response;
+	}
+
+	/**
+	 * The function should successfully send exporter data response when the current user has the required capability.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_succeeds_when_current_user_has_required_capability() {
+		$this->assertTrue( current_user_can( 'export_others_personal_data' ) );
+
+		$this->_make_ajax_call();
+
+		$this->assertTrue( $this->_last_response_parsed['success'] );
+		$this->assertSame( 'custom-exporter-item-id', $this->_last_response_parsed['data']['data']['item_id'] );
+		$this->assertSame( 'Email', $this->_last_response_parsed['data']['data']['data'][0]['name'] );
+		$this->assertSame( self::$request_email, $this->_last_response_parsed['data']['data']['data'][0]['value'] );
+	}
+
+	/**
+	 * The function should successfully send exporter data response when no items to export.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_success_when_no_items_to_export() {
+
+		$this->_make_ajax_call( array( 'page' => 2 ) );
+
+		$this->assertTrue( $this->_last_response_parsed['success'] );
+		$this->assertEmpty( $this->_last_response_parsed['data']['data'] );
+		$this->assertTrue( $this->_last_response_parsed['data']['done'] );
+	}
+
+	/**
+	 * The function's output should be filterable with the `wp_privacy_personal_data_export_page` filter.
+	 *
+	 * @since 5.2.0
+	 */
+	public function test_output_should_be_filterable() {
+		add_filter( 'wp_privacy_personal_data_export_page', array( $this, 'filter_exporter_data_response' ), 20, 7 );
+		$this->_make_ajax_call();
+
+		$expected_group_label = sprintf(
+			'%s-%s-%s-%s-%s-%s',
+			self::$exporter,
+			self::$page,
+			self::$request_email,
+			self::$request_id,
+			self::$send_as_email,
+			self::$exporter_key
+		);
+
+		$this->assertTrue( $this->_last_response_parsed['success'] );
+		$this->assertSame( $expected_group_label, $this->_last_response_parsed['data']['group_label'] );
+		$this->assertSame( 'filtered_group_id', $this->_last_response_parsed['data']['group_id'] );
+		$this->assertSame( 'filtered_item_id', $this->_last_response_parsed['data']['item_id'] );
+		$this->assertSame( 'filtered_name', $this->_last_response_parsed['data']['data'][0]['name'] );
+		$this->assertSame( 'filtered_value', $this->_last_response_parsed['data']['data'][0]['value'] );
+	}
+
+	/**
+	 * Filter exporter's data response.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array  $response        The personal data for the given exporter and page.
+	 * @param int    $exporter_index  The index of the exporter that provided this data.
+	 * @param string $email_address   The email address associated with this personal data.
+	 * @param int    $page            The page for this response.
+	 * @param int    $request_id      The privacy request post ID associated with this request.
+	 * @param bool   $send_as_email   Whether the final results of the export should be emailed to the user.
+	 * @param string $exporter_key    The key (slug) of the exporter that provided this data.
+	 *
+	 * @return array $response The personal data for the given exporter and page.
+	 */
+	public function filter_exporter_data_response( $response, $exporter_index, $email_address, $page, $request_id, $send_as_email, $exporter_key ) {
+		$group_label                  = sprintf(
+			'%s-%s-%s-%s-%s-%s',
+			$exporter_index,
+			$page,
+			$email_address,
+			$request_id,
+			$send_as_email,
+			$exporter_key
+		);
+		$response['group_label']      = $group_label;
+		$response['group_id']         = 'filtered_group_id';
+		$response['item_id']          = 'filtered_item_id';
+		$response['data'][0]['name']  = 'filtered_name';
+		$response['data'][0]['value'] = 'filtered_value';
+
+		return $response;
+	}
+
+	/**
+	 * Filter to register a custom personal data exporter.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $exporters An array of personal data exporters.
+	 *
+	 * @return array $exporters An array of personal data exporters.
+	 */
+	public function filter_register_custom_personal_data_exporter( $exporters ) {
+		$exporters[ self::$exporter_key ] = array(
+			'exporter_friendly_name' => self::$exporter_friendly_name,
+			'callback'               => array( $this, 'callback_custom_personal_data_exporter' ),
+		);
+		return $exporters;
+	}
+
+	/**
+	 * Callback for a custom personal data exporter.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $email_address The requester's email address.
+	 * @param int    $page          Page number.
+	 *
+	 * @return array $response Export data response.
+	 */
+	public function callback_custom_personal_data_exporter( $email_address, $page = 1 ) {
+		$data_to_export = array();
+
+		if ( 1 === $page ) {
+			$data_to_export = array(
+				'group_id'    => self::$exporter_key . '-group-id',
+				'group_label' => self::$exporter_key . '-group-label',
+				'item_id'     => self::$exporter_key . '-item-id',
+				'data'        => array(
+					array(
+						'name'  => 'Email',
+						'value' => $email_address,
+					),
+				),
+			);
+		}
+
+		return array(
+			'data' => $data_to_export,
+			'done' => true,
+		);
+	}
+
+	/**
+	 * Helper function for ajax handler.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array $args Ajax request arguments.
+	 */
+	protected function _make_ajax_call( $args = array() ) {
+		$this->_last_response_parsed = null;
+		$this->_last_response        = '';
+
+		$defaults = array(
+			'action'      => self::$action,
+			'security'    => wp_create_nonce( self::$action . '-' . self::$request_id ),
+			'exporter'    => self::$exporter,
+			'page'        => self::$page,
+			'sendAsEmail' => self::$send_as_email,
+			'id'          => self::$request_id,
+		);
+
+		$_POST = wp_parse_args( $args, $defaults );
+
+		try {
+			$this->_handleAjax( self::$action );
+		} catch ( WPAjaxDieContinueException $e ) {
+			unset( $e );
+		}
+
+		if ( $this->_last_response ) {
+			$this->_last_response_parsed = json_decode( $this->_last_response, true );
+		}
+	}
+}
diff --git a/tests/ajax/Response.php b/tests/ajax/Response.php
index cf92699944..83def22b8f 100644
--- a/tests/ajax/Response.php
+++ b/tests/ajax/Response.php
@@ -69,6 +69,7 @@ class Tests_Ajax_Response extends WP_UnitTestCase {
 	 * @ticket 19448
 	 * @runInSeparateProcess
 	 * @preserveGlobalState disabled
+	 * @group xdebug
 	 */
 	public function test_response_charset_in_header() {
 
@@ -85,7 +86,7 @@ class Tests_Ajax_Response extends WP_UnitTestCase {
 		$headers = xdebug_get_headers();
 		ob_end_clean();
 
-		$this->assertTrue( in_array( 'Content-Type: text/xml; charset=' . get_option( 'blog_charset' ), $headers ) );
+		$this->assertTrue( in_array( 'Content-Type: text/xml; charset=' . get_option( 'blog_charset' ), $headers, true ) );
 	}
 
 	/**
diff --git a/tests/ajax/UpdatePlugin.php b/tests/ajax/UpdatePlugin.php
index ade940393b..ab76ee7cdd 100644
--- a/tests/ajax/UpdatePlugin.php
+++ b/tests/ajax/UpdatePlugin.php
@@ -158,7 +158,7 @@ class Tests_Ajax_Update_Plugin extends WP_Ajax_UnitTestCase {
 				'plugin'       => 'hello.php',
 				'pluginName'   => 'Hello Dolly',
 				'errorMessage' => 'Plugin update failed.',
-				'oldVersion'   => 'Version 1.7.1',
+				'oldVersion'   => 'Version 1.7.2',
 				'newVersion'   => '',
 				'debug'        => array( 'The plugin is at the latest version.' ),
 			),
diff --git a/tests/auth.php b/tests/auth.php
index 6fe223ccf0..a2a190f36c 100644
--- a/tests/auth.php
+++ b/tests/auth.php
@@ -24,7 +24,7 @@ class Tests_Auth extends WP_UnitTestCase {
 
 		self::$user_id = self::$_user->ID;
 
-		require_once( ABSPATH . WPINC . '/class-phpass.php' );
+		require_once ABSPATH . WPINC . '/class-phpass.php';
 		self::$wp_hasher = new PasswordHash( 8, true );
 	}
 
@@ -165,6 +165,15 @@ class Tests_Auth extends WP_UnitTestCase {
 		unset( $_REQUEST['_wpnonce'] );
 	}
 
+	public function test_check_admin_referer_with_default_action_as_string_not_doing_it_wrong() {
+		// A valid nonce needs to be set so the check doesn't die()
+		$_REQUEST['_wpnonce'] = wp_create_nonce( '-1' );
+		$result               = check_admin_referer( '-1' );
+		$this->assertSame( 1, $result );
+
+		unset( $_REQUEST['_wpnonce'] );
+	}
+
 	/**
 	 * @ticket 36361
 	 */
@@ -226,6 +235,20 @@ class Tests_Auth extends WP_UnitTestCase {
 		$this->assertInstanceOf( 'WP_Error', $user );
 	}
 
+	/**
+	 * @ticket 45746
+	 */
+	function test_user_activation_key_is_saved() {
+		$user = get_userdata( $this->user->ID );
+		$key  = get_password_reset_key( $user );
+
+		// A correctly saved key should be accepted
+		$check = check_password_reset_key( $key, $this->user->user_login );
+		$this->assertNotWPError( $check );
+		$this->assertInstanceOf( 'WP_User', $check );
+		$this->assertSame( $this->user->ID, $check->ID );
+	}
+
 	/**
 	 * @ticket 32429
 	 */
@@ -242,6 +265,7 @@ class Tests_Auth extends WP_UnitTestCase {
 				'ID' => $this->user->ID,
 			)
 		);
+		clean_user_cache( $this->user );
 
 		// A valid key should be accepted
 		$check = check_password_reset_key( $key, $this->user->user_login );
@@ -279,6 +303,7 @@ class Tests_Auth extends WP_UnitTestCase {
 				'ID' => $this->user->ID,
 			)
 		);
+		clean_user_cache( $this->user );
 
 		// An expired but otherwise valid key should be rejected
 		$check = check_password_reset_key( $key, $this->user->user_login );
@@ -316,6 +341,7 @@ class Tests_Auth extends WP_UnitTestCase {
 				'ID' => $this->user->ID,
 			)
 		);
+		clean_user_cache( $this->user );
 
 		// A legacy user_activation_key should not be accepted
 		$check = check_password_reset_key( $key, $this->user->user_login );
@@ -345,6 +371,7 @@ class Tests_Auth extends WP_UnitTestCase {
 				'ID' => $this->user->ID,
 			)
 		);
+		clean_user_cache( $this->user );
 
 		// A plaintext user_activation_key should not allow an otherwise valid key to be accepted
 		$check = check_password_reset_key( $key, $this->user->user_login );
diff --git a/tests/basic.php b/tests/basic.php
index e86a0aa71b..396f108df9 100644
--- a/tests/basic.php
+++ b/tests/basic.php
@@ -13,7 +13,7 @@ class Tests_Basic extends WP_UnitTestCase {
 
 		$license = file_get_contents( ABSPATH . 'license.txt' );
 		preg_match( '#Copyright 2011-(\d+) by the contributors#', $license, $matches );
-		$this_year = date( 'Y' );
+		$this_year = gmdate( 'Y' );
 		$this->assertEquals( $this_year, trim( $matches[1] ), "license.txt's year needs to be updated to $this_year." );
 	}
 
@@ -22,7 +22,7 @@ class Tests_Basic extends WP_UnitTestCase {
 		$package_json    = json_decode( $package_json, true );
 		list( $version ) = explode( '-', $GLOBALS['wp_version'] );
 		// package.json uses x.y.z, so fill cleaned $wp_version for .0 releases
-		if ( 1 == substr_count( $version, '.' ) ) {
+		if ( 1 === substr_count( $version, '.' ) ) {
 			$version .= '.0';
 		}
 		$this->assertEquals( $version, $package_json['version'], "package.json's version needs to be updated to $version." );
diff --git a/tests/blocks/block-parser.php b/tests/blocks/block-parser.php
index 8ab5b6b536..fba13b0c71 100644
--- a/tests/blocks/block-parser.php
+++ b/tests/blocks/block-parser.php
@@ -85,7 +85,7 @@ class WP_Test_Block_Parser extends WP_UnitTestCase {
 	 * @return string The cleaned fixture name.
 	 */
 	protected function clean_fixture_filename( $filename ) {
-		$filename = basename( $filename );
+		$filename = wp_basename( $filename );
 		$filename = preg_replace( '/\..+$/', '', $filename );
 		return $filename;
 	}
diff --git a/tests/blocks/render.php b/tests/blocks/render.php
index be41a4bb9a..ab16b498d8 100644
--- a/tests/blocks/render.php
+++ b/tests/blocks/render.php
@@ -60,7 +60,7 @@ class WP_Test_Block_Render extends WP_UnitTestCase {
 
 		$actual_html = do_blocks( $original_html );
 
-		$this->assertEquals( $expected_html, $actual_html );
+		$this->assertEqualsIgnoreEOL( $expected_html, $actual_html );
 	}
 
 	/**
@@ -87,6 +87,32 @@ class WP_Test_Block_Render extends WP_UnitTestCase {
 		return $content;
 	}
 
+	/**
+	 * @ticket 45495
+	 */
+	function test_nested_calls_to_the_content() {
+		register_block_type(
+			'core/test',
+			array(
+				'render_callback' => array(
+					$this,
+					'dynamic_the_content_call',
+				),
+			)
+		);
+
+		$content = "foo\n\nbar";
+
+		$the_content = apply_filters( 'the_content', '<!-- wp:core/test -->' . $content . '<!-- /wp:core/test -->' );
+
+		$this->assertSame( $content, $the_content );
+	}
+
+	function dynamic_the_content_call( $attrs, $content ) {
+		apply_filters( 'the_content', '' );
+		return $content;
+	}
+
 	public function test_can_nest_at_least_so_deep() {
 		$minimum_depth = 99;
 
@@ -358,7 +384,7 @@ class WP_Test_Block_Render extends WP_UnitTestCase {
 	 * @return string The cleaned fixture name.
 	 */
 	protected function clean_fixture_filename( $filename ) {
-		$filename = basename( $filename );
+		$filename = wp_basename( $filename );
 		$filename = preg_replace( '/\..+$/', '', $filename );
 		return $filename;
 	}
diff --git a/tests/canonical.php b/tests/canonical.php
index a2bbc0636a..53d666e59c 100644
--- a/tests/canonical.php
+++ b/tests/canonical.php
@@ -213,4 +213,24 @@ class Tests_Canonical extends WP_Canonical_UnitTestCase {
 			// Todo: Endpoints (feeds, trackbacks, etc), More fuzzed mixed query variables, comment paging, Home page (Static)
 		);
 	}
+
+	/**
+	 * @ticket 43745
+	 */
+	public function test_utf8_query_keys_canonical() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+			)
+		);
+		update_option( 'show_on_front', 'page' );
+		update_option( 'page_on_front', $p );
+
+		$this->go_to( get_permalink( $p ) );
+
+		$url = redirect_canonical( add_query_arg( '%D0%BA%D0%BE%D0%BA%D0%BE%D0%BA%D0%BE', 1, site_url( '/' ) ), false );
+		$this->assertNull( $url );
+
+		delete_option( 'page_on_front' );
+	}
 }
diff --git a/tests/category/walkerCategory.php b/tests/category/walkerCategory.php
new file mode 100644
index 0000000000..aec86e173a
--- /dev/null
+++ b/tests/category/walkerCategory.php
@@ -0,0 +1,92 @@
+<?php
+/**
+ * @group taxonomy
+ * @group walker
+ */
+class Tests_Category_Walker_Category extends WP_UnitTestCase {
+
+	/**
+	 * @var \Walker_Category The instance of the walker.
+	 */
+	public $walker;
+
+	/**
+	 * Setup.
+	 */
+	public function setUp() {
+		parent::setUp();
+
+		/** Walker_Category class */
+		require_once ABSPATH . 'wp-includes/class-walker-category.php';
+		$this->walker = new Walker_Category();
+	}
+
+	/**
+	 * @ticket 47720
+	 *
+	 * @dataProvider data_start_el_with_empty_attributes
+	 */
+	public function test_start_el_with_empty_attributes( $value, $expected ) {
+		$output   = '';
+		$category = $this->factory->category->create_and_get();
+		$link     = get_term_link( $category );
+
+		$args = array(
+			'use_desc_for_title' => 0,
+			'style'              => 'list',
+		);
+
+		add_filter(
+			'category_list_link_attributes',
+			function( $atts ) use ( $value ) {
+				$atts['data-test'] = $value;
+				return $atts;
+			}
+		);
+
+		$this->walker->start_el( $output, $category, 0, $args );
+
+		if ( '' !== $expected ) {
+			$expected = sprintf( ' data-test="%s"', $expected );
+		}
+
+		$this->assertSame( "<li class=\"cat-item cat-item-{$category->term_id}\"><a href=\"{$link}\"{$expected}>{$category->name}</a>", trim( $output ) );
+	}
+
+	public function data_start_el_with_empty_attributes() {
+		return array(
+			array(
+				'',
+				'',
+			),
+			array(
+				0,
+				'0',
+			),
+			array(
+				0.0,
+				'0',
+			),
+			array(
+				'0',
+				'0',
+			),
+			array(
+				null,
+				'',
+			),
+			array(
+				false,
+				'',
+			),
+			array(
+				true,
+				'1',
+			),
+			array(
+				array(),
+				'',
+			),
+		);
+	}
+}
diff --git a/tests/comment-submission.php b/tests/comment-submission.php
index 0760b44dc2..2ad7f49bf5 100644
--- a/tests/comment-submission.php
+++ b/tests/comment-submission.php
@@ -133,7 +133,7 @@ class Tests_Comment_Submission extends WP_UnitTestCase {
 
 		$post = self::factory()->post->create_and_get(
 			array(
-				'post_date' => date( 'Y-m-d H:i:s', strtotime( '+1 day' ) ),
+				'post_date' => gmdate( 'Y-m-d H:i:s', strtotime( '+1 day' ) ),
 			)
 		);
 
diff --git a/tests/comment.php b/tests/comment.php
index fdfb48be3f..720a805062 100644
--- a/tests/comment.php
+++ b/tests/comment.php
@@ -672,7 +672,7 @@ class Tests_Comment extends WP_UnitTestCase {
 		// Check to see if a notification email was sent to the moderator `admin@example.org`.
 		if ( isset( $GLOBALS['phpmailer']->mock_sent )
 			&& ! empty( $GLOBALS['phpmailer']->mock_sent )
-			&& WP_TESTS_EMAIL == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0]
+			&& WP_TESTS_EMAIL === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0]
 		) {
 			$email_sent_when_comment_added = true;
 			reset_phpmailer_instance();
@@ -700,7 +700,7 @@ class Tests_Comment extends WP_UnitTestCase {
 		// Check to see if a notification email was sent to the post author `test@test.com`.
 		if ( isset( $GLOBALS['phpmailer']->mock_sent )
 			&& ! empty( $GLOBALS['phpmailer']->mock_sent )
-			&& 'test@test.com' == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0]
+			&& 'test@test.com' === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0]
 		) {
 			$email_sent_when_comment_approved = true;
 		} else {
@@ -722,7 +722,7 @@ class Tests_Comment extends WP_UnitTestCase {
 		// Check to see if a notification email was sent to the post author `test@test.com`.
 		if ( isset( $GLOBALS['phpmailer']->mock_sent ) &&
 			! empty( $GLOBALS['phpmailer']->mock_sent ) &&
-			'test@test.com' == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] ) {
+			'test@test.com' === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] ) {
 				$email_sent_when_comment_added = true;
 				reset_phpmailer_instance();
 		} else {
diff --git a/tests/comment/commentForm.php b/tests/comment/commentForm.php
index 0fabd97a6a..a03801438d 100644
--- a/tests/comment/commentForm.php
+++ b/tests/comment/commentForm.php
@@ -13,6 +13,7 @@ class Tests_Comment_CommentForm extends WP_UnitTestCase {
 			'class_submit' => 'foo-class',
 			'label_submit' => 'foo-label',
 		);
+
 		$form = get_echo( 'comment_form', array( $args, $p ) );
 
 		$button = '<input name="foo-name" type="submit" id="foo-id" class="foo-class" value="foo-label" />';
@@ -30,6 +31,7 @@ class Tests_Comment_CommentForm extends WP_UnitTestCase {
 			'label_submit'  => 'foo-label',
 			'submit_button' => '<input name="custom-%1$s" type="submit" id="custom-%2$s" class="custom-%3$s" value="custom-%4$s" />',
 		);
+
 		$form = get_echo( 'comment_form', array( $args, $p ) );
 
 		$button = '<input name="custom-foo-name" type="submit" id="custom-foo-id" class="custom-foo-class" value="custom-foo-label" />';
@@ -46,6 +48,7 @@ class Tests_Comment_CommentForm extends WP_UnitTestCase {
 			'label_submit' => 'foo-label',
 			'submit_field' => '<p class="my-custom-submit-field">%1$s %2$s</p>',
 		);
+
 		$form = get_echo( 'comment_form', array( $args, $p ) );
 
 		$button = '<input name="foo-name" type="submit" id="foo-id" class="foo-class" value="foo-label" />';
@@ -94,10 +97,30 @@ class Tests_Comment_CommentForm extends WP_UnitTestCase {
 				'author' => 'Hello World!',
 			),
 		);
+
 		$form = get_echo( 'comment_form', array( $args, $p ) );
 
 		remove_filter( 'option_show_comments_cookies_opt_in', '__return_true' );
 
 		$this->assertRegExp( '|<p class="comment\-form\-cookies\-consent">.*?</p>|', $form );
 	}
+
+	/**
+	 * @ticket 47975
+	 */
+	public function test_aria_describedby_email_notes_should_not_be_added_if_no_email_notes() {
+		$p = self::factory()->post->create();
+
+		$form_with_aria = get_echo( 'comment_form', array( array(), $p ) );
+
+		$this->assertContains( 'aria-describedby="email-notes"', $form_with_aria );
+
+		$args = array(
+			'comment_notes_before' => '',
+		);
+
+		$form_without_aria = get_echo( 'comment_form', array( $args, $p ) );
+
+		$this->assertNotContains( 'aria-describedby="email-notes"', $form_without_aria );
+	}
 }
diff --git a/tests/comment/commentsTemplate.php b/tests/comment/commentsTemplate.php
index b5cc7ef3e3..d5bf72d2f8 100644
--- a/tests/comment/commentsTemplate.php
+++ b/tests/comment/commentsTemplate.php
@@ -17,14 +17,14 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 
@@ -51,14 +51,14 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 
@@ -85,14 +85,14 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 
@@ -119,14 +119,14 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 
@@ -153,42 +153,42 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 		$comment_5 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 500 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 500 ),
 			)
 		);
 		$comment_6 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 600 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 600 ),
 			)
 		);
 
@@ -224,42 +224,42 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 		$comment_5 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 500 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 500 ),
 			)
 		);
 		$comment_6 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 600 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 600 ),
 			)
 		);
 
@@ -295,28 +295,28 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 
@@ -352,28 +352,28 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 
@@ -411,21 +411,21 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 
@@ -463,21 +463,21 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 
@@ -513,28 +513,28 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 
@@ -592,42 +592,42 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 		$comment_5 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 500 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 500 ),
 			)
 		);
 		$comment_6 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 600 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 600 ),
 			)
 		);
 
@@ -706,7 +706,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
 				'comment_approved' => '0',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
@@ -714,7 +714,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
 				'comment_approved' => '0',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
@@ -722,7 +722,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '3',
 				'comment_approved' => '0',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_4 = self::factory()->comment->create(
@@ -730,7 +730,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '4',
 				'comment_approved' => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 
@@ -762,7 +762,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
 				'comment_approved' => '0',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
@@ -770,7 +770,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
 				'comment_approved' => '0',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
@@ -778,7 +778,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'      => $p,
 				'comment_content'      => '3',
 				'comment_approved'     => '0',
-				'comment_date_gmt'     => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 				'comment_author_email' => $comment_author_email,
 			)
 		);
@@ -787,7 +787,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'      => $p,
 				'comment_content'      => '4',
 				'comment_approved'     => '0',
-				'comment_date_gmt'     => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 				'comment_author_email' => $comment_author_email,
 			)
 		);
@@ -796,7 +796,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'      => $p,
 				'comment_content'      => '5',
 				'comment_approved'     => '0',
-				'comment_date_gmt'     => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 				'comment_author_email' => $comment_author_email,
 			)
 		);
@@ -805,7 +805,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '6',
 				'comment_approved' => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 
@@ -842,7 +842,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'      => $p,
 				'comment_content'      => '1',
 				'comment_approved'     => '0',
-				'comment_date_gmt'     => date( 'Y-m-d H:i:s', $now ),
+				'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', $now ),
 				'comment_author_email' => 'foo@bar.mail',
 			)
 		);
@@ -878,7 +878,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
 				'comment_approved' => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
@@ -886,7 +886,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
 				'comment_approved' => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
@@ -895,7 +895,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_content'  => '3',
 				'comment_approved' => '1',
 				'comment_parent'   => $comment_1,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 
@@ -923,7 +923,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '1',
 				'comment_approved' => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		$comment_2 = self::factory()->comment->create(
@@ -931,7 +931,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_post_ID'  => $p,
 				'comment_content'  => '2',
 				'comment_approved' => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		$comment_3 = self::factory()->comment->create(
@@ -940,7 +940,7 @@ class Tests_Comment_CommentsTemplate extends WP_UnitTestCase {
 				'comment_content'  => '3',
 				'comment_approved' => '1',
 				'comment_parent'   => $comment_1,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 
diff --git a/tests/comment/getCommentAuthorUrlLink.php b/tests/comment/getCommentAuthorUrlLink.php
index 468ddeb33a..c123e932c2 100644
--- a/tests/comment/getCommentAuthorUrlLink.php
+++ b/tests/comment/getCommentAuthorUrlLink.php
@@ -31,7 +31,8 @@ class Tests_Comment_GetCommentAuthorUrlLink extends WP_UnitTestCase {
 	}
 
 	public function test_global_comment() {
-		$GLOBALS['comment'] = $comment = reset( self::$comments );
+		$comment            = reset( self::$comments );
+		$GLOBALS['comment'] = $comment;
 
 		$url_link = get_comment_author_url_link();
 		$link     = $this->parseCommentAuthorUrl( $comment );
diff --git a/tests/comment/getCommentLink.php b/tests/comment/getCommentLink.php
index ca75da1532..03ccf923ab 100644
--- a/tests/comment/getCommentLink.php
+++ b/tests/comment/getCommentLink.php
@@ -15,42 +15,42 @@ class Tests_Comment_GetCommentLink extends WP_UnitTestCase {
 			array(
 				'comment_post_ID'  => self::$p,
 				'comment_content'  => '1',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 100 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 100 ),
 			)
 		);
 		self::$comments[] = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$p,
 				'comment_content'  => '2',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 200 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 200 ),
 			)
 		);
 		self::$comments[] = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$p,
 				'comment_content'  => '3',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 300 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 300 ),
 			)
 		);
 		self::$comments[] = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 400 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 400 ),
 			)
 		);
 		self::$comments[] = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 500 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 500 ),
 			)
 		);
 		self::$comments[] = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$p,
 				'comment_content'  => '4',
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 600 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 600 ),
 			)
 		);
 
diff --git a/tests/comment/getCommentReplyLink.php b/tests/comment/getCommentReplyLink.php
index a9645fc4aa..73e288501c 100644
--- a/tests/comment/getCommentReplyLink.php
+++ b/tests/comment/getCommentReplyLink.php
@@ -26,4 +26,64 @@ class Tests_Comment_GetCommentReplyLink extends WP_UnitTestCase {
 
 		$this->assertNull( get_comment_reply_link( $args ) );
 	}
+
+	/**
+	 * Ensure comment reply links include post permalink.
+	 *
+	 * @ticket 47174
+	 */
+	public function test_get_comment_reply_link_should_include_post_permalink() {
+		// Create a sample post.
+		$post_id = self::factory()->post->create();
+
+		// Insert comment.
+		$comment_id = self::factory()->comment->create(
+			array(
+				'comment_post_ID' => $post_id,
+				'user_id'         => 1,
+			)
+		);
+
+		// `depth` and `max_depth` required for reply links to display.
+		$comment_reply_link = get_comment_reply_link(
+			array(
+				'depth'     => 1,
+				'max_depth' => 5,
+			),
+			$comment_id,
+			$post_id
+		);
+
+		$expected_url = esc_url(
+			add_query_arg(
+				array(
+					'p'          => $post_id,
+					'replytocom' => $comment_id,
+				),
+				home_url( '/#respond' )
+			)
+		);
+
+		$this->assertContains( $expected_url, $comment_reply_link );
+	}
+
+	/**
+	 * @ticket 41846
+	 */
+	public function test_should_return_null_when_depth_less_than_max_depth_and_comment_null_and_no_current_global_comment() {
+
+		// Let max depth be greater than depth and depth be non-zero.
+		$args = array(
+			'depth'     => 1,
+			'max_depth' => 2,
+		);
+
+		// Make sure there's no global comment object.
+		add_filter( 'get_comment', '__return_null' );
+
+		$actual = get_comment_reply_link( $args );
+
+		$this->assertNull( $actual );
+	}
+
 }
diff --git a/tests/comment/getPageOfComment.php b/tests/comment/getPageOfComment.php
index 509ecffad6..e6527ffb94 100644
--- a/tests/comment/getPageOfComment.php
+++ b/tests/comment/getPageOfComment.php
@@ -45,7 +45,7 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 				array(
 					'comment_post_ID'  => $p,
 					'comment_type'     => 'trackback',
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now ),
 				)
 			);
 			$now             -= 10 * $i;
@@ -57,7 +57,7 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 				array(
 					'comment_post_ID'  => $p,
 					'comment_type'     => 'pingback',
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now ),
 				)
 			);
 			$now            -= 10 * $i;
@@ -135,7 +135,7 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 				array(
 					'comment_post_ID'  => $p,
 					'comment_type'     => 'trackback',
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( 10 * $i ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( 10 * $i ) ),
 				)
 			);
 		}
@@ -226,20 +226,20 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		$c1 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 		$c2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 20 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 20 ),
 			)
 		);
 		$c3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
 				'comment_approved' => 0,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 30 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 30 ),
 			)
 		);
 
@@ -257,18 +257,19 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		$posts = self::factory()->post->create_many( 2 );
 
 		$now        = time();
-		$comments_0 = $comments_1 = array();
+		$comments_0 = array();
+		$comments_1 = array();
 		for ( $i = 0; $i < 5; $i++ ) {
 			$comments_0[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $posts[0],
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( $i * 60 ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( $i * 60 ) ),
 				)
 			);
 			$comments_1[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $posts[1],
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( $i * 60 ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( $i * 60 ) ),
 				)
 			);
 		}
@@ -286,13 +287,14 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 	public function test_only_top_level_comments_should_be_included_in_older_count() {
 		$post = self::factory()->post->create();
 
-		$now             = time();
-		$comment_parents = $comment_children = array();
+		$now              = time();
+		$comment_parents  = array();
+		$comment_children = array();
 		for ( $i = 0; $i < 5; $i++ ) {
 			$parent                = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $post,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( $i * 60 ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( $i * 60 ) ),
 				)
 			);
 			$comment_parents[ $i ] = $parent;
@@ -300,7 +302,7 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 			$child                  = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $post,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( $i * 59 ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( $i * 59 ) ),
 					'comment_parent'   => $parent,
 				)
 			);
@@ -336,19 +338,19 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		$c1 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 		$c2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 20 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 20 ),
 			)
 		);
 		$c3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 30 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 30 ),
 			)
 		);
 
@@ -369,25 +371,25 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		$c1 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 		$c2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 20 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 20 ),
 			)
 		);
 		$c3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 30 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 30 ),
 			)
 		);
 		$c4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 40 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 40 ),
 			)
 		);
 
@@ -409,25 +411,25 @@ class Tests_Comment_GetPageOfComment extends WP_UnitTestCase {
 		$c1 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 		$c2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 20 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 20 ),
 			)
 		);
 		$c3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 30 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 30 ),
 			)
 		);
 		$c4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => $p,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 40 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 40 ),
 			)
 		);
 
diff --git a/tests/comment/metaCache.php b/tests/comment/metaCache.php
index 834097a76c..a455654e11 100644
--- a/tests/comment/metaCache.php
+++ b/tests/comment/metaCache.php
@@ -142,7 +142,7 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $posts[0],
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( 60 * $i ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( 60 * $i ) ),
 				)
 			);
 		}
@@ -190,7 +190,7 @@ class Tests_Comment_Meta_Cache extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $posts[0],
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - ( 60 * $i ) ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - ( 60 * $i ) ),
 				)
 			);
 		}
diff --git a/tests/comment/query.php b/tests/comment/query.php
index 211415214b..372fa475c4 100644
--- a/tests/comment/query.php
+++ b/tests/comment/query.php
@@ -2949,25 +2949,25 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$c1 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 50 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 50 ),
 			)
 		);
 		$c2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 40 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 40 ),
 			)
 		);
 		$c3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 30 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 30 ),
 			)
 		);
 		$c4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 20 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 20 ),
 			)
 		);
 
@@ -2995,25 +2995,25 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 		$c1 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 50 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 50 ),
 			)
 		);
 		$c2 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 40 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 40 ),
 			)
 		);
 		$c3 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 30 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 30 ),
 			)
 		);
 		$c4 = self::factory()->comment->create(
 			array(
 				'comment_post_ID'  => self::$post_id,
-				'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - 20 ),
+				'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - 20 ),
 			)
 		);
 
@@ -4882,4 +4882,35 @@ class Tests_Comment_Query extends WP_UnitTestCase {
 
 		$this->assertEqualSets( $c1, $found );
 	}
+
+	/**
+	 * @ticket 45800
+	 */
+	public function test_comments_pre_query_filter_should_bypass_database_query() {
+		global $wpdb;
+
+		add_filter( 'comments_pre_query', array( __CLASS__, 'filter_comments_pre_query' ), 10, 2 );
+
+		$num_queries = $wpdb->num_queries;
+
+		$q       = new WP_Comment_Query();
+		$results = $q->query( array() );
+
+		remove_filter( 'comments_pre_query', array( __CLASS__, 'filter_comments_pre_query' ), 10, 2 );
+
+		// Make sure no queries were executed.
+		$this->assertSame( $num_queries, $wpdb->num_queries );
+
+		// We manually inserted a non-existing site and overrode the results with it.
+		$this->assertSame( array( 555 ), $results );
+
+		// Make sure manually setting total_users doesn't get overwritten.
+		$this->assertEquals( 1, $q->found_comments );
+	}
+
+	public static function filter_comments_pre_query( $comments, $query ) {
+		$query->found_comments = 1;
+
+		return array( 555 );
+	}
 }
diff --git a/tests/comment/walker.php b/tests/comment/walker.php
index 5e589270c9..eadd9861e9 100644
--- a/tests/comment/walker.php
+++ b/tests/comment/walker.php
@@ -54,10 +54,10 @@ class Comment_Callback_Test {
 	}
 
 	public function comment( $comment, $args, $depth ) {
-		if ( 1 == $depth ) {
+		if ( 1 === $depth ) {
 			$this->test_walker->assertTrue( $this->walker->has_children );
 			$this->test_walker->assertTrue( $args['has_children'] ); // Back compat
-		} elseif ( 2 == $depth ) {
+		} elseif ( 2 === $depth ) {
 			$this->test_walker->assertFalse( $this->walker->has_children );
 			$this->test_walker->assertFalse( $args['has_children'] ); // Back compat
 		}
diff --git a/tests/comment/wpAllowComment.php b/tests/comment/wpAllowComment.php
index 6d3e3ef6d8..a1404b624c 100644
--- a/tests/comment/wpAllowComment.php
+++ b/tests/comment/wpAllowComment.php
@@ -42,7 +42,7 @@ class Tests_Comment_WpAllowComment extends WP_UnitTestCase {
 			'comment_content'      => 'Yes, we can!',
 			'comment_author_IP'    => '192.168.0.1',
 			'comment_parent'       => 0,
-			'comment_date_gmt'     => date( 'Y-m-d H:i:s', $now ),
+			'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', $now ),
 			'comment_agent'        => 'Bobbot/2.1',
 			'comment_type'         => '',
 		);
@@ -65,7 +65,7 @@ class Tests_Comment_WpAllowComment extends WP_UnitTestCase {
 			'comment_content'      => 'Yes, we can!',
 			'comment_author_IP'    => '192.168.0.1',
 			'comment_parent'       => 0,
-			'comment_date_gmt'     => date( 'Y-m-d H:i:s', $now ),
+			'comment_date_gmt'     => gmdate( 'Y-m-d H:i:s', $now ),
 			'comment_agent'        => 'Bobbot/2.1',
 			'comment_type'         => '',
 		);
diff --git a/tests/comment/wpListComments.php b/tests/comment/wpListComments.php
index da330c7924..9fb94467d0 100644
--- a/tests/comment/wpListComments.php
+++ b/tests/comment/wpListComments.php
@@ -16,7 +16,7 @@ class Tests_Comment_WpListComments extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $p,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - $i ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - $i ),
 					'comment_author'   => 'Commenter ' . $i,
 				)
 			);
@@ -54,7 +54,7 @@ class Tests_Comment_WpListComments extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $p,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - $i ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - $i ),
 					'comment_author'   => 'Commenter ' . $i,
 				)
 			);
@@ -92,7 +92,7 @@ class Tests_Comment_WpListComments extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $p,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - $i ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - $i ),
 					'comment_author'   => 'Commenter ' . $i,
 				)
 			);
@@ -138,7 +138,7 @@ class Tests_Comment_WpListComments extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $p,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - $i ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - $i ),
 					'comment_author'   => 'Commenter ' . $i,
 				)
 			);
@@ -178,7 +178,7 @@ class Tests_Comment_WpListComments extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $p,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - $i ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - $i ),
 					'comment_author'   => 'Commenter ' . $i,
 				)
 			);
@@ -223,7 +223,7 @@ class Tests_Comment_WpListComments extends WP_UnitTestCase {
 			$comments[] = self::factory()->comment->create(
 				array(
 					'comment_post_ID'  => $p,
-					'comment_date_gmt' => date( 'Y-m-d H:i:s', $now - $i ),
+					'comment_date_gmt' => gmdate( 'Y-m-d H:i:s', $now - $i ),
 					'comment_author'   => 'Commenter ' . $i,
 					'user_id'          => $u,
 				)
diff --git a/tests/compat.php b/tests/compat.php
index b5b42d2a00..a8b14ee42c 100644
--- a/tests/compat.php
+++ b/tests/compat.php
@@ -125,10 +125,10 @@ EOT;
 			'string',
 			$heredoc,
 			// object data
-			new classA(),
-			// undefined data
+			new ClassA(),
+			// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged -- intentionally undefined data
 			@$undefined_var,
-			// unset data
+			// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged -- intentionally unset data
 			@$unset_var,
 		);
 		$outputs  = array(
@@ -179,6 +179,9 @@ EOT;
 		$this->assertEquals( array( 1 => '993003b95758e0ac2eba451a4c5877eb1bb7b92a' ), unpack( 'H40', _hash_hmac( 'sha1', 'simple', 'key', true ) ) );
 	}
 
+	/**
+	 * @expectedException PHPUnit_Framework_Error_Deprecated
+	 */
 	function test_json_encode_decode() {
 		require_once( ABSPATH . WPINC . '/class-json.php' );
 		$json = new Services_JSON();
@@ -246,11 +249,6 @@ EOT;
 			$this->markTestSkipped( 'The intl extension is not loaded. ResourceBundle not tested for is_countable().' );
 		}
 
-		if ( version_compare( PHP_VERSION, '5.4', '<' ) ) {
-			$this->markTestSkipped( 'ResourceBundle is only countable in PHP 5.4+' );
-			return;
-		}
-
 		$this->assertTrue( is_countable( new ResourceBundle( 'en', null ) ) );
 	}
 
@@ -315,7 +313,7 @@ EOT;
 }
 
 /* used in test_mb_substr_phpcore */
-class classA {
+class ClassA {
 	public function __toString() {
 		return 'Class A object';
 	}
diff --git a/tests/cron.php b/tests/cron.php
index 8d2f337ed8..3503b1c0d7 100644
--- a/tests/cron.php
+++ b/tests/cron.php
@@ -596,4 +596,88 @@ class Tests_Cron extends WP_UnitTestCase {
 		$this->assertFalse( wp_get_scheduled_event( $hook, $args, 'Words Fail!' ) );
 
 	}
+
+	/**
+	 * Ensure any past event counts as a duplicate.
+	 *
+	 * @ticket 44818
+	 */
+	function test_duplicate_past_event() {
+		$hook = __FUNCTION__;
+		$args = array( 'arg1' );
+		$ts1  = strtotime( '-14 minutes' );
+		$ts2  = strtotime( '+5 minutes' );
+		$ts3  = strtotime( '-2 minutes' );
+
+		// First event scheduled successfully.
+		$this->assertTrue( wp_schedule_single_event( $ts1, $hook, $args ) );
+
+		// Second event fails.
+		$this->assertFalse( wp_schedule_single_event( $ts2, $hook, $args ) );
+
+		// Third event fails.
+		$this->assertFalse( wp_schedule_single_event( $ts3, $hook, $args ) );
+	}
+
+	/**
+	 * Ensure any near future event counts as a duplicate.
+	 *
+	 * @ticket 44818
+	 */
+	function test_duplicate_near_future_event() {
+		$hook = __FUNCTION__;
+		$args = array( 'arg1' );
+		$ts1  = strtotime( '+4 minutes' );
+		$ts2  = strtotime( '-15 minutes' );
+		$ts3  = strtotime( '+12 minutes' );
+
+		// First event scheduled successfully.
+		$this->assertTrue( wp_schedule_single_event( $ts1, $hook, $args ) );
+
+		// Second event fails.
+		$this->assertFalse( wp_schedule_single_event( $ts2, $hook, $args ) );
+
+		// Third event fails.
+		$this->assertFalse( wp_schedule_single_event( $ts3, $hook, $args ) );
+	}
+
+	/**
+	 * Duplicate future events are disallowed.
+	 *
+	 * @ticket 44818
+	 */
+	function test_duplicate_future_event() {
+		$hook = __FUNCTION__;
+		$args = array( 'arg1' );
+		$ts1  = strtotime( '+15 minutes' );
+		$ts2  = strtotime( '-600 seconds', $ts1 );
+		$ts3  = strtotime( '+600 seconds', $ts1 );
+
+		// First event scheduled successfully.
+		$this->assertTrue( wp_schedule_single_event( $ts1, $hook, $args ) );
+
+		// Events within ten minutes should fail.
+		$this->assertFalse( wp_schedule_single_event( $ts2, $hook, $args ) );
+		$this->assertFalse( wp_schedule_single_event( $ts3, $hook, $args ) );
+	}
+
+	/**
+	 * Future events are allowed.
+	 *
+	 * @ticket 44818
+	 */
+	function test_not_duplicate_future_event() {
+		$hook = __FUNCTION__;
+		$args = array( 'arg1' );
+		$ts1  = strtotime( '+15 minutes' );
+		$ts2  = strtotime( '-601 seconds', $ts1 );
+		$ts3  = strtotime( '+601 seconds', $ts1 );
+
+		// First event scheduled successfully.
+		$this->assertTrue( wp_schedule_single_event( $ts1, $hook, $args ) );
+
+		// Events over ten minutes should work.
+		$this->assertTrue( wp_schedule_single_event( $ts2, $hook, $args ) );
+		$this->assertTrue( wp_schedule_single_event( $ts3, $hook, $args ) );
+	}
 }
diff --git a/tests/customize/manager.php b/tests/customize/manager.php
index 71d7e0e6e4..bca6decdc4 100644
--- a/tests/customize/manager.php
+++ b/tests/customize/manager.php
@@ -741,7 +741,8 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		// Ensure that re-importing doesn't cause auto-drafts to balloon.
 		$wp_customize->import_theme_starter_content();
 		$changeset_data = $wp_customize->changeset_data();
-		$this->assertEqualSets( array_values( $posts_by_name ), $changeset_data['nav_menus_created_posts']['value'] ); // Auto-drafts should not get re-created and amended with each import.
+		// Auto-drafts should not get re-created and amended with each import.
+		$this->assertEqualSets( array_values( $posts_by_name ), $changeset_data['nav_menus_created_posts']['value'] );
 
 		// Test that saving non-starter content on top of the changeset clears the starter_content flag.
 		$wp_customize->save_changeset_post(
@@ -755,7 +756,10 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$this->assertArrayNotHasKey( 'starter_content', $changeset_data['blogname'] );
 		$this->assertArrayHasKey( 'starter_content', $changeset_data['blogdescription'] );
 
-		// Test that adding blogname starter content is ignored now that it is modified, but updating a non-modified starter content blog description passes.
+		/*
+		 * Test that adding blogname starter content is ignored now that it is modified,
+		 * but updating a non-modified starter content blog description passes.
+		 */
 		$previous_blogname        = $changeset_data['blogname']['value'];
 		$previous_blogdescription = $changeset_data['blogdescription']['value'];
 		$wp_customize->import_theme_starter_content(
@@ -800,6 +804,80 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$this->assertEmpty( get_post_meta( $posts_by_name['waffles'], '_customize_draft_post_name', true ) );
 	}
 
+	/**
+	 * Test WP_Customize_Manager::import_theme_starter_content() with nested arrays.
+	 *
+	 * @ticket 45484
+	 * @covers WP_Customize_Manager::import_theme_starter_content()
+	 */
+	function test_import_theme_starter_content_with_nested_arrays() {
+		wp_set_current_user( self::$admin_user_id );
+
+		$existing_published_home_page_id = $this->factory()->post->create(
+			array(
+				'post_name'   => 'home',
+				'post_type'   => 'page',
+				'post_status' => 'publish',
+			)
+		);
+
+		global $wp_customize;
+		$wp_customize           = new WP_Customize_Manager();
+		$starter_content_config = array(
+			'posts'      => array(
+				'home',
+			),
+			'options'    => array(
+				'array_option'        => array(
+					0,
+					1,
+					'home_page_id' => '{{home}}',
+				),
+				'nested_array_option' => array(
+					0,
+					1,
+					array(
+						2,
+						'home_page_id' => '{{home}}',
+					),
+				),
+			),
+			'theme_mods' => array(
+				'array_theme_mod'        => array(
+					0,
+					1,
+					'home_page_id' => '{{home}}',
+				),
+				'nested_array_theme_mod' => array(
+					0,
+					1,
+					array(
+						2,
+						'home_page_id' => '{{home}}',
+					),
+				),
+			),
+		);
+
+		add_theme_support( 'starter-content', $starter_content_config );
+		$this->assertEmpty( $wp_customize->unsanitized_post_values() );
+		$wp_customize->import_theme_starter_content();
+		$changeset_values     = $wp_customize->unsanitized_post_values();
+		$expected_setting_ids = array(
+			'array_option',
+			'array_theme_mod',
+			'nav_menus_created_posts',
+			'nested_array_option',
+			'nested_array_theme_mod',
+		);
+		$this->assertEqualSets( $expected_setting_ids, array_keys( $changeset_values ) );
+
+		$this->assertSame( $existing_published_home_page_id, $changeset_values['array_option']['home_page_id'] );
+		$this->assertSame( $existing_published_home_page_id, $changeset_values['nested_array_option'][2]['home_page_id'] );
+		$this->assertSame( $existing_published_home_page_id, $changeset_values['array_theme_mod']['home_page_id'] );
+		$this->assertSame( $existing_published_home_page_id, $changeset_values['nested_array_theme_mod'][2]['home_page_id'] );
+	}
+
 	/**
 	 * Test WP_Customize_Manager::customize_preview_init().
 	 *
@@ -936,7 +1014,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		);
 		$uuid       = wp_generate_uuid4();
 
-		$wp_customize = $manager = new WP_Customize_Manager(
+		$manager      = new WP_Customize_Manager(
 			array(
 				'changeset_uuid' => $uuid,
 			)
@@ -1039,7 +1117,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		$this->assertEquals( $previous_saved_data, json_decode( get_post( $post_id )->post_content, true ) );
 
 		// Attempt a non-transactional/incremental update.
-		$wp_customize = $manager = new WP_Customize_Manager(
+		$manager      = new WP_Customize_Manager(
 			array(
 				'changeset_uuid' => $uuid,
 			)
@@ -1100,7 +1178,8 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 			$action_counts[ $action_name ] = did_action( $action_name );
 		}
 
-		$wp_customize = $manager = new WP_Customize_Manager( array( 'changeset_uuid' => $uuid ) );
+		$manager      = new WP_Customize_Manager( array( 'changeset_uuid' => $uuid ) );
+		$wp_customize = $manager;
 		do_action( 'customize_register', $wp_customize );
 		$manager->add_setting(
 			'scratchpad',
@@ -1142,7 +1221,8 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 		// Test revisions.
 		add_post_type_support( 'customize_changeset', 'revisions' );
 		$uuid         = wp_generate_uuid4();
-		$wp_customize = $manager = new WP_Customize_Manager( array( 'changeset_uuid' => $uuid ) );
+		$manager      = new WP_Customize_Manager( array( 'changeset_uuid' => $uuid ) );
+		$wp_customize = $manager;
 		do_action( 'customize_register', $manager );
 
 		$manager->set_post_value( 'blogname', 'Hello Surface' );
@@ -1854,9 +1934,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 
 		$r = $manager->save_changeset_post( $args );
 		$this->assertInstanceOf( 'WP_Error', $r );
-		if ( function_exists( 'json_last_error' ) ) {
-			$this->assertEquals( 'json_parse_error', $r->get_error_code() );
-		}
+		$this->assertEquals( 'json_parse_error', $r->get_error_code() );
 
 		wp_update_post(
 			array(
@@ -2539,10 +2617,11 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 * Capture the actions fired when calling WP_Customize_Manager::set_post_value().
 	 *
 	 * @see Tests_WP_Customize_Manager::test_set_post_value()
+	 *
+	 * @param mixed ...$args Optional arguments passed to the action.
 	 */
-	function capture_customize_post_value_set_actions() {
+	function capture_customize_post_value_set_actions( ...$args ) {
 		$action = current_action();
-		$args   = func_get_args();
 		$this->captured_customize_post_value_set_actions[] = compact( 'action', 'args' );
 	}
 
@@ -2666,7 +2745,7 @@ class Tests_WP_Customize_Manager extends WP_UnitTestCase {
 	 */
 	function filter_customize_dynamic_setting_args_for_test_dynamic_settings( $setting_args, $setting_id ) {
 		$this->assertInternalType( 'string', $setting_id );
-		if ( in_array( $setting_id, array( 'foo', 'bar' ) ) ) {
+		if ( in_array( $setting_id, array( 'foo', 'bar' ), true ) ) {
 			$setting_args = array( 'default' => "dynamic_{$setting_id}_default" );
 		}
 		return $setting_args;
diff --git a/tests/customize/nav-menu-item-setting.php b/tests/customize/nav-menu-item-setting.php
index 4b88c058e6..c80ce613b4 100644
--- a/tests/customize/nav-menu-item-setting.php
+++ b/tests/customize/nav-menu-item-setting.php
@@ -386,7 +386,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$menu_items = wp_get_nav_menu_items( $secondary_menu_id );
 		$db_ids     = wp_list_pluck( $menu_items, 'db_id' );
 		$this->assertContains( $item_id, $db_ids );
-		$i                         = array_search( $item_id, $db_ids );
+		$i                         = array_search( $item_id, $db_ids, true );
 		$updated_item              = $menu_items[ $i ];
 		$post_value['post_status'] = $post_value['status'];
 		unset( $post_value['status'] );
@@ -676,7 +676,7 @@ class Test_WP_Customize_Nav_Menu_Item_Setting extends WP_UnitTestCase {
 		$menu_items = wp_get_nav_menu_items( $secondary_menu_id );
 		$db_ids     = wp_list_pluck( $menu_items, 'db_id' );
 		$this->assertContains( $item_id, $db_ids );
-		$i                         = array_search( $item_id, $db_ids );
+		$i                         = array_search( $item_id, $db_ids, true );
 		$updated_item              = $menu_items[ $i ];
 		$post_value['post_status'] = $post_value['status'];
 		unset( $post_value['status'] );
diff --git a/tests/customize/nav-menu-setting.php b/tests/customize/nav-menu-setting.php
index b963a2a7a7..ffa8a1bc8d 100644
--- a/tests/customize/nav-menu-setting.php
+++ b/tests/customize/nav-menu-setting.php
@@ -224,7 +224,7 @@ class Test_WP_Customize_Nav_Menu_Setting extends WP_UnitTestCase {
 
 		$menus     = wp_get_nav_menus();
 		$menus_ids = wp_list_pluck( $menus, 'term_id' );
-		$i         = array_search( $menu_id, $menus_ids );
+		$i         = array_search( $menu_id, $menus_ids, true );
 		$this->assertInternalType( 'int', $i, 'Update-previewed menu does not appear in wp_get_nav_menus()' );
 		$filtered_menu = $menus[ $i ];
 		$this->assertEquals( 'Name 2 \\o/', $filtered_menu->name );
@@ -269,7 +269,7 @@ class Test_WP_Customize_Nav_Menu_Setting extends WP_UnitTestCase {
 
 		$menus     = wp_get_nav_menus();
 		$menus_ids = wp_list_pluck( $menus, 'term_id' );
-		$i         = array_search( $menu_id, $menus_ids );
+		$i         = array_search( $menu_id, $menus_ids, true );
 		$this->assertInternalType( 'int', $i, 'Insert-previewed menu was not injected into wp_get_nav_menus()' );
 		$filtered_menu = $menus[ $i ];
 		$this->assertEquals( 'New Menu Name 1 \\o/', $filtered_menu->name );
diff --git a/tests/customize/nav-menus.php b/tests/customize/nav-menus.php
index e7387773ac..1de6047097 100644
--- a/tests/customize/nav-menus.php
+++ b/tests/customize/nav-menus.php
@@ -1083,9 +1083,7 @@ class Test_WP_Customize_Nav_Menus extends WP_UnitTestCase {
 		);
 
 		// Add global namespace prefix to check #41488.
-		if ( version_compare( PHP_VERSION, '5.3', '>=' ) ) {
-			$original_args['fallback_cb'] = '\\' . $original_args['fallback_cb'];
-		}
+		$original_args['fallback_cb'] = '\\' . $original_args['fallback_cb'];
 
 		$args = $menus->filter_wp_nav_menu_args( $original_args );
 
diff --git a/tests/customize/section.php b/tests/customize/section.php
index cac5046881..f2b06dfda3 100644
--- a/tests/customize/section.php
+++ b/tests/customize/section.php
@@ -10,7 +10,8 @@ class Tests_WP_Customize_Section extends WP_UnitTestCase {
 	protected static $user_ids = array();
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$user_ids[] = self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$admin_id   = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$user_ids[] = self::$admin_id;
 	}
 
 	/**
diff --git a/tests/customize/widgets.php b/tests/customize/widgets.php
index 967d3d62f0..006cf6f7a2 100644
--- a/tests/customize/widgets.php
+++ b/tests/customize/widgets.php
@@ -32,9 +32,9 @@ class Tests_WP_Customize_Widgets extends WP_UnitTestCase {
 
 		unset( $GLOBALS['_wp_sidebars_widgets'] ); // clear out cache set by wp_get_sidebars_widgets()
 		$sidebars_widgets = wp_get_sidebars_widgets();
-		$this->assertEqualSets( array( 'wp_inactive_widgets', 'sidebar-1' ), array_keys( wp_get_sidebars_widgets() ) );
+		$this->assertEqualSets( array( 'wp_inactive_widgets', 'sidebar-1', 'sidebar-2' ), array_keys( wp_get_sidebars_widgets() ) );
 		$this->assertContains( 'search-2', $sidebars_widgets['sidebar-1'] );
-		$this->assertContains( 'categories-2', $sidebars_widgets['sidebar-1'] );
+		$this->assertContains( 'categories-2', $sidebars_widgets['sidebar-2'] );
 		$this->assertArrayHasKey( 2, get_option( 'widget_search' ) );
 		$widget_categories = get_option( 'widget_categories' );
 		$this->assertArrayHasKey( 2, $widget_categories );
diff --git a/tests/date/currentTime.php b/tests/date/currentTime.php
index 209eb128c6..836f2737ee 100644
--- a/tests/date/currentTime.php
+++ b/tests/date/currentTime.php
@@ -4,21 +4,66 @@
  * @group date
  * @group datetime
  */
-class Tests_Date_CurrentTime extends WP_UnitTestCase {
+class Tests_Date_Current_Time extends WP_UnitTestCase {
 
+	/**
+	 * @ticket 37440
+	 */
 	public function test_should_work_with_changed_timezone() {
-
 		$format          = 'Y-m-d H:i:s';
 		$timezone_string = 'America/Regina';
 		update_option( 'timezone_string', $timezone_string );
 		$datetime = new DateTime( 'now', new DateTimeZone( $timezone_string ) );
 
 		date_default_timezone_set( $timezone_string );
-		$this->assertEquals( gmdate( $format ), current_time( $format, true ) );
-		$this->assertEquals( $datetime->format( $format ), current_time( $format ) );
+
+		$current_time_custom_timezone_gmt = current_time( $format, true );
+		$current_time_custom_timezone     = current_time( $format );
 
 		date_default_timezone_set( 'UTC' );
-		$this->assertEquals( gmdate( $format ), current_time( $format, true ) );
-		$this->assertEquals( $datetime->format( $format ), current_time( $format ) );
+
+		$current_time_gmt = current_time( $format, true );
+		$current_time     = current_time( $format );
+
+		$this->assertEquals( strtotime( gmdate( $format ) ), strtotime( $current_time_custom_timezone_gmt ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( $datetime->format( $format ) ), strtotime( $current_time_custom_timezone ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( gmdate( $format ) ), strtotime( $current_time_gmt ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( $datetime->format( $format ) ), strtotime( $current_time ), 'The dates should be equal', 2 );
+	}
+
+	/**
+	 * @ticket 40653
+	 */
+	public function test_should_return_wp_timestamp() {
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
+		$timestamp = time();
+		$datetime  = new DateTime( '@' . $timestamp );
+		$datetime->setTimezone( wp_timezone() );
+		$wp_timestamp = $timestamp + $datetime->getOffset();
+
+		$this->assertEquals( $timestamp, current_time( 'timestamp', true ), 'The dates should be equal', 2 );
+		$this->assertEquals( $timestamp, current_time( 'U', true ), 'The dates should be equal', 2 );
+
+		$this->assertEquals( $wp_timestamp, current_time( 'timestamp' ), 'The dates should be equal', 2 );
+		$this->assertEquals( $wp_timestamp, current_time( 'U' ), 'The dates should be equal', 2 );
+
+		$this->assertInternalType( 'int', current_time( 'timestamp' ) );
+	}
+
+	/**
+	 * @ticket 40653
+	 */
+	public function test_should_return_correct_local_time() {
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
+		$timestamp      = time();
+		$datetime_local = new DateTime( '@' . $timestamp );
+		$datetime_local->setTimezone( wp_timezone() );
+		$datetime_utc = new DateTime( '@' . $timestamp );
+		$datetime_utc->setTimezone( new DateTimeZone( 'UTC' ) );
+
+		$this->assertEquals( strtotime( $datetime_local->format( DATE_W3C ) ), strtotime( current_time( DATE_W3C ) ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( $datetime_utc->format( DATE_W3C ) ), strtotime( current_time( DATE_W3C, true ) ), 'The dates should be equal', 2 );
 	}
 }
diff --git a/tests/date/dateI18n.php b/tests/date/dateI18n.php
index 408a4ce447..84c43efc4c 100644
--- a/tests/date/dateI18n.php
+++ b/tests/date/dateI18n.php
@@ -5,8 +5,40 @@
  * @group datetime
  */
 class Tests_Date_I18n extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 28636
+	 */
+	public function test_should_return_current_time_on_invalid_timestamp() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+
+		$datetime     = new DateTime( 'now', new DateTimeZone( $timezone ) );
+		$wp_timestamp = $datetime->getTimestamp() + $datetime->getOffset();
+
+		$this->assertEquals( $wp_timestamp, date_i18n( 'U', 'invalid' ), '', 5 );
+	}
+
+	/**
+	 * @ticket 28636
+	 */
+	public function test_should_handle_zero_timestamp() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+
+		$datetime = DateTimeImmutable::createFromFormat(
+			'Y-m-d H:i:s',
+			'1970-01-01 00:00:00',
+			new DateTimeZone( $timezone )
+		);
+		$rfc3339  = $datetime->format( DATE_RFC3339 );
+
+		$this->assertEquals( 0, date_i18n( 'U', 0 ) );
+		$this->assertEquals( $rfc3339, date_i18n( DATE_RFC3339, 0 ) );
+	}
+
 	public function test_should_format_date() {
-		$this->assertEquals( strtotime( date( 'Y-m-d H:i:s' ) ), strtotime( date_i18n( 'Y-m-d H:i:s' ) ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( date_i18n( 'Y-m-d H:i:s' ) ), 'The dates should be equal', 2 );
 	}
 
 	public function test_should_use_custom_timestamp() {
@@ -14,23 +46,19 @@ class Tests_Date_I18n extends WP_UnitTestCase {
 	}
 
 	public function test_date_should_be_in_gmt() {
-		$this->assertEquals( strtotime( date( DATE_RFC3339 ) ), strtotime( date_i18n( DATE_RFC3339, false, true ) ), 'The dates should be equal', 2 );
-	}
-
-	public function test_custom_timestamp_ignores_gmt_setting() {
-		$this->assertEquals( '2012-12-01 00:00:00', date_i18n( 'Y-m-d H:i:s', strtotime( '2012-12-01 00:00:00' ) ) );
+		$this->assertEquals( strtotime( gmdate( DATE_RFC3339 ) ), strtotime( date_i18n( DATE_RFC3339, false, true ) ), 'The dates should be equal', 2 );
 	}
 
 	public function test_custom_timezone_setting() {
 		update_option( 'timezone_string', 'America/Regina' );
 
-		$this->assertEquals( strtotime( date( 'Y-m-d H:i:s', time() + get_option( 'gmt_offset' ) * HOUR_IN_SECONDS ) ), strtotime( date_i18n( 'Y-m-d H:i:s' ) ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( gmdate( 'Y-m-d H:i:s', time() + get_option( 'gmt_offset' ) * HOUR_IN_SECONDS ) ), strtotime( date_i18n( 'Y-m-d H:i:s' ) ), 'The dates should be equal', 2 );
 	}
 
 	public function test_date_should_be_in_gmt_with_custom_timezone_setting() {
 		update_option( 'timezone_string', 'America/Regina' );
 
-		$this->assertEquals( strtotime( date( DATE_RFC3339 ) ), strtotime( date_i18n( DATE_RFC3339, false, true ) ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( gmdate( DATE_RFC3339 ) ), strtotime( date_i18n( DATE_RFC3339, false, true ) ), 'The dates should be equal', 2 );
 	}
 
 	public function test_date_should_be_in_gmt_with_custom_timezone_setting_and_timestamp() {
@@ -78,6 +106,7 @@ class Tests_Date_I18n extends WP_UnitTestCase {
 		update_option( 'timezone_string', '' );
 		$offset = $datetimezone->getOffset( new DateTime() ) / 3600;
 		update_option( 'gmt_offset', $offset );
+
 		$datetime = new DateTime( 'now', $datetimezone );
 		$datetime = new DateTime( $datetime->format( 'P' ) );
 
@@ -85,8 +114,9 @@ class Tests_Date_I18n extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_formats
 	 * @ticket 20973
+	 *
+	 * @dataProvider data_formats
 	 */
 	public function test_date_i18n_handles_shorthand_formats( $short, $full ) {
 		update_option( 'timezone_string', 'America/Regina' );
@@ -107,4 +137,65 @@ class Tests_Date_I18n extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	/**
+	 * @ticket 25768
+	 */
+	public function test_should_return_wp_timestamp() {
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
+		$datetime     = new DateTimeImmutable( 'now', wp_timezone() );
+		$timestamp    = $datetime->getTimestamp();
+		$wp_timestamp = $timestamp + $datetime->getOffset();
+
+		$this->assertEquals( $wp_timestamp, date_i18n( 'U' ), 'The dates should be equal', 2 );
+		$this->assertEquals( $timestamp, date_i18n( 'U', false, true ), 'The dates should be equal', 2 );
+		$this->assertEquals( $wp_timestamp, date_i18n( 'U', $wp_timestamp ) );
+	}
+
+	/**
+	 * @ticket 43530
+	 */
+	public function test_swatch_internet_time_with_wp_timestamp() {
+		update_option( 'timezone_string', 'America/Regina' );
+
+		$this->assertEquals( gmdate( 'B' ), date_i18n( 'B' ) );
+	}
+
+	/**
+	 * @ticket 25768
+	 */
+	public function test_should_handle_escaped_formats() {
+		$format = 'D | \D | \\D | \\\D | \\\\D | \\\\\D | \\\\\\D';
+
+		$this->assertEquals( gmdate( $format ), date_i18n( $format ) );
+	}
+
+	/**
+	 * @ticket 25768
+	 *
+	 * @dataProvider dst_times
+	 *
+	 * @param string $time     Time to test in Y-m-d H:i:s format.
+	 * @param string $timezone PHP timezone string to use.
+	 */
+	public function test_should_handle_dst( $time, $timezone ) {
+		update_option( 'timezone_string', $timezone );
+
+		$timezone     = new DateTimeZone( $timezone );
+		$datetime     = new DateTime( $time, $timezone );
+		$wp_timestamp = strtotime( $time );
+		$format       = 'I ' . DATE_RFC3339;
+
+		$this->assertEquals( $datetime->format( $format ), date_i18n( $format, $wp_timestamp ) );
+	}
+
+	public function dst_times() {
+		return array(
+			'Before DST start' => array( '2019-03-31 02:59:00', 'Europe/Kiev' ),
+			'After DST start'  => array( '2019-03-31 04:01:00', 'Europe/Kiev' ),
+			'Before DST end'   => array( '2019-10-27 02:59:00', 'Europe/Kiev' ),
+			'After DST end'    => array( '2019-10-27 04:01:00', 'Europe/Kiev' ),
+		);
+	}
 }
diff --git a/tests/date/mysql2date.php b/tests/date/mysql2date.php
new file mode 100644
index 0000000000..3b73771827
--- /dev/null
+++ b/tests/date/mysql2date.php
@@ -0,0 +1,71 @@
+<?php
+
+/**
+ * @group date
+ * @group datetime
+ */
+class Tests_Date_mysql2date extends WP_UnitTestCase {
+
+	function tearDown() {
+		date_default_timezone_set( 'UTC' );
+
+		parent::tearDown();
+	}
+
+	/**
+	 * @ticket 28992
+	 */
+	function test_mysql2date_should_format_time() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+		$datetime = new DateTime( 'now', new DateTimeZone( $timezone ) );
+		$rfc3339  = $datetime->format( DATE_RFC3339 );
+		$mysql    = $datetime->format( 'Y-m-d H:i:s' );
+
+		$this->assertEquals( $rfc3339, mysql2date( DATE_RFC3339, $mysql ) );
+		$this->assertEquals( $rfc3339, mysql2date( DATE_RFC3339, $mysql, false ) );
+	}
+
+	/**
+	 * @ticket 28992
+	 */
+	function test_mysql2date_should_format_time_with_changed_time_zone() {
+		$timezone = 'Europe/Kiev';
+		date_default_timezone_set( $timezone );
+		update_option( 'timezone_string', $timezone );
+		$datetime = new DateTime( 'now', new DateTimeZone( $timezone ) );
+		$rfc3339  = $datetime->format( DATE_RFC3339 );
+		$mysql    = $datetime->format( 'Y-m-d H:i:s' );
+
+		$this->assertEquals( $rfc3339, mysql2date( DATE_RFC3339, $mysql ) );
+		$this->assertEquals( $rfc3339, mysql2date( DATE_RFC3339, $mysql, false ) );
+	}
+
+	/**
+	 * @ticket 28992
+	 */
+	function test_mysql2date_should_return_wp_timestamp() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+		$datetime     = new DateTime( 'now', new DateTimeZone( $timezone ) );
+		$wp_timestamp = $datetime->getTimestamp() + $datetime->getOffset();
+		$mysql        = $datetime->format( 'Y-m-d H:i:s' );
+
+		$this->assertEquals( $wp_timestamp, mysql2date( 'U', $mysql, false ) );
+		$this->assertEquals( $wp_timestamp, mysql2date( 'G', $mysql, false ) );
+	}
+
+	/**
+	 * @ticket 28992
+	 */
+	function test_mysql2date_should_return_unix_timestamp_for_gmt_time() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+		$datetime  = new DateTime( 'now', new DateTimeZone( 'UTC' ) );
+		$timestamp = $datetime->getTimestamp();
+		$mysql     = $datetime->format( 'Y-m-d H:i:s' );
+
+		$this->assertEquals( $timestamp, mysql2date( 'U', $mysql, false ) );
+		$this->assertEquals( $timestamp, mysql2date( 'G', $mysql, false ) );
+	}
+}
diff --git a/tests/date/postTime.php b/tests/date/postTime.php
new file mode 100644
index 0000000000..1380c48160
--- /dev/null
+++ b/tests/date/postTime.php
@@ -0,0 +1,88 @@
+<?php
+
+/**
+ * @group date
+ * @group datetime
+ */
+class Tests_Date_Post_Time extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 25002
+	 */
+	public function test_should_return_wp_timestamp() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+
+		$datetime     = new DateTimeImmutable( 'now', new DateTimeZone( $timezone ) );
+		$mysql        = $datetime->format( 'Y-m-d H:i:s' );
+		$timestamp    = $datetime->getTimestamp();
+		$wp_timestamp = $datetime->getTimestamp() + $datetime->getOffset();
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_date'     => $mysql,
+				'post_modified' => $mysql,
+			)
+		);
+
+		$this->assertEquals( $wp_timestamp, get_post_time( 'U', false, $post_id ) );
+		$this->assertEquals( $wp_timestamp, get_post_time( 'G', false, $post_id ) );
+		$this->assertEquals( $timestamp, get_post_time( 'U', true, $post_id ) );
+		$this->assertEquals( $timestamp, get_post_time( 'G', true, $post_id ) );
+		$this->assertEquals( $wp_timestamp, get_post_modified_time( 'U', false, $post_id ) );
+		$this->assertEquals( $wp_timestamp, get_post_modified_time( 'G', false, $post_id ) );
+		$this->assertEquals( $timestamp, get_post_modified_time( 'U', true, $post_id ) );
+		$this->assertEquals( $timestamp, get_post_modified_time( 'G', true, $post_id ) );
+	}
+
+	/**
+	 * @ticket 25002
+	 */
+	public function test_should_return_time() {
+		$timezone = 'Europe/Kiev';
+		update_option( 'timezone_string', $timezone );
+
+		$datetime    = new DateTimeImmutable( 'now', new DateTimeZone( $timezone ) );
+		$mysql       = $datetime->format( 'Y-m-d H:i:s' );
+		$rfc3339     = $datetime->format( DATE_RFC3339 );
+		$rfc3339_utc = $datetime->setTimezone( new DateTimeZone( 'UTC' ) )->format( DATE_RFC3339 );
+		$post_id     = self::factory()->post->create(
+			array(
+				'post_date'     => $mysql,
+				'post_modified' => $mysql,
+			)
+		);
+
+		$this->assertEquals( $rfc3339, get_post_time( DATE_RFC3339, false, $post_id ) );
+		$this->assertEquals( $rfc3339_utc, get_post_time( DATE_RFC3339, true, $post_id ) );
+		$this->assertEquals( $rfc3339, get_post_time( DATE_RFC3339, false, $post_id, true ) );
+		$this->assertEquals( $rfc3339_utc, get_post_time( DATE_RFC3339, true, $post_id, true ) );
+		$this->assertEquals( $rfc3339, get_post_modified_time( DATE_RFC3339, false, $post_id ) );
+		$this->assertEquals( $rfc3339_utc, get_post_modified_time( DATE_RFC3339, true, $post_id ) );
+		$this->assertEquals( $rfc3339, get_post_modified_time( DATE_RFC3339, false, $post_id, true ) );
+		$this->assertEquals( $rfc3339_utc, get_post_modified_time( DATE_RFC3339, true, $post_id, true ) );
+	}
+
+	/**
+	 * @ticket 48384
+	 */
+	public function test_should_keep_utc_time_on_timezone_change() {
+		$timezone = 'UTC';
+		update_option( 'timezone_string', $timezone );
+
+		$datetime = new DateTimeImmutable( 'now', new DateTimeZone( $timezone ) );
+		$mysql    = $datetime->format( 'Y-m-d H:i:s' );
+		$rfc3339  = $datetime->format( DATE_RFC3339 );
+		$post_id  = self::factory()->post->create(
+			array(
+				'post_date'     => $mysql,
+				'post_modified' => $mysql,
+			)
+		);
+
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
+		$this->assertEquals( $rfc3339, get_post_time( DATE_RFC3339, true, $post_id ) );
+		$this->assertEquals( $rfc3339, get_post_modified_time( DATE_RFC3339, true, $post_id ) );
+	}
+}
diff --git a/tests/date/query.php b/tests/date/query.php
index 3afc4850d5..acf4e5bf7d 100644
--- a/tests/date/query.php
+++ b/tests/date/query.php
@@ -509,40 +509,81 @@ class Tests_WP_Date_Query extends WP_UnitTestCase {
 		$this->assertSame( $expected, $found );
 	}
 
-	public function test_build_mysql_datetime_default_to_max_true() {
+	/**
+	 * @ticket 41782
+	 *
+	 * @dataProvider mysql_datetime_input_provider
+	 *
+	 * @param array|string $datetime       Array or string date input.
+	 * @param string       $expected       Expected built result.
+	 * @param bool         $default_to_max Flag to default missing values to max.
+	 */
+	public function test_build_mysql_datetime( $datetime, $expected, $default_to_max = false ) {
 		$q = new WP_Date_Query( array() );
 
-		$found = $q->build_mysql_datetime(
-			array(
-				'year' => 2011,
-			),
-			true
+		$found = $q->build_mysql_datetime( $datetime, $default_to_max );
+
+		$message = "Expected {$expected}, got {$found}";
+		$this->assertEquals( strtotime( $expected ), strtotime( $found ), $message, 10 );
+	}
+
+	public function mysql_datetime_input_provider() {
+		return array(
+			array( '2019-06-04T08:18:24+03:00', '2019-06-04 05:18:24' ),
+			array( '2019-06-04T05:18:24+00:00', '2019-06-04 05:18:24' ),
+			array( array(), current_time( 'Y' ) . '-01-01 00:00:00' ),
+			array( array( 'year' => 2011 ), '2011-12-31 23:59:59', true ),
+			array( array( 'year' => 2011 ), '2011-01-01 00:00:00' ),
+			array( '2011', '2011-01-01 00:00:00' ),
+			array( '2011-02', '2011-02-01 00:00:00' ),
+			array( '2011-02-03', '2011-02-03 00:00:00' ),
+			array( '2011-02-03 13:30', '2011-02-03 13:30:00' ),
+			array( '2011-02-03 13:30:35', '2011-02-03 13:30:35' ),
 		);
-		$this->assertSame( '2011-12-31 23:59:59', $found );
 	}
 
-	public function test_build_mysql_datetime_default_to_max_false() {
+	/**
+	 * @ticket 41782
+	 *
+	 * @dataProvider mysql_datetime_input_provider_custom_timezone
+	 *
+	 * @param array|string $datetime       Array or string date input.
+	 * @param string       $expected       Expected built result.
+	 * @param bool         $default_to_max Flag to default missing values to max.
+	 */
+	public function test_build_mysql_datetime_with_custom_timezone( $datetime, $expected, $default_to_max = false ) {
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
 		$q = new WP_Date_Query( array() );
 
-		$found = $q->build_mysql_datetime(
-			array(
-				'year' => 2011,
-			),
-			false
+		$found = $q->build_mysql_datetime( $datetime, $default_to_max );
+
+		$message = "Expected {$expected}, got {$found}";
+		$this->assertEquals( strtotime( $expected ), strtotime( $found ), $message, 10 );
+
+	}
+
+	public function mysql_datetime_input_provider_custom_timezone() {
+		return array(
+			array( '2019-06-04T08:18:24+03:00', '2019-06-04 08:18:24' ),
+			array( '2019-06-04T05:18:24+00:00', '2019-06-04 08:18:24' ),
 		);
-		$this->assertSame( '2011-01-01 00:00:00', $found );
 	}
 
-	public function test_build_mysql_datetime_default_to_max_default_to_false() {
+	/**
+	 * @ticket 41782
+	 */
+	public function test_build_mysql_datetime_with_relative_date() {
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
 		$q = new WP_Date_Query( array() );
 
-		$found = $q->build_mysql_datetime(
-			array(
-				'year' => 2011,
-			),
-			false
-		);
-		$this->assertSame( '2011-01-01 00:00:00', $found );
+		$yesterday = new DateTimeImmutable( '-1 day', wp_timezone() );
+		$expected  = $yesterday->format( 'Y-m-d H:i:s' );
+		$found     = $q->build_mysql_datetime( '-1 day' );
+
+		$message = "Expected {$expected}, got {$found}";
+		$this->assertEquals( strtotime( $expected ), strtotime( $found ), $message, 10 );
 	}
 
 	public function test_build_time_query_insufficient_time_values() {
@@ -1014,7 +1055,7 @@ class Tests_WP_Date_Query extends WP_UnitTestCase {
 		// Invalid values.
 		$days_of_year = array( -1, 0, 367 );
 		foreach ( $days_of_year as $day_of_year ) {
-			$this->assertFalse( @$this->q->validate_date_values( array( 'dayofyear' => $day_of_year ) ) );
+			$this->assertFalse( $this->q->validate_date_values( array( 'dayofyear' => $day_of_year ) ) );
 		}
 	}
 
diff --git a/tests/date/theDate.php b/tests/date/theDate.php
index 54fecdffb6..2542240d6b 100644
--- a/tests/date/theDate.php
+++ b/tests/date/theDate.php
@@ -4,7 +4,7 @@
  * @group date
  * @group datetime
  */
-class Tests_Date_TheDate extends WP_UnitTestCase {
+class Tests_Date_The_Date extends WP_UnitTestCase {
 
 	/** @var array $hooks_called Count of hooks called. */
 	protected $hooks_called = array(
@@ -81,4 +81,72 @@ class Tests_Date_TheDate extends WP_UnitTestCase {
 
 		return $input;
 	}
+
+	/**
+	 * @ticket 33750
+	 */
+	function test_the_date() {
+		ob_start();
+		the_date();
+		$actual = ob_get_clean();
+		$this->assertEquals( '', $actual );
+
+		$GLOBALS['post'] = self::factory()->post->create_and_get(
+			array(
+				'post_date' => '2015-09-16 08:00:00',
+			)
+		);
+
+		ob_start();
+		$GLOBALS['currentday']  = '18.09.15';
+		$GLOBALS['previousday'] = '17.09.15';
+		the_date();
+		$this->assertEquals( 'September 16, 2015', ob_get_clean() );
+
+		ob_start();
+		$GLOBALS['currentday']  = '18.09.15';
+		$GLOBALS['previousday'] = '17.09.15';
+		the_date( 'Y' );
+		$this->assertEquals( '2015', ob_get_clean() );
+
+		ob_start();
+		$GLOBALS['currentday']  = '18.09.15';
+		$GLOBALS['previousday'] = '17.09.15';
+		the_date( 'Y', 'before ', ' after' );
+		$this->assertEquals( 'before 2015 after', ob_get_clean() );
+
+		ob_start();
+		$GLOBALS['currentday']  = '18.09.15';
+		$GLOBALS['previousday'] = '17.09.15';
+		the_date( 'Y', 'before ', ' after', false );
+		$this->assertEquals( '', ob_get_clean() );
+	}
+
+	/**
+	 * @ticket 47354
+	 */
+	function test_the_weekday_date() {
+		ob_start();
+		the_weekday_date();
+		$actual = ob_get_clean();
+		$this->assertEquals( '', $actual );
+
+		$GLOBALS['post'] = self::factory()->post->create_and_get(
+			array(
+				'post_date' => '2015-09-16 08:00:00',
+			)
+		);
+
+		ob_start();
+		$GLOBALS['currentday']      = '18.09.15';
+		$GLOBALS['previousweekday'] = '17.09.15';
+		the_weekday_date();
+		$this->assertEquals( 'Wednesday', ob_get_clean() );
+
+		ob_start();
+		$GLOBALS['currentday']      = '18.09.15';
+		$GLOBALS['previousweekday'] = '17.09.15';
+		the_weekday_date( 'before ', ' after' );
+		$this->assertEquals( 'before Wednesday after', ob_get_clean() );
+	}
 }
diff --git a/tests/date/wpDate.php b/tests/date/wpDate.php
new file mode 100644
index 0000000000..01145c82c4
--- /dev/null
+++ b/tests/date/wpDate.php
@@ -0,0 +1,63 @@
+<?php
+
+/**
+ * @group date
+ * @group datetime
+ */
+class Tests_Date_WP_Date extends WP_UnitTestCase {
+
+	/** @var WP_Locale */
+	private $wp_locale_original;
+
+	public function setUp() {
+		global $wp_locale;
+
+		parent::setUp();
+
+		$this->wp_locale_original = clone $wp_locale;
+	}
+
+	public function tearDown() {
+		global $wp_locale;
+
+		$wp_locale = $this->wp_locale_original;
+
+		parent::tearDown();
+	}
+
+	/**
+	 * @ticket 28636
+	 */
+	public function test_should_return_false_on_invalid_timestamp() {
+		$this->assertFalse( wp_date( DATE_RFC3339, 'invalid' ) );
+	}
+
+	/**
+	 * @ticket 48319
+	 */
+	public function test_should_not_escape_localized_numbers() {
+		global $wp_locale;
+
+		$wp_locale->month = array( 10 => '10' );
+
+		$utc      = new DateTimeZone( 'UTC' );
+		$datetime = new DateTimeImmutable( '2019-10-17', $utc );
+
+		$this->assertEquals( '10', wp_date( 'F', $datetime->getTimestamp(), $utc ) );
+	}
+
+	/**
+	 * @ticket 48319
+	 */
+	public function test_should_keep_localized_slashes() {
+		global $wp_locale;
+
+		$string           = 'A \ B';
+		$wp_locale->month = array( 10 => $string );
+
+		$utc      = new DateTimeZone( 'UTC' );
+		$datetime = new DateTimeImmutable( '2019-10-17', $utc );
+
+		$this->assertEquals( $string, wp_date( 'F', $datetime->getTimestamp(), $utc ) );
+	}
+}
diff --git a/tests/date/wpTimezone.php b/tests/date/wpTimezone.php
new file mode 100644
index 0000000000..359ab1244f
--- /dev/null
+++ b/tests/date/wpTimezone.php
@@ -0,0 +1,108 @@
+<?php
+
+/**
+ * @group date
+ * @group datetime
+ */
+class Tests_Date_WP_Timezone extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 24730
+	 *
+	 * @dataProvider timezone_offset_provider
+	 *
+	 * @param float  $gmt_offset Numeric offset from UTC.
+	 * @param string $tz_name    Expected timezone name.
+	 */
+	public function test_should_convert_gmt_offset( $gmt_offset, $tz_name ) {
+		delete_option( 'timezone_string' );
+		update_option( 'gmt_offset', $gmt_offset );
+
+		$this->assertEquals( $tz_name, wp_timezone_string() );
+
+		$timezone = wp_timezone();
+
+		$this->assertEquals( $tz_name, $timezone->getName() );
+	}
+
+	/**
+	 * @ticket 24730
+	 */
+	public function test_should_return_timezone_string() {
+		update_option( 'timezone_string', 'Europe/Kiev' );
+
+		$this->assertEquals( 'Europe/Kiev', wp_timezone_string() );
+
+		$timezone = wp_timezone();
+
+		$this->assertEquals( 'Europe/Kiev', $timezone->getName() );
+	}
+
+	/**
+	 * Data provider to test numeric offset conversion.
+	 *
+	 * @return array
+	 */
+	public function timezone_offset_provider() {
+		return array(
+			array( -12, '-12:00' ),
+			array( -11.5, '-11:30' ),
+			array( -11, '-11:00' ),
+			array( -10.5, '-10:30' ),
+			array( -10, '-10:00' ),
+			array( -9.5, '-09:30' ),
+			array( -9, '-09:00' ),
+			array( -8.5, '-08:30' ),
+			array( -8, '-08:00' ),
+			array( -7.5, '-07:30' ),
+			array( -7, '-07:00' ),
+			array( -6.5, '-06:30' ),
+			array( -6, '-06:00' ),
+			array( -5.5, '-05:30' ),
+			array( -5, '-05:00' ),
+			array( -4.5, '-04:30' ),
+			array( -4, '-04:00' ),
+			array( -3.5, '-03:30' ),
+			array( -3, '-03:00' ),
+			array( -2.5, '-02:30' ),
+			array( -2, '-02:00' ),
+			array( '-1.5', '-01:30' ),
+			array( -1.5, '-01:30' ),
+			array( -1, '-01:00' ),
+			array( -0.5, '-00:30' ),
+			array( 0, '+00:00' ),
+			array( '0', '+00:00' ),
+			array( 0.5, '+00:30' ),
+			array( 1, '+01:00' ),
+			array( 1.5, '+01:30' ),
+			array( '1.5', '+01:30' ),
+			array( 2, '+02:00' ),
+			array( 2.5, '+02:30' ),
+			array( 3, '+03:00' ),
+			array( 3.5, '+03:30' ),
+			array( 4, '+04:00' ),
+			array( 4.5, '+04:30' ),
+			array( 5, '+05:00' ),
+			array( 5.5, '+05:30' ),
+			array( 5.75, '+05:45' ),
+			array( 6, '+06:00' ),
+			array( 6.5, '+06:30' ),
+			array( 7, '+07:00' ),
+			array( 7.5, '+07:30' ),
+			array( 8, '+08:00' ),
+			array( 8.5, '+08:30' ),
+			array( 8.75, '+08:45' ),
+			array( 9, '+09:00' ),
+			array( 9.5, '+09:30' ),
+			array( 10, '+10:00' ),
+			array( 10.5, '+10:30' ),
+			array( 11, '+11:00' ),
+			array( 11.5, '+11:30' ),
+			array( 12, '+12:00' ),
+			array( 12.75, '+12:45' ),
+			array( 13, '+13:00' ),
+			array( 13.75, '+13:45' ),
+			array( 14, '+14:00' ),
+		);
+	}
+}
diff --git a/tests/db.php b/tests/db.php
index dbe70b8a6e..842246528d 100644
--- a/tests/db.php
+++ b/tests/db.php
@@ -23,7 +23,7 @@ class Tests_DB extends WP_UnitTestCase {
 
 	public static function setUpBeforeClass() {
 		parent::setUpBeforeClass();
-		self::$_wpdb = new wpdb_exposed_methods_for_testing();
+		self::$_wpdb = new WpdbExposedMethodsForTesting();
 	}
 
 	/**
@@ -346,7 +346,7 @@ class Tests_DB extends WP_UnitTestCase {
 	}
 
 	public function filter_allowed_incompatible_sql_mode( $modes ) {
-		$pos = array_search( 'ONLY_FULL_GROUP_BY', $modes );
+		$pos = array_search( 'ONLY_FULL_GROUP_BY', $modes, true );
 		$this->assertGreaterThanOrEqual( 0, $pos );
 
 		if ( false === $pos ) {
@@ -365,6 +365,7 @@ class Tests_DB extends WP_UnitTestCase {
 		global $wpdb;
 		$id = 0;
 		// This, obviously, is an incorrect prepare.
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$prepared = $wpdb->prepare( "SELECT * FROM $wpdb->users WHERE id = $id", $id );
 		$this->assertEquals( "SELECT * FROM $wpdb->users WHERE id = 0", $prepared );
 	}
@@ -382,9 +383,11 @@ class Tests_DB extends WP_UnitTestCase {
 	function test_prepare_sprintf_invalid_args() {
 		global $wpdb;
 
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 		$prepared = @$wpdb->prepare( "SELECT * FROM $wpdb->users WHERE id = %d AND user_login = %s", 1, array( 'admin' ) );
 		$this->assertEquals( "SELECT * FROM $wpdb->users WHERE id = 1 AND user_login = ''", $prepared );
 
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 		$prepared = @$wpdb->prepare( "SELECT * FROM $wpdb->users WHERE id = %d AND user_login = %s", array( 1 ), 'admin' );
 		$this->assertEquals( "SELECT * FROM $wpdb->users WHERE id = 0 AND user_login = 'admin'", $prepared );
 	}
@@ -402,9 +405,11 @@ class Tests_DB extends WP_UnitTestCase {
 	function test_prepare_vsprintf_invalid_args() {
 		global $wpdb;
 
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 		$prepared = @$wpdb->prepare( "SELECT * FROM $wpdb->users WHERE id = %d AND user_login = %s", array( 1, array( 'admin' ) ) );
 		$this->assertEquals( "SELECT * FROM $wpdb->users WHERE id = 1 AND user_login = ''", $prepared );
 
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 		$prepared = @$wpdb->prepare( "SELECT * FROM $wpdb->users WHERE id = %d AND user_login = %s", array( array( 1 ), 'admin' ) );
 		$this->assertEquals( "SELECT * FROM $wpdb->users WHERE id = 0 AND user_login = 'admin'", $prepared );
 	}
@@ -417,10 +422,8 @@ class Tests_DB extends WP_UnitTestCase {
 	public function test_prepare_incorrect_arg_count( $query, $args, $expected ) {
 		global $wpdb;
 
-		// $query is the first argument to be passed to wpdb::prepare()
-		array_unshift( $args, $query );
-
-		$prepared = @call_user_func_array( array( $wpdb, 'prepare' ), $args );
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged,WordPress.DB.PreparedSQL
+		$prepared = @$wpdb->prepare( $query, ...$args );
 		$this->assertEquals( $expected, $prepared );
 	}
 
@@ -587,6 +590,7 @@ class Tests_DB extends WP_UnitTestCase {
 
 		$wpdb->last_result = $last_result;
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$result = $wpdb->get_col( $query, $column );
 
 		if ( $query ) {
@@ -1043,7 +1047,7 @@ class Tests_DB extends WP_UnitTestCase {
 			$expected_charset = $wpdb->get_col_charset( $wpdb->posts, 'post_content' );
 		}
 
-		if ( ! in_array( $expected_charset, array( 'utf8', 'utf8mb4', 'latin1' ) ) ) {
+		if ( ! in_array( $expected_charset, array( 'utf8', 'utf8mb4', 'latin1' ), true ) ) {
 			$this->markTestSkipped( 'This test only works with utf8, utf8mb4 or latin1 character sets' );
 		}
 
@@ -1116,7 +1120,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertNull( $row->meta_value );
 	}
@@ -1139,7 +1143,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertSame( $value, $row->meta_value );
 
@@ -1154,7 +1158,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertNull( $row->meta_value );
 	}
@@ -1177,7 +1181,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertNull( $row->meta_value );
 
@@ -1192,7 +1196,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertSame( $value, $row->meta_value );
 	}
@@ -1215,7 +1219,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertNull( $row->meta_value );
 
@@ -1228,7 +1232,7 @@ class Tests_DB extends WP_UnitTestCase {
 			array( '%s', '%s' )
 		);
 
-		$row = $wpdb->get_row( "SELECT * FROM $wpdb->postmeta WHERE meta_key='$key'" );
+		$row = $wpdb->get_row( $wpdb->prepare( "SELECT * FROM $wpdb->postmeta WHERE meta_key=%s", $key ) );
 
 		$this->assertNull( $row );
 	}
@@ -1359,9 +1363,8 @@ class Tests_DB extends WP_UnitTestCase {
 			$values = array( $values );
 		}
 
-		array_unshift( $values, $sql );
-
-		$sql = call_user_func_array( array( $wpdb, 'prepare' ), $values );
+		// phpcs:ignore WordPress.DB.PreparedSQL
+		$sql = $wpdb->prepare( $sql, ...$values );
 		$this->assertEquals( $expected, $sql );
 	}
 
@@ -1379,7 +1382,8 @@ class Tests_DB extends WP_UnitTestCase {
 			$values = array( $values );
 		}
 
-		$sql = call_user_func_array( array( $wpdb, 'prepare' ), array( $sql, $values ) );
+		// phpcs:ignore WordPress.DB.PreparedSQL
+		$sql = $wpdb->prepare( $sql, $values );
 		$this->assertEquals( $expected, $sql );
 	}
 
@@ -1572,6 +1576,7 @@ class Tests_DB extends WP_UnitTestCase {
 
 		$sql = str_replace( '{ESCAPE}', $escape, $sql );
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$actual = $wpdb->prepare( $sql, $values );
 
 		$this->assertEquals( $expected, $actual );
@@ -1612,6 +1617,7 @@ class Tests_DB extends WP_UnitTestCase {
 
 		$part = $wpdb->prepare( ' AND meta_value = %s', ' %s ' );
 		$this->assertNotContains( '%s', $part );
+		// phpcs:ignore WordPress.DB.PreparedSQLPlaceholders.ReplacementsWrongNumber
 		$query = $wpdb->prepare( 'SELECT * FROM {$wpdb->postmeta} WHERE meta_key = %s $part', array( 'foo', 'bar' ) );
 		$this->assertNull( $query );
 	}
@@ -1620,6 +1626,7 @@ class Tests_DB extends WP_UnitTestCase {
 		global $wpdb;
 
 		$actual = $wpdb->prepare(
+			// phpcs:ignore WordPress.DB.PreparedSQLPlaceholders.UnquotedComplexPlaceholder
 			'WHERE second=%2$f AND first=%1$f',
 			1.1,
 			2.2
@@ -1634,6 +1641,7 @@ class Tests_DB extends WP_UnitTestCase {
 		global $wpdb;
 
 		$actual = $wpdb->prepare(
+			// phpcs:ignore WordPress.DB.PreparedSQLPlaceholders.UnquotedComplexPlaceholder
 			'WHERE second=%2$f AND first=%1$f',
 			array( 1.1, 2.2 )
 		);
@@ -1650,6 +1658,8 @@ class Tests_DB extends WP_UnitTestCase {
 
 		$wpdb->query( "CREATE TABLE {$wpdb->prefix}test_placeholder( a VARCHAR(100) );" );
 		$sql = $wpdb->prepare( "INSERT INTO {$wpdb->prefix}test_placeholder VALUES(%s)", $value );
+
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$wpdb->query( $sql );
 
 		$actual = $wpdb->get_var( "SELECT a FROM {$wpdb->prefix}test_placeholder" );
@@ -1664,6 +1674,7 @@ class Tests_DB extends WP_UnitTestCase {
 		global $wpdb;
 
 		$sql = $wpdb->prepare( ' %s %1$c ', 'foo' );
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$sql = $wpdb->prepare( " $sql %s ", 'foo' );
 
 		$this->assertEquals( "  'foo' {$wpdb->placeholder_escape()}1\$c  'foo' ", $sql );
diff --git a/tests/db/charset.php b/tests/db/charset.php
index e0f9df2c4b..dc7f7c3b8f 100644
--- a/tests/db/charset.php
+++ b/tests/db/charset.php
@@ -27,7 +27,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 
 		require_once( dirname( dirname( __FILE__ ) ) . '/db.php' );
 
-		self::$_wpdb = new wpdb_exposed_methods_for_testing();
+		self::$_wpdb = new WpdbExposedMethodsForTesting();
 
 		if ( self::$_wpdb->use_mysqli ) {
 			self::$server_info = mysqli_get_server_info( self::$_wpdb->dbh );
@@ -454,7 +454,9 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 		}
 
 		// The data above is easy to edit. Now, prepare it for the data provider.
-		$data_provider = $multiple = $multiple_expected = array();
+		$data_provider     = array();
+		$multiple          = array();
+		$multiple_expected = array();
 		foreach ( $fields as $test_case => $field ) {
 			$expected          = $field;
 			$expected['value'] = $expected['expected'];
@@ -480,10 +482,6 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	 * @ticket 21212
 	 */
 	function test_strip_invalid_text( $data, $expected, $message ) {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) && stristr( php_uname( 's' ), 'win' ) ) {
-			$this->markTestSkipped( 'This test fails in PHP 5.2 on Windows. See https://core.trac.wordpress.org/ticket/31262' );
-		}
-
 		$charset = self::$_wpdb->charset;
 		if ( isset( $data[0]['connection_charset'] ) ) {
 			$new_charset = $data[0]['connection_charset'];
@@ -582,7 +580,8 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 		$vars = get_defined_vars();
 		unset( $vars['charset'] );
 		foreach ( $vars as $var_name => $var ) {
-			$data = $expected = $var;
+			$data     = $var;
+			$expected = $var;
 			foreach ( $data as &$datum ) {
 				// 'charset' and 'ascii' are part of the expected return only.
 				unset( $datum['charset'], $datum['ascii'] );
diff --git a/tests/dbdelta.php b/tests/dbdelta.php
index 5b44094767..30d0867033 100644
--- a/tests/dbdelta.php
+++ b/tests/dbdelta.php
@@ -33,18 +33,22 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		// Forcing MyISAM, because InnoDB only started supporting FULLTEXT indexes in MySQL 5.7.
 		$wpdb->query(
-			"
-			CREATE TABLE {$wpdb->prefix}dbdelta_test (
-				id bigint(20) NOT NULL AUTO_INCREMENT,
-				column_1 varchar(255) NOT NULL,
-				column_2 text,
-				column_3 blob,
-				PRIMARY KEY  (id),
-				KEY key_1 (column_1($this->max_index_length)),
-				KEY compound_key (id,column_1($this->max_index_length)),
-				FULLTEXT KEY fulltext_key (column_1)
-			) ENGINE=MyISAM
-			"
+			$wpdb->prepare(
+				"
+				CREATE TABLE {$wpdb->prefix}dbdelta_test (
+					id bigint(20) NOT NULL AUTO_INCREMENT,
+					column_1 varchar(255) NOT NULL,
+					column_2 text,
+					column_3 blob,
+					PRIMARY KEY  (id),
+					KEY key_1 (column_1(%d)),
+					KEY compound_key (id,column_1(%d)),
+					FULLTEXT KEY fulltext_key (column_1)
+				) ENGINE=MyISAM
+				",
+				$this->max_index_length,
+				$this->max_index_length
+			)
 		);
 
 		parent::setUp();
@@ -299,6 +303,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 	protected function assertTableRowHasValue( $column, $value, $table ) {
 		global $wpdb;
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$table_row = $wpdb->get_row( "select $column from {$table} where $column = '$value'" );
 
 		$expected = (object) array(
@@ -317,7 +322,8 @@ class Tests_dbDelta extends WP_UnitTestCase {
 	protected function assertTableHasColumn( $column, $table ) {
 		global $wpdb;
 
-		$table_fields = $wpdb->get_results( "DESCRIBE {$table}" );
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+		$table_fields = $wpdb->get_results( "DESCRIBE $table" );
 
 		$this->assertCount( 1, wp_list_filter( $table_fields, array( 'Field' => $column ) ) );
 	}
@@ -333,7 +339,8 @@ class Tests_dbDelta extends WP_UnitTestCase {
 	protected function assertTableHasPrimaryKey( $column, $table ) {
 		global $wpdb;
 
-		$table_indices = $wpdb->get_results( "SHOW INDEX FROM {$table}" );
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+		$table_indices = $wpdb->get_results( "SHOW INDEX FROM $table" );
 
 		$this->assertCount(
 			1,
@@ -358,7 +365,8 @@ class Tests_dbDelta extends WP_UnitTestCase {
 
 		global $wpdb;
 
-		$table_fields = $wpdb->get_results( "DESCRIBE {$table}" );
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
+		$table_fields = $wpdb->get_results( "DESCRIBE $table" );
 
 		$this->assertCount( 0, wp_list_filter( $table_fields, array( 'Field' => $column ) ) );
 	}
@@ -385,15 +393,18 @@ class Tests_dbDelta extends WP_UnitTestCase {
 				KEY a_key (a)
 			) ENGINE=InnoDB ROW_FORMAT=DYNAMIC";
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$wpdb->query( $create );
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$index = $wpdb->get_row( "SHOW INDEXES FROM $table_name WHERE Key_name='a_key';" );
 
 		$actual = dbDelta( $create, false );
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 		$wpdb->query( "DROP TABLE IF EXISTS $table_name;" );
 
-		if ( 191 != $index->Sub_part ) {
+		if ( 191 !== $index->Sub_part ) {
 			$this->markTestSkipped( 'This test requires the index to be truncated.' );
 		}
 
@@ -527,6 +538,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 			)
 		";
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$wpdb->query( $schema );
 
 		$updates = dbDelta( $schema, false );
@@ -556,6 +568,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 			) ENGINE=MyISAM;
 			";
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$wpdb->query( $schema );
 
 		$updates = dbDelta( $schema, false );
@@ -602,6 +615,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 			)
 		";
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$wpdb->query( $schema );
 
 		$updates = dbDelta( $schema );
@@ -998,6 +1012,7 @@ class Tests_dbDelta extends WP_UnitTestCase {
 			)
 		";
 
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
 		$wpdb->query( $schema );
 
 		$schema_update = "
diff --git a/tests/dependencies/scripts.php b/tests/dependencies/scripts.php
index 1812919f2a..2b3b4538d8 100644
--- a/tests/dependencies/scripts.php
+++ b/tests/dependencies/scripts.php
@@ -44,6 +44,7 @@ JS;
 		wp_enqueue_script( 'empty-deps-no-version', 'example.com' );
 		wp_enqueue_script( 'empty-deps-version', 'example.com', array(), 1.2 );
 		wp_enqueue_script( 'empty-deps-null-version', 'example.com', array(), null );
+
 		$ver       = get_bloginfo( 'version' );
 		$expected  = "<script type='text/javascript' src='http://example.com?ver=$ver'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com?ver=$ver'></script>\n";
@@ -56,6 +57,23 @@ JS;
 		$this->assertEquals( '', get_echo( 'wp_print_scripts' ) );
 	}
 
+	/**
+	 * @ticket 42804
+	 */
+	function test_wp_enqueue_script_with_html5_support_does_not_contain_type_attribute() {
+		add_theme_support( 'html5', array( 'script' ) );
+
+		$GLOBALS['wp_scripts']                  = new WP_Scripts();
+		$GLOBALS['wp_scripts']->default_version = get_bloginfo( 'version' );
+
+		wp_enqueue_script( 'empty-deps-no-version', 'example.com' );
+
+		$ver      = get_bloginfo( 'version' );
+		$expected = "<script src='http://example.com?ver=$ver'></script>\n";
+
+		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+	}
+
 	/**
 	 * Test the different protocol references in wp_enqueue_script
 	 *
@@ -118,7 +136,7 @@ JS;
 		$print_scripts = get_echo( '_print_scripts' );
 
 		$ver      = get_bloginfo( 'version' );
-		$expected = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=one,two,three&amp;ver={$ver}'></script>\n";
+		$expected = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one,two,three&amp;ver={$ver}'></script>\n";
 
 		$this->assertEquals( $expected, $print_scripts );
 	}
@@ -562,7 +580,7 @@ JS;
 		wp_add_inline_script( 'three', 'console.log("after three");' );
 
 		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=one&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one&amp;ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript' src='/directory/two.js?ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"after two\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='/directory/three.js?ver={$ver}'></script>\n";
@@ -614,7 +632,7 @@ JS;
 		$wp_scripts->do_concat = true;
 
 		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"after\");\n</script>\n";
 
@@ -639,7 +657,7 @@ JS;
 		$wp_scripts->do_concat = true;
 
 		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
 		$expected .= "<!--[if gte IE 9]>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"after\");\n</script>\n";
@@ -662,12 +680,13 @@ JS;
 		global $wp_scripts;
 
 		wp_default_scripts( $wp_scripts );
+		wp_default_packages( $wp_scripts );
 
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
 		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com'></script>\n";
 
@@ -687,14 +706,21 @@ JS;
 		global $wp_scripts;
 
 		wp_default_scripts( $wp_scripts );
+		wp_default_packages( $wp_scripts );
 
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
 		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=jquery-core,jquery-migrate,wp-a11y&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=jquery-core,jquery-migrate&amp;ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"before\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='http://example.com'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/dist/vendor/wp-polyfill.min.js'></script>\n";
+		$expected .= "<script type='text/javascript'>\n";
+		$expected .= "( 'fetch' in window ) || document.write( '<script src=\"http://example.org/wp-includes/js/dist/vendor/wp-polyfill-fetch.min.js\"></scr' + 'ipt>' );( document.contains ) || document.write( '<script src=\"http://example.org/wp-includes/js/dist/vendor/wp-polyfill-node-contains.min.js\"></scr' + 'ipt>' );( window.FormData && window.FormData.prototype.keys ) || document.write( '<script src=\"http://example.org/wp-includes/js/dist/vendor/wp-polyfill-formdata.min.js\"></scr' + 'ipt>' );( Element.prototype.matches && Element.prototype.closest ) || document.write( '<script src=\"http://example.org/wp-includes/js/dist/vendor/wp-polyfill-element-closest.min.js\"></scr' + 'ipt>' );\n";
+		$expected .= "</script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/dist/dom-ready.min.js'></script>\n";
+		$expected .= "<script type='text/javascript' src='/wp-includes/js/dist/a11y.min.js'></script>\n";
 		$expected .= "<script type='text/javascript' src='http://example2.com'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"after\");\n</script>\n";
 
@@ -703,8 +729,20 @@ JS;
 		wp_enqueue_script( 'test-example2', 'http://example2.com', array( 'wp-a11y' ), null );
 		wp_add_inline_script( 'test-example2', 'console.log("after");', 'after' );
 
-		wp_print_scripts();
-		$print_scripts = get_echo( '_print_scripts' );
+		$print_scripts  = get_echo( 'wp_print_scripts' );
+		$print_scripts .= get_echo( '_print_scripts' );
+
+		/*
+		 * We've replaced wp-a11y.js with @wordpress/a11y package (see #45066),
+		 * and `wp-polyfill` is now a dependency of the packaged wp-a11y.
+		 * The packaged scripts contain various version numbers, which are not exposed,
+		 * so we will remove all version args from the output.
+		 */
+		$print_scripts = preg_replace(
+			'~js\?ver=([^"\']*)~', // Matches `js?ver=X.X.X` and everything to single or double quote.
+			'js',                  // The replacement, `js` without the version arg.
+			$print_scripts         // Printed scripts.
+		);
 
 		$this->assertEquals( $expected, $print_scripts );
 	}
@@ -716,12 +754,12 @@ JS;
 		global $wp_scripts;
 
 		wp_default_scripts( $wp_scripts );
+		wp_default_packages( $wp_scripts );
 
 		$wp_scripts->base_url  = '';
 		$wp_scripts->do_concat = true;
 
-		$expected_tail  = "<![endif]-->\n";
-		$expected_tail .= "<script type='text/javascript' src='/customize-dependency.js'></script>\n";
+		$expected_tail  = "<script type='text/javascript' src='/customize-dependency.js'></script>\n";
 		$expected_tail .= "<script type='text/javascript'>\n";
 		$expected_tail .= "tryCustomizeDependency()\n";
 		$expected_tail .= "</script>\n";
@@ -730,10 +768,10 @@ JS;
 		wp_enqueue_script( $handle, '/customize-dependency.js', array( 'customize-controls' ), null );
 		wp_add_inline_script( $handle, 'tryCustomizeDependency()' );
 
-		wp_print_scripts();
-		$print_scripts = get_echo( '_print_scripts' );
+		$print_scripts  = get_echo( 'wp_print_scripts' );
+		$print_scripts .= get_echo( '_print_scripts' );
 
-		$tail = substr( $print_scripts, strrpos( $print_scripts, '<![endif]-->' ) );
+		$tail = substr( $print_scripts, strrpos( $print_scripts, "<script type='text/javascript' src='/customize-dependency.js'>" ) );
 		$this->assertEquals( $expected_tail, $tail );
 	}
 
@@ -778,7 +816,7 @@ JS;
 		wp_enqueue_script( 'four', '/wp-includes/js/script4.js' );
 
 		$ver       = get_bloginfo( 'version' );
-		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5B%5D=one,two&amp;ver={$ver}'></script>\n";
+		$expected  = "<script type='text/javascript' src='/wp-admin/load-scripts.php?c=0&amp;load%5Bchunk_0%5D=one,two&amp;ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript'>\nconsole.log(\"before three\");\n</script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script3.js?ver={$ver}'></script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script4.js?ver={$ver}'></script>\n";
@@ -808,7 +846,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -833,7 +871,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-content/plugins/my-plugin/js/script.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -858,7 +896,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-content/themes/my-theme/js/script.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -883,7 +921,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-admin/js/script.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -923,7 +961,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-admin/js/script.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -950,7 +988,7 @@ JS;
 		);
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
@@ -978,7 +1016,7 @@ JS;
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script.js'></script>\n";
 		$expected .= "<script type='text/javascript' src='/wp-includes/js/script2.js'></script>\n";
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_scripts' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_scripts' ) );
 	}
 
 	/**
diff --git a/tests/dependencies/styles.php b/tests/dependencies/styles.php
index 30ed7799ce..174a8e48b6 100644
--- a/tests/dependencies/styles.php
+++ b/tests/dependencies/styles.php
@@ -56,6 +56,7 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 		wp_enqueue_style( 'no-deps-version', 'example.com', array(), 1.2 );
 		wp_enqueue_style( 'no-deps-null-version', 'example.com', array(), null );
 		wp_enqueue_style( 'no-deps-null-version-print-media', 'example.com', array(), null, 'print' );
+
 		$ver       = get_bloginfo( 'version' );
 		$expected  = "<link rel='stylesheet' id='no-deps-no-version-css'  href='http://example.com?ver=$ver' type='text/css' media='all' />\n";
 		$expected .= "<link rel='stylesheet' id='no-deps-version-css'  href='http://example.com?ver=1.2' type='text/css' media='all' />\n";
@@ -68,6 +69,23 @@ class Tests_Dependencies_Styles extends WP_UnitTestCase {
 		$this->assertEquals( '', get_echo( 'wp_print_styles' ) );
 	}
 
+	/**
+	 * @ticket 42804
+	 */
+	function test_wp_enqueue_style_with_html5_support_does_not_contain_type_attribute() {
+		add_theme_support( 'html5', array( 'style' ) );
+
+		$GLOBALS['wp_styles']                  = new WP_Styles();
+		$GLOBALS['wp_styles']->default_version = get_bloginfo( 'version' );
+
+		wp_enqueue_style( 'no-deps-no-version', 'example.com' );
+
+		$ver      = get_bloginfo( 'version' );
+		$expected = "<link rel='stylesheet' id='no-deps-no-version-css'  href='http://example.com?ver=$ver' media='all' />\n";
+
+		$this->assertEquals( $expected, get_echo( 'wp_print_styles' ) );
+	}
+
 	/**
 	 * Test the different protocol references in wp_enqueue_style
 	 *
@@ -254,7 +272,7 @@ CSS;
 		wp_style_add_data( 'handle', 'conditional', 'IE' );
 		wp_add_inline_style( 'handle', 'a { color: blue; }' );
 
-		$this->assertEquals( $expected, get_echo( 'wp_print_styles' ) );
+		$this->assertEqualsIgnoreEOL( $expected, get_echo( 'wp_print_styles' ) );
 	}
 
 	/**
diff --git a/tests/error-protection/recovery-mode-cookie-service.php b/tests/error-protection/recovery-mode-cookie-service.php
new file mode 100644
index 0000000000..78f9099758
--- /dev/null
+++ b/tests/error-protection/recovery-mode-cookie-service.php
@@ -0,0 +1,89 @@
+<?php
+
+/**
+ * @group error-protection
+ */
+class Tests_Recovery_Mode_Cookie_Service extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_cookie_returns_wp_error_if_invalid_format() {
+
+		$service = new WP_Recovery_Mode_Cookie_Service();
+
+		$error = $service->validate_cookie( 'gibbersih' );
+		$this->assertWPError( $error );
+		$this->assertEquals( 'invalid_format', $error->get_error_code() );
+
+		$error = $service->validate_cookie( base64_encode( 'test|data|format' ) );
+		$this->assertWPError( $error );
+		$this->assertEquals( 'invalid_format', $error->get_error_code() );
+
+		$error = $service->validate_cookie( base64_encode( 'test|data|format|to|long' ) );
+		$this->assertWPError( $error );
+		$this->assertEquals( 'invalid_format', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_cookie_returns_wp_error_if_expired() {
+		$service    = new WP_Recovery_Mode_Cookie_Service();
+		$reflection = new ReflectionMethod( $service, 'recovery_mode_hash' );
+		$reflection->setAccessible( true );
+
+		$to_sign = sprintf( 'recovery_mode|%s|%s', time() - WEEK_IN_SECONDS - 30, wp_generate_password( 20, false ) );
+		$signed  = $reflection->invoke( $service, $to_sign );
+		$cookie  = base64_encode( sprintf( '%s|%s', $to_sign, $signed ) );
+
+		$error = $service->validate_cookie( $cookie );
+		$this->assertWPError( $error );
+		$this->assertEquals( 'expired', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_cookie_returns_wp_error_if_signature_mismatch() {
+		$service    = new WP_Recovery_Mode_Cookie_Service();
+		$reflection = new ReflectionMethod( $service, 'generate_cookie' );
+		$reflection->setAccessible( true );
+
+		$cookie  = $reflection->invoke( $service );
+		$cookie .= 'gibbersih';
+
+		$error = $service->validate_cookie( $cookie );
+		$this->assertWPError( $error );
+		$this->assertEquals( 'signature_mismatch', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_cookie_returns_wp_error_if_created_at_is_invalid_format() {
+		$service    = new WP_Recovery_Mode_Cookie_Service();
+		$reflection = new ReflectionMethod( $service, 'recovery_mode_hash' );
+		$reflection->setAccessible( true );
+
+		$to_sign = sprintf( 'recovery_mode|%s|%s', 'month', wp_generate_password( 20, false ) );
+		$signed  = $reflection->invoke( $service, $to_sign );
+		$cookie  = base64_encode( sprintf( '%s|%s', $to_sign, $signed ) );
+
+		$error = $service->validate_cookie( $cookie );
+		$this->assertWPError( $error );
+		$this->assertEquals( 'invalid_created_at', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_cookie_returns_true_for_valid_cookie() {
+
+		$service    = new WP_Recovery_Mode_Cookie_Service();
+		$reflection = new ReflectionMethod( $service, 'generate_cookie' );
+		$reflection->setAccessible( true );
+
+		$this->assertTrue( $service->validate_cookie( $reflection->invoke( $service ) ) );
+	}
+}
diff --git a/tests/error-protection/recovery-mode-key-service.php b/tests/error-protection/recovery-mode-key-service.php
new file mode 100644
index 0000000000..5364fbf2b3
--- /dev/null
+++ b/tests/error-protection/recovery-mode-key-service.php
@@ -0,0 +1,183 @@
+<?php
+
+/**
+ * @group error-protection
+ */
+class Tests_Recovery_Mode_Key_Service extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_generate_and_store_recovery_mode_key_returns_recovery_key() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$key     = $service->generate_and_store_recovery_mode_key( $token );
+
+		$this->assertNotWPError( $key );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_no_key_set() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$error   = $service->validate_recovery_mode_key( '', 'abcd', HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'token_not_found', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_data_missing() {
+		update_option( 'recovery_keys', 'gibberish' );
+
+		$service = new WP_Recovery_Mode_Key_Service();
+		$error   = $service->validate_recovery_mode_key( '', 'abcd', HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'token_not_found', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_bad() {
+		update_option( 'recovery_keys', array( 'token' => 'gibberish' ) );
+
+		$service = new WP_Recovery_Mode_Key_Service();
+		$error   = $service->validate_recovery_mode_key( 'token', 'abcd', HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'invalid_recovery_key_format', $error->get_error_code() );
+	}
+
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_stored_format_is_invalid() {
+
+		$token = wp_generate_password( 22, false );
+		update_option( 'recovery_keys', array( $token => 'gibberish' ) );
+
+		$service = new WP_Recovery_Mode_Key_Service();
+		$error   = $service->validate_recovery_mode_key( $token, 'abcd', HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'invalid_recovery_key_format', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_empty_key() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$service->generate_and_store_recovery_mode_key( $token );
+		$error = $service->validate_recovery_mode_key( $token, '', HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'hash_mismatch', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_hash_mismatch() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$service->generate_and_store_recovery_mode_key( $token );
+		$error = $service->validate_recovery_mode_key( $token, 'abcd', HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'hash_mismatch', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_wp_error_if_expired() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$key     = $service->generate_and_store_recovery_mode_key( $token );
+
+		$records                         = get_option( 'recovery_keys' );
+		$records[ $token ]['created_at'] = time() - HOUR_IN_SECONDS - 30;
+		update_option( 'recovery_keys', $records );
+
+		$error = $service->validate_recovery_mode_key( $token, $key, HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'key_expired', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46130
+	 */
+	public function test_validate_recovery_mode_key_returns_true_for_valid_key() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$key     = $service->generate_and_store_recovery_mode_key( $token );
+		$this->assertTrue( $service->validate_recovery_mode_key( $token, $key, HOUR_IN_SECONDS ) );
+	}
+
+	/**
+	 * @ticket 46595
+	 */
+	public function test_validate_recovery_mode_key_returns_error_if_token_used_more_than_once() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$key     = $service->generate_and_store_recovery_mode_key( $token );
+
+		$this->assertTrue( $service->validate_recovery_mode_key( $token, $key, HOUR_IN_SECONDS ) );
+
+		// data should be remove by first call
+		$error = $service->validate_recovery_mode_key( $token, $key, HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'token_not_found', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46595
+	 */
+	public function test_validate_recovery_mode_key_returns_error_if_token_used_more_than_once_more_than_key_stored() {
+		$service = new WP_Recovery_Mode_Key_Service();
+
+		// create an extra key
+		$token = $service->generate_recovery_mode_token();
+		$service->generate_and_store_recovery_mode_key( $token );
+
+		$token = $service->generate_recovery_mode_token();
+		$key   = $service->generate_and_store_recovery_mode_key( $token );
+
+		$this->assertTrue( $service->validate_recovery_mode_key( $token, $key, HOUR_IN_SECONDS ) );
+
+		// data should be remove by first call
+		$error = $service->validate_recovery_mode_key( $token, $key, HOUR_IN_SECONDS );
+
+		$this->assertWPError( $error );
+		$this->assertEquals( 'token_not_found', $error->get_error_code() );
+	}
+
+	/**
+	 * @ticket 46595
+	 */
+	public function test_clean_expired_keys() {
+		$service = new WP_Recovery_Mode_Key_Service();
+		$token   = $service->generate_recovery_mode_token();
+		$service->generate_and_store_recovery_mode_key( $token );
+
+		$records = get_option( 'recovery_keys' );
+
+		$records[ $token ]['created_at'] = time() - HOUR_IN_SECONDS - 30;
+
+		update_option( 'recovery_keys', $records );
+
+		$service->clean_expired_keys( HOUR_IN_SECONDS );
+
+		$this->assertEmpty( get_option( 'recovery_keys' ) );
+	}
+}
diff --git a/tests/external-http/basic.php b/tests/external-http/basic.php
index 8799746692..8596cbd472 100644
--- a/tests/external-http/basic.php
+++ b/tests/external-http/basic.php
@@ -13,7 +13,7 @@ class Tests_External_HTTP_Basic extends WP_UnitTestCase {
 		preg_match( '#Recommendations.*PHP</a> version <strong>([0-9.]*)#s', $readme, $matches );
 
 		$response = wp_remote_get( 'https://secure.php.net/supported-versions.php' );
-		if ( 200 != wp_remote_retrieve_response_code( $response ) ) {
+		if ( 200 !== wp_remote_retrieve_response_code( $response ) ) {
 			$this->fail( 'Could not contact PHP.net to check versions.' );
 		}
 		$php = wp_remote_retrieve_body( $response );
@@ -25,7 +25,7 @@ class Tests_External_HTTP_Basic extends WP_UnitTestCase {
 		preg_match( '#Recommendations.*MySQL</a> version <strong>([0-9.]*)#s', $readme, $matches );
 
 		$response = wp_remote_get( "https://dev.mysql.com/doc/relnotes/mysql/{$matches[1]}/en/" );
-		if ( 200 != wp_remote_retrieve_response_code( $response ) ) {
+		if ( 200 !== wp_remote_retrieve_response_code( $response ) ) {
 			$this->fail( 'Could not contact dev.MySQL.com to check versions.' );
 		}
 		$mysql = wp_remote_retrieve_body( $response );
diff --git a/tests/feed/atom.php b/tests/feed/atom.php
index 9d6e3f8eb5..627beda0e1 100644
--- a/tests/feed/atom.php
+++ b/tests/feed/atom.php
@@ -71,6 +71,7 @@ class Tests_Feeds_Atom extends WP_UnitTestCase {
 		// Nasty hack! In the future it would better to leverage do_feed( 'atom' ).
 		global $post;
 		try {
+			// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 			@require( ABSPATH . 'wp-includes/feed-atom.php' );
 			$out = ob_get_clean();
 		} catch ( Exception $e ) {
@@ -162,7 +163,7 @@ class Tests_Feeds_Atom extends WP_UnitTestCase {
 			// Link rel="alternate"
 			$link_alts = xml_find( $entries[ $key ]['child'], 'link' );
 			foreach ( $link_alts as $link_alt ) {
-				if ( 'alternate' == $link_alt['attributes']['rel'] ) {
+				if ( 'alternate' === $link_alt['attributes']['rel'] ) {
 					$this->assertEquals( get_permalink( $post ), $link_alt['attributes']['href'] );
 				}
 			}
@@ -185,7 +186,7 @@ class Tests_Feeds_Atom extends WP_UnitTestCase {
 			}
 			$categories = xml_find( $entries[ $key ]['child'], 'category' );
 			foreach ( $categories as $category ) {
-				$this->assertTrue( in_array( $category['attributes']['term'], $terms ) );
+				$this->assertTrue( in_array( $category['attributes']['term'], $terms, true ) );
 			}
 			unset( $terms );
 
@@ -198,7 +199,7 @@ class Tests_Feeds_Atom extends WP_UnitTestCase {
 			// Link rel="replies"
 			$link_replies = xml_find( $entries[ $key ]['child'], 'link' );
 			foreach ( $link_replies as $link_reply ) {
-				if ( 'replies' == $link_reply['attributes']['rel'] && 'application/atom+xml' == $link_reply['attributes']['type'] ) {
+				if ( 'replies' === $link_reply['attributes']['rel'] && 'application/atom+xml' === $link_reply['attributes']['type'] ) {
 					$this->assertEquals( get_post_comments_feed_link( $post->ID, 'atom' ), $link_reply['attributes']['href'] );
 				}
 			}
diff --git a/tests/feed/rss2.php b/tests/feed/rss2.php
index 79be2fcc64..32d950a1a5 100644
--- a/tests/feed/rss2.php
+++ b/tests/feed/rss2.php
@@ -36,20 +36,23 @@ class Tests_Feeds_RSS2 extends WP_UnitTestCase {
 		);
 
 		// Set a predictable time for testing date archives.
-		self::$post_date = '2003-05-27 10:07:53';
+		self::$post_date = strtotime( '2003-05-27 10:07:53' );
 
 		$count = get_option( 'posts_per_rss' ) + 1;
 
+		self::$posts = array();
 		// Create a few posts
-		self::$posts = $factory->post->create_many(
-			$count,
-			array(
-				'post_author'  => self::$user_id,
-				'post_date'    => self::$post_date,
-				'post_content' => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec velit massa, ultrices eu est suscipit, mattis posuere est. Donec vitae purus lacus. Cras vitae odio odio.',
-				'post_excerpt' => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
-			)
-		);
+		for ( $i = 1; $i <= $count; $i++ ) {
+			self::$posts[] = $factory->post->create(
+				array(
+					'post_author'  => self::$user_id,
+					// Separate post dates 5 seconds apart.
+					'post_date'    => gmdate( 'Y-m-d H:i:s', self::$post_date + ( 5 * $i ) ),
+					'post_content' => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec velit massa, ultrices eu est suscipit, mattis posuere est. Donec vitae purus lacus. Cras vitae odio odio.',
+					'post_excerpt' => 'Lorem ipsum dolor sit amet, consectetur adipiscing elit.',
+				)
+			);
+		}
 
 		// Assign a category to those posts
 		foreach ( self::$posts as $post ) {
@@ -80,6 +83,7 @@ class Tests_Feeds_RSS2 extends WP_UnitTestCase {
 		// Nasty hack! In the future it would better to leverage do_feed( 'rss2' ).
 		global $post;
 		try {
+			// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 			@require( ABSPATH . 'wp-includes/feed-rss2.php' );
 			$out = ob_get_clean();
 		} catch ( Exception $e ) {
@@ -463,4 +467,31 @@ class Tests_Feeds_RSS2 extends WP_UnitTestCase {
 		// There should only be one <rss> child element.
 		$this->assertEquals( 1, count( $rss ) );
 	}
+
+	/**
+	 * Test <rss> element has correct last build date.
+	 *
+	 * @ticket 4575
+	 *
+	 * @dataProvider data_test_get_feed_build_date
+	 */
+	public function test_get_feed_build_date( $url, $element ) {
+		$this->go_to( $url );
+		$feed = $this->do_rss2();
+		$xml  = xml_to_array( $feed );
+
+		// Get the <rss> child element of <xml>.
+		$rss             = xml_find( $xml, $element );
+		$last_build_date = $rss[0]['child'][0]['child'][4]['content'];
+		$this->assertEquals( strtotime( get_feed_build_date( 'r' ) ), strtotime( $last_build_date ) );
+	}
+
+
+	public function data_test_get_feed_build_date() {
+		return array(
+			array( '/?feed=rss2', 'rss' ),
+			array( '/?feed=commentsrss2', 'rss' ),
+		);
+
+	}
 }
diff --git a/tests/file.php b/tests/file.php
index 25a417e512..481b3362c9 100644
--- a/tests/file.php
+++ b/tests/file.php
@@ -183,4 +183,63 @@ class Tests_File extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 47186
+	 */
+	function test_file_signature_functions_as_expected() {
+		$file = wp_tempnam();
+		file_put_contents( $file, 'WordPress' );
+
+		// The signature of 'WordPress' after SHA384 hashing, for verification against the key within self::filter_trust_plus85Tq_key().
+		$expected_signature = 'PmNv0b1ziwJAsVhjdpjd4+PQZidZWSlBm5b+GbbwE9m9HVKDFhEyvyRTHkRYOLypB8P2YvbW7CoOMZqGh8mEAA==';
+
+		add_filter( 'wp_trusted_keys', array( $this, 'filter_trust_plus85Tq_key' ) );
+
+		// Measure how long the call takes.
+		$timer_start = microtime( 1 );
+		$verify      = verify_file_signature( $file, $expected_signature, 'WordPress' );
+		$timer_end   = microtime( 1 );
+		$time_taken  = ( $timer_end - $timer_start );
+
+		unlink( $file );
+		remove_filter( 'wp_trusted_keys', array( $this, 'filter_trust_plus85Tq_key' ) );
+
+		// verify_file_signature() should intentionally never take more than 10s to run.
+		$this->assertLessThan( 10, $time_taken, 'verify_file_signature() took longer than 10 seconds.' );
+
+		// Check to see if the system parameters prevent signature verifications.
+		if ( is_wp_error( $verify ) && 'signature_verification_unsupported' === $verify->get_error_code() ) {
+			$this->markTestSkipped( 'This system does not support Signature Verification.' );
+		}
+
+		$this->assertNotWPError( $verify );
+		$this->assertTrue( $verify );
+	}
+
+	/**
+	 * @ticket 47186
+	 */
+	function test_file_signature_expected_failure() {
+		$file = wp_tempnam();
+		file_put_contents( $file, 'WordPress' );
+
+		// Test an invalid signature.
+		$expected_signature = base64_encode( str_repeat( 'A', SODIUM_CRYPTO_SIGN_PUBLICKEYBYTES ) );
+		$verify             = verify_file_signature( $file, $expected_signature, 'WordPress' );
+		unlink( $file );
+
+		if ( is_wp_error( $verify ) && 'signature_verification_unsupported' === $verify->get_error_code() ) {
+			$this->markTestSkipped( 'This system does not support Signature Verification.' );
+		}
+
+		$this->assertWPError( $verify );
+		$this->assertEquals( 'signature_verification_failed', $verify->get_error_code() );
+	}
+
+	function filter_trust_plus85Tq_key( $keys ) {
+		// A static once-off key used to verify verify_file_signature() works as expected.
+		$keys[] = '+85TqMhxQVAYVW4BSCVkJQvZH4q7z8I9lePbvngvf7A=';
+
+		return $keys;
+	}
 }
diff --git a/tests/formatting/Autop.php b/tests/formatting/Autop.php
index 3f44949fe2..087cbf25c6 100644
--- a/tests/formatting/Autop.php
+++ b/tests/formatting/Autop.php
@@ -312,7 +312,6 @@ Paragraph two.';
 			'h4',
 			'h5',
 			'h6',
-			'hr',
 			'fieldset',
 			'legend',
 			'section',
@@ -416,7 +415,8 @@ Paragraph two.';
 			'select',
 		);
 
-		$content = $expected = array();
+		$content  = array();
+		$expected = array();
 
 		foreach ( $inlines as $inline ) {
 			$content[]  = "<$inline>foo</$inline>";
@@ -502,7 +502,7 @@ line 3<br />
 line 4<br />
 line 5</p>';
 
-		$this->assertEquals( $expected, trim( wpautop( $content ) ) );
+		$this->assertEqualsIgnoreEOL( $expected, trim( wpautop( $content ) ) );
 	}
 
 	/**
@@ -521,7 +521,7 @@ line 2<br/>
 		$expected = '<p>line 1</p>
 <p>line 2</p>';
 
-		$this->assertEquals( $expected, trim( wpautop( $content ) ) );
+		$this->assertEqualsIgnoreEOL( $expected, trim( wpautop( $content ) ) );
 	}
 
 
@@ -543,8 +543,9 @@ line 2<br/>
 	 *
 	 * @ticket 39307
 	 */
-	function test_that_wpautop_doses_not_add_extra_closing_p_in_figure() {
-		$content1 = $expected1 = '<figure><img src="example.jpg" /><figcaption>Caption</figcaption></figure>';
+	function test_that_wpautop_does_not_add_extra_closing_p_in_figure() {
+		$content1  = '<figure><img src="example.jpg" /><figcaption>Caption</figcaption></figure>';
+		$expected1 = $content1;
 
 		$content2 = '<figure>
 <img src="example.jpg" />
@@ -555,7 +556,50 @@ line 2<br/>
 <img src="example.jpg" /><figcaption>Caption</figcaption></figure>';
 
 		$this->assertEquals( $expected1, trim( wpautop( $content1 ) ) );
-		$this->assertEquals( $expected2, trim( wpautop( $content2 ) ) );
+		$this->assertEqualsIgnoreEOL( $expected2, trim( wpautop( $content2 ) ) );
+	}
+
+	/**
+	 * @ticket 14674
+	 */
+	function test_the_hr_is_not_peed() {
+		$content  = 'paragraph1<hr>paragraph2';
+		$expected = "<p>paragraph1</p>\n<hr>\n<p>paragraph2</p>";
+
+		$this->assertEquals( $expected, trim( wpautop( $content ) ) );
+	}
+
+	/**
+	 * wpautop() should ignore inline SVG graphics
+	 *
+	 * @ticket 9437
+	 */
+	function test_that_wpautop_ignores_inline_svgs() {
+		$content =
+			'<svg xmlns="http://www.w3.org/2000/svg">
+				<circle cx="50" cy="50" r="30" fill="blue">
+					<animateTransform attributeName="transform" type="scale" to="1.5" dur="2s" fill="freeze"/>
+				</circle>
+			</svg>';
+
+		$expected = '<p>' . $content . '</p>';
+
+		$this->assertEqualsIgnoreEOL( $expected, trim( wpautop( $content ) ) );
 	}
 
+	/**
+	 * wpautop() should ignore inline scripts
+	 *
+	 * @ticket 9437
+	 */
+	function test_that_wpautop_ignores_inline_scripts() {
+		$content =
+			'<script type="text/javascript">
+				var dummy = 1;
+			</script>';
+
+		$expected = '<p>' . $content . '</p>';
+
+		$this->assertEqualsIgnoreEOL( $expected, trim( wpautop( $content ) ) );
+	}
 }
diff --git a/tests/formatting/Emoji.php b/tests/formatting/Emoji.php
index 4ae62d85f6..34d88fd987 100644
--- a/tests/formatting/Emoji.php
+++ b/tests/formatting/Emoji.php
@@ -6,8 +6,8 @@
  */
 class Tests_Formatting_Emoji extends WP_UnitTestCase {
 
-	private $png_cdn = 'https://s.w.org/images/core/emoji/11.2.0/72x72/';
-	private $svn_cdn = 'https://s.w.org/images/core/emoji/11.2.0/svg/';
+	private $png_cdn = 'https://s.w.org/images/core/emoji/12.0.0-1/72x72/';
+	private $svn_cdn = 'https://s.w.org/images/core/emoji/12.0.0-1/svg/';
 
 	/**
 	 * @ticket 36525
diff --git a/tests/formatting/EscUrl.php b/tests/formatting/EscUrl.php
index 96698c19e8..d183f6f9cb 100644
--- a/tests/formatting/EscUrl.php
+++ b/tests/formatting/EscUrl.php
@@ -13,6 +13,7 @@ class Tests_Formatting_EscUrl extends WP_UnitTestCase {
 		$this->assertEquals( 'http://example.com/Mr%20WordPress', esc_url( 'http://example.com/Mr%20WordPress' ) );
 		$this->assertEquals( 'http://example.com/Mr%20%20WordPress', esc_url( 'http://example.com/Mr%20%20WordPress' ) );
 		$this->assertEquals( 'http://example.com/Mr+WordPress', esc_url( 'http://example.com/Mr+WordPress' ) );
+		$this->assertEquals( 'http://example.com/Mr+WordPress', esc_url( ' http://example.com/Mr+WordPress' ) );
 
 		$this->assertEquals( 'http://example.com/?foo=one%20two%20three&#038;bar=four', esc_url( 'http://example.com/?foo=one two three&bar=four' ) );
 		$this->assertEquals( 'http://example.com/?foo=one%20two%20three&#038;bar=four', esc_url( 'http://example.com/?foo=one%20two%20three&bar=four' ) );
@@ -208,6 +209,7 @@ Hi there,
 
 I thought you might want to sign up for this newsletter
 EOT;
+		$body       = str_replace( "\r\n", "\n", $body );
 		$email_link = 'mailto:?body=' . rawurlencode( $body );
 		$email_link = esc_url( $email_link );
 		$this->assertEquals( 'mailto:?body=Hi%20there%2C%0A%0AI%20thought%20you%20might%20want%20to%20sign%20up%20for%20this%20newsletter', $email_link );
@@ -222,6 +224,7 @@ Hi there,
 
 I thought you might want to sign up for this newsletter
 EOT;
+		$body       = str_replace( "\r\n", "\n", $body );
 		$email_link = 'http://example.com/mailto:?body=' . rawurlencode( $body );
 		$email_link = esc_url( $email_link );
 		$this->assertEquals( 'http://example.com/mailto:?body=Hi%20there%2CI%20thought%20you%20might%20want%20to%20sign%20up%20for%20this%20newsletter', $email_link );
diff --git a/tests/formatting/ExcerptRemoveBlocks.php b/tests/formatting/ExcerptRemoveBlocks.php
new file mode 100644
index 0000000000..8a27f18e81
--- /dev/null
+++ b/tests/formatting/ExcerptRemoveBlocks.php
@@ -0,0 +1,129 @@
+<?php
+
+/**
+ * @group formatting
+ * @covers ::excerpt_remove_blocks
+ * @ticket 46133
+ */
+class Tests_Formatting_ExcerptRemoveBlocks extends WP_UnitTestCase {
+
+	public static $post_id;
+
+	public $content = '
+<!-- wp:paragraph -->
+<p>paragraph</p>
+<!-- /wp:paragraph -->
+<!-- wp:latest-posts {"postsToShow":3,"displayPostDate":true,"order":"asc","orderBy":"title"} /-->
+<!-- wp:spacer -->
+<div style="height:100px" aria-hidden="true" class="wp-block-spacer"></div>
+<!-- /wp:spacer -->
+<!-- wp:columns {"columns":1} -->
+<div class="wp-block-columns has-1-columns">
+	<!-- wp:column -->
+	<div class="wp-block-column">
+		<!-- wp:archives {"displayAsDropdown":false,"showPostCounts":false} /-->
+		
+		<!-- wp:paragraph -->
+		<p>paragraph inside column</p>
+		<!-- /wp:paragraph -->
+	</div>
+	<!-- /wp:column -->
+</div>
+<!-- /wp:columns -->
+';
+
+	public $filtered_content = '
+
+<p>paragraph</p>
+
+
+
+
+		<p>paragraph inside column</p>
+		
+';
+
+	/**
+	 * Fake block rendering function.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @return string Block output.
+	 */
+	function render_fake_block() {
+		return get_the_excerpt( self::$post_id );
+	}
+
+	/**
+	 * Set up.
+	 *
+	 * @since 5.2.0
+	 */
+	function setUp() {
+		parent::setUp();
+		self::$post_id = $this->factory()->post->create(
+			array(
+				'post_excerpt' => '', // Empty excerpt, so it has to be generated.
+				'post_content' => '<!-- wp:core/fake /-->',
+			)
+		);
+		register_block_type(
+			'core/fake',
+			array(
+				'render_callback' => array( $this, 'render_fake_block' ),
+			)
+		);
+	}
+
+	/**
+	 * Tear down.
+	 *
+	 * @since 5.2.0
+	 */
+	function tearDown() {
+		parent::tearDown();
+		$registry = WP_Block_Type_Registry::get_instance();
+		$registry->unregister( 'core/fake' );
+		wp_delete_post( self::$post_id, true );
+	}
+
+	/**
+	 * Tests excerpt_remove_blocks().
+	 *
+	 * @ticket 46133
+	 */
+	function test_excerpt_remove_blocks() {
+		// Simple dynamic block..
+		$content = '<!-- wp:core/block /-->';
+
+		$this->assertEmpty( excerpt_remove_blocks( $content ) );
+
+		// Dynamic block with options, embedded in other content.
+		$this->assertEquals( $this->filtered_content, excerpt_remove_blocks( $this->content ) );
+	}
+
+	/**
+	 * Tests that dynamic blocks don't cause an out-of-memory error.
+	 *
+	 * When dynamic blocks happen to generate an excerpt, they can cause an
+	 * infinite loop if that block is part of the post's content.
+	 *
+	 * `wp_trim_excerpt()` applies the `the_content` filter, which has
+	 * `do_blocks` attached to it, trying to render the block which again will
+	 * attempt to return an excerpt of that post.
+	 *
+	 * This infinite loop can be avoided by stripping dynamic blocks before
+	 * `the_content` gets applied, just like shortcodes.
+	 *
+	 * @ticket 46133
+	 */
+	function test_excerpt_infinite_loop() {
+		$query = new WP_Query(
+			array(
+				'post__in' => array( self::$post_id ),
+			)
+		);
+		$query->the_post();
+		$this->assertEmpty( do_blocks( '<!-- wp:core/fake /-->' ) );
+	}
+}
diff --git a/tests/formatting/HumanTimeDiff.php b/tests/formatting/HumanTimeDiff.php
index da1ad2dcfc..473f5325d3 100644
--- a/tests/formatting/HumanTimeDiff.php
+++ b/tests/formatting/HumanTimeDiff.php
@@ -19,6 +19,11 @@ class Tests_Formatting_HumanTimeDiff extends WP_UnitTestCase {
 	// Data for test_human_time_diff.
 	function data_test_human_time_diff() {
 		return array(
+			array(
+				'37 seconds',
+				new DateTime( '2016-01-01 12:00:37' ),
+				'Test a difference of 37 seconds.',
+			),
 			array(
 				'5 mins',
 				new DateTime( '2016-01-01 12:05:00' ),
diff --git a/tests/formatting/MakeClickable.php b/tests/formatting/MakeClickable.php
index 7d5befcdd1..a990ad42ff 100644
--- a/tests/formatting/MakeClickable.php
+++ b/tests/formatting/MakeClickable.php
@@ -375,8 +375,8 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_script_and_style_tags
 	 * @ticket 30162
+	 * @dataProvider data_script_and_style_tags
 	 */
 	public function test_dont_link_script_and_style_tags( $tag ) {
 		$this->assertEquals( $tag, make_clickable( $tag ) );
@@ -399,4 +399,35 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 48022
+	 * @dataProvider data_add_rel_ugc_in_comments
+	 */
+	public function test_add_rel_ugc_in_comments( $content, $expected ) {
+		$comment_id = self::factory()->comment->create(
+			array(
+				'comment_content' => $content,
+			)
+		);
+
+		ob_start();
+		comment_text( $comment_id );
+		$comment_text = ob_get_clean();
+
+		$this->assertContains( $expected, make_clickable( $comment_text ) );
+	}
+
+	public function data_add_rel_ugc_in_comments() {
+		return array(
+			array(
+				'http://wordpress.org',
+				'<a href="http://wordpress.org" rel="nofollow ugc">http://wordpress.org</a>',
+			),
+			array(
+				'www.wordpress.org',
+				'<p><a href="http://www.wordpress.org" rel="nofollow ugc">http://www.wordpress.org</a>',
+			),
+		);
+	}
+
 }
diff --git a/tests/formatting/SanitizeTextField.php b/tests/formatting/SanitizeTextField.php
index c6f978484b..5e87ff1c89 100644
--- a/tests/formatting/SanitizeTextField.php
+++ b/tests/formatting/SanitizeTextField.php
@@ -133,10 +133,11 @@ class Tests_Formatting_SanitizeTextField extends WP_UnitTestCase {
 			$expected_oneline   = $expected['oneline'];
 			$expected_multiline = $expected['multiline'];
 		} else {
-			$expected_oneline = $expected_multiline = $expected;
+			$expected_oneline   = $expected;
+			$expected_multiline = $expected;
 		}
 		$this->assertEquals( $expected_oneline, sanitize_text_field( $string ) );
-		$this->assertEquals( $expected_multiline, sanitize_textarea_field( $string ) );
+		$this->assertEqualsIgnoreEOL( $expected_multiline, sanitize_textarea_field( $string ) );
 
 	}
 }
diff --git a/tests/formatting/Smilies.php b/tests/formatting/Smilies.php
index d1fd3af1a5..662de0b4f6 100644
--- a/tests/formatting/Smilies.php
+++ b/tests/formatting/Smilies.php
@@ -146,8 +146,8 @@ class Tests_Formatting_Smilies extends WP_UnitTestCase {
 	public function test_ignore_smilies_in_tags( $element ) {
 		$includes_path = includes_url( 'images/smilies/' );
 
-		$in_str  = 'Do we ingore smilies ;-) in ' . $element . ' tags <' . $element . '>My Content Here :?: </' . $element . '>';
-		$exp_str = "Do we ingore smilies \xf0\x9f\x98\x89 in $element tags <$element>My Content Here :?: </$element>";
+		$in_str  = 'Do we ingore smilies ;-) in ' . $element . ' tags <' . $element . ' class="foo">My Content Here :?: </' . $element . '>';
+		$exp_str = "Do we ingore smilies \xf0\x9f\x98\x89 in $element tags <$element class=\"foo\">My Content Here :?: </$element>";
 
 		// standard smilies, use_smilies: ON
 		update_option( 'use_smilies', 1 );
diff --git a/tests/formatting/UrlEncodedToEntities.php b/tests/formatting/UrlEncodedToEntities.php
deleted file mode 100644
index 3fefd420eb..0000000000
--- a/tests/formatting/UrlEncodedToEntities.php
+++ /dev/null
@@ -1,24 +0,0 @@
-<?php
-
-/**
- * @group formatting
- */
-class Tests_Formatting_UrlEncodedToEntities extends WP_UnitTestCase {
-	/**
-	 * @dataProvider data
-	 */
-	function test_convert_urlencoded_to_entities( $u_urlencoded, $entity ) {
-		$this->assertEquals( $entity, preg_replace_callback( '/\%u([0-9A-F]{4,5})/', '_convert_urlencoded_to_entities', $u_urlencoded ), $entity );
-	}
-
-	function data() {
-		$input         = file( DIR_TESTDATA . '/formatting/utf-8/u-urlencoded.txt' );
-		$output        = file( DIR_TESTDATA . '/formatting/utf-8/entitized.txt' );
-		$data_provided = array();
-		foreach ( $input as $key => $value ) {
-			$data_provided[] = array( trim( $value ), trim( $output[ $key ] ) );
-		}
-		return $data_provided;
-	}
-}
-
diff --git a/tests/formatting/WPRelNoFollow.php b/tests/formatting/WPRelNoFollow.php
index b6ff460f86..187bb5997b 100644
--- a/tests/formatting/WPRelNoFollow.php
+++ b/tests/formatting/WPRelNoFollow.php
@@ -74,4 +74,10 @@ class Tests_Rel_No_Follow extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	public function test_append_no_follow_with_valueless_attribute() {
+		$content  = '<p>This is some cool <a href="demo.com" download rel="hola">Code</a></p>';
+		$expected = '<p>This is some cool <a href=\"demo.com\" download rel=\"hola nofollow\">Code</a></p>';
+		$this->assertEquals( $expected, wp_rel_nofollow( $content ) );
+	}
 }
diff --git a/tests/formatting/WPRelUgc.php b/tests/formatting/WPRelUgc.php
new file mode 100644
index 0000000000..515eebb736
--- /dev/null
+++ b/tests/formatting/WPRelUgc.php
@@ -0,0 +1,83 @@
+<?php
+
+/**
+ * @group formatting
+ */
+class Tests_Rel_Ugc extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 48022
+	 */
+	public function test_add_ugc() {
+		$content  = '<p>This is some cool <a href="/">Code</a></p>';
+		$expected = '<p>This is some cool <a href=\"/\" rel=\"nofollow ugc\">Code</a></p>';
+		$this->assertEquals( $expected, wp_rel_ugc( $content ) );
+	}
+
+	/**
+	 * @ticket 48022
+	 */
+	public function test_convert_ugc() {
+		$content  = '<p>This is some cool <a href="/" rel="weird">Code</a></p>';
+		$expected = '<p>This is some cool <a href=\"/\" rel=\"weird nofollow ugc\">Code</a></p>';
+		$this->assertEquals( $expected, wp_rel_ugc( $content ) );
+	}
+
+	/**
+	 * @ticket 48022
+	 * @dataProvider data_wp_rel_ugc
+	 */
+	public function test_wp_rel_ugc( $input, $output ) {
+		return $this->assertEquals( wp_slash( $output ), wp_rel_ugc( $input ) );
+	}
+
+	public function data_wp_rel_ugc() {
+		$home_url_http  = set_url_scheme( home_url(), 'http' );
+		$home_url_https = set_url_scheme( home_url(), 'https' );
+
+		return array(
+			array(
+				'<a href="">Double Quotes</a>',
+				'<a href="" rel="nofollow ugc">Double Quotes</a>',
+			),
+			array(
+				'<a href="https://wordpress.org">Double Quotes</a>',
+				'<a href="https://wordpress.org" rel="nofollow ugc">Double Quotes</a>',
+			),
+			array(
+				"<a href='https://wordpress.org'>Single Quotes</a>",
+				"<a href='https://wordpress.org' rel=\"nofollow ugc\">Single Quotes</a>",
+			),
+			array(
+				'<a href="https://wordpress.org" title="Title">Multiple attributes</a>',
+				'<a href="https://wordpress.org" title="Title" rel="nofollow ugc">Multiple attributes</a>',
+			),
+			array(
+				'<a title="Title" href="https://wordpress.org">Multiple attributes</a>',
+				'<a title="Title" href="https://wordpress.org" rel="nofollow ugc">Multiple attributes</a>',
+			),
+			array(
+				'<a data-someflag href="https://wordpress.org">Multiple attributes</a>',
+				'<a data-someflag href="https://wordpress.org" rel="nofollow ugc">Multiple attributes</a>',
+			),
+			array(
+				'<a  data-someflag  title="Title"  href="https://wordpress.org" onclick=""  >Everything at once</a>',
+				'<a  data-someflag  title="Title"  href="https://wordpress.org" onclick=""   rel="nofollow ugc">Everything at once</a>',
+			),
+			array(
+				'<a href="' . $home_url_http . '/some-url">Home URL (http)</a>',
+				'<a href="' . $home_url_http . '/some-url">Home URL (http)</a>',
+			),
+			array(
+				'<a href="' . $home_url_https . '/some-url">Home URL (https)</a>',
+				'<a href="' . $home_url_https . '/some-url">Home URL (https)</a>',
+			),
+		);
+	}
+
+	public function test_append_ugc_with_valueless_attribute() {
+		$content  = '<p>This is some cool <a href="demo.com" download rel="hola">Code</a></p>';
+		$expected = '<p>This is some cool <a href=\"demo.com\" download rel=\"hola nofollow ugc\">Code</a></p>';
+		$this->assertEquals( $expected, wp_rel_ugc( $content ) );
+	}
+}
diff --git a/tests/formatting/WPSpecialchars.php b/tests/formatting/WPSpecialchars.php
index 09d51d58d8..97ce8e084c 100644
--- a/tests/formatting/WPSpecialchars.php
+++ b/tests/formatting/WPSpecialchars.php
@@ -17,7 +17,7 @@ class Tests_Formatting_WPSpecialchars extends WP_UnitTestCase {
 
 		// Allowed entities should be unchanged
 		foreach ( $allowedentitynames as $ent ) {
-			if ( 'apos' == $ent ) {
+			if ( 'apos' === $ent ) {
 				// But for some reason, PHP doesn't allow &apos;
 				continue;
 			}
diff --git a/tests/formatting/WPTargetedLinkRel.php b/tests/formatting/WPTargetedLinkRel.php
index 08f8ac1021..8be254ac44 100644
--- a/tests/formatting/WPTargetedLinkRel.php
+++ b/tests/formatting/WPTargetedLinkRel.php
@@ -101,4 +101,42 @@ class Tests_Targeted_Link_Rel extends WP_UnitTestCase {
 
 		$this->assertEquals( $expected, $post->post_content );
 	}
+
+	/**
+	 * Ensure JSON format is preserved when relation attribute (rel) is missing.
+	 *
+	 * @ticket 46316
+	 */
+	public function test_wp_targeted_link_rel_should_preserve_json() {
+		$content  = '<p>Links: <a href=\"\/\" target=\"_blank\">No rel<\/a><\/p>';
+		$expected = '<p>Links: <a href=\"\/\" target=\"_blank\" rel=\"noopener noreferrer\">No rel<\/a><\/p>';
+		$this->assertEquals( $expected, wp_targeted_link_rel( $content ) );
+	}
+
+	/**
+	 * Ensure correct quotes are used when relation attribute (rel) is missing.
+	 *
+	 * @ticket 47244
+	 */
+	public function test_wp_targeted_link_rel_should_use_correct_quotes() {
+		$content  = '<p>Links: <a href=\'\/\' target=\'_blank\'>No rel<\/a><\/p>';
+		$expected = '<p>Links: <a href=\'\/\' target=\'_blank\' rel=\'noopener noreferrer\'>No rel<\/a><\/p>';
+		$this->assertEquals( $expected, wp_targeted_link_rel( $content ) );
+
+		$content  = '<p>Links: <a href=\'\/\' target=_blank>No rel<\/a><\/p>';
+		$expected = '<p>Links: <a href=\'\/\' target=_blank rel=\'noopener noreferrer\'>No rel<\/a><\/p>';
+		$this->assertEquals( $expected, wp_targeted_link_rel( $content ) );
+	}
+
+	/**
+	 * Ensure entirely serialized content is ignored.
+	 *
+	 * @ticket 46402
+	 */
+	public function test_ignore_entirely_serialized_content() {
+		$content  = 'a:1:{s:4:"html";s:52:"<p>Links: <a href="/" target="_blank">No Rel</a></p>";}';
+		$expected = 'a:1:{s:4:"html";s:52:"<p>Links: <a href="/" target="_blank">No Rel</a></p>";}';
+		$this->assertEquals( $expected, wp_targeted_link_rel( $content ) );
+	}
+
 }
diff --git a/tests/formatting/WPTexturize.php b/tests/formatting/WPTexturize.php
index 5b6a11cd08..24b0b26883 100644
--- a/tests/formatting/WPTexturize.php
+++ b/tests/formatting/WPTexturize.php
@@ -1576,7 +1576,7 @@ class Tests_Formatting_WPTexturize extends WP_UnitTestCase {
 			case '&#8216;':
 				return '!openq1!';
 			case '&#8217;':
-				if ( 'apostrophe' == $context ) {
+				if ( 'apostrophe' === $context ) {
 					return '!apos!';
 				} else {
 					return '!closeq1!';
@@ -2001,7 +2001,7 @@ String with a number followed by a single quote &#8216;Expendables 3&#8217; vest
 			case '&#8216;':
 				return '!q1!';
 			case '&#8217;':
-				if ( 'apostrophe' == $context ) {
+				if ( 'apostrophe' === $context ) {
 					return '!apos!';
 				} else {
 					return '!q1!';
diff --git a/tests/formatting/WPTrimWords.php b/tests/formatting/WPTrimWords.php
index 7f2a27fc05..7b7438de46 100644
--- a/tests/formatting/WPTrimWords.php
+++ b/tests/formatting/WPTrimWords.php
@@ -4,6 +4,14 @@
  * @group formatting
  */
 class Tests_Formatting_WPTrimWords extends WP_UnitTestCase {
+
+	/**
+	 * Long Dummy Text.
+	 *
+	 * @since 5.0.0
+	 *
+	 * @var string $long_text
+	 */
 	private $long_text = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Fusce varius lacinia vehicula. Etiam sapien risus, ultricies ac posuere eu, convallis sit amet augue. Pellentesque urna massa, lacinia vel iaculis eget, bibendum in mauris. Aenean eleifend pulvinar ligula, a convallis eros gravida non. Suspendisse potenti. Pellentesque et odio tortor. In vulputate pellentesque libero, sed dapibus velit mollis viverra. Pellentesque id urna euismod dolor cursus sagittis.';
 
 	function test_trims_to_55_by_default() {
@@ -42,4 +50,37 @@ class Tests_Formatting_WPTrimWords extends WP_UnitTestCase {
 		$text = 'This is some short text.';
 		$this->assertEquals( $text, wp_trim_words( $text ) );
 	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_trims_to_20_counted_by_chars() {
+		switch_to_locale( 'ja_JP' );
+		$expected = substr( $this->long_text, 0, 20 ) . '&hellip;';
+		$actual   = wp_trim_words( $this->long_text, 20 );
+		restore_previous_locale();
+		$this->assertEquals( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_trims_to_20_counted_by_chars_with_double_width_chars() {
+		switch_to_locale( 'ja_JP' );
+		$text     = str_repeat( '', 100 );
+		$expected = str_repeat( '', 19 ) . '&hellip;';
+		$actual   = wp_trim_words( $text, 19 );
+		restore_previous_locale();
+		$this->assertEquals( $expected, $actual );
+	}
+
+	/**
+	 * @ticket 47867
+	 */
+	function test_works_with_non_numeric_num_words() {
+		$this->assertEquals( '', wp_trim_words( $this->long_text, '', '' ) );
+		$this->assertEquals( '', wp_trim_words( $this->long_text, 'abc', '' ) );
+		$this->assertEquals( '', wp_trim_words( $this->long_text, null, '' ) );
+		$this->assertEquals( 'Lorem ipsum dolor', wp_trim_words( $this->long_text, '3', '' ) );
+	}
 }
diff --git a/tests/formatting/balanceTags.php b/tests/formatting/balanceTags.php
index 783c320780..a660f45303 100644
--- a/tests/formatting/balanceTags.php
+++ b/tests/formatting/balanceTags.php
@@ -37,6 +37,158 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		);
 	}
 
+	function supported_traditional_tag_names() {
+		return array(
+			array( 'a' ),
+			array( 'div' ),
+			array( 'blockquote' ),
+			// HTML tag names can be CAPITALIZED and are case-insensitive.
+			array( 'A' ),
+			array( 'dIv' ),
+			array( 'BLOCKQUOTE' ),
+		);
+	}
+
+	function supported_custom_element_tag_names() {
+		return array(
+			array( 'custom-element' ),
+			array( 'my-custom-element' ),
+			array( 'weekday-5-item' ),
+			array( 'a-big-old-tag-name' ),
+			array( 'with_underscores-and_the_dash' ),
+			array( 'a-.' ),
+			array( 'a._-.-_' ),
+		);
+	}
+
+	function invalid_tag_names() {
+		return array(
+			array( '<0-day>inside', '&lt;0-day>inside' ), // Can't start with a number - handled by the "<3" fix.
+			array( '<UPPERCASE-TAG>inside', '<UPPERCASE-TAG>inside' ), // Custom elements cannot be uppercase.
+		);
+	}
+
+	/**
+	 * These are valid custom elements but we don't support them yet.
+	 *
+	 * @see https://w3c.github.io/webcomponents/spec/custom/#valid-custom-element-name
+	 */
+	function unsupported_valid_tag_names() {
+		return array(
+			// We don't allow ending in a dash.
+			array( '<what->inside' ),
+			// Examples from the spec working document.
+			array( 'math-帢' ),
+			array( 'emotion-' ),
+			// UNICODE ranges
+			// 0x00b7
+			array( 'b-繚' ),
+			// Latin characters with accents/modifiers.
+			// 0x00c0-0x00d6
+			// 0x00d8-0x00f6
+			array( 'a---' ),
+			// 0x00f8-0x037d
+			array( 'a-苀' ),
+			// No 0x037e, which is a Greek semicolon.
+			// 0x037f-0x1fff
+			array( 'a-幘' ),
+			// Zero-width characters, probably never supported.
+			// 0x200c-0x200d
+			array( 'a-to-my-left-is-a-zero-width-non-joiner-do-not-delete-it' ),
+			array( 'a-to-my-left-is-a-zero-width-joiner-do-not-delete-it' ),
+			// Ties.
+			// 0x203f-0x2040
+			array( 'under--tie' ),
+			array( 'over--tie' ),
+			// 0x2170-0x218f
+			array( 'a-' ),
+			array( 'a-' ),
+			array( 'tag--it' ),
+			// 0x2c00-0x2fef
+			array( 'a-滶' ),
+			array( 'b-漺-c' ),
+			array( 'd-熀' ),
+			// 0x3001-0xd7ff
+			array( 'a-' ),
+			array( 'z-' ),
+			array( 'a----' ),
+			// 0xf900-0xfdcf
+			array( 'a-鴾' ),
+			array( 'my-翵' ),
+			array( 'a鼢-tag' ),
+			array( 'my-儱' ),
+			// 0xfdf0-0xfffd
+			array( 'a-儱' ),
+			array( 'a-嚙-嚙-嚙' ), // Warning; blank characters are in there.
+			// Extended ranges.
+			// 0x10000-0xeffff
+			array( 'a-' ),
+			array( 'my-' ),
+			array( 'a-' ),
+		);
+	}
+
+	/**
+	 * These are invalid custom elements but we support them right now in order to keep the parser simpler.
+	 *
+	 * @see https://w3c.github.io/webcomponents/spec/custom/#valid-custom-element-name
+	 */
+	function supported_invalid_tag_names() {
+		return array(
+			// Reserved names for custom elements.
+			array( 'annotation-xml' ),
+			array( 'color-profile' ),
+			array( 'font-face' ),
+			array( 'font-face-src' ),
+			array( 'font-face-uri' ),
+			array( 'font-face-format' ),
+			array( 'font-face-name' ),
+			array( 'missing-glyph' ),
+		);
+	}
+
+	/**
+	 * @ticket 47014
+	 * @dataProvider supported_traditional_tag_names
+	 */
+	function test_detects_traditional_tag_names( $tag ) {
+		$normalized = strtolower( $tag );
+
+		$this->assertEquals( "<$normalized>inside</$normalized>", balanceTags( "<$tag>inside", true ) );
+	}
+
+	/**
+	 * @ticket 47014
+	 * @dataProvider supported_custom_element_tag_names
+	 */
+	function test_detects_supported_custom_element_tag_names( $tag ) {
+		$this->assertEquals( "<$tag>inside</$tag>", balanceTags( "<$tag>inside", true ) );
+	}
+
+	/**
+	 * @ticket 47014
+	 * @dataProvider invalid_tag_names
+	 */
+	function test_ignores_invalid_tag_names( $input, $output ) {
+		$this->assertEquals( $output, balanceTags( $input, true ) );
+	}
+
+	/**
+	 * @ticket 47014
+	 * @dataProvider unsupported_valid_tag_names
+	 */
+	function test_ignores_unsupported_custom_tag_names( $tag ) {
+		$this->assertEquals( "<$tag>inside", balanceTags( "<$tag>inside", true ) );
+	}
+
+	/**
+	 * @ticket 47014
+	 * @dataProvider supported_invalid_tag_names
+	 */
+	function test_detects_supported_invalid_tag_names( $tag ) {
+		$this->assertEquals( "<$tag>inside</$tag>", balanceTags( "<$tag>inside", true ) );
+	}
+
 	/**
 	 * If a recognized valid single tag appears unclosed, it should get self-closed
 	 *
@@ -68,12 +220,15 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 			'<em />',
 			'<p class="main1"/>',
 			'<p class="main2" />',
+			'<STRONG/>',
 		);
 		$expected = array(
 			'<strong></strong>',
 			'<em></em>',
 			'<p class="main1"></p>',
 			'<p class="main2"></p>',
+			// Valid tags are transformed to lowercase.
+			'<strong></strong>',
 		);
 
 		foreach ( $inputs as $key => $input ) {
@@ -221,4 +376,68 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * Get custom element data.
+	 *
+	 * @return array Data.
+	 */
+	public function data_custom_elements() {
+		return array(
+			// Valid custom element tags.
+			array(
+				'<my-custom-element data-attribute="value"/>',
+				'<my-custom-element data-attribute="value"></my-custom-element>',
+			),
+			array(
+				'<my-custom-element>Test</my-custom-element>',
+				'<my-custom-element>Test</my-custom-element>',
+			),
+			array(
+				'<my-custom-element>Test',
+				'<my-custom-element>Test</my-custom-element>',
+			),
+			array(
+				'Test</my-custom-element>',
+				'Test',
+			),
+			array(
+				'</my-custom-element>Test',
+				'Test',
+			),
+			array(
+				'<my-custom-element/>',
+				'<my-custom-element></my-custom-element>',
+			),
+			array(
+				'<my-custom-element />',
+				'<my-custom-element></my-custom-element>',
+			),
+			// Invalid (or at least temporarily unsupported) custom element tags.
+			array(
+				'<MY-CUSTOM-ELEMENT>Test',
+				'<MY-CUSTOM-ELEMENT>Test',
+			),
+			array(
+				'<my->Test',
+				'<my->Test',
+			),
+			array(
+				'<--->Test',
+				'<--->Test',
+			),
+		);
+	}
+
+	/**
+	 * Test custom elements.
+	 *
+	 * @ticket 47014
+	 * @dataProvider data_custom_elements
+	 *
+	 * @param string $source   Source.
+	 * @param string $expected Expected.
+	 */
+	public function test_custom_elements( $source, $expected ) {
+		$this->assertEquals( $expected, balanceTags( $source, true ) );
+	}
 }
diff --git a/tests/formatting/date.php b/tests/formatting/date.php
index 389852594a..fce5494f87 100644
--- a/tests/formatting/date.php
+++ b/tests/formatting/date.php
@@ -13,7 +13,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 */
 	function test_get_date_from_gmt_outside_of_dst() {
 		update_option( 'timezone_string', 'Europe/London' );
-		$gmt = $local = '2012-01-01 12:34:56';
+		$local = '2012-01-01 12:34:56';
+		$gmt   = $local;
 		$this->assertEquals( $local, get_date_from_gmt( $gmt ) );
 	}
 
@@ -34,7 +35,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 */
 	function test_get_gmt_from_date_outside_of_dst() {
 		update_option( 'timezone_string', 'Europe/London' );
-		$local = $gmt = '2012-01-01 12:34:56';
+		$local = '2012-01-01 12:34:56';
+		$gmt   = $local;
 		$this->assertEquals( $gmt, get_gmt_from_date( $local ) );
 	}
 
@@ -52,7 +54,8 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 * @ticket 34279
 	 */
 	function test_get_date_and_time_from_gmt_no_timezone() {
-		$gmt = $local = '2012-01-01 12:34:56';
+		$local = '2012-01-01 12:34:56';
+		$gmt   = $local;
 		$this->assertEquals( $gmt, get_date_from_gmt( $local ) );
 	}
 
@@ -93,4 +96,114 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 		$gmt   = gmdate( 'Y-m-d H:i:s' );
 		$this->assertEquals( strtotime( $gmt ), strtotime( get_gmt_from_date( $local ) ), 'The dates should be equal', 2 );
 	}
+
+	/**
+	 * @ticket 31809
+	 *
+	 * @dataProvider timezone_provider
+	 */
+	public function test_gmt_from_date_correct_time( $timezone_string, $gmt_offset ) {
+		update_option( 'timezone_string', $timezone_string );
+		update_option( 'gmt_offset', $gmt_offset );
+
+		$local       = new DateTimeImmutable( 'now', wp_timezone() );
+		$utc         = $local->setTimezone( new DateTimeZone( 'UTC' ) );
+		$mysql_local = $local->format( 'Y-m-d H:i:s' );
+
+		$this->assertEquals( $utc->format( DATE_RFC3339 ), get_gmt_from_date( $mysql_local, DATE_RFC3339 ) );
+	}
+
+	/**
+	 * @ticket 31809
+	 *
+	 * @dataProvider timezone_provider
+	 */
+	public function test_date_from_gmt_correct_time( $timezone_string, $gmt_offset ) {
+		update_option( 'timezone_string', $timezone_string );
+		update_option( 'gmt_offset', $gmt_offset );
+
+		$local     = new DateTimeImmutable( 'now', wp_timezone() );
+		$utc       = $local->setTimezone( new DateTimeZone( 'UTC' ) );
+		$mysql_utc = $utc->format( 'Y-m-d H:i:s' );
+
+		$this->assertEquals( $local->format( DATE_RFC3339 ), get_date_from_gmt( $mysql_utc, DATE_RFC3339 ) );
+	}
+
+	/**
+	 * @ticket 31809
+	 *
+	 * @dataProvider timezone_provider
+	 */
+	public function test_is8601_to_datetime_correct_time( $timezone_string, $gmt_offset ) {
+		update_option( 'timezone_string', $timezone_string );
+		update_option( 'gmt_offset', $gmt_offset );
+
+		$format       = 'Ymd\TH:i:sO';
+		$format_no_tz = 'Ymd\TH:i:s';
+
+		$local = new DateTimeImmutable( 'now', wp_timezone() );
+		$utc   = $local->setTimezone( new DateTimeZone( 'UTC' ) );
+
+		$this->assertEquals(
+			$local->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $local->format( $format ) ),
+			'Local time from local time.'
+		);
+		$this->assertEquals(
+			$utc->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $local->format( $format ), 'gmt' ),
+			'UTC time from local time.'
+		);
+
+		$this->assertEquals(
+			$local->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $local->format( $format_no_tz ) ),
+			'Local time from local time w/o timezone.'
+		);
+		$this->assertEquals(
+			$utc->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $local->format( $format_no_tz ), 'gmt' ),
+			'UTC time from local time w/o timezone.'
+		);
+
+		$this->assertEquals(
+			$local->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $utc->format( $format ) ),
+			'Local time from UTC time.'
+		);
+		$this->assertEquals(
+			$utc->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $utc->format( $format ), 'gmt' ),
+			'UTC time from UTC time.'
+		);
+
+		$this->assertEquals(
+			$local->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $utc->format( $format_no_tz ) . 'Z' ),
+			'Local time from UTC w/ Z timezone.'
+		);
+		$this->assertEquals(
+			$utc->format( 'Y-m-d H:i:s' ),
+			iso8601_to_datetime( $utc->format( $format_no_tz ) . 'Z', 'gmt' ),
+			'UTC time from UTC w/ Z timezone.'
+		);
+	}
+
+	/**
+	 * Data provider to test different timezone modes.
+	 *
+	 * @return array
+	 */
+	public function timezone_provider() {
+		return array(
+			array(
+				'timezone_string' => 'Europe/Kiev',
+				'gmt_offset'      => 3,
+			),
+			array(
+				'timezone_string' => '',
+				'gmt_offset'      => 3,
+			),
+		);
+	}
 }
diff --git a/tests/formatting/redirect.php b/tests/formatting/redirect.php
index ac16172c69..df69d8470f 100644
--- a/tests/formatting/redirect.php
+++ b/tests/formatting/redirect.php
@@ -36,6 +36,14 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 		$this->assertEquals( 'http://example.com/@username', wp_sanitize_redirect( 'http://example.com/@username' ) );
 	}
 
+	/**
+	 * @group 36998
+	 */
+	function test_wp_sanitize_redirect_should_encode_spaces() {
+		$this->assertEquals( 'http://example.com/test%20spaces', wp_sanitize_redirect( 'http://example.com/test%20spaces' ) );
+		$this->assertEquals( 'http://example.com/test%20spaces%20in%20url', wp_sanitize_redirect( 'http://example.com/test spaces in url' ) );
+	}
+
 	/**
 	 * @dataProvider valid_url_provider
 	 */
@@ -133,4 +141,79 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 			array( 'http://user.pass@#example.com/' ),
 		);
 	}
+
+	/**
+	 * @ticket 47980
+	 * @dataProvider relative_url_provider
+	 */
+	function test_wp_validate_redirect_relative_url( $current_uri, $url, $expected ) {
+		// Backup the global.
+		$unset = false;
+		if ( ! isset( $_SERVER['REQUEST_URI'] ) ) {
+			$unset = true;
+		} else {
+			$backup_request_uri = $_SERVER['REQUEST_URI'];
+		}
+
+		// Set the global to current URI.
+		$_SERVER['REQUEST_URI'] = $current_uri;
+
+		$this->assertEquals( $expected, wp_validate_redirect( $url, false ) );
+
+		// Delete or reset the global as required.
+		if ( $unset ) {
+			unset( $_SERVER['REQUEST_URI'] );
+		} else {
+			$_SERVER['REQUEST_URI'] = $backup_request_uri;
+		}
+	}
+
+	/**
+	 * Data provider for test_wp_validate_redirect_relative_url.
+	 *
+	 * @return array[] {
+	 *      string Current URI (i.e. path and query string only).
+	 *      string Redirect requested.
+	 *      string Expected destination.
+	 * }
+	 */
+	function relative_url_provider() {
+		return array(
+			array(
+				'/',
+				'wp-login.php?loggedout=true',
+				'/wp-login.php?loggedout=true',
+			),
+			array(
+				'/src/',
+				'wp-login.php?loggedout=true',
+				'/src/wp-login.php?loggedout=true',
+			),
+			array(
+				'/wp-admin/settings.php?page=my-plugin',
+				'./settings.php?page=my-plugin',
+				'/wp-admin/./settings.php?page=my-plugin',
+			),
+			array(
+				'/wp-admin/settings.php?page=my-plugin',
+				'/wp-login.php',
+				'/wp-login.php',
+			),
+			array(
+				'/wp-admin/settings.php?page=my-plugin',
+				'../wp-admin/admin.php?page=my-plugin',
+				'/wp-admin/../wp-admin/admin.php?page=my-plugin',
+			),
+			array(
+				'/2019/10/13/my-post',
+				'../../',
+				'/2019/10/13/../../',
+			),
+			array(
+				'/2019/10/13/my-post',
+				'/',
+				'/',
+			),
+		);
+	}
 }
diff --git a/tests/functions.php b/tests/functions.php
index 88b9a46475..dd29c779e5 100644
--- a/tests/functions.php
+++ b/tests/functions.php
@@ -229,6 +229,20 @@ class Tests_Functions extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @ticket 46570
+	 */
+	function test_is_serialized_should_return_true_for_large_floats() {
+		$cases = array(
+			serialize( 1.7976931348623157E+308 ),
+			serialize( array( 1.7976931348623157E+308, 1.23e50 ) ),
+		);
+
+		foreach ( $cases as $case ) {
+			$this->assertTrue( is_serialized( $case ), "Serialized data: $case" );
+		}
+	}
+
 	/**
 	 * @ticket 17375
 	 */
@@ -842,8 +856,9 @@ class Tests_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( 'mbstring extension not available.' );
 		}
 
-		$old_charsets = $charsets = mb_detect_order();
-		if ( ! in_array( 'EUC-JP', $charsets ) ) {
+		$charsets     = mb_detect_order();
+		$old_charsets = $charsets;
+		if ( ! in_array( 'EUC-JP', $charsets, true ) ) {
 			$charsets[] = 'EUC-JP';
 			mb_detect_order( $charsets );
 		}
@@ -866,8 +881,9 @@ class Tests_Functions extends WP_UnitTestCase {
 			$this->markTestSkipped( 'mbstring extension not available.' );
 		}
 
-		$old_charsets = $charsets = mb_detect_order();
-		if ( ! in_array( 'EUC-JP', $charsets ) ) {
+		$charsets     = mb_detect_order();
+		$old_charsets = $charsets;
+		if ( ! in_array( 'EUC-JP', $charsets, true ) ) {
 			$charsets[] = 'EUC-JP';
 			mb_detect_order( $charsets );
 		}
@@ -902,10 +918,6 @@ class Tests_Functions extends WP_UnitTestCase {
 	 * @ticket 28786
 	 */
 	function test_wp_json_encode_depth() {
-		if ( version_compare( PHP_VERSION, '5.5', '<' ) ) {
-			$this->markTestSkipped( 'json_encode() supports the $depth parameter in PHP 5.5+' );
-		};
-
 		$data = array( array( array( 1, 2, 3 ) ) );
 		$json = wp_json_encode( $data, 0, 1 );
 		$this->assertFalse( $json );
@@ -915,46 +927,6 @@ class Tests_Functions extends WP_UnitTestCase {
 		$this->assertFalse( $json );
 	}
 
-	/**
-	 * @ticket 33750
-	 */
-	function test_the_date() {
-		ob_start();
-		the_date();
-		$actual = ob_get_clean();
-		$this->assertEquals( '', $actual );
-
-		$GLOBALS['post'] = self::factory()->post->create_and_get(
-			array(
-				'post_date' => '2015-09-16 08:00:00',
-			)
-		);
-
-		ob_start();
-		$GLOBALS['currentday']  = '18.09.15';
-		$GLOBALS['previousday'] = '17.09.15';
-		the_date();
-		$this->assertEquals( 'September 16, 2015', ob_get_clean() );
-
-		ob_start();
-		$GLOBALS['currentday']  = '18.09.15';
-		$GLOBALS['previousday'] = '17.09.15';
-		the_date( 'Y' );
-		$this->assertEquals( '2015', ob_get_clean() );
-
-		ob_start();
-		$GLOBALS['currentday']  = '18.09.15';
-		$GLOBALS['previousday'] = '17.09.15';
-		the_date( 'Y', 'before ', ' after' );
-		$this->assertEquals( 'before 2015 after', ob_get_clean() );
-
-		ob_start();
-		$GLOBALS['currentday']  = '18.09.15';
-		$GLOBALS['previousday'] = '17.09.15';
-		the_date( 'Y', 'before ', ' after', false );
-		$this->assertEquals( '', ob_get_clean() );
-	}
-
 	/**
 	 * @ticket 36054
 	 * @dataProvider datetime_provider
@@ -1003,8 +975,8 @@ class Tests_Functions extends WP_UnitTestCase {
 	public function test_wp_ext2type() {
 		$extensions = wp_get_ext_types();
 
-		foreach ( $extensions as $type => $extensionList ) {
-			foreach ( $extensionList as $extension ) {
+		foreach ( $extensions as $type => $extension_list ) {
+			foreach ( $extension_list as $extension ) {
 				$this->assertEquals( $type, wp_ext2type( $extension ) );
 				$this->assertEquals( $type, wp_ext2type( strtoupper( $extension ) ) );
 			}
@@ -1350,15 +1322,15 @@ class Tests_Functions extends WP_UnitTestCase {
 				$data,
 				array(
 					// Standard non-image file.
-					 array(
-						 DIR_TESTDATA . '/formatting/big5.txt',
-						 'big5.txt',
-						 array(
-							 'ext'             => 'txt',
-							 'type'            => 'text/plain',
-							 'proper_filename' => false,
-						 ),
-					 ),
+					array(
+						DIR_TESTDATA . '/formatting/big5.txt',
+						'big5.txt',
+						array(
+							'ext'             => 'txt',
+							'type'            => 'text/plain',
+							'proper_filename' => false,
+						),
+					),
 					// Non-image file with wrong sub-type.
 					array(
 						DIR_TESTDATA . '/uploads/pages-to-word.docx',
diff --git a/tests/functions/WpValidateBoolean.php b/tests/functions/WpValidateBoolean.php
index 38a731e31c..833b731425 100644
--- a/tests/functions/WpValidateBoolean.php
+++ b/tests/functions/WpValidateBoolean.php
@@ -1,75 +1,59 @@
 <?php
 
 /**
+ * Tests the wp_validate_boolean function.
+ *
+ * @covers ::wp_validate_boolean
  * @group functions.php
  */
 class Tests_Functions_WpValidateBoolean extends WP_UnitTestCase {
-	public function test_bool_true() {
-		$this->assertTrue( wp_validate_boolean( true ) );
-	}
-
-	public function test_int_1() {
-		$this->assertTrue( wp_validate_boolean( 1 ) );
-	}
-
-	public function test_string_true_lowercase() {
-		$this->assertTrue( wp_validate_boolean( 'true' ) );
-	}
-
-	public function test_string_true_uppercase() {
-		$this->assertTrue( wp_validate_boolean( 'TRUE' ) );
-	}
-
-	public function test_arbitrary_string_should_return_true() {
-		$this->assertTrue( wp_validate_boolean( 'foobar' ) );
-	}
-
-	public function test_bool_false() {
-		$this->assertFalse( wp_validate_boolean( false ) );
-	}
-
-	public function test_int_0() {
-		$this->assertFalse( wp_validate_boolean( 0 ) );
-	}
-
-	public function test_float_0() {
-		$this->assertFalse( wp_validate_boolean( 0.0 ) );
-	}
-
-	public function test_empty_string() {
-		$this->assertFalse( wp_validate_boolean( '' ) );
-	}
-
-	public function test_string_0() {
-		$this->assertFalse( wp_validate_boolean( '0' ) );
-	}
-
-	public function test_empty_array() {
-		$this->assertFalse( wp_validate_boolean( array() ) );
-	}
-
-	public function test_null() {
-		$this->assertFalse( wp_validate_boolean( null ) );
-	}
-
-	public function test_string_false_lowercase() {
-		// Differs from (bool) conversion.
-		$this->assertFalse( wp_validate_boolean( 'false' ) );
-	}
-
 	/**
-	 * @ticket 30238
+	 * Provides test scenarios for all possible scenarios in wp_validate_boolean().
+	 *
+	 * @return array
 	 */
-	public function test_string_false_uppercase() {
-		// Differs from (bool) conversion.
-		$this->assertFalse( wp_validate_boolean( 'FALSE' ) );
+	function data_provider() {
+			$std = new \stdClass();
+
+			return array(
+				array( null, false ),
+				array( true, true ),
+				array( false, false ),
+				array( 'true', true ),
+				array( 'false', false ),
+				array( 'FalSE', false ), // @ticket 30238
+				array( 'FALSE', false ), // @ticket 30238
+				array( 'TRUE', true ),
+				array( ' FALSE ', true ),
+				array( 'yes', true ),
+				array( 'no', true ),
+				array( 'string', true ),
+				array( '', false ),
+				array( array(), false ),
+				array( 1, true ),
+				array( 0, false ),
+				array( -1, true ),
+				array( 99, true ),
+				array( 0.1, true ),
+				array( 0.0, false ),
+				array( '1', true ),
+				array( '0', false ),
+				array( $std, true ),
+			);
 	}
 
 	/**
+	 * Test wp_validate_boolean().
+	 *
+	 * @dataProvider data_provider
+	 *
+	 * @param mixed $test_value.
+	 * @param bool $expected.
+	 *
 	 * @ticket 30238
+	 * @ticket 39868
 	 */
-	public function test_string_false_mixedcase() {
-		// Differs from (bool) conversion.
-		$this->assertFalse( wp_validate_boolean( 'FaLsE' ) );
+	public function test_wp_validate_boolean( $test_value, $expected ) {
+		$this->assertSame( wp_validate_boolean( $test_value ), $expected );
 	}
 }
diff --git a/tests/functions/allowedProtocols.php b/tests/functions/allowedProtocols.php
index 5b32972cc7..992ccee86c 100644
--- a/tests/functions/allowedProtocols.php
+++ b/tests/functions/allowedProtocols.php
@@ -53,6 +53,7 @@ class Tests_Functions_AllowedProtocols extends WP_UnitTestCase {
 			array( 'rtsp', 'rtsp://media.example.com:554/wordpress/audiotrack' ), // RFC2326
 			array( 'svn', 'svn://core.svn.wordpress.org/' ),
 			array( 'tel', 'tel:+1-234-567-8910' ), // RFC3966
+			array( 'sms', 'sms:+1-234-567-8910' ), // RFC3966
 			array( 'fax', 'fax:+123.456.78910' ), // RFC2806/RFC3966
 			array( 'xmpp', 'xmpp://guest@example.com' ), // RFC5122
 			array( 'webcal', 'webcal://example.com/calendar.ics' ),
diff --git a/tests/functions/deprecated.php b/tests/functions/deprecated.php
index c4f8793238..3bd6116f48 100644
--- a/tests/functions/deprecated.php
+++ b/tests/functions/deprecated.php
@@ -135,7 +135,7 @@ class Test_Functions_Deprecated extends WP_UnitTestCase {
 				$key    = 'file';
 		}
 		foreach ( $search as $v ) {
-			if ( $name == $v[ $key ] ) {
+			if ( $name === $v[ $key ] ) {
 				return $v;
 			}
 		}
diff --git a/tests/functions/doEnclose.php b/tests/functions/doEnclose.php
new file mode 100644
index 0000000000..7b2c62ed2c
--- /dev/null
+++ b/tests/functions/doEnclose.php
@@ -0,0 +1,305 @@
+<?php
+/**
+ * Test cases for the `do_enclose()` function.
+ *
+ * @package WordPress\UnitTests
+ *
+ * @since 5.3.0
+ */
+
+/**
+ * Tests_Functions_DoEnclose class.
+ *
+ * @group functions.php
+ * @group post
+ * @covers do_enclose
+ *
+ * @since 5.3.0
+ */
+class Tests_Functions_DoEnclose extends WP_UnitTestCase {
+
+	/**
+	 * Setup before each test method.
+	 *
+	 * @since 5.3.0
+	 */
+	public function setUp() {
+		parent::setUp();
+		add_filter( 'pre_http_request', array( $this, 'fake_http_request' ), 10, 3 );
+	}
+
+	/**
+	 * Cleanup after each test method.
+	 *
+	 * @since 5.3.0
+	 */
+	public function tearDown() {
+		parent::tearDown();
+		remove_filter( 'pre_http_request', array( $this, 'fake_http_request' ) );
+	}
+
+	/**
+	 * Test the function with an explicit content input.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @dataProvider data_test_do_enclose
+	 */
+	public function test_function_with_explicit_content_input( $content, $expected ) {
+		$post_id = self::factory()->post->create();
+
+		do_enclose( $content, $post_id );
+
+		$actual = $this->get_enclosed_by_post_id( $post_id );
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Test the function with an implicit content input.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @dataProvider data_test_do_enclose
+	 */
+	public function test_function_with_implicit_content_input( $content, $expected ) {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $content,
+			)
+		);
+
+		do_enclose( null, $post_id );
+
+		$actual = $this->get_enclosed_by_post_id( $post_id );
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Dataprovider for `test_function_with_explicit_content_input()`
+	 * and `test_function_with_implicit_content_input()`.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string Post content.
+	 *         @type string Expected values.
+	 *     }
+	 * }
+	 */
+	public function data_test_do_enclose() {
+		return array(
+			'null'                  => array(
+				'content'  => null,
+				'expected' => '',
+			),
+			'empty'                 => array(
+				'content'  => '',
+				'expected' => '',
+			),
+			'single-bare-movie'     => array(
+				'content'  => 'movie.mp4',
+				'expected' => '',
+			),
+			'single-bare-audio'     => array(
+				'content'  => 'audio.ogg',
+				'expected' => '',
+			),
+			'single-relative-movie' => array(
+				'content'  => '/movie.mp4',
+				'expected' => "/movie.mp4\n123\nvideo/mp4\n",
+			),
+			'single-relative-audio' => array(
+				'content'  => '/audio.ogg',
+				'expected' => "/audio.ogg\n321\naudio/ogg\n",
+			),
+			'single-unknown'        => array(
+				'content'  => 'https://example.com/wp-content/uploads/2018/06/file.unknown',
+				'expected' => '',
+			),
+			'single-movie'          => array(
+				'content'  => 'https://example.com/wp-content/uploads/2018/06/movie.mp4',
+				'expected' => "https://example.com/wp-content/uploads/2018/06/movie.mp4\n123\nvideo/mp4\n",
+			),
+			'single-audio'          => array(
+				'content'  => 'https://example.com/wp-content/uploads/2018/06/audio.ogg',
+				'expected' => "https://example.com/wp-content/uploads/2018/06/audio.ogg\n321\naudio/ogg\n",
+			),
+			'single-movie-query'    => array(
+				'content'  => 'https://example.com/wp-content/uploads/2018/06/movie.mp4?test=1',
+				'expected' => "https://example.com/wp-content/uploads/2018/06/movie.mp4?test=1\n123\nvideo/mp4\n",
+			),
+			'multi'                 => array(
+				'content'  => "https://example.com/wp-content/uploads/2018/06/audio.ogg\n" .
+								'https://example.com/wp-content/uploads/2018/06/movie.mp4',
+				'expected' => "https://example.com/wp-content/uploads/2018/06/audio.ogg\n321\naudio/ogg\n" .
+								"https://example.com/wp-content/uploads/2018/06/movie.mp4\n123\nvideo/mp4\n",
+			),
+		);
+	}
+
+	/**
+	 * The function should return false when the post ID input is invalid.
+	 *
+	 * @since 5.3.0
+	 */
+	public function test_function_should_return_false_when_invalid_post_id() {
+		$post_id = null;
+		$result  = do_enclose( null, $post_id );
+		$this->assertFalse( $result );
+	}
+
+	/**
+	 * The function should delete an enclosed link when it's no longer in the post content.
+	 *
+	 * @since 5.3.0
+	 */
+	public function test_function_should_delete_enclosed_link_when_no_longer_in_post_content() {
+		$data = $this->data_test_do_enclose();
+
+		// Create a post with a single movie link.
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $data['single-movie']['content'],
+			)
+		);
+
+		do_enclose( null, $post_id );
+
+		$actual = $this->get_enclosed_by_post_id( $post_id );
+		$this->assertSame( $data['single-movie']['expected'], $actual );
+
+		// Replace the movie link with an audio link.
+		wp_update_post(
+			array(
+				'ID'           => $post_id,
+				'post_content' => $data['single-audio']['content'],
+			)
+		);
+
+		do_enclose( null, $post_id );
+
+		$actual = $this->get_enclosed_by_post_id( $post_id );
+		$this->assertSame( $data['single-audio']['expected'], $actual );
+	}
+
+	/**
+	 * The function should support a post object input.
+	 *
+	 * @since 5.3.0
+	 */
+	public function test_function_should_support_post_object_input() {
+		$data = $this->data_test_do_enclose();
+
+		$post_object = self::factory()->post->create_and_get(
+			array(
+				'post_content' => $data['multi']['content'],
+			)
+		);
+
+		do_enclose( null, $post_object );
+
+		$actual = $this->get_enclosed_by_post_id( $post_object->ID );
+		$this->assertSame( $data['multi']['expected'], $actual );
+	}
+
+	/**
+	 * The enclosure links should be filterable with the `enclosure_links` filter.
+	 *
+	 * @since 5.3.0
+	 */
+	public function test_function_enclosure_links_should_be_filterable() {
+		$data = $this->data_test_do_enclose();
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => $data['multi']['content'],
+			)
+		);
+
+		add_filter( 'enclosure_links', array( $this, 'filter_enclosure_links' ), 10, 2 );
+		do_enclose( null, $post_id );
+		remove_filter( 'enclosure_links', array( $this, 'filter_enclosure_links' ) );
+
+		$actual   = $this->get_enclosed_by_post_id( $post_id );
+		$expected = str_replace( 'example.org', sprintf( 'example-%d.org', $post_id ), $data['multi']['expected'] );
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * A callback to filter the list of enclosure links.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @param  array $post_links An array of enclosure links.
+	 * @param  int   $post_id    Post ID.
+	 * @return array $post_links An array of enclosure links.
+	 */
+	public function filter_enclosure_links( $enclosure_links, $post_id ) {
+		// Replace the link host to contain the post ID, to test both filter input arguments.
+		foreach ( $enclosure_links as &$link ) {
+			$link = str_replace( 'example.org', sprintf( 'example-%d.org', $post_id ), $link );
+		}
+		return $enclosure_links;
+	}
+
+	/**
+	 * Helper function to get all enclosure data for a given post.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @param  int    $post_id Post ID.
+	 * @return string          All enclosure data for the given post.
+	 */
+	protected function get_enclosed_by_post_id( $post_id ) {
+		return implode( '', (array) get_post_meta( $post_id, 'enclosure', false ) );
+	}
+
+	/**
+	 * Fake the HTTP request response.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @param bool   $false     False.
+	 * @param array  $arguments Request arguments.
+	 * @param string $url       Request URL.
+	 *
+	 * @return array            Header.
+	 */
+	public function fake_http_request( $false, $arguments, $url ) {
+
+		// Video and audio headers.
+		$fake_headers = array(
+			'mp4' => array(
+				'headers' => array(
+					'content-length' => 123,
+					'content-type'   => 'video/mp4',
+				),
+			),
+			'ogg' => array(
+				'headers' => array(
+					'content-length' => 321,
+					'content-type'   => 'audio/ogg',
+				),
+			),
+		);
+
+		$path = parse_url( $url, PHP_URL_PATH );
+
+		if ( false !== $path ) {
+			$extension = pathinfo( $path, PATHINFO_EXTENSION );
+			if ( isset( $fake_headers[ $extension ] ) ) {
+				return $fake_headers[ $extension ];
+			}
+		}
+
+		// Fallback header.
+		return array(
+			'headers' => array(
+				'content-length' => 0,
+				'content-type'   => '',
+			),
+		);
+	}
+
+}
diff --git a/tests/functions/getArchives.php b/tests/functions/getArchives.php
index bd7b617250..c771eece09 100644
--- a/tests/functions/getArchives.php
+++ b/tests/functions/getArchives.php
@@ -15,8 +15,8 @@ class Tests_Get_Archives extends WP_UnitTestCase {
 	function setUp() {
 		parent::setUp();
 
-		$this->month_url = get_month_link( date( 'Y' ), date( 'm' ) );
-		$this->year_url  = get_year_link( date( 'Y' ) );
+		$this->month_url = get_month_link( gmdate( 'Y' ), gmdate( 'm' ) );
+		$this->year_url  = get_year_link( gmdate( 'Y' ) );
 	}
 
 	public static function wpSetUpBeforeClass( $factory ) {
@@ -30,12 +30,12 @@ class Tests_Get_Archives extends WP_UnitTestCase {
 	}
 
 	function test_wp_get_archives_default() {
-		$expected['default'] = "<li><a href='" . $this->month_url . "'>" . date( 'F Y' ) . '</a></li>';
+		$expected['default'] = "<li><a href='" . $this->month_url . "'>" . gmdate( 'F Y' ) . '</a></li>';
 		$this->assertEquals( $expected['default'], trim( wp_get_archives( array( 'echo' => false ) ) ) );
 	}
 
 	function test_wp_get_archives_type() {
-		$expected['type'] = "<li><a href='" . $this->year_url . "'>" . date( 'Y' ) . '</a></li>';
+		$expected['type'] = "<li><a href='" . $this->year_url . "'>" . gmdate( 'Y' ) . '</a></li>';
 		$this->assertEquals(
 			$expected['type'],
 			trim(
@@ -71,7 +71,7 @@ class Tests_Get_Archives extends WP_UnitTestCase {
 	<li><a href='$link4'>$title4</a></li>
 	<li><a href='$link5'>$title5</a></li>
 EOF;
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			$expected['limit'],
 			trim(
 				wp_get_archives(
@@ -86,7 +86,7 @@ EOF;
 	}
 
 	function test_wp_get_archives_format() {
-		$expected['format'] = "<option value='" . $this->month_url . "'> " . date( 'F Y' ) . ' </option>';
+		$expected['format'] = "<option value='" . $this->month_url . "'> " . gmdate( 'F Y' ) . ' </option>';
 		$this->assertEquals(
 			$expected['format'],
 			trim(
@@ -101,7 +101,7 @@ EOF;
 	}
 
 	function test_wp_get_archives_before_and_after() {
-		$expected['before_and_after'] = "<div><a href='" . $this->month_url . "'>" . date( 'F Y' ) . '</a></div>';
+		$expected['before_and_after'] = "<div><a href='" . $this->month_url . "'>" . gmdate( 'F Y' ) . '</a></div>';
 		$this->assertEquals(
 			$expected['before_and_after'],
 			trim(
@@ -118,7 +118,7 @@ EOF;
 	}
 
 	function test_wp_get_archives_show_post_count() {
-		$expected['show_post_count'] = "<li><a href='" . $this->month_url . "'>" . date( 'F Y' ) . '</a>&nbsp;(8)</li>';
+		$expected['show_post_count'] = "<li><a href='" . $this->month_url . "'>" . gmdate( 'F Y' ) . '</a>&nbsp;(8)</li>';
 		$this->assertEquals(
 			$expected['show_post_count'],
 			trim(
@@ -133,7 +133,7 @@ EOF;
 	}
 
 	function test_wp_get_archives_echo() {
-		$expected['echo'] = "\t<li><a href='" . $this->month_url . "'>" . date( 'F Y' ) . '</a></li>' . "\n";
+		$expected['echo'] = "\t<li><a href='" . $this->month_url . "'>" . gmdate( 'F Y' ) . '</a></li>' . "\n";
 		$this->expectOutputString( $expected['echo'] );
 		wp_get_archives( array( 'echo' => true ) );
 	}
@@ -147,13 +147,13 @@ EOF;
 			)
 		);
 
-		$date_full             = date( 'F Y' );
+		$date_full             = gmdate( 'F Y' );
 		$oct_url               = get_month_link( 2012, 10 );
 		$expected['order_asc'] = <<<EOF
 <li><a href='{$oct_url}'>October 2012</a></li>
 	<li><a href='{$this->month_url}'>$date_full</a></li>
 EOF;
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			$expected['order_asc'],
 			trim(
 				wp_get_archives(
@@ -169,7 +169,7 @@ EOF;
 <li><a href='{$this->month_url}'>$date_full</a></li>
 	<li><a href='{$oct_url}'>October 2012</a></li>
 EOF;
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			$expected['order_desc'],
 			trim(
 				wp_get_archives(
diff --git a/tests/functions/getStatusHeaderDesc.php b/tests/functions/getStatusHeaderDesc.php
new file mode 100644
index 0000000000..0b4ec37661
--- /dev/null
+++ b/tests/functions/getStatusHeaderDesc.php
@@ -0,0 +1,42 @@
+<?php
+
+/**
+ * Tests get_status_header_desc function
+ *
+ * @since 5.3.0
+ *
+ * @group functions.php
+ */
+class Tests_Functions_get_status_header_desc extends WP_UnitTestCase {
+
+	/**
+	 * @dataProvider _status_strings
+	 *
+	 * @param int    $code     HTTP status code.
+	 * @param string $expected Status description.
+	 */
+	public function test_get_status_header_desc( $code, $expected ) {
+		$this->assertSame( get_status_header_desc( $code ), $expected );
+	}
+
+	/**
+	 * Data provider for test_get_status_header_desc().
+	 *
+	 * @return array
+	 */
+	public function _status_strings() {
+		return array(
+			array( 200, 'OK' ),
+			array( 301, 'Moved Permanently' ),
+			array( 404, 'Not Found' ),
+			array( 500, 'Internal Server Error' ),
+
+			// A string to make sure that the absint() is working.
+			array( '200', 'OK' ),
+
+			// Not recognized codes return empty strings.
+			array( 9999, '' ),
+			array( 'random', '' ),
+		);
+	}
+}
diff --git a/tests/functions/isNewDay.php b/tests/functions/isNewDay.php
new file mode 100644
index 0000000000..629a6d3de5
--- /dev/null
+++ b/tests/functions/isNewDay.php
@@ -0,0 +1,36 @@
+<?php
+/**
+ * Test is_new_date() function.
+ *
+ * @since 5.2.0
+ *
+ * @group functions.php
+ */
+class Tests_Functions_is_new_date extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 46627
+	 * @dataProvider _data_is_new_date
+	 *
+	 * @param string $currentday_string  The day of the current post in the loop.
+	 * @param string $previousday_string The day of the previous post in the loop.
+	 * @param bool   $expected           Expected result.
+	 */
+	public function test_is_new_date( $currentday_string, $previousday_string, $expected ) {
+		global $currentday, $previousday;
+
+		$currentday  = $currentday_string;
+		$previousday = $previousday_string;
+
+		$this->assertSame( $expected, is_new_day() );
+	}
+
+	public function _data_is_new_date() {
+		return array(
+			array( '21.05.19', '21.05.19', 0 ),
+			array( '21.05.19', '20.05.19', 1 ),
+			array( '21.05.19', false, 1 ),
+		);
+	}
+
+}
diff --git a/tests/functions/maybeDeclineDate.php b/tests/functions/maybeDeclineDate.php
index a3ec61a44a..d888a2d53c 100644
--- a/tests/functions/maybeDeclineDate.php
+++ b/tests/functions/maybeDeclineDate.php
@@ -3,6 +3,7 @@
 /**
  * @group functions.php
  * @group i18n
+ * @group datetime
  */
 class Tests_Functions_MaybeDeclineDate extends WP_UnitTestCase {
 
@@ -68,6 +69,8 @@ class Tests_Functions_MaybeDeclineDate extends WP_UnitTestCase {
 		return array(
 			array( 'ru_RU', '21 郇', '21 邽郇' ),
 			array( 'ru_RU', '1 觓郇赲訄 2016', '1 郇赲訄 2016' ),
+			array( 'ru_RU', '觓郇赲訄 1st 2016', '1 郇赲訄 2016' ),
+			array( 'ru_RU', '觓郇赲訄 1 2016', '1 郇赲訄 2016' ),
 			array( 'pl_PL', '1 Stycze', '1 stycznia' ),
 			array( 'hr', '1. Sijeanj', '1. sijenja' ),
 			array( 'ca', '1 de abril', "1 d'abril" ),
diff --git a/tests/functions/wpArraySliceAssoc.php b/tests/functions/wpArraySliceAssoc.php
new file mode 100644
index 0000000000..73df5cb87c
--- /dev/null
+++ b/tests/functions/wpArraySliceAssoc.php
@@ -0,0 +1,129 @@
+<?php
+
+/**
+ * Tests wp_array_slice_assoc function
+ *
+ * @since 5.3.0
+ *
+ * @covers wp_array_slice_assoc
+ * @group functions.php
+ */
+class Tests_Functions_WpArraySliceAssoc extends WP_UnitTestCase {
+
+	/**
+	 * Test wp_array_slice_assoc().
+	 *
+	 * @dataProvider data_wp_array_slice_assoc_arrays
+	 *
+	 * @ticket 46638
+	 *
+	 * @param array $target_array The original array.
+	 * @param array $keys         The list of keys.
+	 * @param array $expected     The expected result.
+	 */
+	public function test_wp_array_slice_assoc( $target_array, $keys, $expected ) {
+		$this->assertSame( wp_array_slice_assoc( $target_array, $keys ), $expected );
+	}
+
+	/**
+	 * Test data for wp_array_slice_assoc().
+	 *
+	 * @return array
+	 */
+	public function data_wp_array_slice_assoc_arrays() {
+		return array(
+			array(
+				array( 1 => 1 ),
+				array( 1 ),
+				array( 1 => 1 ),
+			),
+			array(
+				array( 1 => 1 ),
+				array( 0 ),
+				array(),
+			),
+			array(
+				array( 1 => array( 1 => 1 ) ),
+				array( 1 ),
+				array( 1 => array( 1 => 1 ) ),
+			),
+			array(
+				array(
+					1 => 1,
+					2 => 2,
+				),
+				array( 1 ),
+				array( 1 => 1 ),
+			),
+			array(
+				array(
+					1 => 1,
+					2 => 2,
+				),
+				array( 2 ),
+				array( 2 => 2 ),
+			),
+			array(
+				array(
+					1 => 1,
+					2 => 2,
+				),
+				array( 1, 1 ),
+				array( 1 => 1 ),
+			),
+			array(
+				array( 1 => array( 1 => array( 1 => 1 ) ) ),
+				array( 1 ),
+				array( 1 => array( 1 => array( 1 => 1 ) ) ),
+			),
+			array(
+				array(
+					1 => 1,
+					2 => 2,
+				),
+				array( 1, 2 ),
+				array(
+					1 => 1,
+					2 => 2,
+				),
+			),
+			array(
+				array(
+					'1' => '1',
+					'2' => '2',
+				),
+				array( '1' ),
+				array( '1' => '1' ),
+			),
+			array(
+				array(
+					'1' => '1',
+					'2' => '2',
+				),
+				array( '2' ),
+				array( '2' => '2' ),
+			),
+			array(
+				array(
+					'1' => '1',
+					'2' => '2',
+				),
+				array( 1 ),
+				array( '1' => '1' ),
+			),
+			array(
+				array(
+					'1' => '1',
+					'2' => '2',
+				),
+				array( 1 ),
+				array( '1' => '1' ),
+			),
+			array(
+				array( 1 => 1 ),
+				array( '1' ),
+				array( 1 => 1 ),
+			),
+		);
+	}
+}
diff --git a/tests/functions/wpGetMimeTypes.php b/tests/functions/wpGetMimeTypes.php
new file mode 100644
index 0000000000..dec3ea73d6
--- /dev/null
+++ b/tests/functions/wpGetMimeTypes.php
@@ -0,0 +1,30 @@
+<?php
+
+/**
+ * Test wp_get_mime_types().
+ *
+ * @group functions.php
+ */
+class Tests_wp_get_mime_types extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 47701
+	 */
+	public function test_all_mime_match() {
+		$mime_types_start = wp_get_mime_types();
+
+		$this->assertInternalType( 'array', $mime_types_start );
+		$this->assertNotEmpty( $mime_types_start );
+
+		add_filter( 'mime_types', '__return_empty_array' );
+		$mime_types_empty = wp_get_mime_types();
+		$this->assertSame( array(), $mime_types_empty );
+
+		remove_filter( 'mime_types', '__return_empty_array' );
+		$mime_types = wp_get_mime_types();
+		$this->assertInternalType( 'array', $mime_types );
+		$this->assertNotEmpty( $mime_types );
+		// Did it revert to the original after filter remove?
+		$this->assertSame( $mime_types_start, $mime_types );
+	}
+}
diff --git a/tests/general/archives.php b/tests/general/archives.php
index cdf2670f5d..f32bb6bcbc 100644
--- a/tests/general/archives.php
+++ b/tests/general/archives.php
@@ -30,7 +30,8 @@ class Tests_General_Archives extends WP_UnitTestCase {
 			)
 		);
 		$this->assertInternalType( 'string', $result );
-		$this->assertNotEmpty( $time1 = wp_cache_get( 'last_changed', 'posts' ) );
+		$time1 = wp_cache_get( 'last_changed', 'posts' );
+		$this->assertNotEmpty( $time1 );
 		$this->assertEquals( $num_queries + 1, $wpdb->num_queries );
 
 		$num_queries = $wpdb->num_queries;
diff --git a/tests/general/paginateLinks.php b/tests/general/paginateLinks.php
index 30e076c3af..dc7195c5f9 100644
--- a/tests/general/paginateLinks.php
+++ b/tests/general/paginateLinks.php
@@ -16,16 +16,16 @@ class Tests_Paginate_Links extends WP_UnitTestCase {
 		$page50 = get_pagenum_link( 50 );
 
 		$expected = <<<EXPECTED
-<span aria-current='page' class='page-numbers current'>1</span>
-<a class='page-numbers' href='$page2'>2</a>
-<a class='page-numbers' href='$page3'>3</a>
+<span aria-current="page" class="page-numbers current">1</span>
+<a class="page-numbers" href="$page2">2</a>
+<a class="page-numbers" href="$page3">3</a>
 <span class="page-numbers dots">&hellip;</span>
-<a class='page-numbers' href='$page50'>50</a>
+<a class="page-numbers" href="$page50">50</a>
 <a class="next page-numbers" href="$page2">Next &raquo;</a>
 EXPECTED;
 
 		$links = paginate_links( array( 'total' => 50 ) );
-		$this->assertEquals( $expected, $links );
+		$this->assertEqualsIgnoreEOL( $expected, $links );
 	}
 
 	function test_format() {
@@ -34,11 +34,11 @@ EXPECTED;
 		$page50 = home_url( '/page/50/' );
 
 		$expected = <<<EXPECTED
-<span aria-current='page' class='page-numbers current'>1</span>
-<a class='page-numbers' href='$page2'>2</a>
-<a class='page-numbers' href='$page3'>3</a>
+<span aria-current="page" class="page-numbers current">1</span>
+<a class="page-numbers" href="$page2">2</a>
+<a class="page-numbers" href="$page3">3</a>
 <span class="page-numbers dots">&hellip;</span>
-<a class='page-numbers' href='$page50'>50</a>
+<a class="page-numbers" href="$page50">50</a>
 <a class="next page-numbers" href="$page2">Next &raquo;</a>
 EXPECTED;
 
@@ -48,7 +48,7 @@ EXPECTED;
 				'format' => 'page/%#%/',
 			)
 		);
-		$this->assertEquals( $expected, $links );
+		$this->assertEqualsIgnoreEOL( $expected, $links );
 	}
 
 	function test_prev_next_false() {
@@ -58,12 +58,12 @@ EXPECTED;
 		$page50 = get_pagenum_link( 50 );
 
 		$expected = <<<EXPECTED
-<a class='page-numbers' href='$home'>1</a>
-<span aria-current='page' class='page-numbers current'>2</span>
-<a class='page-numbers' href='$page3'>3</a>
-<a class='page-numbers' href='$page4'>4</a>
+<a class="page-numbers" href="$home">1</a>
+<span aria-current="page" class="page-numbers current">2</span>
+<a class="page-numbers" href="$page3">3</a>
+<a class="page-numbers" href="$page4">4</a>
 <span class="page-numbers dots">&hellip;</span>
-<a class='page-numbers' href='$page50'>50</a>
+<a class="page-numbers" href="$page50">50</a>
 EXPECTED;
 
 		$links = paginate_links(
@@ -73,7 +73,7 @@ EXPECTED;
 				'current'   => 2,
 			)
 		);
-		$this->assertEquals( $expected, $links );
+		$this->assertEqualsIgnoreEOL( $expected, $links );
 	}
 
 	function test_prev_next_true() {
@@ -84,12 +84,12 @@ EXPECTED;
 
 		$expected = <<<EXPECTED
 <a class="prev page-numbers" href="$home">&laquo; Previous</a>
-<a class='page-numbers' href='$home'>1</a>
-<span aria-current='page' class='page-numbers current'>2</span>
-<a class='page-numbers' href='$page3'>3</a>
-<a class='page-numbers' href='$page4'>4</a>
+<a class="page-numbers" href="$home">1</a>
+<span aria-current="page" class="page-numbers current">2</span>
+<a class="page-numbers" href="$page3">3</a>
+<a class="page-numbers" href="$page4">4</a>
 <span class="page-numbers dots">&hellip;</span>
-<a class='page-numbers' href='$page50'>50</a>
+<a class="page-numbers" href="$page50">50</a>
 <a class="next page-numbers" href="$page3">Next &raquo;</a>
 EXPECTED;
 
@@ -100,7 +100,7 @@ EXPECTED;
 				'current'   => 2,
 			)
 		);
-		$this->assertEquals( $expected, $links );
+		$this->assertEqualsIgnoreEOL( $expected, $links );
 	}
 
 	function increment_i18n_count() {
@@ -333,7 +333,7 @@ EXPECTED;
 			)
 		);
 
-		$this->assertContains( "<span aria-current='page' class='page-numbers current'>3</span>", $links );
+		$this->assertContains( '<span aria-current="page" class="page-numbers current">3</span>', $links );
 	}
 
 	/**
@@ -355,6 +355,6 @@ EXPECTED;
 		);
 
 		$page_2_url = home_url() . '?foo=2';
-		$this->assertContains( "<a class='page-numbers' href='$page_2_url'>2</a>", $links );
+		$this->assertContains( "<a class=\"page-numbers\" href=\"$page_2_url\">2</a>", $links );
 	}
 }
diff --git a/tests/general/template.php b/tests/general/template.php
index d5752fc71b..648e22661a 100644
--- a/tests/general/template.php
+++ b/tests/general/template.php
@@ -231,7 +231,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload              = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload              = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->site_icon_url = $upload['url'];
 
 		// Save the data
@@ -308,8 +308,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 		$this->_set_custom_logo();
 
 		$custom_logo_attr = array(
-			'class'    => 'custom-logo',
-			'itemprop' => 'logo',
+			'class' => 'custom-logo',
 		);
 
 		// If the logo alt attribute is empty, use the site title.
@@ -322,7 +321,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 		$image    = wp_get_attachment_image( $this->custom_logo_id, 'full', false, $custom_logo_attr );
 		restore_current_blog();
 
-		$expected_custom_logo = '<a href="' . $home_url . '" class="custom-logo-link" rel="home" itemprop="url">' . $image . '</a>';
+		$expected_custom_logo = '<a href="' . $home_url . '" class="custom-logo-link" rel="home">' . $image . '</a>';
 		$this->assertEquals( $expected_custom_logo, get_custom_logo( $blog_id ) );
 	}
 
@@ -338,8 +337,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 		$this->_set_custom_logo();
 
 		$custom_logo_attr = array(
-			'class'    => 'custom-logo',
-			'itemprop' => 'logo',
+			'class' => 'custom-logo',
 		);
 
 		// If the logo alt attribute is empty, use the site title.
@@ -350,7 +348,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 
 		$image = wp_get_attachment_image( $this->custom_logo_id, 'full', false, $custom_logo_attr );
 
-		$this->expectOutputString( '<a href="http://' . WP_TESTS_DOMAIN . '/" class="custom-logo-link" rel="home" itemprop="url">' . $image . '</a>' );
+		$this->expectOutputString( '<a href="http://' . WP_TESTS_DOMAIN . '/" class="custom-logo-link" rel="home">' . $image . '</a>' );
 		the_custom_logo();
 	}
 
@@ -370,12 +368,11 @@ class Tests_General_Template extends WP_UnitTestCase {
 			'full',
 			false,
 			array(
-				'class'    => 'custom-logo',
-				'itemprop' => 'logo',
+				'class' => 'custom-logo',
 			)
 		);
 
-		$this->expectOutputString( '<a href="http://' . WP_TESTS_DOMAIN . '/" class="custom-logo-link" rel="home" itemprop="url">' . $image . '</a>' );
+		$this->expectOutputString( '<a href="http://' . WP_TESTS_DOMAIN . '/" class="custom-logo-link" rel="home">' . $image . '</a>' );
 		the_custom_logo();
 	}
 
@@ -409,7 +406,7 @@ class Tests_General_Template extends WP_UnitTestCase {
 	function _insert_custom_logo() {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
-		$upload   = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload   = wp_upload_bits( wp_basename( $filename ), null, $contents );
 
 		// Save the data.
 		$this->custom_logo_url = $upload['url'];
@@ -615,4 +612,34 @@ class Tests_General_Template extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, $result );
 	}
+
+	/**
+	 * @ticket 43590
+	 */
+	function test_wp_no_robots() {
+		// Simulate private site (search engines discouraged).
+		update_option( 'blog_public', '0' );
+		$actual_private = get_echo( 'wp_no_robots' );
+		$this->assertSame( "<meta name='robots' content='noindex,nofollow' />\n", $actual_private );
+
+		// Simulate public site.
+		update_option( 'blog_public', '1' );
+		$actual_public = get_echo( 'wp_no_robots' );
+		$this->assertSame( "<meta name='robots' content='noindex,follow' />\n", $actual_public );
+	}
+
+	/**
+	 * @ticket 40969
+	 */
+	function test_get_template_part_returns_nothing() {
+		ob_start();
+
+		// The `get_template_part()` function must not return anything
+		// due to themes in the wild that echo its return value.
+		$part   = get_template_part( 'template', 'part' );
+		$output = ob_get_clean();
+
+		self::assertSame( 'Template Part', trim( $output ) );
+		self::assertSame( null, $part );
+	}
 }
diff --git a/tests/hooks/doAction.php b/tests/hooks/doAction.php
index 48ced32e1d..34f90eae3a 100644
--- a/tests/hooks/doAction.php
+++ b/tests/hooks/doAction.php
@@ -164,9 +164,10 @@ class Tests_WP_Hook_Do_Action extends WP_UnitTestCase {
 
 	/**
 	 * Use this rather than MockAction so we can test callbacks with no args
+	 *
+	 * @param mixed ...$args Optional arguments passed to the action.
 	 */
-	public function _action_callback() {
-		$args           = func_get_args();
+	public function _action_callback( ...$args ) {
 		$this->events[] = array(
 			'action' => __FUNCTION__,
 			'args'   => $args,
diff --git a/tests/http/base.php b/tests/http/base.php
index bed3cf4c89..6cc6cc7d67 100644
--- a/tests/http/base.php
+++ b/tests/http/base.php
@@ -54,7 +54,7 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 		// Disable all transports aside from this one.
 		foreach ( array( 'curl', 'streams', 'fsockopen' ) as $t ) {
 			remove_filter( "use_{$t}_transport", '__return_false' ); // Just strip them all
-			if ( $t != $this->transport ) {
+			if ( $t !== $this->transport ) {
 				add_filter( "use_{$t}_transport", '__return_false' ); // and add it back if need be..
 			}
 		}
@@ -226,7 +226,7 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 	 * @ticket 11888
 	 */
 	function test_send_headers() {
-		// Test that the headers sent are recieved by the server
+		// Test that the headers sent are received by the server
 		$headers = array(
 			'test1' => 'test',
 			'test2' => 0,
@@ -247,7 +247,7 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 			$headers[ $parts[0] ] = $parts[1];
 		}
 
-		$this->assertTrue( isset( $headers['test1'] ) && 'test' == $headers['test1'] );
+		$this->assertTrue( isset( $headers['test1'] ) && 'test' === $headers['test1'] );
 		$this->assertTrue( isset( $headers['test2'] ) && '0' === $headers['test2'] );
 		// cURL/HTTP Extension Note: Will never pass, cURL does not pass headers with an empty value.
 		// Should it be that empty headers with empty values are NOT sent?
diff --git a/tests/http/functions.php b/tests/http/functions.php
index bfa4cd3e2a..3b15c6856e 100644
--- a/tests/http/functions.php
+++ b/tests/http/functions.php
@@ -199,4 +199,29 @@ class Tests_HTTP_Functions extends WP_UnitTestCase {
 		$this->assertSame( 'test', $cookie->name );
 		$this->assertSame( 'foo', $cookie->value );
 	}
+
+	/**
+	 * @ticket 43231
+	 */
+	function test_get_cookie_host_only() {
+		// emulate WP_Http::request() internals
+		$requests_response = new Requests_Response();
+
+		$requests_response->cookies['test'] = Requests_Cookie::parse( 'test=foo; domain=.wordpress.org' );
+
+		$requests_response->cookies['test']->flags['host-only'] = false; // https://github.com/rmccue/Requests/issues/306
+
+		$http_response = new WP_HTTP_Requests_Response( $requests_response );
+
+		$response = $http_response->to_array();
+
+		// check the host_only flag in the resulting WP_Http_Cookie
+		$cookie = wp_remote_retrieve_cookie( $response, 'test' );
+		$this->assertEquals( $cookie->domain, 'wordpress.org' );
+		$this->assertFalse( $cookie->host_only, 'host-only flag not set' );
+
+		// regurgitate (Requests_Cookie -> WP_Http_Cookie -> Requests_Cookie)
+		$cookies = WP_Http::normalize_cookies( wp_remote_retrieve_cookies( $response ) );
+		$this->assertFalse( $cookies['test']->flags['host-only'], 'host-only flag data lost' );
+	}
 }
diff --git a/tests/image/base.php b/tests/image/base.php
index e0530e8881..3c32052b63 100644
--- a/tests/image/base.php
+++ b/tests/image/base.php
@@ -75,7 +75,7 @@ abstract class WP_Image_UnitTestCase extends WP_UnitTestCase {
 	protected function assertImageDimensions( $filename, $width, $height ) {
 		$detected_width  = 0;
 		$detected_height = 0;
-		$image_size      = @getimagesize( $filename );
+		$image_size      = getimagesize( $filename );
 
 		if ( isset( $image_size[0] ) ) {
 			$detected_width = $image_size[0];
diff --git a/tests/image/dimensions.php b/tests/image/dimensions.php
index 392524453f..87b494ba87 100644
--- a/tests/image/dimensions.php
+++ b/tests/image/dimensions.php
@@ -129,6 +129,17 @@ class Tests_Image_Dimensions extends WP_UnitTestCase {
 	}
 
 	function test_640x480() {
+		// crop 640x480 to fit 640x480 (no change)
+		$out = image_resize_dimensions( 640, 480, 640, 480, true );
+		$this->assertFalse( $out );
+
+		// resize 640x480 to fit 640x480 (no change)
+		$out = image_resize_dimensions( 640, 480, 640, 480, false );
+		$this->assertFalse( $out );
+
+		// Test with the filter override.
+		add_filter( 'wp_image_resize_identical_dimensions', '__return_true' );
+
 		// crop 640x480 to fit 640x480 (no change)
 		$out = image_resize_dimensions( 640, 480, 640, 480, true );
 		// dst_x, dst_y, src_x, src_y, dst_w, dst_h, src_w, src_h
@@ -138,6 +149,8 @@ class Tests_Image_Dimensions extends WP_UnitTestCase {
 		$out = image_resize_dimensions( 640, 480, 640, 480, false );
 		// dst_x, dst_y, src_x, src_y, dst_w, dst_h, src_w, src_h
 		$this->assertEquals( array( 0, 0, 0, 0, 640, 480, 640, 480 ), $out );
+
+		remove_filter( 'wp_image_resize_identical_dimensions', '__return_true' );
 	}
 
 	/**
diff --git a/tests/image/editor.php b/tests/image/editor.php
index 680070c728..35242ad3e0 100644
--- a/tests/image/editor.php
+++ b/tests/image/editor.php
@@ -130,16 +130,16 @@ class Tests_Image_Editor extends WP_Image_UnitTestCase {
 		);
 
 		// Test with no parameters
-		$this->assertEquals( 'canola-100x50.jpg', basename( $editor->generate_filename() ) );
+		$this->assertEquals( 'canola-100x50.jpg', wp_basename( $editor->generate_filename() ) );
 
 		// Test with a suffix only
-		$this->assertEquals( 'canola-new.jpg', basename( $editor->generate_filename( 'new' ) ) );
+		$this->assertEquals( 'canola-new.jpg', wp_basename( $editor->generate_filename( 'new' ) ) );
 
 		// Test with a destination dir only
 		$this->assertEquals( trailingslashit( realpath( get_temp_dir() ) ), trailingslashit( realpath( dirname( $editor->generate_filename( null, get_temp_dir() ) ) ) ) );
 
 		// Test with a suffix only
-		$this->assertEquals( 'canola-100x50.png', basename( $editor->generate_filename( null, null, 'png' ) ) );
+		$this->assertEquals( 'canola-100x50.png', wp_basename( $editor->generate_filename( null, null, 'png' ) ) );
 
 		// Combo!
 		$this->assertEquals( trailingslashit( realpath( get_temp_dir() ) ) . 'canola-new.png', $editor->generate_filename( 'new', realpath( get_temp_dir() ), 'png' ) );
diff --git a/tests/image/editorImagick.php b/tests/image/editorImagick.php
index f62ad39815..ac531ff942 100644
--- a/tests/image/editorImagick.php
+++ b/tests/image/editorImagick.php
@@ -421,7 +421,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 	 * Test rotating an image 180 deg
 	 */
 	public function test_rotate() {
-		$file = DIR_TESTDATA . '/images/gradient-square.jpg';
+		$file = DIR_TESTDATA . '/images/one-blue-pixel-100x100.png';
 
 		$imagick_image_editor = new WP_Image_Editor_Imagick( $file );
 		$imagick_image_editor->load();
@@ -429,7 +429,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 		$property = new ReflectionProperty( $imagick_image_editor, 'image' );
 		$property->setAccessible( true );
 
-		$color_top_left = $property->getValue( $imagick_image_editor )->getImagePixelColor( 1, 1 )->getColor();
+		$color_top_left = $property->getValue( $imagick_image_editor )->getImagePixelColor( 0, 0 )->getColor();
 
 		$imagick_image_editor->rotate( 180 );
 
@@ -440,7 +440,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 	 * Test flipping an image
 	 */
 	public function test_flip() {
-		$file = DIR_TESTDATA . '/images/gradient-square.jpg';
+		$file = DIR_TESTDATA . '/images/one-blue-pixel-100x100.png';
 
 		$imagick_image_editor = new WP_Image_Editor_Imagick( $file );
 		$imagick_image_editor->load();
@@ -448,7 +448,7 @@ class Tests_Image_Editor_Imagick extends WP_Image_UnitTestCase {
 		$property = new ReflectionProperty( $imagick_image_editor, 'image' );
 		$property->setAccessible( true );
 
-		$color_top_left = $property->getValue( $imagick_image_editor )->getImagePixelColor( 1, 1 )->getColor();
+		$color_top_left = $property->getValue( $imagick_image_editor )->getImagePixelColor( 0, 0 )->getColor();
 
 		$imagick_image_editor->flip( true, false );
 
diff --git a/tests/image/functions.php b/tests/image/functions.php
index 4d385ae2dc..8fa47c65a5 100644
--- a/tests/image/functions.php
+++ b/tests/image/functions.php
@@ -435,10 +435,10 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 
 		$expected = array(
 			'sizes' => array(
-				'thumbnail' => array(
-					'file'      => 'wordpress-gsoc-flyer-pdf-116x150.jpg',
-					'width'     => 116,
-					'height'    => 150,
+				'full'      => array(
+					'file'      => 'wordpress-gsoc-flyer-pdf.jpg',
+					'width'     => 1088,
+					'height'    => 1408,
 					'mime-type' => 'image/jpeg',
 				),
 				'medium'    => array(
@@ -453,10 +453,10 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 					'height'    => 1024,
 					'mime-type' => 'image/jpeg',
 				),
-				'full'      => array(
-					'file'      => 'wordpress-gsoc-flyer-pdf.jpg',
-					'width'     => 1088,
-					'height'    => 1408,
+				'thumbnail' => array(
+					'file'      => 'wordpress-gsoc-flyer-pdf-116x150.jpg',
+					'width'     => 116,
+					'height'    => 150,
 					'mime-type' => 'image/jpeg',
 				),
 			),
@@ -500,10 +500,10 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 
 		$expected = array(
 			'sizes' => array(
-				'thumbnail' => array(
-					'file'      => 'wordpress-gsoc-flyer-pdf-116x150.jpg',
-					'width'     => 116,
-					'height'    => 150,
+				'full'      => array(
+					'file'      => 'wordpress-gsoc-flyer-pdf.jpg',
+					'width'     => 1088,
+					'height'    => 1408,
 					'mime-type' => 'image/jpeg',
 				),
 				'medium'    => array(
@@ -518,10 +518,10 @@ class Tests_Image_Functions extends WP_UnitTestCase {
 					'height'    => 1024,
 					'mime-type' => 'image/jpeg',
 				),
-				'full'      => array(
-					'file'      => 'wordpress-gsoc-flyer-pdf.jpg',
-					'width'     => 1088,
-					'height'    => 1408,
+				'thumbnail' => array(
+					'file'      => 'wordpress-gsoc-flyer-pdf-116x150.jpg',
+					'width'     => 116,
+					'height'    => 150,
 					'mime-type' => 'image/jpeg',
 				),
 			),
diff --git a/tests/image/header.php b/tests/image/header.php
index e9bdcde344..b166d0e2bb 100644
--- a/tests/image/header.php
+++ b/tests/image/header.php
@@ -1,5 +1,5 @@
 <?php
-require_once( ABSPATH . 'wp-admin/custom-header.php' );
+require_once( ABSPATH . 'wp-admin/includes/class-custom-image-header.php' );
 
 /**
  * @group image
diff --git a/tests/image/intermediateSize.php b/tests/image/intermediateSize.php
index 95ee173edd..ec0b818a9e 100644
--- a/tests/image/intermediateSize.php
+++ b/tests/image/intermediateSize.php
@@ -17,7 +17,7 @@ class Tests_Image_Intermediate_Size extends WP_UnitTestCase {
 
 	public function _make_attachment( $file, $parent_post_id = 0 ) {
 		$contents = file_get_contents( $file );
-		$upload   = wp_upload_bits( basename( $file ), null, $contents );
+		$upload   = wp_upload_bits( wp_basename( $file ), null, $contents );
 
 		return parent::_make_attachment( $upload, $parent_post_id );
 	}
diff --git a/tests/image/resize.php b/tests/image/resize.php
index 003f50e3ad..2cbd5a2505 100644
--- a/tests/image/resize.php
+++ b/tests/image/resize.php
@@ -29,7 +29,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_jpg() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/test-image.jpg', 25, 25 );
 
-		$this->assertEquals( 'test-image-25x25.jpg', basename( $image ) );
+		$this->assertEquals( 'test-image-25x25.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 25, $w );
 		$this->assertEquals( 25, $h );
@@ -45,7 +45,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 			$this->fail( sprintf( 'No PNG support in the editor engine %s on this system', $this->editor_engine ) );
 		}
 
-		$this->assertEquals( 'test-image-25x25.png', basename( $image ) );
+		$this->assertEquals( 'test-image-25x25.png', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 25, $w );
 		$this->assertEquals( 25, $h );
@@ -61,7 +61,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 			$this->fail( sprintf( 'No GIF support in the editor engine %s on this system', $this->editor_engine ) );
 		}
 
-		$this->assertEquals( 'test-image-25x25.gif', basename( $image ) );
+		$this->assertEquals( 'test-image-25x25.gif', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 25, $w );
 		$this->assertEquals( 25, $h );
@@ -81,7 +81,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_thumb_128x96() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 128, 96 );
 
-		$this->assertEquals( '2007-06-17DSC_4173-64x96.jpg', basename( $image ) );
+		$this->assertEquals( '2007-06-17DSC_4173-64x96.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 64, $w );
 		$this->assertEquals( 96, $h );
@@ -93,7 +93,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_thumb_128x0() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 128, 0 );
 
-		$this->assertEquals( '2007-06-17DSC_4173-128x193.jpg', basename( $image ) );
+		$this->assertEquals( '2007-06-17DSC_4173-128x193.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 128, $w );
 		$this->assertEquals( 193, $h );
@@ -105,7 +105,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_thumb_0x96() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 0, 96 );
 
-		$this->assertEquals( '2007-06-17DSC_4173-64x96.jpg', basename( $image ) );
+		$this->assertEquals( '2007-06-17DSC_4173-64x96.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 64, $w );
 		$this->assertEquals( 96, $h );
@@ -117,7 +117,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_thumb_150x150_crop() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 150, 150, true );
 
-		$this->assertEquals( '2007-06-17DSC_4173-150x150.jpg', basename( $image ) );
+		$this->assertEquals( '2007-06-17DSC_4173-150x150.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 150, $w );
 		$this->assertEquals( 150, $h );
@@ -129,7 +129,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_thumb_150x100_crop() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 150, 100, true );
 
-		$this->assertEquals( '2007-06-17DSC_4173-150x100.jpg', basename( $image ) );
+		$this->assertEquals( '2007-06-17DSC_4173-150x100.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 150, $w );
 		$this->assertEquals( 100, $h );
@@ -141,7 +141,7 @@ abstract class WP_Tests_Image_Resize_UnitTestCase extends WP_Image_UnitTestCase
 	function test_resize_thumb_50x150_crop() {
 		$image = $this->resize_helper( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG', 50, 150, true );
 
-		$this->assertEquals( '2007-06-17DSC_4173-50x150.jpg', basename( $image ) );
+		$this->assertEquals( '2007-06-17DSC_4173-50x150.jpg', wp_basename( $image ) );
 		list($w, $h, $type) = getimagesize( $image );
 		$this->assertEquals( 50, $w );
 		$this->assertEquals( 150, $h );
diff --git a/tests/image/siteIcon.php b/tests/image/siteIcon.php
index 509b69f975..dad3ddba52 100644
--- a/tests/image/siteIcon.php
+++ b/tests/image/siteIcon.php
@@ -55,7 +55,7 @@ class Tests_WP_Site_Icon extends WP_UnitTestCase {
 		$this->assertEquals( $sizes, $image_sizes );
 
 		// Remove custom size.
-		unset( $this->wp_site_icon->site_icon_sizes[ array_search( 321, $this->wp_site_icon->site_icon_sizes ) ] );
+		unset( $this->wp_site_icon->site_icon_sizes[ array_search( 321, $this->wp_site_icon->site_icon_sizes, true ) ] );
 		// Remove the filter we added
 		remove_filter( 'site_icon_image_sizes', array( $this, '_custom_test_sizes' ) );
 	}
@@ -95,13 +95,13 @@ class Tests_WP_Site_Icon extends WP_UnitTestCase {
 		$this->assertEquals( $sizes, $image_sizes );
 
 		// Remove custom size.
-		unset( $this->wp_site_icon->site_icon_sizes[ array_search( 321, $this->wp_site_icon->site_icon_sizes ) ] );
+		unset( $this->wp_site_icon->site_icon_sizes[ array_search( 321, $this->wp_site_icon->site_icon_sizes, true ) ] );
 	}
 
 	function test_create_attachment_object() {
 		$attachment_id = $this->_insert_attachment();
 		$parent_url    = get_post( $attachment_id )->guid;
-		$cropped       = str_replace( basename( $parent_url ), 'cropped-test-image.jpg', $parent_url );
+		$cropped       = str_replace( wp_basename( $parent_url ), 'cropped-test-image.jpg', $parent_url );
 
 		$object = $this->wp_site_icon->create_attachment_object( $cropped, $attachment_id );
 
@@ -115,7 +115,7 @@ class Tests_WP_Site_Icon extends WP_UnitTestCase {
 	function test_insert_cropped_attachment() {
 		$attachment_id = $this->_insert_attachment();
 		$parent_url    = get_post( $attachment_id )->guid;
-		$cropped       = str_replace( basename( $parent_url ), 'cropped-test-image.jpg', $parent_url );
+		$cropped       = str_replace( wp_basename( $parent_url ), 'cropped-test-image.jpg', $parent_url );
 
 		$object     = $this->wp_site_icon->create_attachment_object( $cropped, $attachment_id );
 		$cropped_id = $this->wp_site_icon->insert_attachment( $object, $cropped );
@@ -163,7 +163,7 @@ class Tests_WP_Site_Icon extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 
 		$this->attachment_id = $this->_make_attachment( $upload );
 		return $this->attachment_id;
diff --git a/tests/import/base.php b/tests/import/base.php
index 45ec430743..5897ce55fb 100644
--- a/tests/import/base.php
+++ b/tests/import/base.php
@@ -27,7 +27,9 @@ abstract class WP_Import_UnitTestCase extends WP_UnitTestCase {
 		$this->assertTrue( ! empty( $file ), 'Path to import file is empty.' );
 		$this->assertTrue( is_file( $file ), 'Import file is not a file.' );
 
-		$authors = $mapping = $new = array();
+		$authors = array();
+		$mapping = array();
+		$new     = array();
 		$i       = 0;
 
 		// each user is either mapped to a given ID, mapped to a new user
diff --git a/tests/import/import.php b/tests/import/import.php
index 0b85d261d4..e005826a18 100644
--- a/tests/import/import.php
+++ b/tests/import/import.php
@@ -28,6 +28,7 @@ class Tests_Import_Import extends WP_Import_UnitTestCase {
 		global $wpdb;
 		// crude but effective: make sure there's no residual data in the main tables
 		foreach ( array( 'posts', 'postmeta', 'comments', 'terms', 'term_taxonomy', 'term_relationships', 'users', 'usermeta' ) as $table ) {
+			// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 			$wpdb->query( "DELETE FROM {$wpdb->$table}" );
 		}
 	}
diff --git a/tests/includes/helpers.php b/tests/includes/helpers.php
index 6e488b72f2..d96207606b 100644
--- a/tests/includes/helpers.php
+++ b/tests/includes/helpers.php
@@ -274,6 +274,18 @@ class Tests_TestHelpers extends WP_UnitTestCase {
 		wp_die( new WP_Error( 'test', 'test' ) );
 	}
 
+	/**
+	 * @ticket 46813
+	 * @expectedException WPDieException
+	 */
+	public function test_die_handler_should_not_cause_doing_it_wrong_notice_without_wp_query_set() {
+		unset( $GLOBALS['wp_query'] );
+
+		wp_die();
+
+		$this->assertEmpty( $this->caught_doing_it_wrong );
+	}
+
 	/**
 	 * @ticket 45933
 	 * @dataProvider data_die_process_input
diff --git a/tests/kses.php b/tests/kses.php
index b359452b88..051897c07f 100644
--- a/tests/kses.php
+++ b/tests/kses.php
@@ -54,7 +54,8 @@ class Tests_Kses extends WP_UnitTestCase {
 				$attr          = "$name='$value'";
 				$expected_attr = "$name='" . trim( $value, ';' ) . "'";
 			} else {
-				$attr = $expected_attr = $name;
+				$attr          = $name;
+				$expected_attr = $name;
 			}
 			$string        = "<a $attr>I link this</a>";
 			$expect_string = "<a $expected_attr>I link this</a>";
@@ -144,10 +145,12 @@ EOF;
 			'javascript&#0000058alert(1)//?:',
 			'feed:javascript:alert(1)',
 			'feed:javascript:feed:javascript:feed:javascript:alert(1)',
+			'javascript&#58alert(1)',
+			'javascript&#x3ax=1;alert(1)',
 		);
 		foreach ( $bad as $k => $x ) {
 			$result = wp_kses_bad_protocol( wp_kses_normalize_entities( $x ), wp_allowed_protocols() );
-			if ( ! empty( $result ) && $result != 'alert(1);' && $result != 'alert(1)' ) {
+			if ( ! empty( $result ) && 'alert(1);' !== $result && 'alert(1)' !== $result ) {
 				switch ( $k ) {
 					case 6:
 						$this->assertEquals( 'javascript&amp;#0000058alert(1);', $result );
@@ -164,8 +167,14 @@ EOF;
 					case 24:
 						$this->assertEquals( 'feed:alert(1)', $result );
 						break;
+					case 26:
+						$this->assertEquals( 'javascript&amp;#58alert(1)', $result );
+						break;
+					case 27:
+						$this->assertEquals( 'javascript&amp;#x3ax=1;alert(1)', $result );
+						break;
 					default:
-						$this->fail( "wp_kses_bad_protocol failed on $x. Result: $result" );
+						$this->fail( "wp_kses_bad_protocol failed on $k, $x. Result: $result" );
 				}
 			}
 		}
@@ -182,7 +191,7 @@ EOF;
 		);
 		foreach ( $safe as $x ) {
 			$result = wp_kses_bad_protocol( wp_kses_normalize_entities( $x ), array( 'http', 'https', 'dummy' ) );
-			if ( $result != $x && $result != 'http://example.org/' ) {
+			if ( $result !== $x && 'http://example.org/' !== $result ) {
 				$this->fail( "wp_kses_bad_protocol incorrectly blocked $x" );
 			}
 		}
@@ -191,17 +200,17 @@ EOF;
 	public function test_hackers_attacks() {
 		$xss = simplexml_load_file( DIR_TESTDATA . '/formatting/xssAttacks.xml' );
 		foreach ( $xss->attack as $attack ) {
-			if ( in_array( $attack->name, array( 'IMG Embedded commands 2', 'US-ASCII encoding', 'OBJECT w/Flash 2', 'Character Encoding Example' ) ) ) {
+			if ( in_array( (string) $attack->name, array( 'IMG Embedded commands 2', 'US-ASCII encoding', 'OBJECT w/Flash 2', 'Character Encoding Example' ), true ) ) {
 				continue;
 			}
 
 			$code = (string) $attack->code;
 
-			if ( $code == 'See Below' ) {
+			if ( 'See Below' === $code ) {
 				continue;
 			}
 
-			if ( substr( $code, 0, 4 ) == 'perl' ) {
+			if ( substr( $code, 0, 4 ) === 'perl' ) {
 				$pos  = strpos( $code, '"' ) + 1;
 				$code = substr( $code, $pos, strrpos( $code, '"' ) - $pos );
 				$code = str_replace( '\0', "\0", $code );
@@ -209,7 +218,7 @@ EOF;
 
 			$result = trim( wp_kses_data( $code ) );
 
-			if ( $result == '' || $result == 'XSS' || $result == 'alert("XSS");' || $result == "alert('XSS');" ) {
+			if ( in_array( $result, array( '', 'XSS', 'alert("XSS");', "alert('XSS');" ), true ) ) {
 				continue;
 			}
 
@@ -323,7 +332,7 @@ EOF;
 	}
 
 	function _wp_kses_allowed_html_filter( $html, $context ) {
-		if ( 'post' == $context ) {
+		if ( 'post' === $context ) {
 			return array( 'a' => array( 'href' => true ) );
 		} else {
 			return array( 'a' => array( 'href' => false ) );
@@ -830,6 +839,45 @@ EOF;
 				'css'      => 'background: green url("foo.jpg") no-repeat fixed center',
 				'expected' => 'background: green url("foo.jpg") no-repeat fixed center',
 			),
+			// Additional background attributes introduced in 5.3.
+			array(
+				'css'      => 'background-size: cover;background-size: 200px 100px;background-attachment: local, scroll;background-blend-mode: hard-light',
+				'expected' => 'background-size: cover;background-size: 200px 100px;background-attachment: local, scroll;background-blend-mode: hard-light',
+			),
+			// `border-radius` attribute introduced in 5.3.
+			array(
+				'css'      => 'border-radius: 10% 30% 50% 70%;border-radius: 30px',
+				'expected' => 'border-radius: 10% 30% 50% 70%;border-radius: 30px',
+			),
+			// `flex` and related attributes introduced in 5.3.
+			array(
+				'css'      => 'flex: 0 1 auto;flex-basis: 75%;flex-direction: row-reverse;flex-flow: row-reverse nowrap;flex-grow: 2;flex-shrink: 1',
+				'expected' => 'flex: 0 1 auto;flex-basis: 75%;flex-direction: row-reverse;flex-flow: row-reverse nowrap;flex-grow: 2;flex-shrink: 1',
+			),
+			// `grid` and related attributes introduced in 5.3.
+			array(
+				'css'      => 'grid-template-columns: 1fr 60px;grid-auto-columns: min-content;grid-column-start: span 2;grid-column-end: -1;grid-column-gap: 10%;grid-gap: 10px 20px',
+				'expected' => 'grid-template-columns: 1fr 60px;grid-auto-columns: min-content;grid-column-start: span 2;grid-column-end: -1;grid-column-gap: 10%;grid-gap: 10px 20px',
+			),
+			array(
+				'css'      => 'grid-template-rows: 40px 4em 40px;grid-auto-rows: min-content;grid-row-start: -1;grid-row-end: 3;grid-row-gap: 1em',
+				'expected' => 'grid-template-rows: 40px 4em 40px;grid-auto-rows: min-content;grid-row-start: -1;grid-row-end: 3;grid-row-gap: 1em',
+			),
+			// `grid` does not yet support functions or `\`.
+			array(
+				'css'      => 'grid-template-columns: repeat(2, 50px 1fr);grid-template: 1em / 20% 20px 1fr',
+				'expected' => '',
+			),
+			// `flex` and `grid` alignments introduced in 5.3.
+			array(
+				'css'      => 'align-content: space-between;align-items: start;align-self: center;justify-items: center;justify-content: space-between;justify-self: end',
+				'expected' => 'align-content: space-between;align-items: start;align-self: center;justify-items: center;justify-content: space-between;justify-self: end',
+			),
+			// `columns` and related attributes introduced in 5.3.
+			array(
+				'css'      => 'columns: 6rem auto;column-count: 4;column-fill: balance;column-gap: 9px;column-rule: thick inset blue;column-span: none;column-width: 120px',
+				'expected' => 'columns: 6rem auto;column-count: 4;column-fill: balance;column-gap: 9px;column-rule: thick inset blue;column-span: none;column-width: 120px',
+			),
 		);
 	}
 
diff --git a/tests/l10n.php b/tests/l10n.php
index 45a6008363..7c8e492fc5 100644
--- a/tests/l10n.php
+++ b/tests/l10n.php
@@ -6,6 +6,15 @@
  */
 class Tests_L10n extends WP_UnitTestCase {
 
+	/**
+	 * Long Dummy Text.
+	 *
+	 * @since 5.0.0
+	 *
+	 * @var string $long_text
+	 */
+	private $long_text = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.';
+
 	/**
 	 * @ticket 35961
 	 */
@@ -66,16 +75,16 @@ class Tests_L10n extends WP_UnitTestCase {
 		$this->assertEqualSets( $textdomains_expected, array_keys( $installed_translations ) );
 
 		$this->assertNotEmpty( $installed_translations['default']['en_GB'] );
-		$data_en_GB = $installed_translations['default']['en_GB'];
-		$this->assertEquals( '2016-10-26 00:01+0200', $data_en_GB['PO-Revision-Date'] );
-		$this->assertEquals( 'Development (4.4.x)', $data_en_GB['Project-Id-Version'] );
-		$this->assertEquals( 'Poedit 1.8.10', $data_en_GB['X-Generator'] );
+		$data_en_gb = $installed_translations['default']['en_GB'];
+		$this->assertEquals( '2016-10-26 00:01+0200', $data_en_gb['PO-Revision-Date'] );
+		$this->assertEquals( 'Development (4.4.x)', $data_en_gb['Project-Id-Version'] );
+		$this->assertEquals( 'Poedit 1.8.10', $data_en_gb['X-Generator'] );
 
 		$this->assertNotEmpty( $installed_translations['admin']['es_ES'] );
-		$data_es_ES = $installed_translations['admin']['es_ES'];
-		$this->assertEquals( '2016-10-25 18:29+0200', $data_es_ES['PO-Revision-Date'] );
-		$this->assertEquals( 'Administration', $data_es_ES['Project-Id-Version'] );
-		$this->assertEquals( 'Poedit 1.8.10', $data_es_ES['X-Generator'] );
+		$data_es_es = $installed_translations['admin']['es_ES'];
+		$this->assertEquals( '2016-10-25 18:29+0200', $data_es_es['PO-Revision-Date'] );
+		$this->assertEquals( 'Administration', $data_es_es['Project-Id-Version'] );
+		$this->assertEquals( 'Poedit 1.8.10', $data_es_es['X-Generator'] );
 	}
 
 	/**
@@ -260,4 +269,251 @@ class Tests_L10n extends WP_UnitTestCase {
 		$this->assertNotEmpty( $array['Project-Id-Version'] );
 		$this->assertNotEmpty( $array['X-Generator'] );
 	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_excerpt_should_be_counted_by_words() {
+		global $post;
+
+		switch_to_locale( 'en_US' );
+
+		$args = array(
+			'post_content' => $this->long_text,
+			'post_excerpt' => '',
+		);
+
+		$post = $this->factory()->post->create_and_get( $args );
+		setup_postdata( $post );
+
+		$expect = "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat [&hellip;]</p>\n";
+		the_excerpt();
+
+		restore_previous_locale();
+
+		$this->expectOutputString( $expect );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_excerpt_should_be_counted_by_chars() {
+		global $post;
+
+		switch_to_locale( 'ja_JP' );
+
+		$args = array(
+			'post_content' => $this->long_text,
+			'post_excerpt' => '',
+		);
+
+		$post = $this->factory()->post->create_and_get( $args );
+		setup_postdata( $post );
+
+		$expect = "<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore  [&hellip;]</p>\n";
+		the_excerpt();
+
+		restore_previous_locale();
+
+		$this->expectOutputString( $expect );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_excerpt_should_be_counted_by_chars_in_japanese() {
+		global $post;
+
+		switch_to_locale( 'ja_JP' );
+
+		$args = array(
+			'post_content' => str_repeat( '', 200 ),
+			'post_excerpt' => '',
+		);
+
+		$post = $this->factory()->post->create_and_get( $args );
+		setup_postdata( $post );
+
+		$expect = '<p>' . str_repeat( '', 110 ) . " [&hellip;]</p>\n";
+		the_excerpt();
+
+		restore_previous_locale();
+
+		$this->expectOutputString( $expect );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_excerpt_rss_should_be_counted_by_words() {
+		global $post;
+
+		switch_to_locale( 'en_US' );
+
+		$args = array(
+			'post_content' => $this->long_text,
+			'post_excerpt' => '',
+		);
+
+		$post = $this->factory()->post->create_and_get( $args );
+		setup_postdata( $post );
+
+		$expect = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat [&#8230;]';
+		the_excerpt_rss();
+
+		restore_previous_locale();
+
+		$this->expectOutputString( $expect );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_excerpt_rss_should_be_counted_by_chars() {
+		global $post;
+
+		switch_to_locale( 'ja_JP' );
+
+		$args = array(
+			'post_content' => $this->long_text,
+			'post_excerpt' => '',
+		);
+
+		$post = $this->factory()->post->create_and_get( $args );
+		setup_postdata( $post );
+
+		$expect = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore  [&#8230;]';
+
+		the_excerpt_rss();
+
+		restore_previous_locale();
+
+		$this->expectOutputString( $expect );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_draft_should_be_counted_by_words() {
+		require_once ABSPATH . 'wp-admin/includes/dashboard.php';
+
+		switch_to_locale( 'en_US' );
+
+		$args = array(
+			'post_content' => $this->long_text,
+			'post_excerpt' => '',
+			'post_status'  => 'draft',
+		);
+
+		$this->factory()->post->create( $args );
+
+		$expect = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do&hellip;';
+		wp_dashboard_recent_drafts();
+
+		restore_previous_locale();
+
+		$this->expectOutputRegex( '/' . $expect . '/' );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_draft_should_be_counted_by_chars() {
+		require_once ABSPATH . 'wp-admin/includes/dashboard.php';
+
+		switch_to_locale( 'ja_JP' );
+
+		$args = array(
+			'post_content' => $this->long_text,
+			'post_excerpt' => '',
+			'post_status'  => 'draft',
+		);
+
+		$post = $this->factory()->post->create( $args );
+
+		$expect = 'Lorem ipsum dolor sit amet, consectetur &hellip;';
+		wp_dashboard_recent_drafts();
+
+		restore_previous_locale();
+
+		$this->expectOutputRegex( '/' . $expect . '/' );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_draft_should_be_counted_by_chars_in_japanese() {
+		require_once ABSPATH . 'wp-admin/includes/dashboard.php';
+
+		switch_to_locale( 'ja_JP' );
+
+		$args = array(
+			'post_content' => str_repeat( '', 200 ),
+			'post_excerpt' => '',
+			'post_status'  => 'draft',
+		);
+
+		$this->factory()->post->create( $args );
+
+		$expect = str_repeat( '', 40 ) . '&hellip;';
+		wp_dashboard_recent_drafts();
+
+		restore_previous_locale();
+
+		$this->expectOutputRegex( '/' . $expect . '/' );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_comment_excerpt_should_be_counted_by_words() {
+		switch_to_locale( 'en_US' );
+
+		$args            = array(
+			'comment_content' => $this->long_text,
+		);
+		$comment_id      = $this->factory()->comment->create( $args );
+		$expect          = 'Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut&hellip;';
+		$comment_excerpt = get_comment_excerpt( $comment_id );
+
+		restore_previous_locale();
+
+		$this->assertSame( $expect, $comment_excerpt );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_comment_excerpt_should_be_counted_by_chars() {
+		switch_to_locale( 'ja_JP' );
+
+		$args            = array(
+			'comment_content' => $this->long_text,
+		);
+		$comment_id      = $this->factory()->comment->create( $args );
+		$expect          = 'Lorem ipsum dolor sit amet, consectetur &hellip;';
+		$comment_excerpt = get_comment_excerpt( $comment_id );
+
+		restore_previous_locale();
+
+		$this->assertSame( $expect, $comment_excerpt );
+	}
+
+	/**
+	 * @ticket 44541
+	 */
+	function test_length_of_comment_excerpt_should_be_counted_by_chars_in_Japanese() {
+		switch_to_locale( 'ja_JP' );
+
+		$args            = array(
+			'comment_content' => str_repeat( '', 200 ),
+		);
+		$comment_id      = $this->factory()->comment->create( $args );
+		$expect          = str_repeat( '', 40 ) . '&hellip;';
+		$comment_excerpt = get_comment_excerpt( $comment_id );
+
+		restore_previous_locale();
+
+		$this->assertSame( $expect, $comment_excerpt );
+	}
 }
diff --git a/tests/l10n/loadScriptTextdomain.php b/tests/l10n/loadScriptTextdomain.php
index 73bc53b333..310cc72bea 100644
--- a/tests/l10n/loadScriptTextdomain.php
+++ b/tests/l10n/loadScriptTextdomain.php
@@ -17,6 +17,14 @@ class Tests_L10n_loadScriptTextdomain extends WP_UnitTestCase {
 		return $relative;
 	}
 
+	public function plugins_url_custom_domain() {
+		return 'https://plugins.example.com';
+	}
+
+	public function content_url_custom_domain_with_no_path() {
+		return 'https://content.example.com';
+	}
+
 	/**
 	 * @ticket 45528
 	 */
@@ -38,4 +46,28 @@ class Tests_L10n_loadScriptTextdomain extends WP_UnitTestCase {
 		$this->assertEquals( $json_translations, load_script_textdomain( 'test-example-subdir', 'default', DIR_TESTDATA . '/languages' ) );
 		remove_filter( 'site_url', array( $this, 'site_url_subdirectory' ) );
 	}
+
+	/**
+	 * @ticket 46336
+	 */
+	public function test_resolve_relative_path_custom_plugins_url() {
+		$json_translations = file_get_contents( DIR_TESTDATA . '/languages/plugins/internationalized-plugin-en_US-2f86cb96a0233e7cb3b6f03ad573be0b.json' );
+
+		add_filter( 'plugins_url', array( $this, 'plugins_url_custom_domain' ) );
+		wp_enqueue_script( 'plugin-example-1', 'https://plugins.example.com/my-plugin/js/script.js', array(), null );
+		$this->assertEquals( $json_translations, load_script_textdomain( 'plugin-example-1', 'internationalized-plugin', DIR_TESTDATA . '/languages' ) );
+		remove_filter( 'plugins_url', array( $this, 'plugins_url_custom_domain' ) );
+	}
+
+	/**
+	 * @ticket 46387
+	 */
+	public function test_resolve_relative_path_custom_content_url() {
+		$json_translations = file_get_contents( DIR_TESTDATA . '/languages/plugins/internationalized-plugin-en_US-2f86cb96a0233e7cb3b6f03ad573be0b.json' );
+
+		add_filter( 'content_url', array( $this, 'content_url_custom_domain_with_no_path' ) );
+		wp_enqueue_script( 'plugin-example-2', 'https://content.example.com/plugins/my-plugin/js/script.js', array(), null );
+		$this->assertEquals( $json_translations, load_script_textdomain( 'plugin-example-2', 'internationalized-plugin', DIR_TESTDATA . '/languages' ) );
+		remove_filter( 'content_url', array( $this, 'content_url_custom_domain_with_no_path' ) );
+	}
 }
diff --git a/tests/l10n/loadTextdomainJustInTime.php b/tests/l10n/loadTextdomainJustInTime.php
index 7fb85a5427..ea35bbfcfd 100644
--- a/tests/l10n/loadTextdomainJustInTime.php
+++ b/tests/l10n/loadTextdomainJustInTime.php
@@ -175,15 +175,15 @@ class Tests_L10n_loadTextdomainJustInTime extends WP_UnitTestCase {
 		require_once DIR_TESTDATA . '/plugins/internationalized-plugin.php';
 
 		switch_to_locale( 'de_DE' );
-		$expected_de_DE = i18n_plugin_test();
+		$expected_de_de = i18n_plugin_test();
 
 		switch_to_locale( 'es_ES' );
-		$expected_es_ES = i18n_plugin_test();
+		$expected_es_es = i18n_plugin_test();
 
 		restore_current_locale();
 
-		$this->assertSame( 'Das ist ein Dummy Plugin', $expected_de_DE );
-		$this->assertSame( 'This is a dummy plugin', $expected_es_ES );
+		$this->assertSame( 'Das ist ein Dummy Plugin', $expected_de_de );
+		$this->assertSame( 'This is a dummy plugin', $expected_es_es );
 	}
 
 	/**
diff --git a/tests/l10n/localeSwitcher.php b/tests/l10n/localeSwitcher.php
index f100c8a1db..0621092165 100644
--- a/tests/l10n/localeSwitcher.php
+++ b/tests/l10n/localeSwitcher.php
@@ -86,25 +86,25 @@ class Tests_Locale_Switcher extends WP_UnitTestCase {
 
 		switch_to_locale( 'de_DE' );
 
-		$wp_locale_de_DE = clone $wp_locale;
+		$wp_locale_de_de = clone $wp_locale;
 
 		// Cleanup.
 		restore_previous_locale();
 
-		$this->assertEqualSetsWithIndex( $expected, $wp_locale_de_DE->number_format );
+		$this->assertEqualSetsWithIndex( $expected, $wp_locale_de_de->number_format );
 	}
 
 	public function test_switch_to_locale_en_US() {
 		switch_to_locale( 'en_GB' );
-		$locale_en_GB = get_locale();
+		$locale_en_gb = get_locale();
 		switch_to_locale( 'en_US' );
-		$locale_en_US = get_locale();
+		$locale_en_us = get_locale();
 
 		// Cleanup.
 		restore_current_locale();
 
-		$this->assertSame( 'en_GB', $locale_en_GB );
-		$this->assertSame( 'en_US', $locale_en_US );
+		$this->assertSame( 'en_GB', $locale_en_gb );
+		$this->assertSame( 'en_US', $locale_en_us );
 	}
 
 	public function test_switch_to_locale_multiple_times() {
diff --git a/tests/link/themeFile.php b/tests/link/themeFile.php
index fe0dbcfe42..9497b71e14 100644
--- a/tests/link/themeFile.php
+++ b/tests/link/themeFile.php
@@ -8,9 +8,11 @@ class Test_Theme_File extends WP_UnitTestCase {
 		if ( ! function_exists( 'symlink' ) ) {
 			self::markTestSkipped( 'symlink() is not available.' );
 		}
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 		if ( ! @symlink( DIR_TESTDATA . '/theme-file-parent', WP_CONTENT_DIR . '/themes/theme-file-parent' ) ) {
 			self::markTestSkipped( 'Could not create parent symlink.' );
 		}
+		// phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged
 		if ( ! @symlink( DIR_TESTDATA . '/theme-file-child', WP_CONTENT_DIR . '/themes/theme-file-child' ) ) {
 			self::markTestSkipped( 'Could not create child symlink.' );
 		}
diff --git a/tests/locale.php b/tests/locale.php
index 4788d57d90..9790ca14bf 100644
--- a/tests/locale.php
+++ b/tests/locale.php
@@ -15,11 +15,6 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->locale = new WP_Locale();
 	}
 
-	public function test_rtl_src_admin_notice() {
-		$this->expectOutputRegex( '#<div class="error"><p>.*</p></div>#' );
-		$this->locale->rtl_src_admin_notice();
-	}
-
 	public function test_get_weekday() {
 		$this->assertEquals( __( 'Sunday' ), $this->locale->get_weekday( 0 ) );
 		$this->assertEquals( __( 'Monday' ), $this->locale->get_weekday( 1 ) );
diff --git a/tests/mail.php b/tests/mail.php
index 951615136b..39c6036d2c 100644
--- a/tests/mail.php
+++ b/tests/mail.php
@@ -273,6 +273,22 @@ class Tests_Mail extends WP_UnitTestCase {
 		$this->assertTrue( strpos( $mailer->get_sent()->header, $expected ) > 0 );
 	}
 
+	/**
+	 * @ticket 43542
+	 */
+	public function test_wp_mail_does_not_duplicate_mime_version_header() {
+		$to       = 'user@example.com';
+		$subject  = 'Test email with a MIME-Version header';
+		$message  = 'The MIME-Version header should not be duplicated.';
+		$headers  = 'MIME-Version: 1.0';
+		$expected = 'MIME-Version: 1.0';
+
+		wp_mail( $to, $subject, $message, $headers );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+		$this->assertEquals( 1, substr_count( $mailer->get_sent()->header, $expected ) );
+	}
+
 	function wp_mail_quoted_printable( $mailer ) {
 		$mailer->Encoding = 'quoted-printable';
 	}
diff --git a/tests/media.php b/tests/media.php
index d9c34e5b9d..26d8468bc2 100644
--- a/tests/media.php
+++ b/tests/media.php
@@ -1249,14 +1249,14 @@ Stop.</p>
 EOF;
 
 		$result = apply_filters( 'the_content', $content );
-		$this->assertEquals( $expected, $result );
+		$this->assertEqualsIgnoreEOL( $expected, $result );
 	}
 
 	/**
 	 * @ticket 33016
 	 */
 	function filter_wp_embed_shortcode_custom( $content, $url ) {
-		if ( 'https://www.example.com/?video=1' == $url ) {
+		if ( 'https://www.example.com/?video=1' === $url ) {
 			$content = '@embed URL was replaced@';
 		}
 		return $content;
@@ -1428,7 +1428,7 @@ EOF;
 	function test_wp_calculate_image_srcset() {
 		$_wp_additional_image_sizes = wp_get_additional_image_sizes();
 
-		$year_month      = date( 'Y/m' );
+		$year_month      = gmdate( 'Y/m' );
 		$image_meta      = wp_get_attachment_metadata( self::$large_id );
 		$uploads_dir_url = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/';
 
@@ -1446,7 +1446,7 @@ EOF;
 
 		foreach ( $image_meta['sizes'] as $name => $size ) {
 			// Whitelist the sizes that should be included so we pick up 'medium_large' in 4.4.
-			if ( in_array( $name, $intermediates ) ) {
+			if ( in_array( $name, $intermediates, true ) ) {
 				$expected .= $uploads_dir_url . $year_month . '/' . $size['file'] . ' ' . $size['width'] . 'w, ';
 			}
 		}
@@ -1491,7 +1491,7 @@ EOF;
 
 		foreach ( $image_meta['sizes'] as $name => $size ) {
 			// Whitelist the sizes that should be included so we pick up 'medium_large' in 4.4.
-			if ( in_array( $name, $intermediates ) ) {
+			if ( in_array( $name, $intermediates, true ) ) {
 				$expected .= $uploads_dir_url . $size['file'] . ' ' . $size['width'] . 'w, ';
 			}
 		}
@@ -1524,7 +1524,7 @@ EOF;
 		// Copy hash generation method used in wp_save_image().
 		$hash = 'e' . time() . rand( 100, 999 );
 
-		$filename_base = basename( $image_meta['file'], '.png' );
+		$filename_base = wp_basename( $image_meta['file'], '.png' );
 
 		// Add the hash to the image URL
 		$image_url = str_replace( $filename_base, $filename_base . '-' . $hash, $image_url );
@@ -1550,7 +1550,7 @@ EOF;
 	function test_wp_calculate_image_srcset_with_absolute_path_in_meta() {
 		$_wp_additional_image_sizes = wp_get_additional_image_sizes();
 
-		$year_month      = date( 'Y/m' );
+		$year_month      = gmdate( 'Y/m' );
 		$image_meta      = wp_get_attachment_metadata( self::$large_id );
 		$uploads_dir_url = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/';
 
@@ -1568,7 +1568,7 @@ EOF;
 
 		foreach ( $image_meta['sizes'] as $name => $size ) {
 			// Whitelist the sizes that should be included so we pick up 'medium_large' in 4.4.
-			if ( in_array( $name, $intermediates ) ) {
+			if ( in_array( $name, $intermediates, true ) ) {
 				$expected .= $uploads_dir_url . $year_month . '/' . $size['file'] . ' ' . $size['width'] . 'w, ';
 			}
 		}
@@ -1784,8 +1784,8 @@ EOF;
 		// Mock data for this test.
 		$image_src  = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/2015/12/test image-300x150.png';
 		$image_meta = array(
-			'width'  => 2000,
-			'height' => 1000,
+			'width'  => 3000,
+			'height' => 1500,
 			'file'   => '2015/12/test image.png',
 			'sizes'  => array(
 				'thumbnail'    => array(
@@ -1831,7 +1831,7 @@ EOF;
 
 		$srcset = wp_get_attachment_image_srcset( self::$large_id, $size_array, $image_meta );
 
-		$year_month  = date( 'Y/m' );
+		$year_month  = gmdate( 'Y/m' );
 		$uploads_dir = 'http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/';
 
 		// Set up test cases for all expected size names.
@@ -1847,7 +1847,7 @@ EOF;
 
 		foreach ( $image_meta['sizes'] as $name => $size ) {
 			// Whitelist the sizes that should be included so we pick up 'medium_large' in 4.4.
-			if ( in_array( $name, $intermediates ) ) {
+			if ( in_array( $name, $intermediates, true ) ) {
 				$expected .= $uploads_dir . $year_month . '/' . $size['file'] . ' ' . $size['width'] . 'w, ';
 			}
 		}
@@ -2228,8 +2228,8 @@ EOF;
 		remove_all_filters( 'wp_calculate_image_sizes' );
 
 		$actual = wp_get_attachment_image( self::$large_id, 'testsize' );
-		$year   = date( 'Y' );
-		$month  = date( 'm' );
+		$year   = gmdate( 'Y' );
+		$month  = gmdate( 'm' );
 
 		$expected = '<img width="999" height="999" src="http://' . WP_TESTS_DOMAIN . '/wp-content/uploads/' . $year . '/' . $month . '/test-image-testsize-999x999.png"' .
 			' class="attachment-testsize size-testsize" alt=""' .
diff --git a/tests/menu/nav-menu.php b/tests/menu/nav-menu.php
index b0b5c446fb..af67f98379 100644
--- a/tests/menu/nav-menu.php
+++ b/tests/menu/nav-menu.php
@@ -1,7 +1,7 @@
 <?php
 
 /**
- * @group navmenus
+ * @group menu
  */
 class Tests_Nav_Menu_Theme_Change extends WP_UnitTestCase {
 
@@ -54,11 +54,12 @@ class Tests_Nav_Menu_Theme_Change extends WP_UnitTestCase {
 	 */
 	function test_filter_registered_locations() {
 		$this->register_nav_menu_locations( array( 'primary', 'secondary' ) );
-		$old_next_theme_nav_menu_locations = $prev_theme_nav_menu_locations = array(
+		$prev_theme_nav_menu_locations     = array(
 			'primary'   => 1,
 			'secondary' => 2,
 			'social'    => 3,
 		);
+		$old_next_theme_nav_menu_locations = $prev_theme_nav_menu_locations;
 		$new_next_theme_nav_menu_locations = wp_map_nav_menu_locations( $old_next_theme_nav_menu_locations, $prev_theme_nav_menu_locations );
 
 		$expected_nav_menu_locations = array(
@@ -181,6 +182,8 @@ class Tests_Nav_Menu_Theme_Change extends WP_UnitTestCase {
 	/**
 	 * Technically possible to register menu locations numerically.
 	 *
+	 * @expectedIncorrectUsage register_nav_menus
+	 *
 	 * @covers ::wp_map_nav_menu_locations()
 	 */
 	function test_numerical_locations() {
@@ -204,6 +207,8 @@ class Tests_Nav_Menu_Theme_Change extends WP_UnitTestCase {
 	/**
 	 * Technically possible old nav menu locations were registered numerically.
 	 *
+	 * @expectedIncorrectUsage register_nav_menus
+	 *
 	 * @covers wp_map_nav_menu_locations()
 	 */
 	public function test_numerical_old_locations() {
diff --git a/tests/menu/walker-nav-menu-edit.php b/tests/menu/walker-nav-menu-edit.php
index 6bf931608d..62485f36f2 100644
--- a/tests/menu/walker-nav-menu-edit.php
+++ b/tests/menu/walker-nav-menu-edit.php
@@ -1,10 +1,10 @@
 <?php
 
 /**
- * @group navmenus
+ * @group menu
  * @group walker
  */
-class Tests_Walker_Nav_Menu_Edit extends WP_UnitTestCase {
+class Tests_Menu_Walker_Nav_Menu_Edit extends WP_UnitTestCase {
 	protected $_wp_nav_menu_max_depth;
 
 	function setUp() {
diff --git a/tests/menu/walker-nav-menu.php b/tests/menu/walker-nav-menu.php
new file mode 100644
index 0000000000..25e6aba510
--- /dev/null
+++ b/tests/menu/walker-nav-menu.php
@@ -0,0 +1,149 @@
+<?php
+/**
+ * @group menu
+ * @group walker
+ */
+class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
+
+	/**
+	 * @var \Walker_Nav_Menu The instance of the walker.
+	 */
+	public $walker;
+
+	/**
+	 * Setup.
+	 */
+	public function setUp() {
+		global $_wp_nav_menu_max_depth;
+
+		parent::setUp();
+
+		/** Walker_Nav_Menu class */
+		require_once ABSPATH . 'wp-includes/class-walker-nav-menu.php';
+		$this->walker = new Walker_Nav_Menu();
+
+		$this->_wp_nav_menu_max_depth = $_wp_nav_menu_max_depth;
+		parent::setUp();
+	}
+
+	/**
+	 * Tear down
+	 */
+	public function tearDown() {
+		global $_wp_nav_menu_max_depth;
+
+		$_wp_nav_menu_max_depth = $this->_wp_nav_menu_max_depth;
+		parent::tearDown();
+	}
+
+	/**
+	 * Tests when an item's target is _blank, that rel="noopener noreferrer" is added.
+	 *
+	 * @ticket 43290
+	 */
+	public function test_noopener_no_referrer_for_target_blank() {
+		$expected   = '';
+		$post_id    = $this->factory->post->create();
+		$post_title = get_the_title( $post_id );
+
+		$item = array(
+			'ID'        => $post_id,
+			'object_id' => $post_id,
+			'title'     => $post_title,
+			'target'    => '_blank',
+			'xfn'       => '',
+			'current'   => false,
+		);
+
+		$args = array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$this->walker->start_el( $expected, (object) $item, 0, (object) $args );
+
+		$this->assertSame( "<li id=\"menu-item-{$post_id}\" class=\"menu-item-{$post_id}\"><a target=\"_blank\" rel=\"noopener noreferrer\">{$post_title}</a>", $expected );
+	}
+
+	/**
+	 * @ticket 47720
+	 *
+	 * @dataProvider data_start_el_with_empty_attributes
+	 */
+	public function test_start_el_with_empty_attributes( $value, $expected ) {
+		$output     = '';
+		$post_id    = $this->factory->post->create();
+		$post_title = get_the_title( $post_id );
+
+		$item = array(
+			'ID'        => $post_id,
+			'object_id' => $post_id,
+			'title'     => $post_title,
+			'target'    => '',
+			'xfn'       => '',
+			'current'   => false,
+		);
+
+		$args = array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		add_filter(
+			'nav_menu_link_attributes',
+			function( $atts ) use ( $value ) {
+				$atts['data-test'] = $value;
+				return $atts;
+			}
+		);
+
+		$this->walker->start_el( $output, (object) $item, 0, (object) $args );
+
+		if ( '' !== $expected ) {
+			$expected = sprintf( ' data-test="%s"', $expected );
+		}
+
+		$this->assertSame( "<li id=\"menu-item-{$post_id}\" class=\"menu-item-{$post_id}\"><a{$expected}>{$post_title}</a>", $output );
+	}
+
+	public function data_start_el_with_empty_attributes() {
+		return array(
+			array(
+				'',
+				'',
+			),
+			array(
+				0,
+				'0',
+			),
+			array(
+				0.0,
+				'0',
+			),
+			array(
+				'0',
+				'0',
+			),
+			array(
+				null,
+				'',
+			),
+			array(
+				false,
+				'',
+			),
+			array(
+				true,
+				'1',
+			),
+			array(
+				array(),
+				'',
+			),
+		);
+	}
+}
diff --git a/tests/meta.php b/tests/meta.php
index b20f2be90d..c2cc6663b9 100644
--- a/tests/meta.php
+++ b/tests/meta.php
@@ -370,6 +370,7 @@ class Tests_Meta extends WP_UnitTestCase {
 
 		$string_mid = "{$meta_id}.0";
 
+		// phpcs:ignore WordPress.PHP.StrictComparisons.LooseComparison -- intentional implicit casting check
 		$this->assertTrue( floor( $string_mid ) == $string_mid );
 		$this->assertNotEquals( false, get_metadata_by_mid( 'user', $string_mid ) );
 		$this->assertNotEquals( false, update_metadata_by_mid( 'user', $string_mid, 'meta_new_value_2' ) );
diff --git a/tests/meta/deleteMetadata.php b/tests/meta/deleteMetadata.php
index 5527d1f02f..024ac5b526 100644
--- a/tests/meta/deleteMetadata.php
+++ b/tests/meta/deleteMetadata.php
@@ -144,4 +144,21 @@ class Tests_Meta_DeleteMetadata extends WP_UnitTestCase {
 		$p2_cache = wp_cache_get( $p2, 'post_meta' );
 		$this->assertFalse( $p2_cache );
 	}
+
+	/**
+	 * @ticket 43561
+	 */
+	public function test_object_id_is_int_inside_delete_post_meta() {
+		$post_id = self::factory()->post->create();
+		$meta_id = add_metadata( 'post', $post_id, 'my_key', 'my_value' );
+		add_action( 'delete_post_meta', array( $this, 'action_check_object_id_is_int' ), 10, 2 );
+		delete_metadata_by_mid( 'post', $meta_id );
+	}
+
+	public function action_check_object_id_is_int( $meta_type, $object_id ) {
+		$this->assertEquals(
+			'integer',
+			gettype( $object_id )
+		);
+	}
 }
diff --git a/tests/meta/query.php b/tests/meta/query.php
index 0e37abff9e..4a22821ca9 100644
--- a/tests/meta/query.php
+++ b/tests/meta/query.php
@@ -737,6 +737,42 @@ class Tests_Meta_Query extends WP_UnitTestCase {
 		$this->assertSame( 1, substr_count( $sql['where'], "$wpdb->postmeta.meta_value =" ) );
 	}
 
+	/**
+	 * Verifies only that meta_type_key is passed. See query/metaQuery.php for more complete tests.
+	 *
+	 * @ticket 43446
+	 */
+	public function test_meta_type_key_should_be_passed_to_meta_query() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'AAA_FOO_AAA', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_aaa', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_key'         => 'AAA_foo_.*',
+				'meta_compare_key' => 'REGEXP',
+				'fields'           => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0], $posts[2] ), $q->posts );
+
+		$q = new WP_Query(
+			array(
+				'meta_key'         => 'AAA_FOO_.*',
+				'meta_compare_key' => 'REGEXP',
+				'meta_type_key'    => 'BINARY',
+				'fields'           => 'ids',
+				'fields'           => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0] ), $q->posts );
+	}
+
 	/**
 	 * This is the clause that ensures that empty arrays are not valid queries.
 	 */
diff --git a/tests/meta/registerMeta.php b/tests/meta/registerMeta.php
index 6a7a4c830e..334a2320d0 100644
--- a/tests/meta/registerMeta.php
+++ b/tests/meta/registerMeta.php
@@ -505,7 +505,7 @@ class Tests_Meta_Register_Meta extends WP_UnitTestCase {
 	}
 
 	public function filter_get_object_subtype_for_customtype( $subtype, $object_id ) {
-		if ( $object_id % 2 === 1 ) {
+		if ( 1 === ( $object_id % 2 ) ) {
 			return 'odd';
 		}
 
diff --git a/tests/multisite.php b/tests/multisite.php
index 6ff0743991..009c0d4e52 100644
--- a/tests/multisite.php
+++ b/tests/multisite.php
@@ -31,9 +31,51 @@ if ( is_multisite() ) :
 			wpmu_log_new_registrations( 1, 1 );
 
 			// currently there is no wrapper function for the registration_log
-			$reg_blog = $wpdb->get_col( "SELECT email FROM {$wpdb->registration_log} WHERE {$wpdb->registration_log}.blog_id = 1 AND IP LIKE '" . $ip . "'" );
+			$reg_blog = $wpdb->get_col( $wpdb->prepare( "SELECT email FROM {$wpdb->registration_log} WHERE {$wpdb->registration_log}.blog_id = 1 AND IP LIKE %s", $ip ) );
 			$this->assertEquals( $user->user_email, $reg_blog[ count( $reg_blog ) - 1 ] );
 		}
+
+		/**
+		 * @ticket 37392
+		 */
+		function test_wp_count_sites() {
+			// create a random number of sites with each status.
+			$site_ids = array(
+				'public'   => self::factory()->blog->create_many(
+					random_int( 0, 5 ),
+					array( 'meta' => array( 'public' => 1 ) )
+				),
+				'archived' => self::factory()->blog->create_many(
+					random_int( 0, 5 ),
+					array( 'meta' => array( 'archived' => 1 ) )
+				),
+				'mature'   => self::factory()->blog->create_many(
+					random_int( 0, 5 ),
+					array( 'meta' => array( 'mature' => 1 ) )
+				),
+				'spam'     => self::factory()->blog->create_many(
+					random_int( 0, 5 ),
+					array( 'meta' => array( 'spam' => 1 ) )
+				),
+				'deleted'  => self::factory()->blog->create_many(
+					random_int( 0, 5 ),
+					array( 'meta' => array( 'deleted' => 1 ) )
+				),
+			);
+
+			$counts = wp_count_sites();
+
+			$counts_by_status = array_map( 'count', $site_ids );
+			$expected         = array_merge(
+				array( 'all' => array_sum( $counts_by_status ) ),
+				$counts_by_status
+			);
+			// add 1 to all & public for the main site.
+			$expected['all']    += 1;
+			$expected['public'] += 1;
+
+			$this->assertEquals( $expected, $counts );
+		}
 	}
 
 endif;
diff --git a/tests/multisite/getSpaceUsed.php b/tests/multisite/getSpaceUsed.php
index e386634616..7d6d33304c 100644
--- a/tests/multisite/getSpaceUsed.php
+++ b/tests/multisite/getSpaceUsed.php
@@ -28,7 +28,7 @@ if ( is_multisite() ) :
 			// Our comparison of space relies on an initial value of 0. If a previous test has failed or if the
 			// src directory already contains a content directory with site content, then the initial expectation
 			// will be polluted. We create sites until an empty one is available.
-			while ( 0 != get_space_used() ) {
+			while ( 0 !== get_space_used() ) {
 				restore_current_blog();
 				$blog_id = self::factory()->blog->create();
 				switch_to_blog( $blog_id );
@@ -64,7 +64,7 @@ if ( is_multisite() ) :
 			// We don't rely on an initial value of 0 for space used, but should have a clean space available
 			// so that we can remove any uploaded files and directories without concern of a conflict with
 			// existing content directories in src.
-			while ( 0 != get_space_used() ) {
+			while ( 0 !== get_space_used() ) {
 				restore_current_blog();
 				$blog_id = self::factory()->blog->create();
 				switch_to_blog( $blog_id );
diff --git a/tests/multisite/network.php b/tests/multisite/network.php
index 18e8510e5b..f6d0984a1e 100644
--- a/tests/multisite/network.php
+++ b/tests/multisite/network.php
@@ -152,7 +152,7 @@ if ( is_multisite() ) :
 			$site_count_start = get_blog_count();
 
 			$site_ids = self::factory()->blog->create_many( 1 );
-			$actual   = (int) get_blog_count(); // count only updated when cron runs, so unchanged
+			$actual   = (int) get_blog_count(); // Count only updated when cron runs, so should be unchanged.
 
 			foreach ( $site_ids as $site_id ) {
 				wpmu_delete_blog( $site_id, true );
@@ -171,7 +171,7 @@ if ( is_multisite() ) :
 
 			add_filter( 'enable_live_network_counts', '__return_false' );
 			$site_ids = self::factory()->blog->create_many( 1 );
-			$actual   = (int) get_blog_count(); // count only updated when cron runs, so unchanged
+			$actual   = (int) get_blog_count(); // Count only updated when cron runs, so should be unchanged.
 			remove_filter( 'enable_live_network_counts', '__return_false' );
 
 			foreach ( $site_ids as $site_id ) {
@@ -234,16 +234,16 @@ if ( is_multisite() ) :
 		 * @ticket 22917
 		 */
 		function test_enable_live_network_user_counts_filter() {
-			// false for large networks by default
+			// False for large networks by default.
 			add_filter( 'enable_live_network_counts', '__return_false' );
 
-			// Refresh the cache
+			// Refresh the cache.
 			wp_update_network_counts();
 			$start_count = get_user_count();
 
 			wpmu_create_user( 'user', 'pass', 'email' );
 
-			// No change, cache not refreshed
+			// No change, cache not refreshed.
 			$count = get_user_count();
 
 			$this->assertEquals( $start_count, $count );
@@ -265,29 +265,29 @@ if ( is_multisite() ) :
 		function test_active_network_plugins() {
 			$path = 'hello.php';
 
-			// local activate, should be invisible for the network
-			activate_plugin( $path ); // $network_wide = false
+			// Local activate, should be invisible for the network.
+			activate_plugin( $path ); // Enable the plugin for the current site.
 			$active_plugins = wp_get_active_network_plugins();
 			$this->assertEquals( array(), $active_plugins );
 
 			add_action( 'deactivated_plugin', array( $this, '_helper_deactivate_hook' ) );
 
-			// activate the plugin sitewide
-			activate_plugin( $path, '', $network_wide = true );
-			$active_plugins                           = wp_get_active_network_plugins();
+			// Activate the plugin sitewide.
+			activate_plugin( $path, '', true ); // Enable the plugin for all sites in the network.
+			$active_plugins = wp_get_active_network_plugins();
 			$this->assertEquals( array( WP_PLUGIN_DIR . '/hello.php' ), $active_plugins );
 
-			//deactivate the plugin
+			// Deactivate the plugin.
 			deactivate_plugins( $path );
 			$active_plugins = wp_get_active_network_plugins();
 			$this->assertEquals( array(), $active_plugins );
 
-			$this->assertEquals( 1, $this->plugin_hook_count ); // testing actions and silent mode
+			$this->assertEquals( 1, $this->plugin_hook_count ); // Testing actions and silent mode.
 
-			activate_plugin( $path, '', $network_wide = true );
-			deactivate_plugins( $path, true ); // silent
+			activate_plugin( $path, '', true ); // Enable the plugin for all sites in the network.
+			deactivate_plugins( $path, true );  // Silent mode.
 
-			$this->assertEquals( 1, $this->plugin_hook_count ); // testing actions and silent mode
+			$this->assertEquals( 1, $this->plugin_hook_count ); // Testing actions and silent mode.
 		}
 
 		/**
@@ -298,14 +298,14 @@ if ( is_multisite() ) :
 			$mock = new MockAction();
 			add_action( 'activate_' . $path, array( $mock, 'action' ) );
 
-			// should activate on the first try
-			activate_plugin( $path, '', true );
+			// Should activate on the first try.
+			activate_plugin( $path, '', true ); // Enable the plugin for all sites in the network.
 			$active_plugins = wp_get_active_network_plugins();
 			$this->assertCount( 1, $active_plugins );
 			$this->assertEquals( 1, $mock->get_call_count() );
 
-			// should do nothing on the second try
-			activate_plugin( $path, '', true );
+			// Should do nothing on the second try.
+			activate_plugin( $path, '', true ); // Enable the plugin for all sites in the network.
 			$active_plugins = wp_get_active_network_plugins();
 			$this->assertCount( 1, $active_plugins );
 			$this->assertEquals( 1, $mock->get_call_count() );
@@ -328,18 +328,18 @@ if ( is_multisite() ) :
 		}
 
 		function test_get_user_count() {
-			// Refresh the cache
+			// Refresh the cache.
 			wp_update_network_counts();
 			$start_count = get_user_count();
 
-			// Only false for large networks as of 3.7
+			// Only false for large networks as of 3.7.
 			add_filter( 'enable_live_network_counts', '__return_false' );
 			self::factory()->user->create( array( 'role' => 'administrator' ) );
 
-			$count = get_user_count(); // No change, cache not refreshed
+			$count = get_user_count(); // No change, cache not refreshed.
 			$this->assertEquals( $start_count, $count );
 
-			wp_update_network_counts(); // Magic happens here
+			wp_update_network_counts(); // Magic happens here.
 
 			$count = get_user_count();
 			$this->assertEquals( $start_count + 1, $count );
@@ -349,7 +349,7 @@ if ( is_multisite() ) :
 		function test_wp_schedule_update_network_counts() {
 			$this->assertFalse( wp_next_scheduled( 'update_network_counts' ) );
 
-			// We can't use wp_schedule_update_network_counts() because WP_INSTALLING is set
+			// We can't use wp_schedule_update_network_counts() because WP_INSTALLING is set.
 			wp_schedule_event( time(), 'twicedaily', 'update_network_counts' );
 
 			$this->assertInternalType( 'int', wp_next_scheduled( 'update_network_counts' ) );
@@ -359,7 +359,7 @@ if ( is_multisite() ) :
 		 * @expectedDeprecated get_dashboard_blog
 		 */
 		function test_get_dashboard_blog() {
-			// if there is no dashboard blog set, current blog is used
+			// If there is no dashboard blog set, current blog is used.
 			$dashboard_blog = get_dashboard_blog();
 			$this->assertEquals( 1, $dashboard_blog->blog_id );
 
@@ -367,7 +367,7 @@ if ( is_multisite() ) :
 			$blog_id = self::factory()->blog->create( array( 'user_id' => $user_id ) );
 			$this->assertInternalType( 'int', $blog_id );
 
-			// set the dashboard blog to another one
+			// Set the dashboard blog to another one.
 			update_site_option( 'dashboard_blog', $blog_id );
 			$dashboard_blog = get_dashboard_blog();
 			$this->assertEquals( $blog_id, $dashboard_blog->blog_id );
@@ -613,6 +613,49 @@ if ( is_multisite() ) :
 
 			$this->assertSame( (string) self::$different_site_ids[0], $network->blog_id );
 		}
+
+		/**
+		 * @ticket 42251
+		 */
+		public function test_get_network_not_found_cache() {
+			global $wpdb;
+
+			$new_network_id = $this->_get_next_network_id();
+			$this->assertNull( get_network( $new_network_id ) );
+
+			$num_queries = $wpdb->num_queries;
+			$this->assertNull( get_network( $new_network_id ) );
+			$this->assertSame( $num_queries, $wpdb->num_queries );
+		}
+
+		/**
+		 * @ticket 42251
+		 */
+		public function test_get_network_not_found_cache_clear() {
+			$new_network_id = $this->_get_next_network_id();
+			$this->assertNull( get_network( $new_network_id ) );
+
+			$new_network = $this->factory()->network->create_and_get();
+
+			// Double-check we got the ID of the new network correct.
+			$this->assertEquals( $new_network_id, $new_network->id );
+
+			// Verify that if we fetch the network now, it's no longer false.
+			$fetched_network = get_network( $new_network_id );
+			$this->assertInstanceOf( 'WP_Network', $fetched_network );
+			$this->assertEquals( $new_network_id, $fetched_network->id );
+		}
+
+		/**
+		 * Gets the ID of the site with the highest ID.
+		 * @return int
+		 */
+		protected function _get_next_network_id() {
+			global $wpdb;
+			// Create an extra network, just to make sure we know the ID of the following one.
+			static::factory()->network->create();
+			return (int) $wpdb->get_var( 'SELECT id FROM ' . $wpdb->site . ' ORDER BY id DESC LIMIT 1' ) + 1;
+		}
 	}
 
 endif;
diff --git a/tests/multisite/networkQuery.php b/tests/multisite/networkQuery.php
index 6ec7f16c42..0318998129 100644
--- a/tests/multisite/networkQuery.php
+++ b/tests/multisite/networkQuery.php
@@ -522,6 +522,38 @@ if ( is_multisite() ) :
 			);
 			$this->assertEquals( $number_of_queries + 1, $wpdb->num_queries );
 		}
+
+		/**
+		 * @ticket 45749
+		 * @ticket 47599
+		 */
+		public function test_networks_pre_query_filter_should_bypass_database_query() {
+			global $wpdb;
+
+			add_filter( 'networks_pre_query', array( __CLASS__, 'filter_networks_pre_query' ), 10, 2 );
+
+			$num_queries = $wpdb->num_queries;
+
+			$q       = new WP_Network_Query();
+			$results = $q->query( array() );
+
+			remove_filter( 'networks_pre_query', array( __CLASS__, 'filter_networks_pre_query' ), 10, 2 );
+
+			// Make sure no queries were executed.
+			$this->assertSame( $num_queries, $wpdb->num_queries );
+
+			// We manually inserted a non-existing site and overrode the results with it.
+			$this->assertSame( array( 555 ), $results );
+
+			// Make sure manually setting total_users doesn't get overwritten.
+			$this->assertEquals( 1, $q->found_networks );
+		}
+
+		public static function filter_networks_pre_query( $networks, $query ) {
+			$query->found_networks = 1;
+
+			return array( 555 );
+		}
 	}
 
 endif;
diff --git a/tests/multisite/site.php b/tests/multisite/site.php
index 5397e85dcf..f0aa28a06d 100644
--- a/tests/multisite/site.php
+++ b/tests/multisite/site.php
@@ -12,6 +12,7 @@ if ( is_multisite() ) :
 		protected $suppress                = false;
 		protected $site_status_hooks       = array();
 		protected $wp_initialize_site_args = array();
+		protected $wp_initialize_site_meta = array();
 		protected static $network_ids;
 		protected static $site_ids;
 		protected static $uninitialized_site_id;
@@ -165,16 +166,21 @@ if ( is_multisite() ) :
 
 			// Check existence of each database table for the created site.
 			foreach ( $wpdb->tables( 'blog', false ) as $table ) {
-				$suppress     = $wpdb->suppress_errors();
+				$suppress = $wpdb->suppress_errors();
+
+				// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 				$table_fields = $wpdb->get_results( "DESCRIBE $prefix$table;" );
+
 				$wpdb->suppress_errors( $suppress );
 
 				// The table should exist.
 				$this->assertNotEmpty( $table_fields );
 
 				// And the table should not be empty, unless commentmeta, termmeta, or links.
+				// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 				$result = $wpdb->get_results( "SELECT * FROM $prefix$table LIMIT 1" );
-				if ( 'commentmeta' == $table || 'termmeta' == $table || 'links' == $table ) {
+
+				if ( 'commentmeta' === $table || 'termmeta' === $table || 'links' === $table ) {
 					$this->assertEmpty( $result );
 				} else {
 					$this->assertNotEmpty( $result );
@@ -243,8 +249,11 @@ if ( is_multisite() ) :
 
 			$prefix = $wpdb->get_blog_prefix( $blog_id );
 			foreach ( $wpdb->tables( 'blog', false ) as $table ) {
-				$suppress     = $wpdb->suppress_errors();
+				$suppress = $wpdb->suppress_errors();
+
+				// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 				$table_fields = $wpdb->get_results( "DESCRIBE $prefix$table;" );
+
 				$wpdb->suppress_errors( $suppress );
 				$this->assertNotEmpty( $table_fields, $prefix . $table );
 			}
@@ -281,8 +290,11 @@ if ( is_multisite() ) :
 
 			$prefix = $wpdb->get_blog_prefix( $blog_id );
 			foreach ( $wpdb->tables( 'blog', false ) as $table ) {
-				$suppress     = $wpdb->suppress_errors();
+				$suppress = $wpdb->suppress_errors();
+
+				// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 				$table_fields = $wpdb->get_results( "DESCRIBE $prefix$table;" );
+
 				$wpdb->suppress_errors( $suppress );
 				$this->assertEmpty( $table_fields );
 			}
@@ -319,8 +331,11 @@ if ( is_multisite() ) :
 
 			$prefix = $wpdb->get_blog_prefix( $blog_id );
 			foreach ( $wpdb->tables( 'blog', false ) as $table ) {
-				$suppress     = $wpdb->suppress_errors();
+				$suppress = $wpdb->suppress_errors();
+
+				// phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared
 				$table_fields = $wpdb->get_results( "DESCRIBE $prefix$table;" );
+
 				$wpdb->suppress_errors( $suppress );
 				$this->assertNotEmpty( $table_fields, $prefix . $table );
 			}
@@ -854,7 +869,7 @@ if ( is_multisite() ) :
 		 * the testing of the filter and for a test which does not need the database.
 		 */
 		function _domain_exists_cb( $exists, $domain, $path, $site_id ) {
-			if ( 'foo' == $domain && 'bar/' == $path ) {
+			if ( 'foo' === $domain && 'bar/' === $path ) {
 				return 1234;
 			} else {
 				return null;
@@ -2348,6 +2363,128 @@ if ( is_multisite() ) :
 			// Set siteurl
 			update_option( 'siteurl', 'http://testsite1.example.org/test' );
 		}
+
+		/**
+		 * Tests whether all expected meta are provided in deprecated `wpmu_new_blog` action.
+		 *
+		 * @dataProvider data_wpmu_new_blog_action_backward_commpatible
+		 *
+		 * @ticket 46351
+		 */
+		public function test_wpmu_new_blog_action_backward_compatible( $meta, $expected_meta ) {
+			// We are testing deprecated hook. Register it to expected deprecated notices.
+			$this->setExpectedDeprecated( 'wpmu_new_blog' );
+			add_action( 'wpmu_new_blog', array( $this, 'wpmu_new_blog_callback' ), 10, 6 );
+
+			wpmu_create_blog( 'testsite1.example.org', '/new-blog/', 'New Blog', get_current_user_id(), $meta, 1 );
+
+			$this->assertEquals( $expected_meta, $this->wp_initialize_site_meta );
+
+			$this->wp_initialize_site_meta = array();
+		}
+
+		/**
+		 * @ticket 42251
+		 */
+		public function test_get_site_not_found_cache() {
+			global $wpdb;
+
+			$new_site_id = $this->_get_next_site_id();
+			$this->assertNull( get_site( $new_site_id ) );
+
+			$num_queries = $wpdb->num_queries;
+			$this->assertNull( get_site( $new_site_id ) );
+			$this->assertSame( $num_queries, $wpdb->num_queries );
+		}
+
+		/**
+		 * @ticket 42251
+		 */
+		public function test_get_site_not_found_cache_clear() {
+			$new_site_id = $this->_get_next_site_id();
+			$this->assertNull( get_site( $new_site_id ) );
+
+			$new_site = $this->factory()->blog->create_and_get();
+
+			// Double-check we got the ID of the new site correct.
+			$this->assertEquals( $new_site_id, $new_site->blog_id );
+
+			// Verify that if we fetch the site now, it's no longer false.
+			$fetched_site = get_site( $new_site_id );
+			$this->assertInstanceOf( 'WP_Site', $fetched_site );
+			$this->assertEquals( $new_site_id, $fetched_site->blog_id );
+
+		}
+
+		/**
+		 * Gets the ID of the next site that will get inserted
+		 * @return int
+		 */
+		protected function _get_next_site_id() {
+			global $wpdb;
+			//create an entry
+			static::factory()->blog->create();
+			//get the ID after it
+			return (int) $wpdb->get_var( 'SELECT blog_id FROM ' . $wpdb->blogs . ' ORDER BY blog_ID DESC LIMIT 1' ) + 1;
+		}
+
+		/**
+		 * Capture the $meta value passed to the wpmu_new_blog action and compare it.
+		 */
+		public function wpmu_new_blog_callback( $blog_id, $user_id, $domain, $path, $network_id, $meta ) {
+			$this->wp_initialize_site_meta = $meta;
+		}
+
+		public function data_wpmu_new_blog_action_backward_commpatible() {
+			return array(
+				'default values'  => array(
+					array(),
+					array(
+						'public' => 0, // `public` is one of the defaults metas in `wpmu_create_blog' function prior WordPress 5.1.0
+						'WPLANG' => 'en_US', // WPLANG is another default meta in `wpmu_create_blog` function prior WordPress 5.1.0.
+					),
+				),
+				'public site'     => array(
+					array(
+						'public' => 1,
+					),
+					array(
+						'public' => 1,
+						'WPLANG' => 'en_US',
+					),
+				),
+				'all whitelisted' => array(
+					array(
+						'public'   => -1,
+						'archived' => 0,
+						'mature'   => 0,
+						'spam'     => 0,
+						'deleted'  => 0,
+						'lang_id'  => 11,
+
+					),
+					array(
+						'public'   => -1,
+						'WPLANG'   => 'en_US',
+						'archived' => 0,
+						'mature'   => 0,
+						'spam'     => 0,
+						'deleted'  => 0,
+						'lang_id'  => 11,
+					),
+				),
+				'extra meta key'  => array(
+					array(
+						'foo' => 'bar',
+					),
+					array(
+						'public' => 0,
+						'WPLANG' => 'en_US',
+						'foo'    => 'bar',
+					),
+				),
+			);
+		}
 	}
 
 endif;
diff --git a/tests/multisite/siteQuery.php b/tests/multisite/siteQuery.php
index bac9269ff4..c8bcff2256 100644
--- a/tests/multisite/siteQuery.php
+++ b/tests/multisite/siteQuery.php
@@ -911,6 +911,39 @@ if ( is_multisite() ) :
 			}
 		}
 
+
+		/**
+		 * @ticket 45749
+		 * @ticket 47599
+		 */
+		public function test_sites_pre_query_filter_should_bypass_database_query() {
+			global $wpdb;
+
+			add_filter( 'sites_pre_query', array( __CLASS__, 'filter_sites_pre_query' ), 10, 2 );
+
+			$num_queries = $wpdb->num_queries;
+
+			$q       = new WP_Site_Query();
+			$results = $q->query( array() );
+
+			remove_filter( 'sites_pre_query', array( __CLASS__, 'filter_sites_pre_query' ), 10, 2 );
+
+			// Make sure no queries were executed.
+			$this->assertSame( $num_queries, $wpdb->num_queries );
+
+			// We manually inserted a non-existing site and overrode the results with it.
+			$this->assertSame( array( 555 ), $results );
+
+			// Make sure manually setting total_users doesn't get overwritten.
+			$this->assertEquals( 1, $q->found_sites );
+		}
+
+		public static function filter_sites_pre_query( $sites, $query ) {
+			$query->found_sites = 1;
+
+			return array( 555 );
+		}
+
 		public function data_wp_site_query_meta_query() {
 			return array(
 				array(
diff --git a/tests/multisite/wpmuValidateUserSignup.php b/tests/multisite/wpmuValidateUserSignup.php
index 15ab87a0ec..02fee8ae5f 100644
--- a/tests/multisite/wpmuValidateUserSignup.php
+++ b/tests/multisite/wpmuValidateUserSignup.php
@@ -99,7 +99,7 @@ if ( is_multisite() ) :
 			remove_filter( 'wpmu_signup_user_notification', '__return_true' );
 
 			global $wpdb;
-			$date = date( 'Y-m-d H:i:s', time() - ( 2 * DAY_IN_SECONDS ) - 60 );
+			$date = gmdate( 'Y-m-d H:i:s', time() - ( 2 * DAY_IN_SECONDS ) - 60 );
 			$wpdb->update( $wpdb->signups, array( 'registered' => $date ), array( 'user_login' => 'foo123' ) );
 
 			$v = wpmu_validate_user_signup( 'foo123', 'foo2@example.com' );
@@ -123,7 +123,7 @@ if ( is_multisite() ) :
 			remove_filter( 'wpmu_signup_user_notification', '__return_true' );
 
 			global $wpdb;
-			$date = date( 'Y-m-d H:i:s', time() - ( 2 * DAY_IN_SECONDS ) - 60 );
+			$date = gmdate( 'Y-m-d H:i:s', time() - ( 2 * DAY_IN_SECONDS ) - 60 );
 			$wpdb->update( $wpdb->signups, array( 'registered' => $date ), array( 'user_login' => 'foo123' ) );
 
 			$v = wpmu_validate_user_signup( 'foo2', 'foo2@example.com' );
diff --git a/tests/oembed/controller.php b/tests/oembed/controller.php
index 2852eda2de..b726735152 100644
--- a/tests/oembed/controller.php
+++ b/tests/oembed/controller.php
@@ -121,7 +121,7 @@ class Test_oEmbed_Controller extends WP_UnitTestCase {
 			);
 		}
 
-		if ( $url === self::UNTRUSTED_PROVIDER_URL ) {
+		if ( self::UNTRUSTED_PROVIDER_URL === $url ) {
 			return array(
 				'response' => array(
 					'code' => 200,
diff --git a/tests/oembed/filterTitleAttributes.php b/tests/oembed/filterTitleAttributes.php
new file mode 100644
index 0000000000..f378686752
--- /dev/null
+++ b/tests/oembed/filterTitleAttributes.php
@@ -0,0 +1,110 @@
+<?php
+
+/**
+ * @group oembed
+ */
+class Tests_Filter_oEmbed_Iframe_Title_Attribute extends WP_UnitTestCase {
+	public function data_filter_oembed_iframe_title_attribute() {
+		return array(
+			array(
+				'<p>Foo</p><iframe src=""></iframe><b>Bar</b>',
+				array(
+					'type' => 'rich',
+				),
+				'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
+				'<p>Foo</p><iframe src=""></iframe><b>Bar</b>',
+			),
+			array(
+				'<p>Foo</p><iframe src="" title="Hello World"></iframe><b>Bar</b>',
+				array(
+					'type' => 'rich',
+				),
+				'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
+				'<p>Foo</p><iframe title="Hello World" src=""></iframe><b>Bar</b>',
+			),
+			array(
+				'<p>Foo</p>',
+				array(
+					'type'  => 'rich',
+					'title' => 'Hello World',
+				),
+				'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
+				'<p>Foo</p>',
+			),
+			array(
+				'<p title="Foo">Bar</p>',
+				array(
+					'type'  => 'rich',
+					'title' => 'Hello World',
+				),
+				'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
+				'<p title="Foo">Bar</p>',
+			),
+			array(
+				'<p>Foo</p><iframe src=""></iframe><b>Bar</b>',
+				array(
+					'type'  => 'rich',
+					'title' => 'Hello World',
+				),
+				'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
+				'<p>Foo</p><iframe title="Hello World" src=""></iframe><b>Bar</b>',
+			),
+			array(
+				'<iframe src="" title="Foo"></iframe>',
+				array(
+					'type'  => 'rich',
+					'title' => 'Bar',
+				),
+				'https://www.youtube.com/watch?v=dQw4w9WgXcQ',
+				'<iframe title="Foo" src=""></iframe>',
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_filter_oembed_iframe_title_attribute
+	 */
+	public function test_oembed_iframe_title_attribute( $html, $oembed_data, $url, $expected ) {
+		$actual = wp_filter_oembed_iframe_title_attribute( $html, (object) $oembed_data, $url );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	public function test_filter_oembed_iframe_title_attribute() {
+		add_filter( 'oembed_iframe_title_attribute', array( $this, '_filter_oembed_iframe_title_attribute' ) );
+
+		$actual = wp_filter_oembed_iframe_title_attribute(
+			'<iframe title="Foo" src=""></iframe>',
+			(object) array(
+				'type'  => 'rich',
+				'title' => 'Bar',
+			),
+			'https://www.youtube.com/watch?v=dQw4w9WgXcQ'
+		);
+
+		remove_filter( 'oembed_iframe_title_attribute', array( $this, '_filter_oembed_iframe_title_attribute' ) );
+
+		$this->assertSame( '<iframe title="Baz" src=""></iframe>', $actual );
+	}
+
+	public function test_filter_oembed_iframe_title_attribute_does_not_modify_other_tags() {
+		add_filter( 'oembed_iframe_title_attribute', array( $this, '_filter_oembed_iframe_title_attribute' ) );
+
+		$actual = wp_filter_oembed_iframe_title_attribute(
+			'<p title="Bar">Baz</p><iframe title="Foo" src=""></iframe>',
+			(object) array(
+				'type'  => 'rich',
+				'title' => 'Bar',
+			),
+			'https://www.youtube.com/watch?v=dQw4w9WgXcQ'
+		);
+
+		remove_filter( 'oembed_iframe_title_attribute', array( $this, '_filter_oembed_iframe_title_attribute' ) );
+
+		$this->assertSame( '<p title="Bar">Baz</p><iframe title="Baz" src=""></iframe>', $actual );
+	}
+
+	public function _filter_oembed_iframe_title_attribute() {
+		return 'Baz';
+	}
+}
diff --git a/tests/oembed/headers.php b/tests/oembed/headers.php
index 6125bf9d1f..adc3ff93c2 100644
--- a/tests/oembed/headers.php
+++ b/tests/oembed/headers.php
@@ -5,6 +5,7 @@
  * @preserveGlobalState disabled
  * @group oembed
  * @group oembed-headers
+ * @group xdebug
  */
 class Tests_oEmbed_HTTP_Headers extends WP_UnitTestCase {
 	function test_rest_pre_serve_request_headers() {
@@ -30,6 +31,6 @@ class Tests_oEmbed_HTTP_Headers extends WP_UnitTestCase {
 
 		$headers = xdebug_get_headers();
 
-		$this->assertTrue( in_array( 'Content-Type: text/xml; charset=' . get_option( 'blog_charset' ), $headers ) );
+		$this->assertTrue( in_array( 'Content-Type: text/xml; charset=' . get_option( 'blog_charset' ), $headers, true ) );
 	}
 }
diff --git a/tests/oembed/template.php b/tests/oembed/template.php
index 95c532edb0..3d9b2b90c1 100644
--- a/tests/oembed/template.php
+++ b/tests/oembed/template.php
@@ -309,7 +309,7 @@ class Tests_Embed_Template extends WP_UnitTestCase {
 	 * So this test checks for ampersands in build/wp-includes/js/wp-embed.min.js.
 	 * In many cases, this file will not exist; in those cases, we simply skip the test.
 	 *
-	 * So when would it be run? We have Travis CI run `grunt test` which then runs, in order,
+	 * So when would it be run? We have Travis CI run `npm run test` which then runs, in order,
 	 * `qunit:compiled` (which runs the build) and then `phpunit`. Thus, this test will at least be
 	 * run during continuous integration.
 	 *
diff --git a/tests/oembed/wpOembed.php b/tests/oembed/wpOembed.php
index c148dd555c..2c029da6b2 100644
--- a/tests/oembed/wpOembed.php
+++ b/tests/oembed/wpOembed.php
@@ -14,7 +14,7 @@ class Tests_WP_oEmbed extends WP_UnitTestCase {
 	public function setUp() {
 		parent::setUp();
 
-		require_once ABSPATH . WPINC . '/class-oembed.php';
+		require_once ABSPATH . WPINC . '/class-wp-oembed.php';
 		$this->oembed = _wp_oembed_get_object();
 
 		$this->pre_oembed_result_filtered = false;
diff --git a/tests/option/sanitize-option.php b/tests/option/sanitize-option.php
index edfb180127..0a6ec865bb 100644
--- a/tests/option/sanitize-option.php
+++ b/tests/option/sanitize-option.php
@@ -158,45 +158,4 @@ class Tests_Sanitize_Option extends WP_UnitTestCase {
 		);
 	}
 
-	/**
-	 * Test calling get_settings_errors() with variations on where it gets errors from.
-	 *
-	 * @ticket 42498
-	 * @covers ::get_settings_errors()
-	 * @global array $wp_settings_errors
-	 */
-	public function test_get_settings_errors_sources() {
-		global $wp_settings_errors;
-
-		$blogname_error        = array(
-			'setting' => 'blogname',
-			'code'    => 'blogname',
-			'message' => 'Capital P dangit!',
-			'type'    => 'error',
-		);
-		$blogdescription_error = array(
-			'setting' => 'blogdescription',
-			'code'    => 'blogdescription',
-			'message' => 'Too short',
-			'type'    => 'error',
-		);
-
-		$wp_settings_errors = null;
-		$this->assertSame( array(), get_settings_errors( 'blogname' ) );
-
-		// Test getting errors from transient.
-		$_GET['settings-updated'] = '1';
-		set_transient( 'settings_errors', array( $blogname_error ) );
-		$wp_settings_errors = null;
-		$this->assertSame( array( $blogname_error ), get_settings_errors( 'blogname' ) );
-
-		// Test getting errors from transient and from global.
-		$_GET['settings-updated'] = '1';
-		set_transient( 'settings_errors', array( $blogname_error ) );
-		$wp_settings_errors = null;
-		add_settings_error( $blogdescription_error['setting'], $blogdescription_error['code'], $blogdescription_error['message'], $blogdescription_error['type'] );
-		$this->assertEqualSets( array( $blogname_error, $blogdescription_error ), get_settings_errors() );
-
-		$wp_settings_errors = null;
-	}
 }
diff --git a/tests/option/themeMods.php b/tests/option/themeMods.php
index 8bd8f5d85c..5c39de6b9e 100644
--- a/tests/option/themeMods.php
+++ b/tests/option/themeMods.php
@@ -32,4 +32,70 @@ class Tests_Option_Theme_Mods extends WP_UnitTestCase {
 		$this->assertEquals( '', get_theme_mod( 'test_remove' ) );
 	}
 
+	/**
+	 * @ticket 34290
+	 *
+	 * @dataProvider data_theme_mod_default_value_with_percent_symbols
+	 */
+	function test_theme_mod_default_value_with_percent_symbols( $default, $expected ) {
+		$this->assertEquals( $expected, get_theme_mod( 'test_name', $default ) );
+	}
+
+	function data_theme_mod_default_value_with_percent_symbols() {
+		return array(
+			array(
+				'100%',
+				'100%',
+			),
+			array(
+				'%s',
+				get_template_directory_uri(),
+			),
+			array(
+				'%s%s',
+				get_template_directory_uri() . get_stylesheet_directory_uri(),
+			),
+			array(
+				'%1$s%s',
+				get_template_directory_uri() . get_template_directory_uri(),
+			),
+			array(
+				'%2$s%s',
+				get_stylesheet_directory_uri() . get_template_directory_uri(),
+			),
+			array(
+				'%1$s%2$s',
+				get_template_directory_uri() . get_stylesheet_directory_uri(),
+			),
+			array(
+				'%40s%40s',
+				get_template_directory_uri() . get_stylesheet_directory_uri(),
+			),
+			array(
+				'%%1',
+				'%%1',
+			),
+			array(
+				'%1%',
+				'%1%',
+			),
+			array(
+				'1%%',
+				'1%%',
+			),
+			array(
+				'%%s',
+				'%%s',
+			),
+			array(
+				'%s%',
+				get_template_directory_uri(),
+			),
+			array(
+				's%%',
+				's%%',
+			),
+		);
+	}
+
 }
diff --git a/tests/option/wpLoadAllOptions.php b/tests/option/wpLoadAllOptions.php
index f2fb8a685d..5088f10b9a 100644
--- a/tests/option/wpLoadAllOptions.php
+++ b/tests/option/wpLoadAllOptions.php
@@ -104,6 +104,7 @@ class Tests_Option_WP_Load_Alloptions extends WP_UnitTestCase {
 	}
 
 	function return_pre_cache_filter( $alloptions ) {
-		return $this->alloptions = $alloptions;
+		$this->alloptions = $alloptions;
+		return $this->alloptions;
 	}
 }
diff --git a/tests/pluggable.php b/tests/pluggable.php
index e711f3b8bc..fd97a2dd77 100644
--- a/tests/pluggable.php
+++ b/tests/pluggable.php
@@ -11,11 +11,11 @@ class Tests_Pluggable extends WP_UnitTestCase {
 	 * @ticket 33654
 	 * @ticket 33867
 	 *
-	 * @dataProvider getDefinedPluggableFunctions
+	 * @dataProvider get_defined_pluggable_functions
 	 */
-	public function testPluggableFunctionSignaturesMatch( $function ) {
+	public function test_pluggable_function_signatures_match( $function ) {
 
-		$signatures = $this->getPluggableFunctionSignatures();
+		$signatures = $this->get_pluggable_function_signatures();
 
 		$this->assertTrue( function_exists( $function ) );
 		$this->assertArrayHasKey( $function, $signatures );
@@ -54,10 +54,10 @@ class Tests_Pluggable extends WP_UnitTestCase {
 	 * @ticket 33654
 	 * @ticket 33867
 	 */
-	public function testAllPluggableFunctionsExist() {
+	public function test_all_pluggable_functions_exist() {
 
-		$defined  = wp_list_pluck( $this->getDefinedPluggableFunctions(), 0 );
-		$expected = $this->getPluggableFunctionSignatures();
+		$defined  = wp_list_pluck( $this->get_defined_pluggable_functions(), 0 );
+		$expected = $this->get_pluggable_function_signatures();
 
 		foreach ( $expected as $function => $sig ) {
 			$msg = 'Function: ' . $function . '()';
@@ -72,7 +72,7 @@ class Tests_Pluggable extends WP_UnitTestCase {
 	 *
 	 * @return array Data provider array of pluggable function names.
 	 */
-	public function getDefinedPluggableFunctions() {
+	public function get_defined_pluggable_functions() {
 
 		require_once ABSPATH . '/wp-admin/includes/upgrade.php';
 
@@ -120,7 +120,7 @@ class Tests_Pluggable extends WP_UnitTestCase {
 	 *
 	 * @return array Array of signatures keyed by their function name.
 	 */
-	public function getPluggableFunctionSignatures() {
+	public function get_pluggable_function_signatures() {
 
 		$signatures = array(
 
diff --git a/tests/pomo/mo.php b/tests/pomo/mo.php
index d48467c936..a3990198dd 100644
--- a/tests/pomo/mo.php
+++ b/tests/pomo/mo.php
@@ -178,7 +178,7 @@ class Tests_POMO_MO extends WP_UnitTestCase {
 	}
 
 	function test_overloaded_mb_functions() {
-		if ( ( ini_get( 'mbstring.func_overload' ) & 2 ) == 0 ) {
+		if ( ( ini_get( 'mbstring.func_overload' ) & 2 ) === 0 ) {
 			$this->markTestSkipped( __METHOD__ . ' only runs when mbstring.func_overload is enabled.' );
 		}
 
diff --git a/tests/pomo/pluralForms.php b/tests/pomo/pluralForms.php
index 7bd9ff89e3..2cd283cf95 100644
--- a/tests/pomo/pluralForms.php
+++ b/tests/pomo/pluralForms.php
@@ -60,7 +60,7 @@ class PluralFormsTest extends WP_UnitTestCase {
 		$plural_expressions = array();
 		foreach ( $locales as $slug => $locale ) {
 			$plural_expression = $locale->plural_expression;
-			if ( $plural_expression !== 'n != 1' ) {
+			if ( 'n != 1' !== $plural_expression ) {
 				$plural_expressions[] = array( $slug, $locale->nplurals, $plural_expression );
 			}
 		}
@@ -82,14 +82,14 @@ class PluralFormsTest extends WP_UnitTestCase {
 
 		$parenthesized = self::parenthesize_plural_expression( $expression );
 		$old_style     = tests_make_plural_form_function( $nplurals, $parenthesized );
-		$pluralForms   = new Plural_Forms( $expression );
+		$plural_forms  = new Plural_Forms( $expression );
 
 		$generated_old = array();
 		$generated_new = array();
 
 		foreach ( range( 0, 200 ) as $i ) {
 			$generated_old[] = $old_style( $i );
-			$generated_new[] = $pluralForms->get( $i );
+			$generated_new[] = $plural_forms->get( $i );
 		}
 
 		$this->assertSame( $generated_old, $generated_new );
@@ -151,10 +151,10 @@ class PluralFormsTest extends WP_UnitTestCase {
 	 * @dataProvider simple_provider
 	 */
 	public function test_simple( $expression, $expected ) {
-		$pluralForms = new Plural_Forms( $expression );
-		$actual      = array();
+		$plural_forms = new Plural_Forms( $expression );
+		$actual       = array();
 		foreach ( array_keys( $expected ) as $num ) {
-			$actual[ $num ] = $pluralForms->get( $num );
+			$actual[ $num ] = $plural_forms->get( $num );
 		}
 
 		$this->assertSame( $expected, $actual );
@@ -212,9 +212,9 @@ class PluralFormsTest extends WP_UnitTestCase {
 	 */
 	public function test_exceptions( $expression, $expected_exception, $call_get ) {
 		try {
-			$pluralForms = new Plural_Forms( $expression );
+			$plural_forms = new Plural_Forms( $expression );
 			if ( $call_get ) {
-				$pluralForms->get( 1 );
+				$plural_forms->get( 1 );
 			}
 		} catch ( Exception $e ) {
 			$this->assertEquals( $expected_exception, $e->getMessage() );
diff --git a/tests/pomo/po.php b/tests/pomo/po.php
index 4f5bef31fa..0bd6f461dc 100644
--- a/tests/pomo/po.php
+++ b/tests/pomo/po.php
@@ -22,6 +22,7 @@ We hope you enjoy your new blog. Thanks!
 --The WordPress Team
 http://wordpress.org/
 ';
+		$this->mail    = str_replace( "\r\n", "\n", $this->mail );
 		$this->po_mail = '""
 "Your new WordPress blog has been successfully set up at:\n"
 "\n"
@@ -63,7 +64,7 @@ http://wordpress.org/
 		$src = 'Categories can be selectively converted to tags using the <a href="%s">category to tag converter</a>.';
 		$this->assertEquals( '"Categories can be selectively converted to tags using the <a href=\\"%s\\">category to tag converter</a>."', $po->poify( $src ) );
 
-		$this->assertEquals( $this->po_mail, $po->poify( $this->mail ) );
+		$this->assertEqualsIgnoreEOL( $this->po_mail, $po->poify( $this->mail ) );
 	}
 
 	function test_unpoify() {
@@ -74,7 +75,7 @@ http://wordpress.org/
 		$this->assertEquals( '\\t\\n', $po->unpoify( '"\\\\t\\\\n"' ) );
 		// wordwrapped
 		$this->assertEquals( 'babadyado', $po->unpoify( "\"\"\n\"baba\"\n\"dyado\"" ) );
-		$this->assertEquals( $this->mail, $po->unpoify( $this->po_mail ) );
+		$this->assertEqualsIgnoreEOL( $this->mail, $po->unpoify( $this->po_mail ) );
 	}
 
 	function test_export_entry() {
@@ -88,7 +89,7 @@ http://wordpress.org/
 				'plural'   => 'babas',
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'msgid "baba"
 msgid_plural "babas"
 msgstr[0] ""
@@ -101,7 +102,7 @@ msgstr[1] ""',
 				'translator_comments' => "baba\ndyado",
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'#  baba
 #  dyado
 msgid "baba"
@@ -114,7 +115,7 @@ msgstr ""',
 				'extracted_comments' => 'baba',
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'#. baba
 msgid "baba"
 msgstr ""',
@@ -127,7 +128,7 @@ msgstr ""',
 				'references'         => range( 1, 29 ),
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'#. baba
 #: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28
 #: 29
@@ -158,7 +159,7 @@ msgstr ""',
 				'translations' => array( '郕郕訇郕' ),
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'msgid "baba"
 msgid_plural "babas"
 msgstr[0] "郕郕訇郕"',
@@ -172,7 +173,7 @@ msgstr[0] "郕郕訇郕"',
 				'translations' => array( '郕郕訇郕', '郕郕郕', '訇訄訇訄迣訄' ),
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'msgid "baba"
 msgid_plural "babas"
 msgstr[0] "郕郕訇郕"
@@ -190,7 +191,7 @@ msgstr[2] "訇訄訇訄迣訄"',
 				'flags'        => array( 'fuzzy', 'php-format' ),
 			)
 		);
-		$this->assertEquals(
+		$this->assertEqualsIgnoreEOL(
 			'#, fuzzy, php-format
 msgctxt "ctxt"
 msgid "baba"
diff --git a/tests/post.php b/tests/post.php
index d0d902978c..39a8bae14a 100644
--- a/tests/post.php
+++ b/tests/post.php
@@ -48,7 +48,8 @@ class Tests_Post extends WP_UnitTestCase {
 	function _unset_current_user() {
 		global $current_user, $user_ID;
 
-		$current_user = $user_ID = null;
+		$current_user = null;
+		$user_ID      = null;
 	}
 
 	// test simple valid behavior: insert and get a post
@@ -94,7 +95,7 @@ class Tests_Post extends WP_UnitTestCase {
 			$this->assertEquals( 2, count( $tcache ) );
 
 			$tcache = wp_cache_get( $id, 'ctax_relationships' );
-			if ( 'cpt' == $post_type ) {
+			if ( 'cpt' === $post_type ) {
 				$this->assertInternalType( 'array', $tcache );
 				$this->assertEquals( 2, count( $tcache ) );
 			} else {
@@ -124,7 +125,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 		#dmp(_get_cron_array());
 		$this->assertTrue( is_numeric( $id ) );
 		$this->assertTrue( $id > 0 );
@@ -158,7 +160,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 
 		// fetch the post and make sure has the correct date and status
 		$out = get_post( $id );
@@ -200,7 +203,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 
 		// fetch the post and make sure has the correct date and status
 		$out = get_post( $id );
@@ -240,7 +244,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 		#dmp(_get_cron_array());
 		$this->assertTrue( is_numeric( $id ) );
 		$this->assertTrue( $id > 0 );
@@ -272,7 +277,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 
 		// fetch the post and make sure has the correct date and status
 		$out = get_post( $id );
@@ -313,7 +319,8 @@ class Tests_Post extends WP_UnitTestCase {
 			);
 
 			// insert a post and make sure the ID is ok
-			$id = $this->post_ids[] = wp_insert_post( $post );
+			$id               = wp_insert_post( $post );
+			$this->post_ids[] = $id;
 
 			// fetch the post and make sure has the correct date and status
 			$out = get_post( $id );
@@ -353,7 +360,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 		#dmp(_get_cron_array());
 		$this->assertTrue( is_numeric( $id ) );
 		$this->assertTrue( $id > 0 );
@@ -407,7 +415,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 
 		// fetch the post and make sure has the correct date and status
 		$out = get_post( $id );
@@ -511,7 +520,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 
 		// check that there's a publish_future_post job scheduled at the right time
 		$this->assertEquals( $future_date, $this->_next_schedule_for_post( 'publish_future_post', $id ) );
@@ -540,7 +550,8 @@ class Tests_Post extends WP_UnitTestCase {
 		);
 
 		// insert a post and make sure the ID is ok
-		$id = $this->post_ids[] = wp_insert_post( $post );
+		$id               = wp_insert_post( $post );
+		$this->post_ids[] = $id;
 
 		$plink = get_permalink( $id );
 
@@ -997,7 +1008,7 @@ class Tests_Post extends WP_UnitTestCase {
 	 */
 	function test_utf8mb3_post_saves_with_emoji() {
 		global $wpdb;
-		$_wpdb = new wpdb_exposed_methods_for_testing();
+		$_wpdb = new WpdbExposedMethodsForTesting();
 
 		if ( 'utf8' !== $_wpdb->get_col_charset( $wpdb->posts, 'post_title' ) ) {
 			$this->markTestSkipped( 'This test is only useful with the utf8 character set' );
@@ -1383,4 +1394,40 @@ class Tests_Post extends WP_UnitTestCase {
 	function filter_pre_wp_unique_post_slug( $default, $slug, $post_ID, $post_status, $post_type, $post_parent ) {
 		return 'override-slug-' . $post_type;
 	}
+
+	/**
+	 * @ticket 48113
+	 */
+	public function test_insert_post_should_respect_date_floating_post_status_arg() {
+		register_post_status( 'floating', array( 'date_floating' => true ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status'   => 'floating',
+				'post_date'     => null,
+				'post_date_gmt' => null,
+			)
+		);
+
+		$post = get_post( $post_id );
+		self::assertEquals( '0000-00-00 00:00:00', $post->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 48113
+	 */
+	public function test_insert_post_should_respect_date_floating_post_status_arg_not_set() {
+		register_post_status( 'not-floating', array( 'date_floating' => false ) );
+
+		$post_id = self::factory()->post->create(
+			array(
+				'post_status'   => 'floating',
+				'post_date'     => null,
+				'post_date_gmt' => null,
+			)
+		);
+
+		$post = get_post( $post_id );
+		self::assertEquals( strtotime( gmdate( 'Y-m-d H:i:s' ) ), strtotime( $post->post_date_gmt ), 'The dates should be equal', 2 );
+	}
 }
diff --git a/tests/post/attachments.php b/tests/post/attachments.php
index 08e44500f8..70255d5bec 100644
--- a/tests/post/attachments.php
+++ b/tests/post/attachments.php
@@ -27,7 +27,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$id = $this->_make_attachment( $upload );
@@ -39,17 +39,17 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 
 		// medium, medium_large, and full size will both point to the original
 		$downsize = image_downsize( $id, 'medium' );
-		$this->assertEquals( basename( $upload['file'] ), basename( $downsize[0] ) );
+		$this->assertEquals( wp_basename( $upload['file'] ), wp_basename( $downsize[0] ) );
 		$this->assertEquals( 50, $downsize[1] );
 		$this->assertEquals( 50, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'medium_large' );
-		$this->assertEquals( basename( $upload['file'] ), basename( $downsize[0] ) );
+		$this->assertEquals( wp_basename( $upload['file'] ), wp_basename( $downsize[0] ) );
 		$this->assertEquals( 50, $downsize[1] );
 		$this->assertEquals( 50, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'full' );
-		$this->assertEquals( basename( $upload['file'] ), basename( $downsize[0] ) );
+		$this->assertEquals( wp_basename( $upload['file'] ), wp_basename( $downsize[0] ) );
 		$this->assertEquals( 50, $downsize[1] );
 		$this->assertEquals( 50, $downsize[2] );
 
@@ -66,7 +66,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/a2-small.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$id = $this->_make_attachment( $upload );
@@ -86,23 +86,23 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 
 		// image_downsize() should return the correct images and sizes
 		$downsize = image_downsize( $id, 'thumbnail' );
-		$this->assertEquals( 'a2-small-150x150.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( 'a2-small-150x150.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 150, $downsize[1] );
 		$this->assertEquals( 150, $downsize[2] );
 
 		// medium, medium_large, and full will both point to the original
 		$downsize = image_downsize( $id, 'medium' );
-		$this->assertEquals( 'a2-small.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( 'a2-small.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 400, $downsize[1] );
 		$this->assertEquals( 300, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'medium_large' );
-		$this->assertEquals( 'a2-small.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( 'a2-small.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 400, $downsize[1] );
 		$this->assertEquals( 300, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'full' );
-		$this->assertEquals( 'a2-small.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( 'a2-small.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 400, $downsize[1] );
 		$this->assertEquals( 300, $downsize[2] );
 
@@ -122,7 +122,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$id      = $this->_make_attachment( $upload );
@@ -146,22 +146,22 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 
 		// image_downsize() should return the correct images and sizes
 		$downsize = image_downsize( $id, 'thumbnail' );
-		$this->assertEquals( '2007-06-17DSC_4173-150x150.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( '2007-06-17DSC_4173-150x150.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 150, $downsize[1] );
 		$this->assertEquals( 150, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'medium' );
-		$this->assertEquals( '2007-06-17DSC_4173-400x602.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( '2007-06-17DSC_4173-400x602.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 400, $downsize[1] );
 		$this->assertEquals( 602, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'medium_large' );
-		$this->assertEquals( '2007-06-17DSC_4173-600x904.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( '2007-06-17DSC_4173-600x904.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 600, $downsize[1] );
 		$this->assertEquals( 904, $downsize[2] );
 
 		$downsize = image_downsize( $id, 'full' );
-		$this->assertEquals( '2007-06-17DSC_4173.jpg', basename( $downsize[0] ) );
+		$this->assertEquals( '2007-06-17DSC_4173.jpg', wp_basename( $downsize[0] ) );
 		$this->assertEquals( 680, $downsize[1] );
 		$this->assertEquals( 1024, $downsize[2] );
 	}
@@ -181,7 +181,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/2007-06-17DSC_4173.JPG' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$id      = $this->_make_attachment( $upload );
@@ -224,7 +224,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$upload['url'] = '';
@@ -241,7 +241,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$id = $this->_make_attachment( $upload );
@@ -267,7 +267,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		$attachment_id = $this->_make_attachment( $upload );
@@ -299,7 +299,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		// Set attachment ID.
@@ -324,7 +324,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		// Set attachment ID.
@@ -349,7 +349,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		// Set attachment ID
@@ -377,7 +377,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		// Set attachment ID.
@@ -405,7 +405,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		// Set attachment ID
@@ -432,7 +432,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = ( DIR_TESTDATA . '/images/test-image.jpg' );
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$this->assertTrue( empty( $upload['error'] ) );
 
 		// Set attachment ID
@@ -454,7 +454,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload        = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload        = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$attachment_id = $this->_make_attachment( $upload );
 
 		$this->assertTrue( wp_attachment_is_image( $attachment_id ) );
@@ -472,7 +472,7 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.psd';
 		$contents = file_get_contents( $filename );
 
-		$upload        = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload        = wp_upload_bits( wp_basename( $filename ), null, $contents );
 		$attachment_id = $this->_make_attachment( $upload );
 
 		$this->assertFalse( wp_attachment_is_image( $attachment_id ) );
@@ -489,13 +489,13 @@ class Tests_Post_Attachments extends WP_UnitTestCase {
 		$filename = DIR_TESTDATA . '/images/test-image.jpg';
 		$contents = file_get_contents( $filename );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 
 		$this->assertFalse( $upload['error'] );
 
 		add_filter( 'upload_mimes', array( $this, 'blacklist_jpg_mime_type' ) );
 
-		$upload = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload = wp_upload_bits( wp_basename( $filename ), null, $contents );
 
 		remove_filter( 'upload_mimes', array( $this, 'blacklist_jpg_mime_type' ) );
 
diff --git a/tests/post/getBodyClass.php b/tests/post/getBodyClass.php
index 5b0ade1bff..236d78e2ba 100644
--- a/tests/post/getBodyClass.php
+++ b/tests/post/getBodyClass.php
@@ -202,4 +202,60 @@ class Tests_Post_GetBodyClass extends WP_UnitTestCase {
 		$this->assertContains( "attachmentid-{$attachment_id}", $class );
 		$this->assertContains( 'attachment-jpeg', $class );
 	}
+
+	/**
+	 * @ticket 38168
+	 */
+	public function test_custom_background_class_is_added_when_theme_supports_it() {
+		add_theme_support( 'custom-background', array( 'default-color', '#ffffff' ) );
+		set_theme_mod( 'background_color', '#000000' );
+
+		$class                     = get_body_class();
+		$theme_supports_background = current_theme_supports( 'custom-background' );
+
+		remove_theme_mod( 'background_color' );
+		remove_theme_support( 'custom-background' );
+
+		$this->assertTrue( $theme_supports_background );
+		$this->assertContains( 'custom-background', $class );
+	}
+
+	/**
+	 * @ticket 38168
+	 */
+	public function test_custom_background_class_is_not_added_when_theme_support_is_missing() {
+		set_theme_mod( 'background_color', '#000000' );
+
+		$class                     = get_body_class();
+		$theme_supports_background = current_theme_supports( 'custom-background' );
+
+		remove_theme_mod( 'background_color' );
+
+		$this->assertFalse( $theme_supports_background );
+		$this->assertNotContains( 'custom-background', $class );
+	}
+
+	/**
+	 * @ticket 44005
+	 * @group privacy
+	 */
+	public function test_privacy_policy_body_class() {
+		$page_id = self::factory()->post->create(
+			array(
+				'post_type'  => 'page',
+				'post_title' => 'Privacy Policy',
+			)
+		);
+		update_option( 'wp_page_for_privacy_policy', $page_id );
+
+		$this->go_to( get_permalink( $page_id ) );
+
+		$class = get_body_class();
+
+		$this->assertContains( 'privacy-policy', $class );
+		$this->assertContains( 'page-template-default', $class );
+		$this->assertContains( 'page', $class );
+		$this->assertContains( "page-id-{$page_id}", $class );
+	}
+
 }
diff --git a/tests/post/getPages.php b/tests/post/getPages.php
index 2271cae672..b92ff088b9 100644
--- a/tests/post/getPages.php
+++ b/tests/post/getPages.php
@@ -21,8 +21,9 @@ class Tests_Post_getPages extends WP_UnitTestCase {
 
 		$pages = get_pages();
 		$this->assertEquals( 3, count( $pages ) );
-		$this->assertNotEmpty( $time1 = wp_cache_get( 'last_changed', 'posts' ) );
-		$num_queries                  = $wpdb->num_queries;
+		$time1 = wp_cache_get( 'last_changed', 'posts' );
+		$this->assertNotEmpty( $time1 );
+		$num_queries = $wpdb->num_queries;
 		foreach ( $pages as $page ) {
 			$this->assertInstanceOf( 'WP_Post', $page );
 		}
diff --git a/tests/post/getTheContent.php b/tests/post/getTheContent.php
new file mode 100644
index 0000000000..7bb14a1f93
--- /dev/null
+++ b/tests/post/getTheContent.php
@@ -0,0 +1,78 @@
+<?php
+
+/**
+ * @group post
+ * @group formatting
+ */
+class Tests_Post_GetTheContent extends WP_UnitTestCase {
+	/**
+	 * @ticket 42814
+	 */
+	public function test_argument_back_compat_more_link_text() {
+		$text = 'Foo<!--more-->Bar';
+		$p    = self::factory()->post->create( array( 'post_content' => $text ) );
+
+		$q = new WP_Query( array( 'p' => $p ) );
+		while ( $q->have_posts() ) {
+			$q->the_post();
+
+			$found = get_the_content( 'Ping' );
+		}
+
+		$this->assertContains( '>Ping<', $found );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_argument_back_compat_strip_teaser() {
+		$text = 'Foo<!--more-->Bar';
+		$p    = self::factory()->post->create( array( 'post_content' => $text ) );
+
+		$this->go_to( get_permalink( $p ) );
+
+		$q = new WP_Query( array( 'p' => $p ) );
+		while ( $q->have_posts() ) {
+			$q->the_post();
+
+			$found = get_the_content( null, true );
+		}
+
+		$this->assertNotContains( 'Foo', $found );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_content_other_post() {
+		$text_1 = 'Foo<!--nextpage-->Bar<!--nextpage-->Baz';
+		$post_1 = self::factory()->post->create_and_get( array( 'post_content' => $text_1 ) );
+
+		$text_2 = 'Bing<!--nextpage-->Bang<!--nextpage-->Boom';
+		$post_2 = self::factory()->post->create_and_get( array( 'post_content' => $text_2 ) );
+		setup_postdata( $post_1 );
+		$found = get_the_content( null, true, $post_2 );
+
+		$this->assertSame( 'Bing', $found );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_should_respect_pagination_of_inner_post() {
+		$text_1 = 'Foo<!--nextpage-->Bar<!--nextpage-->Baz';
+		$post_1 = self::factory()->post->create_and_get( array( 'post_content' => $text_1 ) );
+
+		$text_2 = 'Bing<!--nextpage-->Bang<!--nextpage-->Boom';
+		$post_2 = self::factory()->post->create_and_get( array( 'post_content' => $text_2 ) );
+		$go_to  = add_query_arg( 'page', '2', get_permalink( $post_1->ID ) );
+		$this->go_to( $go_to );
+
+		while ( have_posts() ) {
+			the_post();
+			$found = get_the_content( '', false, $post_2 );
+		}
+
+		$this->assertSame( 'Bang', $found );
+	}
+}
diff --git a/tests/post/getTheExcerpt.php b/tests/post/getTheExcerpt.php
index 65e5bb0f03..8633a27c35 100644
--- a/tests/post/getTheExcerpt.php
+++ b/tests/post/getTheExcerpt.php
@@ -57,4 +57,92 @@ class Tests_Post_GetTheExcerpt extends WP_UnitTestCase {
 		$post_id         = self::factory()->post->create( array( 'post_excerpt' => 'Bar' ) );
 		$this->assertSame( 'Bar', get_the_excerpt( $post_id ) );
 	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_should_fall_back_on_post_content_if_excerpt_is_empty_and_post_is_inferred_from_context() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_content' => 'Foo',
+				'post_excerpt' => '',
+			)
+		);
+
+		$q = new WP_Query(
+			array(
+				'p' => $post_id,
+			)
+		);
+
+		while ( $q->have_posts() ) {
+			$q->the_post();
+			$found = get_the_excerpt();
+		}
+
+		$this->assertSame( 'Foo', $found );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_should_fall_back_on_post_content_if_excerpt_is_empty_and_post_is_provided() {
+		$GLOBALS['post'] = self::factory()->post->create_and_get(
+			array(
+				'post_content' => 'Foo',
+				'post_excerpt' => '',
+			)
+		);
+		$this->assertSame( 'Foo', get_the_excerpt( $GLOBALS['post'] ) );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_should_respect_post_parameter_in_the_loop() {
+		$p1 = self::factory()->post->create_and_get( array( 'post_excerpt' => 'Foo' ) );
+		$p2 = self::factory()->post->create_and_get( array( 'post_excerpt' => 'Bar' ) );
+		$q  = new WP_Query(
+			array(
+				'p' => $p1->ID,
+			)
+		);
+
+		while ( $q->have_posts() ) {
+			$q->the_post();
+			$found = get_the_excerpt( $p2 );
+		}
+
+		$this->assertSame( 'Bar', $found );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_should_respect_post_parameter_in_the_loop_when_falling_back_on_post_content() {
+		$p1 = self::factory()->post->create_and_get(
+			array(
+				'post_content' => 'Foo',
+				'post_excerpt' => '',
+			)
+		);
+		$p2 = self::factory()->post->create_and_get(
+			array(
+				'post_content' => 'Bar',
+				'post_excerpt' => '',
+			)
+		);
+		$q  = new WP_Query(
+			array(
+				'p' => $p1->ID,
+			)
+		);
+
+		while ( $q->have_posts() ) {
+			$q->the_post();
+			$found = get_the_excerpt( $p2 );
+		}
+
+		$this->assertSame( 'Bar', $found );
+	}
 }
diff --git a/tests/post/listPages.php b/tests/post/listPages.php
index 2c5a9a26c2..01efc5157d 100644
--- a/tests/post/listPages.php
+++ b/tests/post/listPages.php
@@ -49,7 +49,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 	public static function wpSetupBeforeClass() {
 		self::$time = time();
 
-		$post_date = date( 'Y-m-d H:i:s', self::$time );
+		$post_date = gmdate( 'Y-m-d H:i:s', self::$time );
 
 		self::$parent_1 = self::factory()->post->create(
 			array(
@@ -134,7 +134,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 </li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_depth() {
@@ -148,7 +148,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 <li class="page_item page-item-' . self::$parent_3 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_show_date() {
@@ -157,14 +157,14 @@ class Tests_List_Pages extends WP_UnitTestCase {
 			'depth'     => 1,
 			'show_date' => true,
 		);
-		$date = date( get_option( 'date_format' ), self::$time );
+		$date = gmdate( get_option( 'date_format' ), self::$time );
 
 		$expected = '<li class="pagenav">Pages<ul><li class="page_item page-item-' . self::$parent_1 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_1 ) . '">Parent 1</a> ' . $date . '</li>
 <li class="page_item page-item-' . self::$parent_2 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_2 ) . '">Parent 2</a> ' . $date . '</li>
 <li class="page_item page-item-' . self::$parent_3 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a> ' . $date . '</li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_date_format() {
@@ -173,7 +173,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 			'show_date'   => true,
 			'date_format' => 'l, F j, Y',
 		);
-		$date = date( $args['date_format'], self::$time );
+		$date = gmdate( $args['date_format'], self::$time );
 
 		$expected = '<li class="pagenav">Pages<ul><li class="page_item page-item-' . self::$parent_1 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_1 ) . '">Parent 1</a> ' . $date . '
 <ul class=\'children\'>
@@ -198,7 +198,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 </li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_child_of() {
@@ -212,7 +212,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 <li class="page_item page-item-' . self::$children[ self::$parent_2 ][2] . '"><a href="' . get_permalink( self::$children[ self::$parent_2 ][2] ) . '">Child 3</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_exclude() {
@@ -240,7 +240,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 <li class="page_item page-item-' . self::$children[ self::$parent_2 ][2] . '"><a href="' . get_permalink( self::$children[ self::$parent_2 ][2] ) . '">Child 3</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_title_li() {
@@ -255,7 +255,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 <li class="page_item page-item-' . self::$parent_3 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_echo() {
@@ -268,6 +268,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 <li class="page_item page-item-' . self::$parent_2 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_2 ) . '">Parent 2</a></li>
 <li class="page_item page-item-' . self::$parent_3 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a></li>
 </ul></li>';
+		$expected = str_replace( "\r\n", "\n", $expected );
 		$this->expectOutputString( $expected );
 		wp_list_pages( $args );
 	}
@@ -281,7 +282,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 		$expected = '<li class="pagenav">Pages<ul><li class="page_item page-item-' . self::$parent_3 . '"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_number() {
@@ -293,7 +294,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 		$expected = '<li class="pagenav">Pages<ul><li class="page_item page-item-' . self::$children[ self::$parent_1 ][0] . '"><a href="' . get_permalink( self::$children[ self::$parent_1 ][0] ) . '">Child 1</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_sort_column() {
@@ -326,7 +327,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 </li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_link_before() {
@@ -358,7 +359,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 </li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_link_after() {
@@ -390,7 +391,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 </li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 
@@ -404,7 +405,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 <li class="page_item page-item-' . self::$parent_3 . '"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a></li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_exclude_tree() {
@@ -422,7 +423,7 @@ class Tests_List_Pages extends WP_UnitTestCase {
 </li>
 </ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEqualsIgnoreEOL( $expected, wp_list_pages( $args ) );
 	}
 
 	function test_wp_list_pages_discarded_whitespace() {
@@ -433,6 +434,6 @@ class Tests_List_Pages extends WP_UnitTestCase {
 
 		$expected = '<li class="pagenav">Pages<ul><li class="page_item page-item-' . self::$parent_1 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_1 ) . '">Parent 1</a><ul class=\'children\'><li class="page_item page-item-' . self::$children[ self::$parent_1 ][0] . '"><a href="' . get_permalink( self::$children[ self::$parent_1 ][0] ) . '">Child 1</a></li><li class="page_item page-item-' . self::$children[ self::$parent_1 ][1] . '"><a href="' . get_permalink( self::$children[ self::$parent_1 ][1] ) . '">Child 2</a></li><li class="page_item page-item-' . self::$children[ self::$parent_1 ][2] . '"><a href="' . get_permalink( self::$children[ self::$parent_1 ][2] ) . '">Child 3</a></li></ul></li><li class="page_item page-item-' . self::$parent_2 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_2 ) . '">Parent 2</a><ul class=\'children\'><li class="page_item page-item-' . self::$children[ self::$parent_2 ][0] . '"><a href="' . get_permalink( self::$children[ self::$parent_2 ][0] ) . '">Child 1</a></li><li class="page_item page-item-' . self::$children[ self::$parent_2 ][1] . '"><a href="' . get_permalink( self::$children[ self::$parent_2 ][1] ) . '">Child 2</a></li><li class="page_item page-item-' . self::$children[ self::$parent_2 ][2] . '"><a href="' . get_permalink( self::$children[ self::$parent_2 ][2] ) . '">Child 3</a></li></ul></li><li class="page_item page-item-' . self::$parent_3 . ' page_item_has_children"><a href="' . get_permalink( self::$parent_3 ) . '">Parent 3</a><ul class=\'children\'><li class="page_item page-item-' . self::$children[ self::$parent_3 ][0] . '"><a href="' . get_permalink( self::$children[ self::$parent_3 ][0] ) . '">Child 1</a></li><li class="page_item page-item-' . self::$children[ self::$parent_3 ][1] . '"><a href="' . get_permalink( self::$children[ self::$parent_3 ][1] ) . '">Child 2</a></li><li class="page_item page-item-' . self::$children[ self::$parent_3 ][2] . '"><a href="' . get_permalink( self::$children[ self::$parent_3 ][2] ) . '">Child 3</a></li></ul></li></ul></li>';
 
-		$this->AssertEquals( $expected, wp_list_pages( $args ) );
+		$this->assertEquals( $expected, wp_list_pages( $args ) );
 	}
 }
diff --git a/tests/post/meta.php b/tests/post/meta.php
index 2344b1db8f..a79228c070 100644
--- a/tests/post/meta.php
+++ b/tests/post/meta.php
@@ -95,7 +95,7 @@ class Tests_Post_Meta extends WP_UnitTestCase {
 			'another value',
 		);
 		sort( $expected );
-		$this->assertTrue( in_array( get_post_meta( self::$post_id, 'nonunique', true ), $expected ) );
+		$this->assertTrue( in_array( get_post_meta( self::$post_id, 'nonunique', true ), $expected, true ) );
 		$actual = get_post_meta( self::$post_id, 'nonunique', false );
 		sort( $actual );
 		$this->assertEquals( $expected, $actual );
diff --git a/tests/post/nav-menu.php b/tests/post/nav-menu.php
index 9ef3f8e390..978580e186 100644
--- a/tests/post/nav-menu.php
+++ b/tests/post/nav-menu.php
@@ -1,7 +1,7 @@
 <?php
 /**
  * @group post
- * @group navmenus
+ * @group menu
  */
 class Test_Nav_Menus extends WP_UnitTestCase {
 	/**
@@ -149,7 +149,7 @@ class Test_Nav_Menus extends WP_UnitTestCase {
 			array(
 				'menu-item-type'   => 'custom',
 				'menu-item-title'  => 'Wordpress.org',
-				'menu-item-link'   => 'http://wordpress.org',
+				'menu-item-url'    => 'http://wordpress.org',
 				'menu-item-status' => 'publish',
 			)
 		);
@@ -651,9 +651,9 @@ class Test_Nav_Menus extends WP_UnitTestCase {
 		);
 		$tag_id  = self::factory()->tag->create();
 
-		$wpdb->query( "UPDATE $wpdb->posts SET ID=$new_id WHERE ID=$page_id" );
-		$wpdb->query( "UPDATE $wpdb->terms SET term_id=$new_id WHERE term_id=$tag_id" );
-		$wpdb->query( "UPDATE $wpdb->term_taxonomy SET term_id=$new_id WHERE term_id=$tag_id" );
+		$wpdb->update( $wpdb->posts, array( 'ID' => $new_id ), array( 'ID' => $page_id ) );
+		$wpdb->update( $wpdb->terms, array( 'term_id' => $new_id ), array( 'term_id' => $tag_id ) );
+		$wpdb->update( $wpdb->term_taxonomy, array( 'term_id' => $new_id ), array( 'term_id' => $tag_id ) );
 
 		update_option( 'page_on_front', $new_id );
 
@@ -861,4 +861,99 @@ class Test_Nav_Menus extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @ticket 44005
+	 * @group privacy
+	 */
+	function test_no_privacy_policy_class_applied() {
+		$page_id = self::factory()->post->create(
+			array(
+				'post_type'  => 'page',
+				'post_title' => 'Privacy Policy Page',
+			)
+		);
+
+		wp_update_nav_menu_item(
+			$this->menu_id,
+			0,
+			array(
+				'menu-item-type'      => 'post_type',
+				'menu-item-object'    => 'page',
+				'menu-item-object-id' => $page_id,
+				'menu-item-status'    => 'publish',
+			)
+		);
+
+		$menu_items = wp_get_nav_menu_items( $this->menu_id );
+		_wp_menu_item_classes_by_context( $menu_items );
+
+		$classes = $menu_items[0]->classes;
+
+		$this->assertNotContains( 'menu-item-privacy-policy', $classes );
+	}
+
+	/**
+	 * @ticket 44005
+	 * @group privacy
+	 */
+	function test_class_applied_to_privacy_policy_page_item() {
+		$page_id = self::factory()->post->create(
+			array(
+				'post_type'  => 'page',
+				'post_title' => 'Privacy Policy Page',
+			)
+		);
+		update_option( 'wp_page_for_privacy_policy', $page_id );
+
+		wp_update_nav_menu_item(
+			$this->menu_id,
+			0,
+			array(
+				'menu-item-type'      => 'post_type',
+				'menu-item-object'    => 'page',
+				'menu-item-object-id' => $page_id,
+				'menu-item-status'    => 'publish',
+			)
+		);
+
+		$menu_items = wp_get_nav_menu_items( $this->menu_id );
+		_wp_menu_item_classes_by_context( $menu_items );
+
+		$classes = $menu_items[0]->classes;
+
+		delete_option( 'wp_page_for_privacy_policy' );
+
+		$this->assertContains( 'menu-item-privacy-policy', $classes );
+	}
+
+	/**
+	 * @ticket 47723
+	 * @dataProvider data_trim_url_for_custom_item
+	 */
+	function test_trim_url_for_custom_item( $custom_url, $correct_url ) {
+		$custom_item_id = wp_update_nav_menu_item(
+			$this->menu_id,
+			0,
+			array(
+				'menu-item-type'   => 'custom',
+				'menu-item-title'  => 'WordPress.org',
+				'menu-item-url'    => $custom_url,
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		$custom_item = wp_setup_nav_menu_item( get_post( $custom_item_id ) );
+		$this->assertEquals( $correct_url, $custom_item->url );
+	}
+
+	/**
+	 * Provides data for test_trim_url_for_custom_item().
+	 */
+	function data_trim_url_for_custom_item() {
+		return array(
+			array( 'https://wordpress.org ', 'https://wordpress.org' ),
+			array( ' https://wordpress.org', 'https://wordpress.org' ),
+		);
+	}
+
 }
diff --git a/tests/post/objects.php b/tests/post/objects.php
index d468e4e5c4..c2d05a555a 100644
--- a/tests/post/objects.php
+++ b/tests/post/objects.php
@@ -36,7 +36,7 @@ class Tests_Post_Objects extends WP_UnitTestCase {
 		$post = get_post( $id, ARRAY_N );
 		$this->assertInternalType( 'array', $post );
 		$this->assertFalse( isset( $post['post_type'] ) );
-		$this->assertTrue( in_array( 'post', $post ) );
+		$this->assertTrue( in_array( 'post', $post, true ) );
 
 		$post = get_post( $id );
 		$post = get_post( $post, ARRAY_A );
diff --git a/tests/post/output.php b/tests/post/output.php
index b6c402ba89..02be7ffa6e 100644
--- a/tests/post/output.php
+++ b/tests/post/output.php
@@ -175,4 +175,183 @@ EOF;
 
 		kses_remove_filters();
 	}
+
+	/**
+	 * Ensure the_content handles a More block on a singular page.
+	 *
+	 * @ticket 46471
+	 *
+	 * @group blocks
+	 */
+	public function test_the_content_should_handle_more_block_on_singular() {
+		$post_content = <<<EOF
+<!-- wp:paragraph -->
+<p>Teaser part.</p>
+<!-- /wp:paragraph -->
+
+<!-- wp:more {"customText":"Read More"} -->
+<!--more Read More-->
+<!-- /wp:more -->
+
+<!-- wp:paragraph -->
+<p>Second block.</p>
+<!-- /wp:paragraph -->
+EOF;
+
+		$post_id = self::factory()->post->create( compact( 'post_content' ) );
+
+		$expected_without_teaser = <<<EOF
+<span id="more-{$post_id}"></span>
+<p>Second block.</p>
+EOF;
+
+		$expected_with_teaser = <<<EOF
+<p>Teaser part.</p>
+<span id="more-{$post_id}"></span>
+<p>Second block.</p>
+EOF;
+
+		$this->go_to( get_permalink( $post_id ) );
+		$this->assertTrue( is_singular() );
+		$this->assertTrue( have_posts() );
+		$this->assertNull( the_post() );
+
+		// Without the teaser.
+		$actual = get_echo( 'the_content', array( null, true ) );
+		$this->assertSame( strip_ws( $expected_without_teaser ), strip_ws( $actual ) );
+
+		// With the teaser.
+		$actual = get_echo( 'the_content', array( null, false ) );
+		$this->assertSame( strip_ws( $expected_with_teaser ), strip_ws( $actual ) );
+	}
+
+	/**
+	 * Ensure the_content handles a More block when using the noteaser text tag on a singular page.
+	 *
+	 * @ticket 46471
+	 *
+	 * @group blocks
+	 */
+	public function test_the_content_should_handle_more_block_when_noteaser_on_singular() {
+		$post_content = <<<EOF
+<!-- wp:paragraph -->
+<p>Teaser part.</p>
+<!-- /wp:paragraph -->
+
+<!-- wp:more -->
+<!--more-->
+<!--noteaser-->
+<!-- /wp:more -->
+
+<!-- wp:paragraph -->
+<p>Second block.</p>
+<!-- /wp:paragraph -->
+EOF;
+
+		$post_id = self::factory()->post->create( compact( 'post_content' ) );
+
+		$expected = <<<EOF
+<span id="more-{$post_id}"></span>
+<!--noteaser-->
+<p>Second block.</p>
+EOF;
+
+		$this->go_to( get_permalink( $post_id ) );
+		$this->assertTrue( is_singular() );
+		$this->assertTrue( have_posts() );
+		$this->assertNull( the_post() );
+
+		$actual = get_echo( 'the_content', array( null, true ) );
+		$this->assertSame( strip_ws( $expected ), strip_ws( $actual ) );
+
+		$actual = get_echo( 'the_content', array( null, false ) );
+		$this->assertSame( strip_ws( $expected ), strip_ws( $actual ) );
+	}
+
+	/**
+	 * Ensure the_content displays the teaser part with a read more link
+	 * for a More block on a non-singular page.
+	 *
+	 * @ticket 46471
+	 *
+	 * @group blocks
+	 */
+	public function test_the_content_should_handle_more_block_when_non_singular() {
+		$post_content = <<<EOF
+<!-- wp:paragraph -->
+<p>Teaser part.</p>
+<!-- /wp:paragraph -->
+
+<!-- wp:more {"customText":"Read More"} -->
+<!--more Read More-->
+<!-- /wp:more -->
+
+<!-- wp:paragraph -->
+<p>Second block.</p>
+<!-- /wp:paragraph -->
+EOF;
+
+		$post_id = self::factory()->post->create( compact( 'post_content' ) );
+
+		$expected = <<<EOF
+<span id="more-{$post_id}"></span>
+<p>Second block.</p>
+EOF;
+
+		$this->go_to( home_url() );
+		$this->assertFalse( is_singular() );
+		$this->assertTrue( have_posts() );
+		$this->assertNull( the_post() );
+
+		foreach ( array( true, false ) as $strip_teaser ) {
+			$actual = get_echo( 'the_content', array( null, $strip_teaser ) );
+			$this->assertContains( 'Teaser part', $actual );
+			$this->assertContains( 'Read More</a>', $actual );
+			$this->assertNotContains( '<!--more-->', $actual );
+			$this->assertNotContains( 'wp:more', $actual );
+			$this->assertNotContains( 'wp:paragraph', $actual );
+		}
+	}
+
+	/**
+	 * Ensure the_content displays the teaser part with a read more link for a More block
+	 * when using the noteaser text tag on a non-singular page.
+	 *
+	 * @ticket 46471
+	 *
+	 * @group blocks
+	 */
+	public function test_the_content_should_handle_more_block_when_noteaser_on_non_singular() {
+		$post_content = <<<EOF
+<!-- wp:paragraph -->
+<p>Teaser part.</p>
+<!-- /wp:paragraph -->
+
+<!-- wp:more -->
+<!--more-->
+<!--noteaser-->
+<!-- /wp:more -->
+
+<!-- wp:paragraph -->
+<p>Second block.</p>
+<!-- /wp:paragraph -->
+EOF;
+
+		$post_id = self::factory()->post->create( compact( 'post_content' ) );
+
+		$this->go_to( home_url() );
+		$this->assertFalse( is_singular() );
+		$this->assertTrue( have_posts() );
+		$this->assertNull( the_post() );
+
+		foreach ( array( true, false ) as $strip_teaser ) {
+			$actual = get_echo( 'the_content', array( null, $strip_teaser ) );
+			$this->assertContains( 'Teaser part', $actual );
+			$this->assertContains( '(more&hellip;)</span></a>', $actual );
+			$this->assertNotContains( '<!--more-->', $actual );
+			$this->assertNotContains( '<!--noteaser-->', $actual ); // We placed the noteaser tag below the more tag.
+			$this->assertNotContains( 'wp:more', $actual );
+			$this->assertNotContains( 'wp:paragraph', $actual );
+		}
+	}
 }
diff --git a/tests/post/query.php b/tests/post/query.php
index 7388dc24b7..4bac94c1bc 100644
--- a/tests/post/query.php
+++ b/tests/post/query.php
@@ -705,11 +705,6 @@ class Tests_Post_Query extends WP_UnitTestCase {
 	 * @dataProvider set_found_posts_provider
 	 */
 	public function test_set_found_posts_not_posts_as_an_array( $posts, $expected ) {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			$this->markTestSkipped( 'ReflectionMethod::setAccessible is only available in PHP 5.3+' );
-			return;
-		}
-
 		$q = new WP_Query(
 			array(
 				'post_type'      => 'wptests_pt',
diff --git a/tests/post/revisions.php b/tests/post/revisions.php
index bbb25a8ad6..b3927a537e 100644
--- a/tests/post/revisions.php
+++ b/tests/post/revisions.php
@@ -532,7 +532,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 		$now          = time();
 		for ( $j = 1; $j < 3; $j++ ) {
 			// Manually modify dates to ensure they're different.
-			$date                                  = date( 'Y-m-d H:i:s', $now - ( $j * 10 ) );
+			$date                                  = gmdate( 'Y-m-d H:i:s', $now - ( $j * 10 ) );
 			$post_revision_fields['post_date']     = $date;
 			$post_revision_fields['post_date_gmt'] = $date;
 
@@ -563,7 +563,7 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 		$post_revision_fields = wp_slash( $post_revision_fields );
 
 		$revision_ids = array();
-		$date         = date( 'Y-m-d H:i:s', time() - 10 );
+		$date         = gmdate( 'Y-m-d H:i:s', time() - 10 );
 		for ( $j = 1; $j < 3; $j++ ) {
 			// Manually modify dates to ensure they're the same.
 			$post_revision_fields['post_date']     = $date;
diff --git a/tests/post/template.php b/tests/post/template.php
index 9be2fb63d2..56d26cf77b 100644
--- a/tests/post/template.php
+++ b/tests/post/template.php
@@ -164,7 +164,7 @@ class Tests_Post_Template extends WP_UnitTestCase {
 LINEAGE;
 
 		$output = wp_dropdown_pages( array( 'echo' => 0 ) );
-		$this->assertEquals( $lineage, $output );
+		$this->assertEqualsIgnoreEOL( $lineage, $output );
 
 		$depth = <<<DEPTH
 <select name='page_id' id='page_id'>
@@ -179,7 +179,7 @@ DEPTH;
 				'depth' => 1,
 			)
 		);
-		$this->assertEquals( $depth, $output );
+		$this->assertEqualsIgnoreEOL( $depth, $output );
 
 		$option_none = <<<NONE
 <select name='page_id' id='page_id'>
@@ -197,7 +197,7 @@ NONE;
 				'option_none_value' => 'Woo',
 			)
 		);
-		$this->assertEquals( $option_none, $output );
+		$this->assertEqualsIgnoreEOL( $option_none, $output );
 
 		$option_no_change = <<<NO
 <select name='page_id' id='page_id'>
@@ -207,7 +207,8 @@ NONE;
 </select>
 
 NO;
-		$output           = wp_dropdown_pages(
+
+		$output = wp_dropdown_pages(
 			array(
 				'echo'                  => 0,
 				'depth'                 => 1,
@@ -216,7 +217,7 @@ NO;
 				'show_option_no_change' => 'Burrito',
 			)
 		);
-		$this->assertEquals( $option_no_change, $output );
+		$this->assertEqualsIgnoreEOL( $option_no_change, $output );
 	}
 
 	/**
diff --git a/tests/post/thumbnails.php b/tests/post/thumbnails.php
index d47527b5d0..e8ca9e41a7 100644
--- a/tests/post/thumbnails.php
+++ b/tests/post/thumbnails.php
@@ -71,7 +71,7 @@ class Tests_Post_Thumbnail_Template extends WP_UnitTestCase {
 	function test_update_post_thumbnail_cache() {
 		set_post_thumbnail( self::$post, self::$attachment_id );
 
-		$WP_Query = new WP_Query(
+		$query = new WP_Query(
 			array(
 				'post_type' => 'any',
 				'post__in'  => array( self::$post->ID ),
@@ -79,11 +79,11 @@ class Tests_Post_Thumbnail_Template extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertFalse( $WP_Query->thumbnails_cached );
+		$this->assertFalse( $query->thumbnails_cached );
 
-		update_post_thumbnail_cache( $WP_Query );
+		update_post_thumbnail_cache( $query );
 
-		$this->assertTrue( $WP_Query->thumbnails_cached );
+		$this->assertTrue( $query->thumbnails_cached );
 	}
 
 	/**
@@ -392,7 +392,7 @@ class Tests_Post_Thumbnail_Template extends WP_UnitTestCase {
 			self::$different_post->ID => 'thumbnail',
 		);
 
-		$post = $which_post === 1 ? self::$different_post : self::$post;
+		$post = 1 === $which_post ? self::$different_post : self::$post;
 
 		add_filter( 'post_thumbnail_size', array( $this, 'filter_post_thumbnail_size' ), 10, 2 );
 
diff --git a/tests/post/types.php b/tests/post/types.php
index 0bfb6d103b..cdab0337f3 100644
--- a/tests/post/types.php
+++ b/tests/post/types.php
@@ -305,9 +305,9 @@ class Tests_Post_Types extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertInternalType( 'int', array_search( 'bar', $wp->public_query_vars ) );
+		$this->assertInternalType( 'int', array_search( 'bar', $wp->public_query_vars, true ) );
 		$this->assertTrue( unregister_post_type( 'foo' ) );
-		$this->assertFalse( array_search( 'bar', $wp->public_query_vars ) );
+		$this->assertFalse( array_search( 'bar', $wp->public_query_vars, true ) );
 	}
 
 	/**
diff --git a/tests/post/walkerPage.php b/tests/post/walkerPage.php
new file mode 100644
index 0000000000..14963e9b32
--- /dev/null
+++ b/tests/post/walkerPage.php
@@ -0,0 +1,87 @@
+<?php
+/**
+ * @group post
+ * @group walker
+ */
+class Tests_Post_Walker_Page extends WP_UnitTestCase {
+
+	/**
+	 * @var \Walker_Page The instance of the walker.
+	 */
+	public $walker;
+
+	/**
+	 * Setup.
+	 */
+	public function setUp() {
+		parent::setUp();
+
+		/** Walker_Page class */
+		require_once ABSPATH . 'wp-includes/class-walker-page.php';
+		$this->walker = new Walker_Page();
+	}
+
+	/**
+	 * @ticket 47720
+	 *
+	 * @dataProvider data_start_el_with_empty_attributes
+	 */
+	public function test_start_el_with_empty_attributes( $value, $expected ) {
+		$output = '';
+		$page   = $this->factory->post->create_and_get( array( 'post_type' => 'page' ) );
+		$link   = get_permalink( $page );
+
+		add_filter(
+			'page_menu_link_attributes',
+			function( $atts ) use ( $value ) {
+				$atts['data-test'] = $value;
+				return $atts;
+			}
+		);
+
+		$this->walker->start_el( $output, $page, 0 );
+
+		if ( '' !== $expected ) {
+			$expected = sprintf( ' data-test="%s"', $expected );
+		}
+
+		$this->assertSame( "<li class=\"page_item page-item-{$page->ID}\"><a href=\"{$link}\"{$expected}>{$page->post_title}</a>", $output );
+	}
+
+	public function data_start_el_with_empty_attributes() {
+		return array(
+			array(
+				'',
+				'',
+			),
+			array(
+				0,
+				'0',
+			),
+			array(
+				0.0,
+				'0',
+			),
+			array(
+				'0',
+				'0',
+			),
+			array(
+				null,
+				'',
+			),
+			array(
+				false,
+				'',
+			),
+			array(
+				true,
+				'1',
+			),
+			array(
+				array(),
+				'',
+			),
+		);
+	}
+}
diff --git a/tests/post/wpInsertPost.php b/tests/post/wpInsertPost.php
index 519248a567..649dd55e28 100644
--- a/tests/post/wpInsertPost.php
+++ b/tests/post/wpInsertPost.php
@@ -302,4 +302,29 @@ class Tests_WPInsertPost extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
+	/**
+	 * @ticket 25347
+	 */
+	function test_scheduled_post_with_a_past_date_should_be_published() {
+
+		$now = new DateTimeImmutable( 'now', new DateTimeZone( 'UTC' ) );
+
+		$post_id = $this->factory()->post->create(
+			array(
+				'post_date_gmt' => $now->modify( '-1 year' )->format( 'Y-m-d H:i:s' ),
+				'post_status'   => 'future',
+			)
+		);
+
+		$this->assertEquals( 'publish', get_post_status( $post_id ) );
+
+		$post_id = $this->factory()->post->create(
+			array(
+				'post_date_gmt' => $now->modify( '+50 years' )->format( 'Y-m-d H:i:s' ),
+				'post_status'   => 'future',
+			)
+		);
+
+		$this->assertEquals( 'future', get_post_status( $post_id ) );
+	}
 }
diff --git a/tests/post/wpPostType.php b/tests/post/wpPostType.php
index 18bfe782cf..041d1320c2 100644
--- a/tests/post/wpPostType.php
+++ b/tests/post/wpPostType.php
@@ -62,6 +62,47 @@ class Tests_WP_Post_Type extends WP_UnitTestCase {
 		$this->assertEqualSets( array(), $post_type_supports_after );
 	}
 
+	/**
+	 * Test that supports can optionally receive nested args.
+	 *
+	 * @ticket 40413
+	 */
+	public function test_add_supports_custom_with_args() {
+		$post_type        = 'cpt';
+		$post_type_object = new WP_Post_Type(
+			$post_type,
+			array(
+				'supports' => array(
+					'support_with_args' => array(
+						'arg1',
+						'arg2',
+					),
+					'support_without_args',
+				),
+			)
+		);
+
+		$post_type_object->add_supports();
+		$post_type_supports = get_all_post_type_supports( $post_type );
+
+		$post_type_object->remove_supports();
+		$post_type_supports_after = get_all_post_type_supports( $post_type );
+
+		$this->assertEqualSets(
+			array(
+				'support_with_args'    => array(
+					array(
+						'arg1',
+						'arg2',
+					),
+				),
+				'support_without_args' => true,
+			),
+			$post_type_supports
+		);
+		$this->assertEqualSets( array(), $post_type_supports_after );
+	}
+
 	public function test_does_not_add_query_var_if_not_public() {
 		$this->set_permalink_structure( '/%postname%' );
 
@@ -78,7 +119,7 @@ class Tests_WP_Post_Type extends WP_UnitTestCase {
 		);
 		$post_type_object->add_rewrite_rules();
 
-		$this->assertFalse( in_array( 'foobar', $wp->public_query_vars ) );
+		$this->assertFalse( in_array( 'foobar', $wp->public_query_vars, true ) );
 	}
 
 	public function test_adds_query_var_if_public() {
@@ -98,10 +139,10 @@ class Tests_WP_Post_Type extends WP_UnitTestCase {
 		);
 
 		$post_type_object->add_rewrite_rules();
-		$in_array = in_array( 'foobar', $wp->public_query_vars );
+		$in_array = in_array( 'foobar', $wp->public_query_vars, true );
 
 		$post_type_object->remove_rewrite_rules();
-		$in_array_after = in_array( 'foobar', $wp->public_query_vars );
+		$in_array_after = in_array( 'foobar', $wp->public_query_vars, true );
 
 		$this->assertTrue( $in_array );
 		$this->assertFalse( $in_array_after );
@@ -128,8 +169,8 @@ class Tests_WP_Post_Type extends WP_UnitTestCase {
 		$post_type_object->remove_rewrite_rules();
 		$rewrite_tags_after = $wp_rewrite->rewritecode;
 
-		$this->assertNotFalse( array_search( "%$post_type%", $rewrite_tags ) );
-		$this->assertFalse( array_search( "%$post_type%", $rewrite_tags_after ) );
+		$this->assertNotFalse( array_search( "%$post_type%", $rewrite_tags, true ) );
+		$this->assertFalse( array_search( "%$post_type%", $rewrite_tags_after, true ) );
 	}
 
 	public function test_register_meta_boxes() {
diff --git a/tests/post/wpUniquePostSlug.php b/tests/post/wpUniquePostSlug.php
index 575bec4fa4..eb6d637389 100644
--- a/tests/post/wpUniquePostSlug.php
+++ b/tests/post/wpUniquePostSlug.php
@@ -31,7 +31,8 @@ class Tests_Post_WpUniquePostSlug extends WP_UnitTestCase {
 					'post_title'   => $post_title,
 				);
 
-				$id = $this->post_ids[] = self::factory()->post->create( $post );
+				$id               = self::factory()->post->create( $post );
+				$this->post_ids[] = $id;
 			}
 
 			$post = get_post( $id );
diff --git a/tests/privacy/wpCreateUserRequest.php b/tests/privacy/wpCreateUserRequest.php
new file mode 100644
index 0000000000..17a20a587e
--- /dev/null
+++ b/tests/privacy/wpCreateUserRequest.php
@@ -0,0 +1,298 @@
+<?php
+/**
+ * Test the `wp_create_user_request()` function.
+ *
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 5.2.0
+ */
+
+/**
+ * Tests_WpCreateUserRequest class.
+ *
+ * @group privacy
+ * @covers ::wp_create_user_request
+ *
+ * @since 5.2.0
+ */
+class Tests_WpCreateUserRequest extends WP_UnitTestCase {
+	/**
+	 * Request ID.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $request_id
+	 */
+	protected static $request_id;
+
+	/**
+	 * Request email for a registered user.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $registered_user_email
+	 */
+	protected static $registered_user_email;
+
+	/**
+	 * Request email for a non-registered user.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $non_registered_user_email
+	 */
+	protected static $non_registered_user_email;
+
+	/**
+	 * Test user ID.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $user_id
+	 */
+	protected static $user_id;
+
+	/**
+	 * Create fixtures.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param WP_UnitTest_Factory $factory Factory.
+	 */
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$registered_user_email     = 'export@local.test';
+		self::$non_registered_user_email = 'non-registered-user@local.test';
+
+		self::$user_id = $factory->user->create(
+			array(
+				'user_email' => self::$registered_user_email,
+			)
+		);
+
+		self::$request_id = $factory->post->create(
+			array(
+				'post_type'   => 'user_request',
+				'post_author' => self::$user_id,
+				'post_name'   => 'export_personal_data',
+				'post_status' => 'request-pending',
+				'post_title'  => self::$registered_user_email,
+			)
+		);
+	}
+
+	/**
+	 * Ensure a WP_Error is returned when an invalid email is passed.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_invalid_email() {
+		$actual = wp_create_user_request( 'not-a-valid-email', 'export_personal_data' );
+
+		$this->assertWPError( $actual );
+		$this->assertSame( 'invalid_email', $actual->get_error_code() );
+	}
+
+	/**
+	 * Ensure a WP_Error is returned when an invalid action is passed.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_invalid_action() {
+		$actual = wp_create_user_request( self::$registered_user_email, false );
+
+		$this->assertWPError( $actual );
+		$this->assertSame( 'invalid_action', $actual->get_error_code() );
+	}
+
+	/**
+	 * When there are incomplete requests for a registered user, a WP_Error should be returned.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_failure_due_to_incomplete_registered_user() {
+		// Second request (duplicated).
+		$actual = wp_create_user_request( self::$registered_user_email, 'export_personal_data' );
+
+		$this->assertWPError( $actual );
+		$this->assertSame( 'duplicate_request', $actual->get_error_code() );
+	}
+
+	/**
+	 * When there are incomplete requests for an non-registered user, a WP_Error should be returned.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_failure_due_to_incomplete_unregistered_user() {
+		// Update first request.
+		wp_update_post(
+			array(
+				'ID'          => self::$request_id,
+				'post_author' => 0,
+				'post_title'  => self::$non_registered_user_email,
+			)
+		);
+
+		// Second request (duplicated).
+		$actual = wp_create_user_request( self::$non_registered_user_email, 'export_personal_data' );
+
+		$this->assertWPError( $actual );
+		$this->assertSame( 'duplicate_request', $actual->get_error_code() );
+	}
+
+	/**
+	 * Ensure emails are properly sanitized.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_sanitized_email() {
+		$actual = wp_create_user_request( 'some(email<withinvalid\characters@local.test', 'export_personal_data' );
+
+		$this->assertNotWPError( $actual );
+
+		$post = get_post( $actual );
+
+		$this->assertSame( 'export_personal_data', $post->post_name );
+		$this->assertSame( 'someemailwithinvalidcharacters@local.test', $post->post_title );
+	}
+
+	/**
+	 * Ensure action names are properly sanitized.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_sanitized_action_name() {
+		$actual = wp_create_user_request( self::$non_registered_user_email, 'some[custom*action\name' );
+
+		$this->assertNotWPError( $actual );
+
+		$post = get_post( $actual );
+
+		$this->assertSame( 'somecustomactionname', $post->post_name );
+		$this->assertSame( self::$non_registered_user_email, $post->post_title );
+	}
+
+	/**
+	 * Test a user request is created successfully for a registered user.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_create_request_registered_user() {
+		wp_delete_post( self::$request_id, true );
+
+		$test_data = array(
+			'test-data'  => 'test value here',
+			'test index' => 'more privacy data',
+		);
+
+		$actual = wp_create_user_request( self::$registered_user_email, 'export_personal_data', $test_data );
+
+		$this->assertNotWPError( $actual );
+
+		$post = get_post( $actual );
+
+		$this->assertSame( self::$user_id, (int) $post->post_author );
+		$this->assertSame( 'export_personal_data', $post->post_name );
+		$this->assertSame( self::$registered_user_email, $post->post_title );
+		$this->assertSame( 'request-pending', $post->post_status );
+		$this->assertSame( 'user_request', $post->post_type );
+		$this->assertSame( wp_json_encode( $test_data ), $post->post_content );
+	}
+
+	/**
+	 * Test a user request is created successfully for an non-registered user.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_create_request_unregistered_user() {
+		wp_delete_post( self::$request_id, true );
+
+		$test_data = array(
+			'test-data'  => 'test value here',
+			'test index' => 'more privacy data',
+		);
+
+		$actual = wp_create_user_request( self::$non_registered_user_email, 'export_personal_data', $test_data );
+
+		$this->assertNotWPError( $actual );
+
+		$post = get_post( $actual );
+
+		$this->assertSame( 0, (int) $post->post_author );
+		$this->assertSame( 'export_personal_data', $post->post_name );
+		$this->assertSame( self::$non_registered_user_email, $post->post_title );
+		$this->assertSame( 'request-pending', $post->post_status );
+		$this->assertSame( 'user_request', $post->post_type );
+		$this->assertSame( wp_json_encode( $test_data ), $post->post_content );
+	}
+
+	/**
+	 * Test that a pre-existing request for the same registered user that is not pending or confirmed status does not
+	 * block a new request.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_completed_request_does_not_block_new_request() {
+		// Update first request.
+		wp_update_post(
+			array(
+				'ID'          => self::$request_id,
+				'post_status' => 'request-completed', // Not 'request-pending' or 'request-confirmed'.
+			)
+		);
+
+		// Second request.
+		$actual = wp_create_user_request( self::$registered_user_email, 'export_personal_data' );
+
+		$this->assertNotWPError( $actual );
+
+		$post = get_post( $actual );
+
+		$this->assertSame( self::$registered_user_email, $post->post_title );
+		$this->assertSame( 'request-pending', $post->post_status );
+		$this->assertSame( 'user_request', $post->post_type );
+	}
+
+	/**
+	 * Test that a pre-existing request for the same non-registered user that is not pending or confirmed status does not
+	 * block a new request.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_completed_request_does_not_block_new_request_for_unregistered_user() {
+		wp_update_post(
+			array(
+				'ID'          => self::$request_id,
+				'post_author' => 0,
+				'post_title'  => self::$non_registered_user_email,
+				'post_status' => 'request-failed', // Not 'request-pending' or 'request-confirmed'.
+			)
+		);
+
+		$actual = wp_create_user_request( self::$non_registered_user_email, 'export_personal_data' );
+
+		$this->assertNotWPError( $actual );
+
+		$post = get_post( $actual );
+
+		$this->assertSame( 0, (int) $post->post_author );
+		$this->assertSame( 'export_personal_data', $post->post_name );
+		$this->assertSame( self::$non_registered_user_email, $post->post_title );
+		$this->assertSame( 'request-pending', $post->post_status );
+		$this->assertSame( 'user_request', $post->post_type );
+	}
+
+	/**
+	 * Test that an error from `wp_insert_post()` is returned.
+	 *
+	 * @ticket 44707
+	 */
+	public function test_wp_error_returned_from_wp_insert_post() {
+		wp_delete_post( self::$request_id, true );
+
+		add_filter( 'wp_insert_post_empty_content', '__return_true' );
+		$actual = wp_create_user_request( self::$registered_user_email, 'export_personal_data' );
+
+		$this->assertWPError( $actual );
+		$this->assertSame( 'empty_content', $actual->get_error_code() );
+	}
+}
diff --git a/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php b/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
new file mode 100644
index 0000000000..9ca05dadca
--- /dev/null
+++ b/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
@@ -0,0 +1,267 @@
+<?php
+/**
+ * Define a class to test `wp_privacy_generate_personal_data_export_file()`.
+ *
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 5.2.0
+ */
+
+/**
+ * Test cases for `wp_privacy_generate_personal_data_export_file()`.
+ *
+ * @group privacy
+ * @covers ::wp_privacy_generate_personal_data_export_file
+ *
+ * @since 5.2.0
+ */
+class Tests_Privacy_WpPrivacyGeneratePersonalDataExportFile extends WP_UnitTestCase {
+	/**
+	 * An Export Request ID
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $export_request_id
+	 */
+	protected static $export_request_id;
+
+	/**
+	 * The full path to the export file for the current test method.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $export_file_name
+	 */
+	public $export_file_name = '';
+
+	/**
+	 * The full path to the exports directory.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $exports_dir
+	 */
+	public static $exports_dir;
+
+	/**
+	 * Create fixtures that are shared by multiple test cases.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param WP_UnitTest_Factory $factory The base factory object.
+	 */
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$export_request_id = wp_create_user_request( 'export-requester@example.com', 'export_personal_data' );
+		update_post_meta( self::$export_request_id, '_export_data_grouped', array() );
+		self::$exports_dir = wp_privacy_exports_dir();
+	}
+
+	/**
+	 * Set up the test fixture.
+	 *
+	 * Override `wp_die()`, pretend to be Ajax, and suppress `E_WARNING`s.
+	 *
+	 * @since 5.2.0
+	 */
+	public function setUp() {
+		parent::setUp();
+
+		$this->export_file_name = '';
+
+		if ( ! class_exists( 'ZipArchive' ) ) {
+			$this->markTestSkipped( 'The ZipArchive class is missing.' );
+		}
+
+		if ( ! $this->remove_exports_dir() ) {
+			$this->markTestSkipped( 'Existing exports directory could not be removed. Skipping test.' );
+		}
+
+		// We need to override the die handler. Otherwise, the unit tests will die too.
+		add_filter( 'wp_die_ajax_handler', array( $this, 'get_wp_die_handler' ), 1, 1 );
+		add_filter( 'wp_doing_ajax', '__return_true' );
+		add_action( 'wp_privacy_personal_data_export_file_created', array( $this, 'action_wp_privacy_personal_data_export_file_created' ) );
+
+		// Suppress warnings from "Cannot modify header information - headers already sent by".
+		$this->_error_level = error_reporting();
+		error_reporting( $this->_error_level & ~E_WARNING );
+	}
+
+	/**
+	 * Tear down the test fixture.
+	 *
+	 * Remove the `wp_die()` override, restore error reporting.
+	 *
+	 * @since 5.2.0
+	 */
+	public function tearDown() {
+		$this->remove_exports_dir();
+		error_reporting( $this->_error_level );
+		parent::tearDown();
+	}
+
+	/**
+	 * Stores the name of the export zip file to check the file is actually created.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $archive_name Created export zip file path.
+	 */
+	public function action_wp_privacy_personal_data_export_file_created( $archive_name ) {
+		$this->export_file_name = $archive_name;
+	}
+
+	/**
+	 * Removes the privacy exports directory, including files and subdirectories.
+	 *
+	 * Ignores hidden files and has upper limit of nested levels, because of `list_files()`.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @return bool Whether the privacy exports directory was removed.
+	 */
+	private function remove_exports_dir() {
+		/**
+		 * The `$exports_dir` will be a file after the `test_detect_cannot_create_folder()` test method, or,
+		 * if an incorrect value is returned to the `wp_privacy_exports_dir` filter.
+		 */
+		if ( is_file( untrailingslashit( self::$exports_dir ) ) ) {
+			wp_delete_file( untrailingslashit( self::$exports_dir ) );
+			return ! is_file( untrailingslashit( self::$exports_dir ) );
+		}
+
+		if ( ! is_dir( self::$exports_dir ) ) {
+			return true;
+		}
+
+		chmod( self::$exports_dir, 0755 );
+
+		$files = list_files( self::$exports_dir );
+
+		// Delete files first, then delete subdirectories.
+		foreach ( $files as $file ) {
+			if ( is_file( $file ) ) {
+				wp_delete_file( $file );
+			}
+		}
+
+		foreach ( $files as $file ) {
+			if ( is_dir( $file ) ) {
+				rmdir( $file );
+			}
+		}
+
+		rmdir( self::$exports_dir );
+
+		return ! is_dir( self::$exports_dir );
+	}
+
+	/**
+	 * When a remove request ID is passed to the export function an error should be displayed.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_rejects_remove_requests() {
+		$request_id = wp_create_user_request( 'removal-requester@example.com', 'remove_personal_data' );
+
+		$this->setExpectedException( 'WPDieException' );
+		$this->expectOutputString( '{"success":false,"data":"Invalid request ID when generating export file."}' );
+		wp_privacy_generate_personal_data_export_file( $request_id );
+	}
+
+	/**
+	 * When an invalid request ID is passed an error should be displayed.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_invalid_request_id() {
+		$this->setExpectedException( 'WPDieException' );
+		$this->expectOutputString( '{"success":false,"data":"Invalid request ID when generating export file."}' );
+		wp_privacy_generate_personal_data_export_file( 123456789 );
+	}
+
+	/**
+	 * When the request post title is not a valid email an error should be displayed.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_rejects_requests_with_bad_email_addresses() {
+		$request_id = wp_create_user_request( 'bad-email-requester@example.com', 'export_personal_data' );
+
+		wp_update_post(
+			array(
+				'ID'         => $request_id,
+				'post_title' => 'not-a-valid-email-address',
+			)
+		);
+
+		$this->setExpectedException( 'WPDieException' );
+		$this->expectOutputString( '{"success":false,"data":"Invalid email address when generating export file."}' );
+		wp_privacy_generate_personal_data_export_file( $request_id );
+	}
+
+	/**
+	 * When the export directory fails to be created an error should be displayed.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_detect_cannot_create_folder() {
+		// Create a file with the folder name to ensure the function cannot create a folder.
+		touch( untrailingslashit( self::$exports_dir ) );
+
+		$this->setExpectedException( 'WPDieException' );
+		$this->expectOutputString( '{"success":false,"data":"Unable to create export folder."}' );
+		wp_privacy_generate_personal_data_export_file( self::$export_request_id );
+	}
+
+	/**
+	 * Test that an index.html file can be added to the export directory.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_creates_index_in_export_folder() {
+		$this->expectOutputString( '' );
+		wp_privacy_generate_personal_data_export_file( self::$export_request_id );
+
+		$this->assertTrue( file_exists( self::$exports_dir . 'index.html' ) );
+	}
+
+	/**
+	 * Test that an export file is successfully created.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_can_succeed() {
+		wp_privacy_generate_personal_data_export_file( self::$export_request_id );
+
+		$this->assertTrue( file_exists( $this->export_file_name ) );
+	}
+
+	/**
+	 * Test the export file has all the expected parts.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_contents() {
+		$this->expectOutputString( '' );
+		wp_privacy_generate_personal_data_export_file( self::$export_request_id );
+		$this->assertTrue( file_exists( $this->export_file_name ) );
+
+		$report_dir = trailingslashit( self::$exports_dir . 'test_contents' );
+		mkdir( $report_dir );
+
+		$zip        = new ZipArchive();
+		$opened_zip = $zip->open( $this->export_file_name );
+		$this->assertTrue( $opened_zip );
+
+		$zip->extractTo( $report_dir );
+		$zip->close();
+		$this->assertTrue( file_exists( $report_dir . 'index.html' ) );
+
+		$report_contents = file_get_contents( $report_dir . 'index.html' );
+		$request         = wp_get_user_request_data( self::$export_request_id );
+
+		$this->assertContains( '<h1>Personal Data Export</h1>', $report_contents );
+		$this->assertContains( '<h2>About</h2>', $report_contents );
+		$this->assertContains( $request->email, $report_contents );
+	}
+}
diff --git a/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php b/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php
new file mode 100644
index 0000000000..688f790e22
--- /dev/null
+++ b/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php
@@ -0,0 +1,257 @@
+<?php
+/**
+ * Test cases for the `wp_privacy_generate_personal_data_export_group_html()` function.
+ *
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 5.2.0
+ */
+
+/**
+ * Tests_Privacy_WpPrivacyGeneratePersonalDataExportGroupHtml class.
+ *
+ * @group privacy
+ * @covers ::wp_privacy_generate_personal_data_export_group_html
+ *
+ * @since 5.2.0
+ */
+class Tests_Privacy_WpPrivacyGeneratePersonalDataExportGroupHtml extends WP_UnitTestCase {
+
+	/**
+	 * Test when a single data item is passed.
+	 *
+	 * @ticket 44044
+	 */
+	public function test_group_html_generation_single_data_item() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					array(
+						'name'  => 'Field 1 Name',
+						'value' => 'Field 1 Value',
+					),
+					array(
+						'name'  => 'Field 2 Name',
+						'value' => 'Field 2 Value',
+					),
+				),
+			),
+		);
+
+		$actual                = wp_privacy_generate_personal_data_export_group_html( $data );
+		$expected_table_markup = '<table><tbody><tr><th>Field 1 Name</th><td>Field 1 Value</td></tr><tr><th>Field 2 Name</th><td>Field 2 Value</td></tr></tbody></table>';
+
+		$this->assertContains( '<h2>Test Data Group</h2>', $actual );
+		$this->assertContains( $expected_table_markup, $actual );
+	}
+
+	/**
+	 * Test when a multiple data items are passed.
+	 *
+	 * @ticket 44044
+	 * @ticket 46895 Updated to remove </h2> from test to avoid Count introducing failure.
+	 */
+	public function test_group_html_generation_multiple_data_items() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					array(
+						'name'  => 'Field 1 Name',
+						'value' => 'Field 1 Value',
+					),
+					array(
+						'name'  => 'Field 2 Name',
+						'value' => 'Field 2 Value',
+					),
+				),
+				array(
+					array(
+						'name'  => 'Field 1 Name',
+						'value' => 'Another Field 1 Value',
+					),
+					array(
+						'name'  => 'Field 2 Name',
+						'value' => 'Another Field 2 Value',
+					),
+				),
+			),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertContains( '<h2>Test Data Group', $actual );
+		$this->assertContains( '<td>Field 1 Value', $actual );
+		$this->assertContains( '<td>Another Field 1 Value', $actual );
+		$this->assertContains( '<td>Field 2 Value', $actual );
+		$this->assertContains( '<td>Another Field 2 Value', $actual );
+		$this->assertSame( 2, substr_count( $actual, '<th>Field 1 Name' ) );
+		$this->assertSame( 2, substr_count( $actual, '<th>Field 2 Name' ) );
+		$this->assertSame( 4, substr_count( $actual, '<tr>' ) );
+	}
+
+	/**
+	 * Values that appear to be links should be wrapped in `<a>` tags.
+	 *
+	 * @ticket 44044
+	 */
+	public function test_links_become_anchors() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					array(
+						'name'  => 'HTTP Link',
+						'value' => 'http://wordpress.org',
+					),
+					array(
+						'name'  => 'HTTPS Link',
+						'value' => 'https://wordpress.org',
+					),
+					array(
+						'name'  => 'Link with Spaces',
+						'value' => 'https://wordpress.org not a link.',
+					),
+				),
+			),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertContains( '<a href="http://wordpress.org">http://wordpress.org</a>', $actual );
+		$this->assertContains( '<a href="https://wordpress.org">https://wordpress.org</a>', $actual );
+		$this->assertContains( 'https://wordpress.org not a link.', $actual );
+	}
+
+	/**
+	 * HTML in group labels should be escaped.
+	 *
+	 * @ticket 44044
+	 */
+	public function test_group_labels_escaped() {
+		$data = array(
+			'group_label' => '<div>Escape HTML in group lavels</div>',
+			'items'       => array(),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertContains( '<h2>&lt;div&gt;Escape HTML in group lavels&lt;/div&gt;</h2>', $actual );
+	}
+
+	/**
+	 * Test that the exported data should contain allowed HTML.
+	 *
+	 * @ticket 44044
+	 */
+	public function test_allowed_html_not_stripped() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					'links'      => array(
+						'name'  => 'Links are allowed',
+						'value' => '<a href="http://wordpress.org">http://wordpress.org</a>',
+					),
+					'formatting' => array(
+						'name'  => 'Simple formatting is allowed',
+						'value' => '<b>bold</b>, <em>emphasis</em>, <i>italics</i>, and <strong>strong</strong> are allowed.',
+					),
+				),
+			),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertContains( $data['items'][0]['links']['value'], $actual );
+		$this->assertContains( $data['items'][0]['formatting']['value'], $actual );
+	}
+
+	/**
+	 * Test that the exported data should not contain disallowed HTML.
+	 *
+	 * @ticket 44044
+	 */
+	public function test_disallowed_html_is_stripped() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					'scripts' => array(
+						'name'  => 'Script tags are not allowed.',
+						'value' => '<script>Testing that script tags are stripped.</script>',
+					),
+					'images'  => array(
+						'name'  => 'Images are not allowed',
+						'value' => '<img src="https://example.com/logo.jpg" alt="Alt text" />',
+					),
+				),
+			),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertNotContains( $data['items'][0]['scripts']['value'], $actual );
+		$this->assertContains( '<td>Testing that script tags are stripped.</td>', $actual );
+
+		$this->assertNotContains( $data['items'][0]['images']['value'], $actual );
+		$this->assertContains( '<th>Images are not allowed</th><td></td>', $actual );
+	}
+
+	/**
+	 * Test group count is displayed for multiple items.
+	 *
+	 * @ticket 46895
+	 */
+	public function test_group_html_generation_should_display_group_count_when_multiple_items() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					array(
+						'name'  => 'Field 1 Name',
+						'value' => 'Field 1 Value',
+					),
+				),
+				array(
+					array(
+						'name'  => 'Field 2 Name',
+						'value' => 'Field 2 Value',
+					),
+				),
+			),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertContains( '<h2>Test Data Group', $actual );
+		$this->assertContains( '<span class="count">(2)</span></h2>', $actual );
+		$this->assertSame( 2, substr_count( $actual, '<table>' ) );
+	}
+
+	/**
+	 * Test group count is not displayed for a single item.
+	 *
+	 * @ticket 46895
+	 */
+	public function test_group_html_generation_should_not_display_group_count_when_single_item() {
+		$data = array(
+			'group_label' => 'Test Data Group',
+			'items'       => array(
+				array(
+					array(
+						'name'  => 'Field 1 Name',
+						'value' => 'Field 1 Value',
+					),
+				),
+			),
+		);
+
+		$actual = wp_privacy_generate_personal_data_export_group_html( $data );
+
+		$this->assertContains( '<h2>Test Data Group</h2>', $actual );
+		$this->assertNotContains( '<span class="count">', $actual );
+		$this->assertSame( 1, substr_count( $actual, '<table>' ) );
+	}
+}
diff --git a/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php b/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
new file mode 100644
index 0000000000..baf0db89cc
--- /dev/null
+++ b/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
@@ -0,0 +1,704 @@
+<?php
+/**
+ * Test cases for the `wp_privacy_process_personal_data_export_page()` function.
+ *
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 5.2.0
+ */
+
+/**
+ * Tests_Privacy_WpPrivacyProcessPersonalDataExportPage class.
+ *
+ * @group privacy
+ * @covers ::wp_privacy_process_personal_data_export_page
+ *
+ * @since 5.2.0
+ */
+class Tests_Privacy_WpPrivacyProcessPersonalDataExportPage extends WP_UnitTestCase {
+	/**
+	 * Request ID.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $request_id
+	 */
+	protected static $request_id;
+
+	/**
+	 * Response for the First Page.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var array $response
+	 */
+	protected static $response_first_page;
+
+	/**
+	 * Response for the Last Page.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var array $response_last_page
+	 */
+	protected static $response_last_page;
+
+	/**
+	 * Export File Url.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $export_file_url
+	 */
+	protected static $export_file_url;
+
+	/**
+	 * Requester Email.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var string $requester_email
+	 */
+	protected static $requester_email;
+
+	/**
+	 * Index Of The First Page.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $page
+	 */
+	protected static $page_index_first;
+
+	/**
+	 * Index Of The Last Page.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $page_index_last
+	 */
+	protected static $page_index_last;
+
+	/**
+	 * Index of the First Exporter.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $exporter_index_first
+	 */
+	protected static $exporter_index_first;
+
+	/**
+	 * Index of the Last Exporter.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $exporter_index_last
+	 */
+	protected static $exporter_index_last;
+
+	/**
+	 * Key of the First Exporter.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $exporter_key_first
+	 */
+	protected static $exporter_key_first;
+
+	/**
+	 * Key of the Last Exporter.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var int $exporter_key_last
+	 */
+	protected static $exporter_key_last;
+
+	/**
+	 * Export data stored on the `wp_privacy_personal_data_export_file` action hook.
+	 *
+	 * @var string $_export_data_grouped_fetched_within_callback
+	 */
+	public $_export_data_grouped_fetched_within_callback;
+
+	/**
+	 * Create user request fixtures shared by test methods.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param WP_UnitTest_Factory $factory Factory.
+	 */
+	public static function wpSetUpBeforeClass( $factory ) {
+		self::$requester_email      = 'requester@example.com';
+		self::$export_file_url      = wp_privacy_exports_url() . 'wp-personal-data-file-requester-at-example-com-Wv0RfMnGIkl4CFEDEEkSeIdfLmaUrLsl.zip';
+		self::$request_id           = wp_create_user_request( self::$requester_email, 'export_personal_data' );
+		self::$page_index_first     = 1;
+		self::$page_index_last      = 2;
+		self::$exporter_index_first = 1;
+		self::$exporter_index_last  = 2;
+		self::$exporter_key_first   = 'custom-exporter-first';
+		self::$exporter_key_last    = 'custom-exporter-last';
+
+		$data = array(
+			array(
+				'group_id'          => 'custom-exporter-group-id',
+				'group_label'       => 'Custom Exporter Group Label',
+				'group_description' => 'Custom Exporter Group Description',
+				'item_id'           => 'custom-exporter-item-id',
+				'data'              => array(
+					array(
+						'name'  => 'Email',
+						'value' => self::$requester_email,
+					),
+				),
+			),
+		);
+
+		self::$response_first_page = array(
+			'done' => false,
+			'data' => $data,
+		);
+
+		self::$response_last_page = array(
+			'done' => true,
+			'data' => $data,
+		);
+	}
+
+	/**
+	 * Setup before each test method.
+	 *
+	 * @since 5.2.0
+	 */
+	public function setUp() {
+		parent::setUp();
+
+		// Avoid writing export files to disk. Using `WP_Filesystem_MockFS` is blocked by #44204.
+		remove_action( 'wp_privacy_personal_data_export_file', 'wp_privacy_generate_personal_data_export_file', 10 );
+
+		// Register our custom data exporters, very late, so we can override other unrelated exporters.
+		add_filter( 'wp_privacy_personal_data_exporters', array( $this, 'filter_register_custom_personal_data_exporters' ), 9999 );
+
+		// Set Ajax context for `wp_send_json()` and `wp_die()`.
+		add_filter( 'wp_doing_ajax', '__return_true' );
+
+		// Set up a `wp_die()` ajax handler that throws an exception, to be able to get
+		// the error message from `wp_send_json_error( 'some message here' )`,
+		// called by `wp_privacy_process_personal_data_export_page()`.
+		add_filter( 'wp_die_ajax_handler', array( $this, 'get_wp_die_handler' ), 1, 1 );
+
+		// Suppress warnings from "Cannot modify header information - headers already sent by".
+		$this->_error_level = error_reporting();
+		error_reporting( $this->_error_level & ~E_WARNING );
+	}
+
+	/**
+	 * Clean up after each test method.
+	 *
+	 * @since 5.2.0
+	 */
+	public function tearDown() {
+		error_reporting( $this->_error_level );
+
+		parent::tearDown();
+	}
+
+	/**
+	 * Filter to register custom personal data exporters.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param  array $exporters An array of personal data exporters.
+	 * @return array $exporters An array of personal data exporters.
+	 */
+	public function filter_register_custom_personal_data_exporters( $exporters ) {
+		// Let's override other unrelated exporters.
+		$exporters = array();
+
+		$exporters[ self::$exporter_key_first ] = array(
+			'exporter_friendly_name' => __( 'Custom Exporter #1' ),
+			'callback'               => null,
+		);
+		$exporters[ self::$exporter_key_last ]  = array(
+			'exporter_friendly_name' => __( 'Custom Exporter #2' ),
+			'callback'               => null,
+		);
+
+		return $exporters;
+	}
+
+	/**
+	 * Set up a test method to properly assert an exception.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param string $expected_output The expected string exception output.
+	 */
+	private function _setup_expected_failure( $expected_output ) {
+		$this->setExpectedException( 'WPDieException' );
+		$this->expectOutputString( $expected_output );
+	}
+
+	/**
+	 * Ensure the correct errors are returned when exporter responses are incorrect.
+	 *
+	 * @ticket 44233
+	 *
+	 * @dataProvider data_wp_privacy_process_personal_data_export_page
+	 *
+	 * @param string|array $expected_response The response from the personal data exporter for the given test.
+	 */
+	public function test_wp_privacy_process_personal_data_export_page( $expected_response ) {
+		$actual_response = wp_privacy_process_personal_data_export_page(
+			$expected_response,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			self::$request_id,
+			true,
+			self::$exporter_key_last
+		);
+
+		$this->assertSame( $expected_response, $actual_response );
+	}
+
+	/**
+	 * Provide test cases for `test_wp_privacy_process_personal_data_export_page()`.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string|array $response The response from the personal data exporter to test. Can be a string or an array.
+	 *     }
+	 * }
+	 */
+	public function data_wp_privacy_process_personal_data_export_page() {
+		return array(
+			// Response is not an array.
+			array(
+				'not-an-array',
+			),
+			// Missing `done` array key.
+			array(
+				array(
+					'missing-done-array-key' => true,
+				),
+			),
+			// Missing `data` array key.
+			array(
+				array(
+					'done' => true,
+				),
+			),
+			// `data` key is not an array.
+			array(
+				array(
+					'done' => true,
+					'data' => 'not-an-array',
+				),
+			),
+			array(
+				array(
+					'done' => true,
+					'data' => array(),
+				),
+			),
+		);
+	}
+
+	/**
+	 * Provide test scenarios for both sending and not sending an email.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type bool $send_as_email Whether the final results of the export should be emailed to the user.
+	 *     }
+	 * }
+	 */
+	public function data_send_as_email_options() {
+		return array(
+			array(
+				true,
+			),
+			array(
+				false,
+			),
+		);
+	}
+
+	/**
+	 * The function should send a JSON error when receiving an invalid request ID.
+	 *
+	 * @ticket 44233
+	 *
+	 * @dataProvider data_send_as_email_options
+	 *
+	 * @param bool Whether the final results of the export should be emailed to the user.
+	 */
+	public function test_send_error_when_invalid_request_id( $send_as_email ) {
+		$response           = array(
+			'done' => true,
+			'data' => array(),
+		);
+		$invalid_request_id = 0;
+
+		// Process data, given the last exporter, on the last page and send as email.
+		$this->_setup_expected_failure( '{"success":false,"data":"Invalid request ID when merging exporter data."}' );
+
+		wp_privacy_process_personal_data_export_page(
+			$response,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			$invalid_request_id,
+			$send_as_email,
+			self::$exporter_key_last
+		);
+	}
+
+	/**
+	 * The function should send a JSON error when the request has an invalid action name.
+	 *
+	 * @ticket 44233
+	 *
+	 * @dataProvider data_send_as_email_options
+	 *
+	 * @param bool Whether the final results of the export should be emailed to the user.
+	 */
+	public function test_send_error_when_invalid_request_action_name( $send_as_email ) {
+		$response = array(
+			'done' => true,
+			'data' => array(),
+		);
+
+		// Create a valid request ID, but for a different action than the function expects.
+		$request_id = wp_create_user_request( self::$requester_email, 'remove_personal_data' );
+
+		// Process data, given the last exporter, on the last page and send as email.
+		$this->_setup_expected_failure( '{"success":false,"data":"Invalid request ID when merging exporter data."}' );
+
+		wp_privacy_process_personal_data_export_page(
+			$response,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			$request_id,
+			$send_as_email,
+			self::$exporter_key_last
+		);
+	}
+
+	/**
+	 * The function should store export raw data until the export finishes. Then the meta key should be deleted.
+	 *
+	 * @ticket 44233
+	 *
+	 * @dataProvider data_send_as_email_options
+	 *
+	 * @param bool Whether the final results of the export should be emailed to the user.
+	 *
+	 */
+	public function test_raw_data_post_meta( $send_as_email ) {
+		$this->assertEmpty( get_post_meta( self::$request_id, '_export_data_raw', true ) );
+
+		// Adds post meta when processing data, given the first exporter on the first page and send as email.
+		wp_privacy_process_personal_data_export_page(
+			self::$response_first_page,
+			self::$exporter_index_first,
+			self::$requester_email,
+			self::$page_index_first,
+			self::$request_id,
+			$send_as_email,
+			self::$exporter_key_first
+		);
+
+		$this->assertNotEmpty( get_post_meta( self::$request_id, '_export_data_raw', true ) );
+
+		// Deletes post meta when processing data, given the last exporter on the last page and send as email.
+		wp_privacy_process_personal_data_export_page(
+			self::$response_last_page,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			self::$request_id,
+			$send_as_email,
+			self::$exporter_key_last
+		);
+
+		$this->assertEmpty( get_post_meta( self::$request_id, '_export_data_raw', true ) );
+	}
+
+	/**
+	 * The function should add `_export_data_grouped` post meta for the request, only available
+	 * when personal data export file is generated.
+	 *
+	 * @ticket 44233
+	 *
+	 * @dataProvider data_send_as_email_options
+	 *
+	 * @param bool Whether the final results of the export should be emailed to the user.
+	 */
+	public function test_add_post_meta_with_groups_data_only_available_when_export_file_generated( $send_as_email ) {
+		// Adds post meta when processing data, given the first exporter on the first page and send as email.
+		wp_privacy_process_personal_data_export_page(
+			self::$response_first_page,
+			self::$exporter_index_first,
+			self::$requester_email,
+			self::$page_index_first,
+			self::$request_id,
+			true,
+			self::$exporter_key_first
+		);
+		$this->assertEmpty( get_post_meta( self::$request_id, '_export_data_grouped', true ) );
+
+		add_action( 'wp_privacy_personal_data_export_file', array( $this, 'action_callback_to_get_export_groups_data' ) );
+
+		// Process data, given the last exporter on the last page and send as email.
+		wp_privacy_process_personal_data_export_page(
+			self::$response_last_page,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			self::$request_id,
+			true,
+			self::$exporter_key_last
+		);
+
+		$this->assertNotEmpty( $this->_export_data_grouped_fetched_within_callback );
+		$this->assertEmpty( get_post_meta( self::$request_id, '_export_data_grouped', true ) );
+	}
+
+	/**
+	 * When mail delivery fails, the function should send a JSON error on the last page of the last exporter.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_send_error_on_last_page_of_last_exporter_when_mail_delivery_fails() {
+		// Cause `wp_mail()` to return false, to simulate mail delivery failure. Filter removed in tearDown.
+		add_filter( 'wp_mail_from', '__return_empty_string' );
+
+		// Process data, given the last exporter, on the last page and send as email.
+		$this->_setup_expected_failure( '{"success":false,"data":"Unable to send personal data export email."}' );
+
+		wp_privacy_process_personal_data_export_page(
+			self::$response_last_page,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			self::$request_id,
+			true,
+			self::$exporter_key_last
+		);
+	}
+
+	/**
+	 * The function should return the response, containing the export file URL, when not sent as email
+	 * for the last exporter on the last page.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_return_response_with_export_file_url_when_not_sent_as_email_for_last_exporter_on_last_page() {
+		update_post_meta( self::$request_id, '_export_file_url', self::$export_file_url );
+
+		// Process data, given the last exporter, on the last page and not send as email.
+		$actual_response = wp_privacy_process_personal_data_export_page(
+			self::$response_last_page,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			self::$request_id,
+			false,
+			self::$exporter_key_last
+		);
+
+		$this->assertArrayHasKey( 'url', $actual_response );
+		$this->assertSame( self::$export_file_url, $actual_response['url'] );
+		$this->assertSame( self::$response_last_page['done'], $actual_response['done'] );
+		$this->assertSame( self::$response_last_page['data'], $actual_response['data'] );
+	}
+
+	/**
+	 * The function should return the response, not containing the export file URL, when sent as email
+	 * for the last exporter on the last page.
+	 *
+	 * @ticket 44233
+	 */
+	public function test_return_response_without_export_file_url_when_sent_as_email_for_last_exporter_on_last_page() {
+		update_post_meta( self::$request_id, '_export_file_url', self::$export_file_url );
+
+		// Process data, given the last exporter, on the last page and send as email.
+		$actual_response = wp_privacy_process_personal_data_export_page(
+			self::$response_last_page,
+			self::$exporter_index_last,
+			self::$requester_email,
+			self::$page_index_last,
+			self::$request_id,
+			true,
+			self::$exporter_key_last
+		);
+
+		$this->assertArrayNotHasKey( 'url', $actual_response );
+		$this->assertSame( self::$response_last_page['done'], $actual_response['done'] );
+		$this->assertSame( self::$response_last_page['data'], $actual_response['data'] );
+	}
+
+	/**
+	 * Test that request statuses are properly transitioned.
+	 *
+	 * @ticket 44233
+	 *
+	 * @dataProvider data_export_page_status_transitions
+	 *
+	 * @param string $expected_status The expected post status after calling the function.
+	 * @param string $response_page   The exporter page to pass. Options are 'first' and 'last'. Default 'first'.
+	 * @param string $exporter_index  The exporter index to pass. Options are 'first' and 'last'. Default 'first'.
+	 * @param string $page_index      The page index to pass. Options are 'first' and 'last'. Default 'first'.
+	 * @param bool   $send_as_email   If the response should be sent as an email.
+	 * @param string $exporter_key    The slug (key) of the exporter to pass.
+	 */
+	public function test_request_status_transitions_correctly( $expected_status, $response_page, $exporter_index, $page_index, $send_as_email, $exporter_key ) {
+		if ( 'first' === $response_page ) {
+			$response_page = self::$response_first_page;
+		} else {
+			$response_page = self::$response_last_page;
+		}
+
+		if ( 'first' === $exporter_index ) {
+			$exporter_index = self::$exporter_index_first;
+		} else {
+			$exporter_index = self::$exporter_index_last;
+		}
+
+		if ( 'first' === $page_index ) {
+			$page_index = self::$page_index_first;
+		} else {
+			$page_index = self::$page_index_last;
+		}
+
+		if ( 'first' === $exporter_key ) {
+			$exporter_key = self::$exporter_key_first;
+		} else {
+			$exporter_key = self::$exporter_key_last;
+		}
+
+		wp_privacy_process_personal_data_export_page(
+			$response_page,
+			$exporter_index,
+			self::$requester_email,
+			$page_index,
+			self::$request_id,
+			$send_as_email,
+			$exporter_key
+		);
+
+		$this->assertSame( $expected_status, get_post_status( self::$request_id ) );
+	}
+
+	/**
+	 * Provide test cases for `test_wp_privacy_process_personal_data_export_page()`.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @string string $expected_status The expected post status after calling the function.
+	 *         @string string $response_page   The exporter page to pass. Options are 'first' and 'last'. Default 'first'.
+	 *         @string string $exporter_index  The exporter index to pass. Options are 'first' and 'last'. Default 'first'.
+	 *         @string string $page_index      The page index to pass. Options are 'first' and 'last'. Default 'first'.
+	 *         @bool   bool   $send_as_email   If the response should be sent as an email.
+	 *         @string string $exporter_key    The slug (key) of the exporter to pass.
+	 *     }
+	 * }
+	 */
+	public function data_export_page_status_transitions() {
+		return array(
+			// Mark the request as completed for the last exporter on the last page, with email.
+			array(
+				'request-completed',
+				'last',
+				'last',
+				'last',
+				true,
+				'last',
+			),
+			// Leave the request as pending for the last exporter on the last page, without email.
+			// This check was updated to account for admin vs user export.
+			// Don't mark the request as completed when it's an admin download.
+			array(
+				'request-pending',
+				'last',
+				'last',
+				'last',
+				false,
+				'last',
+			),
+			// Leave the request as pending when not the last exporter and not on the last page.
+			array(
+				'request-pending',
+				'first',
+				'first',
+				'first',
+				true,
+				'first',
+			),
+			array(
+				'request-pending',
+				'first',
+				'first',
+				'first',
+				false,
+				'first',
+			),
+			// Leave the request as pending when last exporter and not on the last page.
+			array(
+				'request-pending',
+				'first',
+				'last',
+				'first',
+				true,
+				'last',
+			),
+			array(
+				'request-pending',
+				'first',
+				'last',
+				'first',
+				false,
+				'last',
+			),
+			// Leave the request as pending when not last exporter on the last page.
+			array(
+				'request-pending',
+				'last',
+				'first',
+				'last',
+				true,
+				'last',
+			),
+			array(
+				'request-pending',
+				'last',
+				'first',
+				'last',
+				false,
+				'first',
+			),
+		);
+	}
+
+	/**
+	 * A callback for the `wp_privacy_personal_data_export_file` action that stores the
+	 * `_export_data_grouped` meta data locally for testing.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param int $request_id Request ID.
+	 */
+	public function action_callback_to_get_export_groups_data( $request_id ) {
+		$this->_export_data_grouped_fetched_within_callback = get_post_meta( $request_id, '_export_data_grouped', true );
+	}
+}
diff --git a/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php b/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
index 3954970994..01c90ae3bc 100644
--- a/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
+++ b/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
@@ -34,6 +34,24 @@ class Tests_Privacy_WpPrivacySendErasureFulfillmentNotification extends WP_UnitT
 	 */
 	protected static $requester_email;
 
+	/**
+	 * Request user.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var WP_User $request_user
+	 */
+	protected static $request_user;
+
+	/**
+	 * Test administrator user.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var WP_User $admin_user
+	 */
+	protected static $admin_user;
+
 	/**
 	 * Create user request fixtures shared by test methods.
 	 *
@@ -43,7 +61,20 @@ class Tests_Privacy_WpPrivacySendErasureFulfillmentNotification extends WP_UnitT
 	 */
 	public static function wpSetUpBeforeClass( $factory ) {
 		self::$requester_email = 'erase-my-data@local.test';
-		self::$request_id      = wp_create_user_request( self::$requester_email, 'erase_personal_data' );
+		self::$request_user    = $factory->user->create_and_get(
+			array(
+				'user_email' => self::$requester_email,
+				'role'       => 'subscriber',
+			)
+		);
+		self::$admin_user      = $factory->user->create_and_get(
+			array(
+				'user_email' => 'admin@local.dev',
+				'role'       => 'administrator',
+			)
+		);
+
+		self::$request_id = wp_create_user_request( self::$requester_email, 'remove_personal_data' );
 		wp_update_post(
 			array(
 				'ID'          => self::$request_id,
@@ -69,6 +100,7 @@ class Tests_Privacy_WpPrivacySendErasureFulfillmentNotification extends WP_UnitT
 	 */
 	public function tearDown() {
 		reset_phpmailer_instance();
+		restore_previous_locale();
 		parent::tearDown();
 	}
 
@@ -276,4 +308,139 @@ class Tests_Privacy_WpPrivacySendErasureFulfillmentNotification extends WP_UnitT
 		$this->assertFalse( metadata_exists( 'post', self::$request_id, '_wp_user_notified' ) );
 	}
 
+	/**
+	 * The function should respect the user locale settings when the site uses the default locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 44721
+	 * @group l10n
+	 */
+	public function test_should_send_fulfillment_email_in_user_locale() {
+		update_user_meta( self::$request_user->ID, 'locale', 'es_ES' );
+
+		_wp_privacy_send_erasure_fulfillment_notification( self::$request_id );
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Solicitud de borrado completada', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site does not use en_US, the administrator
+	 * uses the site's default locale, and the user has a different locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 44721
+	 * @group l10n
+	 */
+	public function test_should_send_fulfillment_email_in_user_locale_when_site_is_not_en_us() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$request_user->ID, 'locale', 'de_DE' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		_wp_privacy_send_erasure_fulfillment_notification( self::$request_id );
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'L繹schauftrag ausgef羹hrt', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site is not en_US, the administrator
+	 * has a different selected locale, and the user uses the site's default locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 44721
+	 * @group l10n
+	 */
+	public function test_should_send_fulfillment_email_in_user_locale_when_admin_and_site_have_different_locales() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$admin_user->ID, 'locale', 'de_DE' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		_wp_privacy_send_erasure_fulfillment_notification( self::$request_id );
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Solicitud de borrado completada', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site is not en_US and both the
+	 * administrator and the user use different locales.
+	 *
+	 * @since 5.2.0
+	 * @ticket 44721
+	 * @group l10n
+	 */
+	public function test_should_send_fulfillment_email_in_user_locale_when_both_have_different_locales_than_site() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$admin_user->ID, 'locale', 'en_US' );
+		update_user_meta( self::$request_user->ID, 'locale', 'de_DE' );
+
+		wp_set_current_user( self::$admin_user->ID );
+
+		_wp_privacy_send_erasure_fulfillment_notification( self::$request_id );
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'L繹schauftrag ausgef羹hrt', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the site's locale when the request is for an unregistered user and the
+	 * administrator does not use the site's locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 44721
+	 * @group l10n
+	 */
+	public function test_should_send_fulfillment_email_in_site_locale() {
+		update_user_meta( self::$admin_user->ID, 'locale', 'es_ES' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		$request_id = wp_create_user_request( 'erase-user-not-registered@example.com', 'remove_personal_data' );
+		wp_update_post(
+			array(
+				'ID'          => $request_id,
+				'post_status' => 'request-completed',
+			)
+		);
+
+		_wp_privacy_send_erasure_fulfillment_notification( $request_id );
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Erasure Request Fulfilled', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the site's locale when it is not en_US, the request is for an
+	 * unregistered user, and the administrator does not use the site's default locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 44721
+	 * @group l10n
+	 */
+	public function test_should_send_fulfillment_email_in_site_locale_when_not_en_us_and_admin_has_different_locale() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$admin_user->ID, 'locale', 'de_DE' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		$request_id = wp_create_user_request( 'erase-user-not-registered@example.com', 'remove_personal_data' );
+		wp_update_post(
+			array(
+				'ID'          => $request_id,
+				'post_status' => 'request-completed',
+			)
+		);
+
+		_wp_privacy_send_erasure_fulfillment_notification( $request_id );
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Solicitud de borrado completada', $mailer->get_sent()->subject );
+	}
 }
diff --git a/tests/privacy/wpPrivacySendPersonalDataExportEmail.php b/tests/privacy/wpPrivacySendPersonalDataExportEmail.php
index 523ec76981..13ee61a59d 100644
--- a/tests/privacy/wpPrivacySendPersonalDataExportEmail.php
+++ b/tests/privacy/wpPrivacySendPersonalDataExportEmail.php
@@ -34,6 +34,24 @@ class Tests_Privacy_WpPrivacySendPersonalDataExportEmail extends WP_UnitTestCase
 	 */
 	protected static $requester_email;
 
+	/**
+	 * Request user.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var WP_User $request_user
+	 */
+	protected static $request_user;
+
+	/**
+	 * Test administrator user.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var WP_User $admin_user
+	 */
+	protected static $admin_user;
+
 	/**
 	 * Reset the mocked phpmailer instance before each test method.
 	 *
@@ -51,6 +69,7 @@ class Tests_Privacy_WpPrivacySendPersonalDataExportEmail extends WP_UnitTestCase
 	 */
 	public function tearDown() {
 		reset_phpmailer_instance();
+		restore_previous_locale();
 		parent::tearDown();
 	}
 
@@ -63,7 +82,20 @@ class Tests_Privacy_WpPrivacySendPersonalDataExportEmail extends WP_UnitTestCase
 	 */
 	public static function wpSetUpBeforeClass( $factory ) {
 		self::$requester_email = 'requester@example.com';
-		self::$request_id      = wp_create_user_request( self::$requester_email, 'export_personal_data' );
+		self::$request_user    = $factory->user->create_and_get(
+			array(
+				'user_email' => self::$requester_email,
+				'role'       => 'subscriber',
+			)
+		);
+		self::$admin_user      = $factory->user->create_and_get(
+			array(
+				'user_email' => 'admin@local.dev',
+				'role'       => 'administrator',
+			)
+		);
+
+		self::$request_id = wp_create_user_request( self::$requester_email, 'export_personal_data' );
 
 		_wp_privacy_account_request_confirmed( self::$request_id );
 	}
@@ -142,6 +174,58 @@ class Tests_Privacy_WpPrivacySendPersonalDataExportEmail extends WP_UnitTestCase
 		return 1513632600 - time();
 	}
 
+	/**
+	 * The email address of the recipient of the personal data export notification should be filterable.
+	 *
+	 * @ticket 46303
+	 */
+	public function test_email_address_of_recipient_should_be_filterable() {
+		add_filter( 'wp_privacy_personal_data_email_to', array( $this, 'filter_email_address' ) );
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertSame( 'modified-' . self::$requester_email, $mailer->get_recipient( 'to' )->address );
+	}
+
+	/**
+	 * Filter callback that modifies the email address of the recipient of the personal data export notification.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @param  string $user_email The email address of the notification recipient.
+	 * @return string $user_email The modified email address of the notification recipient.
+	 */
+	public function filter_email_address( $user_email ) {
+		return 'modified-' . $user_email;
+	}
+
+	/**
+	 * The email subject of the personal data export notification should be filterable.
+	 *
+	 * @ticket 46303
+	 */
+	public function test_email_subject_should_be_filterable() {
+		add_filter( 'wp_privacy_personal_data_email_subject', array( $this, 'filter_email_subject' ) );
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertSame( 'Modified subject', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * Filter callback that modifies the email subject of the data erasure fulfillment notification.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @param string $subject The email subject.
+	 * @return string $subject The email subject.
+	 */
+	public function filter_email_subject( $subject ) {
+		return 'Modified subject';
+	}
+
 	/**
 	 * The email content should be filterable.
 	 *
@@ -167,4 +251,177 @@ class Tests_Privacy_WpPrivacySendPersonalDataExportEmail extends WP_UnitTestCase
 	public function modify_email_content( $email_text, $request_id ) {
 		return 'Custom content for request ID: ' . $request_id;
 	}
+
+	/**
+	 * The email content should be filterable using the $email_data
+	 *
+	 * @ticket 46303
+	 */
+	public function test_email_content_should_be_filterable_using_email_data() {
+		add_filter( 'wp_privacy_personal_data_email_content', array( $this, 'modify_email_content_with_email_data' ), 10, 3 );
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$site_url = home_url();
+		$mailer   = tests_retrieve_phpmailer_instance();
+		$this->assertContains( 'Custom content using the $site_url of $email_data: ' . $site_url, $mailer->get_sent()->body );
+	}
+
+	/**
+	 * Filter callback that modifies the text of the email by using the $email_data sent with a personal data export file.
+	 *
+	 * @since 5.3.0
+	 *
+	 * @param string $email_text Text in the email.
+	 * @param int    $request_id The request ID for this personal data export.
+	 * @param array  $email_data {
+	 *     Data relating to the account action email.
+	 *
+	 *     @type WP_User_Request $request           User request object.
+	 *     @type int             $expiration        The time in seconds until the export file expires.
+	 *     @type string          $expiration_date   The localized date and time when the export file expires.
+	 *     @type string          $message_recipient The address that the email will be sent to. Defaults
+	 *                                              to the value of `$request->email`, but can be changed
+	 *                                              by the `wp_privacy_personal_data_email_to` filter.
+	 *     @type string          $export_file_url   The export file URL.
+	 *     @type string          $sitename          The site name sending the mail.
+	 *     @type string          $siteurl           The site URL sending the mail.
+	 * }
+	 *
+	 * @return string $email_text Text in the email.
+	 */
+	public function modify_email_content_with_email_data( $email_text, $request_id, $email_data ) {
+		return 'Custom content using the $site_url of $email_data: ' . $email_data['siteurl'];
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site uses the default locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 46056
+	 * @group l10n
+	 */
+	public function test_should_send_personal_data_export_email_in_user_locale() {
+		update_user_meta( self::$request_user->ID, 'locale', 'es_ES' );
+
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Exportaci籀n de datos personales', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site does not use en_US, the administrator
+	 * uses the site's default locale, and the user has a different locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 46056
+	 * @group l10n
+	 */
+	public function test_should_send_personal_data_export_email_in_user_locale_when_site_is_not_en_us() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$request_user->ID, 'locale', 'de_DE' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Export personenbezogener Daten', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site is not en_US, the administrator
+	 * has a different selected locale, and the user uses the site's default locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 46056
+	 * @group l10n
+	 */
+	public function test_should_send_personal_data_export_email_in_user_locale_when_admin_and_site_have_different_locales() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$admin_user->ID, 'locale', 'de_DE' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Exportaci籀n de datos personales', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the user locale settings when the site is not en_US and both the
+	 * administrator and the user use different locales.
+	 *
+	 * @since 5.2.0
+	 * @ticket 46056
+	 * @group l10n
+	 */
+	public function test_should_send_personal_data_export_email_in_user_locale_when_both_have_different_locales_than_site() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$admin_user->ID, 'locale', 'en_US' );
+		update_user_meta( self::$request_user->ID, 'locale', 'de_DE' );
+
+		wp_set_current_user( self::$admin_user->ID );
+
+		wp_privacy_send_personal_data_export_email( self::$request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Export personenbezogener Daten', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the site's locale when the request is for an unregistered user and the
+	 * administrator does not use the site's locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 46056
+	 * @group l10n
+	 */
+	public function test_should_send_personal_data_export_email_in_site_locale() {
+		update_user_meta( self::$admin_user->ID, 'locale', 'es_ES' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		$request_id = wp_create_user_request( 'export-user-not-registered@example.com', 'export_personal_data' );
+
+		_wp_privacy_account_request_confirmed( self::$request_id );
+		wp_privacy_send_personal_data_export_email( $request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Personal Data Export', $mailer->get_sent()->subject );
+	}
+
+	/**
+	 * The function should respect the site's locale when it is not en_US, the request is for an
+	 * unregistered user, and the administrator does not use the site's default locale.
+	 *
+	 * @since 5.2.0
+	 * @ticket 46056
+	 * @group l10n
+	 */
+	public function test_should_send_personal_data_export_email_in_site_locale_when_not_en_us_and_admin_has_different_locale() {
+		update_option( 'WPLANG', 'es_ES' );
+		switch_to_locale( 'es_ES' );
+
+		update_user_meta( self::$admin_user->ID, 'locale', 'de_DE' );
+		wp_set_current_user( self::$admin_user->ID );
+
+		$request_id = wp_create_user_request( 'export-user-not-registered@example.com', 'export_personal_data' );
+
+		_wp_privacy_account_request_confirmed( self::$request_id );
+		wp_privacy_send_personal_data_export_email( $request_id );
+
+		$mailer = tests_retrieve_phpmailer_instance();
+
+		$this->assertContains( 'Exportaci籀n de datos personales', $mailer->get_sent()->subject );
+	}
 }
diff --git a/tests/query/conditionals.php b/tests/query/conditionals.php
index 6be39befed..a67c6f29fc 100644
--- a/tests/query/conditionals.php
+++ b/tests/query/conditionals.php
@@ -161,20 +161,22 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 	// '(about)/trackback/?$' => 'index.php?pagename=$matches[1]&tb=1'
 	function test_page_trackback() {
 		$page_ids   = array();
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => 'parent-page',
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-1',
 				'post_parent' => $page_id,
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_ids[] = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-2',
@@ -197,20 +199,22 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 	//'(about)/feed/(feed|rdf|rss|rss2|atom)/?$' => 'index.php?pagename=$matches[1]&feed=$matches[2]'
 	function test_page_feed() {
 		$page_ids   = array();
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => 'parent-page',
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-1',
 				'post_parent' => $page_id,
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_ids[] = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-2',
@@ -233,20 +237,22 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 
 	function test_page_feed_with_no_comments() {
 		$page_ids   = array();
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => 'parent-page',
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-1',
 				'post_parent' => $page_id,
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_ids[] = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-2',
@@ -269,20 +275,22 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 	// '(about)/feed/(feed|rdf|rss|rss2|atom)/?$' => 'index.php?pagename=$matches[1]&feed=$matches[2]'
 	function test_page_feed_atom() {
 		$page_ids   = array();
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'  => 'page',
 				'post_title' => 'parent-page',
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_id    = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-1',
 				'post_parent' => $page_id,
 			)
 		);
-		$page_ids[] = $page_id = self::factory()->post->create(
+		$page_ids[] = $page_id;
+		$page_ids[] = self::factory()->post->create(
 			array(
 				'post_type'   => 'page',
 				'post_title'  => 'child-page-2',
@@ -1590,4 +1598,24 @@ class Tests_Query_Conditionals extends WP_UnitTestCase {
 		$this->assertTrue( is_single( $p2 ) );
 		$this->assertFalse( is_single( $p1 ) );
 	}
+
+	/**
+	 * @ticket 44005
+	 * @group privacy
+	 */
+	public function test_is_privacy_policy() {
+		$page_id = self::factory()->post->create(
+			array(
+				'post_type'  => 'page',
+				'post_title' => 'Privacy Policy',
+			)
+		);
+
+		update_option( 'wp_page_for_privacy_policy', $page_id );
+
+		$this->go_to( get_permalink( $page_id ) );
+
+		$this->assertQueryTrue( 'is_page', 'is_singular', 'is_privacy_policy' );
+	}
+
 }
diff --git a/tests/query/generatePostdata.php b/tests/query/generatePostdata.php
new file mode 100644
index 0000000000..fa7d0afb46
--- /dev/null
+++ b/tests/query/generatePostdata.php
@@ -0,0 +1,145 @@
+<?php
+
+/**
+ * @group query
+ * @covers ::generate_postdata
+ */
+class Tests_Query_GeneratePostdata extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_setup_by_id() {
+		$p    = self::factory()->post->create_and_get();
+		$data = generate_postdata( $p->ID );
+		$this->assertSame( $p->ID, $data['id'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_setup_by_fake_post() {
+		$fake     = new stdClass;
+		$fake->ID = 98765;
+		$data     = generate_postdata( $fake->ID );
+
+		// Fails because there's no post with this ID.
+		$this->assertFalse( $data );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_setup_by_postish_object() {
+		$p = self::factory()->post->create();
+
+		$post     = new stdClass();
+		$post->ID = $p;
+		$data     = generate_postdata( $p );
+
+		$this->assertSame( $p, $data['id'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_authordata() {
+		$u    = self::factory()->user->create_and_get();
+		$p    = self::factory()->post->create_and_get(
+			array(
+				'post_author' => $u->ID,
+			)
+		);
+		$data = generate_postdata( $p );
+
+		$this->assertNotEmpty( $data['authordata'] );
+		$this->assertEquals( $u, $data['authordata'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_currentday() {
+		$p    = self::factory()->post->create_and_get(
+			array(
+				'post_date' => '1980-09-09 06:30:00',
+			)
+		);
+		$data = generate_postdata( $p );
+
+		$this->assertSame( '09.09.80', $data['currentday'] );
+	}
+
+	public function test_currentmonth() {
+		$p    = self::factory()->post->create_and_get(
+			array(
+				'post_date' => '1980-09-09 06:30:00',
+			)
+		);
+		$data = generate_postdata( $p );
+
+		$this->assertSame( '09', $data['currentmonth'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_single_page() {
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_content' => 'Page 0',
+			)
+		);
+		$data = generate_postdata( $post );
+
+		$this->assertSame( 0, $data['multipage'] );
+		$this->assertSame( 1, $data['numpages'] );
+		$this->assertEquals( array( 'Page 0' ), $data['pages'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_multi_page() {
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_content' => 'Page 0<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3',
+			)
+		);
+		$data = generate_postdata( $post );
+
+		$this->assertSame( 1, $data['multipage'] );
+		$this->assertSame( 4, $data['numpages'] );
+		$this->assertEquals( array( 'Page 0', 'Page 1', 'Page 2', 'Page 3' ), $data['pages'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_nextpage_at_start_of_content() {
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_content' => '<!--nextpage-->Page 1<!--nextpage-->Page 2<!--nextpage-->Page 3',
+			)
+		);
+		$data = generate_postdata( $post );
+
+		$this->assertSame( 1, $data['multipage'] );
+		$this->assertSame( 3, $data['numpages'] );
+		$this->assertEquals( array( 'Page 1', 'Page 2', 'Page 3' ), $data['pages'] );
+	}
+
+	/**
+	 * @ticket 42814
+	 */
+	public function test_trim_nextpage_linebreaks() {
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_content' => "Page 0\n<!--nextpage-->\nPage 1\nhas a line break\n<!--nextpage-->Page 2<!--nextpage-->\n\nPage 3",
+			)
+		);
+		$data = generate_postdata( $post );
+
+		$this->assertEquals( array( 'Page 0', "Page 1\nhas a line break", 'Page 2', "\nPage 3" ), $data['pages'] );
+	}
+}
diff --git a/tests/query/metaQuery.php b/tests/query/metaQuery.php
index 26b763e244..9303e60b95 100644
--- a/tests/query/metaQuery.php
+++ b/tests/query/metaQuery.php
@@ -1922,4 +1922,247 @@ class Tests_Query_MetaQuery extends WP_UnitTestCase {
 		$this->assertEqualSets( array( $posts[0] ), $q->posts );
 
 	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_not_equals() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'aaa_foo_aaa', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_ccc', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => '!=',
+						'key'         => 'aaa_foo_bbb',
+						'value'       => 'abc',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0], $posts[1] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_not_like() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'aaa_foo_aaa', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_ccc', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'NOT LIKE',
+						'key'         => 'aaa_bar',
+						'value'       => 'abc',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0], $posts[2] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_in() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'aaa_foo_aaa', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'IN',
+						'key'         => array( 'aaa_foo_bbb', 'aaa_bar_aaa' ),
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[1], $posts[2] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_not_in() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'aaa_foo_aaa', 'abc' );
+		add_post_meta( $posts[0], 'aaa_foo_ddd', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_ccc', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'NOT IN',
+						'key'         => array( 'aaa_foo_bbb', 'aaa_foo_ddd' ),
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[1] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_not_exists() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'aaa_foo_aaa', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_ccc', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'NOT EXISTS',
+						'key'         => 'aaa_foo_bbb',
+						'value'       => 'abc',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0], $posts[1] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_exists() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'aaa_foo_aaa', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_ccc', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'EXISTS',
+						'key'         => 'aaa_foo_bbb',
+						'value'       => 'abc',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[2] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_regexp_rlike() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'AAA_FOO_AAA', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_aaa', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'REGEXP',
+						'key'         => 'AAA_foo_.*',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0], $posts[2] ), $q->posts );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'RLIKE',
+						'key'         => 'AAA_FOO_.*',
+						'type_key'    => 'BINARY',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[0] ), $q->posts );
+	}
+
+	/**
+	 * @ticket 43446
+	 */
+	public function test_compare_key_not_regexp() {
+		$posts = self::factory()->post->create_many( 3 );
+
+		add_post_meta( $posts[0], 'AAA_FOO_AAA', 'abc' );
+		add_post_meta( $posts[0], 'AAA_foo_AAA', 'abc' );
+		add_post_meta( $posts[1], 'aaa_bar_aaa', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_bbb', 'abc' );
+		add_post_meta( $posts[2], 'aaa_foo_aaa', 'abc' );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'NOT REGEXP',
+						'key'         => 'AAA_foo_.*',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[1] ), $q->posts );
+
+		$q = new WP_Query(
+			array(
+				'meta_query' => array(
+					array(
+						'compare_key' => 'NOT REGEXP',
+						'key'         => 'AAA_FOO_.*',
+						'type_key'    => 'BINARY',
+					),
+				),
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertEqualSets( array( $posts[1], $posts[2] ), $q->posts );
+	}
 }
diff --git a/tests/query/results.php b/tests/query/results.php
index a0e8df11dc..daa171efb9 100644
--- a/tests/query/results.php
+++ b/tests/query/results.php
@@ -22,49 +22,56 @@ class Tests_Query_Results extends WP_UnitTestCase {
 	static $child_four;
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$cat_ids[] = $cat_a = $factory->term->create(
+		$cat_a           = $factory->term->create(
 			array(
 				'taxonomy' => 'category',
 				'name'     => 'cat-a',
 			)
 		);
-		self::$cat_ids[] = $cat_b = $factory->term->create(
+		self::$cat_ids[] = $cat_a;
+		$cat_b           = $factory->term->create(
 			array(
 				'taxonomy' => 'category',
 				'name'     => 'cat-b',
 			)
 		);
-		self::$cat_ids[] = $cat_c = $factory->term->create(
+		self::$cat_ids[] = $cat_b;
+		$cat_c           = $factory->term->create(
 			array(
 				'taxonomy' => 'category',
 				'name'     => 'cat-c',
 			)
 		);
+		self::$cat_ids[] = $cat_c;
 
-		self::$tag_ids[] = $tag_a = $factory->term->create(
+		$tag_a           = $factory->term->create(
 			array(
 				'taxonomy' => 'post_tag',
 				'name'     => 'tag-a',
 			)
 		);
-		self::$tag_ids[] = $tag_b = $factory->term->create(
+		self::$tag_ids[] = $tag_a;
+		$tag_b           = $factory->term->create(
 			array(
 				'taxonomy' => 'post_tag',
 				'name'     => 'tag-b',
 			)
 		);
-		self::$tag_ids[] = $tag_c = $factory->term->create(
+		self::$tag_ids[] = $tag_b;
+		$tag_c           = $factory->term->create(
 			array(
 				'taxonomy' => 'post_tag',
 				'name'     => 'tag-c',
 			)
 		);
-		self::$tag_ids[] = $tag_nun = $factory->term->create(
+		self::$tag_ids[] = $tag_c;
+		$tag_nun         = $factory->term->create(
 			array(
 				'taxonomy' => 'post_tag',
 				'name'     => 'tag-',
 			)
 		);
+		self::$tag_ids[] = $tag_nun;
 
 		self::$post_ids[] = $factory->post->create(
 			array(
@@ -232,52 +239,59 @@ class Tests_Query_Results extends WP_UnitTestCase {
 			)
 		);
 
-		self::$post_ids[] = self::$parent_one = $factory->post->create(
+		self::$parent_one   = $factory->post->create(
 			array(
 				'post_title' => 'parent-one',
 				'post_date'  => '2007-01-01 00:00:00',
 			)
 		);
-		self::$post_ids[] = self::$parent_two = $factory->post->create(
+		self::$post_ids[]   = self::$parent_one;
+		self::$parent_two   = $factory->post->create(
 			array(
 				'post_title' => 'parent-two',
 				'post_date'  => '2007-01-01 00:00:00',
 			)
 		);
-		self::$post_ids[] = self::$parent_three = $factory->post->create(
+		self::$post_ids[]   = self::$parent_two;
+		self::$parent_three = $factory->post->create(
 			array(
 				'post_title' => 'parent-three',
 				'post_date'  => '2007-01-01 00:00:00',
 			)
 		);
-		self::$post_ids[] = self::$child_one = $factory->post->create(
+		self::$post_ids[]   = self::$parent_three;
+		self::$child_one    = $factory->post->create(
 			array(
 				'post_title'  => 'child-one',
 				'post_parent' => self::$parent_one,
 				'post_date'   => '2007-01-01 00:00:01',
 			)
 		);
-		self::$post_ids[] = self::$child_two = $factory->post->create(
+		self::$post_ids[]   = self::$child_one;
+		self::$child_two    = $factory->post->create(
 			array(
 				'post_title'  => 'child-two',
 				'post_parent' => self::$parent_one,
 				'post_date'   => '2007-01-01 00:00:02',
 			)
 		);
-		self::$post_ids[] = self::$child_three = $factory->post->create(
+		self::$post_ids[]   = self::$child_two;
+		self::$child_three  = $factory->post->create(
 			array(
 				'post_title'  => 'child-three',
 				'post_parent' => self::$parent_two,
 				'post_date'   => '2007-01-01 00:00:03',
 			)
 		);
-		self::$post_ids[] = self::$child_four = $factory->post->create(
+		self::$post_ids[]   = self::$child_three;
+		self::$child_four   = $factory->post->create(
 			array(
 				'post_title'  => 'child-four',
 				'post_parent' => self::$parent_two,
 				'post_date'   => '2007-01-01 00:00:04',
 			)
 		);
+		self::$post_ids[]   = self::$child_four;
 	}
 
 	function setUp() {
diff --git a/tests/query/setupPostdata.php b/tests/query/setupPostdata.php
index 5a20862bcc..38d473065f 100644
--- a/tests/query/setupPostdata.php
+++ b/tests/query/setupPostdata.php
@@ -9,6 +9,8 @@ class Tests_Query_SetupPostdata extends WP_UnitTestCase {
 
 	protected $global_data = array();
 
+	protected $pages_global;
+
 	public function setUp() {
 		parent::setUp();
 		return;
@@ -401,7 +403,8 @@ class Tests_Query_SetupPostdata extends WP_UnitTestCase {
 	 */
 	function test_setup_postdata_loop() {
 		$post_id                   = self::factory()->post->create( array( 'post_content' => 'global post' ) );
-		$GLOBALS['wp_query']->post = $GLOBALS['post'] = get_post( $post_id );
+		$GLOBALS['post']           = get_post( $post_id );
+		$GLOBALS['wp_query']->post = $GLOBALS['post'];
 
 		$ids = self::factory()->post->create_many( 5 );
 		foreach ( $ids as $id ) {
@@ -416,4 +419,24 @@ class Tests_Query_SetupPostdata extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @ticket 47114
+	 *
+	 * setup_postdata() should set the globals before `the_post` action is fired.
+	 */
+	public function test_the_post_action() {
+		$post = self::factory()->post->create_and_get();
+		add_action( 'the_post', array( $this, 'the_post_action_callback' ) );
+
+		setup_postdata( $post );
+
+		$this->assertEquals( $GLOBALS['pages'], $this->pages_global );
+	}
+
+	/**
+	 * Helpers
+	 */
+	public function the_post_action_callback() {
+		$this->pages_global = $GLOBALS['pages'];
+	}
 }
diff --git a/tests/query/stickies.php b/tests/query/stickies.php
index 61bf15aa19..01e7405e6a 100644
--- a/tests/query/stickies.php
+++ b/tests/query/stickies.php
@@ -12,7 +12,7 @@ class Tests_Query_Stickies extends WP_UnitTestCase {
 		// Set post times to get a reliable order.
 		$now = time();
 		for ( $i = 0; $i <= 22; $i++ ) {
-			$post_date         = date( 'Y-m-d H:i:s', $now - ( 10 * $i ) );
+			$post_date         = gmdate( 'Y-m-d H:i:s', $now - ( 10 * $i ) );
 			self::$posts[ $i ] = $factory->post->create(
 				array(
 					'post_date' => $post_date,
@@ -28,7 +28,7 @@ class Tests_Query_Stickies extends WP_UnitTestCase {
 	public function test_stickies_should_be_ignored_when_is_home_is_false() {
 		$q = new WP_Query(
 			array(
-				'year'           => date( 'Y' ),
+				'year'           => gmdate( 'Y' ),
 				'fields'         => 'ids',
 				'posts_per_page' => 3,
 			)
diff --git a/tests/query/taxQuery.php b/tests/query/taxQuery.php
index 8112c81367..42e73d779e 100644
--- a/tests/query/taxQuery.php
+++ b/tests/query/taxQuery.php
@@ -1298,7 +1298,8 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 
 		$posts = self::factory()->post->create_many( 5 );
 
-		$cats = $tags = array();
+		$cats = array();
+		$tags = array();
 
 		// need term_taxonomy_ids in addition to term_ids, so no factory
 		for ( $i = 0; $i < 5; $i++ ) {
diff --git a/tests/query/vars.php b/tests/query/vars.php
index 05ce90e895..705d3852b9 100644
--- a/tests/query/vars.php
+++ b/tests/query/vars.php
@@ -51,7 +51,6 @@ class Tests_Query_Vars extends WP_UnitTestCase {
 				'tag',
 				'feed',
 				'author_name',
-				'static',
 				'pagename',
 				'page_id',
 				'error',
diff --git a/tests/rest-api.php b/tests/rest-api.php
index 7e72708d43..1efb81a348 100644
--- a/tests/rest-api.php
+++ b/tests/rest-api.php
@@ -255,7 +255,7 @@ class Tests_REST_API extends WP_UnitTestCase {
 	 */
 	function test_rest_route_query_var() {
 		rest_api_init();
-		$this->assertTrue( in_array( 'rest_route', $GLOBALS['wp']->public_query_vars ) );
+		$this->assertTrue( in_array( 'rest_route', $GLOBALS['wp']->public_query_vars, true ) );
 	}
 
 	public function test_route_method() {
@@ -519,6 +519,167 @@ class Tests_REST_API extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Ensure that nested fields may be whitelisted with request['_fields'].
+	 *
+	 * @ticket 42094
+	 */
+	public function test_rest_filter_response_fields_nested_field_filter() {
+		$response = new WP_REST_Response();
+
+		$response->set_data(
+			array(
+				'a' => 0,
+				'b' => array(
+					'1' => 1,
+					'2' => 2,
+				),
+				'c' => 3,
+				'd' => array(
+					'4' => 4,
+					'5' => 5,
+				),
+			)
+		);
+		$request = array(
+			'_fields' => 'b.1,c,d.5',
+		);
+
+		$response = rest_filter_response_fields( $response, null, $request );
+		$this->assertEquals(
+			array(
+				'b' => array(
+					'1' => 1,
+				),
+				'c' => 3,
+				'd' => array(
+					'5' => 5,
+				),
+			),
+			$response->get_data()
+		);
+	}
+
+	/**
+	 * Ensure that specifying a single top-level key in _fields includes that field and all children.
+	 *
+	 * @ticket 48266
+	 */
+	public function test_rest_filter_response_fields_top_level_key() {
+		$response = new WP_REST_Response();
+
+		$response->set_data(
+			array(
+				'meta' => array(
+					'key1' => 1,
+					'key2' => 2,
+				),
+			)
+		);
+		$request = array(
+			'_fields' => 'meta',
+		);
+
+		$response = rest_filter_response_fields( $response, null, $request );
+		$this->assertEquals(
+			array(
+				'meta' => array(
+					'key1' => 1,
+					'key2' => 2,
+				),
+			),
+			$response->get_data()
+		);
+	}
+
+	/**
+	 * Ensure that a top-level key in _fields supersedes any specified children of that field.
+	 *
+	 * @ticket 48266
+	 */
+	public function test_rest_filter_response_fields_child_after_parent() {
+		$response = new WP_REST_Response();
+
+		$response->set_data(
+			array(
+				'meta' => array(
+					'key1' => 1,
+					'key2' => 2,
+				),
+			)
+		);
+		$request = array(
+			'_fields' => 'meta,meta.key1',
+		);
+
+		$response = rest_filter_response_fields( $response, null, $request );
+		$this->assertEquals(
+			array(
+				'meta' => array(
+					'key1' => 1,
+					'key2' => 2,
+				),
+			),
+			$response->get_data()
+		);
+	}
+
+	/**
+	 * Ensure that specifying two sibling properties in _fields causes both to be included.
+	 *
+	 * @ticket 48266
+	 */
+	public function test_rest_filter_response_fields_include_all_specified_siblings() {
+		$response = new WP_REST_Response();
+
+		$response->set_data(
+			array(
+				'meta' => array(
+					'key1' => 1,
+					'key2' => 2,
+				),
+			)
+		);
+		$request = array(
+			'_fields' => 'meta.key1,meta.key2',
+		);
+
+		$response = rest_filter_response_fields( $response, null, $request );
+		$this->assertEquals(
+			array(
+				'meta' => array(
+					'key1' => 1,
+					'key2' => 2,
+				),
+			),
+			$response->get_data()
+		);
+	}
+
+	/**
+	 * @ticket 42094
+	 */
+	public function test_rest_is_field_included() {
+		$fields = array(
+			'id',
+			'title',
+			'content.raw',
+			'custom.property',
+		);
+
+		$this->assertTrue( rest_is_field_included( 'id', $fields ) );
+		$this->assertTrue( rest_is_field_included( 'title', $fields ) );
+		$this->assertTrue( rest_is_field_included( 'title.raw', $fields ) );
+		$this->assertTrue( rest_is_field_included( 'title.rendered', $fields ) );
+		$this->assertTrue( rest_is_field_included( 'content', $fields ) );
+		$this->assertTrue( rest_is_field_included( 'content.raw', $fields ) );
+		$this->assertTrue( rest_is_field_included( 'custom.property', $fields ) );
+		$this->assertFalse( rest_is_field_included( 'content.rendered', $fields ) );
+		$this->assertFalse( rest_is_field_included( 'type', $fields ) );
+		$this->assertFalse( rest_is_field_included( 'meta', $fields ) );
+		$this->assertFalse( rest_is_field_included( 'meta.value', $fields ) );
+	}
+
 	/**
 	 * The get_rest_url function should return a URL consistently terminated with a "/",
 	 * whether the blog is configured with pretty permalink support or not.
@@ -715,15 +876,6 @@ class Tests_REST_API extends WP_UnitTestCase {
 		$this->assertEquals( $routes['/test-ns/test'][0]['methods'], array( 'GET' => true ) );
 	}
 
-	/**
-	 * Ensure rest_preload_api_request() works without notices in PHP 5.2.
-	 *
-	 * The array_reduce() function only accepts mixed variables starting with PHP 5.3.
-	 */
-	function test_rest_preload_api_request_no_notices_php_52() {
-		$this->assertTrue( is_array( rest_preload_api_request( 0, '/' ) ) );
-	}
-
 	function test_rest_preload_api_request_with_method() {
 		$rest_server               = $GLOBALS['wp_rest_server'];
 		$GLOBALS['wp_rest_server'] = null;
@@ -744,4 +896,14 @@ class Tests_REST_API extends WP_UnitTestCase {
 
 		$GLOBALS['wp_rest_server'] = $rest_server;
 	}
+
+	/**
+	 * @ticket 40614
+	 */
+	function test_rest_ensure_response_accepts_path_string() {
+		$request = rest_ensure_request( '/wp/v2/posts' );
+		$this->assertInstanceOf( 'WP_REST_Request', $request );
+		$this->assertEquals( '/wp/v2/posts', $request->get_route() );
+		$this->assertEquals( 'GET', $request->get_method() );
+	}
 }
diff --git a/tests/rest-api/rest-attachments-controller.php b/tests/rest-api/rest-attachments-controller.php
index 0ec277ab3a..dc0b61835d 100644
--- a/tests/rest-api/rest-attachments-controller.php
+++ b/tests/rest-api/rest-attachments-controller.php
@@ -208,6 +208,36 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertEquals( array( 'context', 'id' ), $keys );
 	}
 
+	/**
+	 * @ticket 43701
+	 */
+	public function test_allow_header_sent_on_options_request() {
+		$id1      = $this->factory->attachment->create_object(
+			$this->test_file,
+			0,
+			array(
+				'post_mime_type' => 'image/jpeg',
+				'post_excerpt'   => 'A sample caption',
+			)
+		);
+		$request  = new WP_REST_Request( 'OPTIONS', sprintf( '/wp/v2/media/%d', $id1 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$response = apply_filters( 'rest_post_dispatch', $response, rest_get_server(), $request );
+		$headers  = $response->get_headers();
+
+		$this->assertNotEmpty( $headers['Allow'] );
+		$this->assertEquals( $headers['Allow'], 'GET' );
+
+		wp_set_current_user( self::$editor_id );
+		$request  = new WP_REST_Request( 'OPTIONS', sprintf( '/wp/v2/media/%d', $id1 ) );
+		$response = rest_get_server()->dispatch( $request );
+		$response = apply_filters( 'rest_post_dispatch', $response, rest_get_server(), $request );
+		$headers  = $response->get_headers();
+
+		$this->assertNotEmpty( $headers['Allow'] );
+		$this->assertEquals( $headers['Allow'], 'GET, POST, PUT, PATCH, DELETE' );
+	}
+
 	public function test_get_items() {
 		wp_set_current_user( 0 );
 		$id1            = $this->factory->attachment->create_object(
@@ -1297,7 +1327,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertEquals( 26, count( $properties ) );
+		$this->assertEquals( 27, count( $properties ) );
 		$this->assertArrayHasKey( 'author', $properties );
 		$this->assertArrayHasKey( 'alt_text', $properties );
 		$this->assertArrayHasKey( 'caption', $properties );
@@ -1330,6 +1360,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertArrayHasKey( 'raw', $properties['title']['properties'] );
 		$this->assertArrayHasKey( 'rendered', $properties['title']['properties'] );
 		$this->assertArrayHasKey( 'type', $properties );
+		$this->assertArrayHasKey( 'missing_image_sizes', $properties );
 	}
 
 	public function test_get_additional_field_registration() {
@@ -1435,7 +1466,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 			)
 		);
 
-		$filename = basename( $this->test_file2 );
+		$filename = wp_basename( $this->test_file2 );
 
 		$request = new WP_REST_Request( 'GET', '/wp/v2/media' );
 		$request->set_param( 'search', $filename );
diff --git a/tests/rest-api/rest-categories-controller.php b/tests/rest-api/rest-categories-controller.php
index 3c9543833b..8d44e282db 100644
--- a/tests/rest-api/rest-categories-controller.php
+++ b/tests/rest-api/rest-categories-controller.php
@@ -859,6 +859,18 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 		$this->assertErrorResponse( 'rest_term_invalid', $response, 400 );
 	}
 
+	public function test_create_item_with_no_parent() {
+		wp_set_current_user( self::$administrator );
+		$parent  = 0;
+		$request = new WP_REST_Request( 'POST', '/wp/v2/categories' );
+		$request->set_param( 'name', 'My Awesome Term' );
+		$request->set_param( 'parent', $parent );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 201, $response->get_status() );
+		$data = $response->get_data();
+		$this->assertEquals( $parent, $data['parent'] );
+	}
+
 	public function test_update_item() {
 		wp_set_current_user( self::$administrator );
 		$orig_args = array(
@@ -929,6 +941,33 @@ class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcas
 		$this->assertEquals( $parent->term_id, $data['parent'] );
 	}
 
+	public function test_update_item_remove_parent() {
+		wp_set_current_user( self::$administrator );
+
+		$old_parent_term = get_term_by( 'id', $this->factory->category->create(), 'category' );
+		$new_parent_id   = 0;
+
+		$term = get_term_by(
+			'id',
+			$this->factory->category->create(
+				[
+					'parent' => $old_parent_term->term_id,
+				]
+			),
+			'category'
+		);
+
+		$this->assertEquals( $old_parent_term->term_id, $term->parent );
+
+		$request = new WP_REST_Request( 'POST', '/wp/v2/categories/' . $term->term_id );
+		$request->set_param( 'parent', $new_parent_id );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+
+		$data = $response->get_data();
+		$this->assertEquals( $new_parent_id, $data['parent'] );
+	}
+
 	public function test_update_item_invalid_parent() {
 		wp_set_current_user( self::$administrator );
 		$term = get_term_by( 'id', $this->factory->category->create(), 'category' );
diff --git a/tests/rest-api/rest-comments-controller.php b/tests/rest-api/rest-comments-controller.php
index d1fe7aa34a..aa77f481ab 100644
--- a/tests/rest-api/rest-comments-controller.php
+++ b/tests/rest-api/rest-comments-controller.php
@@ -13,6 +13,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	protected static $superadmin_id;
 	protected static $admin_id;
 	protected static $editor_id;
+	protected static $moderator_id;
 	protected static $subscriber_id;
 	protected static $author_id;
 
@@ -27,6 +28,15 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	protected $endpoint;
 
 	public static function wpSetUpBeforeClass( $factory ) {
+		add_role(
+			'comment_moderator',
+			'Comment Moderator',
+			array(
+				'read'              => true,
+				'moderate_comments' => true,
+			)
+		);
+
 		self::$superadmin_id = $factory->user->create(
 			array(
 				'role'       => 'administrator',
@@ -43,6 +53,11 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 				'role' => 'editor',
 			)
 		);
+		self::$moderator_id  = $factory->user->create(
+			array(
+				'role' => 'comment_moderator',
+			)
+		);
 		self::$subscriber_id = $factory->user->create(
 			array(
 				'role' => 'subscriber',
@@ -98,9 +113,12 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	public static function wpTearDownAfterClass() {
+		remove_role( 'comment_moderator' );
+
 		self::delete_user( self::$superadmin_id );
 		self::delete_user( self::$admin_id );
 		self::delete_user( self::$editor_id );
+		self::delete_user( self::$moderator_id );
 		self::delete_user( self::$subscriber_id );
 		self::delete_user( self::$author_id );
 
@@ -2480,6 +2498,31 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertErrorResponse( 'rest_cannot_edit', $response, 401 );
 	}
 
+	/**
+	 * @ticket 47024
+	 */
+	public function test_update_comment_when_can_moderate_comments() {
+		wp_set_current_user( self::$moderator_id );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
+		$params  = array(
+			'content' => 'Updated comment.',
+			'date'    => '2019-10-07T23:14:25',
+		);
+		$request->add_header( 'content-type', 'application/json' );
+		$request->set_body( wp_json_encode( $params ) );
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+
+		$comment = $response->get_data();
+		$updated = get_comment( self::$approved_id );
+
+		$this->assertEquals( $params['content'], $updated->comment_content );
+		$this->assertEquals( self::$post_id, $comment['post'] );
+		$this->assertEquals( '2019-10-07T23:14:25', $comment['date'] );
+	}
+
 	public function test_update_comment_private_post_invalid_permission() {
 		$private_comment_id = $this->factory->comment->create(
 			array(
diff --git a/tests/rest-api/rest-controller.php b/tests/rest-api/rest-controller.php
index 6301e64d9d..91e1d0c5b7 100644
--- a/tests/rest-api/rest-controller.php
+++ b/tests/rest-api/rest-controller.php
@@ -232,7 +232,7 @@ class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
 	public function data_get_fields_for_response() {
 		return array(
 			array(
-				'somestring,someinteger',
+				'somestring,someinteger,someinvalidkey',
 				array(
 					'somestring',
 					'someinteger',
@@ -255,6 +255,94 @@ class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
 		);
 	}
 
+	public function test_get_fields_for_response_filters_by_context() {
+		$controller = new WP_REST_Test_Controller();
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/testroute' );
+		$request->set_param( 'context', 'view' );
+
+		$schema = $controller->get_item_schema();
+		$field  = 'somefield';
+
+		$listener = new MockAction();
+		$method   = 'action';
+
+		register_rest_field(
+			$schema['title'],
+			$field,
+			array(
+				'schema'       => array(
+					'type'    => 'string',
+					'context' => array( 'embed' ),
+				),
+				'get_callback' => array( $listener, $method ),
+			)
+		);
+
+		$controller->prepare_item_for_response( array(), $request );
+
+		$this->assertSame( 0, $listener->get_call_count( $method ) );
+
+		$request->set_param( 'context', 'embed' );
+
+		$controller->prepare_item_for_response( array(), $request );
+
+		$this->assertGreaterThan( 0, $listener->get_call_count( $method ) );
+	}
+
+	public function test_filtering_fields_for_response_by_context_returns_fields_with_no_context() {
+		$controller = new WP_REST_Test_Controller();
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/testroute' );
+		$request->set_param( 'context', 'view' );
+
+		$schema = $controller->get_item_schema();
+		$field  = 'somefield';
+
+		$listener = new MockAction();
+		$method   = 'action';
+
+		register_rest_field(
+			$schema['title'],
+			$field,
+			array(
+				'schema'       => array(
+					'type' => 'string',
+				),
+				'get_callback' => array( $listener, $method ),
+			)
+		);
+
+		$controller->prepare_item_for_response( array(), $request );
+
+		$this->assertGreaterThan( 0, $listener->get_call_count( $method ) );
+	}
+
+	public function test_filtering_fields_for_response_by_context_returns_fields_with_no_schema() {
+		$controller = new WP_REST_Test_Controller();
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/testroute' );
+		$request->set_param( 'context', 'view' );
+
+		$schema = $controller->get_item_schema();
+		$field  = 'somefield';
+
+		$listener = new MockAction();
+		$method   = 'action';
+
+		register_rest_field(
+			$schema['title'],
+			$field,
+			array(
+				'get_callback' => array( $listener, $method ),
+			)
+		);
+
+		$controller->prepare_item_for_response( array(), $request );
+
+		$this->assertGreaterThan( 0, $listener->get_call_count( $method ) );
+	}
+
 	public function test_add_additional_fields_to_object_respects_fields_param() {
 		$controller = new WP_REST_Test_Controller();
 		$request    = new WP_REST_Request( 'GET', '/wp/v2/testroute' );
diff --git a/tests/rest-api/rest-post-meta-fields.php b/tests/rest-api/rest-post-meta-fields.php
index dc2401b1c3..02f70545c5 100644
--- a/tests/rest-api/rest-post-meta-fields.php
+++ b/tests/rest-api/rest-post-meta-fields.php
@@ -1176,7 +1176,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 	}
 
 	/**
-	 * @ticket 38323
+	 * @ticket       38323
 	 * @dataProvider data_get_subtype_meta_value
 	 */
 	public function test_get_subtype_meta_value( $post_type, $meta_key, $single, $in_post_type ) {
@@ -1228,7 +1228,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 	}
 
 	/**
-	 * @ticket 38323
+	 * @ticket       38323
 	 * @dataProvider data_set_subtype_meta_value
 	 */
 	public function test_set_subtype_meta_value( $post_type, $meta_key, $single, $in_post_type, $can_write ) {
@@ -1256,6 +1256,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 		if ( ! $can_write ) {
 			$this->assertEquals( 403, $response->get_status() );
 			$this->assertEmpty( get_post_meta( $post_id, $meta_key, $single ) );
+
 			return;
 		}
 
@@ -1298,7 +1299,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 	}
 
 	/**
-	 * @ticket 42069
+	 * @ticket       42069
 	 * @dataProvider data_update_value_return_success_with_same_value
 	 */
 	public function test_update_value_return_success_with_same_value( $meta_key, $meta_value ) {
@@ -1347,6 +1348,1313 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 		$this->assertEquals( 'Hello', $data['meta']['test\'slashed\'key'] );
 	}
 
+	/**
+	 * @ticket 43392
+	 */
+	public function test_object_single() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => array(
+						'project' => 'WordPress',
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'object', $data['meta'] );
+		$this->assertArrayHasKey( 'project', $data['meta']['object'] );
+		$this->assertEquals( 'WordPress', $data['meta']['object']['project'] );
+
+		$meta = get_post_meta( self::$post_id, 'object', true );
+		$this->assertArrayHasKey( 'project', $meta );
+		$this->assertEquals( 'WordPress', $meta['project'] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_object_multiple() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => false,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => array(
+						array(
+							'project' => 'WordPress',
+						),
+						array(
+							'project' => 'bbPress',
+						),
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'object', $data['meta'] );
+		$this->assertCount( 2, $data['meta']['object'] );
+
+		$this->assertArrayHasKey( 'project', $data['meta']['object'][0] );
+		$this->assertEquals( 'WordPress', $data['meta']['object'][0]['project'] );
+
+		$this->assertArrayHasKey( 'project', $data['meta']['object'][1] );
+		$this->assertEquals( 'bbPress', $data['meta']['object'][1]['project'] );
+
+		$meta = get_post_meta( self::$post_id, 'object' );
+
+		$this->assertCount( 2, $meta );
+
+		$this->assertArrayHasKey( 'project', $meta[0] );
+		$this->assertEquals( 'WordPress', $meta[0]['project'] );
+
+		$this->assertArrayHasKey( 'project', $meta[1] );
+		$this->assertEquals( 'bbPress', $meta[1]['project'] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_array_single() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'list',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'  => 'array',
+						'items' => array(
+							'type' => 'string',
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'list' => array( 'WordPress', 'bbPress' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'list', $data['meta'] );
+		$this->assertEquals( array( 'WordPress', 'bbPress' ), $data['meta']['list'] );
+
+		$meta = get_post_meta( self::$post_id, 'list', true );
+		$this->assertEquals( array( 'WordPress', 'bbPress' ), $meta );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_array_of_objects_multiple() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'list_of_objects',
+			array(
+				'single'       => false,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'  => 'array',
+						'items' => array(
+							'type'       => 'object',
+							'properties' => array(
+								'version' => array(
+									'type' => 'string',
+								),
+								'artist'  => array(
+									'type' => 'string',
+								),
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'list_of_objects' => array(
+						// Meta 1
+						array(
+							array(
+								'version' => '5.2',
+								'artist'  => 'Jaco',
+							),
+							array(
+								'version' => '5.1',
+								'artist'  => 'Betty',
+							),
+						),
+						// Meta 2
+						array(
+							array(
+								'version' => '4.9',
+								'artist'  => 'Tipton',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'list_of_objects', $data['meta'] );
+		$this->assertCount( 2, $data['meta']['list_of_objects'] );
+
+		$this->assertEquals(
+			array(
+				array(
+					'version' => '5.2',
+					'artist'  => 'Jaco',
+				),
+				array(
+					'version' => '5.1',
+					'artist'  => 'Betty',
+				),
+			),
+			$data['meta']['list_of_objects'][0]
+		);
+
+		$this->assertEquals(
+			array(
+				array(
+					'version' => '4.9',
+					'artist'  => 'Tipton',
+				),
+			),
+			$data['meta']['list_of_objects'][1]
+		);
+
+		$meta = get_post_meta( self::$post_id, 'list_of_objects' );
+
+		$this->assertCount( 2, $meta );
+
+		$this->assertEquals(
+			array(
+				array(
+					'version' => '5.2',
+					'artist'  => 'Jaco',
+				),
+				array(
+					'version' => '5.1',
+					'artist'  => 'Betty',
+				),
+			),
+			$meta[0]
+		);
+
+		$this->assertEquals(
+			array(
+				array(
+					'version' => '4.9',
+					'artist'  => 'Tipton',
+				),
+			),
+			$meta[1]
+		);
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_php_objects_returned_as_null() {
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$basic          = new Basic_Object();
+		$basic->project = 'WordPress';
+		update_post_meta( self::$post_id, 'object', $basic );
+
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'object', $data['meta'] );
+		$this->assertNull( $data['meta']['object'] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_php_objects_returned_as_null_multiple() {
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => false,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$basic          = new Basic_Object();
+		$basic->project = 'WordPress';
+		add_post_meta( self::$post_id, 'object', array( 'project' => 'bbPress' ) );
+		add_post_meta( self::$post_id, 'object', $basic );
+
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'object', $data['meta'] );
+		$this->assertCount( 2, $data['meta']['object'] );
+		$this->assertEquals( array( 'project' => 'bbPress' ), $data['meta']['object'][0] );
+		$this->assertNull( $data['meta']['object'][1] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_php_jsonserializable_object_returns_value() {
+		require_once __DIR__ . '/../../includes/class-jsonserializable-object.php';
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'object', new JsonSerializable_Object( array( 'project' => 'WordPress' ) ) );
+
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertArrayHasKey( 'object', $data['meta'] );
+		$this->assertEquals( array( 'project' => 'WordPress' ), $data['meta']['object'] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_updating_meta_to_null_for_key_with_existing_php_object_does_not_delete_meta_value() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$basic          = new Basic_Object();
+		$basic->project = 'WordPress';
+		update_post_meta( self::$post_id, 'object', $basic );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => null,
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 500, $response->get_status() );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_updating_non_single_meta_to_null_for_key_with_existing_php_object_does_not_set_meta_value_to_null() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => false,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$basic          = new Basic_Object();
+		$basic->project = 'WordPress';
+		add_post_meta( self::$post_id, 'object', array( 'project' => 'bbPress' ) );
+		add_post_meta( self::$post_id, 'object', $basic );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => array(
+						array( 'project' => 'BuddyPress' ),
+						null,
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 500, $response->get_status() );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_object_rejects_additional_properties_by_default() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => array(
+						'project'     => 'BuddyPress',
+						'awesomeness' => 100,
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 400, $response->get_status() );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_object_allows_additional_properties_if_explicitly_set() {
+		$this->grant_write_permission();
+
+		$value = array(
+			'project'     => 'BuddyPress',
+			'awesomeness' => 100,
+		);
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'                 => 'object',
+						'additionalProperties' => true,
+						'properties'           => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => $value,
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertEquals( $value, $response->get_data()['meta']['object'] );
+
+		$this->assertEquals( $value, get_post_meta( self::$post_id, 'object', true ) );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_object_allows_additional_properties_and_uses_its_schema() {
+		$this->grant_write_permission();
+
+		$value = array(
+			'project'     => 'BuddyPress',
+			'awesomeness' => 'fabulous',
+		);
+
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'                 => 'object',
+						'additionalProperties' => array(
+							'type' => 'number',
+						),
+						'properties'           => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => $value,
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 400, $response->get_status() );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_invalid_meta_value_are_set_to_null_in_response() {
+		register_post_meta(
+			'post',
+			'email',
+			array(
+				'single'       => true,
+				'type'         => 'string',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'   => 'string',
+						'format' => 'email',
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'email', 'invalid_meta_value' );
+
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->assertNull( $response->get_data()['meta']['email'] );
+	}
+
+	/**
+	 * @ticket 43392
+	 * @ticket 48363
+	 * @dataProvider _dp_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable
+	 */
+	public function test_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable( $type, $stored, $expected ) {
+		register_post_meta(
+			'post',
+			'safe',
+			array(
+				'single'       => true,
+				'show_in_rest' => true,
+				'type'         => $type,
+			)
+		);
+
+		update_post_meta( self::$post_id, 'safe', $stored );
+
+		$request  = new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+
+		$this->assertSame( $expected, $response->get_data()['meta']['safe'] );
+	}
+
+	public function _dp_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable() {
+		return array(
+			array( 'boolean', 'true', true ),
+			array( 'boolean', 'false', false ),
+			array( 'boolean', '1', true ),
+			array( 'boolean', '0', false ),
+			array( 'boolean', '', false ),
+			array( 'integer', '', 0 ),
+			array( 'integer', '1', 1 ),
+			array( 'integer', '0', 0 ),
+			array( 'number', '', 0.0 ),
+			array( 'number', '1.1', 1.1 ),
+			array( 'number', '0.0', 0.0 ),
+			array( 'string', '', '' ),
+			array( 'string', '1', '1' ),
+			array( 'string', '0', '0' ),
+			array( 'string', 'str', 'str' ),
+		);
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_update_multi_meta_value_object() {
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => false,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		add_post_meta(
+			self::$post_id,
+			'object',
+			array(
+				'project' => 'WordPress',
+			)
+		);
+		add_post_meta(
+			self::$post_id,
+			'object',
+			array(
+				'project' => 'bbPress',
+			)
+		);
+
+		$this->grant_write_permission();
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => array(
+						array( 'project' => 'WordPress' ),
+						array( 'project' => 'BuddyPress' ),
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+
+		$data = $response->get_data();
+		$this->assertArrayHasKey( 'object', $data['meta'] );
+
+		$this->assertCount( 2, $data['meta']['object'] );
+		$this->assertEquals( array( 'project' => 'WordPress' ), $data['meta']['object'][0] );
+		$this->assertEquals( array( 'project' => 'BuddyPress' ), $data['meta']['object'][1] );
+
+		$meta = get_post_meta( self::$post_id, 'object' );
+		$this->assertCount( 2, $meta );
+		$this->assertEquals( array( 'project' => 'WordPress' ), $meta[0] );
+		$this->assertEquals( array( 'project' => 'BuddyPress' ), $meta[1] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_update_multi_meta_value_array() {
+		register_post_meta(
+			'post',
+			'list',
+			array(
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'  => 'array',
+						'items' => array(
+							'type' => 'string',
+						),
+					),
+				),
+			)
+		);
+
+		add_post_meta( self::$post_id, 'list', array( 'WordPress', 'bbPress' ) );
+		add_post_meta( self::$post_id, 'list', array( 'WordCamp' ) );
+
+		$this->grant_write_permission();
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'list' => array(
+						array( 'WordPress', 'bbPress' ),
+						array( 'BuddyPress' ),
+					),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+
+		$data = $response->get_data();
+		$this->assertArrayHasKey( 'list', $data['meta'] );
+
+		$this->assertCount( 2, $data['meta']['list'] );
+		$this->assertEquals( array( 'WordPress', 'bbPress' ), $data['meta']['list'][0] );
+		$this->assertEquals( array( 'BuddyPress' ), $data['meta']['list'][1] );
+
+		$meta = get_post_meta( self::$post_id, 'list' );
+		$this->assertCount( 2, $meta );
+		$this->assertEquals( array( 'WordPress', 'bbPress' ), $meta[0] );
+		$this->assertEquals( array( 'BuddyPress' ), $meta[1] );
+	}
+
+	/**
+	 * @ticket 47928
+	 */
+	public function test_update_meta_with_unchanged_array_values() {
+		register_post_meta(
+			'post',
+			'list',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'  => 'array',
+						'items' => array(
+							'type' => 'string',
+						),
+					),
+				),
+			)
+		);
+
+		add_post_meta( self::$post_id, 'list', array( 'WordCamp' ) );
+
+		$this->grant_write_permission();
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'list' => array( 'WordCamp' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+
+		$data = $response->get_data();
+		$this->assertEquals( array( 'WordCamp' ), $data['meta']['list'] );
+	}
+
+	/**
+	 * @ticket 47928
+	 */
+	public function test_update_meta_with_unchanged_object_values() {
+		register_post_meta(
+			'post',
+			'object',
+			array(
+				'single'       => true,
+				'type'         => 'object',
+				'show_in_rest' => array(
+					'schema' => array(
+						'type'       => 'object',
+						'properties' => array(
+							'project' => array(
+								'type' => 'string',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		add_post_meta( self::$post_id, 'object', array( 'project' => 'WordCamp' ) );
+
+		$this->grant_write_permission();
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'object' => array( 'project' => 'WordCamp' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+
+		$data = $response->get_data();
+		$this->assertEquals( array( 'project' => 'WordCamp' ), $data['meta']['object'] );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_register_meta_issues_doing_it_wrong_when_show_in_rest_is_true() {
+		$this->setExpectedIncorrectUsage( 'register_meta' );
+
+		$registered = register_meta(
+			'post',
+			'invalid_array',
+			array(
+				'type'         => 'array',
+				'show_in_rest' => true,
+			)
+		);
+
+		self::assertFalse( $registered );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_register_meta_issues_doing_it_wrong_when_show_in_rest_omits_schema() {
+		$this->setExpectedIncorrectUsage( 'register_meta' );
+
+		$registered = register_meta(
+			'post',
+			'invalid_array',
+			array(
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'prepare_callback' => 'rest_sanitize_value_from_schema',
+				),
+			)
+		);
+
+		self::assertFalse( $registered );
+	}
+
+	/**
+	 * @ticket 43392
+	 */
+	public function test_register_meta_issues_doing_it_wrong_when_show_in_rest_omits_schema_items() {
+		$this->setExpectedIncorrectUsage( 'register_meta' );
+
+		$registered = register_meta(
+			'post',
+			'invalid_array',
+			array(
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'default' => array( 'Hi!' ),
+					),
+				),
+			)
+		);
+
+		self::assertFalse( $registered );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_ints_meta() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'integer',
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( 1, 2, 3 ),
+				),
+			)
+		);
+
+		rest_get_server()->dispatch( $request );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_ints_meta_stored_strings_are_updated() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'integer',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( '1', '2', '3' ) );
+		$response = rest_get_server()->dispatch( new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) ) );
+		$this->assertEquals( array( 1, 2, 3 ), $response->get_data()['meta']['items'] );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( 1, 2, 3 ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( 1, 2, 3 ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_ints_meta_string_request_data_is_set_as_ints() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'integer',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( 1, 2, 3 ) );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( '1', '2', '3' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( 1, 2, 3 ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_ints_meta_string_request_data_and_string_stored_data() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'integer',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( '1', '2', '3' ) );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( '1', '2', '3' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( 1, 2, 3 ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_bools_meta() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'boolean',
+						),
+					),
+				),
+			)
+		);
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( true, false ),
+				),
+			)
+		);
+
+		rest_get_server()->dispatch( $request );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_bools_meta_stored_strings_are_updated() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'boolean',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( '1', '0' ) );
+
+		$response = rest_get_server()->dispatch( new WP_REST_Request( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) ) );
+		$this->assertEquals( array( true, false ), $response->get_data()['meta']['items'] );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( true, false ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( true, false ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_bools_meta_string_request_data_is_set_as_bools() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'boolean',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( true, false ) );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( '1', '0' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( true, false ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_bools_meta_string_request_data_and_string_stored_data() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'boolean',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( '1', '0' ) );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( '1', '0' ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( true, false ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48264
+	 */
+	public function test_update_array_of_bools_with_string_values_stored_and_opposite_request_data() {
+		$this->grant_write_permission();
+		register_post_meta(
+			'post',
+			'items',
+			array(
+				'single'       => true,
+				'type'         => 'array',
+				'show_in_rest' => array(
+					'schema' => array(
+						'items' => array(
+							'type' => 'boolean',
+						),
+					),
+				),
+			)
+		);
+
+		update_post_meta( self::$post_id, 'items', array( '1', '0' ) );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'items' => array( false, true ),
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertSame( array( false, true ), get_post_meta( self::$post_id, 'items', true ) );
+	}
+
+	/**
+	 * @ticket 48363
+	 */
+	public function test_boolean_meta_update_to_false_stores_0() {
+		$this->grant_write_permission();
+
+		register_post_meta(
+			'post',
+			'boolean',
+			array(
+				'single'            => true,
+				'type'              => 'boolean',
+				'show_in_rest'      => true,
+				'sanitize_callback' => function( $value ) {
+					return $value ? '1' : '0';
+				},
+			)
+		);
+
+		update_post_meta( self::$post_id, 'boolean', 1 );
+
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$request->set_body_params(
+			array(
+				'meta' => array(
+					'boolean' => false,
+				),
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertEquals( 200, $response->get_status() );
+		$this->assertEquals( '0', get_post_meta( self::$post_id, 'boolean', true ) );
+	}
+
 	/**
 	 * Internal function used to disable an insert query which
 	 * will trigger a wpdb error for testing purposes.
diff --git a/tests/rest-api/rest-post-statuses-controller.php b/tests/rest-api/rest-post-statuses-controller.php
index 1fe933b008..43b85289b7 100644
--- a/tests/rest-api/rest-post-statuses-controller.php
+++ b/tests/rest-api/rest-post-statuses-controller.php
@@ -153,7 +153,7 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
 		$properties = $data['schema']['properties'];
-		$this->assertEquals( 7, count( $properties ) );
+		$this->assertEquals( 8, count( $properties ) );
 		$this->assertArrayHasKey( 'name', $properties );
 		$this->assertArrayHasKey( 'private', $properties );
 		$this->assertArrayHasKey( 'protected', $properties );
@@ -161,6 +161,7 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 		$this->assertArrayHasKey( 'queryable', $properties );
 		$this->assertArrayHasKey( 'show_in_list', $properties );
 		$this->assertArrayHasKey( 'slug', $properties );
+		$this->assertArrayHasKey( 'date_floating', $properties );
 	}
 
 	public function test_get_additional_field_registration() {
@@ -217,6 +218,7 @@ class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Test
 			),
 			array_keys( $links )
 		);
+		$this->assertEquals( $status_obj->date_floating, $data['date_floating'] );
 	}
 
 	protected function check_post_status_object_response( $response ) {
diff --git a/tests/rest-api/rest-posts-controller.php b/tests/rest-api/rest-posts-controller.php
index ee01eb717e..37ee1ac02c 100644
--- a/tests/rest-api/rest-posts-controller.php
+++ b/tests/rest-api/rest-posts-controller.php
@@ -189,6 +189,28 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertEquals( array( 'context', 'id', 'password' ), $keys );
 	}
 
+	/**
+	 * @ticket 43701
+	 */
+	public function test_allow_header_sent_on_options_request() {
+		$request  = new WP_REST_Request( 'OPTIONS', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+		$response = apply_filters( 'rest_post_dispatch', $response, rest_get_server(), $request );
+		$headers  = $response->get_headers();
+
+		$this->assertNotEmpty( $headers['Allow'] );
+		$this->assertEquals( $headers['Allow'], 'GET' );
+
+		wp_set_current_user( self::$editor_id );
+		$request  = new WP_REST_Request( 'OPTIONS', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+		$response = rest_get_server()->dispatch( $request );
+		$response = apply_filters( 'rest_post_dispatch', $response, rest_get_server(), $request );
+		$headers  = $response->get_headers();
+
+		$this->assertNotEmpty( $headers['Allow'] );
+		$this->assertEquals( $headers['Allow'], 'GET, POST, PUT, PATCH, DELETE' );
+	}
+
 	public function test_get_items() {
 		$request  = new WP_REST_Request( 'GET', '/wp/v2/posts' );
 		$response = rest_get_server()->dispatch( $request );
@@ -1341,6 +1363,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		$this->assertEquals( rest_url( '/wp/v2/posts/' . self::$post_id ), $links['self'][0]['href'] );
 		$this->assertEquals( rest_url( '/wp/v2/posts' ), $links['collection'][0]['href'] );
+		$this->assertArrayNotHasKey( 'embeddable', $links['self'][0]['attributes'] );
 
 		$this->assertEquals( rest_url( '/wp/v2/types/' . get_post_type( self::$post_id ) ), $links['about'][0]['href'] );
 
@@ -1356,8 +1379,10 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$attachments_url = add_query_arg( 'parent', self::$post_id, $attachments_url );
 		$this->assertEquals( $attachments_url, $links['https://api.w.org/attachment'][0]['href'] );
 
-		$term_links = $links['https://api.w.org/term'];
-		$tag_link   = $cat_link = $format_link = null;
+		$term_links  = $links['https://api.w.org/term'];
+		$tag_link    = null;
+		$cat_link    = null;
+		$format_link = null;
 		foreach ( $term_links as $link ) {
 			if ( 'post_tag' === $link['attributes']['taxonomy'] ) {
 				$tag_link = $link;
@@ -1665,6 +1690,76 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		);
 	}
 
+	/**
+	 * @ticket 42094
+	 */
+	public function test_prepare_item_filters_content_when_needed() {
+		$filter_count   = 0;
+		$filter_content = function() use ( &$filter_count ) {
+			$filter_count++;
+			return '<p>Filtered content.</p>';
+		};
+		add_filter( 'the_content', $filter_content );
+
+		wp_set_current_user( self::$editor_id );
+		$endpoint = new WP_REST_Posts_Controller( 'post' );
+		$request  = new WP_REST_REQUEST( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+
+		$request->set_param( 'context', 'edit' );
+		$request->set_param( '_fields', 'content.rendered' );
+
+		$post     = get_post( self::$post_id );
+		$response = $endpoint->prepare_item_for_response( $post, $request );
+
+		remove_filter( 'the_content', $filter_content );
+
+		$this->assertEquals(
+			array(
+				'id'      => self::$post_id,
+				'content' => array(
+					'rendered' => '<p>Filtered content.</p>',
+				),
+			),
+			$response->get_data()
+		);
+		$this->assertSame( 1, $filter_count );
+	}
+
+	/**
+	 * @ticket 42094
+	 */
+	public function test_prepare_item_skips_content_filter_if_not_needed() {
+		$filter_count   = 0;
+		$filter_content = function() use ( &$filter_count ) {
+			$filter_count++;
+			return '<p>Filtered content.</p>';
+		};
+		add_filter( 'the_content', $filter_content );
+
+		wp_set_current_user( self::$editor_id );
+		$endpoint = new WP_REST_Posts_Controller( 'post' );
+		$request  = new WP_REST_REQUEST( 'GET', sprintf( '/wp/v2/posts/%d', self::$post_id ) );
+
+		$request->set_param( 'context', 'edit' );
+		$request->set_param( '_fields', 'content.raw' );
+
+		$post     = get_post( self::$post_id );
+		$response = $endpoint->prepare_item_for_response( $post, $request );
+
+		remove_filter( 'the_content', $filter_content );
+
+		$this->assertEquals(
+			array(
+				'id'      => $post->ID,
+				'content' => array(
+					'raw' => $post->post_content,
+				),
+			),
+			$response->get_data()
+		);
+		$this->assertSame( 0, $filter_count );
+	}
+
 	public function test_create_item() {
 		wp_set_current_user( self::$editor_id );
 
@@ -1988,8 +2083,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertEquals( 'draft', $data['status'] );
 		$this->assertEquals( 'draft', $new_post->post_status );
 		// Confirm dates are shimmed for gmt_offset
-		$post_modified_gmt = date( 'Y-m-d H:i:s', strtotime( $new_post->post_modified ) + ( get_option( 'gmt_offset' ) * 3600 ) );
-		$post_date_gmt     = date( 'Y-m-d H:i:s', strtotime( $new_post->post_date ) + ( get_option( 'gmt_offset' ) * 3600 ) );
+		$post_modified_gmt = gmdate( 'Y-m-d H:i:s', strtotime( $new_post->post_modified ) + ( get_option( 'gmt_offset' ) * 3600 ) );
+		$post_date_gmt     = gmdate( 'Y-m-d H:i:s', strtotime( $new_post->post_date ) + ( get_option( 'gmt_offset' ) * 3600 ) );
 
 		$this->assertEquals( mysql_to_rfc3339( $post_modified_gmt ), $data['modified_gmt'] );
 		$this->assertEquals( mysql_to_rfc3339( $post_date_gmt ), $data['date_gmt'] );
@@ -2467,7 +2562,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	public function revoke_assign_term( $caps, $cap, $user_id, $args ) {
-		if ( 'assign_term' === $cap && isset( $args[0] ) && $this->forbidden_cat == $args[0] ) {
+		if ( 'assign_term' === $cap && isset( $args[0] ) && $this->forbidden_cat === $args[0] ) {
 			$caps = array( 'do_not_allow' );
 		}
 		return $caps;
@@ -2531,6 +2626,66 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertEquals( $params['excerpt'], $post->post_excerpt );
 	}
 
+	/**
+	 * Verify that updating a post with a `null` date or date_gmt results in a reset post, where all
+	 * date values are equal (date, date_gmt, date_modified and date_modofied_gmt) in the API response.
+	 * In the database, the post_date_gmt field is reset to the default `0000-00-00 00:00:00`.
+	 *
+	 * @ticket 44975
+	 */
+	public function test_rest_update_post_with_empty_date() {
+		// Create a new test post.
+		$post_id = $this->factory->post->create();
+		wp_set_current_user( self::$editor_id );
+
+		// Set the post date to the future.
+		$future_date = '2919-07-29T18:00:00';
+		$request     = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->add_header( 'content-type', 'application/json' );
+		$params = $this->set_post_data(
+			array(
+				'date_gmt' => $future_date,
+				'date'     => $future_date,
+				'title'    => 'update',
+				'status'   => 'draft',
+			)
+		);
+		$request->set_body( wp_json_encode( $params ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->check_update_post_response( $response );
+		$new_data = $response->get_data();
+
+		// Verify the post is set to the future date.
+		$this->assertEquals( $new_data['date_gmt'], $future_date );
+		$this->assertEquals( $new_data['date'], $future_date );
+		$this->assertNotEquals( $new_data['date_gmt'], $new_data['modified_gmt'] );
+		$this->assertNotEquals( $new_data['date'], $new_data['modified'] );
+
+		// Update post with a blank field (date or date_gmt).
+		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
+		$request->add_header( 'content-type', 'application/json' );
+		$params = $this->set_post_data(
+			array(
+				'date_gmt' => null,
+				'title'    => 'test',
+				'status'   => 'draft',
+			)
+		);
+		$request->set_body( wp_json_encode( $params ) );
+		$response = rest_get_server()->dispatch( $request );
+
+		// Verify the date field values are reset in the API response.
+		$this->check_update_post_response( $response );
+		$new_data = $response->get_data();
+		$this->assertEquals( $new_data['date_gmt'], $new_data['date'] );
+		$this->assertNotEquals( $new_data['date_gmt'], $future_date );
+
+		$post = get_post( $post_id, 'ARRAY_A' );
+		$this->assertEquals( $post['post_date_gmt'], '0000-00-00 00:00:00' );
+		$this->assertNotEquals( $new_data['date_gmt'], $future_date );
+		$this->assertNotEquals( $new_data['date'], $future_date );
+	}
+
 	public function test_rest_update_post_raw() {
 		wp_set_current_user( self::$editor_id );
 
@@ -2714,8 +2869,8 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertEquals( $new_content, $new_post->post_content );
 
 		// The modified date should equal the current time.
-		$this->assertEquals( date( 'Y-m-d', strtotime( mysql_to_rfc3339( $expected_modified ) ) ), date( 'Y-m-d', strtotime( $data['modified'] ) ) );
-		$this->assertEquals( date( 'Y-m-d', strtotime( $expected_modified ) ), date( 'Y-m-d', strtotime( $new_post->post_modified ) ) );
+		$this->assertEquals( gmdate( 'Y-m-d', strtotime( mysql_to_rfc3339( $expected_modified ) ) ), gmdate( 'Y-m-d', strtotime( $data['modified'] ) ) );
+		$this->assertEquals( gmdate( 'Y-m-d', strtotime( $expected_modified ) ), gmdate( 'Y-m-d', strtotime( $new_post->post_modified ) ) );
 	}
 
 	/**
@@ -3895,6 +4050,12 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 		remove_post_type_support( 'post', 'author' );
 
+		// Re-initialize the controller to cache-bust schemas from prior test runs.
+		$GLOBALS['wp_rest_server']->override_by_default = true;
+		$controller                                     = new WP_REST_Posts_Controller( 'post' );
+		$controller->register_routes();
+		$GLOBALS['wp_rest_server']->override_by_default = false;
+
 		$response = rest_get_server()->dispatch( new WP_REST_Request( 'OPTIONS', '/wp/v2/posts' ) );
 		$data     = $response->get_data();
 		$schema   = $data['schema'];
@@ -4253,6 +4414,240 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 
 	}
 
+	/**
+	 * @ticket 39953
+	 */
+	public function test_putting_same_publish_date_does_not_remove_floating_date() {
+
+		wp_set_current_user( self::$superadmin_id );
+
+		$time = date( 'Y-m-d H:i:s' );
+
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_status' => 'draft',
+				'post_date'   => $time,
+			)
+		);
+
+		$this->assertEquals( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		$get = new WP_REST_Request( 'GET', "/wp/v2/posts/{$post->ID}" );
+		$get->set_query_params( array( 'context' => 'edit' ) );
+
+		$get      = rest_get_server()->dispatch( $get );
+		$get_body = $get->get_data();
+
+		$put = new WP_REST_Request( 'PUT', "/wp/v2/posts/{$post->ID}" );
+		$put->set_body_params( $get_body );
+
+		$response = rest_get_server()->dispatch( $put );
+		$body     = $response->get_data();
+
+		$this->assertEquals( strtotime( $get_body['date'] ), strtotime( $body['date'] ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( $get_body['date_gmt'] ), strtotime( $body['date_gmt'] ), 'The dates should be equal', 2 );
+
+		$this->assertEquals( '0000-00-00 00:00:00', get_post( $post->ID )->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 39953
+	 */
+	public function test_putting_different_publish_date_removes_floating_date() {
+
+		wp_set_current_user( self::$superadmin_id );
+
+		$time     = date( 'Y-m-d H:i:s' );
+		$new_time = date( 'Y-m-d H:i:s', strtotime( '+1 week' ) );
+
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_status' => 'draft',
+				'post_date'   => $time,
+			)
+		);
+
+		$this->assertEquals( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		$get = new WP_REST_Request( 'GET', "/wp/v2/posts/{$post->ID}" );
+		$get->set_query_params( array( 'context' => 'edit' ) );
+
+		$get      = rest_get_server()->dispatch( $get );
+		$get_body = $get->get_data();
+
+		$put = new WP_REST_Request( 'PUT', "/wp/v2/posts/{$post->ID}" );
+		$put->set_body_params(
+			array_merge(
+				$get_body,
+				array(
+					'date' => mysql_to_rfc3339( $new_time ),
+				)
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $put );
+		$body     = $response->get_data();
+
+		$this->assertEquals( strtotime( mysql_to_rfc3339( $new_time ) ), strtotime( $body['date'] ), 'The dates should be equal', 2 );
+
+		$this->assertNotEquals( '0000-00-00 00:00:00', get_post( $post->ID )->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 39953
+	 */
+	public function test_publishing_post_with_same_date_removes_floating_date() {
+
+		wp_set_current_user( self::$superadmin_id );
+
+		$time = date( 'Y-m-d H:i:s' );
+
+		$post = self::factory()->post->create_and_get(
+			array(
+				'post_status' => 'draft',
+				'post_date'   => $time,
+			)
+		);
+
+		$this->assertEquals( '0000-00-00 00:00:00', $post->post_date_gmt );
+
+		$get = new WP_REST_Request( 'GET', "/wp/v2/posts/{$post->ID}" );
+		$get->set_query_params( array( 'context' => 'edit' ) );
+
+		$get      = rest_get_server()->dispatch( $get );
+		$get_body = $get->get_data();
+
+		$put = new WP_REST_Request( 'PUT', "/wp/v2/posts/{$post->ID}" );
+		$put->set_body_params(
+			array_merge(
+				$get_body,
+				array(
+					'status' => 'publish',
+				)
+			)
+		);
+
+		$response = rest_get_server()->dispatch( $put );
+		$body     = $response->get_data();
+
+		$this->assertEquals( strtotime( $get_body['date'] ), strtotime( $body['date'] ), 'The dates should be equal', 2 );
+		$this->assertEquals( strtotime( $get_body['date_gmt'] ), strtotime( $body['date_gmt'] ), 'The dates should be equal', 2 );
+
+		$this->assertNotEquals( '0000-00-00 00:00:00', get_post( $post->ID )->post_date_gmt );
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_reuses_same_instance() {
+		$this->assertSame(
+			get_post_type_object( 'post' )->get_rest_controller(),
+			get_post_type_object( 'post' )->get_rest_controller()
+		);
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_null_if_post_type_does_not_show_in_rest() {
+		register_post_type(
+			'not_in_rest',
+			array(
+				'show_in_rest' => false,
+			)
+		);
+
+		$this->assertNull( get_post_type_object( 'not_in_rest' )->get_rest_controller() );
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_null_if_class_does_not_exist() {
+		register_post_type(
+			'class_not_found',
+			array(
+				'show_in_rest'          => true,
+				'rest_controller_class' => 'Class_That_Does_Not_Exist',
+			)
+		);
+
+		$this->assertNull( get_post_type_object( 'class_not_found' )->get_rest_controller() );
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_null_if_class_does_not_subclass_rest_controller() {
+		register_post_type(
+			'invalid_class',
+			array(
+				'show_in_rest'          => true,
+				'rest_controller_class' => 'WP_Post',
+			)
+		);
+
+		$this->assertNull( get_post_type_object( 'invalid_class' )->get_rest_controller() );
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_posts_controller_if_custom_class_not_specified() {
+		register_post_type(
+			'test',
+			array(
+				'show_in_rest' => true,
+			)
+		);
+
+		$this->assertInstanceOf(
+			WP_REST_Posts_Controller::class,
+			get_post_type_object( 'test' )->get_rest_controller()
+		);
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_provided_controller_class() {
+		$this->assertInstanceOf(
+			WP_REST_Blocks_Controller::class,
+			get_post_type_object( 'wp_block' )->get_rest_controller()
+		);
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_null_for_invalid_provided_controller() {
+		register_post_type(
+			'test',
+			array(
+				'show_in_rest'    => true,
+				'rest_controller' => new \stdClass(),
+			)
+		);
+
+		$this->assertNull( get_post_type_object( 'test' )->get_rest_controller() );
+	}
+
+	/**
+	 * @ticket 45677
+	 */
+	public function test_get_for_post_type_returns_null_for_controller_class_mismatch() {
+		register_post_type(
+			'test',
+			array(
+				'show_in_rest'          => true,
+				'rest_controller_class' => WP_REST_Posts_Controller::class,
+				'rest_controller'       => new WP_REST_Terms_Controller( 'category' ),
+			)
+		);
+
+		$this->assertNull( get_post_type_object( 'test' )->get_rest_controller() );
+	}
+
 	public function tearDown() {
 		_unregister_post_type( 'private-post' );
 		_unregister_post_type( 'youseeme' );
diff --git a/tests/rest-api/rest-request.php b/tests/rest-api/rest-request.php
index 7d318ce999..2dd539a509 100644
--- a/tests/rest-api/rest-request.php
+++ b/tests/rest-api/rest-request.php
@@ -463,8 +463,8 @@ class Tests_REST_Request extends WP_UnitTestCase {
 
 		$data = $valid->get_error_data( 'rest_missing_callback_param' );
 
-		$this->assertTrue( in_array( 'someinteger', $data['params'] ) );
-		$this->assertTrue( in_array( 'someotherinteger', $data['params'] ) );
+		$this->assertTrue( in_array( 'someinteger', $data['params'], true ) );
+		$this->assertTrue( in_array( 'someotherinteger', $data['params'], true ) );
 	}
 
 	public function test_has_valid_params_validate_callback() {
@@ -491,10 +491,6 @@ class Tests_REST_Request extends WP_UnitTestCase {
 	}
 
 	public function test_has_valid_params_json_error() {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			return $this->markTestSkipped( 'JSON validation is only available for PHP 5.3+' );
-		}
-
 		$this->request->set_header( 'Content-Type', 'application/json' );
 		$this->request->set_body( '{"invalid": JSON}' );
 
@@ -507,10 +503,6 @@ class Tests_REST_Request extends WP_UnitTestCase {
 
 
 	public function test_has_valid_params_empty_json_no_error() {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			return $this->markTestSkipped( 'JSON validation is only available for PHP 5.3+' );
-		}
-
 		$this->request->set_header( 'Content-Type', 'application/json' );
 		$this->request->set_body( '' );
 
diff --git a/tests/rest-api/rest-revisions-controller.php b/tests/rest-api/rest-revisions-controller.php
index f9497845ce..b181c2d5ee 100644
--- a/tests/rest-api/rest-revisions-controller.php
+++ b/tests/rest-api/rest-revisions-controller.php
@@ -76,6 +76,27 @@ class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase
 		$this->revision_id3    = $this->revision_3->ID;
 	}
 
+	public function tearDown() {
+		parent::tearDown();
+
+		remove_filter( 'map_meta_cap', array( $this, '_filter_map_meta_cap_remove_no_allow_revisions' ) );
+	}
+
+	public function _filter_map_meta_cap_remove_no_allow_revisions( $caps, $cap, $user_id, $args ) {
+		if ( 'delete_post' !== $cap || empty( $args ) ) {
+			return $caps;
+		}
+		$post = get_post( $args[0] );
+		if ( ! $post || 'revision' !== $post->post_type ) {
+			return $caps;
+		}
+		$key = array_search( 'do_not_allow', $caps, true );
+		if ( false !== $key ) {
+			unset( $caps[ $key ] );
+		}
+		return $caps;
+	}
+
 	public function test_register_routes() {
 		$routes = rest_get_server()->get_routes();
 		$this->assertArrayHasKey( '/wp/v2/posts/(?P<parent>[\d]+)/revisions', $routes );
@@ -216,13 +237,42 @@ class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase
 		$request = new WP_REST_Request( 'DELETE', '/wp/v2/posts/' . self::$post_id . '/revisions/' . $this->revision_id1 );
 		$request->set_param( 'force', true );
 		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( 'rest_cannot_delete', $response, 403 );
+		$this->assertNotNull( get_post( $this->revision_id1 ) );
+	}
+
+	/**
+	 * @ticket 43709
+	 */
+	public function test_delete_item_remove_do_not_allow() {
+		wp_set_current_user( self::$editor_id );
+		add_filter( 'map_meta_cap', array( $this, '_filter_map_meta_cap_remove_no_allow_revisions' ), 10, 4 );
+		$request = new WP_REST_Request( 'DELETE', '/wp/v2/posts/' . self::$post_id . '/revisions/' . $this->revision_id1 );
+		$request->set_param( 'force', true );
+		$response = rest_get_server()->dispatch( $request );
 		$this->assertEquals( 200, $response->get_status() );
 		$this->assertNull( get_post( $this->revision_id1 ) );
 	}
 
-	public function test_delete_item_no_trash() {
+	/**
+	 * @ticket 43709
+	 */
+	public function test_delete_item_cannot_delete_parent() {
 		wp_set_current_user( self::$editor_id );
+		$request = new WP_REST_Request( 'DELETE', '/wp/v2/posts/' . self::$post_id . '/revisions/' . $this->revision_id1 );
+		$request->set_param( 'force', true );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( 'rest_cannot_delete', $response, 403 );
+		$this->assertNotNull( get_post( $this->revision_id1 ) );
+	}
 
+	/**
+	 * @ticket 38494
+	 * @ticket 43709
+	 */
+	public function test_delete_item_no_trash() {
+		wp_set_current_user( self::$editor_id );
+		add_filter( 'map_meta_cap', array( $this, '_filter_map_meta_cap_remove_no_allow_revisions' ), 10, 4 );
 		$request  = new WP_REST_Request( 'DELETE', '/wp/v2/posts/' . self::$post_id . '/revisions/' . $this->revision_id1 );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_trash_not_supported', $response, 501 );
diff --git a/tests/rest-api/rest-schema-sanitization.php b/tests/rest-api/rest-schema-sanitization.php
index 4f9f2c9242..1b2fd1d90c 100644
--- a/tests/rest-api/rest-schema-sanitization.php
+++ b/tests/rest-api/rest-schema-sanitization.php
@@ -292,4 +292,59 @@ class WP_Test_REST_Schema_Sanitization extends WP_UnitTestCase {
 		$this->assertEquals( 1.10, rest_sanitize_value_from_schema( 1.10, $schema ) );
 		$this->assertEquals( 1, rest_sanitize_value_from_schema( 1, $schema ) );
 	}
+
+	public function test_nullable_date() {
+		$schema = array(
+			'type'   => array( 'string', 'null' ),
+			'format' => 'date-time',
+		);
+
+		$this->assertNull( rest_sanitize_value_from_schema( null, $schema ) );
+		$this->assertEquals( '2019-09-19T18:00:00', rest_sanitize_value_from_schema( '2019-09-19T18:00:00', $schema ) );
+		$this->assertNull( rest_sanitize_value_from_schema( 'lalala', $schema ) );
+	}
+
+	public function test_object_or_string() {
+		$schema = array(
+			'type'       => array( 'object', 'string' ),
+			'properties' => array(
+				'raw' => array(
+					'type' => 'string',
+				),
+			),
+		);
+
+		$this->assertEquals( 'My Value', rest_sanitize_value_from_schema( 'My Value', $schema ) );
+		$this->assertEquals( array( 'raw' => 'My Value' ), rest_sanitize_value_from_schema( array( 'raw' => 'My Value' ), $schema ) );
+		$this->assertNull( rest_sanitize_value_from_schema( array( 'raw' => 1 ), $schema ) );
+	}
+
+	public function test_object_or_bool() {
+		$schema = array(
+			'type'       => array( 'object', 'boolean' ),
+			'properties' => array(
+				'raw' => array(
+					'type' => 'boolean',
+				),
+			),
+		);
+
+		$this->assertTrue( rest_sanitize_value_from_schema( true, $schema ) );
+		$this->assertTrue( rest_sanitize_value_from_schema( '1', $schema ) );
+		$this->assertTrue( rest_sanitize_value_from_schema( 1, $schema ) );
+
+		$this->assertFalse( rest_sanitize_value_from_schema( false, $schema ) );
+		$this->assertFalse( rest_sanitize_value_from_schema( '0', $schema ) );
+		$this->assertFalse( rest_sanitize_value_from_schema( 0, $schema ) );
+
+		$this->assertEquals( array( 'raw' => true ), rest_sanitize_value_from_schema( array( 'raw' => true ), $schema ) );
+		$this->assertEquals( array( 'raw' => true ), rest_sanitize_value_from_schema( array( 'raw' => '1' ), $schema ) );
+		$this->assertEquals( array( 'raw' => true ), rest_sanitize_value_from_schema( array( 'raw' => 1 ), $schema ) );
+
+		$this->assertEquals( array( 'raw' => false ), rest_sanitize_value_from_schema( array( 'raw' => false ), $schema ) );
+		$this->assertEquals( array( 'raw' => false ), rest_sanitize_value_from_schema( array( 'raw' => '0' ), $schema ) );
+		$this->assertEquals( array( 'raw' => false ), rest_sanitize_value_from_schema( array( 'raw' => 0 ), $schema ) );
+
+		$this->assertNull( rest_sanitize_value_from_schema( array( 'raw' => 'something non boolean' ), $schema ) );
+	}
 }
diff --git a/tests/rest-api/rest-schema-setup.php b/tests/rest-api/rest-schema-setup.php
index 8eb03cb4c2..0aeebb4352 100644
--- a/tests/rest-api/rest-schema-setup.php
+++ b/tests/rest-api/rest-schema-setup.php
@@ -99,6 +99,7 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp/v2/pages/(?P<parent>[\\d]+)/autosaves/(?P<id>[\\d]+)',
 			'/wp/v2/media',
 			'/wp/v2/media/(?P<id>[\\d]+)',
+			'/wp/v2/media/(?P<id>[\\d]+)/post-process',
 			'/wp/v2/blocks',
 			'/wp/v2/blocks/(?P<id>[\d]+)',
 			'/wp/v2/blocks/(?P<id>[\d]+)/autosaves',
@@ -119,12 +120,16 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp/v2/comments',
 			'/wp/v2/comments/(?P<id>[\\d]+)',
 			'/wp/v2/search',
-			'/wp/v2/block-renderer/(?P<name>core/block)',
-			'/wp/v2/block-renderer/(?P<name>core/latest-comments)',
 			'/wp/v2/block-renderer/(?P<name>core/archives)',
+			'/wp/v2/block-renderer/(?P<name>core/block)',
+			'/wp/v2/block-renderer/(?P<name>core/calendar)',
 			'/wp/v2/block-renderer/(?P<name>core/categories)',
+			'/wp/v2/block-renderer/(?P<name>core/latest-comments)',
 			'/wp/v2/block-renderer/(?P<name>core/latest-posts)',
+			'/wp/v2/block-renderer/(?P<name>core/rss)',
+			'/wp/v2/block-renderer/(?P<name>core/search)',
 			'/wp/v2/block-renderer/(?P<name>core/shortcode)',
+			'/wp/v2/block-renderer/(?P<name>core/tag-cloud)',
 			'/wp/v2/settings',
 			'/wp/v2/themes',
 		);
@@ -445,16 +450,14 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			);
 			$this->assertTrue( ! empty( $data ), $route['name'] . ' route should return data.' );
 
-			if ( version_compare( PHP_VERSION, '5.4', '>=' ) ) {
-				$fixture           = $this->normalize_fixture( $data, $route['name'] );
-				$mocked_responses .= "\nmockedApiResponse." . $route['name'] . ' = '
-					. json_encode( $fixture, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES )
-					. ";\n";
-			}
+			$fixture           = $this->normalize_fixture( $data, $route['name'] );
+			$mocked_responses .= "\nmockedApiResponse." . $route['name'] . ' = '
+				. json_encode( $fixture, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES )
+				. ";\n";
 		}
 
 		// Only generate API client fixtures in single site and when required JSON_* constants are supported.
-		if ( ! is_multisite() && version_compare( PHP_VERSION, '5.4', '>=' ) ) {
+		if ( ! is_multisite() ) {
 			// Save the route object for QUnit tests.
 			$file = dirname( DIR_TESTROOT ) . '/qunit/fixtures/wp-api-generated.js';
 			file_put_contents( $file, $mocked_responses );
diff --git a/tests/rest-api/rest-schema-validation.php b/tests/rest-api/rest-schema-validation.php
index df16a894ad..9c18a846dc 100644
--- a/tests/rest-api/rest-schema-validation.php
+++ b/tests/rest-api/rest-schema-validation.php
@@ -296,4 +296,36 @@ class WP_Test_REST_Schema_Validation extends WP_UnitTestCase {
 		$this->assertTrue( rest_validate_value_from_schema( 1, $schema ) );
 		$this->assertTrue( rest_validate_value_from_schema( array(), $schema ) );
 	}
+
+	public function test_type_null() {
+		$this->assertTrue( rest_validate_value_from_schema( null, array( 'type' => 'null' ) ) );
+		$this->assertWPError( rest_validate_value_from_schema( '', array( 'type' => 'null' ) ) );
+		$this->assertWPError( rest_validate_value_from_schema( 'null', array( 'type' => 'null' ) ) );
+	}
+
+	public function test_nullable_date() {
+		$schema = array(
+			'type'   => array( 'string', 'null' ),
+			'format' => 'date-time',
+		);
+
+		$this->assertTrue( rest_validate_value_from_schema( null, $schema ) );
+		$this->assertTrue( rest_validate_value_from_schema( '2019-09-19T18:00:00', $schema ) );
+		$this->assertWPError( rest_validate_value_from_schema( 'some random string', $schema ) );
+	}
+
+	public function test_object_or_string() {
+		$schema = array(
+			'type'       => array( 'object', 'string' ),
+			'properties' => array(
+				'raw' => array(
+					'type' => 'string',
+				),
+			),
+		);
+
+		$this->assertTrue( rest_validate_value_from_schema( 'My Value', $schema ) );
+		$this->assertTrue( rest_validate_value_from_schema( array( 'raw' => 'My Value' ), $schema ) );
+		$this->assertWPError( rest_validate_value_from_schema( array( 'raw' => array( 'a list' ) ), $schema ) );
+	}
 }
diff --git a/tests/rest-api/rest-search-controller.php b/tests/rest-api/rest-search-controller.php
index 60d1ef0bfb..9a3982a701 100644
--- a/tests/rest-api/rest-search-controller.php
+++ b/tests/rest-api/rest-search-controller.php
@@ -500,6 +500,20 @@ class WP_Test_REST_Search_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertEqualSets( array( 'test_first_type', 'test_second_type', WP_REST_Search_Controller::TYPE_ANY ), $params[ WP_REST_Search_Controller::PROP_SUBTYPE ]['items']['enum'] );
 	}
 
+	/**
+	 * @ticket 47684
+	 */
+	public function test_search_result_links_are_embedded() {
+		$response = $this->do_request_with_params( array( 'per_page' => 1 ) );
+		$data     = rest_get_server()->response_to_data( $response, true )[0];
+
+		$this->assertArrayHasKey( '_embedded', $data );
+		$this->assertArrayHasKey( 'self', $data['_embedded'] );
+		$this->assertCount( 1, $data['_embedded']['self'] );
+		$this->assertArrayHasKey( WP_REST_Search_Controller::PROP_ID, $data['_embedded']['self'][0] );
+		$this->assertEquals( $data[ WP_REST_Search_Controller::PROP_ID ], $data['_embedded']['self'][0][ WP_REST_Search_Controller::PROP_ID ] );
+	}
+
 	/**
 	 * Perform a REST request to our search endpoint with given parameters.
 	 */
diff --git a/tests/rest-api/rest-server.php b/tests/rest-api/rest-server.php
index 8c514e9e66..74d957cbe5 100644
--- a/tests/rest-api/rest-server.php
+++ b/tests/rest-api/rest-server.php
@@ -569,6 +569,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 
 	/**
 	 * @depends test_link_embedding
+	 * @ticket 47684
 	 */
 	public function test_link_embedding_self() {
 		// Register our testing route.
@@ -582,8 +583,32 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		);
 		$response = new WP_REST_Response();
 
-		// 'self' should be ignored.
-		$response->add_link( 'self', rest_url( '/test/notembeddable' ), array( 'embeddable' => true ) );
+		// 'self' should not be special-cased, and may be marked embeddable.
+		$response->add_link( 'self', rest_url( '/test/embeddable' ), array( 'embeddable' => true ) );
+
+		$data = rest_get_server()->response_to_data( $response, true );
+
+		$this->assertArrayHasKey( '_embedded', $data );
+	}
+
+	/**
+	 * @depends test_link_embedding
+	 * @ticket 47684
+	 */
+	public function test_link_embedding_self_non_embeddable() {
+		// Register our testing route.
+		rest_get_server()->register_route(
+			'test',
+			'/test/embeddable',
+			array(
+				'methods'  => 'GET',
+				'callback' => array( $this, 'embedded_response_callback' ),
+			)
+		);
+		$response = new WP_REST_Response();
+
+		// 'self' should not be special-cased, and should be ignored if not marked embeddable.
+		$response->add_link( 'self', rest_url( '/test/notembeddable' ) );
 
 		$data = rest_get_server()->response_to_data( $response, true );
 
@@ -1144,6 +1169,48 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertEquals( 200, $response->get_status() );
 	}
 
+	/**
+	 * @ticket 43691
+	 */
+	public function test_does_not_echo_body_for_null_responses() {
+		register_rest_route(
+			'test-ns',
+			'/test',
+			array(
+				'methods'  => array( 'GET' ),
+				'callback' => function () {
+					return new WP_REST_Response();
+				},
+			)
+		);
+
+		$result = rest_get_server()->serve_request( '/test-ns/test' );
+
+		$this->assertNull( $result );
+		$this->assertEquals( '', rest_get_server()->sent_body );
+	}
+
+	/**
+	 * @ticket 43691
+	 */
+	public function test_does_not_echo_body_for_responses_with_204_status() {
+		register_rest_route(
+			'test-ns',
+			'/test',
+			array(
+				'methods'  => array( 'GET' ),
+				'callback' => function () {
+					return new WP_REST_Response( 'data', 204 );
+				},
+			)
+		);
+
+		$result = rest_get_server()->serve_request( '/test-ns/test' );
+
+		$this->assertNull( $result );
+		$this->assertEquals( '', rest_get_server()->sent_body );
+	}
+
 	public function _validate_as_integer_123( $value, $request, $key ) {
 		if ( ! is_int( $value ) ) {
 			return new WP_Error( 'some-error', 'This is not valid!' );
diff --git a/tests/rest-api/rest-tags-controller.php b/tests/rest-api/rest-tags-controller.php
index 96263c4061..ec17bc71e9 100644
--- a/tests/rest-api/rest-tags-controller.php
+++ b/tests/rest-api/rest-tags-controller.php
@@ -1269,6 +1269,50 @@ class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
 		$this->assertSame( $num_queries, $wpdb->num_queries );
 	}
 
+	/**
+	 * @ticket 41411
+	 */
+	public function test_editable_response_uses_edit_context() {
+		wp_set_current_user( self::$administrator );
+
+		$view_field = 'view_only_field';
+		$edit_field = 'edit_only_field';
+
+		register_rest_field(
+			'tag',
+			$view_field,
+			array(
+				'context'      => array( 'view' ),
+				'get_callback' => '__return_empty_string',
+			)
+		);
+
+		register_rest_field(
+			'tag',
+			$edit_field,
+			array(
+				'context'      => array( 'edit' ),
+				'get_callback' => '__return_empty_string',
+			)
+		);
+
+		$create = new WP_REST_Request( 'POST', '/wp/v2/tags' );
+		$create->set_param( 'name', 'My New Term' );
+		$response = rest_get_server()->dispatch( $create );
+		$this->assertEquals( 201, $response->get_status() );
+		$data = $response->get_data();
+		$this->assertArrayHasKey( $edit_field, $data );
+		$this->assertArrayNotHasKey( $view_field, $data );
+
+		$update = new WP_REST_Request( 'PUT', '/wp/v2/tags/' . $data['id'] );
+		$update->set_param( 'name', 'My Awesome New Term' );
+		$response = rest_get_server()->dispatch( $update );
+		$this->assertEquals( 200, $response->get_status() );
+		$data = $response->get_data();
+		$this->assertArrayHasKey( $edit_field, $data );
+		$this->assertArrayNotHasKey( $view_field, $data );
+	}
+
 	public function additional_field_get_callback( $object, $request ) {
 		return 123;
 	}
diff --git a/tests/rest-api/rest-taxonomies-controller.php b/tests/rest-api/rest-taxonomies-controller.php
index 4fd4935fb8..7b367b09a1 100644
--- a/tests/rest-api/rest-taxonomies-controller.php
+++ b/tests/rest-api/rest-taxonomies-controller.php
@@ -195,6 +195,25 @@ class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcas
 		);
 	}
 
+	/**
+	 * @ticket 42209
+	 */
+	public function test_object_types_is_an_array_if_object_type_is_unregistered() {
+		register_taxonomy_for_object_type( 'category', 'page' );
+		register_taxonomy_for_object_type( 'category', 'attachment' );
+		unregister_taxonomy_for_object_type( 'category', 'page' );
+
+		$request  = new WP_REST_Request( 'GET', '/wp/v2/taxonomies/category' );
+		$response = rest_get_server()->dispatch( $request );
+
+		$types = $response->get_data()['types'];
+		$this->assertArrayHasKey( 0, $types );
+		$this->assertEquals( 'post', $types[0] );
+		$this->assertArrayHasKey( 1, $types );
+		$this->assertEquals( 'attachment', $types[1] );
+		$this->assertEquals( 2, count( $types ) );
+	}
+
 	public function test_get_item_schema() {
 		$request    = new WP_REST_Request( 'OPTIONS', '/wp/v2/taxonomies' );
 		$response   = rest_get_server()->dispatch( $request );
diff --git a/tests/rest-api/rest-users-controller.php b/tests/rest-api/rest-users-controller.php
index 5addd6b6f4..28755a97d1 100644
--- a/tests/rest-api/rest-users-controller.php
+++ b/tests/rest-api/rest-users-controller.php
@@ -2522,6 +2522,13 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 
 	public function test_get_item_schema_show_avatar() {
 		update_option( 'show_avatars', false );
+
+		// Re-initialize the controller to cache-bust schemas from prior test runs.
+		$GLOBALS['wp_rest_server']->override_by_default = true;
+		$controller                                     = new WP_REST_Users_Controller();
+		$controller->register_routes();
+		$GLOBALS['wp_rest_server']->override_by_default = false;
+
 		$request    = new WP_REST_Request( 'OPTIONS', '/wp/v2/users' );
 		$response   = rest_get_server()->dispatch( $request );
 		$data       = $response->get_data();
@@ -2791,7 +2798,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 			$this->assertEquals( $user->user_email, $data['email'] );
 			$this->assertEquals( (object) $user->allcaps, $data['capabilities'] );
 			$this->assertEquals( (object) $user->caps, $data['extra_capabilities'] );
-			$this->assertEquals( date( 'c', strtotime( $user->user_registered ) ), $data['registered_date'] );
+			$this->assertEquals( gmdate( 'c', strtotime( $user->user_registered ) ), $data['registered_date'] );
 			$this->assertEquals( $user->user_login, $data['username'] );
 			$this->assertEquals( $user->roles, $data['roles'] );
 			$this->assertEquals( get_user_locale( $user ), $data['locale'] );
diff --git a/tests/shortcode.php b/tests/shortcode.php
index be1b1ad760..a978779c9a 100644
--- a/tests/shortcode.php
+++ b/tests/shortcode.php
@@ -38,7 +38,8 @@ class Tests_Shortcode extends WP_UnitTestCase {
 
 	// [footag foo="bar"]
 	function _shortcode_footag( $atts ) {
-		return @"foo = {$atts['foo']}";
+		$foo = isset( $atts['foo'] ) ? $atts['foo'] : '';
+		return "foo = $foo";
 	}
 
 	// [bartag foo="bar"]
@@ -444,7 +445,7 @@ EOF;
 	// Filter shortcode atts in various ways
 	function _filter_atts2( $out, $pairs, $atts ) {
 		// If foo attribute equals "foo1", change it to be default value
-		if ( isset( $out['foo'] ) && 'foo1' == $out['foo'] ) {
+		if ( isset( $out['foo'] ) && 'foo1' === $out['foo'] ) {
 			$out['foo'] = $pairs['foo'];
 		}
 
diff --git a/tests/site-health.php b/tests/site-health.php
new file mode 100644
index 0000000000..6c22fe4ddf
--- /dev/null
+++ b/tests/site-health.php
@@ -0,0 +1,107 @@
+<?php
+
+/**
+ * @group site-health
+ */
+class Tests_Site_Health extends WP_UnitTestCase {
+	public static function wpSetUpBeforeClass() {
+		// Include the `WP_Site_Health` file.
+		include_once( ABSPATH . 'wp-admin/includes/class-wp-site-health.php' );
+	}
+
+	/**
+	 * Ensure Site Health reports correctly cron job reports.
+	 *
+	 * @ticket 47223
+	 */
+	function test_cron_health_checks_critical() {
+		// Clear the cron array.
+		_set_cron_array( array() );
+		$wp_site_health = new WP_Site_Health();
+		$cron_health    = $wp_site_health->get_test_scheduled_events();
+
+		$this->assertSame( 'critical', $cron_health['status'] );
+		$this->assertSame( __( 'It was not possible to check your scheduled events' ), $cron_health['label'] );
+		$this->assertWPError( $wp_site_health->has_late_cron() );
+		$this->assertWPError( $wp_site_health->has_missed_cron() );
+	}
+
+	/**
+	 * Ensure Site Health reports correctly cron job reports.
+	 *
+	 * @dataProvider data_cron_health_checks
+	 * @ticket 47223
+	 */
+	function test_cron_health_checks( $times, $expected_status, $expected_label, $expected_late, $expected_missed ) {
+		/*
+		 * Clear the cron array.
+		 *
+		 * The core jobs may register as late/missed in the test suite as they
+		 * are not run. Clearing the array ensures the site health tests are only
+		 * reported based on the jobs set in the test.
+		 */
+		_set_cron_array( array() );
+		$times = (array) $times;
+		foreach ( $times as $job => $time ) {
+			$timestamp = strtotime( $time );
+			wp_schedule_event( $timestamp, 'daily', __FUNCTION__ . "_{$job}" );
+		}
+
+		$wp_site_health = new WP_Site_Health();
+		$cron_health    = $wp_site_health->get_test_scheduled_events();
+
+		$this->assertSame( $expected_status, $cron_health['status'] );
+		$this->assertSame( $expected_label, $cron_health['label'] );
+		$this->assertSame( $expected_late, $wp_site_health->has_late_cron() );
+		$this->assertSame( $expected_missed, $wp_site_health->has_missed_cron() );
+	}
+
+	/**
+	 * Data provider for Site Health cron reports.
+	 *
+	 * The test suite runs with `DISABLE_WP_CRON === true` so the
+	 * missed and late tests need to account for the extended periods
+	 * allowed for with this flag enabled.
+	 *
+	 * 1. string|array Times to schedule (run through strtotime())
+	 * 2. string       Expected status
+	 * 3. string       Expected label
+	 * 4. bool         Expected outcome has_late_cron()
+	 * 5. bool         Expected outcome has_missed_cron()
+	 */
+	function data_cron_health_checks() {
+		return array(
+			array(
+				'+5 minutes',
+				'good',
+				__( 'Scheduled events are running' ),
+				false,
+				false,
+			),
+			array(
+				'-50 minutes',
+				'recommended',
+				__( 'A scheduled event is late' ),
+				true,
+				false,
+			),
+			array(
+				'-500 minutes',
+				'recommended',
+				__( 'A scheduled event has failed' ),
+				false,
+				true,
+			),
+			array(
+				array(
+					'-50 minutes',
+					'-500 minutes',
+				),
+				'recommended',
+				__( 'A scheduled event has failed' ),
+				true,
+				true,
+			),
+		);
+	}
+}
diff --git a/tests/taxonomy.php b/tests/taxonomy.php
index 1286322bb1..6d30ccf778 100644
--- a/tests/taxonomy.php
+++ b/tests/taxonomy.php
@@ -811,9 +811,9 @@ class Tests_Taxonomy extends WP_UnitTestCase {
 
 		register_taxonomy( 'foo', 'post', array( 'query_var' => 'bar' ) );
 
-		$this->assertInternalType( 'int', array_search( 'bar', $wp->public_query_vars ) );
+		$this->assertInternalType( 'int', array_search( 'bar', $wp->public_query_vars, true ) );
 		$this->assertTrue( unregister_taxonomy( 'foo' ) );
-		$this->assertFalse( array_search( 'bar', $wp->public_query_vars ) );
+		$this->assertFalse( array_search( 'bar', $wp->public_query_vars, true ) );
 	}
 
 	/**
diff --git a/tests/template.php b/tests/template.php
index 3a0b66b752..7178d7a3cd 100644
--- a/tests/template.php
+++ b/tests/template.php
@@ -13,6 +13,15 @@ class Tests_Template extends WP_UnitTestCase {
 	protected static $page;
 	protected static $post;
 
+	/**
+	 * Page For Privacy Policy.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @var WP_Post $page_for_privacy_policy
+	 */
+	protected static $page_for_privacy_policy;
+
 	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
 		self::$page_on_front = $factory->post->create_and_get(
 			array(
@@ -45,6 +54,13 @@ class Tests_Template extends WP_UnitTestCase {
 		);
 		set_post_format( self::$post, 'quote' );
 		add_post_meta( self::$post->ID, '_wp_page_template', 'templates/post.php' );
+
+		self::$page_for_privacy_policy = $factory->post->create_and_get(
+			array(
+				'post_type'  => 'page',
+				'post_title' => 'Privacy Policy',
+			)
+		);
 	}
 
 	public function setUp() {
@@ -272,6 +288,25 @@ class Tests_Template extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 44005
+	 * @group privacy
+	 */
+	public function test_privacy_template_hierarchy() {
+		update_option( 'wp_page_for_privacy_policy', self::$page_for_privacy_policy->ID );
+
+		$this->assertTemplateHierarchy(
+			get_permalink( self::$page_for_privacy_policy->ID ),
+			array(
+				'privacy-policy.php',
+				'page-privacy-policy.php',
+				'page-' . self::$page_for_privacy_policy->ID . '.php',
+				'page.php',
+				'singular.php',
+			)
+		);
+	}
+
 	/**
 	 * @ticket 18375
 	 */
@@ -436,6 +471,7 @@ class Tests_Template extends WP_UnitTestCase {
 			'search'            => 'is_search',
 			'front_page'        => 'is_front_page',
 			'home'              => 'is_home',
+			'privacy_policy'    => 'is_privacy_policy',
 			'post_type_archive' => 'is_post_type_archive',
 			'taxonomy'          => 'is_tax',
 			'attachment'        => 'is_attachment',
diff --git a/tests/term/cache.php b/tests/term/cache.php
index f53432918d..bfebe9338e 100644
--- a/tests/term/cache.php
+++ b/tests/term/cache.php
@@ -90,7 +90,7 @@ class Tests_Term_Cache extends WP_UnitTestCase {
 				$this->assertEquals( $children, count( $hierarchy, COUNT_RECURSIVE ) - count( $hierarchy ) );
 			}
 
-			if ( $i % 3 === 0 ) {
+			if ( 0 === ( $i % 3 ) ) {
 				$step = 1;
 			} else {
 				$step++;
diff --git a/tests/term/getTerms.php b/tests/term/getTerms.php
index b2a0965306..6b8145e845 100644
--- a/tests/term/getTerms.php
+++ b/tests/term/getTerms.php
@@ -173,8 +173,9 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		// Force last_changed to bump.
 		wp_delete_term( $terms[0]->term_id, 'post_tag' );
 
-		$num_queries                           = $wpdb->num_queries;
-		$this->assertNotEquals( $time1, $time2 = wp_cache_get( 'last_changed', 'terms' ) );
+		$num_queries = $wpdb->num_queries;
+		$time2       = wp_cache_get( 'last_changed', 'terms' );
+		$this->assertNotEquals( $time1, $time2 );
 
 		// last_changed and num_queries should bump after a term is deleted.
 		$terms = get_terms( 'post_tag' );
@@ -2474,9 +2475,9 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$this->assertEqualSets( array( $t1, $t2, $t3 ), wp_list_pluck( $found, 'term_id' ) );
 
 		foreach ( $found as $f ) {
-			if ( $t1 == $f->term_id ) {
+			if ( $t1 === $f->term_id ) {
 				$this->assertSame( 3, $f->count );
-			} elseif ( $t2 == $f->term_id ) {
+			} elseif ( $t2 === $f->term_id ) {
 				$this->assertSame( 2, $f->count );
 			} else {
 				$this->assertSame( 1, $f->count );
@@ -2547,9 +2548,9 @@ class Tests_Term_getTerms extends WP_UnitTestCase {
 		$this->assertEqualSets( array( $t1, $t2, $t3 ), wp_list_pluck( $found, 'term_id' ) );
 
 		foreach ( $found as $f ) {
-			if ( $t1 == $f->term_id ) {
+			if ( $t1 === $f->term_id ) {
 				$this->assertEquals( 1, $f->count );
-			} elseif ( $t2 == $f->term_id ) {
+			} elseif ( $t2 === $f->term_id ) {
 				$this->assertEquals( 2, $f->count );
 			} else {
 				$this->assertEquals( 1, $f->count );
diff --git a/tests/term/query.php b/tests/term/query.php
index f40a9b55e7..699330851b 100644
--- a/tests/term/query.php
+++ b/tests/term/query.php
@@ -737,4 +737,113 @@ class Tests_Term_Query extends WP_UnitTestCase {
 
 		return $term;
 	}
+
+	/**
+	 * @ticket 41246
+	 */
+	public function test_terms_pre_query_filter_should_bypass_database_query() {
+		global $wpdb;
+
+		add_filter( 'terms_pre_query', array( __CLASS__, 'filter_terms_pre_query' ), 10, 2 );
+
+		$num_queries = $wpdb->num_queries;
+
+		$q       = new WP_Term_Query();
+		$results = $q->query(
+			array(
+				'fields' => 'ids',
+			)
+		);
+
+		remove_filter( 'terms_pre_query', array( __CLASS__, 'filter_terms_pre_query' ), 10, 2 );
+
+		// Make sure no queries were executed.
+		$this->assertSame( $num_queries, $wpdb->num_queries );
+
+		// We manually inserted a non-existing term and overrode the results with it.
+		$this->assertSame( array( 555 ), $q->terms );
+	}
+
+	public static function filter_terms_pre_query( $terms, $query ) {
+		return array( 555 );
+	}
+
+	/**
+	 * @ticket 37728
+	 */
+	public function test_hide_empty_should_include_empty_parents_of_nonempty_children() {
+		register_taxonomy(
+			'wptests_tax',
+			'post',
+			array(
+				'hierarchical' => true,
+			)
+		);
+
+		$t1 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+
+		$t2 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'parent'   => $t1,
+			)
+		);
+
+		$p = self::factory()->post->create();
+
+		wp_set_object_terms( $p, $t2, 'wptests_tax' );
+
+		$q = new WP_Term_Query(
+			array(
+				'taxonomy'   => 'wptests_tax',
+				'hide_empty' => true,
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertContains( $t1, $q->terms );
+	}
+
+	/**
+	 * @ticket 37728
+	 */
+	public function test_hide_empty_should_include_empty_parents_of_nonempty_children_when_category_is_unspecified() {
+		register_taxonomy(
+			'wptests_tax',
+			'post',
+			array(
+				'hierarchical' => true,
+			)
+		);
+
+		$t1 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+			)
+		);
+
+		$t2 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax',
+				'parent'   => $t1,
+			)
+		);
+
+		$p = self::factory()->post->create();
+
+		wp_set_object_terms( $p, $t2, 'wptests_tax' );
+
+		$q = new WP_Term_Query(
+			array(
+				'hide_empty' => true,
+				'fields'     => 'ids',
+			)
+		);
+
+		$this->assertContains( $t1, $q->terms );
+	}
 }
diff --git a/tests/term/splitSharedTerm.php b/tests/term/splitSharedTerm.php
index 04b67d4b0d..ff540f68db 100644
--- a/tests/term/splitSharedTerm.php
+++ b/tests/term/splitSharedTerm.php
@@ -228,7 +228,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33187
-	 * @group navmenus
+	 * @group menu
 	 */
 	public function test_nav_menu_locations_should_be_updated_on_split() {
 		global $wpdb;
@@ -257,7 +257,7 @@ class Tests_Term_SplitSharedTerm extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 33187
-	 * @group navmenus
+	 * @group menu
 	 */
 	public function test_nav_menu_term_should_retain_menu_items_on_split() {
 		global $wpdb;
diff --git a/tests/term/termExists.php b/tests/term/termExists.php
index 658cac087a..a99aefbb76 100644
--- a/tests/term/termExists.php
+++ b/tests/term/termExists.php
@@ -150,7 +150,7 @@ class Tests_TermExists extends WP_UnitTestCase {
 
 		_unregister_taxonomy( 'foo' );
 
-		$this->assertSame( null, $found['term_id'] );
+		$this->assertSame( null, $found );
 	}
 
 	public function test_term_exists_taxonomy_nonempty_parent_nonempty_match_name() {
diff --git a/tests/term/wpInsertTerm.php b/tests/term/wpInsertTerm.php
index 08f5dabc00..160bbab62e 100644
--- a/tests/term/wpInsertTerm.php
+++ b/tests/term/wpInsertTerm.php
@@ -822,7 +822,7 @@ class Tests_Term_WpInsertTerm extends WP_UnitTestCase {
 
 		$cached_children = get_option( 'wptests_tax_children' );
 		$this->assertNotEmpty( $cached_children[ $t ] );
-		$this->assertTrue( in_array( $found['term_id'], $cached_children[ $t ] ) );
+		$this->assertTrue( in_array( $found['term_id'], $cached_children[ $t ], true ) );
 	}
 
 	/**
diff --git a/tests/term/wpTaxonomy.php b/tests/term/wpTaxonomy.php
index 94bc882cce..3f646fd5ba 100644
--- a/tests/term/wpTaxonomy.php
+++ b/tests/term/wpTaxonomy.php
@@ -22,7 +22,7 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		$taxonomy_object = new WP_Taxonomy( $taxonomy, 'post' );
 
 		$taxonomy_object->add_rewrite_rules();
-		$this->assertFalse( in_array( 'foobar', $wp->public_query_vars ) );
+		$this->assertFalse( in_array( 'foobar', $wp->public_query_vars, true ) );
 	}
 
 	public function test_adds_query_var_if_public() {
@@ -43,10 +43,10 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		);
 
 		$taxonomy_object->add_rewrite_rules();
-		$in_array = in_array( 'foobar', $wp->public_query_vars );
+		$in_array = in_array( 'foobar', $wp->public_query_vars, true );
 
 		$taxonomy_object->remove_rewrite_rules();
-		$in_array_after = in_array( 'foobar', $wp->public_query_vars );
+		$in_array_after = in_array( 'foobar', $wp->public_query_vars, true );
 
 		$this->assertTrue( $in_array );
 		$this->assertFalse( $in_array_after );
@@ -74,8 +74,8 @@ class Tests_WP_Taxonomy extends WP_UnitTestCase {
 		$taxonomy_object->remove_rewrite_rules();
 		$rewrite_tags_after = $wp_rewrite->rewritecode;
 
-		$this->assertNotFalse( array_search( "%$taxonomy%", $rewrite_tags ) );
-		$this->assertFalse( array_search( "%$taxonomy%", $rewrite_tags_after ) );
+		$this->assertNotFalse( array_search( "%$taxonomy%", $rewrite_tags, true ) );
+		$this->assertFalse( array_search( "%$taxonomy%", $rewrite_tags_after, true ) );
 	}
 
 	public function test_adds_ajax_callback() {
diff --git a/tests/term/wpUniqueTermSlug.php b/tests/term/wpUniqueTermSlug.php
index b81dca5b40..75501edab6 100644
--- a/tests/term/wpUniqueTermSlug.php
+++ b/tests/term/wpUniqueTermSlug.php
@@ -127,4 +127,49 @@ class Tests_Term_WpUniqueTermSlug extends WP_UnitTestCase {
 		$actual = wp_unique_term_slug( 'bar', $term2_object );
 		$this->assertEquals( 'bar-2', $actual );
 	}
+
+	/**
+	 * @ticket 46431
+	 */
+	public function test_duplicate_parent_suffixed_slug_should_get_numeric_suffix() {
+		$t1 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax2',
+				'name'     => 'Animal',
+				'slug'     => 'animal',
+			)
+		);
+
+		$t2 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax2',
+				'name'     => 'Dog',
+				'slug'     => 'dog',
+			)
+		);
+
+		$t3 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax2',
+				'name'     => 'Cat',
+				'slug'     => 'dog-animal',
+				'parent'   => $t1,
+			)
+		);
+
+		$t4 = self::factory()->term->create(
+			array(
+				'taxonomy' => 'wptests_tax2',
+				'name'     => 'Giraffe',
+				'slug'     => 'giraffe',
+				'parent'   => $t1,
+			)
+		);
+
+		$term = get_term( $t4 );
+
+		$slug = wp_unique_term_slug( 'dog', $term );
+
+		$this->assertSame( 'dog-animal-2', $slug );
+	}
 }
diff --git a/tests/term/wpUpdateTerm.php b/tests/term/wpUpdateTerm.php
index d9c4f60e46..5de6d83c59 100644
--- a/tests/term/wpUpdateTerm.php
+++ b/tests/term/wpUpdateTerm.php
@@ -685,7 +685,7 @@ class Tests_Term_WpUpdateTerm extends WP_UnitTestCase {
 
 		$cached_children = get_option( 'wptests_tax_children' );
 		$this->assertNotEmpty( $cached_children[ $t2 ] );
-		$this->assertTrue( in_array( $found['term_id'], $cached_children[ $t2 ] ) );
+		$this->assertTrue( in_array( $found['term_id'], $cached_children[ $t2 ], true ) );
 	}
 
 	/**
diff --git a/tests/theme.php b/tests/theme.php
index 7e2ea89efc..2f114d43e2 100644
--- a/tests/theme.php
+++ b/tests/theme.php
@@ -18,6 +18,7 @@ class Tests_Theme extends WP_UnitTestCase {
 		'twentysixteen',
 		'twentyseventeen',
 		'twentynineteen',
+		'twentytwenty',
 	);
 
 	function setUp() {
@@ -243,7 +244,7 @@ class Tests_Theme extends WP_UnitTestCase {
 		for ( $i = 0; $i < 3; $i++ ) {
 			foreach ( $themes as $name => $theme ) {
 				// switch to this theme
-				if ( $i === 2 ) {
+				if ( 2 === $i ) {
 					switch_theme( $theme['Template'], $theme['Stylesheet'] );
 				} else {
 					switch_theme( $theme['Stylesheet'] );
@@ -288,6 +289,7 @@ class Tests_Theme extends WP_UnitTestCase {
 				$this->assertEquals( get_category_template(), get_query_template( 'category' ) );
 				$this->assertEquals( get_date_template(), get_query_template( 'date' ) );
 				$this->assertEquals( get_home_template(), get_query_template( 'home', array( 'home.php', 'index.php' ) ) );
+				$this->assertEquals( get_privacy_policy_template(), get_query_template( 'privacy_policy', array( 'privacy-policy.php' ) ) );
 				$this->assertEquals( get_page_template(), get_query_template( 'page' ) );
 				$this->assertEquals( get_search_template(), get_query_template( 'search' ) );
 				$this->assertEquals( get_single_template(), get_query_template( 'single' ) );
diff --git a/tests/theme/customHeader.php b/tests/theme/customHeader.php
index eeb240fc91..65b037042a 100644
--- a/tests/theme/customHeader.php
+++ b/tests/theme/customHeader.php
@@ -126,10 +126,6 @@ class Tests_Theme_Custom_Header extends WP_UnitTestCase {
 		$this->assertFalse( has_custom_header() );
 		$this->assertEmpty( $html );
 
-		// ReflectionMethod::setAccessible is only available in PHP 5.3+
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			return;
-		}
 		// The container should always be returned in the Customizer preview.
 		$this->_set_customize_previewing( true );
 		$html = get_custom_header_markup();
@@ -226,11 +222,6 @@ class Tests_Theme_Custom_Header extends WP_UnitTestCase {
 	}
 
 	function test_header_script_is_enqueued_by_the_custom_header_markup_without_video_when_previewing_in_customizer() {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			$this->markTestSkipped( 'ReflectionMethod::setAccessible is only available in PHP 5.3+' );
-			return;
-		}
-
 		$this->_add_theme_support(
 			array(
 				'video'                 => true,
diff --git a/tests/theme/support.php b/tests/theme/support.php
index f71760ed31..86561a5c9b 100644
--- a/tests/theme/support.php
+++ b/tests/theme/support.php
@@ -142,7 +142,7 @@ class Tests_Theme_Support extends WP_UnitTestCase {
 	}
 
 	function supports_foobar( $yesno, $args, $feature ) {
-		if ( $args[0] == $feature[0] ) {
+		if ( $args[0] === $feature[0] ) {
 			return true;
 		}
 		return false;
diff --git a/tests/theme/themeDir.php b/tests/theme/themeDir.php
index 2cab375b1a..51e5046bae 100644
--- a/tests/theme/themeDir.php
+++ b/tests/theme/themeDir.php
@@ -145,7 +145,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 
 		// Ignore themes in the default /themes directory.
 		foreach ( $themes as $theme_name => $theme ) {
-			if ( $theme->get_theme_root() != $this->theme_root ) {
+			if ( $theme->get_theme_root() !== $this->theme_root ) {
 				unset( $themes[ $theme_name ] );
 			}
 		}
@@ -209,7 +209,7 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 		$this->assertFalse( empty( $theme ) );
 
 		$templates = $theme['Template Files'];
-		$this->assertTrue( in_array( $this->theme_root . '/page-templates/template-top-level.php', $templates ) );
+		$this->assertTrue( in_array( $this->theme_root . '/page-templates/template-top-level.php', $templates, true ) );
 	}
 
 	/**
diff --git a/tests/url.php b/tests/url.php
index 4d59c67bed..66f4b77eb6 100644
--- a/tests/url.php
+++ b/tests/url.php
@@ -336,8 +336,8 @@ class Tests_URL extends WP_UnitTestCase {
 
 	public function test_get_adjacent_post() {
 		$now      = time();
-		$post_id  = self::factory()->post->create( array( 'post_date' => date( 'Y-m-d H:i:s', $now - 1 ) ) );
-		$post_id2 = self::factory()->post->create( array( 'post_date' => date( 'Y-m-d H:i:s', $now ) ) );
+		$post_id  = self::factory()->post->create( array( 'post_date' => gmdate( 'Y-m-d H:i:s', $now - 1 ) ) );
+		$post_id2 = self::factory()->post->create( array( 'post_date' => gmdate( 'Y-m-d H:i:s', $now ) ) );
 
 		if ( ! isset( $GLOBALS['post'] ) ) {
 			$GLOBALS['post'] = null;
@@ -379,13 +379,13 @@ class Tests_URL extends WP_UnitTestCase {
 			array(
 				'post_author' => $u,
 				'post_status' => 'private',
-				'post_date'   => date( 'Y-m-d H:i:s', $now - 1 ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now - 1 ),
 			)
 		);
 		$p2  = self::factory()->post->create(
 			array(
 				'post_author' => $u,
-				'post_date'   => date( 'Y-m-d H:i:s', $now ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 
@@ -417,13 +417,13 @@ class Tests_URL extends WP_UnitTestCase {
 			array(
 				'post_author' => $u1,
 				'post_status' => 'private',
-				'post_date'   => date( 'Y-m-d H:i:s', $now - 1 ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now - 1 ),
 			)
 		);
 		$p2  = self::factory()->post->create(
 			array(
 				'post_author' => $u1,
-				'post_date'   => date( 'Y-m-d H:i:s', $now ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 
@@ -454,20 +454,20 @@ class Tests_URL extends WP_UnitTestCase {
 		$p1  = self::factory()->post->create(
 			array(
 				'post_author' => $u1,
-				'post_date'   => date( 'Y-m-d H:i:s', $now - 2 ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now - 2 ),
 			)
 		);
 		$p2  = self::factory()->post->create(
 			array(
 				'post_author' => $u1,
 				'post_status' => 'private',
-				'post_date'   => date( 'Y-m-d H:i:s', $now - 1 ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now - 1 ),
 			)
 		);
 		$p3  = self::factory()->post->create(
 			array(
 				'post_author' => $u1,
-				'post_date'   => date( 'Y-m-d H:i:s', $now ),
+				'post_date'   => gmdate( 'Y-m-d H:i:s', $now ),
 			)
 		);
 
diff --git a/tests/url/getPrivacyPolicyUrl.php b/tests/url/getPrivacyPolicyUrl.php
index b6d6a23ba3..69384702da 100644
--- a/tests/url/getPrivacyPolicyUrl.php
+++ b/tests/url/getPrivacyPolicyUrl.php
@@ -45,8 +45,6 @@ class Tests_Url_GetPrivacyPolicyUrl extends WP_UnitTestCase {
 				'post_title' => WP_TESTS_DOMAIN . ' Privacy Policy',
 			)
 		);
-
-		self::$privacy_policy_url = get_permalink( self::$privacy_policy_page_id );
 	}
 
 	/**
@@ -60,9 +58,10 @@ class Tests_Url_GetPrivacyPolicyUrl extends WP_UnitTestCase {
 	 * The function should return the privacy policy URL when `wp_page_for_privacy_policy` is set.
 	 */
 	public function test_get_privacy_policy_url_should_return_valid_url_when_policy_page_set() {
+		$privacy_policy_url = get_permalink( self::$privacy_policy_page_id );
 		update_option( 'wp_page_for_privacy_policy', self::$privacy_policy_page_id );
 
-		$this->assertSame( self::$privacy_policy_url, get_privacy_policy_url() );
+		$this->assertSame( $privacy_policy_url, get_privacy_policy_url() );
 	}
 
 	/**
diff --git a/tests/user.php b/tests/user.php
index 01be5de452..d90793958b 100644
--- a/tests/user.php
+++ b/tests/user.php
@@ -18,7 +18,7 @@ class Tests_User extends WP_UnitTestCase {
 	protected $user_data;
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$user_ids[] = self::$contrib_id = $factory->user->create(
+		self::$contrib_id = $factory->user->create(
 			array(
 				'user_login'    => 'user1',
 				'user_nicename' => 'userone',
@@ -33,23 +33,28 @@ class Tests_User extends WP_UnitTestCase {
 				'description'   => 'I am a WordPress user that cares about privacy.',
 			)
 		);
+		self::$user_ids[] = self::$contrib_id;
 
-		self::$user_ids[] = self::$author_id = $factory->user->create(
+		self::$author_id  = $factory->user->create(
 			array(
 				'user_login' => 'author_login',
 				'user_email' => 'author@email.com',
 				'role'       => 'author',
 			)
 		);
+		self::$user_ids[] = self::$author_id;
 
-		self::$user_ids[] = self::$admin_id = $factory->user->create( array( 'role' => 'administrator' ) );
-		self::$user_ids[] = self::$editor_id = $factory->user->create(
+		self::$admin_id   = $factory->user->create( array( 'role' => 'administrator' ) );
+		self::$user_ids[] = self::$admin_id;
+		self::$editor_id  = $factory->user->create(
 			array(
 				'role'       => 'editor',
 				'user_email' => 'test@test.com',
 			)
 		);
-		self::$user_ids[] = self::$sub_id = $factory->user->create( array( 'role' => 'subscriber' ) );
+		self::$user_ids[] = self::$editor_id;
+		self::$sub_id     = $factory->user->create( array( 'role' => 'subscriber' ) );
+		self::$user_ids[] = self::$sub_id;
 
 		self::$_author = get_user_by( 'ID', self::$author_id );
 	}
@@ -76,7 +81,7 @@ class Tests_User extends WP_UnitTestCase {
 		$found = array();
 		foreach ( $user_list as $user ) {
 			// only include the users we just created - there might be some others that existed previously
-			if ( in_array( $user->ID, $nusers ) ) {
+			if ( in_array( $user->ID, $nusers, true ) ) {
 				$found[] = $user->ID;
 			}
 		}
@@ -156,7 +161,7 @@ class Tests_User extends WP_UnitTestCase {
 		// for reasons unclear, the resulting array is indexed numerically; meta keys are not included anywhere.
 		// so we'll just check to make sure our values are included somewhere.
 		foreach ( $vals as $k => $v ) {
-			$this->assertTrue( isset( $out[ $k ] ) && $out[ $k ][0] == $v );
+			$this->assertTrue( isset( $out[ $k ] ) && $out[ $k ][0] === $v );
 		}
 		// delete one key and check again
 		$keys          = array_keys( $vals );
@@ -165,10 +170,10 @@ class Tests_User extends WP_UnitTestCase {
 		$out = get_user_meta( self::$author_id );
 		// make sure that key is excluded from the results
 		foreach ( $vals as $k => $v ) {
-			if ( $k == $key_to_delete ) {
+			if ( $k === $key_to_delete ) {
 				$this->assertFalse( isset( $out[ $k ] ) );
 			} else {
-				$this->assertTrue( isset( $out[ $k ] ) && $out[ $k ][0] == $v );
+				$this->assertTrue( isset( $out[ $k ] ) && $out[ $k ][0] === $v );
 			}
 		}
 	}
@@ -569,6 +574,34 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertEquals( $pwd_before, $pwd_after );
 	}
 
+	/**
+	 * @ticket 45747
+	 */
+	function test_wp_update_user_should_not_mark_user_as_spam_on_single_site() {
+		if ( is_multisite() ) {
+			$this->markTestSkipped( 'This test is intended for single site.' );
+		}
+
+		$u = wp_update_user(
+			array(
+				'ID'   => self::$contrib_id,
+				'spam' => '0',
+			)
+		);
+
+		$this->assertNotWPError( $u );
+
+		$u = wp_update_user(
+			array(
+				'ID'   => self::$contrib_id,
+				'spam' => '1',
+			)
+		);
+
+		$this->assertWPError( $u );
+		$this->assertSame( 'no_spam', $u->get_error_code() );
+	}
+
 	/**
 	 * @ticket 28315
 	 */
@@ -594,7 +627,7 @@ class Tests_User extends WP_UnitTestCase {
 			$this->assertWPError( $id2 );
 		}
 
-		@update_user_meta( $id2, 'key', 'value' );
+		update_user_meta( $id2, 'key', 'value' );
 
 		$metas = array_keys( get_user_meta( 1 ) );
 		$this->assertNotContains( 'key', $metas );
@@ -956,6 +989,21 @@ class Tests_User extends WP_UnitTestCase {
 		);
 
 		$this->assertWPError( $u );
+		$this->assertSame( 'invalid_user_id', $u->get_error_code() );
+	}
+
+	/**
+	 * @ticket 47902
+	 */
+	public function test_wp_insert_user_with_empty_data() {
+		add_filter( 'wp_pre_insert_user_data', '__return_empty_array' );
+
+		$u = self::factory()->user->create();
+
+		remove_filter( 'wp_pre_insert_user_data', '__return_empty_array' );
+
+		$this->assertWPError( $u );
+		$this->assertSame( 'empty_data', $u->get_error_code() );
 	}
 
 	/**
@@ -1017,7 +1065,7 @@ class Tests_User extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertTrue( in_array( self::$contrib_id, $users ) );
+		$this->assertTrue( in_array( (string) self::$contrib_id, $users, true ) );
 	}
 
 	public function test_search_users_url() {
@@ -1028,7 +1076,7 @@ class Tests_User extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertTrue( in_array( self::$contrib_id, $users ) );
+		$this->assertTrue( in_array( (string) self::$contrib_id, $users, true ) );
 	}
 
 	public function test_search_users_email() {
@@ -1039,7 +1087,7 @@ class Tests_User extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertTrue( in_array( self::$contrib_id, $users ) );
+		$this->assertTrue( in_array( (string) self::$contrib_id, $users, true ) );
 	}
 
 	public function test_search_users_nicename() {
@@ -1050,7 +1098,7 @@ class Tests_User extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertTrue( in_array( self::$contrib_id, $users ) );
+		$this->assertTrue( in_array( (string) self::$contrib_id, $users, true ) );
 	}
 
 	public function test_search_users_display_name() {
@@ -1061,7 +1109,7 @@ class Tests_User extends WP_UnitTestCase {
 			)
 		);
 
-		$this->assertTrue( in_array( self::$contrib_id, $users ) );
+		$this->assertTrue( in_array( (string) self::$contrib_id, $users, true ) );
 	}
 
 	/**
@@ -1196,8 +1244,8 @@ class Tests_User extends WP_UnitTestCase {
 		 * post author `blackburn@battlefield3.com` and and site admin `admin@example.org`.
 		 */
 		if ( ! empty( $GLOBALS['phpmailer']->mock_sent ) ) {
-			$was_admin_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && WP_TESTS_EMAIL == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
-			$was_user_email_sent  = ( isset( $GLOBALS['phpmailer']->mock_sent[1] ) && 'blackburn@battlefield3.com' == $GLOBALS['phpmailer']->mock_sent[1]['to'][0][0] );
+			$was_admin_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && WP_TESTS_EMAIL === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
+			$was_user_email_sent  = ( isset( $GLOBALS['phpmailer']->mock_sent[1] ) && 'blackburn@battlefield3.com' === $GLOBALS['phpmailer']->mock_sent[1]['to'][0][0] );
 		}
 
 		$this->assertTrue( $was_admin_email_sent );
@@ -1221,8 +1269,8 @@ class Tests_User extends WP_UnitTestCase {
 		 * post author `blackburn@battlefield3.com` and and site admin `admin@example.org`.
 		 */
 		if ( ! empty( $GLOBALS['phpmailer']->mock_sent ) ) {
-			$was_admin_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && WP_TESTS_EMAIL == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
-			$was_user_email_sent  = ( isset( $GLOBALS['phpmailer']->mock_sent[1] ) && 'blackburn@battlefield3.com' == $GLOBALS['phpmailer']->mock_sent[1]['to'][0][0] );
+			$was_admin_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && WP_TESTS_EMAIL === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
+			$was_user_email_sent  = ( isset( $GLOBALS['phpmailer']->mock_sent[1] ) && 'blackburn@battlefield3.com' === $GLOBALS['phpmailer']->mock_sent[1]['to'][0][0] );
 		}
 
 		$this->assertTrue( $was_admin_email_sent );
@@ -1374,7 +1422,9 @@ class Tests_User extends WP_UnitTestCase {
 	 * @ticket 35715
 	 */
 	function test_edit_user_blank_pw() {
-		$_POST                 = $_GET = $_REQUEST = array();
+		$_POST                 = array();
+		$_GET                  = array();
+		$_REQUEST              = array();
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user1@example.com';
 		$_POST['user_login']   = 'user_login1';
@@ -1390,7 +1440,8 @@ class Tests_User extends WP_UnitTestCase {
 		$this->assertEquals( 'pass', $response->get_error_code() );
 
 		// Check new user with password set.
-		$_POST['pass1'] = $_POST['pass2'] = 'password';
+		$_POST['pass1'] = 'password';
+		$_POST['pass2'] = 'password';
 
 		$user_id = edit_user();
 		$user    = get_user_by( 'ID', $user_id );
@@ -1401,7 +1452,8 @@ class Tests_User extends WP_UnitTestCase {
 
 		// Check updating user with empty password.
 		$_POST['nickname'] = 'nickname_updated';
-		$_POST['pass1']    = $_POST['pass2'] = '';
+		$_POST['pass1']    = '';
+		$_POST['pass2']    = '';
 
 		$user_id = edit_user( $user_id );
 
@@ -1456,7 +1508,7 @@ class Tests_User extends WP_UnitTestCase {
 		do_action( 'personal_options_update' );
 
 		if ( ! empty( $GLOBALS['phpmailer']->mock_sent ) ) {
-			$was_confirmation_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && 'after@example.com' == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
+			$was_confirmation_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && 'after@example.com' === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
 		}
 
 		// A confirmation email is sent.
@@ -1493,7 +1545,7 @@ class Tests_User extends WP_UnitTestCase {
 		do_action( 'personal_options_update' );
 
 		if ( ! empty( $GLOBALS['phpmailer']->mock_sent ) ) {
-			$was_confirmation_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && 'after@example.com' == $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
+			$was_confirmation_email_sent = ( isset( $GLOBALS['phpmailer']->mock_sent[0] ) && 'after@example.com' === $GLOBALS['phpmailer']->mock_sent[0]['to'][0][0] );
 		}
 
 		// No confirmation email is sent.
@@ -1550,7 +1602,9 @@ class Tests_User extends WP_UnitTestCase {
 	 * @ticket 42564
 	 */
 	function test_edit_user_role_update() {
-		$_POST = $_GET = $_REQUEST = array();
+		$_POST    = array();
+		$_GET     = array();
+		$_REQUEST = array();
 
 		$administrator = self::factory()->user->create(
 			array(
diff --git a/tests/user/capabilities.php b/tests/user/capabilities.php
index 3bc5264d52..487dcf25bf 100644
--- a/tests/user/capabilities.php
+++ b/tests/user/capabilities.php
@@ -76,77 +76,80 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 	final private function _getSingleSitePrimitiveCaps() {
 		return array(
 
-			'unfiltered_html'        => array( 'administrator', 'editor' ),
-
-			'activate_plugins'       => array( 'administrator' ),
-			'create_users'           => array( 'administrator' ),
-			'delete_plugins'         => array( 'administrator' ),
-			'delete_themes'          => array( 'administrator' ),
-			'delete_users'           => array( 'administrator' ),
-			'edit_files'             => array( 'administrator' ),
-			'edit_plugins'           => array( 'administrator' ),
-			'edit_themes'            => array( 'administrator' ),
-			'edit_users'             => array( 'administrator' ),
-			'install_plugins'        => array( 'administrator' ),
-			'install_themes'         => array( 'administrator' ),
-			'update_core'            => array( 'administrator' ),
-			'update_plugins'         => array( 'administrator' ),
-			'update_themes'          => array( 'administrator' ),
-			'edit_theme_options'     => array( 'administrator' ),
-			'export'                 => array( 'administrator' ),
-			'import'                 => array( 'administrator' ),
-			'list_users'             => array( 'administrator' ),
-			'manage_options'         => array( 'administrator' ),
-			'promote_users'          => array( 'administrator' ),
-			'remove_users'           => array( 'administrator' ),
-			'switch_themes'          => array( 'administrator' ),
-			'edit_dashboard'         => array( 'administrator' ),
-
-			'moderate_comments'      => array( 'administrator', 'editor' ),
-			'manage_categories'      => array( 'administrator', 'editor' ),
-			'edit_others_posts'      => array( 'administrator', 'editor' ),
-			'edit_pages'             => array( 'administrator', 'editor' ),
-			'edit_others_pages'      => array( 'administrator', 'editor' ),
-			'edit_published_pages'   => array( 'administrator', 'editor' ),
-			'publish_pages'          => array( 'administrator', 'editor' ),
-			'delete_pages'           => array( 'administrator', 'editor' ),
-			'delete_others_pages'    => array( 'administrator', 'editor' ),
-			'delete_published_pages' => array( 'administrator', 'editor' ),
-			'delete_others_posts'    => array( 'administrator', 'editor' ),
-			'delete_private_posts'   => array( 'administrator', 'editor' ),
-			'edit_private_posts'     => array( 'administrator', 'editor' ),
-			'read_private_posts'     => array( 'administrator', 'editor' ),
-			'delete_private_pages'   => array( 'administrator', 'editor' ),
-			'edit_private_pages'     => array( 'administrator', 'editor' ),
-			'read_private_pages'     => array( 'administrator', 'editor' ),
-
-			'edit_published_posts'   => array( 'administrator', 'editor', 'author' ),
-			'upload_files'           => array( 'administrator', 'editor', 'author' ),
-			'publish_posts'          => array( 'administrator', 'editor', 'author' ),
-			'delete_published_posts' => array( 'administrator', 'editor', 'author' ),
-
-			'edit_posts'             => array( 'administrator', 'editor', 'author', 'contributor' ),
-			'delete_posts'           => array( 'administrator', 'editor', 'author', 'contributor' ),
-
-			'read'                   => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
-
-			'level_10'               => array( 'administrator' ),
-			'level_9'                => array( 'administrator' ),
-			'level_8'                => array( 'administrator' ),
-			'level_7'                => array( 'administrator', 'editor' ),
-			'level_6'                => array( 'administrator', 'editor' ),
-			'level_5'                => array( 'administrator', 'editor' ),
-			'level_4'                => array( 'administrator', 'editor' ),
-			'level_3'                => array( 'administrator', 'editor' ),
-			'level_2'                => array( 'administrator', 'editor', 'author' ),
-			'level_1'                => array( 'administrator', 'editor', 'author', 'contributor' ),
-			'level_0'                => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
-
-			'administrator'          => array( 'administrator' ),
-			'editor'                 => array( 'editor' ),
-			'author'                 => array( 'author' ),
-			'contributor'            => array( 'contributor' ),
-			'subscriber'             => array( 'subscriber' ),
+			'unfiltered_html'         => array( 'administrator', 'editor' ),
+
+			'activate_plugins'        => array( 'administrator' ),
+			'create_users'            => array( 'administrator' ),
+			'delete_plugins'          => array( 'administrator' ),
+			'delete_themes'           => array( 'administrator' ),
+			'delete_users'            => array( 'administrator' ),
+			'edit_files'              => array( 'administrator' ),
+			'edit_plugins'            => array( 'administrator' ),
+			'edit_themes'             => array( 'administrator' ),
+			'edit_users'              => array( 'administrator' ),
+			'install_plugins'         => array( 'administrator' ),
+			'install_themes'          => array( 'administrator' ),
+			'update_core'             => array( 'administrator' ),
+			'update_plugins'          => array( 'administrator' ),
+			'update_themes'           => array( 'administrator' ),
+			'edit_theme_options'      => array( 'administrator' ),
+			'export'                  => array( 'administrator' ),
+			'import'                  => array( 'administrator' ),
+			'list_users'              => array( 'administrator' ),
+			'manage_options'          => array( 'administrator' ),
+			'promote_users'           => array( 'administrator' ),
+			'remove_users'            => array( 'administrator' ),
+			'switch_themes'           => array( 'administrator' ),
+			'edit_dashboard'          => array( 'administrator' ),
+			'resume_plugins'          => array( 'administrator' ),
+			'resume_themes'           => array( 'administrator' ),
+			'view_site_health_checks' => array( 'administrator' ),
+
+			'moderate_comments'       => array( 'administrator', 'editor' ),
+			'manage_categories'       => array( 'administrator', 'editor' ),
+			'edit_others_posts'       => array( 'administrator', 'editor' ),
+			'edit_pages'              => array( 'administrator', 'editor' ),
+			'edit_others_pages'       => array( 'administrator', 'editor' ),
+			'edit_published_pages'    => array( 'administrator', 'editor' ),
+			'publish_pages'           => array( 'administrator', 'editor' ),
+			'delete_pages'            => array( 'administrator', 'editor' ),
+			'delete_others_pages'     => array( 'administrator', 'editor' ),
+			'delete_published_pages'  => array( 'administrator', 'editor' ),
+			'delete_others_posts'     => array( 'administrator', 'editor' ),
+			'delete_private_posts'    => array( 'administrator', 'editor' ),
+			'edit_private_posts'      => array( 'administrator', 'editor' ),
+			'read_private_posts'      => array( 'administrator', 'editor' ),
+			'delete_private_pages'    => array( 'administrator', 'editor' ),
+			'edit_private_pages'      => array( 'administrator', 'editor' ),
+			'read_private_pages'      => array( 'administrator', 'editor' ),
+
+			'edit_published_posts'    => array( 'administrator', 'editor', 'author' ),
+			'upload_files'            => array( 'administrator', 'editor', 'author' ),
+			'publish_posts'           => array( 'administrator', 'editor', 'author' ),
+			'delete_published_posts'  => array( 'administrator', 'editor', 'author' ),
+
+			'edit_posts'              => array( 'administrator', 'editor', 'author', 'contributor' ),
+			'delete_posts'            => array( 'administrator', 'editor', 'author', 'contributor' ),
+
+			'read'                    => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
+
+			'level_10'                => array( 'administrator' ),
+			'level_9'                 => array( 'administrator' ),
+			'level_8'                 => array( 'administrator' ),
+			'level_7'                 => array( 'administrator', 'editor' ),
+			'level_6'                 => array( 'administrator', 'editor' ),
+			'level_5'                 => array( 'administrator', 'editor' ),
+			'level_4'                 => array( 'administrator', 'editor' ),
+			'level_3'                 => array( 'administrator', 'editor' ),
+			'level_2'                 => array( 'administrator', 'editor', 'author' ),
+			'level_1'                 => array( 'administrator', 'editor', 'author', 'contributor' ),
+			'level_0'                 => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
+
+			'administrator'           => array( 'administrator' ),
+			'editor'                  => array( 'editor' ),
+			'author'                  => array( 'author' ),
+			'contributor'             => array( 'contributor' ),
+			'subscriber'              => array( 'subscriber' ),
 
 		);
 
@@ -155,78 +158,81 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 	final private function _getMultiSitePrimitiveCaps() {
 		return array(
 
-			'unfiltered_html'        => array(),
-
-			'activate_plugins'       => array(),
-			'create_users'           => array(),
-			'delete_plugins'         => array(),
-			'delete_themes'          => array(),
-			'delete_users'           => array(),
-			'edit_files'             => array(),
-			'edit_plugins'           => array(),
-			'edit_themes'            => array(),
-			'edit_users'             => array(),
-			'install_plugins'        => array(),
-			'install_themes'         => array(),
-			'update_core'            => array(),
-			'update_plugins'         => array(),
-			'update_themes'          => array(),
-
-			'edit_theme_options'     => array( 'administrator' ),
-			'export'                 => array( 'administrator' ),
-			'import'                 => array( 'administrator' ),
-			'list_users'             => array( 'administrator' ),
-			'manage_options'         => array( 'administrator' ),
-			'promote_users'          => array( 'administrator' ),
-			'remove_users'           => array( 'administrator' ),
-			'switch_themes'          => array( 'administrator' ),
-			'edit_dashboard'         => array( 'administrator' ),
-
-			'moderate_comments'      => array( 'administrator', 'editor' ),
-			'manage_categories'      => array( 'administrator', 'editor' ),
-			'edit_others_posts'      => array( 'administrator', 'editor' ),
-			'edit_pages'             => array( 'administrator', 'editor' ),
-			'edit_others_pages'      => array( 'administrator', 'editor' ),
-			'edit_published_pages'   => array( 'administrator', 'editor' ),
-			'publish_pages'          => array( 'administrator', 'editor' ),
-			'delete_pages'           => array( 'administrator', 'editor' ),
-			'delete_others_pages'    => array( 'administrator', 'editor' ),
-			'delete_published_pages' => array( 'administrator', 'editor' ),
-			'delete_others_posts'    => array( 'administrator', 'editor' ),
-			'delete_private_posts'   => array( 'administrator', 'editor' ),
-			'edit_private_posts'     => array( 'administrator', 'editor' ),
-			'read_private_posts'     => array( 'administrator', 'editor' ),
-			'delete_private_pages'   => array( 'administrator', 'editor' ),
-			'edit_private_pages'     => array( 'administrator', 'editor' ),
-			'read_private_pages'     => array( 'administrator', 'editor' ),
-
-			'edit_published_posts'   => array( 'administrator', 'editor', 'author' ),
-			'upload_files'           => array( 'administrator', 'editor', 'author' ),
-			'publish_posts'          => array( 'administrator', 'editor', 'author' ),
-			'delete_published_posts' => array( 'administrator', 'editor', 'author' ),
-
-			'edit_posts'             => array( 'administrator', 'editor', 'author', 'contributor' ),
-			'delete_posts'           => array( 'administrator', 'editor', 'author', 'contributor' ),
-
-			'read'                   => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
-
-			'level_10'               => array( 'administrator' ),
-			'level_9'                => array( 'administrator' ),
-			'level_8'                => array( 'administrator' ),
-			'level_7'                => array( 'administrator', 'editor' ),
-			'level_6'                => array( 'administrator', 'editor' ),
-			'level_5'                => array( 'administrator', 'editor' ),
-			'level_4'                => array( 'administrator', 'editor' ),
-			'level_3'                => array( 'administrator', 'editor' ),
-			'level_2'                => array( 'administrator', 'editor', 'author' ),
-			'level_1'                => array( 'administrator', 'editor', 'author', 'contributor' ),
-			'level_0'                => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
-
-			'administrator'          => array( 'administrator' ),
-			'editor'                 => array( 'editor' ),
-			'author'                 => array( 'author' ),
-			'contributor'            => array( 'contributor' ),
-			'subscriber'             => array( 'subscriber' ),
+			'unfiltered_html'         => array(),
+
+			'activate_plugins'        => array(),
+			'create_users'            => array(),
+			'delete_plugins'          => array(),
+			'delete_themes'           => array(),
+			'delete_users'            => array(),
+			'edit_files'              => array(),
+			'edit_plugins'            => array(),
+			'edit_themes'             => array(),
+			'edit_users'              => array(),
+			'install_plugins'         => array(),
+			'install_themes'          => array(),
+			'update_core'             => array(),
+			'update_plugins'          => array(),
+			'update_themes'           => array(),
+			'view_site_health_checks' => array(),
+
+			'edit_theme_options'      => array( 'administrator' ),
+			'export'                  => array( 'administrator' ),
+			'import'                  => array( 'administrator' ),
+			'list_users'              => array( 'administrator' ),
+			'manage_options'          => array( 'administrator' ),
+			'promote_users'           => array( 'administrator' ),
+			'remove_users'            => array( 'administrator' ),
+			'switch_themes'           => array( 'administrator' ),
+			'edit_dashboard'          => array( 'administrator' ),
+			'resume_plugins'          => array( 'administrator' ),
+			'resume_themes'           => array( 'administrator' ),
+
+			'moderate_comments'       => array( 'administrator', 'editor' ),
+			'manage_categories'       => array( 'administrator', 'editor' ),
+			'edit_others_posts'       => array( 'administrator', 'editor' ),
+			'edit_pages'              => array( 'administrator', 'editor' ),
+			'edit_others_pages'       => array( 'administrator', 'editor' ),
+			'edit_published_pages'    => array( 'administrator', 'editor' ),
+			'publish_pages'           => array( 'administrator', 'editor' ),
+			'delete_pages'            => array( 'administrator', 'editor' ),
+			'delete_others_pages'     => array( 'administrator', 'editor' ),
+			'delete_published_pages'  => array( 'administrator', 'editor' ),
+			'delete_others_posts'     => array( 'administrator', 'editor' ),
+			'delete_private_posts'    => array( 'administrator', 'editor' ),
+			'edit_private_posts'      => array( 'administrator', 'editor' ),
+			'read_private_posts'      => array( 'administrator', 'editor' ),
+			'delete_private_pages'    => array( 'administrator', 'editor' ),
+			'edit_private_pages'      => array( 'administrator', 'editor' ),
+			'read_private_pages'      => array( 'administrator', 'editor' ),
+
+			'edit_published_posts'    => array( 'administrator', 'editor', 'author' ),
+			'upload_files'            => array( 'administrator', 'editor', 'author' ),
+			'publish_posts'           => array( 'administrator', 'editor', 'author' ),
+			'delete_published_posts'  => array( 'administrator', 'editor', 'author' ),
+
+			'edit_posts'              => array( 'administrator', 'editor', 'author', 'contributor' ),
+			'delete_posts'            => array( 'administrator', 'editor', 'author', 'contributor' ),
+
+			'read'                    => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
+
+			'level_10'                => array( 'administrator' ),
+			'level_9'                 => array( 'administrator' ),
+			'level_8'                 => array( 'administrator' ),
+			'level_7'                 => array( 'administrator', 'editor' ),
+			'level_6'                 => array( 'administrator', 'editor' ),
+			'level_5'                 => array( 'administrator', 'editor' ),
+			'level_4'                 => array( 'administrator', 'editor' ),
+			'level_3'                 => array( 'administrator', 'editor' ),
+			'level_2'                 => array( 'administrator', 'editor', 'author' ),
+			'level_1'                 => array( 'administrator', 'editor', 'author', 'contributor' ),
+			'level_0'                 => array( 'administrator', 'editor', 'author', 'contributor', 'subscriber' ),
+
+			'administrator'           => array( 'administrator' ),
+			'editor'                  => array( 'editor' ),
+			'author'                  => array( 'author' ),
+			'contributor'             => array( 'contributor' ),
+			'subscriber'              => array( 'subscriber' ),
 
 		);
 
@@ -392,7 +398,11 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 			$actual['editor'],
 			$actual['author'],
 			$actual['subscriber'],
-			$actual['contributor']
+			$actual['contributor'],
+			// The following are granted via `user_has_cap`:
+			$actual['resume_plugins'],
+			$actual['resume_themes'],
+			$actual['view_site_health_checks']
 		);
 
 		unset(
@@ -454,6 +464,8 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 			// Singular object meta capabilities (where an object ID is passed) are not tested:
 			$expected['activate_plugin'],
 			$expected['deactivate_plugin'],
+			$expected['resume_plugin'],
+			$expected['resume_theme'],
 			$expected['remove_user'],
 			$expected['promote_user'],
 			$expected['edit_user'],
@@ -1191,7 +1203,7 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$this->assertFalse( $contributor->has_cap( 'publish_post', $post ) );
 		$this->assertFalse( $contributor->has_cap( 'edit_post', $post ) );
 		$this->assertFalse( $contributor->has_cap( 'delete_post', $post ) );
-		$this->assertEquals( $status === 'publish', $contributor->has_cap( 'read_post', $post ) );
+		$this->assertEquals( 'publish' === $status, $contributor->has_cap( 'read_post', $post ) );
 	}
 
 	/**
@@ -1534,7 +1546,7 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 	function _nullify_current_user() {
 		// Prevents fatal errors in ::tearDown()'s and other uses of restore_current_blog()
 		$function_stack = wp_debug_backtrace_summary( null, 0, false );
-		if ( in_array( 'restore_current_blog', $function_stack ) ) {
+		if ( in_array( 'restore_current_blog', $function_stack, true ) ) {
 			return;
 		}
 		$GLOBALS['current_user'] = null;
@@ -1738,7 +1750,6 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 	 * @ticket 17253
 	 */
 	function test_cpt_with_page_capability_type() {
-
 		register_post_type(
 			'page_capability',
 			array(
@@ -1787,8 +1798,7 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 
 	}
 
-	public function testNonLoggedInUsersHaveNoCapabilities() {
-
+	public function test_non_logged_in_users_have_no_capabilities() {
 		$this->assertFalse( is_user_logged_in() );
 
 		$caps = $this->getAllCapsAndRoles();
@@ -1805,6 +1815,20 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$this->assertFalse( current_user_can( 'do_not_allow' ), 'Non-logged-in user should not have the do_not_allow capability' );
 	}
 
+	/**
+	 * @ticket 35488
+	 */
+	function test_wp_logout_should_clear_current_user() {
+		$user_id = self::factory()->user->create();
+		wp_set_current_user( $user_id );
+
+		wp_logout();
+
+		$this->assertEquals( 0, get_current_user_id() );
+
+	}
+
+
 	protected $_role_test_wp_roles_role;
 	/**
 	 * @ticket 23016
diff --git a/tests/user/listAuthors.php b/tests/user/listAuthors.php
index 8dcfad8935..ccaa733551 100644
--- a/tests/user/listAuthors.php
+++ b/tests/user/listAuthors.php
@@ -75,12 +75,20 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_default() {
-		$expected['default'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+		$expected['default'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+
 		$this->AssertEquals( $expected['default'], wp_list_authors( array( 'echo' => false ) ) );
 	}
 
 	function test_wp_list_authors_orderby() {
-		$expected['post_count'] = '<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li><li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>';
+		$expected['post_count'] =
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>' .
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>';
+
 		$this->AssertEquals(
 			$expected['post_count'],
 			wp_list_authors(
@@ -93,7 +101,11 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_order() {
-		$expected['id'] = '<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li><li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+		$expected['id'] =
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>' .
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+
 		$this->AssertEquals(
 			$expected['id'],
 			wp_list_authors(
@@ -107,7 +119,11 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_optioncount() {
-		$expected['optioncount'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> (2)</li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> (3)</li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> (1)</li>';
+		$expected['optioncount'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> (2)</li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> (3)</li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> (1)</li>';
+
 		$this->AssertEquals(
 			$expected['optioncount'],
 			wp_list_authors(
@@ -126,7 +142,13 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 				'post_author' => 1,
 			)
 		);
-		$expected['exclude_admin'] = '<li><a href="' . get_author_posts_url( 1 ) . '" title="Posts by admin">admin</a></li><li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+
+		$expected['exclude_admin'] =
+			'<li><a href="' . get_author_posts_url( 1 ) . '" title="Posts by admin">admin</a></li>' .
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+
 		$this->AssertEquals(
 			$expected['exclude_admin'],
 			wp_list_authors(
@@ -139,7 +161,11 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_show_fullname() {
-		$expected['show_fullname'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob reno</a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul norris</a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack moon</a></li>';
+		$expected['show_fullname'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob reno</a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul norris</a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack moon</a></li>';
+
 		$this->AssertEquals(
 			$expected['show_fullname'],
 			wp_list_authors(
@@ -152,8 +178,14 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_hide_empty() {
-		$fred_id                = self::$fred_id;
-		$expected['hide_empty'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li><li><a href="' . get_author_posts_url( $fred_id ) . '" title="Posts by fred">fred</a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+		$fred_id = self::$fred_id;
+
+		$expected['hide_empty'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li>' .
+			'<li><a href="' . get_author_posts_url( $fred_id ) . '" title="Posts by fred">fred</a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+
 		$this->AssertEquals(
 			$expected['hide_empty'],
 			wp_list_authors(
@@ -166,16 +198,25 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_echo() {
-		$expected['echo'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+		$expected['echo'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a></li>';
+
 		$this->expectOutputString( $expected['echo'] );
 		wp_list_authors( array( 'echo' => true ) );
 	}
 
 	function test_wp_list_authors_feed() {
-		$url0             = get_author_feed_link( self::$user_ids[0] );
-		$url1             = get_author_feed_link( self::$user_ids[1] );
-		$url2             = get_author_feed_link( self::$user_ids[2] );
-		$expected['feed'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> (<a href="' . $url1 . '">link to feed</a>)</li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> (<a href="' . $url2 . '">link to feed</a>)</li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> (<a href="' . $url0 . '">link to feed</a>)</li>';
+		$url0 = get_author_feed_link( self::$user_ids[0] );
+		$url1 = get_author_feed_link( self::$user_ids[1] );
+		$url2 = get_author_feed_link( self::$user_ids[2] );
+
+		$expected['feed'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> (<a href="' . $url1 . '">link to feed</a>)</li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> (<a href="' . $url2 . '">link to feed</a>)</li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> (<a href="' . $url0 . '">link to feed</a>)</li>';
+
 		$this->AssertEquals(
 			$expected['feed'],
 			wp_list_authors(
@@ -188,10 +229,15 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_feed_image() {
-		$url0                   = get_author_feed_link( self::$user_ids[0] );
-		$url1                   = get_author_feed_link( self::$user_ids[1] );
-		$url2                   = get_author_feed_link( self::$user_ids[2] );
-		$expected['feed_image'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> <a href="' . $url1 . '"><img src="http://' . WP_TESTS_DOMAIN . '/path/to/a/graphic.png" style="border: none;" /></a></li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> <a href="' . $url2 . '"><img src="http://' . WP_TESTS_DOMAIN . '/path/to/a/graphic.png" style="border: none;" /></a></li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> <a href="' . $url0 . '"><img src="http://' . WP_TESTS_DOMAIN . '/path/to/a/graphic.png" style="border: none;" /></a></li>';
+		$url0 = get_author_feed_link( self::$user_ids[0] );
+		$url1 = get_author_feed_link( self::$user_ids[1] );
+		$url2 = get_author_feed_link( self::$user_ids[2] );
+
+		$expected['feed_image'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> <a href="' . $url1 . '"><img src="http://' . WP_TESTS_DOMAIN . '/path/to/a/graphic.png" style="border: none;" /></a></li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> <a href="' . $url2 . '"><img src="http://' . WP_TESTS_DOMAIN . '/path/to/a/graphic.png" style="border: none;" /></a></li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> <a href="' . $url0 . '"><img src="http://' . WP_TESTS_DOMAIN . '/path/to/a/graphic.png" style="border: none;" /></a></li>';
+
 		$this->AssertEquals(
 			$expected['feed_image'],
 			wp_list_authors(
@@ -207,10 +253,15 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	 * @ticket 26538
 	 */
 	function test_wp_list_authors_feed_type() {
-		$url0                  = get_author_feed_link( self::$user_ids[0], 'atom' );
-		$url1                  = get_author_feed_link( self::$user_ids[1], 'atom' );
-		$url2                  = get_author_feed_link( self::$user_ids[2], 'atom' );
-		$expected['feed_type'] = '<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> (<a href="' . $url1 . '">link to feed</a>)</li><li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> (<a href="' . $url2 . '">link to feed</a>)</li><li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> (<a href="' . $url0 . '">link to feed</a>)</li>';
+		$url0 = get_author_feed_link( self::$user_ids[0], 'atom' );
+		$url1 = get_author_feed_link( self::$user_ids[1], 'atom' );
+		$url2 = get_author_feed_link( self::$user_ids[2], 'atom' );
+
+		$expected['feed_type'] =
+			'<li><a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a> (<a href="' . $url1 . '">link to feed</a>)</li>' .
+			'<li><a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a> (<a href="' . $url2 . '">link to feed</a>)</li>' .
+			'<li><a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a> (<a href="' . $url0 . '">link to feed</a>)</li>';
+
 		$this->AssertEquals(
 			$expected['feed_type'],
 			wp_list_authors(
@@ -224,7 +275,11 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 	}
 
 	function test_wp_list_authors_style() {
-		$expected['style'] = '<a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a>, <a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a>, <a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a>';
+		$expected['style'] =
+			'<a href="' . self::$user_urls[1] . '" title="Posts by bob">bob</a>, ' .
+			'<a href="' . self::$user_urls[2] . '" title="Posts by paul">paul</a>, ' .
+			'<a href="' . self::$user_urls[0] . '" title="Posts by zack">zack</a>';
+
 		$this->AssertEquals(
 			$expected['style'],
 			wp_list_authors(
@@ -238,6 +293,7 @@ class Tests_User_ListAuthors extends WP_UnitTestCase {
 
 	function test_wp_list_authors_html() {
 		$expected['html'] = 'bob, paul, zack';
+
 		$this->AssertEquals(
 			$expected['html'],
 			wp_list_authors(
diff --git a/tests/user/multisite.php b/tests/user/multisite.php
index 6cb8df74da..01c7b7d096 100644
--- a/tests/user/multisite.php
+++ b/tests/user/multisite.php
@@ -212,7 +212,12 @@ if ( is_multisite() ) :
 					'user_login' => $spam_username,
 				)
 			);
-			update_user_status( $spam_user_id, 'spam', '1' );
+			wp_update_user(
+				array(
+					'ID'   => $spam_user_id,
+					'spam' => '1',
+				)
+			);
 
 			$this->assertTrue( is_user_spammy( $spam_username ) );
 			$this->assertFalse( is_user_spammy( 'testuser1' ) );
diff --git a/tests/user/query.php b/tests/user/query.php
index 1330d8b5c9..c094360ebc 100644
--- a/tests/user/query.php
+++ b/tests/user/query.php
@@ -53,7 +53,9 @@ class Tests_User_Query extends WP_UnitTestCase {
 		$users = new WP_User_Query();
 
 		$this->assertEquals( '', $users->get( 'fields' ) );
-		$this->assertEquals( '', @$users->query_vars['fields'] );
+		if ( isset( $users->query_vars['fields'] ) ) {
+			$this->assertEquals( '', $users->query_vars['fields'] );
+		}
 
 		$users->set( 'fields', 'all' );
 
@@ -1136,11 +1138,11 @@ class Tests_User_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$foundCount    = count( $q->get_results() );
-		$expectedCount = 10; // 13 total users minus 3 from query
+		$found_count    = count( $q->get_results() );
+		$expected_count = 10; // 13 total users minus 3 from query
 
 		$this->assertContains( "AND user_nicename NOT IN ( 'peter','paul','mary' )", $q->query_where );
-		$this->assertEquals( $expectedCount, $foundCount );
+		$this->assertEquals( $expected_count, $found_count );
 	}
 
 	/**
@@ -1237,11 +1239,11 @@ class Tests_User_Query extends WP_UnitTestCase {
 			)
 		);
 
-		$foundCount    = count( $q->get_results() );
-		$expectedCount = 10; // 13 total users minus 3 from query
+		$found_count    = count( $q->get_results() );
+		$expected_count = 10; // 13 total users minus 3 from query
 
 		$this->assertContains( "AND user_login NOT IN ( '$user_login1','$user_login2','$user_login3' )", $q->query_where );
-		$this->assertEquals( $expectedCount, $foundCount );
+		$this->assertEquals( $expected_count, $found_count );
 	}
 
 	/**
diff --git a/tests/user/slashes.php b/tests/user/slashes.php
index b15d9436b1..202d6a1622 100644
--- a/tests/user/slashes.php
+++ b/tests/user/slashes.php
@@ -27,7 +27,9 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 	 * Tests the controller function that expects slashed data
 	 */
 	function test_add_user() {
-		$_POST                 = $_GET = $_REQUEST = array();
+		$_POST                 = array();
+		$_GET                  = array();
+		$_REQUEST              = array();
 		$_POST['user_login']   = 'slash_example_user_1';
 		$_POST['pass1']        = 'password';
 		$_POST['pass2']        = 'password';
@@ -49,7 +51,9 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		$this->assertEquals( $this->slash_7, $user->display_name );
 		$this->assertEquals( $this->slash_3, $user->description );
 
-		$_POST                 = $_GET = $_REQUEST = array();
+		$_POST                 = array();
+		$_GET                  = array();
+		$_REQUEST              = array();
 		$_POST['user_login']   = 'slash_example_user_2';
 		$_POST['pass1']        = 'password';
 		$_POST['pass2']        = 'password';
@@ -78,7 +82,9 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 	function test_edit_user() {
 		$id = self::factory()->user->create();
 
-		$_POST                 = $_GET = $_REQUEST = array();
+		$_POST                 = array();
+		$_GET                  = array();
+		$_REQUEST              = array();
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user1@example.com';
 		$_POST['first_name']   = $this->slash_1;
@@ -97,7 +103,9 @@ class Tests_User_Slashes extends WP_UnitTestCase {
 		$this->assertEquals( $this->slash_7, $user->display_name );
 		$this->assertEquals( $this->slash_3, $user->description );
 
-		$_POST                 = $_GET = $_REQUEST = array();
+		$_POST                 = array();
+		$_GET                  = array();
+		$_REQUEST              = array();
 		$_POST['role']         = 'subscriber';
 		$_POST['email']        = 'user2@example.com';
 		$_POST['first_name']   = $this->slash_2;
diff --git a/tests/user/wpAuthenticateSpamCheck.php b/tests/user/wpAuthenticateSpamCheck.php
index 8ff969949a..8cf2fd4abd 100644
--- a/tests/user/wpAuthenticateSpamCheck.php
+++ b/tests/user/wpAuthenticateSpamCheck.php
@@ -34,7 +34,13 @@ class Tests_User_WpAuthenticateSpamCheck extends WP_UnitTestCase {
 	 */
 	function test_wp_authenticate_spam_check_returns_wp_error_when_flagged() {
 		$user_id = self::factory()->user->create( array( 'role' => 'contributor' ) );
-		update_user_status( $user_id, 'spam', 1 );
+		wp_update_user(
+			array(
+				'ID'   => $user_id,
+				'spam' => '1',
+			)
+		);
+
 		$user        = new WP_User( $user_id );
 		$actual_user = wp_authenticate_spam_check( $user );
 		wpmu_delete_user( $user_id );
diff --git a/tests/user/wpSetCurrentUser.php b/tests/user/wpSetCurrentUser.php
index 4871ffe5fc..ec720b814e 100644
--- a/tests/user/wpSetCurrentUser.php
+++ b/tests/user/wpSetCurrentUser.php
@@ -9,8 +9,10 @@ class Tests_User_WpSetCurrentUser extends WP_UnitTestCase {
 	protected static $user_ids = array();
 
 	public static function wpSetUpBeforeClass( $factory ) {
-		self::$user_ids[] = self::$user_id = $factory->user->create();
-		self::$user_ids[] = self::$user_id2 = $factory->user->create( array( 'user_login' => 'foo' ) );
+		self::$user_id    = $factory->user->create();
+		self::$user_ids[] = self::$user_id;
+		self::$user_id2   = $factory->user->create( array( 'user_login' => 'foo' ) );
+		self::$user_ids[] = self::$user_id2;
 	}
 
 	public function test_set_by_id() {
diff --git a/tests/walker.php b/tests/walker.php
index 8c96f63395..0cb2ad232c 100644
--- a/tests/walker.php
+++ b/tests/walker.php
@@ -2,7 +2,7 @@
 
 /**
  * @group post
- * @group navmenus
+ * @group menu
  * @group taxonomy
  * @group walker
  */
diff --git a/tests/widgets.php b/tests/widgets.php
index d2160f786f..9d5f547dc6 100644
--- a/tests/widgets.php
+++ b/tests/widgets.php
@@ -150,7 +150,7 @@ class Tests_Widgets extends WP_UnitTestCase {
 
 		$names = wp_list_pluck( $wp_registered_sidebars, 'name' );
 		for ( $i = 1; $i <= $num; $i++ ) {
-			if ( in_array( "$id_base $i", $names ) ) {
+			if ( in_array( "$id_base $i", $names, true ) ) {
 				$result[] = true;
 			}
 		}
@@ -620,21 +620,20 @@ class Tests_Widgets extends WP_UnitTestCase {
 
 		wp_widgets_init();
 		require_once ABSPATH . '/wp-admin/includes/widgets.php';
-		$widget_id = 'search-2';
-		$widget    = $wp_registered_widgets[ $widget_id ];
-		$params    = array(
+		$widget_id    = 'search-2';
+		$widget       = $wp_registered_widgets[ $widget_id ];
+		$params       = array(
 			'widget_id'   => $widget['id'],
 			'widget_name' => $widget['name'],
 		);
-		$args      = wp_list_widget_controls_dynamic_sidebar(
-			array(
-				0 => $params,
-				1 => $widget['params'][0],
-			)
+		$control_args = array(
+			0 => $params,
+			1 => $widget['params'][0],
 		);
+		$sidebar_args = wp_list_widget_controls_dynamic_sidebar( $control_args );
 
 		ob_start();
-		call_user_func_array( 'wp_widget_control', $args );
+		wp_widget_control( ...$sidebar_args );
 		$control = ob_get_clean();
 		$this->assertNotEmpty( $control );
 
@@ -659,15 +658,14 @@ class Tests_Widgets extends WP_UnitTestCase {
 			'after_widget_content'  => '<!-- after_widget_content -->',
 		);
 		$params          = array_merge( $params, $param_overrides );
-		$args            = wp_list_widget_controls_dynamic_sidebar(
-			array(
-				0 => $params,
-				1 => $widget['params'][0],
-			)
+		$control_args    = array(
+			0 => $params,
+			1 => $widget['params'][0],
 		);
+		$sidebar_args    = wp_list_widget_controls_dynamic_sidebar( $control_args );
 
 		ob_start();
-		call_user_func_array( 'wp_widget_control', $args );
+		wp_widget_control( ...$sidebar_args );
 		$control = ob_get_clean();
 		$this->assertNotEmpty( $control );
 		$this->assertNotContains( '<form method="post">', $control );
@@ -712,6 +710,22 @@ class Tests_Widgets extends WP_UnitTestCase {
 		the_widget( 'Widget_Class' );
 	}
 
+	/**
+	 * @ticket 34226
+	 */
+	public function test_the_widget_should_short_circuit_with_widget_display_callback() {
+		add_filter( 'widget_display_callback', '__return_false' );
+
+		register_widget( 'WP_Widget_Text' );
+
+		ob_start();
+		the_widget( 'WP_Widget_Text' );
+		$widget_content = ob_get_clean();
+		unregister_widget( 'WP_Widget_Text' );
+
+		$this->assertEmpty( $widget_content );
+	}
+
 	/**
 	 * Register nav menu sidebars.
 	 *
diff --git a/tests/widgets/custom-html-widget.php b/tests/widgets/custom-html-widget.php
index 91860d9062..3a31a7d9a5 100644
--- a/tests/widgets/custom-html-widget.php
+++ b/tests/widgets/custom-html-widget.php
@@ -302,4 +302,57 @@ class Test_WP_Widget_Custom_HTML extends WP_UnitTestCase {
 
 		$this->assertContains( 'Use the Custom HTML widget to add arbitrary HTML code to your widget areas.', $help_tab['content'] );
 	}
+
+	/**
+	 * Ensure that rel="noopener noreferrer" is added to links with a target.
+	 *
+	 * @ticket 46421
+	 */
+	function test_render_links_with_target() {
+		$widget = new WP_Widget_Custom_HTML();
+
+		$content = 'Test content with an external <a href="https://example.org" target="_blank">link</a>.';
+
+		$args = array(
+			'before_title'  => '<h2>',
+			'after_title'   => '</h2>',
+			'before_widget' => '',
+			'after_widget'  => '',
+		);
+
+		$instance = array(
+			'title'   => 'Foo',
+			'content' => $content,
+		);
+
+		$output = get_echo( array( $widget, 'widget' ), array( $args, $instance ) );
+		$this->assertContains( 'rel="noopener noreferrer"', $output );
+	}
+
+	/**
+	 * Ensure that rel="noopener noreferrer" is not added to links without a target.
+	 *
+	 * @ticket 46421
+	 */
+	function test_render_links_without_target() {
+		$widget = new WP_Widget_Custom_HTML();
+
+		$content = 'Test content with an internal <a href="/">link</a>.';
+
+		$args = array(
+			'before_title'  => '<h2>',
+			'after_title'   => '</h2>',
+			'before_widget' => '',
+			'after_widget'  => '',
+		);
+
+		$instance = array(
+			'title'   => 'Foo',
+			'content' => $content,
+		);
+
+		$output = get_echo( array( $widget, 'widget' ), array( $args, $instance ) );
+		$this->assertNotContains( 'rel="noopener noreferrer"', $output );
+	}
+
 }
diff --git a/tests/widgets/media-audio-widget.php b/tests/widgets/media-audio-widget.php
index b8ceff3875..aceba85711 100644
--- a/tests/widgets/media-audio-widget.php
+++ b/tests/widgets/media-audio-widget.php
@@ -50,6 +50,38 @@ class Test_WP_Widget_Media_Audio extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Test get_instance_schema filtering.
+	 *
+	 * @covers WP_Widget_Media_Audio::get_instance_schema
+	 *
+	 * @ticket 45029
+	 */
+	function test_get_instance_schema_filtering() {
+		$wp_widget_audio = new WP_Widget_Media_Audio();
+		$schema          = $wp_widget_audio->get_instance_schema();
+
+		add_filter( 'widget_media_audio_instance_schema', array( $this, 'filter_instance_schema' ), 10, 2 );
+		$schema = $wp_widget_audio->get_instance_schema();
+
+		$this->assertTrue( $schema['loop']['default'] );
+	}
+
+	/**
+	 * Filters instance schema.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array                 $schema Schema.
+	 * @param WP_Widget_Media_Audio $widget Widget.
+	 * @return array
+	 */
+	public function filter_instance_schema( $schema, $widget ) {
+		// Override the default loop value (false).
+		$schema['loop']['default'] = true;
+		return $schema;
+	}
+
 	/**
 	 * Test constructor.
 	 *
diff --git a/tests/widgets/media-image-widget.php b/tests/widgets/media-image-widget.php
index e138f3e796..aa4e65f267 100644
--- a/tests/widgets/media-image-widget.php
+++ b/tests/widgets/media-image-widget.php
@@ -57,6 +57,38 @@ class Test_WP_Widget_Media_Image extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Test schema filtering.
+	 *
+	 * @covers WP_Widget_Media_Image::get_instance_schema
+	 *
+	 * @ticket 45029
+	 */
+	function test_get_instance_schema_filtering() {
+		$widget = new WP_Widget_Media_Image();
+		$schema = $widget->get_instance_schema();
+
+		add_filter( 'widget_media_image_instance_schema', array( $this, 'filter_instance_schema' ), 10, 2 );
+		$schema = $widget->get_instance_schema();
+
+		$this->assertSame( 'large', $schema['size']['default'] );
+	}
+
+	/**
+	 * Filters instance schema.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array                 $schema Schema.
+	 * @param WP_Widget_Media_Image $widget Widget.
+	 * @return array
+	 */
+	public function filter_instance_schema( $schema, $widget ) {
+		// Override the default size value ('medium').
+		$schema['size']['default'] = 'large';
+		return $schema;
+	}
+
 	/**
 	 * Test constructor.
 	 *
@@ -509,6 +541,7 @@ class Test_WP_Widget_Media_Image extends WP_UnitTestCase {
 
 		$this->assertContains( '<a href="https://example.org"', $output );
 		$this->assertContains( 'target="_blank"', $output );
+		$this->assertContains( 'rel="noopener noreferrer"', $output );
 
 		// Populate caption in attachment.
 		wp_update_post(
diff --git a/tests/widgets/media-video-widget.php b/tests/widgets/media-video-widget.php
index e63673d7db..fa37e44c7b 100644
--- a/tests/widgets/media-video-widget.php
+++ b/tests/widgets/media-video-widget.php
@@ -51,6 +51,38 @@ class Test_WP_Widget_Media_Video extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Test schema filtering.
+	 *
+	 * @covers WP_Widget_Media_Video::get_instance_schema
+	 *
+	 * @ticket 45029
+	 */
+	function test_get_instance_schema_filtering() {
+		$widget = new WP_Widget_Media_Video();
+		$schema = $widget->get_instance_schema();
+
+		add_filter( 'widget_media_video_instance_schema', array( $this, 'filter_instance_schema' ), 10, 2 );
+		$schema = $widget->get_instance_schema();
+
+		$this->assertTrue( $schema['loop']['default'] );
+	}
+
+	/**
+	 * Filters instance schema.
+	 *
+	 * @since 5.2.0
+	 *
+	 * @param array                 $schema Schema.
+	 * @param WP_Widget_Media_Video $widget Widget.
+	 * @return array
+	 */
+	public function filter_instance_schema( $schema, $widget ) {
+		// Override the default loop value (false).
+		$schema['loop']['default'] = true;
+		return $schema;
+	}
+
 	/**
 	 * Test constructor.
 	 *
diff --git a/tests/widgets/media-widget.php b/tests/widgets/media-widget.php
index 4a828cdbc4..6b9dc926ce 100644
--- a/tests/widgets/media-widget.php
+++ b/tests/widgets/media-widget.php
@@ -187,7 +187,6 @@ class Test_WP_Widget_Media extends WP_UnitTestCase {
 	 *
 	 * @param array           $schema Schema.
 	 * @param WP_Widget_Media $widget Widget.
-	 *
 	 * @return array
 	 */
 	public function filter_instance_schema( $schema, $widget ) {
@@ -480,11 +479,6 @@ class Test_WP_Widget_Media extends WP_UnitTestCase {
 	 * @covers WP_Widget_Media::has_content()
 	 */
 	function test_has_content() {
-		if ( version_compare( PHP_VERSION, '5.3', '<' ) ) {
-			$this->markTestSkipped( 'ReflectionMethod::setAccessible is only available for PHP 5.3+' );
-			return;
-		}
-
 		$attachment_id = self::factory()->attachment->create_object(
 			array(
 				'file'           => DIR_TESTDATA . '/images/canola.jpg',
diff --git a/tests/widgets/text-widget.php b/tests/widgets/text-widget.php
index 64146a44a3..eeb37c7ce3 100644
--- a/tests/widgets/text-widget.php
+++ b/tests/widgets/text-widget.php
@@ -1001,4 +1001,58 @@ class Test_WP_Widget_Text extends WP_UnitTestCase {
 
 		$this->assertContains( '<script type="text/html" id="tmpl-widget-text-control-fields">', $output );
 	}
+
+	/**
+	 * Ensure that rel="noopener noreferrer" is added to links with a target.
+	 *
+	 * @ticket 46421
+	 */
+	function test_render_links_with_target() {
+		$widget = new WP_Widget_Text();
+
+		$text = 'Test content with an external <a href="https://example.org" target="_blank">link</a>.';
+
+		$args = array(
+			'before_title'  => '<h2>',
+			'after_title'   => '</h2>',
+			'before_widget' => '',
+			'after_widget'  => '',
+		);
+
+		$instance = array(
+			'title' => 'Foo',
+			'text'  => $text,
+		);
+
+		$output = get_echo( array( $widget, 'widget' ), array( $args, $instance ) );
+
+		$this->assertContains( 'rel="noopener noreferrer"', $output );
+	}
+
+	/**
+	 * Ensure that rel="noopener noreferrer" is not added to links without a target.
+	 *
+	 * @ticket 46421
+	 */
+	function test_render_links_without_target() {
+		$widget = new WP_Widget_Text();
+
+		$text = 'Test content with an internal <a href="/">link</a>.';
+
+		$args = array(
+			'before_title'  => '<h2>',
+			'after_title'   => '</h2>',
+			'before_widget' => '',
+			'after_widget'  => '',
+		);
+
+		$instance = array(
+			'title' => 'Foo',
+			'text'  => $text,
+		);
+
+		$output = get_echo( array( $widget, 'widget' ), array( $args, $instance ) );
+
+		$this->assertNotContains( 'rel="noopener noreferrer"', $output );
+	}
 }
diff --git a/tests/wp.php b/tests/wp.php
index 218c087c05..cdb3f79525 100644
--- a/tests/wp.php
+++ b/tests/wp.php
@@ -22,15 +22,15 @@ class Tests_WP extends WP_UnitTestCase {
 		$this->wp->add_query_var( 'test' );
 
 		$this->assertSame( $public_qv_count + 2, count( $this->wp->public_query_vars ) );
-		$this->assertTrue( in_array( 'test', $this->wp->public_query_vars ) );
-		$this->assertTrue( in_array( 'test2', $this->wp->public_query_vars ) );
+		$this->assertTrue( in_array( 'test', $this->wp->public_query_vars, true ) );
+		$this->assertTrue( in_array( 'test2', $this->wp->public_query_vars, true ) );
 	}
 
 	public function test_remove_query_var() {
 		$public_qv_count = count( $this->wp->public_query_vars );
 
 		$this->wp->add_query_var( 'test' );
-		$this->assertTrue( in_array( 'test', $this->wp->public_query_vars ) );
+		$this->assertTrue( in_array( 'test', $this->wp->public_query_vars, true ) );
 		$this->wp->remove_query_var( 'test' );
 
 		$this->assertSame( $public_qv_count, count( $this->wp->public_query_vars ) );
diff --git a/tests/xmlrpc/mw/getRecentPosts.php b/tests/xmlrpc/mw/getRecentPosts.php
index 58ebe25d58..a976ffafa2 100644
--- a/tests/xmlrpc/mw/getRecentPosts.php
+++ b/tests/xmlrpc/mw/getRecentPosts.php
@@ -109,7 +109,7 @@ class Tests_XMLRPC_mw_getRecentPosts extends WP_XMLRPC_UnitTestCase {
 			$this->assertInternalType( 'string', $result['wp_post_thumbnail'] );
 			$this->assertStringMatchesFormat( '%d', $result['wp_post_thumbnail'] );
 
-			if ( ! empty( $result['wp_post_thumbnail'] ) || $result['postid'] == self::$post_id ) {
+			if ( ! empty( $result['wp_post_thumbnail'] ) || $result['postid'] === self::$post_id ) {
 				$attachment_id = get_post_meta( $result['postid'], '_thumbnail_id', true );
 
 				$this->assertEquals( $attachment_id, $result['wp_post_thumbnail'] );
diff --git a/tests/xmlrpc/wp/editPost.php b/tests/xmlrpc/wp/editPost.php
index 90399b092c..fc822a251c 100644
--- a/tests/xmlrpc/wp/editPost.php
+++ b/tests/xmlrpc/wp/editPost.php
@@ -274,7 +274,7 @@ class Tests_XMLRPC_wp_editPost extends WP_XMLRPC_UnitTestCase {
 				'post_content' => 'Not edited',
 				'post_author'  => $editor_id,
 				'post_status'  => 'publish',
-				'post_date'    => date( 'Y-m-d H:i:s', $yesterday ),
+				'post_date'    => gmdate( 'Y-m-d H:i:s', $yesterday ),
 			)
 		);
 
@@ -445,7 +445,7 @@ class Tests_XMLRPC_wp_editPost extends WP_XMLRPC_UnitTestCase {
 		$this->assertEquals( 1, count( get_post_meta( $post_id, 'enclosure' ) ) );
 
 		// For good measure, check that the expected value is in the array
-		$this->assertTrue( in_array( $enclosure_string, get_post_meta( $post_id, 'enclosure' ) ) );
+		$this->assertTrue( in_array( $enclosure_string, get_post_meta( $post_id, 'enclosure' ), true ) );
 
 		// Attempt to add a brand new enclosure via XML-RPC
 		$this->myxmlrpcserver->add_enclosure_if_new( $post_id, $new_enclosure );
@@ -455,10 +455,10 @@ class Tests_XMLRPC_wp_editPost extends WP_XMLRPC_UnitTestCase {
 
 		// Check that the new enclosure is in the enclosure meta
 		$new_enclosure_string = "{$new_enclosure['url']}\n{$new_enclosure['length']}\n{$new_enclosure['type']}\n";
-		$this->assertTrue( in_array( $new_enclosure_string, get_post_meta( $post_id, 'enclosure' ) ) );
+		$this->assertTrue( in_array( $new_enclosure_string, get_post_meta( $post_id, 'enclosure' ), true ) );
 
 		// Check that the old enclosure is in the enclosure meta
-		$this->assertTrue( in_array( $enclosure_string, get_post_meta( $post_id, 'enclosure' ) ) );
+		$this->assertTrue( in_array( $enclosure_string, get_post_meta( $post_id, 'enclosure' ), true ) );
 	}
 
 	/**
@@ -496,4 +496,33 @@ class Tests_XMLRPC_wp_editPost extends WP_XMLRPC_UnitTestCase {
 		$future_date_string = strftime( '%Y-%m-%d %H:%M:%S', $future_time );
 		$this->assertEquals( $future_date_string, $after->post_date );
 	}
+
+	/**
+	 * @ticket 45322
+	 */
+	function test_draft_not_assigned_published_date() {
+		$editor_id = $this->make_user_by_role( 'editor' );
+
+		// Start with a draft post, confirming its post_date_gmt is "zero".
+		$post    = array(
+			'post_title'  => 'Test',
+			'post_status' => 'draft',
+		);
+		$post_id = $this->myxmlrpcserver->wp_newPost( array( 1, 'editor', 'editor', $post ) );
+
+		$before = get_post( $post_id );
+		$this->assertEquals( '0000-00-00 00:00:00', $before->post_date_gmt );
+
+		// Edit the post without specifying any dates.
+		$new_post_content = array(
+			'ID'         => $post_id,
+			'post_title' => 'Updated',
+		);
+
+		$this->myxmlrpcserver->wp_editPost( array( 1, 'editor', 'editor', $post_id, $new_post_content ) );
+
+		// The published date should still be zero.
+		$after = get_post( $post_id );
+		$this->assertEquals( '0000-00-00 00:00:00', $after->post_date_gmt );
+	}
 }
diff --git a/tests/xmlrpc/wp/getMediaItem.php b/tests/xmlrpc/wp/getMediaItem.php
index e036a7f4b9..7c46ded316 100644
--- a/tests/xmlrpc/wp/getMediaItem.php
+++ b/tests/xmlrpc/wp/getMediaItem.php
@@ -20,7 +20,7 @@ class Tests_XMLRPC_wp_getMediaItem extends WP_XMLRPC_UnitTestCase {
 
 		$filename = ( DIR_TESTDATA . '/images/waffles.jpg' );
 		$contents = file_get_contents( $filename );
-		$upload   = wp_upload_bits( basename( $filename ), null, $contents );
+		$upload   = wp_upload_bits( wp_basename( $filename ), null, $contents );
 
 		$this->attachment_id   = $this->_make_attachment( $upload, self::$post_id );
 		$this->attachment_data = get_post( $this->attachment_id, ARRAY_A );
diff --git a/tests/xmlrpc/wp/getPages.php b/tests/xmlrpc/wp/getPages.php
index 76c9f360cb..40da0ea891 100644
--- a/tests/xmlrpc/wp/getPages.php
+++ b/tests/xmlrpc/wp/getPages.php
@@ -55,8 +55,8 @@ class Tests_XMLRPC_wp_getPages extends WP_XMLRPC_UnitTestCase {
 	}
 
 	function remove_editor_edit_page_cap( $caps, $cap, $user_id, $args ) {
-		if ( in_array( $cap, array( 'edit_page', 'edit_others_pages' ) ) ) {
-			if ( $user_id == self::$editor_id && $args[0] == self::$post_id ) {
+		if ( in_array( $cap, array( 'edit_page', 'edit_others_pages' ), true ) ) {
+			if ( $user_id === self::$editor_id && $args[0] === self::$post_id ) {
 				return array( false );
 			}
 		}
@@ -78,7 +78,7 @@ class Tests_XMLRPC_wp_getPages extends WP_XMLRPC_UnitTestCase {
 			// WP#20629
 			$this->assertNotIXRError( $result );
 
-			if ( $result['page_id'] == self::$post_id ) {
+			if ( $result['page_id'] === self::$post_id ) {
 				$found_incapable = true;
 				break;
 			}
diff --git a/tests/xmlrpc/wp/getPosts.php b/tests/xmlrpc/wp/getPosts.php
index cce9e5b0df..c9a1b4cce1 100644
--- a/tests/xmlrpc/wp/getPosts.php
+++ b/tests/xmlrpc/wp/getPosts.php
@@ -60,7 +60,7 @@ class Tests_XMLRPC_wp_getPosts extends WP_XMLRPC_UnitTestCase {
 			$post_ids[] = self::factory()->post->create(
 				array(
 					'post_type' => $cpt_name,
-					'post_date' => date( 'Y-m-d H:i:s', time() + $i ),
+					'post_date' => gmdate( 'Y-m-d H:i:s', time() + $i ),
 				)
 			);
 		}
diff --git a/tests/xmlrpc/wp/getTerms.php b/tests/xmlrpc/wp/getTerms.php
index 2432fecf53..477bed7195 100644
--- a/tests/xmlrpc/wp/getTerms.php
+++ b/tests/xmlrpc/wp/getTerms.php
@@ -121,9 +121,9 @@ class Tests_XMLRPC_wp_getTerms extends WP_XMLRPC_UnitTestCase {
 		$this->assertNotEquals( 0, count( $results ) );
 
 		foreach ( $results as $term ) {
-			if ( $term['term_id'] == $cat1 ) {
+			if ( $term['term_id'] === $cat1 ) {
 				break;  // found cat1 first as expected
-			} elseif ( $term['term_id'] == $cat2 ) {
+			} elseif ( $term['term_id'] === $cat2 ) {
 				$this->assertFalse( false, 'Incorrect category ordering.' );
 			}
 		}
diff --git a/tests/xmlrpc/wp/newPost.php b/tests/xmlrpc/wp/newPost.php
index 27a164564a..7e37333254 100644
--- a/tests/xmlrpc/wp/newPost.php
+++ b/tests/xmlrpc/wp/newPost.php
@@ -355,7 +355,7 @@ class Tests_XMLRPC_wp_newPost extends WP_XMLRPC_UnitTestCase {
 		$result       = $this->myxmlrpcserver->wp_newPost( array( 1, 'author', 'author', $post ) );
 		$fetched_post = get_post( $result );
 		$this->assertStringMatchesFormat( '%d', $result );
-		$this->assertEquals( '1970-01-01 00:00:00', $fetched_post->post_date );
+		$this->assertEquals( current_time( 'Y-m-d' ), substr( $fetched_post->post_date, 0, 10 ) );
 	}
 
 	/**
@@ -363,7 +363,7 @@ class Tests_XMLRPC_wp_newPost extends WP_XMLRPC_UnitTestCase {
 	 */
 	function test_invalid_post_date_gmt_does_not_fatal() {
 		$this->make_user_by_role( 'author' );
-		$date_string  = 'invalid date';
+		$date_string  = 'invalid_date';
 		$post         = array(
 			'post_title'    => 'test',
 			'post_content'  => 'test',
@@ -372,7 +372,7 @@ class Tests_XMLRPC_wp_newPost extends WP_XMLRPC_UnitTestCase {
 		$result       = $this->myxmlrpcserver->wp_newPost( array( 1, 'author', 'author', $post ) );
 		$fetched_post = get_post( $result );
 		$this->assertStringMatchesFormat( '%d', $result );
-		$this->assertEquals( '1970-01-01 00:00:00', $fetched_post->post_date_gmt );
+		$this->assertEquals( '0000-00-00', substr( $fetched_post->post_date_gmt, 0, 10 ) );
 	}
 
 	/**
diff --git a/wp-mail-real-test.php b/wp-mail-real-test.php
index 55bd090773..67da30ef86 100644
--- a/wp-mail-real-test.php
+++ b/wp-mail-real-test.php
@@ -53,7 +53,7 @@ require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
 wp_install( WP_BLOG_TITLE, WP_USER_NAME, WP_USER_EMAIL, true );
 
 // make sure we're installed
-assert( true == is_blog_installed() );
+assert( true === is_blog_installed() );
 
 // phpcs:ignore Generic.NamingConventions.UpperCaseConstantName.ConstantNotUpperCase
 define( 'PHPUnit_MAIN_METHOD', false );
