diff --git a/data/WPHTTP-testcase-redirection-script.php b/data/WPHTTP-testcase-redirection-script.php
index a73e8c6e09..94643d3de9 100644
--- a/data/WPHTTP-testcase-redirection-script.php
+++ b/data/WPHTTP-testcase-redirection-script.php
@@ -36,7 +36,7 @@ if ( isset($_GET['201-location']) ) {
 }
 if ( isset($_GET['header-check']) ) {
 	$out = array();
-	header("Content-type: text/plain");
+	header("Content-Type: text/plain");
 	foreach ( $_SERVER as $key => $value ) {
 		if ( stripos($key, 'http') === 0 ) {
 			$key = strtolower(substr($key, 5));
@@ -63,7 +63,7 @@ if ( isset( $_GET['post-redirect-to-method'] ) ) {
 
 	echo $method;
 	exit;
-	
+
 }
 
 if ( isset( $_GET['location-with-200'] ) ) {
diff --git a/data/blocks/fixtures/core__archives.server.html b/data/blocks/fixtures/core__archives.server.html
index 9191cc5b03..19e64659ef 100644
--- a/data/blocks/fixtures/core__archives.server.html
+++ b/data/blocks/fixtures/core__archives.server.html
@@ -1 +1 @@
-<div class=" wp-block-archives-list wp-block-archives">No archives to show.</div>
\ No newline at end of file
+<div class="wp-block-archives-list wp-block-archives">No archives to show.</div>
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__archives__showPostCounts.server.html b/data/blocks/fixtures/core__archives__showPostCounts.server.html
index 9191cc5b03..19e64659ef 100644
--- a/data/blocks/fixtures/core__archives__showPostCounts.server.html
+++ b/data/blocks/fixtures/core__archives__showPostCounts.server.html
@@ -1 +1 @@
-<div class=" wp-block-archives-list wp-block-archives">No archives to show.</div>
\ No newline at end of file
+<div class="wp-block-archives-list wp-block-archives">No archives to show.</div>
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__column.server.html b/data/blocks/fixtures/core__column.server.html
index d3d3cac083..a3624daaf0 100644
--- a/data/blocks/fixtures/core__column.server.html
+++ b/data/blocks/fixtures/core__column.server.html
@@ -1,5 +1,5 @@
 
-<div class="is-layout-flow wp-block-column">
+<div class="wp-block-column is-layout-flow">
 	
 	<p>Column One, Paragraph One</p>
 	
diff --git a/data/blocks/fixtures/core__columns.server.html b/data/blocks/fixtures/core__columns.server.html
index f8b9705b59..1c144512d1 100644
--- a/data/blocks/fixtures/core__columns.server.html
+++ b/data/blocks/fixtures/core__columns.server.html
@@ -1,7 +1,7 @@
 
-<div class="is-layout-flex wp-container-1 wp-block-columns has-3-columns">
+<div class="wp-block-columns has-3-columns is-layout-flex wp-container-1">
 	
-	<div class="is-layout-flow wp-block-column">
+	<div class="wp-block-column is-layout-flow">
 		
 		<p>Column One, Paragraph One</p>
 		
@@ -11,7 +11,7 @@
 	</div>
 	
 	
-	<div class="is-layout-flow wp-block-column">
+	<div class="wp-block-column is-layout-flow">
 		
 		<p>Column Two, Paragraph One</p>
 		
diff --git a/data/blocks/fixtures/core__columns__deprecated.server.html b/data/blocks/fixtures/core__columns__deprecated.server.html
index 6240dc51a8..9d213ddcdf 100644
--- a/data/blocks/fixtures/core__columns__deprecated.server.html
+++ b/data/blocks/fixtures/core__columns__deprecated.server.html
@@ -1,5 +1,5 @@
 
-<div class="is-layout-flex wp-container-1 wp-block-columns has-3-columns">
+<div class="wp-block-columns has-3-columns is-layout-flex wp-container-1">
 	
 	<p class="layout-column-1">Column One, Paragraph One</p>
 	
diff --git a/data/blocks/fixtures/core__gallery-with-caption.html b/data/blocks/fixtures/core__gallery-with-caption.html
new file mode 100644
index 0000000000..498c7752e3
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery-with-caption.html
@@ -0,0 +1,26 @@
+<!-- wp:gallery {"linkTo":"none"} -->
+<figure
+	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"
+>
+	<!-- wp:image {"id":1421,"sizeSlug":"large","linkDestination":"none","inheritedAttributes":{"linkDestination":true,"linkTarget":true,"sizeSlug":true}} -->
+	<figure class="wp-block-image size-large">
+		<img
+			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
+			alt="Image gallery image"
+			class="wp-image-1421"
+		/>
+	</figure>
+	<!-- /wp:image -->
+
+	<!-- wp:image {"id":1440,"sizeSlug":"large","linkDestination":"none","inheritedAttributes":{"linkDestination":true,"linkTarget":true,"sizeSlug":true}} -->
+	<figure class="wp-block-image size-large">
+		<img
+			src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580"
+			alt="Image gallery image"
+			class="wp-image-1440"
+		/>
+	</figure>
+	<!-- /wp:image -->
+	<figcaption class="blocks-gallery-caption wp-element-caption">Gallery Caption</figcaption>
+</figure>
+<!-- /wp:core/gallery -->
diff --git a/data/blocks/fixtures/core__gallery-with-caption.json b/data/blocks/fixtures/core__gallery-with-caption.json
new file mode 100644
index 0000000000..12b5166066
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery-with-caption.json
@@ -0,0 +1,46 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"images": [],
+			"ids": [],
+			"shortCodeTransforms": [],
+			"caption": "Gallery Caption",
+			"imageCrop": true,
+			"fixedHeight": true,
+			"linkTo": "none",
+			"sizeSlug": "large",
+			"allowResize": false,
+			"className": "columns-2"
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190",
+					"alt": "Image gallery image",
+					"caption": "",
+					"id": 1421,
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580",
+					"alt": "Image gallery image",
+					"caption": "",
+					"id": 1440,
+					"sizeSlug": "large",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery-with-caption.parsed.json b/data/blocks/fixtures/core__gallery-with-caption.parsed.json
new file mode 100644
index 0000000000..619adef3d8
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery-with-caption.parsed.json
@@ -0,0 +1,62 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"linkTo": "none"
+		},
+		"innerBlocks": [
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 1421,
+					"sizeSlug": "large",
+					"linkDestination": "none",
+					"inheritedAttributes": {
+						"linkDestination": true,
+						"linkTarget": true,
+						"sizeSlug": true
+					}
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1421\"\n\t\t/>\n\t</figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1421\"\n\t\t/>\n\t</figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 1440,
+					"sizeSlug": "large",
+					"linkDestination": "none",
+					"inheritedAttributes": {
+						"linkDestination": true,
+						"linkTarget": true,
+						"sizeSlug": true
+					}
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1440\"\n\t\t/>\n\t</figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1440\"\n\t\t/>\n\t</figure>\n\t"
+				]
+			}
+		],
+		"innerHTML": "\n<figure\n\tclass=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\"\n>\n\t\n\n\t\n\t<figcaption class=\"blocks-gallery-caption wp-element-caption\">Gallery Caption</figcaption>\n</figure>\n",
+		"innerContent": [
+			"\n<figure\n\tclass=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\"\n>\n\t",
+			null,
+			"\n\n\t",
+			null,
+			"\n\t<figcaption class=\"blocks-gallery-caption wp-element-caption\">Gallery Caption</figcaption>\n</figure>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+
+]
diff --git a/data/blocks/fixtures/core__gallery-with-caption.serialized.html b/data/blocks/fixtures/core__gallery-with-caption.serialized.html
new file mode 100644
index 0000000000..0eeab028d1
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery-with-caption.serialized.html
@@ -0,0 +1,9 @@
+<!-- wp:gallery {"linkTo":"none","className":"columns-2"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"><!-- wp:image {"id":1421,"sizeSlug":"large","linkDestination":"none"} -->
+<figure class="wp-block-image size-large"><img src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190" alt="Image gallery image" class="wp-image-1421"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":1440,"sizeSlug":"large","linkDestination":"none"} -->
+<figure class="wp-block-image size-large"><img src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580" alt="Image gallery image" class="wp-image-1440"/></figure>
+<!-- /wp:image --><figcaption class="blocks-gallery-caption wp-element-caption">Gallery Caption</figcaption></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery-with-caption.server.html b/data/blocks/fixtures/core__gallery-with-caption.server.html
new file mode 100644
index 0000000000..18e3f1d8c8
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery-with-caption.server.html
@@ -0,0 +1,26 @@
+
+<figure
+	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2 wp-block-gallery-1 is-layout-flex"
+>
+
+	<figure class="wp-block-image size-large">
+		<img data-id="1421"
+			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
+			alt="Image gallery image"
+			class="wp-image-1421"
+		/>
+	</figure>
+
+
+
+	<figure class="wp-block-image size-large">
+		<img data-id="1440"
+			src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580"
+			alt="Image gallery image"
+			class="wp-image-1440"
+		/>
+	</figure>
+
+	<figcaption class="blocks-gallery-caption wp-element-caption">Gallery Caption</figcaption>
+</figure>
+
diff --git a/data/blocks/fixtures/core__gallery.html b/data/blocks/fixtures/core__gallery.html
index 54f9991f88..3db587c8d7 100644
--- a/data/blocks/fixtures/core__gallery.html
+++ b/data/blocks/fixtures/core__gallery.html
@@ -1,14 +1,24 @@
 <!-- wp:gallery {"linkTo":"none","className":"columns-2"} -->
-<figure class="wp-block-gallery has-nested-images columns-default is-cropped columns-2">
-	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+<figure
+	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"
+>
+	<!-- wp:image {"id":1421,"sizeSlug":"large","linkDestination":"none"} -->
 	<figure class="wp-block-image size-large">
-		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+		<img
+			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
+			alt="Image gallery image"
+			class="wp-image-1421"
+		/>
 	</figure>
 	<!-- /wp:image -->
 
-	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+	<!-- wp:image {"id":1440,"sizeSlug":"large","linkDestination":"none"} -->
 	<figure class="wp-block-image size-large">
-		<img src="http://google.com/hi.png" alt="Image gallery image" />
+		<img
+			src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580"
+			alt="Image gallery image"
+			class="wp-image-1440"
+		/>
 	</figure>
 	<!-- /wp:image -->
 </figure>
diff --git a/data/blocks/fixtures/core__gallery.json b/data/blocks/fixtures/core__gallery.json
index 0225422123..8b7a1000d3 100644
--- a/data/blocks/fixtures/core__gallery.json
+++ b/data/blocks/fixtures/core__gallery.json
@@ -19,9 +19,10 @@
 				"name": "core/image",
 				"isValid": true,
 				"attributes": {
-					"url": "https://cldup.com/uuUqE_dXzy.jpg",
+					"url": "https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190",
 					"alt": "Image gallery image",
 					"caption": "",
+					"id": 1421,
 					"sizeSlug": "large",
 					"linkDestination": "none"
 				},
@@ -31,9 +32,10 @@
 				"name": "core/image",
 				"isValid": true,
 				"attributes": {
-					"url": "http://google.com/hi.png",
+					"url": "https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580",
 					"alt": "Image gallery image",
 					"caption": "",
+					"id": 1440,
 					"sizeSlug": "large",
 					"linkDestination": "none"
 				},
diff --git a/data/blocks/fixtures/core__gallery.parsed.json b/data/blocks/fixtures/core__gallery.parsed.json
index 00a75f5f13..4ddf4ca36e 100644
--- a/data/blocks/fixtures/core__gallery.parsed.json
+++ b/data/blocks/fixtures/core__gallery.parsed.json
@@ -9,44 +9,45 @@
 			{
 				"blockName": "core/image",
 				"attrs": {
+					"id": 1421,
 					"sizeSlug": "large",
 					"linkDestination": "none"
 				},
 				"innerBlocks": [],
-				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1421\"\n\t\t/>\n\t</figure>\n\t",
 				"innerContent": [
-					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1421\"\n\t\t/>\n\t</figure>\n\t"
 				]
 			},
 			{
 				"blockName": "core/image",
 				"attrs": {
+					"id": 1440,
 					"sizeSlug": "large",
 					"linkDestination": "none"
 				},
 				"innerBlocks": [],
-				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1440\"\n\t\t/>\n\t</figure>\n\t",
 				"innerContent": [
-					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1440\"\n\t\t/>\n\t</figure>\n\t"
 				]
 			}
 		],
-		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\">\n\t\n\n\t\n</figure>\n",
+		"innerHTML": "\n<figure\n\tclass=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\"\n>\n\t\n\n\t\n</figure>\n",
 		"innerContent": [
-			"\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\">\n\t",
+			"\n<figure\n\tclass=\"wp-block-gallery has-nested-images columns-default is-cropped columns-2\"\n>\n\t",
 			null,
 			"\n\n\t",
 			null,
 			"\n</figure>\n"
 		]
 	},
-    {
-        "blockName": null,
-        "attrs": {},
-        "innerBlocks": [],
-        "innerHTML": "\n",
-        "innerContent": [
-            "\n"
-        ]
-    }
-]
\ No newline at end of file
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+
+]
diff --git a/data/blocks/fixtures/core__gallery.serialized.html b/data/blocks/fixtures/core__gallery.serialized.html
index bc5d6be414..6ab87b7c60 100644
--- a/data/blocks/fixtures/core__gallery.serialized.html
+++ b/data/blocks/fixtures/core__gallery.serialized.html
@@ -1,3 +1,9 @@
 <!-- wp:gallery {"linkTo":"none","className":"columns-2"} -->
-<figure class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" /></figure><!-- /wp:image --><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="http://google.com/hi.png" alt="Image gallery image" /></figure><!-- /wp:image --></figure>
-<!-- /wp:gallery -->
\ No newline at end of file
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped columns-2"><!-- wp:image {"id":1421,"sizeSlug":"large","linkDestination":"none"} -->
+<figure class="wp-block-image size-large"><img src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190" alt="Image gallery image" class="wp-image-1421"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":1440,"sizeSlug":"large","linkDestination":"none"} -->
+<figure class="wp-block-image size-large"><img src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580" alt="Image gallery image" class="wp-image-1440"/></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery.server.html b/data/blocks/fixtures/core__gallery.server.html
index c7a5d3bb44..fdea3c8cee 100644
--- a/data/blocks/fixtures/core__gallery.server.html
+++ b/data/blocks/fixtures/core__gallery.server.html
@@ -1,15 +1,25 @@
 
-<figure class="is-layout-flex wp-block-gallery-1 wp-block-gallery has-nested-images columns-default is-cropped columns-2">
-	
+<figure
+	class="wp-block-gallery has-nested-images columns-default is-cropped columns-2 wp-block-gallery-1 is-layout-flex"
+>
+
 	<figure class="wp-block-image size-large">
-		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+		<img data-id="1421"
+			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
+			alt="Image gallery image"
+			class="wp-image-1421"
+		/>
 	</figure>
-	
 
-	
+
+
 	<figure class="wp-block-image size-large">
-		<img src="http://google.com/hi.png" alt="Image gallery image" />
+		<img data-id="1440"
+			src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580"
+			alt="Image gallery image"
+			class="wp-image-1440"
+		/>
 	</figure>
-	
+
 </figure>
 
diff --git a/data/blocks/fixtures/core__gallery__columns.html b/data/blocks/fixtures/core__gallery__columns.html
index 4f34167c17..b70ac2b6f0 100644
--- a/data/blocks/fixtures/core__gallery__columns.html
+++ b/data/blocks/fixtures/core__gallery__columns.html
@@ -1,14 +1,22 @@
-<!-- wp:gallery {"linkTo":"none","className":"columns-1"} -->
-<figure class="wp-block-gallery has-nested-images is-cropped columns-1" >
-	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+<!-- wp:gallery {"columns":1,"linkTo":"none"} -->
+<figure class="wp-block-gallery has-nested-images columns-1 is-cropped">
+	<!-- wp:image {"id":1421,"sizeSlug":"large","linkDestination":"none","inheritedAttributes":{"linkDestination":true,"linkTarget":true,"sizeSlug":true}} -->
 	<figure class="wp-block-image size-large">
-		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+		<img
+			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
+			alt="Image gallery image"
+			class="wp-image-1421"
+		/>
 	</figure>
 	<!-- /wp:image -->
 
-	<!-- wp:image {"sizeSlug":"large","linkDestination":"none"} -->
+	<!-- wp:image {"id":1440,"sizeSlug":"large","linkDestination":"none","inheritedAttributes":{"linkDestination":true,"linkTarget":true,"sizeSlug":true}} -->
 	<figure class="wp-block-image size-large">
-		<img src="http://google.com/hi.png" alt="Image gallery image" />
+		<img
+			src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580"
+			alt="Image gallery image"
+			class="wp-image-1440"
+		/>
 	</figure>
 	<!-- /wp:image -->
 </figure>
diff --git a/data/blocks/fixtures/core__gallery__columns.json b/data/blocks/fixtures/core__gallery__columns.json
index 4523d16b20..d0c40b3d3a 100644
--- a/data/blocks/fixtures/core__gallery__columns.json
+++ b/data/blocks/fixtures/core__gallery__columns.json
@@ -6,23 +6,23 @@
 			"images": [],
 			"ids": [],
 			"shortCodeTransforms": [],
+			"columns": 1,
 			"caption": "",
 			"imageCrop": true,
 			"fixedHeight": true,
 			"linkTo": "none",
 			"sizeSlug": "large",
-			"allowResize": false,
-			"className": "columns-1",
-            "columns": 1
+			"allowResize": false
 		},
 		"innerBlocks": [
 			{
 				"name": "core/image",
 				"isValid": true,
 				"attributes": {
-					"url": "https://cldup.com/uuUqE_dXzy.jpg",
+					"url": "https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190",
 					"alt": "Image gallery image",
 					"caption": "",
+					"id": 1421,
 					"sizeSlug": "large",
 					"linkDestination": "none"
 				},
@@ -32,9 +32,10 @@
 				"name": "core/image",
 				"isValid": true,
 				"attributes": {
-					"url": "http://google.com/hi.png",
+					"url": "https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580",
 					"alt": "Image gallery image",
 					"caption": "",
+					"id": 1440,
 					"sizeSlug": "large",
 					"linkDestination": "none"
 				},
diff --git a/data/blocks/fixtures/core__gallery__columns.parsed.json b/data/blocks/fixtures/core__gallery__columns.parsed.json
index d3d7c23893..b7a56415bf 100644
--- a/data/blocks/fixtures/core__gallery__columns.parsed.json
+++ b/data/blocks/fixtures/core__gallery__columns.parsed.json
@@ -2,51 +2,61 @@
 	{
 		"blockName": "core/gallery",
 		"attrs": {
-			"linkTo": "none",
-			"className": "columns-1"
+			"columns": 1,
+			"linkTo": "none"
 		},
 		"innerBlocks": [
 			{
 				"blockName": "core/image",
 				"attrs": {
+					"id": 1421,
 					"sizeSlug": "large",
-					"linkDestination": "none"
+					"linkDestination": "none",
+					"inheritedAttributes": {
+						"linkDestination": true,
+						"linkTarget": true,
+						"sizeSlug": true
+					}
 				},
 				"innerBlocks": [],
-				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1421\"\n\t\t/>\n\t</figure>\n\t",
 				"innerContent": [
-					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"https://cldup.com/uuUqE_dXzy.jpg\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1421\"\n\t\t/>\n\t</figure>\n\t"
 				]
 			},
 			{
 				"blockName": "core/image",
 				"attrs": {
+					"id": 1440,
 					"sizeSlug": "large",
-					"linkDestination": "none"
+					"linkDestination": "none",
+					"inheritedAttributes": {
+						"linkDestination": true,
+						"linkTarget": true,
+						"sizeSlug": true
+					}
 				},
 				"innerBlocks": [],
-				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t",
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1440\"\n\t\t/>\n\t</figure>\n\t",
 				"innerContent": [
-					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img src=\"http://google.com/hi.png\" alt=\"Image gallery image\" />\n\t</figure>\n\t"
+					"\n\t<figure class=\"wp-block-image size-large\">\n\t\t<img\n\t\t\tsrc=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\"\n\t\t\talt=\"Image gallery image\"\n\t\t\tclass=\"wp-image-1440\"\n\t\t/>\n\t</figure>\n\t"
 				]
 			}
 		],
-		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images is-cropped columns-1\" >\n\t\n\n\t\n</figure>\n",
+		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images columns-1 is-cropped\">\n\t\n\n\t\n</figure>\n",
 		"innerContent": [
-			"\n<figure class=\"wp-block-gallery has-nested-images is-cropped columns-1\" >\n\t",
+			"\n<figure class=\"wp-block-gallery has-nested-images columns-1 is-cropped\">\n\t",
 			null,
 			"\n\n\t",
 			null,
 			"\n</figure>\n"
 		]
 	},
-    {
-        "blockName": null,
-        "attrs": {},
-        "innerBlocks": [],
-        "innerHTML": "\n",
-        "innerContent": [
-            "\n"
-        ]
-    }
-]
\ No newline at end of file
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__columns.serialized.html b/data/blocks/fixtures/core__gallery__columns.serialized.html
index 88464bedce..a139867795 100644
--- a/data/blocks/fixtures/core__gallery__columns.serialized.html
+++ b/data/blocks/fixtures/core__gallery__columns.serialized.html
@@ -1,3 +1,9 @@
-<!-- wp:gallery {"linkTo":"none","className":"columns-1"} -->
-<figure class="wp-block-gallery has-nested-images is-cropped columns-1"><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" /></figure><!-- /wp:image --><!-- wp:image {"sizeSlug":"large","linkDestination":"none"} --><figure class="wp-block-image size-large"><img src="http://google.com/hi.png" alt="Image gallery image" /></figure><!-- /wp:image --></figure>
-<!-- /wp:gallery -->
\ No newline at end of file
+<!-- wp:gallery {"columns":1,"linkTo":"none"} -->
+<figure class="wp-block-gallery has-nested-images columns-1 is-cropped"><!-- wp:image {"id":1421,"sizeSlug":"large","linkDestination":"none"} -->
+<figure class="wp-block-image size-large"><img src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190" alt="Image gallery image" class="wp-image-1421"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":1440,"sizeSlug":"large","linkDestination":"none"} -->
+<figure class="wp-block-image size-large"><img src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580" alt="Image gallery image" class="wp-image-1440"/></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__columns.server.html b/data/blocks/fixtures/core__gallery__columns.server.html
index 2970d60ced..33bf96793e 100644
--- a/data/blocks/fixtures/core__gallery__columns.server.html
+++ b/data/blocks/fixtures/core__gallery__columns.server.html
@@ -1,15 +1,17 @@
 
-<figure class="is-layout-flex wp-block-gallery-1 wp-block-gallery has-nested-images is-cropped columns-1" >
-	
+<figure class="wp-block-gallery has-nested-images columns-1 is-cropped wp-block-gallery-1 is-layout-flex">
 	<figure class="wp-block-image size-large">
-		<img src="https://cldup.com/uuUqE_dXzy.jpg" alt="Image gallery image" />
+		<img data-id="1421"
+			src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190"
+			alt="Image gallery image"
+			class="wp-image-1421"
+		/>
 	</figure>
-	
-
-	
 	<figure class="wp-block-image size-large">
-		<img src="http://google.com/hi.png" alt="Image gallery image" />
+		<img data-id="1440"
+			src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580"
+			alt="Image gallery image"
+			class="wp-image-1440"
+		/>
 	</figure>
-	
 </figure>
-
diff --git a/data/blocks/fixtures/core__gallery__deprecated-1.html b/data/blocks/fixtures/core__gallery__deprecated-1.html
new file mode 100644
index 0000000000..f982c52aa2
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-1.html
@@ -0,0 +1,10 @@
+<!-- wp:core/gallery {"columns":2,"align":"wide"} -->
+<div class="wp-block-gallery columns-2 is-cropped alignwide">
+	<figure class="blocks-gallery-image">
+		<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" />
+	</figure>
+	<figure class="blocks-gallery-image">
+		<img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title" />
+	</figure>
+</div>
+<!-- /wp:core/gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-1.json b/data/blocks/fixtures/core__gallery__deprecated-1.json
new file mode 100644
index 0000000000..9e15ee7f1c
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-1.json
@@ -0,0 +1,35 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"columns": 2,
+			"imageCrop": true,
+			"linkTo": "none",
+			"align": "wide",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==",
+					"alt": "title",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=",
+					"alt": "title",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-1.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-1.parsed.json
new file mode 100644
index 0000000000..1f2ad33f72
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-1.parsed.json
@@ -0,0 +1,21 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"columns": 2,
+			"align": "wide"
+		},
+		"innerBlocks": [],
+		"innerHTML": "\n<div class=\"wp-block-gallery columns-2 is-cropped alignwide\">\n\t<figure class=\"blocks-gallery-image\">\n\t\t<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\" alt=\"title\" />\n\t</figure>\n\t<figure class=\"blocks-gallery-image\">\n\t\t<img src=\"data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=\" alt=\"title\" />\n\t</figure>\n</div>\n",
+		"innerContent": [
+			"\n<div class=\"wp-block-gallery columns-2 is-cropped alignwide\">\n\t<figure class=\"blocks-gallery-image\">\n\t\t<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\" alt=\"title\" />\n\t</figure>\n\t<figure class=\"blocks-gallery-image\">\n\t\t<img src=\"data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=\" alt=\"title\" />\n\t</figure>\n</div>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-1.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-1.serialized.html
new file mode 100644
index 0000000000..d0210e6ab6
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-1.serialized.html
@@ -0,0 +1,9 @@
+<!-- wp:gallery {"columns":2,"linkTo":"none","align":"wide"} -->
+<figure class="wp-block-gallery alignwide has-nested-images columns-2 is-cropped"><!-- wp:image {"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title"/></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-1.server.html b/data/blocks/fixtures/core__gallery__deprecated-1.server.html
new file mode 100644
index 0000000000..edf07c2a72
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-1.server.html
@@ -0,0 +1,9 @@
+
+<div class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+	<figure class="blocks-gallery-image">
+		<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" />
+	</figure>
+	<figure class="blocks-gallery-image">
+		<img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title" />
+	</figure>
+</div>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-2.html b/data/blocks/fixtures/core__gallery__deprecated-2.html
new file mode 100644
index 0000000000..7ff72ee6bc
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-2.html
@@ -0,0 +1,14 @@
+<!-- wp:core/gallery {"columns":2,"align":"wide"} -->
+<ul class="wp-block-gallery columns-2 is-cropped alignwide">
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" data-id="1" alt="title" class="wp-image-1" />
+		</figure>
+	</li>
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" data-id="2" alt="title" class="wp-image-2" />
+		</figure>
+	</li>
+</ul>
+<!-- /wp:core/gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-2.json b/data/blocks/fixtures/core__gallery__deprecated-2.json
new file mode 100644
index 0000000000..a60776801e
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-2.json
@@ -0,0 +1,39 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"columns": 2,
+			"imageCrop": true,
+			"linkTo": "none",
+			"align": "wide",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==",
+					"alt": "title",
+					"caption": "",
+					"id": 1,
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=",
+					"alt": "title",
+					"caption": "",
+					"id": 2,
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-2.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-2.parsed.json
new file mode 100644
index 0000000000..84f1f77d5b
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-2.parsed.json
@@ -0,0 +1,21 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"columns": 2,
+			"align": "wide"
+		},
+		"innerBlocks": [],
+		"innerHTML": "\n<ul class=\"wp-block-gallery columns-2 is-cropped alignwide\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\" data-id=\"1\" alt=\"title\" class=\"wp-image-1\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=\" data-id=\"2\" alt=\"title\" class=\"wp-image-2\" />\n\t\t</figure>\n\t</li>\n</ul>\n",
+		"innerContent": [
+			"\n<ul class=\"wp-block-gallery columns-2 is-cropped alignwide\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\" data-id=\"1\" alt=\"title\" class=\"wp-image-1\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=\" data-id=\"2\" alt=\"title\" class=\"wp-image-2\" />\n\t\t</figure>\n\t</li>\n</ul>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-2.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-2.serialized.html
new file mode 100644
index 0000000000..cab51d71a3
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-2.serialized.html
@@ -0,0 +1,9 @@
+<!-- wp:gallery {"columns":2,"linkTo":"none","align":"wide"} -->
+<figure class="wp-block-gallery alignwide has-nested-images columns-2 is-cropped"><!-- wp:image {"id":1,"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" class="wp-image-1"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":2,"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title" class="wp-image-2"/></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-2.server.html b/data/blocks/fixtures/core__gallery__deprecated-2.server.html
new file mode 100644
index 0000000000..4f47253ffb
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-2.server.html
@@ -0,0 +1,13 @@
+
+<ul class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" data-id="1" alt="title" class="wp-image-1" />
+		</figure>
+	</li>
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" data-id="2" alt="title" class="wp-image-2" />
+		</figure>
+	</li>
+</ul>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-3.html b/data/blocks/fixtures/core__gallery__deprecated-3.html
new file mode 100644
index 0000000000..8b23e16a38
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-3.html
@@ -0,0 +1,14 @@
+<!-- wp:core/gallery {"ids":[null,null],"align":"wide"} -->
+<ul class="wp-block-gallery columns-2 is-cropped alignwide">
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" />
+		</figure>
+	</li>
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title" />
+		</figure>
+	</li>
+</ul>
+<!-- /wp:core/gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-3.json b/data/blocks/fixtures/core__gallery__deprecated-3.json
new file mode 100644
index 0000000000..9ac2c19781
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-3.json
@@ -0,0 +1,36 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"imageCrop": true,
+			"linkTo": "none",
+			"align": "wide",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==",
+					"alt": "title",
+					"caption": "",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=",
+					"alt": "title",
+					"caption": "",
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-3.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-3.parsed.json
new file mode 100644
index 0000000000..cbb35065cf
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-3.parsed.json
@@ -0,0 +1,21 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"ids": [ null, null ],
+			"align": "wide"
+		},
+		"innerBlocks": [],
+		"innerHTML": "\n<ul class=\"wp-block-gallery columns-2 is-cropped alignwide\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>\n",
+		"innerContent": [
+			"\n<ul class=\"wp-block-gallery columns-2 is-cropped alignwide\">\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n\t<li class=\"blocks-gallery-item\">\n\t\t<figure>\n\t\t\t<img src=\"data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=\" alt=\"title\" />\n\t\t</figure>\n\t</li>\n</ul>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-3.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-3.serialized.html
new file mode 100644
index 0000000000..3cf2bb609d
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-3.serialized.html
@@ -0,0 +1,9 @@
+<!-- wp:gallery {"linkTo":"none","align":"wide"} -->
+<figure class="wp-block-gallery alignwide has-nested-images columns-default is-cropped"><!-- wp:image {"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title"/></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-3.server.html b/data/blocks/fixtures/core__gallery__deprecated-3.server.html
new file mode 100644
index 0000000000..9c58c81034
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-3.server.html
@@ -0,0 +1,13 @@
+
+<ul class="wp-block-gallery columns-2 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==" alt="title" />
+		</figure>
+	</li>
+	<li class="blocks-gallery-item">
+		<figure>
+			<img src="data:image/jpeg;base64,/9j/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/yQALCAABAAEBAREA/8wABgAQEAX/2gAIAQEAAD8A0s8g/9k=" alt="title" />
+		</figure>
+	</li>
+</ul>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-4.html b/data/blocks/fixtures/core__gallery__deprecated-4.html
new file mode 100644
index 0000000000..2ec6368390
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-4.html
@@ -0,0 +1,21 @@
+<!-- wp:gallery {"ids":["1421","1440","1362"],"align":"wide"} -->
+<figure class="wp-block-gallery columns-3 is-cropped alignwide">
+	<ul class="blocks-gallery-grid">
+		<li class="blocks-gallery-item">
+			<figure>
+				<img src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190" alt="" data-id="1421" class="wp-image-1421"/>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<img src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580" alt="" data-id="1440" class="wp-image-1440"/>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<img src="https://sergioestevaofolio.files.wordpress.com/2017/05/cropped-l1005945-2-2.jpg?w=580" alt="" data-id="1362" class="wp-image-1362"/>
+			</figure>
+		</li>
+	</ul>
+</figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-4.json b/data/blocks/fixtures/core__gallery__deprecated-4.json
new file mode 100644
index 0000000000..dad150cc96
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-4.json
@@ -0,0 +1,51 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"caption": "",
+			"imageCrop": true,
+			"linkTo": "none",
+			"align": "wide",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190",
+					"alt": "",
+					"caption": "",
+					"id": 1421,
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580",
+					"alt": "",
+					"caption": "",
+					"id": 1440,
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "https://sergioestevaofolio.files.wordpress.com/2017/05/cropped-l1005945-2-2.jpg?w=580",
+					"alt": "",
+					"caption": "",
+					"id": 1362,
+					"linkDestination": "none"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-4.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-4.parsed.json
new file mode 100644
index 0000000000..04dc77f799
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-4.parsed.json
@@ -0,0 +1,21 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"ids": [ "1421", "1440", "1362" ],
+			"align": "wide"
+		},
+		"innerBlocks": [],
+		"innerHTML": "\n<figure class=\"wp-block-gallery columns-3 is-cropped alignwide\">\n\t<ul class=\"blocks-gallery-grid\">\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<img src=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\" alt=\"\" data-id=\"1421\" class=\"wp-image-1421\"/>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<img src=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\" alt=\"\" data-id=\"1440\" class=\"wp-image-1440\"/>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<img src=\"https://sergioestevaofolio.files.wordpress.com/2017/05/cropped-l1005945-2-2.jpg?w=580\" alt=\"\" data-id=\"1362\" class=\"wp-image-1362\"/>\n\t\t\t</figure>\n\t\t</li>\n\t</ul>\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery columns-3 is-cropped alignwide\">\n\t<ul class=\"blocks-gallery-grid\">\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<img src=\"https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190\" alt=\"\" data-id=\"1421\" class=\"wp-image-1421\"/>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<img src=\"https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580\" alt=\"\" data-id=\"1440\" class=\"wp-image-1440\"/>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<img src=\"https://sergioestevaofolio.files.wordpress.com/2017/05/cropped-l1005945-2-2.jpg?w=580\" alt=\"\" data-id=\"1362\" class=\"wp-image-1362\"/>\n\t\t\t</figure>\n\t\t</li>\n\t</ul>\n</figure>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-4.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-4.serialized.html
new file mode 100644
index 0000000000..7ecc6f852e
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-4.serialized.html
@@ -0,0 +1,13 @@
+<!-- wp:gallery {"linkTo":"none","align":"wide"} -->
+<figure class="wp-block-gallery alignwide has-nested-images columns-default is-cropped"><!-- wp:image {"id":1421,"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190" alt="" class="wp-image-1421"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":1440,"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580" alt="" class="wp-image-1440"/></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":1362,"linkDestination":"none"} -->
+<figure class="wp-block-image"><img src="https://sergioestevaofolio.files.wordpress.com/2017/05/cropped-l1005945-2-2.jpg?w=580" alt="" class="wp-image-1362"/></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-4.server.html b/data/blocks/fixtures/core__gallery__deprecated-4.server.html
new file mode 100644
index 0000000000..355dc4bdf4
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-4.server.html
@@ -0,0 +1,20 @@
+
+<figure class="wp-block-gallery columns-3 is-cropped alignwide wp-block-gallery-1 is-layout-flex">
+	<ul class="blocks-gallery-grid">
+		<li class="blocks-gallery-item">
+			<figure>
+				<img src="https://sergioestevaofolio.files.wordpress.com/2016/09/cropped-img_9054-1.jpg?w=190" alt="" data-id="1421" class="wp-image-1421"/>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<img src="https://sergioestevaofolio.files.wordpress.com/2017/09/cropped-l1001498-1.jpg?w=580" alt="" data-id="1440" class="wp-image-1440"/>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<img src="https://sergioestevaofolio.files.wordpress.com/2017/05/cropped-l1005945-2-2.jpg?w=580" alt="" data-id="1362" class="wp-image-1362"/>
+			</figure>
+		</li>
+	</ul>
+</figure>
diff --git a/data/blocks/fixtures/core__gallery__deprecated-5.html b/data/blocks/fixtures/core__gallery__deprecated-5.html
new file mode 100644
index 0000000000..d97624d43e
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-5.html
@@ -0,0 +1,48 @@
+<!-- wp:gallery {"ids":[705,704,703],"linkTo":"media"} -->
+<figure class="wp-block-gallery columns-3 is-cropped">
+	<ul class="blocks-gallery-grid">
+		<li class="blocks-gallery-item">
+			<figure>
+				<a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg" >
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"
+						alt=""
+						data-id="705"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg"
+						data-link="http://wptest.local/classic/test-image-3/"
+						class="wp-image-705"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg" >
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"
+						alt=""
+						data-id="704"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg"
+						data-link="http://wptest.local/test-image-2/"
+						class="wp-image-704"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a href="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg" >
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"
+						alt=""
+						data-id="703"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg"
+						data-link="http://wptest.local/test-image/"
+						class="wp-image-703"
+					/>
+				</a>
+			</figure>
+		</li>
+	</ul>
+</figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-5.json b/data/blocks/fixtures/core__gallery__deprecated-5.json
new file mode 100644
index 0000000000..9ef1f03ba0
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-5.json
@@ -0,0 +1,57 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"caption": "",
+			"imageCrop": true,
+			"linkTo": "media",
+			"sizeSlug": "large",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"id": 705,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"id": 704,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"id": 703,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-5.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-5.parsed.json
new file mode 100644
index 0000000000..f2680567d8
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-5.parsed.json
@@ -0,0 +1,21 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"ids": [ 705, 704, 703 ],
+			"linkTo": "media"
+		},
+		"innerBlocks": [],
+		"innerHTML": "\n<figure class=\"wp-block-gallery columns-3 is-cropped\">\n\t<ul class=\"blocks-gallery-grid\">\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\" >\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"705\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/classic/test-image-3/\"\n\t\t\t\t\t\tclass=\"wp-image-705\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\" >\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"704\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image-2/\"\n\t\t\t\t\t\tclass=\"wp-image-704\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a href=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\" >\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"703\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image/\"\n\t\t\t\t\t\tclass=\"wp-image-703\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t</ul>\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery columns-3 is-cropped\">\n\t<ul class=\"blocks-gallery-grid\">\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\" >\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"705\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/classic/test-image-3/\"\n\t\t\t\t\t\tclass=\"wp-image-705\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\" >\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"704\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image-2/\"\n\t\t\t\t\t\tclass=\"wp-image-704\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a href=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\" >\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"703\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image/\"\n\t\t\t\t\t\tclass=\"wp-image-703\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t</ul>\n</figure>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-5.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-5.serialized.html
new file mode 100644
index 0000000000..74fb0a124f
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-5.serialized.html
@@ -0,0 +1,13 @@
+<!-- wp:gallery {"linkTo":"media"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":705,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":704,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":703,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-5.server.html b/data/blocks/fixtures/core__gallery__deprecated-5.server.html
new file mode 100644
index 0000000000..57c42cc3bd
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-5.server.html
@@ -0,0 +1,48 @@
+
+<figure class="wp-block-gallery columns-3 is-cropped wp-block-gallery-1 is-layout-flex">
+	<ul class="blocks-gallery-grid">
+		<li class="blocks-gallery-item">
+			<figure>
+				<a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg" >
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"
+						alt=""
+						data-id="705"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg"
+						data-link="http://wptest.local/classic/test-image-3/"
+						class="wp-image-705"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg" >
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"
+						alt=""
+						data-id="704"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg"
+						data-link="http://wptest.local/test-image-2/"
+						class="wp-image-704"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a href="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg" >
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"
+						alt=""
+						data-id="703"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg"
+						data-link="http://wptest.local/test-image/"
+						class="wp-image-703"
+					/>
+				</a>
+			</figure>
+		</li>
+	</ul>
+</figure>
+
diff --git a/data/blocks/fixtures/core__gallery__deprecated-6.html b/data/blocks/fixtures/core__gallery__deprecated-6.html
new file mode 100644
index 0000000000..0dcf604233
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-6.html
@@ -0,0 +1,54 @@
+<!-- wp:gallery {"ids":[705,704,703],"linkTo":"media"} -->
+<figure class="wp-block-gallery columns-3 is-cropped">
+	<ul class="blocks-gallery-grid">
+		<li class="blocks-gallery-item">
+			<figure>
+				<a
+					href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg"
+				>
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"
+						alt=""
+						data-id="705"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg"
+						data-link="http://wptest.local/classic/test-image-3/"
+						class="wp-image-705"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a
+					href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg"
+				>
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"
+						alt=""
+						data-id="704"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg"
+						data-link="http://wptest.local/test-image-2/"
+						class="wp-image-704"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a
+					href="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg"
+				>
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"
+						alt=""
+						data-id="703"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg"
+						data-link="http://wptest.local/test-image/"
+						class="wp-image-703"
+					/>
+				</a>
+			</figure>
+		</li>
+	</ul>
+</figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-6.json b/data/blocks/fixtures/core__gallery__deprecated-6.json
new file mode 100644
index 0000000000..9ef1f03ba0
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-6.json
@@ -0,0 +1,57 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"caption": "",
+			"imageCrop": true,
+			"linkTo": "media",
+			"sizeSlug": "large",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"id": 705,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"id": 704,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"id": 703,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-6.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-6.parsed.json
new file mode 100644
index 0000000000..2b42128d65
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-6.parsed.json
@@ -0,0 +1,21 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"ids": [ 705, 704, 703 ],
+			"linkTo": "media"
+		},
+		"innerBlocks": [],
+		"innerHTML": "\n<figure class=\"wp-block-gallery columns-3 is-cropped\">\n\t<ul class=\"blocks-gallery-grid\">\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a\n\t\t\t\t\thref=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"705\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/classic/test-image-3/\"\n\t\t\t\t\t\tclass=\"wp-image-705\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a\n\t\t\t\t\thref=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"704\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image-2/\"\n\t\t\t\t\t\tclass=\"wp-image-704\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a\n\t\t\t\t\thref=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"703\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image/\"\n\t\t\t\t\t\tclass=\"wp-image-703\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t</ul>\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery columns-3 is-cropped\">\n\t<ul class=\"blocks-gallery-grid\">\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a\n\t\t\t\t\thref=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"705\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/classic/test-image-3/\"\n\t\t\t\t\t\tclass=\"wp-image-705\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a\n\t\t\t\t\thref=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"704\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image-2/\"\n\t\t\t\t\t\tclass=\"wp-image-704\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t\t<li class=\"blocks-gallery-item\">\n\t\t\t<figure>\n\t\t\t\t<a\n\t\t\t\t\thref=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\"\n\t\t\t\t>\n\t\t\t\t\t<img\n\t\t\t\t\t\tsrc=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"\n\t\t\t\t\t\talt=\"\"\n\t\t\t\t\t\tdata-id=\"703\"\n\t\t\t\t\t\tdata-full-url=\"http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg\"\n\t\t\t\t\t\tdata-link=\"http://wptest.local/test-image/\"\n\t\t\t\t\t\tclass=\"wp-image-703\"\n\t\t\t\t\t/>\n\t\t\t\t</a>\n\t\t\t</figure>\n\t\t</li>\n\t</ul>\n</figure>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-6.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-6.serialized.html
new file mode 100644
index 0000000000..74fb0a124f
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-6.serialized.html
@@ -0,0 +1,13 @@
+<!-- wp:gallery {"linkTo":"media"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":705,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":704,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":703,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-6.server.html b/data/blocks/fixtures/core__gallery__deprecated-6.server.html
new file mode 100644
index 0000000000..9175cfa561
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-6.server.html
@@ -0,0 +1,54 @@
+
+<figure class="wp-block-gallery columns-3 is-cropped wp-block-gallery-1 is-layout-flex">
+	<ul class="blocks-gallery-grid">
+		<li class="blocks-gallery-item">
+			<figure>
+				<a
+					href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg"
+				>
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"
+						alt=""
+						data-id="705"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-scaled.jpg"
+						data-link="http://wptest.local/classic/test-image-3/"
+						class="wp-image-705"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a
+					href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg"
+				>
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"
+						alt=""
+						data-id="704"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-scaled.jpg"
+						data-link="http://wptest.local/test-image-2/"
+						class="wp-image-704"
+					/>
+				</a>
+			</figure>
+		</li>
+		<li class="blocks-gallery-item">
+			<figure>
+				<a
+					href="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg"
+				>
+					<img
+						src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"
+						alt=""
+						data-id="703"
+						data-full-url="http://wptest.local/wp-content/uploads/2020/04/test-image-scaled.jpg"
+						data-link="http://wptest.local/test-image/"
+						class="wp-image-703"
+					/>
+				</a>
+			</figure>
+		</li>
+	</ul>
+</figure>
+
diff --git a/data/blocks/fixtures/core__gallery__deprecated-7.html b/data/blocks/fixtures/core__gallery__deprecated-7.html
new file mode 100644
index 0000000000..61b70f3385
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-7.html
@@ -0,0 +1,31 @@
+<!-- wp:gallery {"linkTo":"media"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped">
+	<!-- wp:image {"id":705,"sizeSlug":"large","linkDestination":"media"} -->
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+	<!-- /wp:image -->
+	
+	<!-- wp:image {"id":704,"sizeSlug":"large","linkDestination":"media"} -->
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+	<!-- /wp:image -->
+	
+	<!-- wp:image {"id":703,"sizeSlug":"large","linkDestination":"media"} -->
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+	<!-- /wp:image -->
+</figure>
+<!-- /wp:gallery -->
+<!-- wp:gallery {"linkTo":"media"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped">
+	<!-- wp:image {"id":705,"sizeSlug":"large","linkDestination":"media"} -->
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+	<!-- /wp:image -->
+	
+	<!-- wp:image {"id":704,"sizeSlug":"large","linkDestination":"media"} -->
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+	<!-- /wp:image -->
+	
+	<!-- wp:image {"id":703,"sizeSlug":"large","linkDestination":"media"} -->
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+	<!-- /wp:image -->
+	<figcaption class="blocks-gallery-caption">This gallery has a caption</figcaption>
+</figure>
+<!-- /wp:gallery -->
\ No newline at end of file
diff --git a/data/blocks/fixtures/core__gallery__deprecated-7.json b/data/blocks/fixtures/core__gallery__deprecated-7.json
new file mode 100644
index 0000000000..4eaf85b469
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-7.json
@@ -0,0 +1,120 @@
+[
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"images": [],
+			"ids": [],
+			"shortCodeTransforms": [],
+			"caption": "",
+			"imageCrop": true,
+			"fixedHeight": true,
+			"linkTo": "media",
+			"sizeSlug": "large",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"id": 705,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"id": 704,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"id": 703,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			}
+		]
+	},
+	{
+		"name": "core/gallery",
+		"isValid": true,
+		"attributes": {
+			"images": [],
+			"ids": [],
+			"shortCodeTransforms": [],
+			"caption": "This gallery has a caption",
+			"imageCrop": true,
+			"fixedHeight": true,
+			"linkTo": "media",
+			"sizeSlug": "large",
+			"allowResize": false
+		},
+		"innerBlocks": [
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg",
+					"id": 705,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg",
+					"id": 704,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			},
+			{
+				"name": "core/image",
+				"isValid": true,
+				"attributes": {
+					"url": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"alt": "",
+					"caption": "",
+					"href": "http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg",
+					"id": 703,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": []
+			}
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-7.parsed.json b/data/blocks/fixtures/core__gallery__deprecated-7.parsed.json
new file mode 100644
index 0000000000..f59684073d
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-7.parsed.json
@@ -0,0 +1,123 @@
+[
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"linkTo": "media"
+		},
+		"innerBlocks": [
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 705,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\" alt=\"\" class=\"wp-image-705\"/></a></figure>\n\t",
+				"innerContent": [
+					"\n\t\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\" alt=\"\" class=\"wp-image-705\"/></a></figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 704,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\" alt=\"\" class=\"wp-image-704\"/></a></figure>\n\t",
+				"innerContent": [
+					"\n\t\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\" alt=\"\" class=\"wp-image-704\"/></a></figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 703,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\" alt=\"\" class=\"wp-image-703\"/></a></figure>\n\t",
+				"innerContent": [
+					"\n\t\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\" alt=\"\" class=\"wp-image-703\"/></a></figure>\n\t"
+				]
+			}
+		],
+		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped\">\n\t\n\t\n\t\n\t\n\t\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped\">\n\t",
+			null,
+			"\n\t\n\t",
+			null,
+			"\n\t\n\t",
+			null,
+			"\n</figure>\n"
+		]
+	},
+	{
+		"blockName": null,
+		"attrs": {},
+		"innerBlocks": [],
+		"innerHTML": "\n",
+		"innerContent": [ "\n" ]
+	},
+	{
+		"blockName": "core/gallery",
+		"attrs": {
+			"linkTo": "media"
+		},
+		"innerBlocks": [
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 705,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\" alt=\"\" class=\"wp-image-705\"/></a></figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg\" alt=\"\" class=\"wp-image-705\"/></a></figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 704,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\" alt=\"\" class=\"wp-image-704\"/></a></figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg\" alt=\"\" class=\"wp-image-704\"/></a></figure>\n\t"
+				]
+			},
+			{
+				"blockName": "core/image",
+				"attrs": {
+					"id": 703,
+					"sizeSlug": "large",
+					"linkDestination": "media"
+				},
+				"innerBlocks": [],
+				"innerHTML": "\n\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\" alt=\"\" class=\"wp-image-703\"/></a></figure>\n\t",
+				"innerContent": [
+					"\n\t<figure class=\"wp-block-image size-large\"><a href=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\"><img src=\"http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg\" alt=\"\" class=\"wp-image-703\"/></a></figure>\n\t"
+				]
+			}
+		],
+		"innerHTML": "\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped\">\n\t\n\t\n\t\n\t\n\t\n\t<figcaption class=\"blocks-gallery-caption\">This gallery has a caption</figcaption>\n</figure>\n",
+		"innerContent": [
+			"\n<figure class=\"wp-block-gallery has-nested-images columns-default is-cropped\">\n\t",
+			null,
+			"\n\t\n\t",
+			null,
+			"\n\t\n\t",
+			null,
+			"\n\t<figcaption class=\"blocks-gallery-caption\">This gallery has a caption</figcaption>\n</figure>\n"
+		]
+	}
+]
diff --git a/data/blocks/fixtures/core__gallery__deprecated-7.serialized.html b/data/blocks/fixtures/core__gallery__deprecated-7.serialized.html
new file mode 100644
index 0000000000..0aed527cce
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-7.serialized.html
@@ -0,0 +1,27 @@
+<!-- wp:gallery {"linkTo":"media"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":705,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":704,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":703,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+<!-- /wp:image --></figure>
+<!-- /wp:gallery -->
+
+<!-- wp:gallery {"ids":[],"shortCodeTransforms":[],"linkTo":"media"} -->
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped"><!-- wp:image {"id":705,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":704,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+<!-- /wp:image -->
+
+<!-- wp:image {"id":703,"sizeSlug":"large","linkDestination":"media"} -->
+<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+<!-- /wp:image --><figcaption class="blocks-gallery-caption wp-element-caption">This gallery has a caption</figcaption></figure>
+<!-- /wp:gallery -->
diff --git a/data/blocks/fixtures/core__gallery__deprecated-7.server.html b/data/blocks/fixtures/core__gallery__deprecated-7.server.html
new file mode 100644
index 0000000000..d3fa62fdf5
--- /dev/null
+++ b/data/blocks/fixtures/core__gallery__deprecated-7.server.html
@@ -0,0 +1,15 @@
+
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped wp-block-gallery-1 is-layout-flex">
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img data-id="705"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img data-id="704"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+		<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img data-id="703"  src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+</figure>
+
+
+<figure class="wp-block-gallery has-nested-images columns-default is-cropped wp-block-gallery-1 is-layout-flex">
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg"><img data-id="705"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1-682x1024.jpg" alt="" class="wp-image-705"/></a></figure>
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg"><img data-id="704"  src="http://wptest.local/wp-content/uploads/2020/09/test-image-edited-1024x682.jpg" alt="" class="wp-image-704"/></a></figure>
+	<figure class="wp-block-image size-large"><a href="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg"><img data-id="703"  src="http://wptest.local/wp-content/uploads/2020/04/test-image-1024x683.jpg" alt="" class="wp-image-703"/></a></figure>
+	<figcaption class="blocks-gallery-caption">This gallery has a caption</figcaption>
+</figure>
+
diff --git a/data/blocks/fixtures/core__heading__h2-em.server.html b/data/blocks/fixtures/core__heading__h2-em.server.html
index b67b8225a5..1b47cd7b0b 100644
--- a/data/blocks/fixtures/core__heading__h2-em.server.html
+++ b/data/blocks/fixtures/core__heading__h2-em.server.html
@@ -1,3 +1,3 @@
 
-<h2>The <em>Inserter</em> Tool</h2>
+<h2 class="wp-block-heading">The <em>Inserter</em> Tool</h2>
 
diff --git a/data/blocks/fixtures/core__heading__h2.server.html b/data/blocks/fixtures/core__heading__h2.server.html
index d0ea06ef06..b99dc3b87d 100644
--- a/data/blocks/fixtures/core__heading__h2.server.html
+++ b/data/blocks/fixtures/core__heading__h2.server.html
@@ -1,3 +1,3 @@
 
-<h2>A picture is worth a thousand words, or so the saying goes</h2>
+<h2 class="wp-block-heading">A picture is worth a thousand words, or so the saying goes</h2>
 
diff --git a/data/blocks/pattern-directory/browse-all.json b/data/blocks/pattern-directory/browse-all.json
index 8d0d2d4ba3..27dca1b4b3 100644
--- a/data/blocks/pattern-directory/browse-all.json
+++ b/data/blocks/pattern-directory/browse-all.json
@@ -10,7 +10,8 @@
 			"spay_email": "",
 			"wpop_description": "A heading preceded by a chapter number, and followed by a paragraph.",
 			"wpop_keywords": "blog post",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": [ "core/heading" ]
 		},
 		"category_slugs": [ "text" ],
 		"keyword_slugs": [ "core" ],
@@ -27,7 +28,8 @@
 			"spay_email": "",
 			"wpop_description": "A large hero section with an example background image and a heading in the center.",
 			"wpop_keywords": "header, hero",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "header" ],
 		"keyword_slugs": [ "core" ],
@@ -44,7 +46,8 @@
 			"spay_email": "",
 			"wpop_description": "A large hero section with a bright gradient background, a big heading and a filled button.",
 			"wpop_keywords": "call to action, hero section",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "header" ],
 		"keyword_slugs": [ "core" ],
diff --git a/data/blocks/pattern-directory/browse-category-2.json b/data/blocks/pattern-directory/browse-category-2.json
index 1fce1a0f80..f5d4b289db 100644
--- a/data/blocks/pattern-directory/browse-category-2.json
+++ b/data/blocks/pattern-directory/browse-category-2.json
@@ -10,7 +10,8 @@
 			"spay_email": "",
 			"wpop_description": "Three filled buttons with rounded corners, side by side.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 600
+			"wpop_viewport_width": 600,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "buttons" ],
 		"keyword_slugs": [ "core" ],
@@ -27,7 +28,8 @@
 			"spay_email": "",
 			"wpop_description": "Two buttons, one filled and one outlined, side by side.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 500
+			"wpop_viewport_width": 500,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "buttons" ],
 		"keyword_slugs": [ "core" ],
diff --git a/data/blocks/pattern-directory/browse-keyword-11.json b/data/blocks/pattern-directory/browse-keyword-11.json
index 383d7eff61..360dcdfb84 100644
--- a/data/blocks/pattern-directory/browse-keyword-11.json
+++ b/data/blocks/pattern-directory/browse-keyword-11.json
@@ -10,7 +10,8 @@
 			"spay_email": "",
 			"wpop_description": "A heading preceded by a chapter number, and followed by a paragraph.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "text" ],
 		"keyword_slugs": [ "core" ],
@@ -27,7 +28,8 @@
 			"spay_email": "",
 			"wpop_description": "A large hero section with an example background image and a heading in the center.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "header" ],
 		"keyword_slugs": [ "core" ],
@@ -44,7 +46,8 @@
 			"spay_email": "",
 			"wpop_description": "A large hero section with a bright gradient background, a big heading and a filled button.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "header" ],
 		"keyword_slugs": [ "core" ],
diff --git a/data/blocks/pattern-directory/search-button.json b/data/blocks/pattern-directory/search-button.json
index 10e5c6036f..4a6f86de8a 100644
--- a/data/blocks/pattern-directory/search-button.json
+++ b/data/blocks/pattern-directory/search-button.json
@@ -10,7 +10,8 @@
 			"spay_email": "",
 			"wpop_description": "A large hero section with a bright gradient background, a big heading and a filled button.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "header" ],
 		"keyword_slugs": [ "core" ],
@@ -27,7 +28,8 @@
 			"spay_email": "",
 			"wpop_description": "Three small columns of text, each with an outlined button with rounded corners at the bottom.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 1000
+			"wpop_viewport_width": 1000,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "columns" ],
 		"keyword_slugs": [ "core" ],
@@ -44,7 +46,8 @@
 			"spay_email": "",
 			"wpop_description": "Three filled buttons with rounded corners, side by side.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 600
+			"wpop_viewport_width": 600,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "buttons" ],
 		"keyword_slugs": [ "core" ],
@@ -61,7 +64,8 @@
 			"spay_email": "",
 			"wpop_description": "Two buttons, one filled and one outlined, side by side.",
 			"wpop_keywords": "",
-			"wpop_viewport_width": 500
+			"wpop_viewport_width": 500,
+			"wpop_block_types": []
 		},
 		"category_slugs": [ "buttons" ],
 		"keyword_slugs": [ "core" ],
diff --git a/data/feed/wordpress-org-news.xml b/data/feed/wordpress-org-news.xml
index 1173c71bd7..75ca75f0a1 100644
--- a/data/feed/wordpress-org-news.xml
+++ b/data/feed/wordpress-org-news.xml
@@ -843,7 +843,7 @@
 
 
 
-<ul><li>The <a href="https://make.wordpress.org/updates/2020/10/20/quarterly-updates-q3-2020/">Q3 2020 update</a> from the WordPress project is now out!</li><li>The <a href="https://make.wordpress.org/marketing/">WordPress Marketing team</a> has put together a list of <a href="https://github.com/wpmarketingteam/WP5.5">WordPress 5.5 marketing resources</a> consisting of video presentations, slides, questions &amp; answers, social media posts, and more &#8211; aimed at both developers and non-developers. The team has also prepared a list of <a href="https://www.youtube.com/playlist?list=PLCVEqsAbLffcS1Rx-COZ5CZBOmXZJEe6k">captioned screen-recordings</a> in several languages to aid new contributors. Contact the team on the <a href="https://wordpress.slack.com/archives/C0GKJ7TFA">#marketing</a> channel if you would like to contribute to these and upcoming projects.&nbsp;</li><li>The <a href="https://make.wordpress.org/core">WordPress Core team</a> has <a href="https://make.wordpress.org/core/2020/09/23/proposal-rest-api-authentication-application-passwords/">announced a proposal</a> to introduce application passwords for REST API integrations.</li><li>Five online WordCamps took place in October: <a href="https://2020.rochester.wordcamp.org/">WordCamp Rochester, NY</a>, <a href="https://austin.wordcamp.org/2020/">WordCamp Austin, TX</a>, <a href="https://2020.italia.wordcamp.org/">WordCamp Italia Online</a>, <a href="https://la.wordcamp.org/2020/">WordCamp Los Angeles, CA</a>, and <a href="https://bulgaria.wordcamp.org/2020/">WordCamp Bulgaria Online</a>. You can find livestream recaps of these camps on their websites. The camps are also in the process of uploading their videos to <a href="https://wordpress.tv/">WordPress.tv</a>. Check out the <a href="https://central.wordcamp.org/schedule/">WordCamp Schedule</a> to catch up with upcoming online WordCamps.</li><li>Contributor teams have started work on <a href="https://make.wordpress.org/core/2020/10/22/twenty-twenty-one-dark-mode-discussion/">adding dark mode support for the Twenty Twenty One theme</a>. Additionally, the development of the <a href="https://make.wordpress.org/themes/2020/10/23/developing-the-full-site-editing-version-of-twenty-twenty-one/">Full Site Editing version of Twenty Twenty One</a> has also kicked-off in the <a href="https://github.com/WordPress/theme-experiments/tree/master/twentytwentyone-blocks">Theme Experiments GitHub repository</a>.</li><li><a href="https://buddypress.org/2020/10/buddypress-7-0-0-beta1/">BuddyPress 7.0 beta</a>, which comes with new administration screens, blocks, and improved CLI support &#8211; is now available!&nbsp;</li><li>The Core team is <a href="https://make.wordpress.org/core/2020/10/06/revisiting-starter-content-on-org-and-beyond/">revisiting starter content for WordPress themes</a> as part of the 5.6 release. The team also decided not to ship the widgets screen in WordPress 5.6 and have started discussions on <a href="https://make.wordpress.org/core/2020/10/29/discussion-align-the-wordpress-release-cycle-with-the-industry-standard/">aligning the WordPress release cycle with industry standards</a>.</li><li>WordPress Accessibility enthusiasts all over the world joined hands for the first ever 24 hour <a href="https://wpaccessibilityday.org/">WP Accessibility day</a> event on Oct. 2. You can find the recorded livestream of the event on its <a href="https://www.youtube.com/channel/UCes9XCUZd51CAigbBEGlfNg/featured?view_as=subscriber">YouTube channel</a>.</li><li>The <a href="https://make.wordpress.org/meta">Meta</a> team has <a href="https://make.wordpress.org/meta/2020/10/27/block-pattern-directory-ideas-and-discussion/">kicked off a discussion</a> on setting up a <a href="https://developer.wordpress.org/block-editor/developers/block-api/block-patterns/">Block pattern</a> directory (similar to the <a href="https://wordpress.org/support/article/block-directory/">existing block directory</a>).&nbsp;</li><li>The <a href="https://make.wordpress.org/themes">Themes</a> team has published a post clarifying <a href="https://make.wordpress.org/themes/2020/10/07/block-based-themes-and-wordpress-5-6/">how Block based themes will work with WordPress 5.6</a>. Check out the <a href="https://developer.wordpress.org/block-editor/tutorials/block-based-themes/">block-based theme tutorial</a> and its <a href="https://github.com/WordPress/gutenberg/blob/master/docs/designers-developers/developers/themes/block-based-themes.md">documentation</a> to learn how to build block-based themes.&nbsp;</li></ul>
+<ul><li>The <a href="https://make.wordpress.org/updates/2020/10/20/quarterly-updates-q3-2020/">Q3 2020 update</a> from the WordPress project is now out!</li><li>The <a href="https://make.wordpress.org/marketing/">WordPress Marketing team</a> has put together a list of <a href="https://github.com/wpmarketingteam/WP5.5">WordPress 5.5 marketing resources</a> consisting of video presentations, slides, questions &amp; answers, social media posts, and more &#8211; aimed at both developers and non-developers. The team has also prepared a list of <a href="https://www.youtube.com/playlist?list=PLCVEqsAbLffcS1Rx-COZ5CZBOmXZJEe6k">captioned screen-recordings</a> in several languages to aid new contributors. Contact the team on the <a href="https://wordpress.slack.com/archives/C0GKJ7TFA">#marketing</a> channel if you would like to contribute to these and upcoming projects.&nbsp;</li><li>The <a href="https://make.wordpress.org/core">WordPress Core team</a> has <a href="https://make.wordpress.org/core/2020/09/23/proposal-rest-api-authentication-application-passwords/">announced a proposal</a> to introduce application passwords for REST API integrations.</li><li>Five online WordCamps took place in October: <a href="https://2020.rochester.wordcamp.org/">WordCamp Rochester, NY</a>, <a href="https://austin.wordcamp.org/2020/">WordCamp Austin, TX</a>, <a href="https://2020.italia.wordcamp.org/">WordCamp Italia Online</a>, <a href="https://la.wordcamp.org/2020/">WordCamp Los Angeles, CA</a>, and <a href="https://bulgaria.wordcamp.org/2020/">WordCamp Bulgaria Online</a>. You can find livestream recaps of these camps on their websites. The camps are also in the process of uploading their videos to <a href="https://wordpress.tv/">WordPress.tv</a>. Check out the <a href="https://central.wordcamp.org/schedule/">WordCamp Schedule</a> to catch up with upcoming online WordCamps.</li><li>Contributor teams have started work on <a href="https://make.wordpress.org/core/2020/10/22/twenty-twenty-one-dark-mode-discussion/">adding dark mode support for the Twenty Twenty One theme</a>. Additionally, the development of the <a href="https://make.wordpress.org/themes/2020/10/23/developing-the-full-site-editing-version-of-twenty-twenty-one/">Full Site Editing version of Twenty Twenty One</a> has also kicked-off in the <a href="https://github.com/WordPress/theme-experiments/tree/master/twentytwentyone-blocks">Theme Experiments GitHub repository</a>.</li><li><a href="https://buddypress.org/2020/10/buddypress-7-0-0-beta1/">BuddyPress 7.0 beta</a>, which comes with new administration screens, blocks, and improved CLI support &#8211; is now available!&nbsp;</li><li>The Core team is <a href="https://make.wordpress.org/core/2020/10/06/revisiting-starter-content-on-org-and-beyond/">revisiting starter content for WordPress themes</a> as part of the 5.6 release. The team also decided not to ship the widgets screen in WordPress 5.6 and have started discussions on <a href="https://make.wordpress.org/core/2020/10/29/discussion-align-the-wordpress-release-cycle-with-the-industry-standard/">aligning the WordPress release cycle with industry standards</a>.</li><li>WordPress Accessibility enthusiasts all over the world joined hands for the first ever 24 hour <a href="https://wpaccessibilityday.org/">WP Accessibility day</a> event on Oct. 2. You can find the recorded livestream of the event on its <a href="https://www.youtube.com/channel/UCes9XCUZd51CAigbBEGlfNg/featured?view_as=subscriber">YouTube channel</a>.</li><li>The <a href="https://make.wordpress.org/meta">Meta</a> team has <a href="https://make.wordpress.org/meta/2020/10/27/block-pattern-directory-ideas-and-discussion/">kicked off a discussion</a> on setting up a <a href="https://developer.wordpress.org/block-editor/developers/block-api/block-patterns/">Block pattern</a> directory (similar to the <a href="https://wordpress.org/documentation/article/block-directory/">existing block directory</a>).&nbsp;</li><li>The <a href="https://make.wordpress.org/themes">Themes</a> team has published a post clarifying <a href="https://make.wordpress.org/themes/2020/10/07/block-based-themes-and-wordpress-5-6/">how Block based themes will work with WordPress 5.6</a>. Check out the <a href="https://developer.wordpress.org/block-editor/tutorials/block-based-themes/">block-based theme tutorial</a> and its <a href="https://github.com/WordPress/gutenberg/blob/master/docs/designers-developers/developers/themes/block-based-themes.md">documentation</a> to learn how to build block-based themes.&nbsp;</li></ul>
 
 
 
diff --git a/data/images/test-square-150.jpg b/data/images/test-square-150.jpg
new file mode 100644
index 0000000000..eb60092267
Binary files /dev/null and b/data/images/test-square-150.jpg differ
diff --git a/data/themedir1/block-theme-child-with-fluid-typography-config/style.css b/data/themedir1/block-theme-child-with-fluid-typography-config/style.css
new file mode 100644
index 0000000000..ae4ca9fd83
--- /dev/null
+++ b/data/themedir1/block-theme-child-with-fluid-typography-config/style.css
@@ -0,0 +1,8 @@
+/*
+Theme Name: Block Theme Child Theme With Fluid Typography Config
+Theme URI: https://wordpress.org/
+Description: For testing purposes only.
+Template: block-theme
+Version: 1.0.0
+Text Domain: block-theme-child-with-fluid-typography
+*/
diff --git a/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json b/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json
new file mode 100644
index 0000000000..d0ec32d9ca
--- /dev/null
+++ b/data/themedir1/block-theme-child-with-fluid-typography-config/theme.json
@@ -0,0 +1,11 @@
+{
+	"version": 2,
+	"settings": {
+		"appearanceTools": true,
+		"typography": {
+			"fluid": {
+				"minFontSize": "16px"
+			}
+		}
+	}
+}
diff --git a/data/themedir1/block-theme-child/styles/variation-b.json b/data/themedir1/block-theme-child/styles/variation-b.json
new file mode 100644
index 0000000000..0a8a4fcab9
--- /dev/null
+++ b/data/themedir1/block-theme-child/styles/variation-b.json
@@ -0,0 +1,18 @@
+{
+	"version": 2,
+	"settings": {
+		"blocks": {
+			"core/post-title": {
+				"color": {
+					"palette": [
+						{
+							"slug": "dark",
+							"name": "Dark",
+							"color": "#010101"
+						}
+					]
+				}
+			}
+		}
+	}
+}
diff --git a/data/themedir1/block-theme-non-latin/index.php b/data/themedir1/block-theme-non-latin/index.php
new file mode 100644
index 0000000000..589adcefcd
--- /dev/null
+++ b/data/themedir1/block-theme-non-latin/index.php
@@ -0,0 +1,4 @@
+<?php
+/**
+ * Block theme.
+ */
diff --git a/data/themedir1/block-theme-non-latin/page-1.php b/data/themedir1/block-theme-non-latin/page-1.php
new file mode 100644
index 0000000000..eafbb1b6e8
--- /dev/null
+++ b/data/themedir1/block-theme-non-latin/page-1.php
@@ -0,0 +1,3 @@
+<?php
+
+echo 'PHP template for page with ID 1';
diff --git a/data/themedir1/block-theme-non-latin/parts/small-header-test.html b/data/themedir1/block-theme-non-latin/parts/small-header-test.html
new file mode 100644
index 0000000000..5c18e98125
--- /dev/null
+++ b/data/themedir1/block-theme-non-latin/parts/small-header-test.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>Small Header Template Part</p>
+<!-- /wp:paragraph -->
\ No newline at end of file
diff --git a/data/themedir1/block-theme-non-latin/style.css b/data/themedir1/block-theme-non-latin/style.css
new file mode 100644
index 0000000000..4de5f009a5
--- /dev/null
+++ b/data/themedir1/block-theme-non-latin/style.css
@@ -0,0 +1,7 @@
+/*
+Theme Name: Block Theme Non Latin
+Theme URI: https://wordpress.org/
+Description: Has different characters in theme directory name for testing purposes.
+Version: 0.0.1
+Text Domain: block-theme
+*/
diff --git a/data/themedir1/block-theme-non-latin/templates/page-test.html b/data/themedir1/block-theme-non-latin/templates/page-test.html
new file mode 100644
index 0000000000..1aca9fe8ab
--- /dev/null
+++ b/data/themedir1/block-theme-non-latin/templates/page-test.html
@@ -0,0 +1,3 @@
+<!-- wp:paragraph -->
+<p>(测试) Page Template</p>
+<!-- /wp:paragraph -->
diff --git a/data/themedir1/block-theme-non-latin/theme.json b/data/themedir1/block-theme-non-latin/theme.json
new file mode 100644
index 0000000000..f0c59a63ab
--- /dev/null
+++ b/data/themedir1/block-theme-non-latin/theme.json
@@ -0,0 +1,80 @@
+{
+	"version": 1,
+	"settings": {
+		"color": {
+			"palette": [
+				{
+					"slug": "light",
+					"name": "Light",
+					"color": "#f5f7f9"
+				},
+				{
+					"slug": "dark",
+					"name": "Dark",
+					"color": "#000"
+				}
+			],
+			"gradients": [
+				{
+					"name": "Custom gradient",
+					"gradient": "linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%)",
+					"slug": "custom-gradient"
+				}
+			],
+			"custom": false,
+			"customGradient": false
+		},
+		"typography": {
+			"fontSizes": [
+				{
+					"name": "Custom",
+					"slug": "custom",
+					"size": "100px"
+				}
+			],
+			"customFontSize": false,
+			"customLineHeight": true
+		},
+		"spacing": {
+			"units": [
+				"rem"
+			],
+			"customPadding": true
+		},
+		"blocks": {
+			"core/paragraph": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f5f7f9"
+						}
+					]
+				}
+			}
+		}
+	},
+	"customTemplates": [
+		{
+			"name": "page-τεστ",
+			"title": "Homepage template"
+		},
+		{
+			"name": "page-测试",
+			"title": "Homepage template"
+		}
+	],
+	"templateParts": [
+		{
+			"name": "small-header-τεστ",
+			"title": "Small Header",
+			"area": "header"
+		},
+		{
+			"name": "small-header-测试",
+			"title": "Small Header",
+			"area": "header"
+		},
+	]
+}
diff --git a/data/themedir1/block-theme/styles/variation-b.json b/data/themedir1/block-theme/styles/variation-b.json
new file mode 100644
index 0000000000..340198ffe0
--- /dev/null
+++ b/data/themedir1/block-theme/styles/variation-b.json
@@ -0,0 +1,18 @@
+{
+	"version": 2,
+	"settings": {
+		"blocks": {
+			"core/post-title": {
+				"color": {
+					"palette": [
+						{
+							"slug": "light",
+							"name": "Light",
+							"color": "#f1f1f1"
+						}
+					]
+				}
+			}
+		}
+	}
+}
diff --git a/data/themedir1/block-theme/theme.json b/data/themedir1/block-theme/theme.json
index d023faec53..76d075aab7 100644
--- a/data/themedir1/block-theme/theme.json
+++ b/data/themedir1/block-theme/theme.json
@@ -124,4 +124,4 @@
 			"area": "header"
 		}
 	]
-}
\ No newline at end of file
+}
diff --git a/includes/abstract-testcase.php b/includes/abstract-testcase.php
index bae787a42d..2c1b4a1d58 100644
--- a/includes/abstract-testcase.php
+++ b/includes/abstract-testcase.php
@@ -194,6 +194,10 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 		remove_filter( 'wp_die_handler', array( $this, 'get_wp_die_handler' ) );
 		$this->_restore_hooks();
 		wp_set_current_user( 0 );
+
+		$lazyloader = wp_metadata_lazyloader();
+		$lazyloader->reset_queue( 'term' );
+		$lazyloader->reset_queue( 'comment' );
 	}
 
 	/**
@@ -319,47 +323,55 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 	}
 
 	/**
-	 * Saves the action and filter-related globals so they can be restored later.
+	 * Saves the hook-related globals so they can be restored later.
 	 *
-	 * Stores $wp_actions, $wp_current_filter, and $wp_filter on a class variable
-	 * so they can be restored on tear_down() using _restore_hooks().
+	 * Stores $wp_filter, $wp_actions, $wp_filters, and $wp_current_filter
+	 * on a class variable so they can be restored on tear_down() using _restore_hooks().
 	 *
+	 * @global array $wp_filter
 	 * @global array $wp_actions
+	 * @global array $wp_filters
 	 * @global array $wp_current_filter
-	 * @global array $wp_filter
 	 */
 	protected function _backup_hooks() {
-		$globals = array( 'wp_actions', 'wp_current_filter' );
-		foreach ( $globals as $key ) {
-			self::$hooks_saved[ $key ] = $GLOBALS[ $key ];
-		}
 		self::$hooks_saved['wp_filter'] = array();
+
 		foreach ( $GLOBALS['wp_filter'] as $hook_name => $hook_object ) {
 			self::$hooks_saved['wp_filter'][ $hook_name ] = clone $hook_object;
 		}
+
+		$globals = array( 'wp_actions', 'wp_filters', 'wp_current_filter' );
+
+		foreach ( $globals as $key ) {
+			self::$hooks_saved[ $key ] = $GLOBALS[ $key ];
+		}
 	}
 
 	/**
 	 * Restores the hook-related globals to their state at set_up()
 	 * so that future tests aren't affected by hooks set during this last test.
 	 *
+	 * @global array $wp_filter
 	 * @global array $wp_actions
+	 * @global array $wp_filters
 	 * @global array $wp_current_filter
-	 * @global array $wp_filter
 	 */
 	protected function _restore_hooks() {
-		$globals = array( 'wp_actions', 'wp_current_filter' );
-		foreach ( $globals as $key ) {
-			if ( isset( self::$hooks_saved[ $key ] ) ) {
-				$GLOBALS[ $key ] = self::$hooks_saved[ $key ];
-			}
-		}
 		if ( isset( self::$hooks_saved['wp_filter'] ) ) {
 			$GLOBALS['wp_filter'] = array();
+
 			foreach ( self::$hooks_saved['wp_filter'] as $hook_name => $hook_object ) {
 				$GLOBALS['wp_filter'][ $hook_name ] = clone $hook_object;
 			}
 		}
+
+		$globals = array( 'wp_actions', 'wp_filters', 'wp_current_filter' );
+
+		foreach ( $globals as $key ) {
+			if ( isset( self::$hooks_saved[ $key ] ) ) {
+				$GLOBALS[ $key ] = self::$hooks_saved[ $key ];
+			}
+		}
 	}
 
 	/**
@@ -387,9 +399,11 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 				'blog_meta',
 				'global-posts',
 				'networks',
+				'network-queries',
 				'sites',
 				'site-details',
 				'site-options',
+				'site-queries',
 				'site-transient',
 				'rss',
 				'users',
@@ -401,7 +415,7 @@ abstract class WP_UnitTestCase_Base extends PHPUnit_Adapter_TestCase {
 			)
 		);
 
-		wp_cache_add_non_persistent_groups( array( 'counts', 'plugins' ) );
+		wp_cache_add_non_persistent_groups( array( 'counts', 'plugins', 'theme_json' ) );
 	}
 
 	/**
diff --git a/includes/object-cache.php b/includes/object-cache.php
index c9e51e6d4b..f9e2c4693e 100644
--- a/includes/object-cache.php
+++ b/includes/object-cache.php
@@ -977,21 +977,22 @@ class WP_Object_Cache {
 		}
 
 		$derived_key = $this->buildKey( $key, $group );
-		$expiration  = $this->sanitize_expiration( $expiration );
+
+		// Add does not set the value if the key exists; mimic that here.
+		if ( isset( $this->cache[ $derived_key ] ) ) {
+			return false;
+		}
 
 		// If group is a non-Memcached group, save to runtime cache, not Memcached.
 		if ( in_array( $group, $this->no_mc_groups, true ) ) {
 
-			// Add does not set the value if the key exists; mimic that here.
-			if ( isset( $this->cache[ $derived_key ] ) ) {
-				return false;
-			}
-
 			$this->add_to_internal_cache( $derived_key, $value );
 
 			return true;
 		}
 
+		$expiration = $this->sanitize_expiration( $expiration );
+
 		// Save to Memcached.
 		if ( $by_key ) {
 			$result = $this->m->addByKey( $server_key, $derived_key, $value, $expiration );
@@ -1180,7 +1181,6 @@ class WP_Object_Cache {
 	 */
 	public function cas( $cas_token, $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
-		$expiration  = $this->sanitize_expiration( $expiration );
 
 		/**
 		 * If group is a non-Memcached group, save to runtime cache, not Memcached. Note
@@ -1192,6 +1192,8 @@ class WP_Object_Cache {
 			return true;
 		}
 
+		$expiration = $this->sanitize_expiration( $expiration );
+
 		// Save to Memcached.
 		if ( $by_key ) {
 			$result = $this->m->casByKey( $cas_token, $server_key, $derived_key, $value, $expiration );
@@ -1905,7 +1907,6 @@ class WP_Object_Cache {
 	 */
 	public function replace( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
-		$expiration  = $this->sanitize_expiration( $expiration );
 
 		// If group is a non-Memcached group, save to runtime cache, not Memcached.
 		if ( in_array( $group, $this->no_mc_groups, true ) ) {
@@ -1919,6 +1920,8 @@ class WP_Object_Cache {
 			return true;
 		}
 
+		$expiration = $this->sanitize_expiration( $expiration );
+
 		// Save to Memcached.
 		if ( $by_key ) {
 			$result = $this->m->replaceByKey( $server_key, $derived_key, $value, $expiration );
@@ -1970,7 +1973,6 @@ class WP_Object_Cache {
 	 */
 	public function set( $key, $value, $group = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		$derived_key = $this->buildKey( $key, $group );
-		$expiration  = $this->sanitize_expiration( $expiration );
 
 		// If group is a non-Memcached group, save to runtime cache, not Memcached.
 		if ( in_array( $group, $this->no_mc_groups, true ) ) {
@@ -1978,6 +1980,8 @@ class WP_Object_Cache {
 			return true;
 		}
 
+		$expiration = $this->sanitize_expiration( $expiration );
+
 		// Save to Memcached.
 		if ( $by_key ) {
 			$result = $this->m->setByKey( $server_key, $derived_key, $value, $expiration );
@@ -2032,7 +2036,6 @@ class WP_Object_Cache {
 	public function setMulti( $items, $groups = 'default', $expiration = 0, $server_key = '', $by_key = false ) {
 		// Build final keys and replace $items keys with the new keys.
 		$derived_keys  = $this->buildKeys( array_keys( $items ), $groups );
-		$expiration    = $this->sanitize_expiration( $expiration );
 		$derived_items = array_combine( $derived_keys, $items );
 
 		// Do not add to memcached if in no_mc_groups.
@@ -2048,6 +2051,8 @@ class WP_Object_Cache {
 			}
 		}
 
+		$expiration = $this->sanitize_expiration( $expiration );
+
 		// Save to memcached.
 		if ( $by_key ) {
 			$result = $this->m->setMultiByKey( $server_key, $derived_items, $expiration );
diff --git a/includes/unregister-blocks-hooks.php b/includes/unregister-blocks-hooks.php
index df08612e8c..5edeba1445 100644
--- a/includes/unregister-blocks-hooks.php
+++ b/includes/unregister-blocks-hooks.php
@@ -21,6 +21,7 @@ remove_action( 'init', 'register_block_core_comments_title' );
 remove_action( 'init', 'register_block_core_cover' );
 remove_action( 'init', 'register_block_core_file' );
 remove_action( 'init', 'register_block_core_gallery' );
+remove_action( 'init', 'register_block_core_heading' );
 remove_action( 'init', 'register_block_core_home_link' );
 remove_action( 'init', 'register_block_core_image' );
 remove_action( 'init', 'register_block_core_latest_comments' );
@@ -33,6 +34,7 @@ remove_action( 'init', 'register_block_core_page_list' );
 remove_action( 'init', 'register_block_core_pattern' );
 remove_action( 'init', 'register_block_core_post_author' );
 remove_action( 'init', 'register_block_core_post_author_biography' );
+remove_action( 'init', 'register_block_core_post_author_name' );
 remove_action( 'init', 'register_block_core_post_comments_form' );
 remove_action( 'init', 'register_block_core_post_content' );
 remove_action( 'init', 'register_block_core_post_date' );
diff --git a/tests/admin/includesFile.php b/tests/admin/includesFile.php
index 5ff28ba90c..375f895c84 100644
--- a/tests/admin/includesFile.php
+++ b/tests/admin/includesFile.php
@@ -156,7 +156,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 				'code' => 200,
 			),
 			'headers'  => array(
-				'content-disposition' => 'attachment; filename="filename-from-content-disposition-header.txt"',
+				'Content-Disposition' => 'attachment; filename="filename-from-content-disposition-header.txt"',
 			),
 		);
 	}
@@ -174,7 +174,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 				'code' => 200,
 			),
 			'headers'  => array(
-				'content-disposition' => 'attachment; filename="../../filename-from-content-disposition-header.txt"',
+				'Content-Disposition' => 'attachment; filename="../../filename-from-content-disposition-header.txt"',
 			),
 		);
 	}
@@ -192,7 +192,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 				'code' => 200,
 			),
 			'headers'  => array(
-				'content-disposition' => 'attachment; filename=filename-from-content-disposition-header.txt',
+				'Content-Disposition' => 'attachment; filename=filename-from-content-disposition-header.txt',
 			),
 		);
 	}
@@ -241,7 +241,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 				'code' => 200,
 			),
 			'headers'  => array(
-				'content-disposition' => 'filename="filename-from-content-disposition-header.txt"',
+				'Content-Disposition' => 'filename="filename-from-content-disposition-header.txt"',
 			),
 		);
 	}
@@ -259,7 +259,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 				'code' => 200,
 			),
 			'headers'  => array(
-				'content-disposition' => 'inline; filename="filename-from-content-disposition-header.txt"',
+				'Content-Disposition' => 'inline; filename="filename-from-content-disposition-header.txt"',
 			),
 		);
 	}
@@ -277,7 +277,7 @@ class Tests_Admin_IncludesFile extends WP_UnitTestCase {
 				'code' => 200,
 			),
 			'headers'  => array(
-				'content-disposition' => 'form-data; name="file"; filename="filename-from-content-disposition-header.txt"',
+				'Content-Disposition' => 'form-data; name="file"; filename="filename-from-content-disposition-header.txt"',
 			),
 		);
 	}
diff --git a/tests/admin/includesTemplate.php b/tests/admin/includesTemplate.php
index 6b61639c35..ca769eb8b7 100644
--- a/tests/admin/includesTemplate.php
+++ b/tests/admin/includesTemplate.php
@@ -222,7 +222,7 @@ class Tests_Admin_IncludesTemplate extends WP_UnitTestCase {
 	 * @ticket 44941
 	 * @covers ::settings_errors
 	 * @global array $wp_settings_errors
-	 * @dataProvider settings_errors_css_classes_provider
+	 * @dataProvider data_settings_errors_css_classes
 	 */
 	public function test_settings_errors_css_classes( $type, $expected ) {
 		global $wp_settings_errors;
@@ -241,7 +241,7 @@ class Tests_Admin_IncludesTemplate extends WP_UnitTestCase {
 		$this->assertStringNotContainsString( 'notice-notice-', $output );
 	}
 
-	public function settings_errors_css_classes_provider() {
+	public function data_settings_errors_css_classes() {
 		return array(
 			array( 'error', 'notice-error' ),
 			array( 'success', 'notice-success' ),
diff --git a/tests/admin/includesUser.php b/tests/admin/includesUser.php
index 0b590377e9..c4f6f0c9c1 100644
--- a/tests/admin/includesUser.php
+++ b/tests/admin/includesUser.php
@@ -7,52 +7,82 @@
 class Tests_Admin_IncludesUser extends WP_UnitTestCase {
 
 	/**
-	 * @ticket       42790
+	 * Test redirect URLs for application password authorization requests.
+	 *
+	 * @ticket 42790
+	 * @ticket 52617
+	 *
+	 * @covers ::wp_is_authorize_application_password_request_valid
+	 *
 	 * @dataProvider data_is_authorize_application_password_request_valid
-	 * @param array  $request    The request data to validate.
-	 * @param string $error_code The expected error code, empty if no error.
+	 *
+	 * @param array  $request             The request data to validate.
+	 * @param string $expected_error_code The expected error code, empty if no error is expected.
+	 * @param string $env                 The environment type. Defaults to 'production'.
 	 */
-	public function test_is_authorize_application_password_request_valid( $request, $error_code ) {
-		$error = wp_is_authorize_application_password_request_valid( $request, get_userdata( 1 ) );
+	public function test_is_authorize_application_password_request_valid( $request, $expected_error_code, $env = 'production' ) {
+		putenv( "WP_ENVIRONMENT_TYPE=$env" );
 
-		if ( $error_code ) {
-			$this->assertWPError( $error );
-			$this->assertSame( $error_code, $error->get_error_code() );
+		$actual = wp_is_authorize_application_password_request_valid( $request, get_userdata( 1 ) );
+
+		putenv( 'WP_ENVIRONMENT_TYPE' );
+
+		if ( $expected_error_code ) {
+			$this->assertWPError( $actual, 'A WP_Error object is expected.' );
+			$this->assertSame( $expected_error_code, $actual->get_error_code(), 'Unexpected error code.' );
 		} else {
-			$this->assertNotWPError( $error );
+			$this->assertNotWPError( $actual, 'A WP_Error object is not expected.' );
 		}
 	}
 
 	public function data_is_authorize_application_password_request_valid() {
-		return array(
-			array(
-				array(),
-				'',
-			),
-			array(
-				array( 'success_url' => 'http://example.org' ),
-				'invalid_redirect_scheme',
-			),
-			array(
-				array( 'reject_url' => 'http://example.org' ),
-				'invalid_redirect_scheme',
-			),
-			array(
-				array( 'success_url' => 'https://example.org' ),
-				'',
-			),
-			array(
-				array( 'reject_url' => 'https://example.org' ),
-				'',
-			),
-			array(
-				array( 'success_url' => 'wordpress://example' ),
-				'',
-			),
-			array(
-				array( 'reject_url' => 'wordpress://example' ),
-				'',
-			),
-		);
+		$environment_types = array( 'local', 'development', 'staging', 'production' );
+
+		$datasets = array();
+		foreach ( $environment_types as $environment_type ) {
+			$datasets[ $environment_type . ' and no request arguments' ] = array(
+				'request'             => array(),
+				'expected_error_code' => '',
+				'env'                 => $environment_type,
+			);
+
+			$datasets[ $environment_type . ' and a "https" scheme "success_url"' ] = array(
+				'request'             => array( 'success_url' => 'https://example.org' ),
+				'expected_error_code' => '',
+				'env'                 => $environment_type,
+			);
+
+			$datasets[ $environment_type . ' and a "https" scheme "reject_url"' ] = array(
+				'request'             => array( 'reject_url' => 'https://example.org' ),
+				'expected_error_code' => '',
+				'env'                 => $environment_type,
+			);
+
+			$datasets[ $environment_type . ' and an app scheme "success_url"' ] = array(
+				'request'             => array( 'success_url' => 'wordpress://example' ),
+				'expected_error_code' => '',
+				'env'                 => $environment_type,
+			);
+
+			$datasets[ $environment_type . ' and an app scheme "reject_url"' ] = array(
+				'request'             => array( 'reject_url' => 'wordpress://example' ),
+				'expected_error_code' => '',
+				'env'                 => $environment_type,
+			);
+
+			$datasets[ $environment_type . ' and a "http" scheme "success_url"' ] = array(
+				'request'             => array( 'success_url' => 'http://example.org' ),
+				'expected_error_code' => 'local' === $environment_type ? '' : 'invalid_redirect_scheme',
+				'env'                 => $environment_type,
+			);
+
+			$datasets[ $environment_type . ' and a "http" scheme "reject_url"' ] = array(
+				'request'             => array( 'reject_url' => 'http://example.org' ),
+				'expected_error_code' => 'local' === $environment_type ? '' : 'invalid_redirect_scheme',
+				'env'                 => $environment_type,
+			);
+		}
+
+		return $datasets;
 	}
 }
diff --git a/tests/admin/wpAutomaticUpdater.php b/tests/admin/wpAutomaticUpdater.php
index 65bb39db2a..91ceaa1b38 100644
--- a/tests/admin/wpAutomaticUpdater.php
+++ b/tests/admin/wpAutomaticUpdater.php
@@ -572,4 +572,138 @@ class Tests_Admin_WpAutomaticUpdater extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::is_allowed_dir()` returns true
+	 * when the `open_basedir` directive is not set.
+	 *
+	 * @ticket 42619
+	 *
+	 * @covers WP_Automatic_Updater::is_allowed_dir
+	 */
+	public function test_is_allowed_dir_should_return_true_if_open_basedir_is_not_set() {
+		$this->assertTrue( self::$updater->is_allowed_dir( ABSPATH ) );
+	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::is_allowed_dir()` returns true
+	 * when the `open_basedir` directive is set and the path is allowed.
+	 *
+	 * Runs in a separate process to ensure that `open_basedir` changes
+	 * don't impact other tests should an error occur.
+	 *
+	 * This test does not preserve global state to prevent the exception
+	 * "Serialization of 'Closure' is not allowed" when running in
+	 * a separate process.
+	 *
+	 * @ticket 42619
+	 *
+	 * @covers WP_Automatic_Updater::is_allowed_dir
+	 *
+	 * @runInSeparateProcess
+	 * @preserveGlobalState disabled
+	 */
+	public function test_is_allowed_dir_should_return_true_if_open_basedir_is_set_and_path_is_allowed() {
+		// The repository for PHPUnit and test suite resources.
+		$abspath_parent      = trailingslashit( dirname( ABSPATH ) );
+		$abspath_grandparent = trailingslashit( dirname( $abspath_parent ) );
+
+		$open_basedir_backup = ini_get( 'open_basedir' );
+		// Allow access to the directory one level above the repository.
+		ini_set( 'open_basedir', wp_normalize_path( $abspath_grandparent ) );
+
+		// Checking an allowed directory should succeed.
+		$actual = self::$updater->is_allowed_dir( wp_normalize_path( ABSPATH ) );
+
+		ini_set( 'open_basedir', $open_basedir_backup );
+
+		$this->assertTrue( $actual );
+	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::is_allowed_dir()` returns false
+	 * when the `open_basedir` directive is set and the path is not allowed.
+	 *
+	 * Runs in a separate process to ensure that `open_basedir` changes
+	 * don't impact other tests should an error occur.
+	 *
+	 * This test does not preserve global state to prevent the exception
+	 * "Serialization of 'Closure' is not allowed" when running in
+	 * a separate process.
+	 *
+	 * @ticket 42619
+	 *
+	 * @covers WP_Automatic_Updater::is_allowed_dir
+	 *
+	 * @runInSeparateProcess
+	 * @preserveGlobalState disabled
+	 */
+	public function test_is_allowed_dir_should_return_false_if_open_basedir_is_set_and_path_is_not_allowed() {
+		// The repository for PHPUnit and test suite resources.
+		$abspath_parent      = trailingslashit( dirname( ABSPATH ) );
+		$abspath_grandparent = trailingslashit( dirname( $abspath_parent ) );
+
+		$open_basedir_backup = ini_get( 'open_basedir' );
+		// Allow access to the directory one level above the repository.
+		ini_set( 'open_basedir', wp_normalize_path( $abspath_grandparent ) );
+
+		// Checking a directory not within the allowed path should trigger an `open_basedir` warning.
+		$actual = self::$updater->is_allowed_dir( '/.git' );
+
+		ini_set( 'open_basedir', $open_basedir_backup );
+
+		$this->assertFalse( $actual );
+	}
+
+	/**
+	 * Tests that `WP_Automatic_Updater::is_allowed_dir()` throws `_doing_it_wrong()`
+	 * when an invalid `$dir` argument is provided.
+	 *
+	 * @ticket 42619
+	 *
+	 * @covers WP_Automatic_Updater::is_allowed_dir
+	 *
+	 * @expectedIncorrectUsage WP_Automatic_Updater::is_allowed_dir
+	 *
+	 * @dataProvider data_is_allowed_dir_should_throw_doing_it_wrong_with_invalid_dir
+	 *
+	 * @param mixed $dir The directory to check.
+	 */
+	public function test_is_allowed_dir_should_throw_doing_it_wrong_with_invalid_dir( $dir ) {
+		$this->assertFalse( self::$updater->is_allowed_dir( $dir ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_is_allowed_dir_should_throw_doing_it_wrong_with_invalid_dir() {
+		return array(
+			// Type checks and boolean comparisons.
+			'null'                              => array( 'dir' => null ),
+			'(bool) false'                      => array( 'dir' => false ),
+			'(bool) true'                       => array( 'dir' => true ),
+			'(int) 0'                           => array( 'dir' => 0 ),
+			'(int) -0'                          => array( 'dir' => -0 ),
+			'(int) 1'                           => array( 'dir' => 1 ),
+			'(int) -1'                          => array( 'dir' => -1 ),
+			'(float) 0.0'                       => array( 'dir' => 0.0 ),
+			'(float) -0.0'                      => array( 'dir' => -0.0 ),
+			'(float) 1.0'                       => array( 'dir' => 1.0 ),
+			'empty string'                      => array( 'dir' => '' ),
+			'empty array'                       => array( 'dir' => array() ),
+			'populated array'                   => array( 'dir' => array( ABSPATH ) ),
+			'empty object'                      => array( 'dir' => new stdClass() ),
+			'populated object'                  => array( 'dir' => (object) array( ABSPATH ) ),
+			'INF'                               => array( 'dir' => INF ),
+			'NAN'                               => array( 'dir' => NAN ),
+
+			// Ensures that `trim()` has been called.
+			'string with only spaces'           => array( 'dir' => '   ' ),
+			'string with only tabs'             => array( 'dir' => "\t\t" ),
+			'string with only newlines'         => array( 'dir' => "\n\n" ),
+			'string with only carriage returns' => array( 'dir' => "\r\r" ),
+		);
+	}
 }
diff --git a/tests/admin/wpCommunityEvents.php b/tests/admin/wpCommunityEvents.php
index 6dfd4f044a..6b8ccc7f9b 100644
--- a/tests/admin/wpCommunityEvents.php
+++ b/tests/admin/wpCommunityEvents.php
@@ -5,15 +5,9 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.8.0
- */
-
-/**
- * Class Tests_Admin_wpCommunityEvents.
  *
  * @group admin
  * @group community-events
- *
- * @since 4.8.0
  */
 class Tests_Admin_wpCommunityEvents extends WP_UnitTestCase {
 
diff --git a/tests/admin/wpPrivacyRequestsTable.php b/tests/admin/wpPrivacyRequestsTable.php
index 7f555c4d25..d729a56baf 100644
--- a/tests/admin/wpPrivacyRequestsTable.php
+++ b/tests/admin/wpPrivacyRequestsTable.php
@@ -5,15 +5,9 @@
  * @package WordPress\UnitTests
  *
  * @since 5.1.0
- */
-
-/**
- * Tests_Admin_wpPrivacyRequestsTable class.
  *
  * @group admin
  * @group privacy
- *
- * @since 5.1.0
  */
 class Tests_Admin_wpPrivacyRequestsTable extends WP_UnitTestCase {
 
@@ -79,7 +73,7 @@ class Tests_Admin_wpPrivacyRequestsTable extends WP_UnitTestCase {
 	 * @param string|null $search   Search term.
 	 * @param string      $expected Expected in SQL query.
 
-	 * @dataProvider data_test_columns_should_be_sortable
+	 * @dataProvider data_columns_should_be_sortable
 	 * @covers WP_Privacy_Requests_Table::prepare_items
 	 * @ticket 43960
 	 */
@@ -131,7 +125,7 @@ class Tests_Admin_wpPrivacyRequestsTable extends WP_UnitTestCase {
 	 *     }
 	 * }
 	 */
-	public function data_test_columns_should_be_sortable() {
+	public function data_columns_should_be_sortable() {
 		return array(
 			// Default order (ID) DESC.
 			array(
diff --git a/tests/adminbar.php b/tests/adminbar.php
index cec80d0cae..aa8043e7ec 100644
--- a/tests/adminbar.php
+++ b/tests/adminbar.php
@@ -754,4 +754,33 @@ class Tests_AdminBar extends WP_UnitTestCase {
 			'network-admin-o'      => 'manage_network_options',
 		);
 	}
+
+	/**
+	 * This test ensures that WP_Admin_Bar::$proto is not defined (including magic methods).
+	 *
+	 * @ticket 56876
+	 * @coversNothing
+	 */
+	public function test_proto_property_is_not_defined() {
+		$admin_bar = new WP_Admin_Bar();
+		$this->assertFalse( property_exists( $admin_bar, 'proto' ), 'WP_Admin_Bar::$proto should not be defined.' );
+		$this->assertFalse( isset( $admin_bar->proto ), 'WP_Admin_Bar::$proto should not be defined.' );
+	}
+
+	/**
+	 * This test ensures that WP_Admin_Bar::$menu is declared as a "regular" class property.
+	 *
+	 * @ticket 56876
+	 * @coversNothing
+	 */
+	public function test_menu_property_is_defined() {
+		$admin_bar = new WP_Admin_Bar();
+		$this->assertTrue( property_exists( $admin_bar, 'menu' ), 'WP_Admin_Bar::$proto property should be defined.' );
+
+		$menu_property = new ReflectionProperty( WP_Admin_Bar::class, 'menu' );
+		$this->assertTrue( $menu_property->isPublic(), 'WP_Admin_Bar::$menu should be public.' );
+
+		$this->assertTrue( isset( $admin_bar->menu ), 'WP_Admin_Bar::$menu should be set.' );
+		$this->assertSame( array(), $admin_bar->menu, 'WP_Admin_Bar::$menu should be equal to an empty array.' );
+	}
 }
diff --git a/tests/ajax/wpAjaxWpPrivacyErasePersonalData.php b/tests/ajax/wpAjaxWpPrivacyErasePersonalData.php
index 068165b991..4f76ea12fb 100644
--- a/tests/ajax/wpAjaxWpPrivacyErasePersonalData.php
+++ b/tests/ajax/wpAjaxWpPrivacyErasePersonalData.php
@@ -4,12 +4,6 @@
  *
  * @package WordPress\UnitTests
  * @since 5.2.0
- */
-
-/**
- * Tests_Ajax_PrivacyExportPersonalData class.
- *
- * @since 5.2.0
  *
  * @group ajax
  * @group privacy
diff --git a/tests/ajax/wpAjaxWpPrivacyExportPersonalData.php b/tests/ajax/wpAjaxWpPrivacyExportPersonalData.php
index f8e588ff5e..51e4cb1391 100644
--- a/tests/ajax/wpAjaxWpPrivacyExportPersonalData.php
+++ b/tests/ajax/wpAjaxWpPrivacyExportPersonalData.php
@@ -4,12 +4,6 @@
  *
  * @package WordPress\UnitTests
  * @since 5.2.0
- */
-
-/**
- * Tests_Ajax_PrivacyExportPersonalData class.
- *
- * @since 5.2.0
  *
  * @group ajax
  * @group privacy
diff --git a/tests/auth.php b/tests/auth.php
index 2198fadcd0..1a2bd9a92d 100644
--- a/tests/auth.php
+++ b/tests/auth.php
@@ -100,6 +100,22 @@ class Tests_Auth extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * Tests hooking into wp_set_password().
+	 *
+	 * @ticket 57436
+	 *
+	 * @covers ::wp_set_password
+	 */
+	public function test_wp_set_password_action() {
+		$action = new MockAction();
+
+		add_action( 'wp_set_password', array( $action, 'action' ) );
+		wp_set_password( 'A simple password', self::$user_id );
+
+		$this->assertSame( 1, $action->get_call_count() );
+	}
+
 	/**
 	 * Test wp_hash_password trims whitespace
 	 *
@@ -428,6 +444,25 @@ class Tests_Auth extends WP_UnitTestCase {
 		$this->assertInstanceOf( 'WP_User', wp_signon() );
 	}
 
+	/**
+	 * Tests that PHP 8.1 "passing null to non-nullable" deprecation notices
+	 * are not thrown when `user_login` and `user_password` parameters are empty.
+	 *
+	 * The notices that we should not see:
+	 * `Deprecated: preg_replace(): Passing null to parameter #3 ($subject) of type array|string is deprecated`.
+	 * `Deprecated: trim(): Passing null to parameter #1 ($string) of type string is deprecated`.
+	 *
+	 * @ticket 56850
+	 */
+	public function test_wp_signon_does_not_throw_deprecation_notices_with_default_parameters() {
+		$error = wp_signon();
+		$this->assertWPError( $error, 'The result should be an instance of WP_Error.' );
+
+		$error_codes = $error->get_error_codes();
+		$this->assertContains( 'empty_username', $error_codes, 'The "empty_username" error code should be present.' );
+		$this->assertContains( 'empty_password', $error_codes, 'The "empty_password" error code should be present.' );
+	}
+
 	/**
 	 * HTTP Auth headers are used to determine the current user.
 	 *
diff --git a/tests/block-supports/elements.php b/tests/block-supports/elements.php
index be98fe590a..02c29dd6e6 100644
--- a/tests/block-supports/elements.php
+++ b/tests/block-supports/elements.php
@@ -73,7 +73,7 @@ class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 		);
 		$this->assertSame(
 			$result,
-			'<p class="wp-elements-1 has-dark-gray-background-color has-background">Hello <a href="http://www.wordpress.org/">WordPress</a>!</p>'
+			'<p class="has-dark-gray-background-color has-background wp-elements-1">Hello <a href="http://www.wordpress.org/">WordPress</a>!</p>'
 		);
 	}
 
@@ -103,7 +103,7 @@ class Tests_Block_Supports_Elements extends WP_UnitTestCase {
 		);
 		$this->assertSame(
 			$result,
-			'<p id="anchor" class="wp-elements-1">Hello <a href="http://www.wordpress.org/">WordPress</a>!</p>'
+			'<p class="wp-elements-1" id="anchor">Hello <a href="http://www.wordpress.org/">WordPress</a>!</p>'
 		);
 	}
 }
diff --git a/tests/block-supports/layout.php b/tests/block-supports/layout.php
index bcc21775ba..73acce8bc7 100644
--- a/tests/block-supports/layout.php
+++ b/tests/block-supports/layout.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Block supports tests for the layout.
+ * Tests for block supports related to layout.
  *
  * @package WordPress
  * @subpackage Block Supports
  * @since 6.0.0
- */
-
-/**
- * Tests for block supports related to layout.
- *
- * @since 6.0.0
  *
  * @group block-supports
  *
@@ -173,4 +167,88 @@ class Test_Block_Supports_Layout extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, wp_restore_image_outer_container( $block_content, $block ) );
 	}
+
+	/**
+	 * @ticket 57584
+	 *
+	 * @dataProvider data_layout_support_flag_renders_classnames_on_wrapper
+	 *
+	 * @covers ::wp_render_layout_support_flag
+	 *
+	 * @param array  $args            Dataset to test.
+	 * @param string $expected_output The expected output.
+	 */
+	public function test_layout_support_flag_renders_classnames_on_wrapper( $args, $expected_output ) {
+		$actual_output = wp_render_layout_support_flag( $args['block_content'], $args['block'] );
+		$this->assertSame( $expected_output, $actual_output );
+	}
+
+	/**
+	 * Data provider for test_layout_support_flag_renders_classnames_on_wrapper.
+	 *
+	 * @return array
+	 */
+	public function data_layout_support_flag_renders_classnames_on_wrapper() {
+		return array(
+			'single wrapper block layout with flow type'   => array(
+				'args'            => array(
+					'block_content' => '<div class="wp-block-group"></div>',
+					'block'         => array(
+						'blockName'    => 'core/group',
+						'attrs'        => array(
+							'layout' => array(
+								'type' => 'default',
+							),
+						),
+						'innerBlocks'  => array(),
+						'innerHTML'    => '<div class="wp-block-group"></div>',
+						'innerContent' => array(
+							'<div class="wp-block-group"></div>',
+						),
+					),
+				),
+				'expected_output' => '<div class="wp-block-group is-layout-flow"></div>',
+			),
+			'single wrapper block layout with constrained type' => array(
+				'args'            => array(
+					'block_content' => '<div class="wp-block-group"></div>',
+					'block'         => array(
+						'blockName'    => 'core/group',
+						'attrs'        => array(
+							'layout' => array(
+								'type' => 'constrained',
+							),
+						),
+						'innerBlocks'  => array(),
+						'innerHTML'    => '<div class="wp-block-group"></div>',
+						'innerContent' => array(
+							'<div class="wp-block-group"></div>',
+						),
+					),
+				),
+				'expected_output' => '<div class="wp-block-group is-layout-constrained"></div>',
+			),
+			'multiple wrapper block layout with flow type' => array(
+				'args'            => array(
+					'block_content' => '<div class="wp-block-group"><div class="wp-block-group__inner-wrapper"></div></div>',
+					'block'         => array(
+						'blockName'    => 'core/group',
+						'attrs'        => array(
+							'layout' => array(
+								'type' => 'default',
+							),
+						),
+						'innerBlocks'  => array(),
+						'innerHTML'    => '<div class="wp-block-group"><div class="wp-block-group__inner-wrapper"></div></div>',
+						'innerContent' => array(
+							'<div class="wp-block-group"><div class="wp-block-group__inner-wrapper">',
+							' ',
+							' </div></div>',
+						),
+					),
+				),
+				'expected_output' => '<div class="wp-block-group"><div class="wp-block-group__inner-wrapper is-layout-flow"></div></div>',
+			),
+		);
+	}
 }
diff --git a/tests/block-supports/typography.php b/tests/block-supports/typography.php
index 177a154b9e..6cbd76788d 100644
--- a/tests/block-supports/typography.php
+++ b/tests/block-supports/typography.php
@@ -567,21 +567,18 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 	 *
 	 * @ticket 56467
 	 * @ticket 57065
+	 * @ticket 57529
 	 *
 	 * @covers ::wp_register_typography_support
 	 *
 	 * @dataProvider data_generate_block_supports_font_size_fixtures
 	 *
-	 * @param string $font_size_value             The block supports custom font size value.
-	 * @param bool   $should_use_fluid_typography An override to switch fluid typography "on". Can be used for unit testing.
-	 * @param string $expected_output             Expected value of style property from wp_apply_typography_support().
+	 * @param string $font_size_value The block supports custom font size value.
+	 * @param string $theme_slug      A theme slug corresponding to an available test theme.
+	 * @param string $expected_output Expected value of style property from wp_apply_typography_support().
 	 */
-	public function test_should_covert_font_sizes_to_fluid_values( $font_size_value, $should_use_fluid_typography, $expected_output ) {
-		if ( $should_use_fluid_typography ) {
-			switch_theme( 'block-theme-child-with-fluid-typography' );
-		} else {
-			switch_theme( 'default' );
-		}
+	public function test_should_covert_font_sizes_to_fluid_values( $font_size_value, $theme_slug, $expected_output ) {
+		switch_theme( $theme_slug );
 
 		$this->test_block_name = 'test/font-size-fluid-value';
 		register_block_type(
@@ -623,15 +620,30 @@ class Tests_Block_Supports_Typography extends WP_UnitTestCase {
 	 */
 	public function data_generate_block_supports_font_size_fixtures() {
 		return array(
-			'default_return_value'               => array(
-				'font_size_value'             => '50px',
-				'should_use_fluid_typography' => false,
-				'expected_output'             => 'font-size:50px;',
-			),
-			'return_value_with_fluid_typography' => array(
-				'font_size_value'             => '50px',
-				'should_use_fluid_typography' => true,
-				'expected_output'             => 'font-size:clamp(37.5px, 2.344rem + ((1vw - 7.68px) * 1.502), 50px);',
+			'returns value when fluid typography is not active' => array(
+				'font_size_value' => '15px',
+				'theme_slug'      => 'default',
+				'expected_output' => 'font-size:15px;',
+			),
+			'returns clamp value using default config' => array(
+				'font_size_value' => '15px',
+				'theme_slug'      => 'block-theme-child-with-fluid-typography',
+				'expected_output' => 'font-size:clamp(14px, 0.875rem + ((1vw - 7.68px) * 0.12), 15px);',
+			),
+			'returns value when font size <= default min font size bound' => array(
+				'font_size_value' => '13px',
+				'theme_slug'      => 'block-theme-child-with-fluid-typography',
+				'expected_output' => 'font-size:13px;',
+			),
+			'returns clamp value using custom fluid config' => array(
+				'font_size_value' => '17px',
+				'theme_slug'      => 'block-theme-child-with-fluid-typography-config',
+				'expected_output' => 'font-size:clamp(16px, 1rem + ((1vw - 7.68px) * 0.12), 17px);',
+			),
+			'returns value when font size <= custom min font size bound' => array(
+				'font_size_value' => '15px',
+				'theme_slug'      => 'block-theme-child-with-fluid-typography-config',
+				'expected_output' => 'font-size:15px;',
 			),
 		);
 	}
diff --git a/tests/block-supports/wpApplyDimensionsSupport.php b/tests/block-supports/wpApplyDimensionsSupport.php
new file mode 100644
index 0000000000..a4f2973a06
--- /dev/null
+++ b/tests/block-supports/wpApplyDimensionsSupport.php
@@ -0,0 +1,103 @@
+<?php
+
+/**
+ * @group block-supports
+ *
+ * @covers ::wp_apply_dimensions_support
+ */
+class Tests_Block_Supports_WpApplyDimensionsSupport extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
+
+	public function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+	}
+
+	public function tear_down() {
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests that minimum height block support works as expected.
+	 *
+	 * @ticket 57582
+	 *
+	 * @covers ::wp_apply_dimensions_support
+	 *
+	 * @dataProvider data_minimum_height_block_support
+	 *
+	 * @param string $block_name The test block name to register.
+	 * @param mixed  $dimensions The dimensions block support settings.
+	 * @param mixed  $expected   The expected results.
+	 */
+	public function test_minimum_height_block_support( $block_name, $dimensions, $expected ) {
+		$this->test_block_name = $block_name;
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'dimensions' => $dimensions,
+				),
+			)
+		);
+		$registry    = WP_Block_Type_Registry::get_instance();
+		$block_type  = $registry->get_registered( $this->test_block_name );
+		$block_attrs = array(
+			'style' => array(
+				'dimensions' => array(
+					'minHeight' => '50vh',
+				),
+			),
+		);
+
+		$actual = wp_apply_dimensions_support( $block_type, $block_attrs );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_minimum_height_block_support() {
+		return array(
+			'style is applied' => array(
+				'block_name' => 'test/dimensions-block-supports',
+				'dimensions' => array(
+					'minHeight' => true,
+				),
+				'expected'   => array(
+					'style' => 'min-height:50vh;',
+				),
+			),
+			'style output is skipped when serialization is skipped' => array(
+				'block_name' => 'test/dimensions-with-skipped-serialization-block-supports',
+				'dimensions' => array(
+					'minHeight'                       => true,
+					'__experimentalSkipSerialization' => true,
+				),
+				'expected'   => array(),
+			),
+			'style output is skipped when individual feature serialization is skipped' => array(
+				'block_name' => 'test/min-height-with-individual-skipped-serialization-block-supports',
+				'dimensions' => array(
+					'minHeight'                       => true,
+					'__experimentalSkipSerialization' => array( 'minHeight' ),
+				),
+				'expected'   => array(),
+			),
+		);
+	}
+}
diff --git a/tests/block-supports/wpGetLayoutStyle.php b/tests/block-supports/wpGetLayoutStyle.php
index 6ac4d05a96..91f7df561d 100644
--- a/tests/block-supports/wpGetLayoutStyle.php
+++ b/tests/block-supports/wpGetLayoutStyle.php
@@ -246,7 +246,7 @@ class Tests_Block_Supports_WpGetLayoutStyle extends WP_UnitTestCase {
 						'verticalAlignment' => 'bottom',
 					),
 				),
-				'expected_output' => '.wp-layout{flex-wrap:nowrap;flex-direction:column;align-items:flex-start;}',
+				'expected_output' => '.wp-layout{flex-wrap:nowrap;flex-direction:column;align-items:flex-start;justify-content:flex-end;}',
 			),
 			'default layout with blockGap to verify converting gap value into valid CSS' => array(
 				'args'            => array(
diff --git a/tests/block-supports/wpRenderPositionSupport.php b/tests/block-supports/wpRenderPositionSupport.php
new file mode 100644
index 0000000000..4aa1418fe5
--- /dev/null
+++ b/tests/block-supports/wpRenderPositionSupport.php
@@ -0,0 +1,186 @@
+<?php
+
+/**
+ * @group block-supports
+ *
+ * @covers ::wp_render_position_support
+ */
+class Tests_Block_Supports_WpRenderPositionSupport extends WP_UnitTestCase {
+	/**
+	 * @var string|null
+	 */
+	private $test_block_name;
+
+	/**
+	 * Theme root directory.
+	 *
+	 * @var string
+	 */
+	private $theme_root;
+
+	/**
+	 * Original theme directory.
+	 *
+	 * @var string
+	 */
+	private $orig_theme_dir;
+
+	public function set_up() {
+		parent::set_up();
+		$this->test_block_name = null;
+		$this->theme_root      = realpath( DIR_TESTDATA . '/themedir1' );
+		$this->orig_theme_dir  = $GLOBALS['wp_theme_directories'];
+
+		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
+		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
+
+		add_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		add_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		// Clear caches.
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+	}
+
+	public function tear_down() {
+		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
+
+		// Clear up the filters to modify the theme root.
+		remove_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
+		remove_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+
+		wp_clean_themes_cache();
+		unset( $GLOBALS['wp_themes'] );
+		WP_Style_Engine_CSS_Rules_Store::remove_all_stores();
+		unregister_block_type( $this->test_block_name );
+		$this->test_block_name = null;
+		parent::tear_down();
+	}
+
+	public function filter_set_theme_root() {
+		return $this->theme_root;
+	}
+
+	/**
+	 * Tests that position block support works as expected.
+	 *
+	 * @ticket 57618
+	 *
+	 * @covers ::wp_render_position_support
+	 *
+	 * @dataProvider data_position_block_support
+	 *
+	 * @param string $theme_name        The theme to switch to.
+	 * @param string $block_name        The test block name to register.
+	 * @param mixed  $position_settings The position block support settings.
+	 * @param mixed  $position_style    The position styles within the block attributes.
+	 * @param string $expected_wrapper  Expected markup for the block wrapper.
+	 * @param string $expected_styles   Expected styles enqueued by the style engine.
+	 */
+	public function test_position_block_support( $theme_name, $block_name, $position_settings, $position_style, $expected_wrapper, $expected_styles ) {
+		switch_theme( $theme_name );
+		$this->test_block_name = $block_name;
+
+		register_block_type(
+			$this->test_block_name,
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'style' => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'position' => $position_settings,
+				),
+			)
+		);
+
+		$block = array(
+			'blockName' => 'test/position-rules-are-output',
+			'attrs'     => array(
+				'style' => array(
+					'position' => $position_style,
+				),
+			),
+		);
+
+		$actual = wp_render_position_support( '<div>Content</div>', $block );
+
+		$this->assertMatchesRegularExpression(
+			$expected_wrapper,
+			$actual,
+			'Position block wrapper markup should be correct'
+		);
+
+		$actual_stylesheet = wp_style_engine_get_stylesheet_from_context(
+			'block-supports',
+			array(
+				'prettify' => false,
+			)
+		);
+
+		$this->assertMatchesRegularExpression(
+			$expected_styles,
+			$actual_stylesheet,
+			'Position style rules output should be correct'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_position_block_support() {
+		return array(
+			'sticky position style is applied' => array(
+				'theme_name'        => 'block-theme-child-with-fluid-typography',
+				'block_name'        => 'test/position-rules-are-output',
+				'position_settings' => true,
+				'position_style'    => array(
+					'type' => 'sticky',
+					'top'  => '0px',
+				),
+				'expected_wrapper'  => '/^<div class="wp-container-\d+ is-position-sticky">Content<\/div>$/',
+				'expected_styles'   => '/^.wp-container-\d+' . preg_quote( '{top:calc(0px + var(--wp-admin--admin-bar--position-offset, 0px));position:sticky;z-index:10;}' ) . '$/',
+			),
+			'sticky position style is not applied if theme does not support it' => array(
+				'theme_name'        => 'default',
+				'block_name'        => 'test/position-rules-without-theme-support',
+				'position_settings' => true,
+				'position_style'    => array(
+					'type' => 'sticky',
+					'top'  => '0px',
+				),
+				'expected_wrapper'  => '/^<div>Content<\/div>$/',
+				'expected_styles'   => '/^$/',
+			),
+			'sticky position style is not applied if block does not support it' => array(
+				'theme_name'        => 'block-theme-child-with-fluid-typography',
+				'block_name'        => 'test/position-rules-without-block-support',
+				'position_settings' => false,
+				'position_style'    => array(
+					'type' => 'sticky',
+					'top'  => '0px',
+				),
+				'expected_wrapper'  => '/^<div>Content<\/div>$/',
+				'expected_styles'   => '/^$/',
+			),
+			'sticky position style is not applied if type is not valid' => array(
+				'theme_name'        => 'block-theme-child-with-fluid-typography',
+				'block_name'        => 'test/position-rules-with-valid-type',
+				'position_settings' => true,
+				'position_style'    => array(
+					'type' => 'illegal-type',
+					'top'  => '0px',
+				),
+				'expected_wrapper'  => '/^<div>Content<\/div>$/',
+				'expected_styles'   => '/^$/',
+			),
+		);
+	}
+}
diff --git a/tests/block-template-utils.php b/tests/block-template-utils.php
index 6e4a5b9e5c..5d42207aa7 100644
--- a/tests/block-template-utils.php
+++ b/tests/block-template-utils.php
@@ -1,12 +1,8 @@
 <?php
 /**
- * Tests_Block_Template_Utils class
+ * Tests for the Block Templates abstraction layer.
  *
  * @package WordPress
- */
-
-/**
- * Tests for the Block Templates abstraction layer.
  *
  * @group block-templates
  */
@@ -123,25 +119,6 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( WP_TEMPLATE_PART_AREA_HEADER, $template_part->area );
 	}
 
-	/**
-	 * Tests that _build_block_template_result_from_post() returns the correct theme
-	 * for the template when a child theme is active.
-	 *
-	 * @ticket 55437
-	 *
-	 * @covers ::_build_block_template_result_from_post
-	 */
-	public function test_build_block_template_result_from_post_with_child_theme() {
-		switch_theme( 'block-theme-child' );
-
-		$template = _build_block_template_result_from_post(
-			self::$template_post,
-			'wp_template'
-		);
-
-		$this->assertSame( self::TEST_THEME, $template->theme );
-	}
-
 	public function test_build_block_template_result_from_file() {
 		$template = _build_block_template_result_from_file(
 			array(
@@ -157,7 +134,7 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( 'publish', $template->status );
 		$this->assertSame( 'theme', $template->source );
 		$this->assertSame( 'Single', $template->title );
-		$this->assertSame( 'The default template for displaying any single post or attachment.', $template->description );
+		$this->assertSame( 'Displays single posts on your website unless a custom template has been applied to that post or a dedicated template exists.', $template->description );
 		$this->assertSame( 'wp_template', $template->type );
 
 		// Test template parts.
@@ -180,29 +157,6 @@ class Tests_Block_Template_Utils extends WP_UnitTestCase {
 		$this->assertSame( WP_TEMPLATE_PART_AREA_HEADER, $template_part->area );
 	}
 
-	/**
-	 * Tests that _build_block_template_result_from_file() returns the correct theme
-	 * for the template when a child theme is active.
-	 *
-	 * @ticket 55437
-	 *
-	 * @covers ::_build_block_template_result_from_file
-	 */
-	public function test_build_block_template_result_from_file_with_child_theme() {
-		switch_theme( 'block-theme-child' );
-
-		$template = _build_block_template_result_from_file(
-			array(
-				'slug'  => 'single',
-				'path'  => __DIR__ . '/../data/templates/template.html',
-				'theme' => self::TEST_THEME,
-			),
-			'wp_template'
-		);
-
-		$this->assertSame( self::TEST_THEME, $template->theme );
-	}
-
 	public function test_inject_theme_attribute_in_block_template_content() {
 		$theme                           = get_stylesheet();
 		$content_without_theme_attribute = '<!-- wp:template-part {"slug":"header","align":"full", "tagName":"header","className":"site-header"} /-->';
diff --git a/tests/block-template.php b/tests/block-template.php
index 5439ac3793..16c0978813 100644
--- a/tests/block-template.php
+++ b/tests/block-template.php
@@ -1,12 +1,8 @@
 <?php
 /**
- * Tests_Block_Template class
+ * Tests for the block template loading algorithm.
  *
  * @package WordPress
- */
-
-/**
- * Tests for the block template loading algorithm.
  *
  * @group block-templates
  */
@@ -188,42 +184,4 @@ class Tests_Block_Template extends WP_UnitTestCase {
 		$resolved_template_path = locate_block_template( '', 'search', array() );
 		$this->assertSame( '', $resolved_template_path );
 	}
-
-	/**
-	 * Covers: https://github.com/WordPress/gutenberg/pull/38817.
-	 *
-	 * @ticket 55505
-	 */
-	public function test_resolve_home_block_template_default_hierarchy() {
-		$template = _resolve_home_block_template();
-
-		$this->assertSame( 'wp_template', $template['postType'] );
-		$this->assertSame( get_stylesheet() . '//index', $template['postId'] );
-	}
-
-	/**
-	 * @ticket 55505
-	 */
-	public function test_resolve_home_block_template_static_homepage() {
-		$post_id = self::factory()->post->create( array( 'post_type' => 'page' ) );
-		update_option( 'show_on_front', 'page' );
-		update_option( 'page_on_front', $post_id );
-
-		$template = _resolve_home_block_template();
-
-		$this->assertSame( 'page', $template['postType'] );
-		$this->assertSame( $post_id, $template['postId'] );
-
-		delete_option( 'show_on_front', 'page' );
-	}
-
-	/**
-	 * @ticket 55505
-	 */
-	public function test_resolve_home_block_template_no_resolution() {
-		switch_theme( 'stylesheetonly' );
-		$template = _resolve_home_block_template();
-
-		$this->assertNull( $template );
-	}
 }
diff --git a/tests/block-templates/getTemplateHierarchy.php b/tests/block-templates/getTemplateHierarchy.php
index e550b22778..fab9178665 100644
--- a/tests/block-templates/getTemplateHierarchy.php
+++ b/tests/block-templates/getTemplateHierarchy.php
@@ -8,6 +8,26 @@ require_once __DIR__ . '/base.php';
  */
 class Tests_Block_Templates_GetTemplate_Hierarchy extends WP_Block_Templates_UnitTestCase {
 
+	public function set_up() {
+		parent::set_up();
+		register_post_type(
+			'custom_book',
+			array(
+				'public'       => true,
+				'show_in_rest' => true,
+			)
+		);
+		register_taxonomy( 'book_type', 'custom_book' );
+		register_taxonomy( 'books', 'custom_book' );
+	}
+
+	public function tear_down() {
+		unregister_post_type( 'custom_book' );
+		unregister_taxonomy( 'book_type' );
+		unregister_taxonomy( 'books' );
+		parent::tear_down();
+	}
+
 	/**
 	 * @dataProvider data_get_template_hierarchy
 	 *
@@ -83,14 +103,26 @@ class Tests_Block_Templates_GetTemplate_Hierarchy extends WP_Block_Templates_Uni
 				'args'     => array( 'category-fruits', false, 'category' ),
 				'expected' => array( 'category-fruits', 'category', 'archive', 'index' ),
 			),
+			'single word categories no prefix'         => array(
+				'args'     => array( 'category-fruits', false ),
+				'expected' => array( 'category-fruits', 'category', 'archive', 'index' ),
+			),
 			'multi word categories'                    => array(
 				'args'     => array( 'category-fruits-yellow', false, 'category' ),
 				'expected' => array( 'category-fruits-yellow', 'category', 'archive', 'index' ),
 			),
+			'multi word categories no prefix'          => array(
+				'args'     => array( 'category-fruits-yellow', false ),
+				'expected' => array( 'category-fruits-yellow', 'category', 'archive', 'index' ),
+			),
 			'single word taxonomy and term'            => array(
 				'args'     => array( 'taxonomy-books-action', false, 'taxonomy-books' ),
 				'expected' => array( 'taxonomy-books-action', 'taxonomy-books', 'taxonomy', 'archive', 'index' ),
 			),
+			'single word taxonomy and term no prefix'  => array(
+				'args'     => array( 'taxonomy-books-action', false ),
+				'expected' => array( 'taxonomy-books-action', 'taxonomy-books', 'taxonomy', 'archive', 'index' ),
+			),
 			'single word taxonomy and multi word term' => array(
 				'args'     => array( 'taxonomy-books-action-adventure', false, 'taxonomy-books' ),
 				'expected' => array( 'taxonomy-books-action-adventure', 'taxonomy-books', 'taxonomy', 'archive', 'index' ),
@@ -119,6 +151,46 @@ class Tests_Block_Templates_GetTemplate_Hierarchy extends WP_Block_Templates_Uni
 				'args'     => array( 'author-rigas', false, 'author' ),
 				'expected' => array( 'author-rigas', 'author', 'archive', 'index' ),
 			),
+			'multiple word taxonomy no prefix'         => array(
+				'args'     => array( 'taxonomy-book_type-adventure', false ),
+				'expected' => array( 'taxonomy-book_type-adventure', 'taxonomy-book_type', 'taxonomy', 'archive', 'index' ),
+			),
+			'single post type no prefix'               => array(
+				'args'     => array( 'single-custom_book', false ),
+				'expected' => array(
+					'single-custom_book',
+					'single',
+					'singular',
+					'index',
+				),
+			),
+			'single post and post type no prefix'      => array(
+				'args'     => array( 'single-custom_book-book-1', false ),
+				'expected' => array(
+					'single-custom_book-book-1',
+					'single-custom_book',
+					'single',
+					'singular',
+					'index',
+				),
+			),
+			'page no prefix'                           => array(
+				'args'     => array( 'page-hi', false ),
+				'expected' => array(
+					'page-hi',
+					'page',
+					'singular',
+					'index',
+				),
+			),
+			'post type archive no prefix'              => array(
+				'args'     => array( 'archive-book', false ),
+				'expected' => array(
+					'archive-book',
+					'archive',
+					'index',
+				),
+			),
 		);
 	}
 }
diff --git a/tests/blocks/context.php b/tests/blocks/context.php
index 04f9a88176..76603b7b37 100644
--- a/tests/blocks/context.php
+++ b/tests/blocks/context.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Block context tests
+ * Tests for block context functions.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.5.0
- */
-
-/**
- * Tests for block context functions.
- *
- * @since 5.5.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/editor.php b/tests/blocks/editor.php
index e3a4fdccfc..ef8f1cd795 100644
--- a/tests/blocks/editor.php
+++ b/tests/blocks/editor.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Block editor tests
+ * Tests for the block editor methods.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.5.0
- */
-
-/**
- * Tests for the block editor methods.
- *
- * @since 5.5.0
  *
  * @group blocks
  */
@@ -568,6 +562,44 @@ class Tests_Blocks_Editor extends WP_UnitTestCase {
 		$this->assertStringContainsString( $expected, $haystack );
 	}
 
+	/**
+	 * @ticket 57547
+	 *
+	 * @covers ::get_classic_theme_supports_block_editor_settings
+	 */
+	public function test_get_classic_theme_supports_block_editor_settings() {
+		$font_sizes = array(
+			array(
+				'name' => 'Small',
+				'size' => 12,
+				'slug' => 'small',
+			),
+			array(
+				'name' => 'Regular',
+				'size' => 16,
+				'slug' => 'regular',
+			),
+		);
+
+		add_theme_support( 'editor-font-sizes', $font_sizes );
+		$settings = get_classic_theme_supports_block_editor_settings();
+		remove_theme_support( 'editor-font-sizes' );
+
+		$this->assertFalse( $settings['disableCustomColors'], 'Value for array key "disableCustomColors" does not match expectations' );
+		$this->assertFalse( $settings['disableCustomFontSizes'], 'Value for array key "disableCustomFontSizes" does not match expectations' );
+		$this->assertFalse( $settings['disableCustomGradients'], 'Value for array key "disableCustomGradients" does not match expectations' );
+		$this->assertFalse( $settings['disableLayoutStyles'], 'Value for array key "disableLayoutStyles" does not match expectations' );
+		$this->assertFalse( $settings['enableCustomLineHeight'], 'Value for array key "enableCustomLineHeight" does not match expectations' );
+		$this->assertFalse( $settings['enableCustomSpacing'], 'Value for array key "enableCustomSpacing" does not match expectations' );
+		$this->assertFalse( $settings['enableCustomUnits'], 'Value for array key "enableCustomUnits" does not match expectations' );
+
+		$this->assertSame(
+			$font_sizes,
+			$settings['fontSizes'],
+			'Value for array key "fontSizes" does not match expectations'
+		);
+	}
+
 	/**
 	 * Data provider.
 	 *
diff --git a/tests/blocks/register.php b/tests/blocks/register.php
index ca906086a3..e1cd22db45 100644
--- a/tests/blocks/register.php
+++ b/tests/blocks/register.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Block registration tests
+ * Tests for register_block_type(), unregister_block_type(), get_dynamic_block_names(), and register_block_style().
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.0.0
- */
-
-/**
- * Tests for register_block_type(), unregister_block_type(), get_dynamic_block_names(), and register_block_style().
- *
- * @since 5.0.0
  *
  * @group blocks
  */
@@ -374,6 +368,58 @@ class Tests_Blocks_Register extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Tests that register_block_style_handle() loads RTL stylesheets when an RTL locale is set.
+	 *
+	 * @ticket 56325
+	 * @ticket 56797
+	 *
+	 * @covers ::register_block_style_handle
+	 */
+	public function test_register_block_style_handle_should_load_rtl_stylesheets_for_rtl_text_direction() {
+		global $wp_locale;
+
+		$metadata = array(
+			'file'  => DIR_TESTDATA . '/blocks/notice/block.json',
+			'name'  => 'unit-tests/test-block-rtl',
+			'style' => 'file:./block.css',
+		);
+
+		$orig_text_dir             = $wp_locale->text_direction;
+		$wp_locale->text_direction = 'rtl';
+
+		$handle       = register_block_style_handle( $metadata, 'style' );
+		$extra_rtl    = wp_styles()->get_data( 'unit-tests-test-block-rtl-style', 'rtl' );
+		$extra_suffix = wp_styles()->get_data( 'unit-tests-test-block-rtl-style', 'suffix' );
+		$extra_path   = wp_normalize_path( wp_styles()->get_data( 'unit-tests-test-block-rtl-style', 'path' ) );
+
+		$wp_locale->text_direction = $orig_text_dir;
+
+		$this->assertSame(
+			'unit-tests-test-block-rtl-style',
+			$handle,
+			'The handle did not match the expected handle.'
+		);
+
+		$this->assertSame(
+			'replace',
+			$extra_rtl,
+			'The extra "rtl" data was not "replace".'
+		);
+
+		$this->assertSame(
+			'',
+			$extra_suffix,
+			'The extra "suffix" data was not an empty string.'
+		);
+
+		$this->assertSame(
+			wp_normalize_path( realpath( DIR_TESTDATA . '/blocks/notice/block-rtl.css' ) ),
+			$extra_path,
+			'The "path" did not match the expected path.'
+		);
+	}
+
 	/**
 	 * @ticket 56664
 	 */
diff --git a/tests/blocks/render.php b/tests/blocks/render.php
index e119517d4e..56905956df 100644
--- a/tests/blocks/render.php
+++ b/tests/blocks/render.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Block rendering tests
+ * Tests for block rendering functions.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.0.0
- */
-
-/**
- * Tests for block rendering functions.
- *
- * @since 5.0.0
  *
  * @group blocks
  */
@@ -233,6 +227,10 @@ class Tests_Blocks_Render extends WP_UnitTestCase {
 		$normalized_html = preg_replace( '/wp-block-gallery-\d+/', 'wp-block-gallery-1', $normalized_html );
 		$expected_html   = self::strip_r( file_get_contents( $server_html_path ) );
 
+		// Convert HTML to be white space insensitive.
+		$normalized_html = preg_replace( '/(\s+$)/m', '', $normalized_html );
+		$expected_html   = preg_replace( '/(\s+$)/m', '', $expected_html );
+
 		$this->assertSame(
 			$expected_html,
 			$normalized_html,
diff --git a/tests/blocks/renderCommentTemplate.php b/tests/blocks/renderCommentTemplate.php
index 5bfcd76487..82b2cb91cb 100644
--- a/tests/blocks/renderCommentTemplate.php
+++ b/tests/blocks/renderCommentTemplate.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Comment Template block rendering tests.
+ * Tests for the Comment Template block rendering.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 6.0.0
- */
-
-/**
- * Tests for the Comment Template block.
- *
- * @since 6.0.0
  *
  * @group blocks
  */
@@ -333,7 +327,7 @@ class Tests_Blocks_RenderReusableCommentTemplate extends WP_UnitTestCase {
 
 		$top_level_ids = self::$comment_ids;
 		$expected      = str_replace(
-			array( "\n", "\t" ),
+			array( "\r\n", "\n", "\t" ),
 			'',
 			<<<END
 				<ol class="wp-block-comment-template">
@@ -387,7 +381,7 @@ END
 
 		$this->assertSame(
 			$expected,
-			str_replace( array( "\n", "\t" ), '', $block->render() )
+			str_replace( array( "\r\n", "\n", "\t" ), '', $block->render() )
 		);
 	}
 
diff --git a/tests/blocks/renderReusable.php b/tests/blocks/renderReusable.php
index 086ae67894..7609872b77 100644
--- a/tests/blocks/renderReusable.php
+++ b/tests/blocks/renderReusable.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Reusable block rendering tests
+ * Tests for reusable block rendering.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.0.0
- */
-
-/**
- * Tests for reusable block rendering.
- *
- * @since 5.0.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/serialize.php b/tests/blocks/serialize.php
index aa28f21209..d8e12f0511 100644
--- a/tests/blocks/serialize.php
+++ b/tests/blocks/serialize.php
@@ -1,14 +1,9 @@
 <?php
 /**
- * Block serialization tests
+ * Tests for block serialization functions.
  *
  * @package WordPress
  * @subpackage Blocks
- * @since 5.3.3
- */
-
-/**
- * Tests for block serialization functions.
  *
  * @since 5.3.3
  *
diff --git a/tests/blocks/supportedStyles.php b/tests/blocks/supportedStyles.php
index e4e6c37e9e..d3b1a191de 100644
--- a/tests/blocks/supportedStyles.php
+++ b/tests/blocks/supportedStyles.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * Block supported style tests
+ * Test block supported styles.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.6.0
- */
-
-/**
- * Test block supported styles.
- *
- * @since 5.6.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/wpBlock.php b/tests/blocks/wpBlock.php
index 00f5a97b83..ebf2f9aaf6 100644
--- a/tests/blocks/wpBlock.php
+++ b/tests/blocks/wpBlock.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_Block tests
+ * Tests for WP_Block.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.5.0
- */
-
-/**
- * Tests for WP_Block.
- *
- * @since 5.5.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/wpBlockList.php b/tests/blocks/wpBlockList.php
index e3755a9cd2..6dd2979e70 100644
--- a/tests/blocks/wpBlockList.php
+++ b/tests/blocks/wpBlockList.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_Block_List tests
+ * Tests for WP_Block_List.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.5.0
- */
-
-/**
- * Tests for WP_Block_List.
- *
- * @since 5.5.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/wpBlockParser.php b/tests/blocks/wpBlockParser.php
index 8169d4f610..d88849d956 100644
--- a/tests/blocks/wpBlockParser.php
+++ b/tests/blocks/wpBlockParser.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_Block_Parser tests
+ * Tests for WP_Block_Parser.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.0.0
- */
-
-/**
- * Tests for WP_Block_Parser.
- *
- * @since 5.0.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/wpBlockType.php b/tests/blocks/wpBlockType.php
index 8ba94be4f5..330d082bc2 100644
--- a/tests/blocks/wpBlockType.php
+++ b/tests/blocks/wpBlockType.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_Block_Type tests
+ * Tests for WP_Block_Type.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.0.0
- */
-
-/**
- * Tests for WP_Block_Type.
- *
- * @since 5.0.0
  *
  * @group blocks
  */
diff --git a/tests/blocks/wpBlockTypeRegistry.php b/tests/blocks/wpBlockTypeRegistry.php
index 4d384dc725..c97bdc95d4 100644
--- a/tests/blocks/wpBlockTypeRegistry.php
+++ b/tests/blocks/wpBlockTypeRegistry.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_Block_Type_Registry tests
+ * Tests for WP_Block_Type_Registry.
  *
  * @package WordPress
  * @subpackage Blocks
  * @since 5.0.0
- */
-
-/**
- * Tests for WP_Block_Type_Registry.
- *
- * @since 5.0.0
  *
  * @group blocks
  */
diff --git a/tests/comment.php b/tests/comment.php
index 3914a94081..7858097f73 100644
--- a/tests/comment.php
+++ b/tests/comment.php
@@ -161,7 +161,7 @@ class Tests_Comment extends WP_UnitTestCase {
 		);
 
 		$comment = get_comment( $comment_id );
-		$this->assertEquals( '<a href="http://example.localhost/something.html" rel="nofollow ugc">click</a>', $comment->comment_content, 'Comment: ' . $comment->comment_content );
+		$this->assertSame( '<a href="http://example.localhost/something.html" rel="nofollow ugc">click</a>', $comment->comment_content, 'Comment: ' . $comment->comment_content );
 		wp_set_current_user( 0 );
 	}
 
@@ -377,6 +377,430 @@ class Tests_Comment extends WP_UnitTestCase {
 		$this->assertSame( array(), $found );
 	}
 
+	/**
+	 * Tests that get_cancel_comment_reply_link() returns the expected value.
+	 *
+	 * @ticket 53962
+	 *
+	 * @dataProvider data_get_cancel_comment_reply_link
+	 *
+	 * @covers ::get_cancel_comment_reply_link
+	 *
+	 * @param string        $text       Text to display for cancel reply link.
+	 *                                  If empty, defaults to 'Click here to cancel reply'.
+	 * @param string|int    $post       The post the comment thread is being displayed for.
+	 *                                  Accepts 'POST_ID', 'POST', or an integer post ID.
+	 * @param int|bool|null $replytocom A comment ID (int), whether to generate an approved (true) or unapproved (false) comment,
+	 *                                  or null not to create a comment.
+	 * @param string        $expected   The expected reply link.
+	 */
+	public function test_get_cancel_comment_reply_link( $text, $post, $replytocom, $expected ) {
+		if ( 'POST_ID' === $post ) {
+			$post = self::$post_id;
+		} elseif ( 'POST' === $post ) {
+			$post = self::factory()->post->get_object_by_id( self::$post_id );
+		}
+
+		if ( null === $replytocom ) {
+			unset( $_GET['replytocom'] );
+		} else {
+			$_GET['replytocom'] = $this->create_comment_with_approval_status( $replytocom );
+		}
+
+		$this->assertSame( $expected, get_cancel_comment_reply_link( $text, $post ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_cancel_comment_reply_link() {
+		return array(
+			'text as empty string, a valid post ID and an approved comment'    => array(
+				'text'       => '',
+				'post'       => 'POST_ID',
+				'replytocom' => true,
+				'expected'   => '<a rel="nofollow" id="cancel-comment-reply-link" href="#respond">Click here to cancel reply.</a>',
+			),
+			'text as a custom string, a valid post ID and an approved comment' => array(
+				'text'       => 'Leave a reply!',
+				'post'       => 'POST_ID',
+				'replytocom' => true,
+				'expected'   => '<a rel="nofollow" id="cancel-comment-reply-link" href="#respond">Leave a reply!</a>',
+			),
+			'text as empty string, a valid WP_Post object and an approved comment' => array(
+				'text'       => '',
+				'post'       => 'POST',
+				'replytocom' => true,
+				'expected'   => '<a rel="nofollow" id="cancel-comment-reply-link" href="#respond">Click here to cancel reply.</a>',
+			),
+			'text as a custom string, a valid WP_Post object and an approved comment' => array(
+				'text'       => 'Leave a reply!',
+				'post'       => 'POST',
+				'replytocom' => true,
+				'expected'   => '<a rel="nofollow" id="cancel-comment-reply-link" href="#respond">Leave a reply!</a>',
+			),
+			'text as empty string, an invalid post and an approved comment'    => array(
+				'text'       => '',
+				'post'       => -99999,
+				'replytocom' => true,
+				'expected'   => '<a rel="nofollow" id="cancel-comment-reply-link" href="#respond" style="display:none;">Click here to cancel reply.</a>',
+			),
+			'text as a custom string, a valid post, but no replytocom' => array(
+				'text'       => 'Leave a reply!',
+				'post'       => 'POST',
+				'replytocom' => null,
+				'expected'   => '<a rel="nofollow" id="cancel-comment-reply-link" href="#respond" style="display:none;">Leave a reply!</a>',
+			),
+		);
+	}
+
+	/**
+	 * Tests that comment_form_title() outputs the author of an approved comment.
+	 *
+	 * @ticket 53962
+	 *
+	 * @covers ::comment_form_title
+	 */
+	public function test_should_output_the_author_of_an_approved_comment() {
+		// Must be set for `comment_form_title()`.
+		$_GET['replytocom'] = $this->create_comment_with_approval_status( true );
+
+		$comment = get_comment( $_GET['replytocom'] );
+		comment_form_title( false, false, false, self::$post_id );
+
+		$this->assertInstanceOf(
+			'WP_Comment',
+			$comment,
+			'The comment is not an instance of WP_Comment.'
+		);
+
+		$this->assertObjectHasAttribute(
+			'comment_author',
+			$comment,
+			'The comment object does not have a "comment_author" property.'
+		);
+
+		$this->assertIsString(
+			$comment->comment_author,
+			'The "comment_author" is not a string.'
+		);
+
+		$this->expectOutputString(
+			'Leave a Reply to ' . $comment->comment_author,
+			'The expected string was not output.'
+		);
+	}
+
+	/**
+	 * Tests that get_comment_id_fields() allows replying to an approved comment.
+	 *
+	 * @ticket 53962
+	 *
+	 * @dataProvider data_should_allow_reply_to_an_approved_comment
+	 *
+	 * @covers ::get_comment_id_fields
+	 *
+	 * @param string $comment_post The post of the comment.
+	 *                             Accepts 'POST', 'NEW_POST', 'POST_ID' and 'NEW_POST_ID'.
+	 */
+	public function test_should_allow_reply_to_an_approved_comment( $comment_post ) {
+		// Must be set for `get_comment_id_fields()`.
+		$_GET['replytocom'] = $this->create_comment_with_approval_status( true );
+
+		if ( 'POST_ID' === $comment_post ) {
+			$comment_post = self::$post_id;
+		} elseif ( 'POST' === $comment_post ) {
+			$comment_post = self::factory()->post->get_object_by_id( self::$post_id );
+		}
+
+		$expected  = "<input type='hidden' name='comment_post_ID' value='" . self::$post_id . "' id='comment_post_ID' />\n";
+		$expected .= "<input type='hidden' name='comment_parent' id='comment_parent' value='" . $_GET['replytocom'] . "' />\n";
+		$actual    = get_comment_id_fields( $comment_post );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_allow_reply_to_an_approved_comment() {
+		return array(
+			'a post ID'        => array( 'comment_post' => 'POST_ID' ),
+			'a WP_Post object' => array( 'comment_post' => 'POST' ),
+		);
+	}
+
+	/**
+	 * Tests that get_comment_id_fields() returns an empty string
+	 * when the post cannot be retrieved.
+	 *
+	 * @ticket 53962
+	 *
+	 * @dataProvider data_non_existent_posts
+	 *
+	 * @covers ::get_comment_id_fields
+	 *
+	 * @param bool  $replytocom   Whether to create an approved (true) or unapproved (false) comment.
+	 * @param int   $comment_post The post of the comment.
+	 *
+	 */
+	public function test_should_return_empty_string( $replytocom, $comment_post ) {
+		if ( is_bool( $replytocom ) ) {
+			$replytocom = $this->create_comment_with_approval_status( $replytocom );
+		}
+
+		// Must be set for `get_comment_id_fields()`.
+		$_GET['replytocom'] = $replytocom;
+
+		$actual = get_comment_id_fields( $comment_post );
+
+		$this->assertSame( '', $actual );
+	}
+
+	/**
+	 * Tests that comment_form_title() does not output the author.
+	 *
+	 * @ticket 53962
+	 *
+	 * @covers ::comment_form_title
+	 *
+	 * @dataProvider data_parent_comments
+	 * @dataProvider data_non_existent_posts
+	 *
+	 * @param bool   $replytocom   Whether to create an approved (true) or unapproved (false) comment.
+	 * @param string $comment_post The post of the comment.
+	 *                             Accepts 'POST', 'NEW_POST', 'POST_ID' and 'NEW_POST_ID'.
+	 */
+	public function test_should_not_output_the_author( $replytocom, $comment_post ) {
+		if ( is_bool( $replytocom ) ) {
+			$replytocom = $this->create_comment_with_approval_status( $replytocom );
+		}
+
+		// Must be set for `comment_form_title()`.
+		$_GET['replytocom'] = $replytocom;
+
+		if ( 'NEW_POST_ID' === $comment_post ) {
+			$comment_post = self::factory()->post->create();
+		} elseif ( 'NEW_POST' === $comment_post ) {
+			$comment_post = self::factory()->post->create_and_get();
+		} elseif ( 'POST_ID' === $comment_post ) {
+			$comment_post = self::$post_id;
+		} elseif ( 'POST' === $comment_post ) {
+			$comment_post = self::factory()->post->get_object_by_id( self::$post_id );
+		}
+
+		$comment_post_id = $comment_post instanceof WP_Post ? $comment_post->ID : $comment_post;
+
+		get_comment( $_GET['replytocom'] );
+
+		comment_form_title( false, false, false, $comment_post_id );
+
+		$this->expectOutputString( 'Leave a Reply' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_non_existent_posts() {
+		return array(
+			'an unapproved comment and a non-existent post ID' => array(
+				'replytocom'   => false,
+				'comment_post' => -99999,
+			),
+			'an approved comment and a non-existent post ID' => array(
+				'replytocom'   => true,
+				'comment_post' => -99999,
+			),
+		);
+	}
+
+	/**
+	 * Tests that get_comment_id_fields() does not allow replies when
+	 * the comment does not have a parent post.
+	 *
+	 * @ticket 53962
+	 *
+	 * @covers ::get_comment_id_fields
+	 *
+	 * @dataProvider data_parent_comments
+	 *
+	 * @param mixed  $replytocom   Whether to create an approved (true) or unapproved (false) comment,
+	 *                             or an invalid comment ID.
+	 * @param string $comment_post The post of the comment.
+	 *                             Accepts 'POST', 'NEW_POST', 'POST_ID' and 'NEW_POST_ID'.
+	 */
+	public function test_should_not_allow_reply( $replytocom, $comment_post ) {
+		if ( is_bool( $replytocom ) ) {
+			$replytocom = $this->create_comment_with_approval_status( $replytocom );
+		}
+
+		// Must be set for `get_comment_id_fields()`.
+		$_GET['replytocom'] = $replytocom;
+
+		if ( 'NEW_POST_ID' === $comment_post ) {
+			$comment_post = self::factory()->post->create();
+		} elseif ( 'NEW_POST' === $comment_post ) {
+			$comment_post = self::factory()->post->create_and_get();
+		} elseif ( 'POST_ID' === $comment_post ) {
+			$comment_post = self::$post_id;
+		} elseif ( 'POST' === $comment_post ) {
+			$comment_post = self::factory()->post->get_object_by_id( self::$post_id );
+		}
+
+		$comment_post_id = $comment_post instanceof WP_Post ? $comment_post->ID : $comment_post;
+
+		$expected  = "<input type='hidden' name='comment_post_ID' value='" . $comment_post_id . "' id='comment_post_ID' />\n";
+		$expected .= "<input type='hidden' name='comment_parent' id='comment_parent' value='0' />\n";
+		$actual    = get_comment_id_fields( $comment_post );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_parent_comments() {
+		return array(
+			'an unapproved parent comment (ID)'      => array(
+				'replytocom'   => false,
+				'comment_post' => 'POST_ID',
+			),
+			'an approved parent comment on another post (ID)' => array(
+				'replytocom'   => true,
+				'comment_post' => 'NEW_POST_ID',
+			),
+			'an unapproved parent comment on another post (ID)' => array(
+				'replytocom'   => false,
+				'comment_post' => 'NEW_POST_ID',
+			),
+			'a parent comment ID that cannot be cast to an integer' => array(
+				'replytocom'   => array( 'I cannot be cast to an integer.' ),
+				'comment_post' => 'POST_ID',
+			),
+			'an unapproved parent comment (WP_Post)' => array(
+				'replytocom'   => false,
+				'comment_post' => 'POST',
+			),
+			'an approved parent comment on another post (WP_Post)' => array(
+				'replytocom'   => true,
+				'comment_post' => 'NEW_POST',
+			),
+			'an unapproved parent comment on another post (WP_Post)' => array(
+				'replytocom'   => false,
+				'comment_post' => 'NEW_POST',
+			),
+			'a parent comment WP_Post that cannot be cast to an integer' => array(
+				'replytocom'   => array( 'I cannot be cast to an integer.' ),
+				'comment_post' => 'POST',
+			),
+		);
+	}
+
+	/**
+	 * Helper function to create a comment with an approval status.
+	 *
+	 * @since 6.2.0
+	 *
+	 * @param bool $approved Whether or not the comment is approved.
+	 * @return int The comment ID.
+	 */
+	public function create_comment_with_approval_status( $approved ) {
+		return self::factory()->comment->create(
+			array(
+				'comment_post_ID'  => self::$post_id,
+				'comment_approved' => ( $approved ) ? '1' : '0',
+			)
+		);
+	}
+
+	/**
+	 * Tests that _get_comment_reply_id() returns the expected value.
+	 *
+	 * @ticket 53962
+	 *
+	 * @dataProvider data_get_comment_reply_id
+	 *
+	 * @covers ::_get_comment_reply_id
+	 *
+	 * @param int|bool|null $replytocom A comment ID (int), whether to generate an approved (true) or unapproved (false) comment,
+	 *                                  or null not to create a comment.
+	 * @param string|int    $post       The post the comment thread is being displayed for.
+	 *                                  Accepts 'POST_ID', 'POST', or an integer post ID.
+	 * @param int           $expected   The expected result.
+	 */
+	public function test_get_comment_reply_id( $replytocom, $post, $expected ) {
+		if ( false === $replytocom ) {
+			unset( $_GET['replytocom'] );
+		} else {
+			$_GET['replytocom'] = $this->create_comment_with_approval_status( (bool) $replytocom );
+		}
+
+		if ( 'POST_ID' === $post ) {
+			$post = self::$post_id;
+		} elseif ( 'POST' === $post ) {
+			$post = self::factory()->post->get_object_by_id( self::$post_id );
+		}
+
+		if ( 'replytocom' === $expected ) {
+			$expected = $_GET['replytocom'];
+		}
+
+		$this->assertSame( $expected, _get_comment_reply_id( $post ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_comment_reply_id() {
+		return array(
+			'no comment ID set ($_GET["replytocom"])'     => array(
+				'replytocom' => false,
+				'post'       => 0,
+				'expected'   => 0,
+			),
+			'a non-numeric comment ID'                    => array(
+				'replytocom' => 'three',
+				'post'       => 0,
+				'expected'   => 0,
+			),
+			'a non-existent comment ID'                   => array(
+				'replytocom' => -999999,
+				'post'       => 0,
+				'expected'   => 0,
+			),
+			'an unapproved comment'                       => array(
+				'replytocom' => false,
+				'post'       => 0,
+				'expected'   => 0,
+			),
+			'a post that does not match the parent'       => array(
+				'replytocom' => false,
+				'post'       => -999999,
+				'expected'   => 0,
+			),
+			'an approved comment and the correct post ID' => array(
+				'replytocom' => true,
+				'post'       => 'POST_ID',
+				'expected'   => 'replytocom',
+			),
+			'an approved comment and the correct WP_Post object' => array(
+				'replytocom' => true,
+				'post'       => 'POST',
+				'expected'   => 'replytocom',
+			),
+		);
+	}
+
 	/**
 	 * @ticket 14279
 	 *
@@ -1143,244 +1567,8 @@ class Tests_Comment extends WP_UnitTestCase {
 	}
 
 	/**
-	 * The `wp_comments_personal_data_eraser()` function should erase user's comments.
-	 *
-	 * @group privacy
-	 * @ticket 43442
-	 *
-	 * @covers ::wp_comments_personal_data_eraser
-	 */
-	public function test_wp_comments_personal_data_eraser() {
-
-		$post_id = self::factory()->post->create();
-		$user_id = self::factory()->user->create();
-
-		$args       = array(
-			'user_id'              => $user_id,
-			'comment_post_ID'      => $post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-04-14 17:20:00',
-			'comment_agent'        => 'COMMENT_AGENT',
-			'comment_content'      => 'Comment Content',
-		);
-		$comment_id = self::factory()->comment->create( $args );
-
-		wp_comments_personal_data_eraser( $args['comment_author_email'] );
-
-		$comment = get_comment( $comment_id );
-
-		$actual = array(
-			'comment_ID'           => $comment->comment_ID,
-			'user_id'              => $comment->user_id,
-			'comment_author'       => $comment->comment_author,
-			'comment_author_email' => $comment->comment_author_email,
-			'comment_author_url'   => $comment->comment_author_url,
-			'comment_author_IP'    => $comment->comment_author_IP,
-			'comment_date'         => $comment->comment_date,
-			'comment_date_gmt'     => $comment->comment_date_gmt,
-			'comment_agent'        => $comment->comment_agent,
-			'comment_content'      => $comment->comment_content,
-		);
-
-		$expected = array(
-			'comment_ID'           => (string) $comment_id,
-			'user_id'              => '0', // Anonymized.
-			'comment_author'       => 'Anonymous', // Anonymized.
-			'comment_author_email' => '', // Anonymized.
-			'comment_author_url'   => '', // Anonymized.
-			'comment_author_IP'    => '192.168.0.0', // Anonymized.
-			'comment_date'         => '2018-04-14 17:20:00',
-			'comment_date_gmt'     => '2018-04-14 17:20:00',
-			'comment_agent'        => '', // Anonymized.
-			'comment_content'      => 'Comment Content',
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_eraser()` function's output on an empty first page.
-	 *
-	 * @group privacy
-	 * @ticket 43442
-	 *
-	 * @covers ::wp_comments_personal_data_eraser
-	 */
-	public function test_wp_comments_personal_data_eraser_empty_first_page_output() {
-
-		$actual   = wp_comments_personal_data_eraser( 'nocommentsfound@local.host' );
-		$expected = array(
-			'items_removed'  => false,
-			'items_retained' => false,
-			'messages'       => array(),
-			'done'           => true,
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_eraser()` function's output, for the non-empty first page.
-	 *
-	 * @group privacy
-	 * @ticket 43442
-	 *
-	 * @covers ::wp_comments_personal_data_eraser
-	 */
-	public function test_wp_comments_personal_data_eraser_non_empty_first_page_output() {
-
-		$post_id = self::factory()->post->create();
-		$args    = array(
-			'comment_post_ID'      => $post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-04-14 17:20:00',
-			'comment_agent'        => 'COMMENT_AGENT',
-			'comment_content'      => 'Comment Content',
-		);
-		self::factory()->comment->create( $args );
-
-		$actual   = wp_comments_personal_data_eraser( $args['comment_author_email'] );
-		$expected = array(
-			'items_removed'  => true,
-			'items_retained' => false,
-			'messages'       => array(),
-			'done'           => true,
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_eraser()` function's output, for an empty second page.
-	 *
-	 * @group privacy
-	 * @ticket 43442
-	 *
-	 * @covers ::wp_comments_personal_data_eraser
-	 */
-	public function test_wp_comments_personal_data_eraser_empty_second_page_output() {
-
-		$post_id = self::factory()->post->create();
-		$args    = array(
-			'comment_post_ID'      => $post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-04-14 17:20:00',
-			'comment_agent'        => 'COMMENT_AGENT',
-			'comment_content'      => 'Comment Content',
-		);
-		self::factory()->comment->create( $args );
-
-		$actual   = wp_comments_personal_data_eraser( $args['comment_author_email'], 2 );
-		$expected = array(
-			'items_removed'  => false,
-			'items_retained' => false,
-			'messages'       => array(),
-			'done'           => true,
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Testing the `wp_anonymize_comment` filter, to prevent comment anonymization.
-	 *
-	 * @group privacy
-	 * @ticket 43442
-	 *
-	 * @covers ::wp_comments_personal_data_eraser
-	 */
-	public function test_wp_anonymize_comment_filter_to_prevent_comment_anonymization() {
-
-		$post_id    = self::factory()->post->create();
-		$args       = array(
-			'comment_post_ID'      => $post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-04-14 17:20:00',
-			'comment_agent'        => 'COMMENT_AGENT',
-			'comment_content'      => 'Comment Content',
-		);
-		$comment_id = self::factory()->comment->create( $args );
-
-		add_filter( 'wp_anonymize_comment', '__return_false' );
-		$actual = wp_comments_personal_data_eraser( $args['comment_author_email'] );
-		remove_filter( 'wp_anonymize_comment', '__return_false' );
-
-		$message = sprintf( 'Comment %d contains personal data but could not be anonymized.', $comment_id );
-
-		$expected = array(
-			'items_removed'  => false,
-			'items_retained' => true,
-			'messages'       => array( $message ),
-			'done'           => true,
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Testing the `wp_anonymize_comment` filter, to prevent comment anonymization, with a custom message.
-	 *
-	 * @group privacy
-	 * @ticket 43442
-	 *
-	 * @covers ::wp_comments_personal_data_eraser
-	 */
-	public function test_wp_anonymize_comment_filter_to_prevent_comment_anonymization_with_custom_message() {
-
-		$post_id    = self::factory()->post->create();
-		$args       = array(
-			'comment_post_ID'      => $post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-04-14 17:20:00',
-			'comment_agent'        => 'COMMENT_AGENT',
-			'comment_content'      => 'Comment Content',
-		);
-		$comment_id = self::factory()->comment->create( $args );
-
-		add_filter( 'wp_anonymize_comment', array( $this, 'wp_anonymize_comment_custom_message' ), 10, 3 );
-		$actual = wp_comments_personal_data_eraser( $args['comment_author_email'] );
-		remove_filter( 'wp_anonymize_comment', array( $this, 'wp_anonymize_comment_custom_message' ) );
-
-		$message = sprintf( 'Some custom message for comment %d.', $comment_id );
-
-		$expected = array(
-			'items_removed'  => false,
-			'items_retained' => true,
-			'messages'       => array( $message ),
-			'done'           => true,
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Callback for the `wp_anonymize_comment` filter.
-	 *
-	 * @param  bool|string $anonymize          Whether to apply the comment anonymization (bool).
-	 *                                         Custom prevention message (string). Default true.
-	 * @param  WP_Comment  $comment            WP_Comment object.
-	 * @param  array       $anonymized_comment Anonymized comment data.
-	 * @return string
+	 * @covers ::wp_update_comment
 	 */
-	public function wp_anonymize_comment_custom_message( $anonymize, $comment, $anonymized_comment ) {
-		return sprintf( 'Some custom message for comment %d.', $comment->comment_ID );
-	}
-
 	public function test_update_should_invalidate_comment_cache() {
 		global $wpdb;
 
@@ -1472,135 +1660,4 @@ class Tests_Comment extends WP_UnitTestCase {
 
 		$this->assertSame( '1', $comment->comment_approved );
 	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_exporter()` function.
-	 *
-	 * @group privacy
-	 * @ticket 43440
-	 *
-	 * @covers ::wp_comments_personal_data_exporter
-	 */
-	public function test_wp_comments_personal_data_exporter() {
-		$args = array(
-			'comment_post_ID'      => self::$post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_agent'        => 'SOME_AGENT',
-			'comment_date'         => '2018-03-28 20:05:00',
-			'comment_content'      => 'Comment',
-		);
-
-		$comment_id = self::factory()->comment->create( $args );
-
-		$actual   = wp_comments_personal_data_exporter( $args['comment_author_email'] );
-		$expected = $args;
-
-		$this->assertTrue( $actual['done'] );
-
-		// Number of exported comments.
-		$this->assertCount( 1, $actual['data'] );
-
-		// Number of exported comment properties.
-		$this->assertCount( 8, $actual['data'][0]['data'] );
-
-		// Exported group.
-		$this->assertSame( 'comments', $actual['data'][0]['group_id'] );
-		$this->assertSame( 'Comments', $actual['data'][0]['group_label'] );
-
-		// Exported comment properties.
-		$this->assertSame( $expected['comment_author'], $actual['data'][0]['data'][0]['value'] );
-		$this->assertSame( $expected['comment_author_email'], $actual['data'][0]['data'][1]['value'] );
-		$this->assertSame( $expected['comment_author_url'], $actual['data'][0]['data'][2]['value'] );
-		$this->assertSame( $expected['comment_author_IP'], $actual['data'][0]['data'][3]['value'] );
-		$this->assertSame( $expected['comment_agent'], $actual['data'][0]['data'][4]['value'] );
-		$this->assertSame( $expected['comment_date'], $actual['data'][0]['data'][5]['value'] );
-		$this->assertSame( $expected['comment_content'], $actual['data'][0]['data'][6]['value'] );
-		$this->assertSame( esc_html( get_comment_link( $comment_id ) ), strip_tags( $actual['data'][0]['data'][7]['value'] ) );
-	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_exporter()` function for no comments found.
-	 *
-	 * @group privacy
-	 * @ticket 43440
-	 *
-	 * @covers ::wp_comments_personal_data_exporter
-	 */
-	public function test_wp_comments_personal_data_exporter_no_comments_found() {
-
-		$actual = wp_comments_personal_data_exporter( 'nocommentsfound@local.host' );
-
-		$expected = array(
-			'data' => array(),
-			'done' => true,
-		);
-
-		$this->assertSame( $expected, $actual );
-	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_exporter()` function for an empty comment property.
-	 *
-	 * @group privacy
-	 * @ticket 43440
-	 *
-	 * @covers ::wp_comments_personal_data_exporter
-	 */
-	public function test_wp_comments_personal_data_exporter_empty_comment_prop() {
-		$args = array(
-			'comment_post_ID'      => self::$post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-03-28 20:05:00',
-			'comment_agent'        => '',
-			'comment_content'      => 'Comment',
-		);
-
-		$c = self::factory()->comment->create( $args );
-
-		$actual = wp_comments_personal_data_exporter( $args['comment_author_email'] );
-
-		$this->assertTrue( $actual['done'] );
-
-		// Number of exported comments.
-		$this->assertCount( 1, $actual['data'] );
-
-		// Number of exported comment properties.
-		$this->assertCount( 7, $actual['data'][0]['data'] );
-	}
-
-	/**
-	 * Testing the `wp_comments_personal_data_exporter()` function with an empty second page.
-	 *
-	 * @group privacy
-	 * @ticket 43440
-	 *
-	 * @covers ::wp_comments_personal_data_exporter
-	 */
-	public function test_wp_comments_personal_data_exporter_empty_second_page() {
-		$args = array(
-			'comment_post_ID'      => self::$post_id,
-			'comment_author'       => 'Comment Author',
-			'comment_author_email' => 'personal@local.host',
-			'comment_author_url'   => 'https://local.host/',
-			'comment_author_IP'    => '192.168.0.1',
-			'comment_date'         => '2018-03-28 20:05:00',
-			'comment_agent'        => 'SOME_AGENT',
-			'comment_content'      => 'Comment',
-		);
-
-		$c = self::factory()->comment->create( $args );
-
-		$actual = wp_comments_personal_data_exporter( $args['comment_author_email'], 2 );
-
-		$this->assertTrue( $actual['done'] );
-
-		// Number of exported comments.
-		$this->assertCount( 0, $actual['data'] );
-	}
 }
diff --git a/tests/comment/isAvatarCommentType.php b/tests/comment/isAvatarCommentType.php
index 57ed593b1b..f45caae93b 100644
--- a/tests/comment/isAvatarCommentType.php
+++ b/tests/comment/isAvatarCommentType.php
@@ -5,15 +5,9 @@
  * @package WordPress\UnitTests
  *
  * @since 5.1.0
- */
-
-/**
- * Tests_Comment_IsAvatarCommentType class.
  *
  * @group comment
  *
- * @since 5.1.0
- *
  * @covers ::is_avatar_comment_type
  */
 class Tests_Comment_IsAvatarCommentType extends WP_UnitTestCase {
diff --git a/tests/comment/wpCommentsPersonalDataEraser.php b/tests/comment/wpCommentsPersonalDataEraser.php
new file mode 100644
index 0000000000..ef7ccc4091
--- /dev/null
+++ b/tests/comment/wpCommentsPersonalDataEraser.php
@@ -0,0 +1,261 @@
+<?php
+
+/**
+ * @group comment
+ * @group privacy
+ *
+ * @covers ::wp_comments_personal_data_eraser
+ */
+class Tests_Comment_wpCommentsPersonalDataEraser extends WP_UnitTestCase {
+
+	protected static $post_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$post_id = $factory->post->create();
+	}
+
+	/**
+	 * The `wp_comments_personal_data_eraser()` function should erase user's comments.
+	 *
+	 * @ticket 43442
+	 */
+	public function test_wp_comments_personal_data_eraser() {
+
+		$user_id = self::factory()->user->create();
+
+		$args       = array(
+			'user_id'              => $user_id,
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_agent'        => 'COMMENT_AGENT',
+			'comment_content'      => 'Comment Content',
+		);
+		$comment_id = self::factory()->comment->create( $args );
+
+		wp_comments_personal_data_eraser( $args['comment_author_email'] );
+
+		$comment = get_comment( $comment_id );
+
+		$actual = array(
+			'comment_ID'           => $comment->comment_ID,
+			'user_id'              => $comment->user_id,
+			'comment_author'       => $comment->comment_author,
+			'comment_author_email' => $comment->comment_author_email,
+			'comment_author_url'   => $comment->comment_author_url,
+			'comment_author_IP'    => $comment->comment_author_IP,
+			'comment_date'         => $comment->comment_date,
+			'comment_date_gmt'     => $comment->comment_date_gmt,
+			'comment_agent'        => $comment->comment_agent,
+			'comment_content'      => $comment->comment_content,
+		);
+
+		$expected = array(
+			'comment_ID'           => (string) $comment_id,
+			'user_id'              => '0', // Anonymized.
+			'comment_author'       => 'Anonymous', // Anonymized.
+			'comment_author_email' => '', // Anonymized.
+			'comment_author_url'   => '', // Anonymized.
+			'comment_author_IP'    => '192.168.0.0', // Anonymized.
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_date_gmt'     => '2018-04-14 17:20:00',
+			'comment_agent'        => '', // Anonymized.
+			'comment_content'      => 'Comment Content',
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_eraser()` function's output on an empty first page.
+	 *
+	 * @ticket 43442
+	 */
+	public function test_wp_comments_personal_data_eraser_empty_first_page_output() {
+
+		$actual   = wp_comments_personal_data_eraser( 'nocommentsfound@local.host' );
+		$expected = array(
+			'items_removed'  => false,
+			'items_retained' => false,
+			'messages'       => array(),
+			'done'           => true,
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_eraser()` function's output, for the non-empty first page.
+	 *
+	 * @ticket 43442
+	 */
+	public function test_wp_comments_personal_data_eraser_non_empty_first_page_output() {
+
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_agent'        => 'COMMENT_AGENT',
+			'comment_content'      => 'Comment Content',
+		);
+		self::factory()->comment->create( $args );
+
+		$actual   = wp_comments_personal_data_eraser( $args['comment_author_email'] );
+		$expected = array(
+			'items_removed'  => true,
+			'items_retained' => false,
+			'messages'       => array(),
+			'done'           => true,
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_eraser()` function's output, for an empty second page.
+	 *
+	 * @ticket 43442
+	 */
+	public function test_wp_comments_personal_data_eraser_empty_second_page_output() {
+
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_agent'        => 'COMMENT_AGENT',
+			'comment_content'      => 'Comment Content',
+		);
+		self::factory()->comment->create( $args );
+
+		$actual   = wp_comments_personal_data_eraser( $args['comment_author_email'], 2 );
+		$expected = array(
+			'items_removed'  => false,
+			'items_retained' => false,
+			'messages'       => array(),
+			'done'           => true,
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing the `wp_anonymize_comment` filter, to prevent comment anonymization.
+	 *
+	 * @ticket 43442
+	 */
+	public function test_wp_anonymize_comment_filter_to_prevent_comment_anonymization() {
+
+		$args       = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_agent'        => 'COMMENT_AGENT',
+			'comment_content'      => 'Comment Content',
+		);
+		$comment_id = self::factory()->comment->create( $args );
+
+		add_filter( 'wp_anonymize_comment', '__return_false' );
+		$actual = wp_comments_personal_data_eraser( $args['comment_author_email'] );
+		remove_filter( 'wp_anonymize_comment', '__return_false' );
+
+		$message = sprintf( 'Comment %d contains personal data but could not be anonymized.', $comment_id );
+
+		$expected = array(
+			'items_removed'  => false,
+			'items_retained' => true,
+			'messages'       => array( $message ),
+			'done'           => true,
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing the `wp_anonymize_comment` filter, to prevent comment anonymization, with a custom message.
+	 *
+	 * @ticket 43442
+	 */
+	public function test_wp_anonymize_comment_filter_to_prevent_comment_anonymization_with_custom_message() {
+
+		$args       = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_agent'        => 'COMMENT_AGENT',
+			'comment_content'      => 'Comment Content',
+		);
+		$comment_id = self::factory()->comment->create( $args );
+
+		add_filter( 'wp_anonymize_comment', array( $this, 'wp_anonymize_comment_custom_message' ), 10, 3 );
+		$actual = wp_comments_personal_data_eraser( $args['comment_author_email'] );
+		remove_filter( 'wp_anonymize_comment', array( $this, 'wp_anonymize_comment_custom_message' ) );
+
+		$message = sprintf( 'Some custom message for comment %d.', $comment_id );
+
+		$expected = array(
+			'items_removed'  => false,
+			'items_retained' => true,
+			'messages'       => array( $message ),
+			'done'           => true,
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Callback for the `wp_anonymize_comment` filter.
+	 *
+	 * @param  bool|string $anonymize          Whether to apply the comment anonymization (bool).
+	 *                                         Custom prevention message (string). Default true.
+	 * @param  WP_Comment  $comment            WP_Comment object.
+	 * @param  array       $anonymized_comment Anonymized comment data.
+	 * @return string
+	 */
+	public function wp_anonymize_comment_custom_message( $anonymize, $comment, $anonymized_comment ) {
+		return sprintf( 'Some custom message for comment %d.', $comment->comment_ID );
+	}
+
+	/**
+	 * Testing that `wp_comments_personal_data_eraser()` orders comments by ID.
+	 *
+	 * @ticket 57700
+	 */
+	public function test_wp_comments_personal_data_eraser_orders_comments_by_id() {
+
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-04-14 17:20:00',
+			'comment_agent'        => 'COMMENT_AGENT',
+			'comment_content'      => 'Comment Content',
+		);
+		self::factory()->comment->create( $args );
+
+		$filter = new MockAction();
+		add_filter( 'comments_clauses', array( &$filter, 'filter' ) );
+
+		wp_comments_personal_data_eraser( $args['comment_author_email'] );
+
+		$clauses = $filter->get_args()[0][0];
+
+		$this->assertStringContainsString( 'comment_ID', $clauses['orderby'] );
+	}
+}
diff --git a/tests/comment/wpCommentsPersonalDataExporter.php b/tests/comment/wpCommentsPersonalDataExporter.php
new file mode 100644
index 0000000000..f3fce0f804
--- /dev/null
+++ b/tests/comment/wpCommentsPersonalDataExporter.php
@@ -0,0 +1,164 @@
+<?php
+
+/**
+ * @group comment
+ * @group privacy
+ *
+ * @covers ::wp_comments_personal_data_exporter
+ */
+class Tests_Comment_wpCommentsPersonalDataExporter extends WP_UnitTestCase {
+
+	protected static $post_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$post_id = $factory->post->create();
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_exporter()` function.
+	 *
+	 * @ticket 43440
+	 */
+	public function test_wp_comments_personal_data_exporter() {
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_agent'        => 'SOME_AGENT',
+			'comment_date'         => '2018-03-28 20:05:00',
+			'comment_content'      => 'Comment',
+		);
+
+		$comment_id = self::factory()->comment->create( $args );
+
+		$actual   = wp_comments_personal_data_exporter( $args['comment_author_email'] );
+		$expected = $args;
+
+		$this->assertTrue( $actual['done'] );
+
+		// Number of exported comments.
+		$this->assertCount( 1, $actual['data'] );
+
+		// Number of exported comment properties.
+		$this->assertCount( 8, $actual['data'][0]['data'] );
+
+		// Exported group.
+		$this->assertSame( 'comments', $actual['data'][0]['group_id'] );
+		$this->assertSame( 'Comments', $actual['data'][0]['group_label'] );
+
+		// Exported comment properties.
+		$this->assertSame( $expected['comment_author'], $actual['data'][0]['data'][0]['value'] );
+		$this->assertSame( $expected['comment_author_email'], $actual['data'][0]['data'][1]['value'] );
+		$this->assertSame( $expected['comment_author_url'], $actual['data'][0]['data'][2]['value'] );
+		$this->assertSame( $expected['comment_author_IP'], $actual['data'][0]['data'][3]['value'] );
+		$this->assertSame( $expected['comment_agent'], $actual['data'][0]['data'][4]['value'] );
+		$this->assertSame( $expected['comment_date'], $actual['data'][0]['data'][5]['value'] );
+		$this->assertSame( $expected['comment_content'], $actual['data'][0]['data'][6]['value'] );
+		$this->assertSame( esc_html( get_comment_link( $comment_id ) ), strip_tags( $actual['data'][0]['data'][7]['value'] ) );
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_exporter()` function for no comments found.
+	 *
+	 * @ticket 43440
+	 */
+	public function test_wp_comments_personal_data_exporter_no_comments_found() {
+
+		$actual = wp_comments_personal_data_exporter( 'nocommentsfound@local.host' );
+
+		$expected = array(
+			'data' => array(),
+			'done' => true,
+		);
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_exporter()` function for an empty comment property.
+	 *
+	 * @ticket 43440
+	 */
+	public function test_wp_comments_personal_data_exporter_empty_comment_prop() {
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-03-28 20:05:00',
+			'comment_agent'        => '',
+			'comment_content'      => 'Comment',
+		);
+
+		$c = self::factory()->comment->create( $args );
+
+		$actual = wp_comments_personal_data_exporter( $args['comment_author_email'] );
+
+		$this->assertTrue( $actual['done'] );
+
+		// Number of exported comments.
+		$this->assertCount( 1, $actual['data'] );
+
+		// Number of exported comment properties.
+		$this->assertCount( 7, $actual['data'][0]['data'] );
+	}
+
+	/**
+	 * Testing the `wp_comments_personal_data_exporter()` function with an empty second page.
+	 *
+	 * @ticket 43440
+	 */
+	public function test_wp_comments_personal_data_exporter_empty_second_page() {
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-03-28 20:05:00',
+			'comment_agent'        => 'SOME_AGENT',
+			'comment_content'      => 'Comment',
+		);
+
+		$c = self::factory()->comment->create( $args );
+
+		$actual = wp_comments_personal_data_exporter( $args['comment_author_email'], 2 );
+
+		$this->assertTrue( $actual['done'] );
+
+		// Number of exported comments.
+		$this->assertCount( 0, $actual['data'] );
+	}
+
+	/**
+	 * Testing that `wp_comments_personal_data_exporter()` orders comments by ID.
+	 *
+	 * @ticket 57700
+	 */
+	public function test_wp_comments_personal_data_exporter_orders_comments_by_id() {
+
+		$args = array(
+			'comment_post_ID'      => self::$post_id,
+			'comment_author'       => 'Comment Author',
+			'comment_author_email' => 'personal@local.host',
+			'comment_author_url'   => 'https://local.host/',
+			'comment_author_IP'    => '192.168.0.1',
+			'comment_date'         => '2018-03-28 20:05:00',
+			'comment_agent'        => 'SOME_AGENT',
+			'comment_content'      => 'Comment',
+		);
+		self::factory()->comment->create( $args );
+
+		$filter = new MockAction();
+		add_filter( 'comments_clauses', array( &$filter, 'filter' ) );
+
+		wp_comments_personal_data_exporter( $args['comment_author_email'] );
+
+		$clauses = $filter->get_args()[0][0];
+
+		$this->assertStringContainsString( 'comment_ID', $clauses['orderby'] );
+	}
+}
diff --git a/tests/comment/wpHandleCommentSubmission.php b/tests/comment/wpHandleCommentSubmission.php
index e4ec77af7a..ff2f3c8b7a 100644
--- a/tests/comment/wpHandleCommentSubmission.php
+++ b/tests/comment/wpHandleCommentSubmission.php
@@ -882,4 +882,124 @@ class Tests_Comment_wpHandleCommentSubmission extends WP_UnitTestCase {
 		$this->assertNotWPError( $second_comment );
 		$this->assertEquals( self::$post->ID, $second_comment->comment_post_ID );
 	}
+
+	/**
+	 * Tests that wp_handle_comment_submission() only allows replying to
+	 * an approved parent comment.
+	 *
+	 * @ticket 53962
+	 *
+	 * @dataProvider data_should_only_allow_replying_to_an_approved_parent_comment
+	 *
+	 * @param int $approved Whether the parent comment is approved.
+	 */
+	public function test_should_only_allow_replying_to_an_approved_parent_comment( $approved ) {
+		wp_set_current_user( self::$editor_id );
+
+		$comment_parent = self::factory()->comment->create(
+			array(
+				'comment_post_ID'  => self::$post->ID,
+				'comment_approved' => $approved,
+			)
+		);
+
+		$comment = wp_handle_comment_submission(
+			array(
+				'comment_post_ID'      => self::$post->ID,
+				'comment_author'       => 'A comment author',
+				'comment_author_email' => 'comment_author@example.org',
+				'comment'              => 'Howdy, comment!',
+				'comment_parent'       => $comment_parent,
+			)
+		);
+
+		if ( $approved ) {
+			$this->assertInstanceOf(
+				'WP_Comment',
+				$comment,
+				'The comment was not submitted.'
+			);
+		} else {
+			$this->assertWPError( $comment, 'The comment was submitted.' );
+			$this->assertSame(
+				'comment_reply_to_unapproved_comment',
+				$comment->get_error_code(),
+				'The wrong error code was returned.'
+			);
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_only_allow_replying_to_an_approved_parent_comment() {
+		return array(
+			'an approved parent comment'   => array( 'approved' => 1 ),
+			'an unapproved parent comment' => array( 'approved' => 0 ),
+		);
+	}
+
+	/**
+	 * Tests that wp_handle_comment_submission() only allows replying to
+	 * an existing parent comment.
+	 *
+	 * @ticket 53962
+	 *
+	 * @dataProvider data_should_only_allow_replying_to_an_existing_parent_comment
+	 *
+	 * @param bool $exists Whether the parent comment exists.
+	 */
+	public function test_should_only_allow_replying_to_an_existing_parent_comment( $exists ) {
+		wp_set_current_user( self::$editor_id );
+
+		$parent_comment = -99999;
+
+		if ( $exists ) {
+			$parent_comment = self::factory()->comment->create(
+				array(
+					'comment_post_ID'  => self::$post->ID,
+					'comment_approved' => 1,
+				)
+			);
+		}
+
+		$comment = wp_handle_comment_submission(
+			array(
+				'comment_post_ID'      => self::$post->ID,
+				'comment_author'       => 'A comment author',
+				'comment_author_email' => 'comment_author@example.org',
+				'comment'              => 'Howdy, comment!',
+				'comment_parent'       => $parent_comment,
+			)
+		);
+
+		if ( $exists ) {
+			$this->assertInstanceOf(
+				'WP_Comment',
+				$comment,
+				'The comment was not submitted.'
+			);
+		} else {
+			$this->assertWPError( $comment, 'The comment was submitted.' );
+			$this->assertSame(
+				'comment_reply_to_unapproved_comment',
+				$comment->get_error_code(),
+				'The wrong error code was returned.'
+			);
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_only_allow_replying_to_an_existing_parent_comment() {
+		return array(
+			'an existing parent comment'    => array( 'exists' => true ),
+			'a non-existent parent comment' => array( 'exists' => false ),
+		);
+	}
 }
diff --git a/tests/compat/mbStrlen.php b/tests/compat/mbStrlen.php
index 472d5a3bac..bb77e5f2d3 100644
--- a/tests/compat/mbStrlen.php
+++ b/tests/compat/mbStrlen.php
@@ -17,14 +17,14 @@ class Tests_Compat_mbStrlen extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider utf8_string_lengths
+	 * @dataProvider data_utf8_string_lengths
 	 */
 	public function test_mb_strlen( $input_string, $expected_character_length ) {
 		$this->assertSame( $expected_character_length, _mb_strlen( $input_string, 'UTF-8' ) );
 	}
 
 	/**
-	 * @dataProvider utf8_string_lengths
+	 * @dataProvider data_utf8_string_lengths
 	 */
 	public function test_mb_strlen_via_regex( $input_string, $expected_character_length ) {
 		_wp_can_use_pcre_u( false );
@@ -33,7 +33,7 @@ class Tests_Compat_mbStrlen extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider utf8_string_lengths
+	 * @dataProvider data_utf8_string_lengths
 	 */
 	public function test_8bit_mb_strlen( $input_string, $expected_character_length, $expected_byte_length ) {
 		$this->assertSame( $expected_byte_length, _mb_strlen( $input_string, '8bit' ) );
@@ -44,7 +44,7 @@ class Tests_Compat_mbStrlen extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function utf8_string_lengths() {
+	public function data_utf8_string_lengths() {
 		return array(
 			array(
 				'input_string'              => 'баба',
diff --git a/tests/compat/mbSubstr.php b/tests/compat/mbSubstr.php
index 12325bee73..ddf7e662fb 100644
--- a/tests/compat/mbSubstr.php
+++ b/tests/compat/mbSubstr.php
@@ -17,14 +17,14 @@ class Tests_Compat_mbSubstr extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider utf8_substrings
+	 * @dataProvider data_utf8_substrings
 	 */
 	public function test_mb_substr( $input_string, $start, $length, $expected_character_substring ) {
 		$this->assertSame( $expected_character_substring, _mb_substr( $input_string, $start, $length, 'UTF-8' ) );
 	}
 
 	/**
-	 * @dataProvider utf8_substrings
+	 * @dataProvider data_utf8_substrings
 	 */
 	public function test_mb_substr_via_regex( $input_string, $start, $length, $expected_character_substring ) {
 		_wp_can_use_pcre_u( false );
@@ -33,7 +33,7 @@ class Tests_Compat_mbSubstr extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider utf8_substrings
+	 * @dataProvider data_utf8_substrings
 	 */
 	public function test_8bit_mb_substr( $input_string, $start, $length, $expected_character_substring, $expected_byte_substring ) {
 		$this->assertSame( $expected_byte_substring, _mb_substr( $input_string, $start, $length, '8bit' ) );
@@ -44,7 +44,7 @@ class Tests_Compat_mbSubstr extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function utf8_substrings() {
+	public function data_utf8_substrings() {
 		return array(
 			array(
 				'input_string'                 => 'баба',
diff --git a/tests/customize/control.php b/tests/customize/control.php
index 2131bdc844..d472eacad9 100644
--- a/tests/customize/control.php
+++ b/tests/customize/control.php
@@ -1,12 +1,8 @@
 <?php
 /**
- * Test_WP_Customize_Control tests.
+ * Tests for the Test_WP_Customize_Control class.
  *
  * @package WordPress
- */
-
-/**
- * Tests for the Test_WP_Customize_Control class.
  *
  * @todo This is missing dedicated tests for all but one of the methods.
  *
diff --git a/tests/customize/partial.php b/tests/customize/partial.php
index 5e173a8acf..9fc4a478a4 100644
--- a/tests/customize/partial.php
+++ b/tests/customize/partial.php
@@ -1,12 +1,8 @@
 <?php
 /**
- * Test_WP_Customize_Partial tests.
+ * Tests for the Test_WP_Customize_Partial class.
  *
  * @package WordPress
- */
-
-/**
- * Tests for the Test_WP_Customize_Partial class.
  *
  * @group customize
  */
diff --git a/tests/customize/selective-refresh-ajax.php b/tests/customize/selective-refresh-ajax.php
index 040697d419..cb225498f3 100644
--- a/tests/customize/selective-refresh-ajax.php
+++ b/tests/customize/selective-refresh-ajax.php
@@ -1,19 +1,15 @@
 <?php
-/**
- * WP_Customize_Selective_Refresh Ajax tests.
- *
- * @package    WordPress
- * @subpackage UnitTests
- */
-
 /**
  * Tests for the WP_Customize_Selective_Refresh class Ajax.
  *
  * Note that this is intentionally not extending WP_Ajax_UnitTestCase because it
  * is not admin ajax.
  *
- * @since      4.5.0
- * @group      ajax
+ * @package WordPress
+ * @subpackage UnitTests
+ * @since 4.5.0
+ *
+ * @group ajax
  */
 class Test_WP_Customize_Selective_Refresh_Ajax extends WP_UnitTestCase {
 
diff --git a/tests/customize/selective-refresh.php b/tests/customize/selective-refresh.php
index b3cf7fd84a..af2239fe60 100644
--- a/tests/customize/selective-refresh.php
+++ b/tests/customize/selective-refresh.php
@@ -1,12 +1,8 @@
 <?php
 /**
- * WP_Customize_Selective_Refresh tests.
+ * Tests for the WP_Customize_Selective_Refresh class.
  *
  * @package WordPress
- */
-
-/**
- * Tests for the WP_Customize_Selective_Refresh class.
  *
  * @group customize
  */
diff --git a/tests/date/dateI18n.php b/tests/date/dateI18n.php
index dfc98dd369..1fe6f38a95 100644
--- a/tests/date/dateI18n.php
+++ b/tests/date/dateI18n.php
@@ -203,7 +203,7 @@ class Tests_Date_DateI18n extends WP_UnitTestCase {
 	/**
 	 * @ticket 25768
 	 *
-	 * @dataProvider dst_times
+	 * @dataProvider data_should_handle_dst
 	 *
 	 * @param string $time     Time to test in Y-m-d H:i:s format.
 	 * @param string $timezone PHP timezone string to use.
@@ -219,7 +219,7 @@ class Tests_Date_DateI18n extends WP_UnitTestCase {
 		$this->assertSame( $datetime->format( $format ), date_i18n( $format, $wp_timestamp ) );
 	}
 
-	public function dst_times() {
+	public function data_should_handle_dst() {
 		return array(
 			'Before DST start' => array( '2019-03-31 02:59:00', 'Europe/Helsinki' ),
 			'After DST start'  => array( '2019-03-31 04:01:00', 'Europe/Helsinki' ),
diff --git a/tests/date/query.php b/tests/date/query.php
index 613d74957b..7fc21f3878 100644
--- a/tests/date/query.php
+++ b/tests/date/query.php
@@ -531,7 +531,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 	/**
 	 * @ticket 41782
 	 *
-	 * @dataProvider mysql_datetime_input_provider
+	 * @dataProvider data_build_mysql_datetime
 	 *
 	 * @param array|string $datetime       Array or string date input.
 	 * @param string       $expected       Expected built result.
@@ -546,7 +546,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 		$this->assertEqualsWithDelta( strtotime( $expected ), strtotime( $found ), 10, $message );
 	}
 
-	public function mysql_datetime_input_provider() {
+	public function data_build_mysql_datetime() {
 		return array(
 			array( '2019-06-04T08:18:24+03:00', '2019-06-04 05:18:24' ),
 			array( '2019-06-04T05:18:24+00:00', '2019-06-04 05:18:24' ),
@@ -564,7 +564,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 	/**
 	 * @ticket 41782
 	 *
-	 * @dataProvider mysql_datetime_input_provider_custom_timezone
+	 * @dataProvider data_build_mysql_datetime_with_custom_timezone
 	 *
 	 * @param array|string $datetime       Array or string date input.
 	 * @param string       $expected       Expected built result.
@@ -582,7 +582,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 	}
 
-	public function mysql_datetime_input_provider_custom_timezone() {
+	public function data_build_mysql_datetime_with_custom_timezone() {
 		return array(
 			array( '2019-06-04T08:18:24+03:00', '2019-06-04 08:18:24' ),
 			array( '2019-06-04T05:18:24+00:00', '2019-06-04 08:18:24' ),
@@ -1186,7 +1186,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$parts = mb_split( '\)\s+AND\s+\(', $sql );
 		$this->assertIsArray( $parts, 'SQL query cannot be split into multiple parts using operator AND.' );
-		$this->assertEquals( 2, count( $parts ), 'SQL query does not contain correct number of AND operators.' );
+		$this->assertSame( 2, count( $parts ), 'SQL query does not contain correct number of AND operators.' );
 
 		$this->assertStringNotContainsString( 'OR', $sql, 'SQL query contains conditions joined by operator OR.' );
 	}
@@ -1233,7 +1233,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$parts = mb_split( '\)\s+OR\s+\(', $sql );
 		$this->assertIsArray( $parts, 'SQL query cannot be split into multiple parts using operator OR.' );
-		$this->assertEquals( 2, count( $parts ), 'SQL query does not contain correct number of OR operators.' );
+		$this->assertSame( 2, count( $parts ), 'SQL query does not contain correct number of OR operators.' );
 
 		// Checking number of occurrences of AND while skipping the one at the beginning.
 		$this->assertSame( 2, substr_count( substr( $sql, 5 ), 'AND' ), 'SQL query does not contain expected number conditions joined by operator AND.' );
@@ -1279,7 +1279,7 @@ class Tests_Date_Query extends WP_UnitTestCase {
 
 		$parts = mb_split( '\)\s+AND\s+\(', $sql );
 		$this->assertIsArray( $parts, 'SQL query cannot be split into multiple parts using operator AND.' );
-		$this->assertEquals( 2, count( $parts ), 'SQL query does not contain correct number of AND operators.' );
+		$this->assertSame( 2, count( $parts ), 'SQL query does not contain correct number of AND operators.' );
 
 		$this->assertStringNotContainsString( 'OR', $sql, 'SQL query contains conditions joined by operator OR.' );
 	}
diff --git a/tests/date/wpTimezone.php b/tests/date/wpTimezone.php
index 3e8b6fef5f..f28ebbf658 100644
--- a/tests/date/wpTimezone.php
+++ b/tests/date/wpTimezone.php
@@ -22,7 +22,7 @@ class Tests_Date_wpTimezone extends WP_UnitTestCase {
 	/**
 	 * @ticket 24730
 	 *
-	 * @dataProvider timezone_offset_provider
+	 * @dataProvider data_should_convert_gmt_offset
 	 *
 	 * @param float  $gmt_offset Numeric offset from UTC.
 	 * @param string $tz_name    Expected timezone name.
@@ -38,41 +38,12 @@ class Tests_Date_wpTimezone extends WP_UnitTestCase {
 		$this->assertSame( $tz_name, $timezone->getName() );
 	}
 
-	/**
-	 * @ticket 24730
-	 */
-	public function test_should_return_timezone_string() {
-		update_option( 'timezone_string', 'Europe/Helsinki' );
-
-		$this->assertSame( 'Europe/Helsinki', wp_timezone_string() );
-
-		$timezone = wp_timezone();
-
-		$this->assertSame( 'Europe/Helsinki', $timezone->getName() );
-	}
-
-	/**
-	 * Ensures that deprecated timezone strings are handled correctly.
-	 *
-	 * @ticket 56468
-	 */
-	public function test_should_return_deprecated_timezone_string() {
-		$tz_string = 'America/Buenos_Aires'; // This timezone was deprecated pre-PHP 5.6.
-		update_option( 'timezone_string', $tz_string );
-
-		$this->assertSame( $tz_string, wp_timezone_string() );
-
-		$timezone = wp_timezone();
-
-		$this->assertSame( $tz_string, $timezone->getName() );
-	}
-
 	/**
 	 * Data provider to test numeric offset conversion.
 	 *
 	 * @return array
 	 */
-	public function timezone_offset_provider() {
+	public function data_should_convert_gmt_offset() {
 		return array(
 			array( -12, '-12:00' ),
 			array( -11.5, '-11:30' ),
@@ -134,4 +105,33 @@ class Tests_Date_wpTimezone extends WP_UnitTestCase {
 			array( 14, '+14:00' ),
 		);
 	}
+
+	/**
+	 * @ticket 24730
+	 */
+	public function test_should_return_timezone_string() {
+		update_option( 'timezone_string', 'Europe/Helsinki' );
+
+		$this->assertSame( 'Europe/Helsinki', wp_timezone_string() );
+
+		$timezone = wp_timezone();
+
+		$this->assertSame( 'Europe/Helsinki', $timezone->getName() );
+	}
+
+	/**
+	 * Ensures that deprecated timezone strings are handled correctly.
+	 *
+	 * @ticket 56468
+	 */
+	public function test_should_return_deprecated_timezone_string() {
+		$tz_string = 'America/Buenos_Aires'; // This timezone was deprecated pre-PHP 5.6.
+		update_option( 'timezone_string', $tz_string );
+
+		$this->assertSame( $tz_string, wp_timezone_string() );
+
+		$timezone = wp_timezone();
+
+		$this->assertSame( $tz_string, $timezone->getName() );
+	}
 }
diff --git a/tests/db.php b/tests/db.php
index 4e4b1b8c02..11e35e4554 100644
--- a/tests/db.php
+++ b/tests/db.php
@@ -494,9 +494,11 @@ class Tests_DB extends WP_UnitTestCase {
 		$this->assertTrue( $wpdb->has_cap( 'collation' ) );
 		$this->assertTrue( $wpdb->has_cap( 'group_concat' ) );
 		$this->assertTrue( $wpdb->has_cap( 'subqueries' ) );
+		$this->assertTrue( $wpdb->has_cap( 'identifier_placeholders' ) );
 		$this->assertTrue( $wpdb->has_cap( 'COLLATION' ) );
 		$this->assertTrue( $wpdb->has_cap( 'GROUP_CONCAT' ) );
 		$this->assertTrue( $wpdb->has_cap( 'SUBQUERIES' ) );
+		$this->assertTrue( $wpdb->has_cap( 'IDENTIFIER_PLACEHOLDERS' ) );
 		$this->assertSame(
 			version_compare( $wpdb->db_version(), '5.0.7', '>=' ),
 			$wpdb->has_cap( 'set_charset' )
@@ -576,7 +578,7 @@ class Tests_DB extends WP_UnitTestCase {
 	 * @param arrray|string|null $last_result The value to assign to `$wpdb->last_result`.
 	 * @param int|string         $column      The column index to retrieve.
 	 *
-	 * @dataProvider data_test_get_col
+	 * @dataProvider data_get_col
 	 *
 	 * @ticket 45299
 	 */
@@ -610,7 +612,7 @@ class Tests_DB extends WP_UnitTestCase {
 	 *     @type arrray|string|null $last_result The value to assign to `$wpdb->last_result`.
 	 *     @type int|string         $column      The column index to retrieve.
 	 */
-	public function data_test_get_col() {
+	public function data_get_col() {
 		global $wpdb;
 
 		return array(
@@ -1515,7 +1517,7 @@ class Tests_DB extends WP_UnitTestCase {
 	public function test_prepare_with_placeholders_and_individual_args( $sql, $values, $incorrect_usage, $expected ) {
 		global $wpdb;
 
-		if ( $incorrect_usage ) {
+		if ( is_string( $incorrect_usage ) || true === $incorrect_usage ) {
 			$this->setExpectedIncorrectUsage( 'wpdb::prepare' );
 		}
 
@@ -1525,7 +1527,11 @@ class Tests_DB extends WP_UnitTestCase {
 
 		// phpcs:ignore WordPress.DB.PreparedSQL
 		$sql = $wpdb->prepare( $sql, ...$values );
-		$this->assertSame( $expected, $sql );
+		$this->assertSame( $expected, $sql, 'The expected SQL does not match' );
+
+		if ( is_string( $incorrect_usage ) && array_key_exists( 'wpdb::prepare', $this->caught_doing_it_wrong ) ) {
+			$this->assertStringContainsString( $incorrect_usage, $this->caught_doing_it_wrong['wpdb::prepare'], 'The "_doing_it_wrong" message does not match' );
+		}
 	}
 
 	/**
@@ -1534,7 +1540,7 @@ class Tests_DB extends WP_UnitTestCase {
 	public function test_prepare_with_placeholders_and_array_args( $sql, $values, $incorrect_usage, $expected ) {
 		global $wpdb;
 
-		if ( $incorrect_usage ) {
+		if ( is_string( $incorrect_usage ) || true === $incorrect_usage ) {
 			$this->setExpectedIncorrectUsage( 'wpdb::prepare' );
 		}
 
@@ -1544,7 +1550,11 @@ class Tests_DB extends WP_UnitTestCase {
 
 		// phpcs:ignore WordPress.DB.PreparedSQL
 		$sql = $wpdb->prepare( $sql, $values );
-		$this->assertSame( $expected, $sql );
+		$this->assertSame( $expected, $sql, 'The expected SQL does not match' );
+
+		if ( is_string( $incorrect_usage ) && array_key_exists( 'wpdb::prepare', $this->caught_doing_it_wrong ) ) {
+			$this->assertStringContainsString( $incorrect_usage, $this->caught_doing_it_wrong['wpdb::prepare'], 'The "_doing_it_wrong" message does not match' );
+		}
 	}
 
 	public function data_prepare_with_placeholders() {
@@ -1703,35 +1713,407 @@ class Tests_DB extends WP_UnitTestCase {
 				true,
 				"'{$placeholder_escape}'{$placeholder_escape}s",
 			),
+
+			/*
+			 * @ticket 56933.
+			 * When preparing a '%%%s%%', test that the inserted value
+			 * is not wrapped in single quotes between the 2 "%".
+			 */
 			array(
-				"'%'%%s%s",
+				'%%s %d',
+				1,
+				false,
+				"{$placeholder_escape}s 1",
+			),
+			array(
+				'%%%s',
 				'hello',
 				false,
-				"'{$placeholder_escape}'{$placeholder_escape}s'hello'",
+				"{$placeholder_escape}hello",
 			),
 			array(
-				"'%'%%s %s",
+				'%%%%s',
 				'hello',
 				false,
-				"'{$placeholder_escape}'{$placeholder_escape}s 'hello'",
+				"{$placeholder_escape}{$placeholder_escape}s",
+			),
+			array(
+				'%%%%%s',
+				'hello',
+				false,
+				"{$placeholder_escape}{$placeholder_escape}hello",
 			),
-			/*
-			 * @ticket 56933.
-			 * When preparing a '%%%s%%', test that the inserted value
-			 * is not wrapped in single quotes between the 2 hex values.
-			 */
 			array(
 				'%%%s%%',
 				'hello',
 				false,
 				"{$placeholder_escape}hello{$placeholder_escape}",
 			),
+			array(
+				"'%'%%s%s",
+				'hello',
+				false,
+				"'{$placeholder_escape}'{$placeholder_escape}s'hello'",
+			),
+			array(
+				"'%'%%s %s",
+				'hello',
+				false,
+				"'{$placeholder_escape}'{$placeholder_escape}s 'hello'",
+			),
 			array(
 				"'%-'#5s' '%'#-+-5s'",
 				array( 'hello', 'foo' ),
 				false,
 				"'hello' 'foo##'",
 			),
+
+			/*
+			 * Before WP 6.2 the "force floats to be locale-unaware" RegEx didn't
+			 * convert "%%%f" to "%%%F" (note the uppercase F).
+			 * This was because it didn't check to see if the leading "%" was escaped.
+			 * And because the "Escape any unescaped percents" RegEx used "[sdF]" in its
+			 * negative lookahead assertion, when there was an odd number of "%", it added
+			 * an extra "%", to give the fully escaped "%%%%f" (not a placeholder).
+			 */
+			array(
+				'%f OR id = %d',
+				array( 3, 5 ),
+				false,
+				'3.000000 OR id = 5',
+			),
+			array(
+				'%%f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}f OR id = 5",
+			),
+			array(
+				'%%%f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}{$placeholder_escape}f OR id = 5",
+			),
+			array(
+				'%%%%f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}{$placeholder_escape}f OR id = 5",
+			),
+			array(
+				"WHERE id = %d AND content LIKE '%.4f'",
+				array( 1, 2 ),
+				false,
+				"WHERE id = 1 AND content LIKE '2.0000'",
+			),
+			array(
+				"WHERE id = %d AND content LIKE '%%.4f'",
+				array( 1 ),
+				false,
+				"WHERE id = 1 AND content LIKE '{$placeholder_escape}.4f'",
+			),
+			array(
+				"WHERE id = %d AND content LIKE '%%%.4f'",
+				array( 1 ),
+				false,
+				"WHERE id = 1 AND content LIKE '{$placeholder_escape}{$placeholder_escape}.4f'",
+			),
+			array(
+				"WHERE id = %d AND content LIKE '%%%%.4f'",
+				array( 1 ),
+				false,
+				"WHERE id = 1 AND content LIKE '{$placeholder_escape}{$placeholder_escape}.4f'",
+			),
+			array(
+				"WHERE id = %d AND content LIKE '%%%%%.4f'",
+				array( 1 ),
+				false,
+				"WHERE id = 1 AND content LIKE '{$placeholder_escape}{$placeholder_escape}{$placeholder_escape}.4f'",
+			),
+			array(
+				'%.4f',
+				array( 1 ),
+				false,
+				'1.0000',
+			),
+			array(
+				'%.4f OR id = %d',
+				array( 1, 5 ),
+				false,
+				'1.0000 OR id = 5',
+			),
+			array(
+				'%%.4f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}.4f OR id = 5",
+			),
+			array(
+				'%%%.4f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}{$placeholder_escape}.4f OR id = 5",
+			),
+			array(
+				'%%%%.4f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}{$placeholder_escape}.4f OR id = 5",
+			),
+			array(
+				'%%%%%.4f OR id = %d',
+				array( 5 ),
+				false,
+				"{$placeholder_escape}{$placeholder_escape}{$placeholder_escape}.4f OR id = 5",
+			),
+
+			/*
+			 * @ticket 52506.
+			 * Adding an escape method for Identifiers (e.g. table/field names).
+			 */
+			array(
+				'SELECT * FROM %i WHERE %i = %d;',
+				array( 'my_table', 'my_field', 321 ),
+				false,
+				'SELECT * FROM `my_table` WHERE `my_field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_`_field', 321 ),
+				false,
+				'WHERE `evil_``_field` = 321;', // To quote the identifier itself, then you need to double the character, e.g. `a``b`.
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_````````_field', 321 ),
+				false,
+				'WHERE `evil_````````````````_field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( '``evil_field``', 321 ),
+				false,
+				'WHERE `````evil_field````` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil\'field', 321 ),
+				false,
+				'WHERE `evil\'field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_\``_field', 321 ),
+				false,
+				'WHERE `evil_\````_field` = 321;',
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'evil_%s_field', 321 ),
+				false,
+				"WHERE `evil_{$placeholder_escape}s_field` = 321;",
+			),
+			array(
+				'WHERE %i = %d;',
+				array( 'value`', 321 ),
+				false,
+				'WHERE `value``` = 321;',
+			),
+			array(
+				'WHERE `%i = %d;',
+				array( ' AND evil_value', 321 ),
+				false,
+				'WHERE `` AND evil_value` = 321;', // Won't run (SQL parse error: "Unclosed quote").
+			),
+			array(
+				'WHERE %i` = %d;',
+				array( 'evil_value -- ', 321 ),
+				false,
+				'WHERE `evil_value -- `` = 321;', // Won't run (SQL parse error: "Unclosed quote").
+			),
+			array(
+				'WHERE `%i`` = %d;',
+				array( ' AND true -- ', 321 ),
+				false,
+				'WHERE `` AND true -- ``` = 321;', // Won't run (Unknown column '').
+			),
+			array(
+				'WHERE ``%i` = %d;',
+				array( ' AND true -- ', 321 ),
+				false,
+				'WHERE ``` AND true -- `` = 321;', // Won't run (SQL parse error: "Unclosed quote").
+			),
+			array(
+				'WHERE %2$i = %1$d;',
+				array( '1', 'two' ),
+				false,
+				'WHERE `two` = 1;',
+			),
+			array(
+				'WHERE \'%i\' = 1 AND "%i" = 2 AND `%i` = 3 AND ``%i`` = 4 AND %15i = 5',
+				array( 'my_field1', 'my_field2', 'my_field3', 'my_field4', 'my_field5' ),
+				false,
+				'WHERE \'`my_field1`\' = 1 AND "`my_field2`" = 2 AND ``my_field3`` = 3 AND ```my_field4``` = 4 AND `      my_field5` = 5', // Does not remove any existing quotes, always adds it's own (safer).
+			),
+			array(
+				'WHERE id = %d AND %i LIKE %2$s LIMIT 1',
+				array( 123, 'field -- ', false ),
+				'Arguments cannot be prepared as both an Identifier and Value. Found the following conflicts: %i and %2$s',
+				null, // Should be rejected, otherwise the `%1$s` could use Identifier escaping, e.g. 'WHERE `field -- ` LIKE field --  LIMIT 1' (thanks @vortfu).
+			),
+			array(
+				'WHERE %i LIKE %s LIMIT 1',
+				array( "field' -- ", "field' -- " ),
+				false,
+				"WHERE `field' -- ` LIKE 'field\' -- ' LIMIT 1", // In contrast to the above, Identifier vs String escaping is used.
+			),
+			array(
+				'WHERE %2$i IN ( %s , %s ) LIMIT 1',
+				array( 'a', 'b' ),
+				'Arguments cannot be prepared as both an Identifier and Value. Found the following conflicts: %2$i and %s',
+				null,
+			),
+			array(
+				'WHERE %1$i = %1$s',
+				array( 'a', 'b' ),
+				'Arguments cannot be prepared as both an Identifier and Value. Found the following conflicts: %1$i and %1$s',
+				null,
+			),
+			array(
+				'WHERE %1$i = %1$s OR %2$i = %2$s',
+				array( 'a', 'b' ),
+				'Arguments cannot be prepared as both an Identifier and Value. Found the following conflicts: %1$i and %1$s, %2$i and %2$s',
+				null,
+			),
+			array(
+				'WHERE %1$i = %1$s OR %2$i = %1$s',
+				array( 'a', 'b' ),
+				'Arguments cannot be prepared as both an Identifier and Value. Found the following conflicts: %1$i and %1$s and %1$s',
+				null,
+			),
+		);
+	}
+
+	/**
+	 * The wpdb->allow_unsafe_unquoted_parameters is true (for now), purely for backwards compatibility reasons.
+	 *
+	 * @ticket 52506
+	 *
+	 * @dataProvider data_prepare_should_respect_the_allow_unsafe_unquoted_parameters_property
+	 *
+	 * @covers wpdb::prepare
+	 *
+	 * @param bool   $allow    Whether to allow unsafe unquoted parameters.
+	 * @param string $sql      The SQL to prepare.
+	 * @param array  $values   The values for prepare.
+	 * @param string $expected The expected prepared parameters.
+	 */
+	public function test_prepare_should_respect_the_allow_unsafe_unquoted_parameters_property( $allow, $sql, $values, $expected ) {
+		global $wpdb;
+
+		$default = $wpdb->allow_unsafe_unquoted_parameters;
+
+		$property = new ReflectionProperty( $wpdb, 'allow_unsafe_unquoted_parameters' );
+		$property->setAccessible( true );
+		$property->setValue( $wpdb, $allow );
+
+		// phpcs:ignore WordPress.DB.PreparedSQL.NotPrepared
+		$actual = $wpdb->prepare( $sql, $values );
+
+		// Reset.
+		$property->setValue( $wpdb, $default );
+		$property->setAccessible( false );
+
+		$this->assertSame( $expected, $actual );
+	}
+
+	/**
+	 * Data provider for test_prepare_should_respect_the_allow_unsafe_unquoted_parameters_property().
+	 *
+	 * @return array[]
+	 */
+	public function data_prepare_should_respect_the_allow_unsafe_unquoted_parameters_property() {
+		global $wpdb;
+
+		$placeholder_escape = $wpdb->placeholder_escape();
+
+		return array(
+
+			'numbered-true-1'  => array(
+				'allow'    => true,
+				'sql'      => 'WHERE (%i = %s) OR (%3$i = %4$s)',
+				'values'   => array( 'field_a', 'string_a', 'field_b', 'string_b' ),
+				'expected' => 'WHERE (`field_a` = \'string_a\') OR (`field_b` = string_b)',
+			),
+			'numbered-false-1' => array(
+				'allow'    => false,
+				'sql'      => 'WHERE (%i = %s) OR (%3$i = %4$s)',
+				'values'   => array( 'field_a', 'string_a', 'field_b', 'string_b' ),
+				'expected' => 'WHERE (`field_a` = \'string_a\') OR (`field_b` = \'string_b\')',
+			),
+			'numbered-true-2'  => array(
+				'allow'    => true,
+				'sql'      => 'WHERE (%i = %s) OR (%3$i = %4$s)',
+				'values'   => array( 'field_a', 'string_a', 'field_b', '0 OR EvilSQL' ),
+				'expected' => 'WHERE (`field_a` = \'string_a\') OR (`field_b` = 0 OR EvilSQL)',
+			),
+			'numbered-false-2' => array(
+				'allow'    => false,
+				'sql'      => 'WHERE (%i = %s) OR (%3$i = %4$s)',
+				'values'   => array( 'field_a', 'string_a', 'field_b', '0 OR EvilSQL' ),
+				'expected' => 'WHERE (`field_a` = \'string_a\') OR (`field_b` = \'0 OR EvilSQL\')',
+			),
+
+			'format-true-1'    => array(
+				'allow'    => true,
+				'sql'      => 'WHERE (%10i = %10s)',
+				'values'   => array( 'field_a', 'string_a' ),
+				'expected' => 'WHERE (`   field_a` =   string_a)',
+			),
+			'format-false-1'   => array(
+				'allow'    => false,
+				'sql'      => 'WHERE (%10i = %10s)',
+				'values'   => array( 'field_a', 'string_a' ),
+				'expected' => 'WHERE (`   field_a` = \'  string_a\')',
+			),
+			'format-true-2'    => array(
+				'allow'    => true,
+				'sql'      => 'WHERE (%10i = %10s)',
+				'values'   => array( 'field_a', '0 OR EvilSQL' ),
+				'expected' => 'WHERE (`   field_a` = 0 OR EvilSQL)',
+			),
+			'format-false-2'   => array(
+				'allow'    => false,
+				'sql'      => 'WHERE (%10i = %10s)',
+				'values'   => array( 'field_a', '0 OR EvilSQL' ),
+				'expected' => 'WHERE (`   field_a` = \'0 OR EvilSQL\')',
+			),
+
+			'escaped-true-1'   => array(
+				'allow'    => true,
+				'sql'      => 'SELECT 9%%%s',
+				'values'   => array( '7' ),
+				'expected' => "SELECT 9{$placeholder_escape}7", // SELECT 9%7.
+			),
+			'escaped-false-1'  => array(
+				'allow'    => false,
+				'sql'      => 'SELECT 9%%%s',
+				'values'   => array( '7' ),
+				'expected' => "SELECT 9{$placeholder_escape}'7'", // SELECT 9%'7'.
+			),
+			'escaped-true-2'   => array(
+				'allow'    => true,
+				'sql'      => 'SELECT 9%%%s',
+				'values'   => array( '7 OR EvilSQL' ),
+				'expected' => "SELECT 9{$placeholder_escape}7 OR EvilSQL", // SELECT 9%7 OR EvilSQL.
+			),
+			'escaped-false-2'  => array(
+				'allow'    => false,
+				'sql'      => 'SELECT 9%%%s',
+				'values'   => array( '7 OR EvilSQL' ),
+				'expected' => "SELECT 9{$placeholder_escape}'7 OR EvilSQL'", // SELECT 9%'7 OR EvilSQL'.
+			),
+
 		);
 	}
 
@@ -1857,7 +2239,7 @@ class Tests_DB extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider parse_db_host_data_provider
+	 * @dataProvider data_parse_db_host
 	 * @ticket 41722
 	 * @ticket 54877
 	 */
@@ -1878,7 +2260,7 @@ class Tests_DB extends WP_UnitTestCase {
 		}
 	}
 
-	public function parse_db_host_data_provider() {
+	public function data_parse_db_host() {
 		return array(
 			array(
 				'',    // DB_HOST.
diff --git a/tests/db/charset.php b/tests/db/charset.php
index 627526bff2..1a79ab911f 100644
--- a/tests/db/charset.php
+++ b/tests/db/charset.php
@@ -773,7 +773,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	/**
 	 * @ticket 21212
 	 */
-	public function data_test_get_table_charset() {
+	public function data_get_table_charset() {
 		$table_name = 'test_get_table_charset';
 
 		$vars = array();
@@ -788,7 +788,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_test_get_table_charset
+	 * @dataProvider data_get_table_charset
 	 * @ticket 21212
 	 *
 	 * @covers wpdb::get_table_charset
@@ -814,7 +814,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	/**
 	 * @ticket 21212
 	 */
-	public function data_test_get_column_charset() {
+	public function data_get_column_charset() {
 		$table_name = 'test_get_column_charset';
 
 		$vars = array();
@@ -829,7 +829,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_test_get_column_charset
+	 * @dataProvider data_get_column_charset
 	 * @ticket 21212
 	 *
 	 * @covers wpdb::get_col_charset
@@ -856,7 +856,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_test_get_column_charset
+	 * @dataProvider data_get_column_charset
 	 * @ticket 21212
 	 *
 	 * @covers wpdb::get_col_charset
@@ -883,7 +883,7 @@ class Tests_DB_Charset extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_test_get_column_charset
+	 * @dataProvider data_get_column_charset
 	 * @ticket 33501
 	 *
 	 * @covers wpdb::get_col_charset
diff --git a/tests/dependencies/jquery.php b/tests/dependencies/jquery.php
index aa44b0047a..8e332484e0 100644
--- a/tests/dependencies/jquery.php
+++ b/tests/dependencies/jquery.php
@@ -84,20 +84,6 @@ class Tests_Dependencies_jQuery extends WP_UnitTestCase {
 		}
 	}
 
-	/**
-	 * @ticket 28404
-	 *
-	 * @covers ::wp_script_is
-	 */
-	public function test_wp_script_is_dep_enqueued() {
-		wp_enqueue_script( 'jquery-ui-accordion' );
-
-		$this->assertTrue( wp_script_is( 'jquery', 'enqueued' ) );
-		$this->assertFalse( wp_script_is( 'underscore', 'enqueued' ) );
-
-		unset( $GLOBALS['wp_scripts'] );
-	}
-
 	/**
 	 * Test placing of jQuery in footer.
 	 *
diff --git a/tests/dependencies/styles.php b/tests/dependencies/styles.php
index 34a9847f2f..0d2f8e664b 100644
--- a/tests/dependencies/styles.php
+++ b/tests/dependencies/styles.php
@@ -405,9 +405,9 @@ CSS;
 	}
 
 	/**
-	 * Tests that visual block styles are enqueued in the editor even when there is not theme support for 'wp-block-styles'.
+	 * Tests that visual block styles are not be enqueued in the editor when there is not theme support for 'wp-block-styles'.
 	 *
-	 * Visual block styles should always be enqueued when editing to avoid the appearance of a broken editor.
+	 * @ticket 57561
 	 *
 	 * @covers ::wp_enqueue_style
 	 */
@@ -419,7 +419,7 @@ CSS;
 
 		$this->assertFalse( wp_style_is( 'wp-block-library-theme' ) );
 		wp_enqueue_style( 'wp-edit-blocks' );
-		$this->assertTrue( wp_style_is( 'wp-block-library-theme' ) );
+		$this->assertFalse( wp_style_is( 'wp-block-library-theme' ), "The 'wp-block-library-theme' style should not be in the queue after enqueuing 'wp-edit-blocks'" );
 	}
 
 	/**
diff --git a/tests/dependencies/wpScriptIs.php b/tests/dependencies/wpScriptIs.php
new file mode 100644
index 0000000000..f2783e4396
--- /dev/null
+++ b/tests/dependencies/wpScriptIs.php
@@ -0,0 +1,232 @@
+<?php
+
+/**
+ * Test wp_script_is().
+ *
+ * @group dependencies
+ * @group scripts
+ *
+ * @covers ::wp_script_is
+ * @covers WP_Scripts::query
+ */
+class Tests_Dependencies_WpScriptIs extends WP_UnitTestCase {
+	private static $wp_scripts;
+	private static $wp_scripts_was_set = false;
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		// If the global is set, store it for restoring when done testing.
+		static::$wp_scripts_was_set = array_key_exists( 'wp_scripts', $GLOBALS );
+		if ( static::$wp_scripts_was_set ) {
+			static::$wp_scripts = $GLOBALS['wp_scripts'];
+			unset( $GLOBALS['wp_scripts'] );
+		}
+	}
+
+	public static function tear_down_after_class() {
+		// Restore the global if it was set before running this set of tests.
+		if ( static::$wp_scripts_was_set ) {
+			$GLOBALS['wp_scripts'] = static::$wp_scripts;
+		}
+
+		parent::tear_down_after_class();
+	}
+
+	public function clean_up_global_scope() {
+		unset( $GLOBALS['wp_scripts'] );
+		parent::clean_up_global_scope();
+	}
+
+	public function test_script_is_registered() {
+		$handle = 'test-script';
+		wp_register_script( $handle, 'https://example.org/script.js' );
+
+		$this->assertTrue( wp_script_is( $handle, 'registered' ) );
+	}
+
+	/**
+	 * @dataProvider data_script_handles
+	 *
+	 * @param string $handle Script handle to test.
+	 */
+	public function test_script_is_enqueued( $handle ) {
+		// Test set up.
+		wp_enqueue_script( $handle );
+
+		$this->assertTrue( wp_script_is( $handle ), "Script `{$handle}` should be enqueued after invoking wp_enqueue_script()" );
+	}
+
+	/**
+	 * @dataProvider data_script_handles
+	 *
+	 * @param string $handle Script handle to test.
+	 */
+	public function test_script_is_not_enqueued( $handle ) {
+		$this->assertFalse( wp_script_is( $handle ), "Script `{$handle}` should not be enqueued when test starts" );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_script_handles() {
+		return array(
+			array( 'heartbeat' ),
+			array( 'jquery' ),
+			array( 'wp-lists' ),
+			array( 'wp-pointer' ),
+			array( 'thickbox' ),
+		);
+	}
+
+	/**
+	 * @ticket 28404
+	 *
+	 * @dataProvider data_deps_are_enqueued
+	 *
+	 * @param string   $handle Script handle.
+	 * @param string[] $deps   The deps to test for the given script handle.
+	 */
+	public function test_deps_are_enqueued( $handle, $deps ) {
+		// Check the deps are not enqueued before enqueuing.
+		$this->assertFalse( wp_script_is( $handle ), 'Script `jquery-ui-accordion` should not be enqueued when test starts' );
+		foreach ( $deps as $dep_handle ) {
+			$this->assertFalse( wp_script_is( $dep_handle ), "Dependency `{$dep_handle}` should not be enqueued when test starts" );
+		}
+
+		// Test set up.
+		wp_enqueue_script( $handle );
+
+		foreach ( $deps as $dep_handle ) {
+			$this->assertTrue( wp_script_is( $dep_handle ), "Dependency `{$dep_handle}` should be enqueued" );
+		}
+
+		$this->assertFalse( wp_script_is( 'underscore' ), 'Script "underscore" is not a dependency of "jquery-ui-accordion" and should not be enqueued' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_deps_are_enqueued() {
+		return array(
+			'jquery: 1 level of deps'                 => array(
+				'handle' => 'jquery',
+				'deps'   => array(
+					'jquery-core',
+					'jquery-migrate',
+				),
+			),
+			'mediaelement: 1 level of deps'           => array(
+				'handle' => 'mediaelement',
+				'deps'   => array(
+					'mediaelement-core',
+					'mediaelement-migrate',
+				),
+			),
+			'jquery-effects-core: 2 levels of deps'   => array(
+				'handle' => 'jquery-effects-core',
+				'deps'   => array(
+					// Dep to 'jquery-effects-core'.
+					'jquery',
+					// Deps to 'jquery'.
+					'jquery-core',
+					'jquery-migrate',
+				),
+			),
+			'jquery-ui-accordion: 3 levels of deps'   => array(
+				'handle' => 'jquery-ui-accordion',
+				'deps'   => array(
+					// Dep to 'jquery-ui-accordion'.
+					'jquery-ui-core',
+					// Dep to 'jquery-ui-core'.
+					'jquery',
+					// Deps to 'jquery'.
+					'jquery-core',
+					'jquery-migrate',
+				),
+			),
+			'wp-mediaelement: 2 and 3 levels of deps' => array(
+				'handle' => 'wp-mediaelement',
+				'deps'   => array(
+					// Dep to 'wp-mediaelement'.
+					'mediaelement',
+					// Deps to 'mediaelement'.
+					'jquery',
+					'mediaelement-core',
+					'mediaelement-migrate',
+					// Deps to 'jquery'.
+					'jquery-core',
+					'jquery-migrate',
+				),
+			),
+		);
+	}
+
+	/**
+	 * @ticket 28404
+	 *
+	 * @dataProvider data_non_deps_should_not_enqueue
+	 *
+	 * @param string   $handle   Script handle.
+	 * @param string[] $not_deps The handles that are not deps of the given script handle.
+	 */
+	public function test_non_deps_are_not_enqueued( $handle, $not_deps ) {
+		// Check the deps are not enqueued before enqueuing.
+		$this->assertFalse( wp_script_is( $handle ), "Script `{$handle}` should not be enqueued when test starts" );
+		foreach ( $not_deps as $not_dep_handle ) {
+			$this->assertFalse( wp_script_is( $not_dep_handle ), "Dependency `{$not_dep_handle}` should not be enqueued when test starts" );
+		}
+
+		// Test set up.
+		wp_enqueue_script( $handle );
+
+		foreach ( $not_deps as $not_dep_handle ) {
+			$this->assertFalse( wp_script_is( $not_dep_handle ), "Script `{$not_dep_handle}` should not be enqueued as it is not a dependency of `{$handle}`" );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_non_deps_should_not_enqueue() {
+		return array(
+			'imagesloaded: no dependencies' => array(
+				'handle'   => 'imagesloaded',
+				'not_deps' => array(
+					'jquery',
+					'masonry',
+				),
+			),
+			'wp-sanitize: no dependencies'  => array(
+				'handle'   => 'wp-sanitize',
+				'not_deps' => array(
+					'jquery',
+					'jquery-core',
+					'jquery-migrate',
+				),
+			),
+			'jquery-ui-accordion'           => array(
+				'handle'   => 'jquery-ui-accordion',
+				'not_deps' => array(
+					'underscore',
+					'thickbox',
+					'jquery-effects-core',
+				),
+			),
+			'jquery-ui-datepicker'          => array(
+				'handle'   => 'jquery-ui-datepicker',
+				'not_deps' => array(
+					'backbone',
+					'jquery-effects-core',
+					'jquery-effects-highlight',
+				),
+			),
+		);
+	}
+}
diff --git a/tests/feed/rss2.php b/tests/feed/rss2.php
index 356b402def..a3f45e0896 100644
--- a/tests/feed/rss2.php
+++ b/tests/feed/rss2.php
@@ -487,7 +487,7 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 	 *
 	 * @ticket 4575
 	 *
-	 * @dataProvider data_test_get_feed_build_date
+	 * @dataProvider data_get_feed_build_date
 	 */
 	public function test_get_feed_build_date( $url, $element ) {
 		$this->go_to( $url );
@@ -501,7 +501,7 @@ class Tests_Feed_RSS2 extends WP_UnitTestCase {
 	}
 
 
-	public function data_test_get_feed_build_date() {
+	public function data_get_feed_build_date() {
 		return array(
 			array( '/?feed=rss2', 'rss' ),
 			array( '/?feed=commentsrss2', 'rss' ),
diff --git a/tests/feed/wpSimplePieFile.php b/tests/feed/wpSimplePieFile.php
index 7af366b3cc..466e0df4be 100644
--- a/tests/feed/wpSimplePieFile.php
+++ b/tests/feed/wpSimplePieFile.php
@@ -1,19 +1,13 @@
 <?php
 /**
- * Unit tests for methods in `WP_SimplePie_File`.
+ * Tests the `WP_SimplePie_File` class.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.6.1
- */
-
-/**
- * Tests the `WP_SimplePie_File` class.
  *
  * @group feed
  * @group wp-simplepie-file
- *
- * @since 5.6.1
  */
 class Tests_Feed_wpSimplePieFile extends WP_UnitTestCase {
 	public static function set_up_before_class() {
diff --git a/tests/filesystem/moveDir.php b/tests/filesystem/moveDir.php
new file mode 100644
index 0000000000..4cc013453d
--- /dev/null
+++ b/tests/filesystem/moveDir.php
@@ -0,0 +1,312 @@
+<?php
+
+/**
+ * Tests move_dir().
+ *
+ * @group file.php
+ *
+ * @covers ::move_dir
+ */
+class Tests_Filesystem_MoveDir extends WP_UnitTestCase {
+
+	/**
+	 * The test directory.
+	 *
+	 * @var string $test_dir
+	 */
+	private static $test_dir;
+
+	/**
+	 * The existing 'from' directory path.
+	 *
+	 * @var string $existing_from
+	 */
+	private static $existing_from;
+
+	/**
+	 * The existing 'from' sub-directory path.
+	 *
+	 * @var string $existing_from_subdir
+	 */
+	private static $existing_from_subdir;
+
+	/**
+	 * The existing 'from' file path.
+	 *
+	 * @var string $existing_from_file
+	 */
+	private static $existing_from_file;
+
+	/**
+	 * The existing 'from' sub-directory file path.
+	 *
+	 * @var string $existing_from_subdir_file
+	 */
+	private static $existing_from_subdir_file;
+
+	/**
+	 * The existing 'to' directory file path.
+	 *
+	 * @var string $existing_to
+	 */
+	private static $existing_to;
+
+	/**
+	 * The existing 'to' file path.
+	 *
+	 * @var string $existing_to_file
+	 */
+	private static $existing_to_file;
+
+	/**
+	 * Sets up the filesystem and directory structure properties
+	 * before any tests run.
+	 */
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		require_once ABSPATH . 'wp-admin/includes/file.php';
+		WP_Filesystem();
+
+		self::$test_dir                  = get_temp_dir() . 'move_dir/';
+		self::$existing_from             = self::$test_dir . 'existing_from/';
+		self::$existing_from_subdir      = self::$existing_from . 'existing_from_subdir/';
+		self::$existing_from_file        = self::$existing_from . 'existing_from_file.txt';
+		self::$existing_from_subdir_file = self::$existing_from_subdir . 'existing_from_subdir_file.txt';
+		self::$existing_to               = self::$test_dir . 'existing_to/';
+		self::$existing_to_file          = self::$existing_to . 'existing_to_file.txt';
+	}
+
+	/**
+	 * Sets up the directory structure before each test.
+	 */
+	public function set_up() {
+		global $wp_filesystem;
+
+		parent::set_up();
+
+		// Create the root directory.
+		$wp_filesystem->mkdir( self::$test_dir );
+
+		// Create the "from" directory structure.
+		$wp_filesystem->mkdir( self::$existing_from );
+		$wp_filesystem->touch( self::$existing_from_file );
+		$wp_filesystem->mkdir( self::$existing_from_subdir );
+		$wp_filesystem->touch( self::$existing_from_subdir_file );
+
+		// Create the "to" directory structure.
+		$wp_filesystem->mkdir( self::$existing_to );
+		$wp_filesystem->touch( self::$existing_to_file );
+	}
+
+	/**
+	 * Removes the test directory structure after each test.
+	 */
+	public function tear_down() {
+		global $wp_filesystem;
+
+		// Delete the root directory and its contents.
+		$wp_filesystem->delete( self::$test_dir, true );
+
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests that move_dir() returns a WP_Error object.
+	 *
+	 * @ticket 57375
+	 *
+	 * @dataProvider data_should_return_wp_error
+	 *
+	 * @param string $from      The source directory path.
+	 * @param string $to        The destination directory path.
+	 * @param bool   $overwrite Whether to overwrite the destination directory.
+	 * @param string $expected  The expected WP_Error code.
+	 */
+	public function test_should_return_wp_error( $from, $to, $overwrite, $expected ) {
+		global $wp_filesystem;
+
+		$from   = self::$test_dir . $from;
+		$to     = self::$test_dir . $to;
+		$result = move_dir( $from, $to, $overwrite );
+
+		$this->assertWPError(
+			$result,
+			'move_dir() did not return a WP_Error object.'
+		);
+
+		$this->assertSame(
+			$expected,
+			$result->get_error_code(),
+			'The expected error code was not returned.'
+		);
+
+		if ( 'source_destination_same_move_dir' !== $expected ) {
+			$this->assertTrue(
+				$wp_filesystem->exists( $from ),
+				'The $from directory does not exist anymore.'
+			);
+
+			if ( false === $overwrite && 'existing_to' === untrailingslashit( $to ) ) {
+				$this->assertTrue(
+					$wp_filesystem->exists( $to ),
+					'The $to directory does not exist anymore.'
+				);
+			}
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_return_wp_error() {
+		return array(
+			'$overwrite is false and $to exists' => array(
+				'from'      => 'existing_from',
+				'to'        => 'existing_to',
+				'overwrite' => false,
+				'expected'  => 'destination_already_exists_move_dir',
+			),
+			'same source and destination, source has trailing slash' => array(
+				'from'      => 'existing_from/',
+				'to'        => 'existing_from',
+				'overwrite' => false,
+				'expected'  => 'source_destination_same_move_dir',
+			),
+			'same source and destination, destination has trailing slash' => array(
+				'from'      => 'existing_from',
+				'to'        => 'existing_from/',
+				'overwrite' => false,
+				'expected'  => 'source_destination_same_move_dir',
+			),
+			'same source and destination, source lowercase, destination uppercase' => array(
+				'from'      => 'existing_from',
+				'to'        => 'EXISTING_FROM',
+				'overwrite' => false,
+				'expected'  => 'source_destination_same_move_dir',
+			),
+			'same source and destination, source uppercase, destination lowercase' => array(
+				'from'      => 'EXISTING_FROM',
+				'to'        => 'existing_from',
+				'overwrite' => false,
+				'expected'  => 'source_destination_same_move_dir',
+			),
+			'same source and destination, source and destination in inverted case' => array(
+				'from'      => 'ExIsTiNg_FrOm',
+				'to'        => 'eXiStInG_fRoM',
+				'overwrite' => false,
+				'expected'  => 'source_destination_same_move_dir',
+			),
+		);
+	}
+
+	/**
+	 * Tests that move_dir() successfully moves a directory.
+	 *
+	 * @ticket 57375
+	 *
+	 * @dataProvider data_should_move_directory
+	 *
+	 * @param string $from      The source directory path.
+	 * @param string $to        The destination directory path.
+	 * @param bool   $overwrite Whether to overwrite the destination directory.
+	 */
+	public function test_should_move_directory( $from, $to, $overwrite ) {
+		global $wp_filesystem;
+
+		$from   = self::$test_dir . $from;
+		$to     = self::$test_dir . $to;
+		$result = move_dir( $from, $to, $overwrite );
+
+		$this->assertTrue(
+			$result,
+			'The directory was not moved.'
+		);
+
+		$this->assertFalse(
+			$wp_filesystem->exists( $from ),
+			'The source directory still exists.'
+		);
+
+		$this->assertTrue(
+			$wp_filesystem->exists( $to ),
+			'The destination directory does not exist.'
+		);
+
+		$dirlist = $wp_filesystem->dirlist( $to, true, true );
+
+		// Prevent PHP array sorting bugs from breaking tests.
+		$to_contents = array_keys( $dirlist );
+
+		$this->assertSameSets(
+			array(
+				'existing_from_file.txt',
+				'existing_from_subdir',
+			),
+			$to_contents,
+			'The expected files were not moved.'
+		);
+
+		$this->assertSame(
+			array( 'existing_from_subdir_file.txt' ),
+			array_keys( $dirlist['existing_from_subdir']['files'] ),
+			'Sub-directory files failed to move.'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_move_directory() {
+		return array(
+			'$overwrite is false and $to does not exist' => array(
+				'from'      => 'existing_from',
+				'to'        => 'non_existing_to',
+				'overwrite' => false,
+			),
+			'$overwrite is true and $to exists'          => array(
+				'from'      => 'existing_from',
+				'to'        => 'existing_to',
+				'overwrite' => true,
+			),
+		);
+	}
+
+	/**
+	 * Tests that `move_dir()` returns a WP_Error object when overwriting
+	 * is enabled, the destination exists, but cannot be deleted.
+	 *
+	 * @ticket 57375
+	 */
+	public function test_should_return_wp_error_when_overwriting_is_enabled_the_destination_exists_but_cannot_be_deleted() {
+		global $wp_filesystem;
+		$wpfilesystem_backup = $wp_filesystem;
+
+		// Force failure conditions.
+		$filesystem_mock = $this->getMockBuilder( 'WP_Filesystem_Direct' )->setConstructorArgs( array( null ) )->getMock();
+		$filesystem_mock->expects( $this->once() )->method( 'exists' )->willReturn( true );
+		$filesystem_mock->expects( $this->once() )->method( 'delete' )->willReturn( false );
+		$wp_filesystem = $filesystem_mock;
+
+		$actual = move_dir( self::$existing_from, self::$existing_from_subdir, true );
+
+		// Restore the filesystem.
+		$wp_filesystem = $wpfilesystem_backup;
+
+		$this->assertWPError(
+			$actual,
+			'A WP_Error object was not returned.'
+		);
+
+		$this->assertSame(
+			'destination_not_deleted_move_dir',
+			$actual->get_error_code(),
+			'An unexpected error code was returned.'
+		);
+	}
+
+}
diff --git a/tests/filesystem/wpOpcacheInvalidateDirectory.php b/tests/filesystem/wpOpcacheInvalidateDirectory.php
new file mode 100644
index 0000000000..54c71c7ab0
--- /dev/null
+++ b/tests/filesystem/wpOpcacheInvalidateDirectory.php
@@ -0,0 +1,101 @@
+<?php
+
+/**
+ * Tests wp_opcache_invalidate_directory().
+ *
+ * @group file.php
+ *
+ * @covers ::wp_opcache_invalidate_directory
+ */
+class Tests_Filesystem_WpOpcacheInvalidateDirectory extends WP_UnitTestCase {
+
+	/**
+	 * Sets up the filesystem before any tests run.
+	 */
+	public static function set_up_before_class() {
+		global $wp_filesystem;
+
+		parent::set_up_before_class();
+
+		if ( ! $wp_filesystem ) {
+			require_once ABSPATH . 'wp-admin/includes/file.php';
+			WP_Filesystem();
+		}
+	}
+
+	/**
+	 * Tests that wp_opcache_invalidate_directory() returns a WP_Error object
+	 * when the $dir argument invalid.
+	 *
+	 * @ticket 57375
+	 *
+	 * @dataProvider data_should_trigger_error_with_invalid_dir
+	 *
+	 * @param mixed $dir An invalid directory path.
+	 */
+	public function test_should_trigger_error_with_invalid_dir( $dir ) {
+		$this->expectError();
+		$this->expectErrorMessage(
+			'<code>wp_opcache_invalidate_directory()</code>',
+			'The expected error was not triggered.'
+		);
+
+		wp_opcache_invalidate_directory( $dir );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_trigger_error_with_invalid_dir() {
+		return array(
+			'an empty string'                => array( '' ),
+			'a string with spaces'           => array( '   ' ),
+			'a string with tabs'             => array( "\t" ),
+			'a string with new lines'        => array( "\n" ),
+			'a string with carriage returns' => array( "\r" ),
+			'int -1'                         => array( -1 ),
+			'int 0'                          => array( 0 ),
+			'int 1'                          => array( 1 ),
+			'float -1.0'                     => array( -1.0 ),
+			'float 0.0'                      => array( 0.0 ),
+			'float 1.0'                      => array( 1.0 ),
+			'false'                          => array( false ),
+			'true'                           => array( true ),
+			'null'                           => array( null ),
+			'an empty array'                 => array( array() ),
+			'a non-empty array'              => array( array( 'directory_path' ) ),
+			'an empty object'                => array( new stdClass() ),
+			'a non-empty object'             => array( (object) array( 'directory_path' ) ),
+			'INF'                            => array( INF ),
+			'NAN'                            => array( NAN ),
+		);
+	}
+
+	/**
+	 * Tests that wp_opcache_invalidate_directory() does not trigger an error
+	 * with a valid directory.
+	 *
+	 * @ticket 57375
+	 *
+	 * @dataProvider data_should_not_trigger_error_wp_opcache_valid_directory
+	 *
+	 * @param string $dir A directory path.
+	 */
+	public function test_should_not_trigger_error_wp_opcache_valid_directory( $dir ) {
+		$this->assertNull( wp_opcache_invalidate_directory( $dir ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_not_trigger_error_wp_opcache_valid_directory() {
+		return array(
+			'an existing directory'    => array( DIR_TESTDATA ),
+			'a non-existent directory' => array( 'non_existent_directory' ),
+		);
+	}
+}
diff --git a/tests/formatting/balanceTags.php b/tests/formatting/balanceTags.php
index e035275741..2631343ec6 100644
--- a/tests/formatting/balanceTags.php
+++ b/tests/formatting/balanceTags.php
@@ -7,46 +7,17 @@
  */
 class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 
-	public function nestable_tags() {
-		return array(
-			array( 'article' ),
-			array( 'aside' ),
-			array( 'blockquote' ),
-			array( 'details' ),
-			array( 'div' ),
-			array( 'figure' ),
-			array( 'object' ),
-			array( 'q' ),
-			array( 'section' ),
-			array( 'span' ),
-		);
-	}
+	/**
+	 * @ticket 47014
+	 * @dataProvider data_supported_traditional_tag_names
+	 */
+	public function test_detects_traditional_tag_names( $tag ) {
+		$normalized = strtolower( $tag );
 
-	// This is a complete(?) listing of valid single/self-closing tags.
-	public function single_tags() {
-		return array(
-			array( 'area' ),
-			array( 'base' ),
-			array( 'basefont' ),
-			array( 'br' ),
-			array( 'col' ),
-			array( 'command' ),
-			array( 'embed' ),
-			array( 'frame' ),
-			array( 'hr' ),
-			array( 'img' ),
-			array( 'input' ),
-			array( 'isindex' ),
-			array( 'link' ),
-			array( 'meta' ),
-			array( 'param' ),
-			array( 'source' ),
-			array( 'track' ),
-			array( 'wbr' ),
-		);
+		$this->assertSame( "<$normalized>inside</$normalized>", balanceTags( "<$tag>inside", true ) );
 	}
 
-	public function supported_traditional_tag_names() {
+	public function data_supported_traditional_tag_names() {
 		return array(
 			array( 'a' ),
 			array( 'div' ),
@@ -58,7 +29,15 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		);
 	}
 
-	public function supported_custom_element_tag_names() {
+	/**
+	 * @ticket 47014
+	 * @dataProvider data_supported_custom_element_tag_names
+	 */
+	public function test_detects_supported_custom_element_tag_names( $tag ) {
+		$this->assertSame( "<$tag>inside</$tag>", balanceTags( "<$tag>inside", true ) );
+	}
+
+	public function data_supported_custom_element_tag_names() {
 		return array(
 			array( 'custom-element' ),
 			array( 'my-custom-element' ),
@@ -70,19 +49,35 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		);
 	}
 
-	public function invalid_tag_names() {
+	/**
+	 * @ticket 47014
+	 * @dataProvider data_invalid_tag_names
+	 */
+	public function test_ignores_invalid_tag_names( $input, $output ) {
+		$this->assertSame( $output, balanceTags( $input, true ) );
+	}
+
+	public function data_invalid_tag_names() {
 		return array(
 			array( '<0-day>inside', '&lt;0-day>inside' ), // Can't start with a number - handled by the "<3" fix.
 			array( '<UPPERCASE-TAG>inside', '<UPPERCASE-TAG>inside' ), // Custom elements cannot be uppercase.
 		);
 	}
 
+	/**
+	 * @ticket 47014
+	 * @dataProvider data_unsupported_valid_tag_names
+	 */
+	public function test_ignores_unsupported_custom_tag_names( $tag ) {
+		$this->assertSame( "<$tag>inside", balanceTags( "<$tag>inside", true ) );
+	}
+
 	/**
 	 * These are valid custom elements but we don't support them yet.
 	 *
 	 * @see https://html.spec.whatwg.org/multipage/custom-elements.html#valid-custom-element-name
 	 */
-	public function unsupported_valid_tag_names() {
+	public function data_unsupported_valid_tag_names() {
 		return array(
 			// We don't allow ending in a dash.
 			array( '<what->inside' ),
@@ -137,12 +132,20 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * @ticket 47014
+	 * @dataProvider data_supported_invalid_tag_names
+	 */
+	public function test_detects_supported_invalid_tag_names( $tag ) {
+		$this->assertSame( "<$tag>inside</$tag>", balanceTags( "<$tag>inside", true ) );
+	}
+
 	/**
 	 * These are invalid custom elements but we support them right now in order to keep the parser simpler.
 	 *
 	 * @see https://w3c.github.io/webcomponents/spec/custom/#valid-custom-element-name
 	 */
-	public function supported_invalid_tag_names() {
+	public function data_supported_invalid_tag_names() {
 		return array(
 			// Reserved names for custom elements.
 			array( 'annotation-xml' ),
@@ -156,53 +159,11 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		);
 	}
 
-	/**
-	 * @ticket 47014
-	 * @dataProvider supported_traditional_tag_names
-	 */
-	public function test_detects_traditional_tag_names( $tag ) {
-		$normalized = strtolower( $tag );
-
-		$this->assertSame( "<$normalized>inside</$normalized>", balanceTags( "<$tag>inside", true ) );
-	}
-
-	/**
-	 * @ticket 47014
-	 * @dataProvider supported_custom_element_tag_names
-	 */
-	public function test_detects_supported_custom_element_tag_names( $tag ) {
-		$this->assertSame( "<$tag>inside</$tag>", balanceTags( "<$tag>inside", true ) );
-	}
-
-	/**
-	 * @ticket 47014
-	 * @dataProvider invalid_tag_names
-	 */
-	public function test_ignores_invalid_tag_names( $input, $output ) {
-		$this->assertSame( $output, balanceTags( $input, true ) );
-	}
-
-	/**
-	 * @ticket 47014
-	 * @dataProvider unsupported_valid_tag_names
-	 */
-	public function test_ignores_unsupported_custom_tag_names( $tag ) {
-		$this->assertSame( "<$tag>inside", balanceTags( "<$tag>inside", true ) );
-	}
-
-	/**
-	 * @ticket 47014
-	 * @dataProvider supported_invalid_tag_names
-	 */
-	public function test_detects_supported_invalid_tag_names( $tag ) {
-		$this->assertSame( "<$tag>inside</$tag>", balanceTags( "<$tag>inside", true ) );
-	}
-
 	/**
 	 * If a recognized valid single tag appears unclosed, it should get self-closed
 	 *
 	 * @ticket 1597
-	 * @dataProvider single_tags
+	 * @dataProvider data_single_tags
 	 */
 	public function test_selfcloses_unclosed_known_single_tags( $tag ) {
 		$this->assertSame( "<$tag />", balanceTags( "<$tag>", true ) );
@@ -213,12 +174,36 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 	 *   should get removed and tag should be self-closed.
 	 *
 	 * @ticket 1597
-	 * @dataProvider single_tags
+	 * @dataProvider data_single_tags
 	 */
 	public function test_selfcloses_known_single_tags_having_closing_tag( $tag ) {
 		$this->assertSame( "<$tag />", balanceTags( "<$tag></$tag>", true ) );
 	}
 
+	// This is a complete(?) listing of valid single/self-closing tags.
+	public function data_single_tags() {
+		return array(
+			array( 'area' ),
+			array( 'base' ),
+			array( 'basefont' ),
+			array( 'br' ),
+			array( 'col' ),
+			array( 'command' ),
+			array( 'embed' ),
+			array( 'frame' ),
+			array( 'hr' ),
+			array( 'img' ),
+			array( 'input' ),
+			array( 'isindex' ),
+			array( 'link' ),
+			array( 'meta' ),
+			array( 'param' ),
+			array( 'source' ),
+			array( 'track' ),
+			array( 'wbr' ),
+		);
+	}
+
 	/**
 	 * @ticket 1597
 	 */
@@ -274,7 +259,7 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider nestable_tags
+	 * @dataProvider data_nestable_tags
 	 */
 	public function test_balances_nestable_tags( $tag ) {
 		$inputs   = array(
@@ -293,6 +278,21 @@ class Tests_Formatting_BalanceTags extends WP_UnitTestCase {
 		}
 	}
 
+	public function data_nestable_tags() {
+		return array(
+			array( 'article' ),
+			array( 'aside' ),
+			array( 'blockquote' ),
+			array( 'details' ),
+			array( 'div' ),
+			array( 'figure' ),
+			array( 'object' ),
+			array( 'q' ),
+			array( 'section' ),
+			array( 'span' ),
+		);
+	}
+
 	public function test_allows_adjacent_nestable_tags() {
 		$inputs = array(
 			'<blockquote><blockquote>Example quote</blockquote></blockquote>',
diff --git a/tests/formatting/convertSmilies.php b/tests/formatting/convertSmilies.php
index 5031b4b51c..c7f0803804 100644
--- a/tests/formatting/convertSmilies.php
+++ b/tests/formatting/convertSmilies.php
@@ -9,11 +9,36 @@
 class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 
 	/**
-	 * Basic Test Content DataProvider
+	 * Basic validation test to confirm that smilies are converted to image
+	 * when use_smilies = 1 and not when use_smilies = 0.
 	 *
-	 * array ( input_txt, converted_output_txt)
+	 * @dataProvider data_convert_standard_smilies
 	 */
-	public function get_smilies_input_output() {
+	public function test_convert_standard_smilies( $input, $converted ) {
+		// Standard smilies, use_smilies: ON.
+		update_option( 'use_smilies', 1 );
+
+		smilies_init();
+
+		$this->assertSame( $converted, convert_smilies( $input ) );
+
+		// Standard smilies, use_smilies: OFF.
+		update_option( 'use_smilies', 0 );
+
+		$this->assertSame( $input, convert_smilies( $input ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input     Input content.
+	 *         @type string $converted Converted output.
+	 *     }
+	 * }
+	 */
+	public function data_convert_standard_smilies() {
 		$includes_path = includes_url( 'images/smilies/' );
 
 		return array(
@@ -45,31 +70,52 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider get_smilies_input_output
+	 * Tests that custom smilies are converted to images when use_smilies = 1.
 	 *
-	 * Basic Validation Test to confirm that smilies are converted to image
-	 * when use_smilies = 1 and not when use_smilies = 0
+	 * @dataProvider data_convert_custom_smilies
 	 */
-	public function test_convert_standard_smilies( $in_txt, $converted_txt ) {
-		// Standard smilies, use_smilies: ON.
+	public function test_convert_custom_smilies( $input, $converted ) {
+		global $wpsmiliestrans;
+
+		// Custom smilies, use_smilies: ON.
 		update_option( 'use_smilies', 1 );
 
+		if ( ! isset( $wpsmiliestrans ) ) {
+			smilies_init();
+		}
+
+		$trans_orig = $wpsmiliestrans; // Save original translations array.
+
+		$wpsmiliestrans = array(
+			':PP'      => 'icon_tongue.gif',
+			':arrow:'  => 'icon_arrow.gif',
+			':monkey:' => 'icon_shock_the_monkey.gif',
+			':nervou:' => 'icon_nervou.gif',
+		);
+
 		smilies_init();
 
-		$this->assertSame( $converted_txt, convert_smilies( $in_txt ) );
+		$this->assertSame( $converted, convert_smilies( $input ) );
 
 		// Standard smilies, use_smilies: OFF.
 		update_option( 'use_smilies', 0 );
 
-		$this->assertSame( $in_txt, convert_smilies( $in_txt ) );
+		$this->assertSame( $input, convert_smilies( $input ) );
+
+		$wpsmiliestrans = $trans_orig; // Reset original translations array.
 	}
 
 	/**
-	 * Custom Smilies Test Content DataProvider
+	 * Data provider.
 	 *
-	 * array ( input_txt, converted_output_txt)
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input     Input content.
+	 *         @type string $converted Converted output.
+	 *     }
+	 * }
 	 */
-	public function get_custom_smilies_input_output() {
+	public function data_convert_custom_smilies() {
 		$includes_path = includes_url( 'images/smilies/' );
 
 		return array(
@@ -89,46 +135,38 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider get_custom_smilies_input_output
+	 * Tests that conversion of smilies is ignored in pre-determined tags:
+	 * pre, code, script, style.
 	 *
-	 * Validate Custom Smilies are converted to images when use_smilies = 1
+	 * @ticket 16448
+	 * @dataProvider data_ignore_smilies_in_tags
 	 */
-	public function test_convert_custom_smilies( $in_txt, $converted_txt ) {
-		global $wpsmiliestrans;
-
-		// Custom smilies, use_smilies: ON.
-		update_option( 'use_smilies', 1 );
-
-		if ( ! isset( $wpsmiliestrans ) ) {
-			smilies_init();
-		}
+	public function test_ignore_smilies_in_tags( $element ) {
+		$includes_path = includes_url( 'images/smilies/' );
 
-		$trans_orig = $wpsmiliestrans; // Save original translations array.
-
-		$wpsmiliestrans = array(
-			':PP'      => 'icon_tongue.gif',
-			':arrow:'  => 'icon_arrow.gif',
-			':monkey:' => 'icon_shock_the_monkey.gif',
-			':nervou:' => 'icon_nervou.gif',
-		);
+		$input    = 'Do we ignore smilies ;-) in ' . $element . ' tags <' . $element . ' class="foo">My Content Here :?: </' . $element . '>';
+		$expected = "Do we ignore smilies \xf0\x9f\x98\x89 in $element tags <$element class=\"foo\">My Content Here :?: </$element>";
 
+		// Standard smilies, use_smilies: ON.
+		update_option( 'use_smilies', 1 );
 		smilies_init();
 
-		$this->assertSame( $converted_txt, convert_smilies( $in_txt ) );
+		$this->assertSame( $expected, convert_smilies( $input ) );
 
 		// Standard smilies, use_smilies: OFF.
 		update_option( 'use_smilies', 0 );
-
-		$this->assertSame( $in_txt, convert_smilies( $in_txt ) );
-
-		$wpsmiliestrans = $trans_orig; // Reset original translations array.
 	}
 
-
 	/**
-	 * DataProvider of HTML elements/tags that smilie matches should be ignored in
+	 * Data provider.
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $element HTML tag name.
+	 *     }
+	 * }
 	 */
-	public function get_smilies_ignore_tags() {
+	public function data_ignore_smilies_in_tags() {
 		return array(
 			array( 'pre' ),
 			array( 'code' ),
@@ -139,32 +177,36 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Validate Conversion of Smilies is ignored in pre-determined tags
-	 * pre, code, script, style
+	 * Tests that combinations of smilies separated by a single space
+	 * are converted correctly.
 	 *
-	 * @ticket 16448
-	 * @dataProvider get_smilies_ignore_tags
+	 * @ticket 20124
+	 * @dataProvider data_smilies_combinations
 	 */
-	public function test_ignore_smilies_in_tags( $element ) {
-		$includes_path = includes_url( 'images/smilies/' );
-
-		$in_str  = 'Do we ingore smilies ;-) in ' . $element . ' tags <' . $element . ' class="foo">My Content Here :?: </' . $element . '>';
-		$exp_str = "Do we ingore smilies \xf0\x9f\x98\x89 in $element tags <$element class=\"foo\">My Content Here :?: </$element>";
-
-		// Standard smilies, use_smilies: ON.
+	public function test_smilies_combinations( $input, $converted ) {
+		// Custom smilies, use_smilies: ON.
 		update_option( 'use_smilies', 1 );
 		smilies_init();
 
-		$this->assertSame( $exp_str, convert_smilies( $in_str ) );
+		$this->assertSame( $converted, convert_smilies( $input ) );
 
-		// Standard smilies, use_smilies: OFF.
+		// Custom smilies, use_smilies: OFF.
 		update_option( 'use_smilies', 0 );
+
+		$this->assertSame( $input, convert_smilies( $input ) );
 	}
 
 	/**
-	 * DataProvider of Smilie Combinations
+	 * Data provider.
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input     Input content.
+	 *         @type string $converted Converted output.
+	 *     }
+	 * }
 	 */
-	public function get_smilies_combinations() {
+	public function data_smilies_combinations() {
 		$includes_path = includes_url( 'images/smilies/' );
 
 		return array(
@@ -196,29 +238,51 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Validate Combinations of Smilies separated by single space
-	 * are converted correctly
+	 * Tests that smilies are converted for single smilie in
+	 * the $wpsmiliestrans global array.
 	 *
-	 * @ticket 20124
-	 * @dataProvider get_smilies_combinations
+	 * @ticket 25303
+	 * @dataProvider data_single_smilies_in_wpsmiliestrans
 	 */
-	public function test_smilies_combinations( $in_txt, $converted_txt ) {
-		// Custom smilies, use_smilies: ON.
+	public function test_single_smilies_in_wpsmiliestrans( $input, $converted ) {
+		global $wpsmiliestrans;
+
+		// Standard smilies, use_smilies: ON.
 		update_option( 'use_smilies', 1 );
+
+		if ( ! isset( $wpsmiliestrans ) ) {
+			smilies_init();
+		}
+
+		$orig_trans = $wpsmiliestrans; // Save original tranlations array.
+
+		$wpsmiliestrans = array(
+			':)' => 'simple-smile.png',
+		);
+
 		smilies_init();
 
-		$this->assertSame( $converted_txt, convert_smilies( $in_txt ) );
+		$this->assertSame( $converted, convert_smilies( $input ) );
 
-		// Custom smilies, use_smilies: OFF.
+		// Standard smilies, use_smilies: OFF.
 		update_option( 'use_smilies', 0 );
 
-		$this->assertSame( $in_txt, convert_smilies( $in_txt ) );
+		$this->assertSame( $input, convert_smilies( $input ) );
+
+		$wpsmiliestrans = $orig_trans; // Reset original translations array.
 	}
 
 	/**
-	 * DataProvider of Single Smilies input and converted output
+	 * Data provider.
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input     Input content.
+	 *         @type string $converted Converted output.
+	 *     }
+	 * }
 	 */
-	public function get_single_smilies_input_output() {
+	public function data_single_smilies_in_wpsmiliestrans() {
 		$includes_path = includes_url( 'images/smilies/' );
 
 		return array(
@@ -238,41 +302,38 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Validate Smilies are converted for single smilie in
-	 * the $wpsmiliestrans global array
+	 * Tests that $wp_smiliessearch pattern will match smilies
+	 * between spaces, but never capture those spaces.
 	 *
-	 * @ticket 25303
-	 * @dataProvider get_single_smilies_input_output
+	 * Further tests that spaces aren't randomly deleted
+	 * or added when replacing the text with an image.
+	 *
+	 * @ticket 22692
+	 * @dataProvider data_spaces_around_smilies
 	 */
-	public function test_single_smilies_in_wpsmiliestrans( $in_txt, $converted_txt ) {
-		global $wpsmiliestrans;
-
+	public function test_spaces_around_smilies( $input, $converted ) {
 		// Standard smilies, use_smilies: ON.
 		update_option( 'use_smilies', 1 );
 
-		if ( ! isset( $wpsmiliestrans ) ) {
-			smilies_init();
-		}
-
-		$orig_trans = $wpsmiliestrans; // Save original tranlations array.
-
-		$wpsmiliestrans = array(
-			':)' => 'simple-smile.png',
-		);
-
 		smilies_init();
 
-		$this->assertSame( $converted_txt, convert_smilies( $in_txt ) );
+		$this->assertSame( $converted, convert_smilies( $input ) );
 
 		// Standard smilies, use_smilies: OFF.
 		update_option( 'use_smilies', 0 );
-
-		$this->assertSame( $in_txt, convert_smilies( $in_txt ) );
-
-		$wpsmiliestrans = $orig_trans; // Reset original translations array.
 	}
 
-	public function get_spaces_around_smilies() {
+	/**
+	 * Data provider.
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input     Input content.
+	 *         @type string $converted Converted output.
+	 *     }
+	 * }
+	 */
+	public function data_spaces_around_smilies() {
 		$nbsp = "\xC2\xA0";
 
 		return array(
@@ -291,28 +352,6 @@ class Tests_Formatting_ConvertSmilies extends WP_UnitTestCase {
 		);
 	}
 
-	/**
-	 * Check that $wp_smiliessearch pattern will match smilies
-	 * between spaces, but never capture those spaces.
-	 *
-	 * Further check that spaces aren't randomly deleted
-	 * or added when replacing the text with an image.
-	 *
-	 * @ticket 22692
-	 * @dataProvider get_spaces_around_smilies
-	 */
-	public function test_spaces_around_smilies( $in_txt, $converted_txt ) {
-		// Standard smilies, use_smilies: ON.
-		update_option( 'use_smilies', 1 );
-
-		smilies_init();
-
-		$this->assertSame( $converted_txt, convert_smilies( $in_txt ) );
-
-		// Standard smilies, use_smilies: OFF.
-		update_option( 'use_smilies', 0 );
-	}
-
 	/**
 	 * Test to ensure smilies can be removed with a filter
 	 *
diff --git a/tests/formatting/date.php b/tests/formatting/date.php
index 684cf86d97..8e090dd9c1 100644
--- a/tests/formatting/date.php
+++ b/tests/formatting/date.php
@@ -130,11 +130,11 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	/**
 	 * @ticket 31809
 	 *
-	 * @dataProvider timezone_provider
+	 * @dataProvider data_timezone_provider
 	 *
 	 * @covers ::get_gmt_from_date
 	 */
-	public function test_gmt_from_date_correct_time( $timezone_string, $gmt_offset ) {
+	public function test_get_gmt_from_date_correct_time( $timezone_string, $gmt_offset ) {
 		update_option( 'timezone_string', $timezone_string );
 		update_option( 'gmt_offset', $gmt_offset );
 
@@ -148,11 +148,11 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	/**
 	 * @ticket 31809
 	 *
-	 * @dataProvider timezone_provider
+	 * @dataProvider data_timezone_provider
 	 *
 	 * @covers ::get_date_from_gmt
 	 */
-	public function test_date_from_gmt_correct_time( $timezone_string, $gmt_offset ) {
+	public function test_get_date_from_gmt_correct_time( $timezone_string, $gmt_offset ) {
 		update_option( 'timezone_string', $timezone_string );
 		update_option( 'gmt_offset', $gmt_offset );
 
@@ -166,7 +166,7 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	/**
 	 * @ticket 31809
 	 *
-	 * @dataProvider timezone_provider
+	 * @dataProvider data_timezone_provider
 	 *
 	 * @covers ::iso8601_to_datetime
 	 */
@@ -230,7 +230,7 @@ class Tests_Formatting_Date extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function timezone_provider() {
+	public function data_timezone_provider() {
 		return array(
 			array(
 				'timezone_string' => 'Europe/Helsinki',
diff --git a/tests/formatting/ent2ncr.php b/tests/formatting/ent2ncr.php
index daf7f44b4d..ea5e2885bf 100644
--- a/tests/formatting/ent2ncr.php
+++ b/tests/formatting/ent2ncr.php
@@ -7,7 +7,7 @@
  */
 class Tests_Formatting_Ent2ncr extends WP_UnitTestCase {
 	/**
-	 * @dataProvider entities
+	 * @dataProvider data_entities
 	 */
 	public function test_converts_named_entities_to_numeric_character_references( $entity, $ncr ) {
 		$entity = '&' . $entity . ';';
@@ -19,7 +19,7 @@ class Tests_Formatting_Ent2ncr extends WP_UnitTestCase {
 	 * Get test data from files, one test per line.
 	 * Comments start with "###".
 	 */
-	public function entities() {
+	public function data_entities() {
 		$entities      = file( DIR_TESTDATA . '/formatting/entities.txt' );
 		$data_provided = array();
 		foreach ( $entities as $line ) {
diff --git a/tests/formatting/escXml.php b/tests/formatting/escXml.php
index bce29da9df..6fdbd136a7 100644
--- a/tests/formatting/escXml.php
+++ b/tests/formatting/escXml.php
@@ -9,7 +9,7 @@ class Tests_Formatting_EscXml extends WP_UnitTestCase {
 	/**
 	 * Test basic escaping
 	 *
-	 * @dataProvider _test_esc_xml_basics_dataprovider
+	 * @dataProvider data_esc_xml_basics
 	 *
 	 * @param string $source   The source string to be escaped.
 	 * @param string $expected The expected escaped value of `$source`.
@@ -27,7 +27,7 @@ class Tests_Formatting_EscXml extends WP_UnitTestCase {
 	 *     @type string $expected The expected escaped value of `$source`.
 	 * }
 	 */
-	public function _test_esc_xml_basics_dataprovider() {
+	public function data_esc_xml_basics() {
 		return array(
 			// Simple string.
 			array(
@@ -84,7 +84,7 @@ class Tests_Formatting_EscXml extends WP_UnitTestCase {
 	/**
 	 * Test that CDATA Sections are not escaped.
 	 *
-	 * @dataProvider _test_ignores_cdata_sections_dataprovider
+	 * @dataProvider data_ignores_cdata_sections
 	 *
 	 * @param string $source   The source string to be escaped.
 	 * @param string $expected The expected escaped value of `$source`.
@@ -102,7 +102,7 @@ class Tests_Formatting_EscXml extends WP_UnitTestCase {
 	 *     @type string $expected The expected escaped value of `$source`.
 	 * }
 	 */
-	public function _test_ignores_cdata_sections_dataprovider() {
+	public function data_ignores_cdata_sections() {
 		return array(
 			// basic CDATA Section containing chars that would otherwise be escaped if not in a CDATA Section
 			// not to mention the CDATA Section markup itself :-)
diff --git a/tests/formatting/getBloginfo.php b/tests/formatting/getBloginfo.php
index 0b6ab77358..37f449bac6 100644
--- a/tests/formatting/getBloginfo.php
+++ b/tests/formatting/getBloginfo.php
@@ -8,7 +8,7 @@
 class Tests_Formatting_GetBloginfo extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider locales
+	 * @dataProvider data_get_bloginfo_language
 	 * @ticket 28303
 	 */
 	public function test_get_bloginfo_language( $test_locale, $expected ) {
@@ -22,7 +22,7 @@ class Tests_Formatting_GetBloginfo extends WP_UnitTestCase {
 		$locale = $old_locale;
 	}
 
-	public function locales() {
+	public function data_get_bloginfo_language() {
 		return array(
 			// Locale, language code.
 			array( 'en_US', 'en-US' ),
diff --git a/tests/formatting/getUrlInContent.php b/tests/formatting/getUrlInContent.php
index dd79769998..ce99099ef5 100644
--- a/tests/formatting/getUrlInContent.php
+++ b/tests/formatting/getUrlInContent.php
@@ -8,11 +8,25 @@
 class Tests_Formatting_GetUrlInContent extends WP_UnitTestCase {
 
 	/**
-	 * URL Content Data Provider
+	 * Tests the get_url_in_content() function.
 	 *
-	 * array ( input_txt, converted_output_txt )
+	 * @dataProvider data_get_url_in_content
 	 */
-	public function get_input_output() {
+	public function test_get_url_in_content( $input, $expected ) {
+		$this->assertSame( $expected, get_url_in_content( $input ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input    Input content.
+	 *         @type string $expected Expected output.
+	 *     }
+	 * }
+	 */
+	public function data_get_url_in_content() {
 		return array(
 			array( // Empty content.
 				'',
@@ -40,13 +54,4 @@ class Tests_Formatting_GetUrlInContent extends WP_UnitTestCase {
 			),
 		);
 	}
-
-	/**
-	 * Validate the get_url_in_content function
-	 *
-	 * @dataProvider get_input_output
-	 */
-	public function test_get_url_in_content( $in_str, $exp_str ) {
-		$this->assertSame( $exp_str, get_url_in_content( $in_str ) );
-	}
 }
diff --git a/tests/formatting/humanTimeDiff.php b/tests/formatting/humanTimeDiff.php
index 829487c370..0a2bffb367 100644
--- a/tests/formatting/humanTimeDiff.php
+++ b/tests/formatting/humanTimeDiff.php
@@ -11,7 +11,7 @@ class Tests_Formatting_HumanTimeDiff extends WP_UnitTestCase {
 	/**
 	 * @group formatting
 	 * @ticket 38773
-	 * @dataProvider data_test_human_time_diff
+	 * @dataProvider data_human_time_diff
 	 */
 	public function test_human_time_diff( $expected, $stopdate, $message ) {
 		$startdate = new DateTime( '2016-01-01 12:00:00' );
@@ -19,7 +19,7 @@ class Tests_Formatting_HumanTimeDiff extends WP_UnitTestCase {
 	}
 
 	// Data for test_human_time_diff.
-	public function data_test_human_time_diff() {
+	public function data_human_time_diff() {
 		return array(
 			array(
 				'37 seconds',
diff --git a/tests/formatting/linksAddTarget.php b/tests/formatting/linksAddTarget.php
index 2bf582824f..1c9a6fedf3 100644
--- a/tests/formatting/linksAddTarget.php
+++ b/tests/formatting/linksAddTarget.php
@@ -5,12 +5,35 @@
  * @covers ::links_add_target
  */
 class Tests_Formatting_LinksAddTarget extends WP_UnitTestCase {
+
+	/**
+	 * Tests the links_add_target() function.
+	 *
+	 * @dataProvider data_links_add_target
+	 */
+	public function test_links_add_target( $content, $target, $tags, $expected ) {
+		if ( is_null( $target ) ) {
+			$this->assertSame( $expected, links_add_target( $content ) );
+		} elseif ( is_null( $tags ) ) {
+			$this->assertSame( $expected, links_add_target( $content, $target ) );
+		} else {
+			$this->assertSame( $expected, links_add_target( $content, $target, $tags ) );
+		}
+	}
+
 	/**
-	 * Test Content DataProvider
+	 * Data provider.
 	 *
-	 * array ( input_txt, converted_output_txt)
+	 * @return array {
+	 *     @type array {
+	 *         @type string $content  String to search for links in.
+	 *         @type string $target   The target to add to the links.
+	 *         @type string $tags     An array of tags to apply to.
+	 *         @type string $expected Expected output.
+	 *     }
+	 * }
 	 */
-	public function get_input_output() {
+	public function data_links_add_target() {
 		return array(
 			array(
 				'MY CONTENT <div> SOME ADDITIONAL TEXT <a href="XYZ" src="ABC">LINK</a> HERE </div> END TEXT',
@@ -92,19 +115,4 @@ class Tests_Formatting_LinksAddTarget extends WP_UnitTestCase {
 			),
 		);
 	}
-
-	/**
-	 * Validate the normalize_whitespace function
-	 *
-	 * @dataProvider get_input_output
-	 */
-	public function test_normalize_whitespace( $content, $target, $tags, $exp_str ) {
-		if ( true === is_null( $target ) ) {
-			$this->assertSame( $exp_str, links_add_target( $content ) );
-		} elseif ( true === is_null( $tags ) ) {
-			$this->assertSame( $exp_str, links_add_target( $content, $target ) );
-		} else {
-			$this->assertSame( $exp_str, links_add_target( $content, $target, $tags ) );
-		}
-	}
 }
diff --git a/tests/formatting/makeClickable.php b/tests/formatting/makeClickable.php
index 18dbe2da0c..0c6236c859 100644
--- a/tests/formatting/makeClickable.php
+++ b/tests/formatting/makeClickable.php
@@ -217,7 +217,7 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 			'In his famous speech “You and Your research” (here: http://www.cs.virginia.edu/~robins/YouAndYourResearch.html) Richard Hamming wrote about people getting more done with their doors closed...',
 		);
 		$urls_expected = array(
-			'Example: WordPress, test (some text), I love example.com (<a href="http://example.org" rel="nofollow">http://example.org</a>), it is brilliant',
+			'Example: WordPress, test (some text), I love example.com (<a href="http://example.org">http://example.org</a>), it is brilliant',
 			'Example: WordPress, test (some text), I love example.com (<a href="http://example.com" rel="nofollow">http://example.com</a>), it is brilliant',
 			'Some text followed by a bracketed link with a trailing elipsis (<a href="http://example.com" rel="nofollow">http://example.com</a>)...',
 			'In his famous speech “You and Your research” (here: <a href="http://www.cs.virginia.edu/~robins/YouAndYourResearch.html" rel="nofollow">http://www.cs.virginia.edu/~robins/YouAndYourResearch.html</a>) Richard Hamming wrote about people getting more done with their doors closed...',
@@ -421,6 +421,7 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 48022
+	 * @ticket 56444
 	 * @dataProvider data_add_rel_ugc_in_comments
 	 */
 	public function test_add_rel_ugc_in_comments( $content, $expected ) {
@@ -438,7 +439,11 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 	}
 
 	public function data_add_rel_ugc_in_comments() {
+		$home_url_http  = set_url_scheme( home_url(), 'http' );
+		$home_url_https = set_url_scheme( home_url(), 'https' );
+
 		return array(
+			// @ticket 48022
 			array(
 				'http://wordpress.org',
 				'<a href="http://wordpress.org" rel="nofollow ugc">http://wordpress.org</a>',
@@ -447,6 +452,19 @@ class Tests_Formatting_MakeClickable extends WP_UnitTestCase {
 				'www.wordpress.org',
 				'<p><a href="http://www.wordpress.org" rel="nofollow ugc">http://www.wordpress.org</a>',
 			),
+			// @ticket 56444
+			array(
+				'www.example.org',
+				'<p><a href="http://www.example.org" rel="nofollow ugc">http://www.example.org</a>',
+			),
+			array(
+				$home_url_http,
+				'<a href="' . $home_url_http . '" rel="ugc">' . $home_url_http . '</a>',
+			),
+			array(
+				$home_url_https,
+				'<a href="' . $home_url_https . '" rel="ugc">' . $home_url_https . '</a>',
+			),
 		);
 	}
 
diff --git a/tests/formatting/normalizeWhitespace.php b/tests/formatting/normalizeWhitespace.php
index cdb9a0062d..b14647b32e 100644
--- a/tests/formatting/normalizeWhitespace.php
+++ b/tests/formatting/normalizeWhitespace.php
@@ -5,12 +5,27 @@
  * @covers ::normalize_whitespace
  */
 class Tests_Formatting_NormalizeWhitespace extends WP_UnitTestCase {
+
+	/**
+	 * Tests the the normalize_whitespace() function.
+	 *
+	 * @dataProvider data_normalize_whitespace
+	 */
+	public function test_normalize_whitespace( $input, $expected ) {
+		$this->assertSame( $expected, normalize_whitespace( $input ) );
+	}
+
 	/**
-	 * WhitespaceTest Content DataProvider
+	 * Data provider.
 	 *
-	 * array( input_txt, converted_output_txt)
+	 * @return array {
+	 *     @type array {
+	 *         @type string $input    Input content.
+	 *         @type string $expected Expected output.
+	 *     }
+	 * }
 	 */
-	public function get_input_output() {
+	public function data_normalize_whitespace() {
 		return array(
 			array(
 				'		',
@@ -42,13 +57,4 @@ class Tests_Formatting_NormalizeWhitespace extends WP_UnitTestCase {
 			),
 		);
 	}
-
-	/**
-	 * Validate the normalize_whitespace function
-	 *
-	 * @dataProvider get_input_output
-	 */
-	public function test_normalize_whitespace( $in_str, $exp_str ) {
-		$this->assertSame( $exp_str, normalize_whitespace( $in_str ) );
-	}
 }
diff --git a/tests/formatting/redirect.php b/tests/formatting/redirect.php
index 213ba36bf5..99e4c8a882 100644
--- a/tests/formatting/redirect.php
+++ b/tests/formatting/redirect.php
@@ -18,7 +18,7 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 	/**
 	 * @ticket 44317
 	 *
-	 * @dataProvider get_bad_status_codes
+	 * @dataProvider data_wp_redirect_bad_status_code
 	 *
 	 * @covers ::wp_redirect
 	 *
@@ -31,7 +31,7 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 		wp_redirect( $location, $status );
 	}
 
-	public function get_bad_status_codes() {
+	public function data_wp_redirect_bad_status_code() {
 		return array(
 			// Tests for bad arguments.
 			array( '/wp-admin', 404 ),
@@ -73,7 +73,7 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider valid_url_provider
+	 * @dataProvider data_wp_validate_redirect_valid_url
 	 *
 	 * @covers ::wp_validate_redirect
 	 */
@@ -81,16 +81,7 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 		$this->assertSame( $expected, wp_validate_redirect( $url ) );
 	}
 
-	/**
-	 * @dataProvider invalid_url_provider
-	 *
-	 * @covers ::wp_validate_redirect
-	 */
-	public function test_wp_validate_redirect_invalid_url( $url ) {
-		$this->assertEquals( false, wp_validate_redirect( $url, false ) );
-	}
-
-	public function valid_url_provider() {
+	public function data_wp_validate_redirect_valid_url() {
 		return array(
 			array( 'http://example.com', 'http://example.com' ),
 			array( 'http://example.com/', 'http://example.com/' ),
@@ -106,7 +97,16 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 		);
 	}
 
-	public function invalid_url_provider() {
+	/**
+	 * @dataProvider data_wp_validate_redirect_invalid_url
+	 *
+	 * @covers ::wp_validate_redirect
+	 */
+	public function test_wp_validate_redirect_invalid_url( $url ) {
+		$this->assertEquals( false, wp_validate_redirect( $url, false ) );
+	}
+
+	public function data_wp_validate_redirect_invalid_url() {
 		return array(
 			// parse_url() fails.
 			array( '' ),
@@ -176,7 +176,7 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 47980
-	 * @dataProvider relative_url_provider
+	 * @dataProvider data_wp_validate_redirect_relative_url
 	 *
 	 * @covers ::wp_validate_redirect
 	 */
@@ -211,7 +211,7 @@ class Tests_Formatting_Redirect extends WP_UnitTestCase {
 	 *      string Expected destination.
 	 * }
 	 */
-	public function relative_url_provider() {
+	public function data_wp_validate_redirect_relative_url() {
 		return array(
 			array(
 				'/',
diff --git a/tests/formatting/sanitizeFileName.php b/tests/formatting/sanitizeFileName.php
index 06c2f10976..d0fac9e232 100644
--- a/tests/formatting/sanitizeFileName.php
+++ b/tests/formatting/sanitizeFileName.php
@@ -95,4 +95,53 @@ class Tests_Formatting_SanitizeFileName extends WP_UnitTestCase {
 			array( 'demo' . json_decode( '"\u00a0"' ) . 'bar.png', 'demo-bar.png' ),
 		);
 	}
+
+	/**
+	 * Tests that sanitize_file_name() replaces consecutive periods
+	 * with a single period.
+	 *
+	 * @ticket 57242
+	 *
+	 * @dataProvider data_sanitize_file_name_should_replace_consecutive_periods_with_a_single_period
+	 *
+	 * @param string $filename A filename with consecutive periods.
+	 * @param string $expected The expected filename after sanitization.
+	 */
+	public function test_sanitize_file_name_should_replace_consecutive_periods_with_a_single_period( $filename, $expected ) {
+		$this->assertSame( $expected, sanitize_file_name( $filename ) );
+	}
+
+	/**
+	 * Data provider for test_sanitize_file_name_should_replace_consecutive_periods_with_a_single_period().
+	 *
+	 * @return array[]
+	 */
+	public function data_sanitize_file_name_should_replace_consecutive_periods_with_a_single_period() {
+		return array(
+			'consecutive periods at the start'         => array(
+				'filename' => '...filename.png',
+				'expected' => 'filename.png',
+			),
+			'consecutive periods in the middle'        => array(
+				'filename' => 'file.......name.png',
+				'expected' => 'file.name_.png',
+			),
+			'consecutive periods before the extension' => array(
+				'filename' => 'filename....png',
+				'expected' => 'filename.png',
+			),
+			'consecutive periods after the extension'  => array(
+				'filename' => 'filename.png...',
+				'expected' => 'filename.png',
+			),
+			'consecutive periods at the start, middle, before, after the extension' => array(
+				'filename' => '.....file....name...png......',
+				'expected' => 'file.name_.png',
+			),
+			'consecutive periods and no extension'     => array(
+				'filename' => 'filename...',
+				'expected' => 'filename',
+			),
+		);
+	}
 }
diff --git a/tests/formatting/sanitizeOrderby.php b/tests/formatting/sanitizeOrderby.php
index 8384f8a4b2..fec1d41713 100644
--- a/tests/formatting/sanitizeOrderby.php
+++ b/tests/formatting/sanitizeOrderby.php
@@ -8,12 +8,12 @@
 class Tests_Formatting_SanitizeOrderby extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider valid_orderbys
+	 * @dataProvider data_sanitize_sql_orderby_valid
 	 */
-	public function test_valid( $orderby ) {
+	public function test_sanitize_sql_orderby_valid( $orderby ) {
 		$this->assertSame( $orderby, sanitize_sql_orderby( $orderby ) );
 	}
-	public function valid_orderbys() {
+	public function data_sanitize_sql_orderby_valid() {
 		return array(
 			array( '1' ),
 			array( '1 ASC' ),
@@ -34,12 +34,12 @@ class Tests_Formatting_SanitizeOrderby extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider invalid_orderbys
+	 * @dataProvider data_sanitize_sql_orderby_invalid
 	 */
-	public function test_invalid( $orderby ) {
+	public function test_sanitize_sql_orderby_invalid( $orderby ) {
 		$this->assertFalse( sanitize_sql_orderby( $orderby ) );
 	}
-	public function invalid_orderbys() {
+	public function data_sanitize_sql_orderby_invalid() {
 		return array(
 			array( '' ),
 			array( '1 2' ),
diff --git a/tests/formatting/sanitizeTextField.php b/tests/formatting/sanitizeTextField.php
index ffee225354..2d184ebb13 100644
--- a/tests/formatting/sanitizeTextField.php
+++ b/tests/formatting/sanitizeTextField.php
@@ -7,6 +7,24 @@
  * @covers ::sanitize_textarea_field
  */
 class Tests_Formatting_SanitizeTextField extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 32257
+	 * @dataProvider data_sanitize_text_field
+	 */
+	public function test_sanitize_text_field( $str, $expected ) {
+		if ( is_array( $expected ) ) {
+			$expected_oneline   = $expected['oneline'];
+			$expected_multiline = $expected['multiline'];
+		} else {
+			$expected_oneline   = $expected;
+			$expected_multiline = $expected;
+		}
+		$this->assertSame( $expected_oneline, sanitize_text_field( $str ) );
+		$this->assertSameIgnoreEOL( $expected_multiline, sanitize_textarea_field( $str ) );
+
+	}
+
 	public function data_sanitize_text_field() {
 		return array(
 			array(
@@ -126,21 +144,4 @@ class Tests_Formatting_SanitizeTextField extends WP_UnitTestCase {
 			),
 		);
 	}
-
-	/**
-	 * @ticket 32257
-	 * @dataProvider data_sanitize_text_field
-	 */
-	public function test_sanitize_text_field( $str, $expected ) {
-		if ( is_array( $expected ) ) {
-			$expected_oneline   = $expected['oneline'];
-			$expected_multiline = $expected['multiline'];
-		} else {
-			$expected_oneline   = $expected;
-			$expected_multiline = $expected;
-		}
-		$this->assertSame( $expected_oneline, sanitize_text_field( $str ) );
-		$this->assertSameIgnoreEOL( $expected_multiline, sanitize_textarea_field( $str ) );
-
-	}
 }
diff --git a/tests/formatting/sanitizeTrackbackUrls.php b/tests/formatting/sanitizeTrackbackUrls.php
index f5a5404e93..b560ad5c75 100644
--- a/tests/formatting/sanitizeTrackbackUrls.php
+++ b/tests/formatting/sanitizeTrackbackUrls.php
@@ -8,7 +8,7 @@
 class Tests_Formatting_SanitizeTrackbackUrls extends WP_UnitTestCase {
 	/**
 	 * @ticket 21624
-	 * @dataProvider separators
+	 * @dataProvider data_sanitize_trackback_urls_with_multiple_urls
 	 */
 	public function test_sanitize_trackback_urls_with_multiple_urls( $separator ) {
 		$this->assertSame(
@@ -17,7 +17,7 @@ class Tests_Formatting_SanitizeTrackbackUrls extends WP_UnitTestCase {
 		);
 	}
 
-	public function separators() {
+	public function data_sanitize_trackback_urls_with_multiple_urls() {
 		return array(
 			array( "\r\n\t " ),
 			array( "\r" ),
diff --git a/tests/formatting/seemsUtf8.php b/tests/formatting/seemsUtf8.php
index 5e9bb8e8a1..b6a67950e9 100644
--- a/tests/formatting/seemsUtf8.php
+++ b/tests/formatting/seemsUtf8.php
@@ -10,14 +10,14 @@ class Tests_Formatting_SeemsUtf8 extends WP_UnitTestCase {
 	/**
 	 * `seems_utf8` returns true for utf-8 strings, false otherwise.
 	 *
-	 * @dataProvider utf8_strings
+	 * @dataProvider data_seems_utf8_returns_true_for_utf8_strings
 	 */
-	public function test_returns_true_for_utf8_strings( $utf8_string ) {
+	public function test_seems_utf8_returns_true_for_utf8_strings( $utf8_string ) {
 		// From http://www.i18nguy.com/unicode-example.html
 		$this->assertTrue( seems_utf8( $utf8_string ) );
 	}
 
-	public function utf8_strings() {
+	public function data_seems_utf8_returns_true_for_utf8_strings() {
 		$utf8_strings = file( DIR_TESTDATA . '/formatting/utf-8/utf-8.txt' );
 		foreach ( $utf8_strings as &$string ) {
 			$string = (array) trim( $string );
@@ -27,13 +27,13 @@ class Tests_Formatting_SeemsUtf8 extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider big5_strings
+	 * @dataProvider data_seems_utf8_returns_false_for_non_utf8_strings
 	 */
-	public function test_returns_false_for_non_utf8_strings( $big5_string ) {
+	public function test_seems_utf8_returns_false_for_non_utf8_strings( $big5_string ) {
 		$this->assertFalse( seems_utf8( $big5_string ) );
 	}
 
-	public function big5_strings() {
+	public function data_seems_utf8_returns_false_for_non_utf8_strings() {
 		// Get data from formatting/big5.txt.
 		$big5_strings = file( DIR_TESTDATA . '/formatting/big5.txt' );
 		foreach ( $big5_strings as &$string ) {
diff --git a/tests/formatting/urlencodeDeep.php b/tests/formatting/urlencodeDeep.php
index a3b461a6ae..632f4083c0 100644
--- a/tests/formatting/urlencodeDeep.php
+++ b/tests/formatting/urlencodeDeep.php
@@ -9,9 +9,21 @@
 class Tests_Formatting_UrlencodeDeep extends WP_UnitTestCase {
 
 	/**
-	 * Data Provider
+	 * Tests the urlencode_deep() function pair by pair.
+	 *
+	 * @dataProvider data_urlencode_deep
+	 *
+	 * @param string $input
+	 * @param string $expected
+	 */
+	public function test_urlencode_deep_should_encode_individual_value( $input, $expected ) {
+		$this->assertSame( $expected, urlencode_deep( $input ) );
+	}
+
+	/**
+	 * Data provider.
 	 */
-	public function data_test_values() {
+	public function data_urlencode_deep() {
 		return array(
 			array( 'qwerty123456', 'qwerty123456' ),
 			array( '|!"£$%&/()=?', '%7C%21%22%C2%A3%24%25%26%2F%28%29%3D%3F' ),
@@ -22,22 +34,10 @@ class Tests_Formatting_UrlencodeDeep extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Validate the urlencode_deep function pair by pair
-	 *
-	 * @dataProvider data_test_values
-	 *
-	 * @param string $actual
-	 * @param string $expected
-	 */
-	public function test_urlencode_deep_should_encode_individual_value( $actual, $expected ) {
-		$this->assertSame( $expected, urlencode_deep( $actual ) );
-	}
-
-	/**
-	 * Test the whole array as input
+	 * Tests the whole array as input.
 	 */
 	public function test_urlencode_deep_should_encode_all_values_in_array() {
-		$data = $this->data_test_values();
+		$data = $this->data_urlencode_deep();
 
 		$actual   = wp_list_pluck( $data, 0 );
 		$expected = wp_list_pluck( $data, 1 );
diff --git a/tests/formatting/wpAutop.php b/tests/formatting/wpAutop.php
index 315a0c9794..6630782963 100644
--- a/tests/formatting/wpAutop.php
+++ b/tests/formatting/wpAutop.php
@@ -104,6 +104,63 @@ PS.  Not yet subscribed for update notifications?  <a href="%1$s" title="Subscri
 		$this->assertSame( "<p>$str</p>", trim( wpautop( $str ) ) );
 	}
 
+	/**
+	 * wpautop() Should add <p> around inline "<math>" elements.
+	 *
+	 * @ticket 13340
+	 */
+	public function test_wrap_inline_math_elements() {
+		$str = '<math><mrow><msup><mi>a</mi><mn>2</mn></msup><mo>+</mo><msup><mi>b</mi><mn>2</mn></msup><mo>=</mo><msup><mi>c</mi><mn>2</mn></msup></mrow></math>';
+
+		$this->assertSame( "<p>$str</p>", trim( wpautop( $str ) ) );
+	}
+
+	/**
+	 * wpautop() Should not add <br> inside block "<math>" elements.
+	 *
+	 * @ticket 13340
+	 */
+	public function test_skip_block_math_elements() {
+		$str = '<math display="block">
+	<mtable>
+		<mtr>
+			<mtd>
+				<msup><mrow><mo>(</mo><mi>a</mi><mo>+</mo><mi>b</mi><mo>)</mo></mrow><mn>2</mn></msup>
+			</mtd>
+			<mtd>
+				<mo>=</mo>
+			</mtd>
+			<mtd>
+				<msup><mi>c</mi><mn>2</mn></msup>
+				<mo>+</mo><mn>4</mn><mo>⋅</mo>
+				<mo>(</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>a</mi><mi>b</mi><mo>)</mo>
+			</mtd>
+		</mtr>
+		<mtr>
+			<mtd>
+				<msup><mi>a</mi><mn>2</mn></msup>
+				<mo>+</mo><mn>2</mn><mi>a</mi><mi>b</mi><mo>+</mo>
+				<msup><mi>b</mi><mn>2</mn></msup>
+			</mtd>
+			<mtd>
+				<mo>=</mo>
+			</mtd>
+			<mtd>
+				<msup><mi>c</mi><mn>2</mn></msup>
+				<mo>+</mo><mn>2</mn><mi>a</mi><mi>b</mi>
+			</mtd>
+		</mtr>
+		<mtr>
+			<mtd><msup><mi>a</mi><mn>2</mn></msup><mo>+</mo><msup><mi>b</mi><mn>2</mn></msup></mtd>
+			<mtd><mo>=</mo></mtd>
+			<mtd><msup><mi>c</mi><mn>2</mn></msup></mtd>
+		</mtr>
+	</mtable>
+</math>';
+
+		$this->assertSameIgnoreEOL( "<p>$str</p>", trim( wpautop( $str ) ) );
+	}
+
 	/**
 	 * wpautop() Should not add <p> and <br/> around <source> and <track>
 	 *
@@ -308,7 +365,6 @@ Paragraph two.';
 			'map',
 			'area',
 			'address',
-			'math',
 			'style',
 			'p',
 			'h1',
diff --git a/tests/formatting/wpParseStr.php b/tests/formatting/wpParseStr.php
index 7a44d5fe96..502715b97b 100644
--- a/tests/formatting/wpParseStr.php
+++ b/tests/formatting/wpParseStr.php
@@ -24,7 +24,7 @@ class Tests_Formatting_wpParseStr extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Data Provider.
+	 * Data provider.
 	 *
 	 * @return array
 	 */
diff --git a/tests/formatting/wpRelNofollow.php b/tests/formatting/wpRelNofollow.php
index 0b45d22e15..41cf835313 100644
--- a/tests/formatting/wpRelNofollow.php
+++ b/tests/formatting/wpRelNofollow.php
@@ -11,16 +11,6 @@ class Tests_Formatting_wpRelNofollow extends WP_UnitTestCase {
 	 * @ticket 9959
 	 */
 	public function test_add_no_follow() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$content  = '<p>This is some cool <a href="/">Code</a></p>';
 		$expected = '<p>This is some cool <a href=\"/\" rel=\"nofollow\">Code</a></p>';
 		$this->assertSame( $expected, wp_rel_nofollow( $content ) );
@@ -30,16 +20,6 @@ class Tests_Formatting_wpRelNofollow extends WP_UnitTestCase {
 	 * @ticket 9959
 	 */
 	public function test_convert_no_follow() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$content  = '<p>This is some cool <a href="/" rel="weird">Code</a></p>';
 		$expected = '<p>This is some cool <a href=\"/\" rel=\"weird nofollow\">Code</a></p>';
 		$this->assertSame( $expected, wp_rel_nofollow( $content ) );
@@ -50,16 +30,6 @@ class Tests_Formatting_wpRelNofollow extends WP_UnitTestCase {
 	 * @dataProvider data_wp_rel_nofollow
 	 */
 	public function test_wp_rel_nofollow( $input, $output, $expect_deprecation = false ) {
-		if ( true === $expect_deprecation && PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$this->assertSame( wp_slash( $output ), wp_rel_nofollow( $input ) );
 	}
 
@@ -109,16 +79,6 @@ class Tests_Formatting_wpRelNofollow extends WP_UnitTestCase {
 	}
 
 	public function test_append_no_follow_with_valueless_attribute() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$content  = '<p>This is some cool <a href="demo.com" download rel="hola">Code</a></p>';
 		$expected = '<p>This is some cool <a href=\"demo.com\" download rel=\"hola nofollow\">Code</a></p>';
 		$this->assertSame( $expected, wp_rel_nofollow( $content ) );
diff --git a/tests/formatting/wpRelUgc.php b/tests/formatting/wpRelUgc.php
index 4b8b11dafa..6f5f942596 100644
--- a/tests/formatting/wpRelUgc.php
+++ b/tests/formatting/wpRelUgc.php
@@ -11,16 +11,6 @@ class Tests_Formatting_wpRelUgc extends WP_UnitTestCase {
 	 * @ticket 48022
 	 */
 	public function test_add_ugc() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$content  = '<p>This is some cool <a href="/">Code</a></p>';
 		$expected = '<p>This is some cool <a href=\"/\" rel=\"nofollow ugc\">Code</a></p>';
 		$this->assertSame( $expected, wp_rel_ugc( $content ) );
@@ -30,16 +20,6 @@ class Tests_Formatting_wpRelUgc extends WP_UnitTestCase {
 	 * @ticket 48022
 	 */
 	public function test_convert_ugc() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$content  = '<p>This is some cool <a href="/" rel="weird">Code</a></p>';
 		$expected = '<p>This is some cool <a href=\"/\" rel=\"weird nofollow ugc\">Code</a></p>';
 		$this->assertSame( $expected, wp_rel_ugc( $content ) );
@@ -50,16 +30,6 @@ class Tests_Formatting_wpRelUgc extends WP_UnitTestCase {
 	 * @dataProvider data_wp_rel_ugc
 	 */
 	public function test_wp_rel_ugc( $input, $output, $expect_deprecation = false ) {
-		if ( true === $expect_deprecation && PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
-
 		$this->assertSame( wp_slash( $output ), wp_rel_ugc( $input ) );
 	}
 
@@ -99,25 +69,16 @@ class Tests_Formatting_wpRelUgc extends WP_UnitTestCase {
 			),
 			array(
 				'<a href="' . $home_url_http . '/some-url">Home URL (http)</a>',
-				'<a href="' . $home_url_http . '/some-url">Home URL (http)</a>',
+				'<a href="' . $home_url_http . '/some-url" rel="ugc">Home URL (http)</a>',
 			),
 			array(
 				'<a href="' . $home_url_https . '/some-url">Home URL (https)</a>',
-				'<a href="' . $home_url_https . '/some-url">Home URL (https)</a>',
+				'<a href="' . $home_url_https . '/some-url" rel="ugc">Home URL (https)</a>',
 			),
 		);
 	}
 
 	public function test_append_ugc_with_valueless_attribute() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, ignoring PHP 8.1 "null to non-nullable" deprecations coming in
-			 * via hooked in filter functions until a more structural solution to the
-			 * "missing input validation" conundrum has been architected and implemented.
-			 */
-			$this->expectDeprecation();
-			$this->expectDeprecationMessageMatches( '`Passing null to parameter \#[0-9]+ \(\$[^\)]+\) of type [^ ]+ is deprecated`' );
-		}
 
 		$content  = '<p>This is some cool <a href="demo.com" download rel="hola">Code</a></p>';
 		$expected = '<p>This is some cool <a href=\"demo.com\" download rel=\"hola nofollow ugc\">Code</a></p>';
diff --git a/tests/formatting/wpStripAllTags.php b/tests/formatting/wpStripAllTags.php
index 2ef332e62e..3efe479dec 100644
--- a/tests/formatting/wpStripAllTags.php
+++ b/tests/formatting/wpStripAllTags.php
@@ -31,5 +31,76 @@ class Tests_Formatting_wpStripAllTags extends WP_UnitTestCase {
 		$text = "lorem<style>* { display: 'none' }<script>alert( document.cookie )</script></style>ipsum";
 		$this->assertSame( 'loremipsum', wp_strip_all_tags( $text ) );
 	}
+
+	/**
+	 * Tests that `wp_strip_all_tags()` returns an empty string when null is passed.
+	 *
+	 * @ticket 56434
+	 */
+	public function test_wp_strip_all_tags_should_return_empty_string_for_a_null_arg() {
+		$this->assertSame( '', wp_strip_all_tags( null ) );
+	}
+
+	/**
+	 * Tests that `wp_strip_all_tags()` triggers a warning and returns
+	 * an empty string when passed a non-string argument.
+	 *
+	 * @ticket 56434
+	 *
+	 * @dataProvider data_wp_strip_all_tags_should_return_empty_string_and_trigger_an_error_for_non_string_arg
+	 *
+	 * @param mixed $non_string A non-string value.
+	 */
+	public function test_wp_strip_all_tags_should_return_empty_string_and_trigger_an_error_for_non_string_arg( $non_string ) {
+		$type = gettype( $non_string );
+		$this->expectError();
+		$this->expectErrorMessage( "Warning: wp_strip_all_tags expects parameter #1 (\$text) to be a string, $type given." );
+		$this->assertSame( '', wp_strip_all_tags( $non_string ) );
+	}
+
+	/**
+	 * Data provider for test_wp_strip_all_tags_should_return_empty_string_and_trigger_an_error_for_non_string_arg().
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_strip_all_tags_should_return_empty_string_and_trigger_an_error_for_non_string_arg() {
+		return array(
+			'an empty array'     => array( 'non_string' => array() ),
+			'a non-empty array'  => array( 'non_string' => array( 'a string' ) ),
+			'an empty object'    => array( 'non_string' => new stdClass() ),
+			'a non-empty object' => array( 'non_string' => (object) array( 'howdy' => 'admin' ) ),
+		);
+	}
+
+	/**
+	 * Tests that `wp_strip_all_tags()` casts scalar values to string.
+	 *
+	 * @ticket 56434
+	 *
+	 * @dataProvider data_wp_strip_all_tags_should_cast_scalar_values_to_string
+	 *
+	 * @param mixed $text A scalar value.
+	 */
+	public function test_wp_strip_all_tags_should_cast_scalar_values_to_string( $text ) {
+		$this->assertSame( (string) $text, wp_strip_all_tags( $text ) );
+	}
+
+	/**
+	 * Data provider for test_wp_strip_all_tags_should_cast_scalar_values_to_string()/
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_strip_all_tags_should_cast_scalar_values_to_string() {
+		return array(
+			'(int) 0'      => array( 'text' => 0 ),
+			'(int) 1'      => array( 'text' => 1 ),
+			'(int) -1'     => array( 'text' => -1 ),
+			'(float) 0.0'  => array( 'text' => 0.0 ),
+			'(float) 1.0'  => array( 'text' => 1.0 ),
+			'(float) -1.0' => array( 'text' => -1.0 ),
+			'(bool) false' => array( 'text' => false ),
+			'(bool) true'  => array( 'text' => true ),
+		);
+	}
 }
 
diff --git a/tests/functions.php b/tests/functions.php
index 71cd6b67d1..aa12b106e1 100644
--- a/tests/functions.php
+++ b/tests/functions.php
@@ -133,7 +133,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 * Tests path_join().
 	 *
 	 * @ticket 55897
-	 * @dataProvider path_join_data_provider
+	 * @dataProvider data_path_join
 	 */
 	public function test_path_join( $base, $path, $expected ) {
 		$this->assertSame( $expected, path_join( $base, $path ) );
@@ -144,7 +144,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 *
 	 * @return string[][]
 	 */
-	public function path_join_data_provider() {
+	public function data_path_join() {
 		return array(
 			// Absolute paths.
 			'absolute path should return path' => array(
@@ -258,7 +258,7 @@ class Tests_Functions extends WP_UnitTestCase {
 		$this->assertSame( 'abcdefgh.png', wp_unique_filename( $testdir, 'abcdefg"h.png' ), 'File with quote failed' );
 
 		// Test crazy name (useful for regression tests).
-		$this->assertSame( '12af34567890@..^_qwerty-fghjkl-zx.png', wp_unique_filename( $testdir, '12%af34567890#~!@#$..%^&*()|_+qwerty  fgh`jkl zx<>?:"{}[]="\'/?.png' ), 'Failed crazy file name' );
+		$this->assertSame( '12af34567890@.^_qwerty-fghjkl-zx.png', wp_unique_filename( $testdir, '12%af34567890#~!@#$..%^&*()|_+qwerty  fgh`jkl zx<>?:"{}[]="\'/?.png' ), 'Failed crazy file name' );
 
 		// Test slashes in names.
 		$this->assertSame( 'abcdefg.png', wp_unique_filename( $testdir, 'abcde\fg.png' ), 'Slash not removed' );
@@ -1158,7 +1158,7 @@ class Tests_Functions extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 36054
-	 * @dataProvider datetime_provider
+	 * @dataProvider data_mysql_to_rfc3339
 	 */
 	public function test_mysql_to_rfc3339( $expected, $actual ) {
 		$date_return = mysql_to_rfc3339( $actual );
@@ -1169,7 +1169,7 @@ class Tests_Functions extends WP_UnitTestCase {
 		$this->assertEquals( new DateTime( $expected ), new DateTime( $date_return ), 'The date is not the same after the call method' );
 	}
 
-	public function datetime_provider() {
+	public function data_mysql_to_rfc3339() {
 		return array(
 			array( '2016-03-15T18:54:46', '15-03-2016 18:54:46' ),
 			array( '2016-03-02T19:13:25', '2016-03-02 19:13:25' ),
@@ -1334,7 +1334,7 @@ class Tests_Functions extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 40017
-	 * @dataProvider wp_get_image_mime
+	 * @dataProvider data_wp_get_image_mime
 	 */
 	public function test_wp_get_image_mime( $file, $expected ) {
 		if ( ! is_callable( 'exif_imagetype' ) && ! function_exists( 'getimagesize' ) ) {
@@ -1344,106 +1344,10 @@ class Tests_Functions extends WP_UnitTestCase {
 		$this->assertSame( $expected, wp_get_image_mime( $file ) );
 	}
 
-	/**
-	 * @ticket 35725
-	 * @dataProvider data_wp_getimagesize
-	 */
-	public function test_wp_getimagesize( $file, $expected ) {
-		if ( ! is_callable( 'exif_imagetype' ) && ! function_exists( 'getimagesize' ) ) {
-			$this->markTestSkipped( 'The exif PHP extension is not loaded.' );
-		}
-
-		$result = wp_getimagesize( $file );
-
-		// The getimagesize() function varies in its response, so
-		// let's restrict comparison to expected keys only.
-		if ( is_array( $expected ) ) {
-			foreach ( $expected as $k => $v ) {
-				$this->assertArrayHasKey( $k, $result );
-				$this->assertSame( $expected[ $k ], $result[ $k ] );
-			}
-		} else {
-			$this->assertSame( $expected, $result );
-		}
-	}
-
-	/**
-	 * @ticket 39550
-	 * @dataProvider wp_check_filetype_and_ext_data
-	 * @requires extension fileinfo
-	 */
-	public function test_wp_check_filetype_and_ext( $file, $filename, $expected ) {
-		$this->assertSame( $expected, wp_check_filetype_and_ext( $file, $filename ) );
-	}
-
-	/**
-	 * @ticket 39550
-	 * @group ms-excluded
-	 * @requires extension fileinfo
-	 */
-	public function test_wp_check_filetype_and_ext_with_filtered_svg() {
-		$file     = DIR_TESTDATA . '/uploads/video-play.svg';
-		$filename = 'video-play.svg';
-
-		$expected = array(
-			'ext'             => 'svg',
-			'type'            => 'image/svg+xml',
-			'proper_filename' => false,
-		);
-
-		add_filter( 'upload_mimes', array( $this, 'filter_mime_types_svg' ) );
-		$this->assertSame( $expected, wp_check_filetype_and_ext( $file, $filename ) );
-
-		// Cleanup.
-		remove_filter( 'upload_mimes', array( $this, 'filter_mime_types_svg' ) );
-	}
-
-	/**
-	 * @ticket 39550
-	 * @group ms-excluded
-	 * @requires extension fileinfo
-	 */
-	public function test_wp_check_filetype_and_ext_with_filtered_woff() {
-		if ( PHP_VERSION_ID >= 80100 ) {
-			/*
-			 * For the time being, this test is marked skipped on PHP 8.1+ as a recent change introduced
-			 * an inconsistency with how the mime-type for WOFF files are handled compared to older versions.
-			 *
-			 * See https://core.trac.wordpress.org/ticket/56817 for more details.
-			 */
-			$this->markTestSkipped( 'This test currently fails on PHP 8.1+ and requires further investigation.' );
-		}
-
-		$file     = DIR_TESTDATA . '/uploads/dashicons.woff';
-		$filename = 'dashicons.woff';
-
-		$expected = array(
-			'ext'             => 'woff',
-			'type'            => 'application/font-woff',
-			'proper_filename' => false,
-		);
-
-		add_filter( 'upload_mimes', array( $this, 'filter_mime_types_woff' ) );
-		$this->assertSame( $expected, wp_check_filetype_and_ext( $file, $filename ) );
-
-		// Cleanup.
-		remove_filter( 'upload_mimes', array( $this, 'filter_mime_types_woff' ) );
-	}
-
-	public function filter_mime_types_svg( $mimes ) {
-		$mimes['svg'] = 'image/svg+xml';
-		return $mimes;
-	}
-
-	public function filter_mime_types_woff( $mimes ) {
-		$mimes['woff'] = 'application/font-woff';
-		return $mimes;
-	}
-
 	/**
 	 * Data provider for test_wp_get_image_mime().
 	 */
-	public function wp_get_image_mime() {
+	public function data_wp_get_image_mime() {
 		$data = array(
 			// Standard JPEG.
 			array(
@@ -1495,6 +1399,29 @@ class Tests_Functions extends WP_UnitTestCase {
 		return $data;
 	}
 
+	/**
+	 * @ticket 35725
+	 * @dataProvider data_wp_getimagesize
+	 */
+	public function test_wp_getimagesize( $file, $expected ) {
+		if ( ! is_callable( 'exif_imagetype' ) && ! function_exists( 'getimagesize' ) ) {
+			$this->markTestSkipped( 'The exif PHP extension is not loaded.' );
+		}
+
+		$result = wp_getimagesize( $file );
+
+		// The getimagesize() function varies in its response, so
+		// let's restrict comparison to expected keys only.
+		if ( is_array( $expected ) ) {
+			foreach ( $expected as $k => $v ) {
+				$this->assertArrayHasKey( $k, $result );
+				$this->assertSame( $expected[ $k ], $result[ $k ] );
+			}
+		} else {
+			$this->assertSame( $expected, $result );
+		}
+	}
+
 	/**
 	 * Data profider for test_wp_getimagesize().
 	 */
@@ -1598,7 +1525,16 @@ class Tests_Functions extends WP_UnitTestCase {
 		return $data;
 	}
 
-	public function wp_check_filetype_and_ext_data() {
+	/**
+	 * @ticket 39550
+	 * @dataProvider data_wp_check_filetype_and_ext
+	 * @requires extension fileinfo
+	 */
+	public function test_wp_check_filetype_and_ext( $file, $filename, $expected ) {
+		$this->assertSame( $expected, wp_check_filetype_and_ext( $file, $filename ) );
+	}
+
+	public function data_wp_check_filetype_and_ext() {
 		$data = array(
 			// Standard image.
 			array(
@@ -1763,11 +1699,75 @@ class Tests_Functions extends WP_UnitTestCase {
 		return $data;
 	}
 
+	/**
+	 * @ticket 39550
+	 * @group ms-excluded
+	 * @requires extension fileinfo
+	 */
+	public function test_wp_check_filetype_and_ext_with_filtered_svg() {
+		$file     = DIR_TESTDATA . '/uploads/video-play.svg';
+		$filename = 'video-play.svg';
+
+		$expected = array(
+			'ext'             => 'svg',
+			'type'            => 'image/svg+xml',
+			'proper_filename' => false,
+		);
+
+		add_filter(
+			'upload_mimes',
+			static function( $mimes ) {
+				$mimes['svg'] = 'image/svg+xml';
+				return $mimes;
+			}
+		);
+
+		$this->assertSame( $expected, wp_check_filetype_and_ext( $file, $filename ) );
+	}
+
+	/**
+	 * @ticket 39550
+	 * @group ms-excluded
+	 * @requires extension fileinfo
+	 */
+	public function test_wp_check_filetype_and_ext_with_filtered_woff() {
+		$file     = DIR_TESTDATA . '/uploads/dashicons.woff';
+		$filename = 'dashicons.woff';
+
+		$woff_mime_type = 'application/font-woff';
+
+		/*
+		 * As of PHP 8.1.12, which includes libmagic/file update to version 5.42,
+		 * the expected mime type for WOFF files is 'font/woff'.
+		 *
+		 * See https://github.com/php/php-src/issues/8805.
+		 */
+		if ( PHP_VERSION_ID >= 80112 ) {
+			$woff_mime_type = 'font/woff';
+		}
+
+		$expected = array(
+			'ext'             => 'woff',
+			'type'            => $woff_mime_type,
+			'proper_filename' => false,
+		);
+
+		add_filter(
+			'upload_mimes',
+			static function( $mimes ) use ( $woff_mime_type ) {
+				$mimes['woff'] = $woff_mime_type;
+				return $mimes;
+			}
+		);
+
+		$this->assertSame( $expected, wp_check_filetype_and_ext( $file, $filename ) );
+	}
+
 	/**
 	 * Test file path validation
 	 *
 	 * @ticket 42016
-	 * @dataProvider data_test_validate_file()
+	 * @dataProvider data_validate_file
 	 *
 	 * @param string $file          File path.
 	 * @param array  $allowed_files List of allowed files.
@@ -1788,7 +1788,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 *     }
 	 * }
 	 */
-	public function data_test_validate_file() {
+	public function data_validate_file() {
 		return array(
 
 			// Allowed files:
@@ -1910,7 +1910,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	/**
 	 * Test stream URL validation.
 	 *
-	 * @dataProvider data_test_wp_is_stream
+	 * @dataProvider data_wp_is_stream
 	 *
 	 * @param string $path     The resource path or URL.
 	 * @param bool   $expected Expected result.
@@ -1933,7 +1933,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 *     }
 	 * }
 	 */
-	public function data_test_wp_is_stream() {
+	public function data_wp_is_stream() {
 		return array(
 			// Legitimate stream examples.
 			array( 'http://example.com', true ),
@@ -1954,7 +1954,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 * Test human_readable_duration().
 	 *
 	 * @ticket 39667
-	 * @dataProvider data_test_human_readable_duration
+	 * @dataProvider data_human_readable_duration
 	 *
 	 * @param string $input    Duration.
 	 * @param string $expected Expected human readable duration.
@@ -1964,7 +1964,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Dataprovider for test_duration_format().
+	 * Data provider for test_duration_format().
 	 *
 	 * @return array {
 	 *     @type array {
@@ -1973,7 +1973,7 @@ class Tests_Functions extends WP_UnitTestCase {
 	 *     }
 	 * }
 	 */
-	public function data_test_human_readable_duration() {
+	public function data_human_readable_duration() {
 		return array(
 			// Valid ii:ss cases.
 			array( '0:0', '0 minutes, 0 seconds' ),
@@ -2030,14 +2030,14 @@ class Tests_Functions extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 49404
-	 * @dataProvider data_test_wp_is_json_media_type
+	 * @dataProvider data_wp_is_json_media_type
 	 */
 	public function test_wp_is_json_media_type( $input, $expected ) {
 		$this->assertSame( $expected, wp_is_json_media_type( $input ) );
 	}
 
 
-	public function data_test_wp_is_json_media_type() {
+	public function data_wp_is_json_media_type() {
 		return array(
 			array( 'application/ld+json', true ),
 			array( 'application/ld+json; profile="https://www.w3.org/ns/activitystreams"', true ),
diff --git a/tests/functions/anonymization.php b/tests/functions/anonymization.php
index 3e0cea6fa7..a7849ddf46 100644
--- a/tests/functions/anonymization.php
+++ b/tests/functions/anonymization.php
@@ -5,12 +5,6 @@
  * @package WordPress\UnitTests
  *
  * @since 4.9.6
- */
-
-/**
- * Class Tests_Functions_Anonymization.
- *
- * @since 4.9.6
  *
  * @group functions.php
  * @group privacy
diff --git a/tests/functions/doEnclose.php b/tests/functions/doEnclose.php
index 5fe48b3554..5611878bd2 100644
--- a/tests/functions/doEnclose.php
+++ b/tests/functions/doEnclose.php
@@ -1,16 +1,11 @@
 <?php
+
 /**
  * Test cases for the `do_enclose()` function.
  *
  * @package WordPress\UnitTests
  *
  * @since 5.3.0
- */
-
-/**
- * Tests_Functions_DoEnclose class.
- *
- * @since 5.3.0
  *
  * @group functions.php
  * @group post
@@ -33,7 +28,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 *
 	 * @since 5.3.0
 	 *
-	 * @dataProvider data_test_do_enclose
+	 * @dataProvider data_do_enclose
 	 */
 	public function test_function_with_explicit_content_input( $content, $expected ) {
 		$post_id = self::factory()->post->create();
@@ -49,7 +44,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 *
 	 * @since 5.3.0
 	 *
-	 * @dataProvider data_test_do_enclose
+	 * @dataProvider data_do_enclose
 	 */
 	public function test_function_with_implicit_content_input( $content, $expected ) {
 		$post_id = self::factory()->post->create(
@@ -77,7 +72,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 *     }
 	 * }
 	 */
-	public function data_test_do_enclose() {
+	public function data_do_enclose() {
 		return array(
 			'null'                  => array(
 				'content'  => null,
@@ -149,7 +144,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 * @since 5.3.0
 	 */
 	public function test_function_should_delete_enclosed_link_when_no_longer_in_post_content() {
-		$data = $this->data_test_do_enclose();
+		$data = $this->data_do_enclose();
 
 		// Create a post with a single movie link.
 		$post_id = self::factory()->post->create(
@@ -183,7 +178,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 * @since 5.3.0
 	 */
 	public function test_function_should_support_post_object_input() {
-		$data = $this->data_test_do_enclose();
+		$data = $this->data_do_enclose();
 
 		$post_object = self::factory()->post->create_and_get(
 			array(
@@ -203,7 +198,7 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 	 * @since 5.3.0
 	 */
 	public function test_function_enclosure_links_should_be_filterable() {
-		$data = $this->data_test_do_enclose();
+		$data = $this->data_do_enclose();
 
 		$post_id = self::factory()->post->create(
 			array(
@@ -265,14 +260,14 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 		$fake_headers = array(
 			'mp4' => array(
 				'headers' => array(
-					'content-length' => 123,
-					'content-type'   => 'video/mp4',
+					'Content-Length' => 123,
+					'Content-Type'   => 'video/mp4',
 				),
 			),
 			'ogg' => array(
 				'headers' => array(
-					'content-length' => 321,
-					'content-type'   => 'audio/ogg',
+					'Content-Length' => 321,
+					'Content-Type'   => 'audio/ogg',
 				),
 			),
 		);
@@ -289,8 +284,8 @@ class Tests_Functions_DoEnclose extends WP_UnitTestCase {
 		// Fallback header.
 		return array(
 			'headers' => array(
-				'content-length' => 0,
-				'content-type'   => '',
+				'Content-Length' => 0,
+				'Content-Type'   => '',
 			),
 		);
 	}
diff --git a/tests/functions/getNonCachedIds.php b/tests/functions/getNonCachedIds.php
new file mode 100644
index 0000000000..d8df0e11a6
--- /dev/null
+++ b/tests/functions/getNonCachedIds.php
@@ -0,0 +1,103 @@
+<?php
+/**
+ * Test class for `_get_non_cached_ids()`.
+ *
+ * @package WordPress
+ *
+ * @group cache
+ *
+ * @covers ::_get_non_cached_ids
+ * @covers ::_validate_cache_id
+ */
+class Tests_Functions_GetNonCachedIds extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 57593
+	 */
+	public function test_uncached_valid_ids_should_be_unique() {
+		$object_id = 1;
+
+		$this->assertSame(
+			array( $object_id ),
+			_get_non_cached_ids( array( $object_id, $object_id, (string) $object_id ), 'fake-group' ),
+			'Duplicate object IDs should be removed.'
+		);
+	}
+
+	/**
+	 * @ticket 57593
+	 *
+	 * @dataProvider data_valid_ids_should_be_returned_as_integers
+	 *
+	 * @param mixed $object_id The object ID.
+	 */
+	public function test_valid_ids_should_be_returned_as_integers( $object_id ) {
+		$this->assertSame(
+			array( (int) $object_id ),
+			_get_non_cached_ids( array( $object_id ), 'fake-group' ),
+			'Object IDs should be returned as integers.'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_valid_ids_should_be_returned_as_integers() {
+		return array(
+			'(int) 1'    => array( 1 ),
+			'(string) 1' => array( '1' ),
+		);
+	}
+
+	/**
+	 * @ticket 57593
+	 */
+	public function test_mix_of_valid_and_invalid_ids_should_return_the_valid_ids_and_throw_a_notice() {
+		$object_id = 1;
+
+		$this->setExpectedIncorrectUsage( '_get_non_cached_ids' );
+		$this->assertSame(
+			array( $object_id ),
+			_get_non_cached_ids( array( $object_id, null ), 'fake-group' ),
+			'Valid object IDs should be returned.'
+		);
+	}
+
+	/**
+	 * @ticket 57593
+	 *
+	 * @dataProvider data_invalid_cache_ids_should_throw_a_notice
+	 *
+	 * @param mixed $object_id The object ID.
+	 */
+	public function test_invalid_cache_ids_should_throw_a_notice( $object_id ) {
+		$this->setExpectedIncorrectUsage( '_get_non_cached_ids' );
+		$this->assertSame(
+			array(),
+			_get_non_cached_ids( array( $object_id ), 'fake-group' ),
+			'Invalid object IDs should be dropped.'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_invalid_cache_ids_should_throw_a_notice() {
+		return array(
+			'null'         => array( null ),
+			'false'        => array( false ),
+			'true'         => array( true ),
+			'(float) 1.0'  => array( 1.0 ),
+			'(string) 5.0' => array( '5.0' ),
+			'string'       => array( 'johnny cache' ),
+			'empty string' => array( '' ),
+			'array'        => array( array( 1 ) ),
+			'empty array'  => array( array() ),
+			'stdClass'     => array( new stdClass ),
+		);
+	}
+}
diff --git a/tests/functions/getStatusHeaderDesc.php b/tests/functions/getStatusHeaderDesc.php
index a7b253fcdd..c3826c5dc8 100644
--- a/tests/functions/getStatusHeaderDesc.php
+++ b/tests/functions/getStatusHeaderDesc.php
@@ -11,7 +11,7 @@
 class Tests_Functions_GetStatusHeaderDesc extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider _status_strings
+	 * @dataProvider data_get_status_header_desc
 	 *
 	 * @param int    $code     HTTP status code.
 	 * @param string $expected Status description.
@@ -25,7 +25,7 @@ class Tests_Functions_GetStatusHeaderDesc extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function _status_strings() {
+	public function data_get_status_header_desc() {
 		return array(
 			array( 200, 'OK' ),
 			array( 301, 'Moved Permanently' ),
diff --git a/tests/functions/isNewDay.php b/tests/functions/isNewDay.php
index 3201717fe0..f852c8908f 100644
--- a/tests/functions/isNewDay.php
+++ b/tests/functions/isNewDay.php
@@ -11,7 +11,7 @@ class Tests_Functions_IsNewDate extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 46627
-	 * @dataProvider _data_is_new_date
+	 * @dataProvider data_is_new_date
 	 *
 	 * @param string $currentday_string  The day of the current post in the loop.
 	 * @param string $previousday_string The day of the previous post in the loop.
@@ -26,7 +26,7 @@ class Tests_Functions_IsNewDate extends WP_UnitTestCase {
 		$this->assertSame( $expected, is_new_day() );
 	}
 
-	public function _data_is_new_date() {
+	public function data_is_new_date() {
 		return array(
 			array( '21.05.19', '21.05.19', 0 ),
 			array( '21.05.19', '20.05.19', 1 ),
diff --git a/tests/functions/removeQueryArg.php b/tests/functions/removeQueryArg.php
index b8130abe8d..8d05a6c230 100644
--- a/tests/functions/removeQueryArg.php
+++ b/tests/functions/removeQueryArg.php
@@ -7,7 +7,7 @@
 class Tests_Functions_RemoveQueryArg extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider remove_query_arg_provider
+	 * @dataProvider data_remove_query_arg
 	 */
 	public function test_remove_query_arg( $keys_to_remove, $url, $expected ) {
 		$actual = remove_query_arg( $keys_to_remove, $url );
@@ -16,7 +16,7 @@ class Tests_Functions_RemoveQueryArg extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
-	public function remove_query_arg_provider() {
+	public function data_remove_query_arg() {
 		return array(
 			array( 'foo', 'edit.php?foo=test1&baz=test1', 'edit.php?baz=test1' ),
 			array( array( 'foo' ), 'edit.php?foo=test2&baz=test2', 'edit.php?baz=test2' ),
diff --git a/tests/functions/sizeFormat.php b/tests/functions/sizeFormat.php
index 72c383ff95..bed09d15aa 100644
--- a/tests/functions/sizeFormat.php
+++ b/tests/functions/sizeFormat.php
@@ -12,7 +12,7 @@
  */
 class Tests_Functions_SizeFormat extends WP_UnitTestCase {
 
-	public function _data_size_format() {
+	public function data_size_format() {
 		return array(
 			// Invalid values.
 			array( array(), 0, false ),
@@ -72,7 +72,7 @@ class Tests_Functions_SizeFormat extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider _data_size_format
+	 * @dataProvider data_size_format
 	 *
 	 * @param $bytes
 	 * @param $decimals
diff --git a/tests/functions/wpCheckFiletype.php b/tests/functions/wpCheckFiletype.php
new file mode 100644
index 0000000000..ad947c628b
--- /dev/null
+++ b/tests/functions/wpCheckFiletype.php
@@ -0,0 +1,111 @@
+<?php
+
+/**
+ * Tests for wp_check_filetype().
+ *
+ * @group functions.php
+ * @group upload
+ *
+ * @covers ::wp_check_filetype
+ */
+class Tests_Functions_WpCheckFiletype extends WP_UnitTestCase {
+
+	/**
+	 * Tests that wp_check_filetype() returns the correct extension and MIME type.
+	 *
+	 * @ticket 57151
+	 *
+	 * @dataProvider data_wp_check_filetype
+	 *
+	 * @param string     $filename   The filename to check.
+	 * @param array|null $mimes      An array of MIME types, or null.
+	 * @param array      $expected   An array containing the expected extension and MIME type.
+	 */
+	public function test_wp_check_filetype( $filename, $mimes, $expected ) {
+		$this->assertSame( $expected, wp_check_filetype( $filename, $mimes ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return[]
+	 */
+	public function data_wp_check_filetype() {
+		return array(
+			'.jpg filename and default allowed'       => array(
+				'filename' => 'canola.jpg',
+				'mimes'    => null,
+				'expected' => array(
+					'ext'  => 'jpg',
+					'type' => 'image/jpeg',
+				),
+			),
+			'.jpg filename and jpg|jpeg|jpe'          => array(
+				'filename' => 'canola.jpg',
+				'mimes'    => array(
+					'jpg|jpeg|jpe' => 'image/jpeg',
+					'gif'          => 'image/gif',
+				),
+				'expected' => array(
+					'ext'  => 'jpg',
+					'type' => 'image/jpeg',
+				),
+			),
+			'.jpeg filename and jpg|jpeg|jpe'         => array(
+				'filename' => 'canola.jpeg',
+				'mimes'    => array(
+					'jpg|jpeg|jpe' => 'image/jpeg',
+					'gif'          => 'image/gif',
+				),
+				'expected' => array(
+					'ext'  => 'jpeg',
+					'type' => 'image/jpeg',
+				),
+			),
+			'.jpe filename and jpg|jpeg|jpe'          => array(
+				'filename' => 'canola.jpe',
+				'mimes'    => array(
+					'jpg|jpeg|jpe' => 'image/jpeg',
+					'gif'          => 'image/gif',
+				),
+				'expected' => array(
+					'ext'  => 'jpe',
+					'type' => 'image/jpeg',
+				),
+			),
+			'uppercase filename and jpg|jpeg|jpe'     => array(
+				'filename' => 'canola.JPG',
+				'mimes'    => array(
+					'jpg|jpeg|jpe' => 'image/jpeg',
+					'gif'          => 'image/gif',
+				),
+				'expected' => array(
+					'ext'  => 'JPG',
+					'type' => 'image/jpeg',
+				),
+			),
+			'.XXX filename and no matching MIME type' => array(
+				'filename' => 'canola.XXX',
+				'mimes'    => array(
+					'jpg|jpeg|jpe' => 'image/jpeg',
+					'gif'          => 'image/gif',
+				),
+				'expected' => array(
+					'ext'  => false,
+					'type' => false,
+				),
+			),
+			'.jpg filename but only gif allowed'      => array(
+				'filename' => 'canola.jpg',
+				'mimes'    => array(
+					'gif' => 'image/gif',
+				),
+				'expected' => array(
+					'ext'  => false,
+					'type' => false,
+				),
+			),
+
+		);
+	}
+}
diff --git a/tests/functions/wpListFilter.php b/tests/functions/wpListFilter.php
index 7b7f54d2d9..bc8acdc63a 100644
--- a/tests/functions/wpListFilter.php
+++ b/tests/functions/wpListFilter.php
@@ -9,7 +9,7 @@
 class Tests_Functions_wpListFilter extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider data_test_wp_list_filter
+	 * @dataProvider data_wp_list_filter
 	 *
 	 * @param array  $input_list An array of objects to filter.
 	 * @param array  $args       An array of key => value arguments to match
@@ -21,7 +21,7 @@ class Tests_Functions_wpListFilter extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, wp_list_filter( $input_list, $args, $operator ) );
 	}
 
-	public function data_test_wp_list_filter() {
+	public function data_wp_list_filter() {
 		return array(
 			'string instead of array'  => array(
 				'foo',
diff --git a/tests/functions/wpListPluck.php b/tests/functions/wpListPluck.php
index 63b66670c9..cb3c4bfe27 100644
--- a/tests/functions/wpListPluck.php
+++ b/tests/functions/wpListPluck.php
@@ -11,7 +11,18 @@ class Tests_Functions_wpListPluck extends WP_UnitTestCase {
 	public $array_list  = array();
 
 	public function set_up() {
-		parent::set_up();
+		/*
+		 * This method deliberately does not call parent::set_up(). Why?
+		 *
+		 * The call stack for WP_UnitTestCase_Base::set_up() includes a call to
+		 * WP_List_Util::pluck(), which creates an inaccurate coverage report
+		 * for this method.
+		 *
+		 * To ensure that deprecation and incorrect usage notices continue to be
+		 * detectable, this method uses WP_UnitTestCase_Base::expectDeprecated().
+		 */
+		$this->expectDeprecated();
+
 		$this->array_list['foo'] = array(
 			'name'   => 'foo',
 			'id'     => 'f',
@@ -193,7 +204,7 @@ class Tests_Functions_wpListPluck extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_test_wp_list_pluck
+	 * @dataProvider data_wp_list_pluck
 	 *
 	 * @param array      $input_list List of objects or arrays.
 	 * @param int|string $field      Field from the object to place instead of the entire object
@@ -204,7 +215,7 @@ class Tests_Functions_wpListPluck extends WP_UnitTestCase {
 		$this->assertSameSetsWithIndex( $expected, wp_list_pluck( $input_list, $field, $index_key ) );
 	}
 
-	public function data_test_wp_list_pluck() {
+	public function data_wp_list_pluck() {
 		return array(
 			'arrays'                         => array(
 				array(
diff --git a/tests/functions/wpListSort.php b/tests/functions/wpListSort.php
index a77354d70e..63c495dd84 100644
--- a/tests/functions/wpListSort.php
+++ b/tests/functions/wpListSort.php
@@ -9,7 +9,7 @@
 class Tests_Functions_wpListSort extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider data_test_wp_list_sort
+	 * @dataProvider data_wp_list_sort
 	 *
 	 * @param string|array $orderby Either the field name to order by or an array
 	 *                              of multiple orderby fields as `$orderby => $order`.
@@ -19,7 +19,7 @@ class Tests_Functions_wpListSort extends WP_UnitTestCase {
 		$this->assertSame( $expected, wp_list_sort( $input_list, $orderby, $order ) );
 	}
 
-	public function data_test_wp_list_sort() {
+	public function data_wp_list_sort() {
 		return array(
 			'single orderby ascending'        => array(
 				array(
@@ -334,7 +334,7 @@ class Tests_Functions_wpListSort extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider data_test_wp_list_sort_preserve_keys
+	 * @dataProvider data_wp_list_sort_preserve_keys
 	 *
 	 * @param string|array $orderby Either the field name to order by or an array
 	 *                              of multiple orderby fields as `$orderby => $order`.
@@ -344,7 +344,7 @@ class Tests_Functions_wpListSort extends WP_UnitTestCase {
 		$this->assertSame( $expected, wp_list_sort( $input_list, $orderby, $order, true ) );
 	}
 
-	public function data_test_wp_list_sort_preserve_keys() {
+	public function data_wp_list_sort_preserve_keys() {
 		return array(
 			'single orderby ascending'        => array(
 				array(
diff --git a/tests/functions/wpListUtil.php b/tests/functions/wpListUtil.php
index f455c94936..f40771681e 100644
--- a/tests/functions/wpListUtil.php
+++ b/tests/functions/wpListUtil.php
@@ -85,7 +85,7 @@ class Tests_Functions_wpListUtil extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Data provider for test_wp_list_util_pluck_simple().
+	 * Data provider for test_wp_list_util_pluck().
 	 *
 	 * @return array[]
 	 */
@@ -108,6 +108,65 @@ class Tests_Functions_wpListUtil extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Tests that wp_list_pluck() throws _doing_it_wrong() with invalid input.
+	 *
+	 * @ticket 56650
+	 *
+	 * @dataProvider data_wp_list_pluck_should_throw_doing_it_wrong_with_invalid_input
+	 *
+	 * @covers WP_List_Util::pluck
+	 * @covers ::wp_list_pluck
+	 *
+	 * @expectedIncorrectUsage WP_List_Util::pluck
+	 *
+	 * @param array $input An invalid input array.
+	 */
+	public function test_wp_list_pluck_should_throw_doing_it_wrong_with_invalid_input( $input ) {
+		$this->assertSame( array(), wp_list_pluck( $input, 'a_field' ) );
+	}
+
+	/**
+	 * Tests that wp_list_pluck() throws _doing_it_wrong() with an index key and invalid input.
+	 *
+	 * @ticket 56650
+	 *
+	 * @dataProvider data_wp_list_pluck_should_throw_doing_it_wrong_with_invalid_input
+	 *
+	 * @covers WP_List_Util::pluck
+	 * @covers ::wp_list_pluck
+	 *
+	 * @expectedIncorrectUsage WP_List_Util::pluck
+	 *
+	 * @param array $input An invalid input array.
+	 */
+	public function test_wp_list_pluck_should_throw_doing_it_wrong_with_index_key_and_invalid_input( $input ) {
+		$this->assertSame( array(), wp_list_pluck( $input, 'a_field', 'an_index_key' ) );
+	}
+
+	/**
+	 * Data provider that provides invalid input arrays.
+	 *
+	 * @return array
+	 */
+	public function data_wp_list_pluck_should_throw_doing_it_wrong_with_invalid_input() {
+		return array(
+			'int[] 0'                   => array( array( 0 ) ),
+			'int[] 1'                   => array( array( 1 ) ),
+			'int[] -1'                  => array( array( -1 ) ),
+			'float[] 0.0'               => array( array( 0.0 ) ),
+			'float[] 1.0'               => array( array( 1.0 ) ),
+			'float[] -1.0'              => array( array( -1.0 ) ),
+			'string[] and empty string' => array( array( '' ) ),
+			'string[] and "0"'          => array( array( '0' ) ),
+			'string[] and "1"'          => array( array( '1' ) ),
+			'string[] and "-1"'         => array( array( '-1' ) ),
+			'array and null'            => array( array( null ) ),
+			'array and false'           => array( array( false ) ),
+			'array and true'            => array( array( true ) ),
+		);
+	}
+
 	/**
 	 * @ticket 55300
 	 *
diff --git a/tests/functions/wpRefererField.php b/tests/functions/wpRefererField.php
index ca72d078f0..227fee71f4 100644
--- a/tests/functions/wpRefererField.php
+++ b/tests/functions/wpRefererField.php
@@ -30,26 +30,26 @@ class Tests_Functions_wpRefererField extends WP_UnitTestCase {
 	}
 
 	/**
-	 * Tests that the echo argument is respected.
+	 * Tests that the display argument is respected.
 	 *
 	 * @ticket 54106
 	 *
-	 * @dataProvider data_wp_referer_field_should_respect_echo_arg
+	 * @dataProvider data_wp_referer_field_should_respect_display_arg
 	 *
-	 * @param mixed $echo Whether to echo or return the referer field.
+	 * @param mixed $display Whether to echo or return the referer field.
 	 */
-	public function test_wp_referer_field_should_respect_echo_arg( $echo ) {
-		$actual = $echo ? get_echo( 'wp_referer_field' ) : wp_referer_field( false );
+	public function test_wp_referer_field_should_respect_display_arg( $display ) {
+		$actual = $display ? get_echo( 'wp_referer_field' ) : wp_referer_field( false );
 
 		$this->assertSame( '<input type="hidden" name="_wp_http_referer" value="" />', $actual );
 	}
 
 	/**
-	 * Data provider for test_wp_referer_field_should_respect_echo_arg().
+	 * Data provider for test_wp_referer_field_should_respect_display_arg().
 	 *
 	 * @return array
 	 */
-	public function data_wp_referer_field_should_respect_echo_arg() {
+	public function data_wp_referer_field_should_respect_display_arg() {
 		return array(
 			'true'         => array( true ),
 			'(int) 1'      => array( 1 ),
diff --git a/tests/html-api/wpHtmlTagProcessor-bookmark.php b/tests/html-api/wpHtmlTagProcessor-bookmark.php
new file mode 100644
index 0000000000..1bbbe02021
--- /dev/null
+++ b/tests/html-api/wpHtmlTagProcessor-bookmark.php
@@ -0,0 +1,438 @@
+<?php
+/**
+ * Unit tests covering WP_HTML_Tag_Processor bookmark functionality.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ */
+
+/**
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Tag_Processor
+ */
+class Tests_HtmlApi_wpHtmlTagProcessor_Bookmark extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_bookmark
+	 */
+	public function test_set_bookmark() {
+		$p = new WP_HTML_Tag_Processor( '<ul><li>One</li><li>Two</li><li>Three</li></ul>' );
+		$p->next_tag( 'li' );
+		$this->assertTrue( $p->set_bookmark( 'first li' ), 'Could not allocate a "first li" bookmark' );
+		$p->next_tag( 'li' );
+		$this->assertTrue( $p->set_bookmark( 'second li' ), 'Could not allocate a "second li" bookmark' );
+		$this->assertTrue( $p->set_bookmark( 'first li' ), 'Could not move the "first li" bookmark' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::release_bookmark
+	 */
+	public function test_release_bookmark() {
+		$p = new WP_HTML_Tag_Processor( '<ul><li>One</li><li>Two</li><li>Three</li></ul>' );
+		$p->next_tag( 'li' );
+		$this->assertFalse( $p->release_bookmark( 'first li' ), 'Released a non-existing bookmark' );
+		$p->set_bookmark( 'first li' );
+		$this->assertTrue( $p->release_bookmark( 'first li' ), 'Could not release a bookmark' );
+	}
+
+	/**
+	 * @ticket 57788
+	 *
+	 * @covers WP_HTML_Tag_Processor::has_bookmark
+	 */
+	public function test_has_bookmark_returns_false_if_bookmark_does_not_exist() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+		$this->assertFalse( $p->has_bookmark( 'my-bookmark' ) );
+	}
+
+	/**
+	 * @ticket 57788
+	 *
+	 * @covers WP_HTML_Tag_Processor::has_bookmark
+	 */
+	public function test_has_bookmark_returns_true_if_bookmark_exists() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+		$p->next_tag();
+		$p->set_bookmark( 'my-bookmark' );
+		$this->assertTrue( $p->has_bookmark( 'my-bookmark' ) );
+	}
+
+	/**
+	 * @ticket 57788
+	 *
+	 * @covers WP_HTML_Tag_Processor::has_bookmark
+	 */
+	public function test_has_bookmark_returns_false_if_bookmark_has_been_released() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+		$p->next_tag();
+		$p->set_bookmark( 'my-bookmark' );
+		$p->release_bookmark( 'my-bookmark' );
+		$this->assertFalse( $p->has_bookmark( 'my-bookmark' ) );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_seek() {
+		$p = new WP_HTML_Tag_Processor( '<ul><li>One</li><li>Two</li><li>Three</li></ul>' );
+		$p->next_tag( 'li' );
+		$p->set_bookmark( 'first li' );
+
+		$p->next_tag( 'li' );
+		$p->set_attribute( 'foo-2', 'bar-2' );
+
+		$p->seek( 'first li' );
+		$p->set_attribute( 'foo-1', 'bar-1' );
+
+		$this->assertSame(
+			'<ul><li foo-1="bar-1">One</li><li foo-2="bar-2">Two</li><li>Three</li></ul>',
+			$p->get_updated_html(),
+			'Did not seek to the intended bookmark locations'
+		);
+	}
+
+	/**
+	 * @ticket 57787
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_seeks_to_tag_closer_bookmark() {
+		$p = new WP_HTML_Tag_Processor( '<div>First</div><span>Second</span>' );
+		$p->next_tag( array( 'tag_closers' => 'visit' ) );
+		$p->set_bookmark( 'first' );
+		$p->next_tag( array( 'tag_closers' => 'visit' ) );
+		$p->set_bookmark( 'second' );
+
+		$p->seek( 'first' );
+		$p->seek( 'second' );
+
+		$this->assertSame(
+			'DIV',
+			$p->get_tag(),
+			'Did not seek to the intended bookmark location'
+		);
+	}
+
+	/**
+	 * WP_HTML_Tag_Processor used to test for the diffs affecting
+	 * the adjusted bookmark position while simultaneously adjusting
+	 * the bookmark in question. As a result, updating the bookmarks
+	 * of a next tag while removing two subsequent attributes in
+	 * a previous tag unfolded like this:
+	 *
+	 * 1. Check if the first removed attribute is before the bookmark:
+	 *
+	 * <button twenty_one_characters 7_chars></button><button></button>
+	 *         ^-------------------^                  ^
+	 *           diff applied here           the bookmark is here
+	 *
+	 *    (Yes it is)
+	 *
+	 * 2. Move the bookmark to the left by the attribute length:
+	 *
+	 * <button twenty_one_characters 7_chars></button><button></button>
+	 *                           ^
+	 *                   the bookmark is here
+	 *
+	 * 3. Check if the second removed attribute is before the bookmark:
+	 *
+	 * <button twenty_one_characters 7_chars></button><button></button>
+	 *                           ^   ^-----^
+	 *                    bookmark    diff
+	 *
+	 *    This time, it isn't!
+	 *
+	 * The fix in the WP_HTML_Tag_Processor involves doing all the checks
+	 * before moving the bookmark. This test is here to guard us from
+	 * the erroneous behavior accidentally returning one day.
+	 *
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 * @covers WP_HTML_Tag_Processor::set_bookmark
+	 */
+	public function test_removing_long_attributes_doesnt_break_seek() {
+		$input = <<<HTML
+		<button twenty_one_characters 7_chars></button><button></button>
+HTML;
+		$p     = new WP_HTML_Tag_Processor( $input );
+		$p->next_tag( 'button' );
+		$p->set_bookmark( 'first' );
+		$p->next_tag( 'button' );
+		$p->set_bookmark( 'second' );
+
+		$this->assertTrue(
+			$p->seek( 'first' ),
+			'Seek() to the first button has failed'
+		);
+		$p->remove_attribute( 'twenty_one_characters' );
+		$p->remove_attribute( '7_chars' );
+
+		$this->assertTrue(
+			$p->seek( 'second' ),
+			'Seek() to the second button has failed'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 * @covers WP_HTML_Tag_Processor::set_bookmark
+	 */
+	public function test_bookmarks_complex_use_case() {
+		$input           = <<<HTML
+<div selected class="merge-message" checked>
+	<div class="select-menu d-inline-block">
+		<div checked class="BtnGroup MixedCaseHTML position-relative" />
+		<div checked class="BtnGroup MixedCaseHTML position-relative">
+			<button type="button" class="merge-box-button btn-group-merge rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Merge pull request
+			</button>
+
+			<button type="button" class="merge-box-button btn-group-squash rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Squash and merge
+			</button>
+
+			<button type="button" class="merge-box-button btn-group-rebase rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Rebase and merge
+			</button>
+
+			<button aria-label="Select merge method" disabled="disabled" type="button" data-view-component="true" class="select-menu-button btn BtnGroup-item"></button>
+		</div>
+	</div>
+</div>
+HTML;
+		$expected_output = <<<HTML
+<div selected class="merge-message" checked>
+	<div class="select-menu d-inline-block">
+		<div  class="BtnGroup MixedCaseHTML position-relative" />
+		<div checked class="BtnGroup MixedCaseHTML position-relative">
+			<button type="submit" class="merge-box-button btn-group-merge rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Merge pull request
+			</button>
+
+			<button  class="hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Squash and merge
+			</button>
+
+			<button id="rebase-and-merge"     disabled="">
+			  Rebase and merge
+			</button>
+
+			<button id="last-button"     ></button>
+		</div>
+	</div>
+</div>
+HTML;
+		$p               = new WP_HTML_Tag_Processor( $input );
+		$p->next_tag( 'div' );
+		$p->next_tag( 'div' );
+		$p->next_tag( 'div' );
+		$p->set_bookmark( 'first div' );
+		$p->next_tag( 'button' );
+		$p->set_bookmark( 'first button' );
+		$p->next_tag( 'button' );
+		$p->set_bookmark( 'second button' );
+		$p->next_tag( 'button' );
+		$p->set_bookmark( 'third button' );
+		$p->next_tag( 'button' );
+		$p->set_bookmark( 'fourth button' );
+
+		$p->seek( 'first button' );
+		$p->set_attribute( 'type', 'submit' );
+
+		$this->assertTrue(
+			$p->seek( 'third button' ),
+			'Seek() to the third button failed'
+		);
+		$p->remove_attribute( 'class' );
+		$p->remove_attribute( 'type' );
+		$p->remove_attribute( 'aria-expanded' );
+		$p->set_attribute( 'id', 'rebase-and-merge' );
+		$p->remove_attribute( 'data-details-container' );
+
+		$this->assertTrue(
+			$p->seek( 'first div' ),
+			'Seek() to the first div failed'
+		);
+		$p->set_attribute( 'checked', false );
+
+		$this->assertTrue(
+			$p->seek( 'fourth button' ),
+			'Seek() to the fourth button failed'
+		);
+		$p->set_attribute( 'id', 'last-button' );
+		$p->remove_attribute( 'class' );
+		$p->remove_attribute( 'type' );
+		$p->remove_attribute( 'checked' );
+		$p->remove_attribute( 'aria-label' );
+		$p->remove_attribute( 'disabled' );
+		$p->remove_attribute( 'data-view-component' );
+
+		$this->assertTrue(
+			$p->seek( 'second button' ),
+			'Seek() to the second button failed'
+		);
+		$p->remove_attribute( 'type' );
+		$p->set_attribute( 'class', 'hx_create-pr-button' );
+
+		$this->assertSame(
+			$expected_output,
+			$p->get_updated_html(),
+			'Performing several attribute updates on different tags does not produce the expected HTML snippet'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_updates_bookmark_for_additions_after_both_sides() {
+		$p = new WP_HTML_Tag_Processor( '<div>First</div><div>Second</div>' );
+		$p->next_tag();
+		$p->set_bookmark( 'first' );
+		$p->next_tag();
+		$p->add_class( 'second' );
+
+		$p->seek( 'first' );
+		$p->add_class( 'first' );
+
+		$this->assertSame(
+			'<div class="first">First</div><div class="second">Second</div>',
+			$p->get_updated_html(),
+			'The bookmark was updated incorrectly in response to HTML markup updates'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_updates_bookmark_for_additions_before_both_sides() {
+		$p = new WP_HTML_Tag_Processor( '<div>First</div><div>Second</div>' );
+		$p->next_tag();
+		$p->set_bookmark( 'first' );
+		$p->next_tag();
+		$p->set_bookmark( 'second' );
+
+		$p->seek( 'first' );
+		$p->add_class( 'first' );
+
+		$p->seek( 'second' );
+		$p->add_class( 'second' );
+
+		$this->assertSame(
+			'<div class="first">First</div><div class="second">Second</div>',
+			$p->get_updated_html(),
+			'The bookmark was updated incorrectly in response to HTML markup updates'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_updates_bookmark_for_deletions_after_both_sides() {
+		$p = new WP_HTML_Tag_Processor( '<div>First</div><div disabled>Second</div>' );
+		$p->next_tag();
+		$p->set_bookmark( 'first' );
+		$p->next_tag();
+		$p->remove_attribute( 'disabled' );
+
+		$p->seek( 'first' );
+		$p->set_attribute( 'untouched', true );
+
+		$this->assertSame(
+			/*
+			 * It shouldn't be necessary to assert the extra space after the tag
+			 * following the attribute removal, but doing so makes the test easier
+			 * to see than it would be if parsing the output HTML for proper
+			 * validation. If the Tag Processor changes so that this space no longer
+			 * appears then this test should be updated to reflect that. The space
+			 * is not required.
+			 */
+			'<div untouched>First</div><div >Second</div>',
+			$p->get_updated_html(),
+			'The bookmark was incorrectly in response to HTML markup updates'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_updates_bookmark_for_deletions_before_both_sides() {
+		$p = new WP_HTML_Tag_Processor( '<div disabled>First</div><div>Second</div>' );
+		$p->next_tag();
+		$p->set_bookmark( 'first' );
+		$p->next_tag();
+		$p->set_bookmark( 'second' );
+
+		$p->seek( 'first' );
+		$p->remove_attribute( 'disabled' );
+
+		$p->seek( 'second' );
+		$p->set_attribute( 'safe', true );
+
+		$this->assertSame(
+			/*
+			 * It shouldn't be necessary to assert the extra space after the tag
+			 * following the attribute removal, but doing so makes the test easier
+			 * to see than it would be if parsing the output HTML for proper
+			 * validation. If the Tag Processor changes so that this space no longer
+			 * appears then this test should be updated to reflect that. The space
+			 * is not required.
+			 */
+			'<div >First</div><div safe>Second</div>',
+			$p->get_updated_html(),
+			'The bookmark was updated incorrectly in response to HTML markup updates'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_bookmark
+	 */
+	public function test_limits_the_number_of_bookmarks() {
+		$p = new WP_HTML_Tag_Processor( '<ul><li>One</li><li>Two</li><li>Three</li></ul>' );
+		$p->next_tag( 'li' );
+
+		for ( $i = 0; $i < WP_HTML_Tag_Processor::MAX_BOOKMARKS; $i++ ) {
+			$this->assertTrue( $p->set_bookmark( "bookmark $i" ), "Could not allocate the bookmark #$i" );
+		}
+
+		$this->setExpectedIncorrectUsage( 'WP_HTML_Tag_Processor::set_bookmark' );
+		$this->assertFalse( $p->set_bookmark( 'final bookmark' ), "Allocated $i bookmarks, which is one above the limit" );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::seek
+	 */
+	public function test_limits_the_number_of_seek_calls() {
+		$p = new WP_HTML_Tag_Processor( '<ul><li>One</li><li>Two</li><li>Three</li></ul>' );
+		$p->next_tag( 'li' );
+		$p->set_bookmark( 'bookmark' );
+
+		for ( $i = 0; $i < WP_HTML_Tag_Processor::MAX_SEEK_OPS; $i++ ) {
+			$this->assertTrue( $p->seek( 'bookmark' ), 'Could not seek to the "bookmark"' );
+		}
+
+		$this->setExpectedIncorrectUsage( 'WP_HTML_Tag_Processor::seek' );
+		$this->assertFalse( $p->seek( 'bookmark' ), "$i-th seek() to the bookmark succeeded, even though it should exceed the allowed limit" );
+	}
+}
diff --git a/tests/html-api/wpHtmlTagProcessor.php b/tests/html-api/wpHtmlTagProcessor.php
new file mode 100644
index 0000000000..6b0c263c5d
--- /dev/null
+++ b/tests/html-api/wpHtmlTagProcessor.php
@@ -0,0 +1,2106 @@
+<?php
+/**
+ * Unit tests covering WP_HTML_Tag_Processor functionality.
+ *
+ * @package WordPress
+ * @subpackage HTML-API
+ */
+
+/**
+ * @group html-api
+ *
+ * @coversDefaultClass WP_HTML_Tag_Processor
+ */
+class Tests_HtmlApi_wpHtmlTagProcessor extends WP_UnitTestCase {
+	const HTML_SIMPLE       = '<div id="first"><span id="second">Text</span></div>';
+	const HTML_WITH_CLASSES = '<div class="main with-border" id="first"><span class="not-main bold with-border" id="second">Text</span></div>';
+	const HTML_MALFORMED    = '<div><span class="d-md-none" Notifications</span><span class="d-none d-md-inline">Back to notifications</span></div>';
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_tag
+	 */
+	public function test_get_tag_returns_null_before_finding_tags() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+
+		$this->assertNull( $p->get_tag(), 'Calling get_tag() without selecting a tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_tag
+	 */
+	public function test_get_tag_returns_null_when_not_in_open_tag() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+
+		$this->assertFalse( $p->next_tag( 'p' ), 'Querying a non-existing tag did not return false' );
+		$this->assertNull( $p->get_tag(), 'Accessing a non-existing tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_tag
+	 */
+	public function test_get_tag_returns_open_tag_name() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+
+		$this->assertTrue( $p->next_tag( 'div' ), 'Querying an existing tag did not return true' );
+		$this->assertSame( 'DIV', $p->get_tag(), 'Accessing an existing tag name did not return "div"' );
+	}
+
+	/**
+	 * @ticket 58009
+	 *
+	 * @covers WP_HTML_Tag_Processor::has_self_closing_flag
+	 *
+	 * @dataProvider data_has_self_closing_flag
+	 *
+	 * @param string $html Input HTML whose first tag might contain the self-closing flag `/`.
+	 * @param bool $flag_is_set Whether the input HTML's first tag contains the self-closing flag.
+	 */
+	public function test_has_self_closing_flag_matches_input_html( $html, $flag_is_set ) {
+		$p = new WP_HTML_Tag_Processor( $html );
+		$p->next_tag( array( 'tag_closers' => 'visit' ) );
+
+		if ( $flag_is_set ) {
+			$this->assertTrue( $p->has_self_closing_flag(), 'Did not find the self-closing tag when it was present.' );
+		} else {
+			$this->assertFalse( $p->has_self_closing_flag(), 'Found the self-closing tag when it was absent.' );
+		}
+	}
+
+	/**
+	 * Data provider. HTML tags which might have a self-closing flag, and an indicator if they do.
+	 *
+	 * @return array[]
+	 */
+	public function data_has_self_closing_flag() {
+		return array(
+			// These should not have a self-closer, and will leave an element un-closed if it's assumed they are self-closing.
+			'Self-closing flag on non-void HTML element' => array( '<div />', true ),
+			'No self-closing flag on non-void HTML element' => array( '<div>', false ),
+			// These should not have a self-closer, but are benign when used because the elements are void.
+			'Self-closing flag on void HTML element'     => array( '<img />', true ),
+			'No self-closing flag on void HTML element'  => array( '<img>', false ),
+			'Self-closing flag on void HTML element without spacing' => array( '<img/>', true ),
+			// These should not have a self-closer, but as part of a tag closer they are entirely ignored.
+			'Self-closing flag on tag closer'            => array( '</textarea />', true ),
+			'No self-closing flag on tag closer'         => array( '</textarea>', false ),
+			// These can and should have self-closers, and will leave an element un-closed if it's assumed they aren't self-closing.
+			'Self-closing flag on a foreign element'     => array( '<circle />', true ),
+			'No self-closing flag on a foreign element'  => array( '<circle>', false ),
+			// These involve syntax peculiarities.
+			'Self-closing flag after extra spaces'       => array( '<div      />', true ),
+			'Self-closing flag after attribute'          => array( '<div id=test/>', true ),
+			'Self-closing flag after quoted attribute'   => array( '<div id="test"/>', true ),
+			'Self-closing flag after boolean attribute'  => array( '<div enabled/>', true ),
+			'Boolean attribute that looks like a self-closer' => array( '<div / >', false ),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_null_before_finding_tags() {
+		$p = new WP_HTML_Tag_Processor( '<div class="test">Test</div>' );
+
+		$this->assertNull( $p->get_attribute( 'class' ), 'Accessing an attribute without selecting a tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_null_when_not_in_open_tag() {
+		$p = new WP_HTML_Tag_Processor( '<div class="test">Test</div>' );
+
+		$this->assertFalse( $p->next_tag( 'p' ), 'Querying a non-existing tag did not return false' );
+		$this->assertNull( $p->get_attribute( 'class' ), 'Accessing an attribute of a non-existing tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_null_when_in_closing_tag() {
+		$p = new WP_HTML_Tag_Processor( '<div class="test">Test</div>' );
+
+		$this->assertTrue( $p->next_tag( 'div' ), 'Querying an existing tag did not return true' );
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Querying an existing closing tag did not return true' );
+		$this->assertNull( $p->get_attribute( 'class' ), 'Accessing an attribute of a closing tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_null_when_attribute_missing() {
+		$p = new WP_HTML_Tag_Processor( '<div class="test">Test</div>' );
+
+		$this->assertTrue( $p->next_tag( 'div' ), 'Querying an existing tag did not return true' );
+		$this->assertNull( $p->get_attribute( 'test-id' ), 'Accessing a non-existing attribute did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_attribute_value() {
+		$p = new WP_HTML_Tag_Processor( '<div class="test">Test</div>' );
+
+		$this->assertTrue( $p->next_tag( 'div' ), 'Querying an existing tag did not return true' );
+		$this->assertSame( 'test', $p->get_attribute( 'class' ), 'Accessing a class="test" attribute value did not return "test"' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_true_for_boolean_attribute() {
+		$p = new WP_HTML_Tag_Processor( '<div enabled class="test">Test</div>' );
+
+		$this->assertTrue( $p->next_tag( array( 'class_name' => 'test' ) ), 'Querying an existing tag did not return true' );
+		$this->assertTrue( $p->get_attribute( 'enabled' ), 'Accessing a boolean "enabled" attribute value did not return true' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_string_for_truthy_attributes() {
+		$p = new WP_HTML_Tag_Processor( '<div enabled=enabled checked=1 hidden="true" class="test">Test</div>' );
+
+		$this->assertTrue( $p->next_tag(), 'Querying an existing tag did not return true' );
+		$this->assertSame( 'enabled', $p->get_attribute( 'enabled' ), 'Accessing a boolean "enabled" attribute value did not return true' );
+		$this->assertSame( '1', $p->get_attribute( 'checked' ), 'Accessing a checked=1 attribute value did not return "1"' );
+		$this->assertSame( 'true', $p->get_attribute( 'hidden' ), 'Accessing a hidden="true" attribute value did not return "true"' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_decodes_html_character_references() {
+		$p = new WP_HTML_Tag_Processor( '<div id="the &quot;grande&quot; is &lt; &#x033;&#50;oz&dagger;"></div>' );
+		$p->next_tag();
+
+		$this->assertSame( 'the "grande" is < 32oz†', $p->get_attribute( 'id' ), 'HTML Attribute value was returned without decoding character references' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_attributes_parser_treats_slash_as_attribute_separator() {
+		$p = new WP_HTML_Tag_Processor( '<div a/b/c/d/e="test">Test</div>' );
+
+		$this->assertTrue( $p->next_tag(), 'Querying an existing tag did not return true' );
+		$this->assertTrue( $p->get_attribute( 'a' ), 'Accessing an existing attribute did not return true' );
+		$this->assertTrue( $p->get_attribute( 'b' ), 'Accessing an existing attribute did not return true' );
+		$this->assertTrue( $p->get_attribute( 'c' ), 'Accessing an existing attribute did not return true' );
+		$this->assertTrue( $p->get_attribute( 'd' ), 'Accessing an existing attribute did not return true' );
+		$this->assertSame( 'test', $p->get_attribute( 'e' ), 'Accessing an existing e="test" did not return "test"' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 *
+	 * @dataProvider data_attribute_name_case_variants
+	 *
+	 * @param string $attribute_name Name of data-enabled attribute with case variations.
+	 */
+	public function test_get_attribute_is_case_insensitive_for_attributes_with_values( $attribute_name ) {
+		$p = new WP_HTML_Tag_Processor( '<div DATA-enabled="true">Test</div>' );
+		$p->next_tag();
+
+		$this->assertSame(
+			'true',
+			$p->get_attribute( $attribute_name ),
+			'Accessing an attribute by a differently-cased name did not return its value'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 *
+	 * @dataProvider data_attribute_name_case_variants
+	 *
+	 * @param string $attribute_name Name of data-enabled attribute with case variations.
+	 */
+	public function test_attributes_parser_is_case_insensitive_for_attributes_without_values( $attribute_name ) {
+		$p = new WP_HTML_Tag_Processor( '<div DATA-enabled>Test</div>' );
+		$p->next_tag();
+
+		$this->assertTrue(
+			$p->get_attribute( $attribute_name ),
+			'Accessing an attribute by a differently-cased name did not return its value'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[].
+	 */
+	public function data_attribute_name_case_variants() {
+		return array(
+			array( 'DATA-enabled' ),
+			array( 'data-enabled' ),
+			array( 'DATA-ENABLED' ),
+			array( 'DatA-EnABled' ),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 */
+	public function test_remove_attribute_is_case_insensitive() {
+		$p = new WP_HTML_Tag_Processor( '<div DATA-enabled="true">Test</div>' );
+		$p->next_tag();
+		$p->remove_attribute( 'data-enabled' );
+
+		$this->assertSame( '<div >Test</div>', $p->get_updated_html(), 'A case-insensitive remove_attribute call did not remove the attribute' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_is_case_insensitive() {
+		$p = new WP_HTML_Tag_Processor( '<div DATA-enabled="true">Test</div>' );
+		$p->next_tag();
+		$p->set_attribute( 'data-enabled', 'abc' );
+
+		$this->assertSame( '<div data-enabled="abc">Test</div>', $p->get_updated_html(), 'A case-insensitive set_attribute call did not update the existing attribute' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute_names_with_prefix
+	 */
+	public function test_get_attribute_names_with_prefix_returns_null_before_finding_tags() {
+		$p = new WP_HTML_Tag_Processor( '<div data-foo="bar">Test</div>' );
+		$this->assertNull(
+			$p->get_attribute_names_with_prefix( 'data-' ),
+			'Accessing attributes by their prefix did not return null when no tag was selected'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute_names_with_prefix
+	 */
+	public function test_get_attribute_names_with_prefix_returns_null_when_not_in_open_tag() {
+		$p = new WP_HTML_Tag_Processor( '<div data-foo="bar">Test</div>' );
+		$p->next_tag( 'p' );
+		$this->assertNull( $p->get_attribute_names_with_prefix( 'data-' ), 'Accessing attributes of a non-existing tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute_names_with_prefix
+	 */
+	public function test_get_attribute_names_with_prefix_returns_null_when_in_closing_tag() {
+		$p = new WP_HTML_Tag_Processor( '<div data-foo="bar">Test</div>' );
+		$p->next_tag( 'div' );
+		$p->next_tag( array( 'tag_closers' => 'visit' ) );
+
+		$this->assertNull( $p->get_attribute_names_with_prefix( 'data-' ), 'Accessing attributes of a closing tag did not return null' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute_names_with_prefix
+	 */
+	public function test_get_attribute_names_with_prefix_returns_empty_array_when_no_attributes_present() {
+		$p = new WP_HTML_Tag_Processor( '<div>Test</div>' );
+		$p->next_tag( 'div' );
+
+		$this->assertSame( array(), $p->get_attribute_names_with_prefix( 'data-' ), 'Accessing the attributes on a tag without any did not return an empty array' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute_names_with_prefix
+	 */
+	public function test_get_attribute_names_with_prefix_returns_matching_attribute_names_in_lowercase() {
+		$p = new WP_HTML_Tag_Processor( '<div DATA-enabled class="test" data-test-ID="14">Test</div>' );
+		$p->next_tag();
+
+		$this->assertSame(
+			array( 'data-enabled', 'data-test-id' ),
+			$p->get_attribute_names_with_prefix( 'data-' ),
+			'Accessing attributes by their prefix did not return their lowercase names'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute_names_with_prefix
+	 */
+	public function test_get_attribute_names_with_prefix_returns_attribute_added_by_set_attribute() {
+		$p = new WP_HTML_Tag_Processor( '<div data-foo="bar">Test</div>' );
+		$p->next_tag();
+		$p->set_attribute( 'data-test-id', '14' );
+
+		$this->assertSame(
+			'<div data-test-id="14" data-foo="bar">Test</div>',
+			$p->get_updated_html(),
+			"Updated HTML doesn't include attribute added via set_attribute"
+		);
+		$this->assertSame(
+			array( 'data-test-id', 'data-foo' ),
+			$p->get_attribute_names_with_prefix( 'data-' ),
+			"Accessing attribute names doesn't find attribute added via set_attribute"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::__toString
+	 */
+	public function test_to_string_returns_updated_html() {
+		$p = new WP_HTML_Tag_Processor( '<hr id="remove" /><div enabled class="test">Test</div><span id="span-id"></span>' );
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$p->next_tag();
+		$p->set_attribute( 'id', 'div-id-1' );
+		$p->add_class( 'new_class_1' );
+
+		$this->assertSame(
+			$p->get_updated_html(),
+			(string) $p,
+			'get_updated_html() returned a different value than __toString()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_updated_html
+	 */
+	public function test_get_updated_html_applies_the_updates_so_far_and_keeps_the_processor_on_the_current_tag() {
+		$p = new WP_HTML_Tag_Processor( '<hr id="remove" /><div enabled class="test">Test</div><span id="span-id"></span>' );
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$p->next_tag();
+		$p->set_attribute( 'id', 'div-id-1' );
+		$p->add_class( 'new_class_1' );
+
+		$this->assertSame(
+			'<hr  /><div id="div-id-1" enabled class="test new_class_1">Test</div><span id="span-id"></span>',
+			$p->get_updated_html(),
+			'Calling get_updated_html after updating the attributes of the second tag returned different HTML than expected'
+		);
+
+		$p->set_attribute( 'id', 'div-id-2' );
+		$p->add_class( 'new_class_2' );
+
+		$this->assertSame(
+			'<hr  /><div id="div-id-2" enabled class="test new_class_1 new_class_2">Test</div><span id="span-id"></span>',
+			$p->get_updated_html(),
+			'Calling get_updated_html after updating the attributes of the second tag for the second time returned different HTML than expected'
+		);
+
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$this->assertSame(
+			'<hr  /><div id="div-id-2" enabled class="test new_class_1 new_class_2">Test</div><span ></span>',
+			$p->get_updated_html(),
+			'Calling get_updated_html after removing the id attribute of the third tag returned different HTML than expected'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_updated_html
+	 */
+	public function test_get_updated_html_without_updating_any_attributes_returns_the_original_html() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+
+		$this->assertSame(
+			self::HTML_SIMPLE,
+			$p->get_updated_html(),
+			'Casting WP_HTML_Tag_Processor to a string without performing any updates did not return the initial HTML snippet'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 */
+	public function test_next_tag_with_no_arguments_should_find_the_next_existing_tag() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+
+		$this->assertTrue( $p->next_tag(), 'Querying an existing tag did not return true' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 */
+	public function test_next_tag_should_return_false_for_a_non_existing_tag() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+
+		$this->assertFalse( $p->next_tag( 'p' ), 'Querying a non-existing tag did not return false' );
+	}
+
+	/**
+	 * @ticket 56299
+	 * @ticket 57852
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 * @covers WP_HTML_Tag_Processor::is_tag_closer
+	 */
+	public function test_next_tag_should_stop_on_closers_only_when_requested() {
+		$p = new WP_HTML_Tag_Processor( '<div><img /></div>' );
+
+		$this->assertTrue( $p->next_tag( array( 'tag_name' => 'div' ) ), 'Did not find desired tag opener' );
+		$this->assertFalse( $p->next_tag( array( 'tag_name' => 'div' ) ), 'Visited an unwanted tag, a tag closer' );
+
+		$p = new WP_HTML_Tag_Processor( '<div><img /></div>' );
+		$p->next_tag(
+			array(
+				'tag_name'    => 'div',
+				'tag_closers' => 'visit',
+			)
+		);
+
+		$this->assertFalse( $p->is_tag_closer(), 'Indicated a tag opener is a tag closer' );
+		$this->assertTrue(
+			$p->next_tag(
+				array(
+					'tag_name'    => 'div',
+					'tag_closers' => 'visit',
+				)
+			),
+			'Did not stop at desired tag closer'
+		);
+		$this->assertTrue( $p->is_tag_closer(), 'Indicated a tag closer is a tag opener' );
+
+		$p = new WP_HTML_Tag_Processor( '<div>' );
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), "Did not find a tag opener when tag_closers was set to 'visit'" );
+		$this->assertFalse( $p->next_tag( array( 'tag_closers' => 'visit' ) ), "Found a closer where there wasn't one" );
+	}
+
+	/**
+	 * @ticket 57852
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 * @covers WP_HTML_Tag_Processor::is_tag_closer
+	 */
+	public function test_next_tag_should_stop_on_rcdata_and_script_tag_closers_when_requested() {
+		$p = new WP_HTML_Tag_Processor( '<script>abc</script>' );
+
+		$p->next_tag();
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </script> tag closer' );
+		$this->assertTrue( $p->is_tag_closer(), 'Indicated a <script> tag opener is a tag closer' );
+
+		$p = new WP_HTML_Tag_Processor( 'abc</script>' );
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </script> tag closer when there was no tag opener' );
+
+		$p = new WP_HTML_Tag_Processor( '<textarea>abc</textarea>' );
+
+		$p->next_tag();
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </textarea> tag closer' );
+		$this->assertTrue( $p->is_tag_closer(), 'Indicated a <textarea> tag opener is a tag closer' );
+
+		$p = new WP_HTML_Tag_Processor( 'abc</textarea>' );
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </textarea> tag closer when there was no tag opener' );
+
+		$p = new WP_HTML_Tag_Processor( '<title>abc</title>' );
+
+		$p->next_tag();
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </title> tag closer' );
+		$this->assertTrue( $p->is_tag_closer(), 'Indicated a <title> tag opener is a tag closer' );
+
+		$p = new WP_HTML_Tag_Processor( 'abc</title>' );
+		$this->assertTrue( $p->next_tag( array( 'tag_closers' => 'visit' ) ), 'Did not find the </title> tag closer when there was no tag opener' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_on_a_non_existing_tag_does_not_change_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+
+		$this->assertFalse( $p->next_tag( 'p' ), 'Querying a non-existing tag did not return false' );
+		$this->assertFalse( $p->next_tag( 'div' ), 'Querying a non-existing tag did not return false' );
+
+		$p->set_attribute( 'id', 'primary' );
+
+		$this->assertSame(
+			self::HTML_SIMPLE,
+			$p->get_updated_html(),
+			'Calling get_updated_html after updating a non-existing tag returned an HTML that was different from the original HTML'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 */
+	public function test_attribute_ops_on_tag_closer_do_not_change_the_markup() {
+		$p = new WP_HTML_Tag_Processor( '<div id=3></div invalid-id=4>' );
+		$p->next_tag(
+			array(
+				'tag_name'    => 'div',
+				'tag_closers' => 'visit',
+			)
+		);
+
+		$this->assertFalse( $p->is_tag_closer(), 'Skipped tag opener' );
+
+		$p->next_tag(
+			array(
+				'tag_name'    => 'div',
+				'tag_closers' => 'visit',
+			)
+		);
+
+		$this->assertTrue( $p->is_tag_closer(), 'Skipped tag closer' );
+		$this->assertFalse( $p->set_attribute( 'id', 'test' ), "Allowed setting an attribute on a tag closer when it shouldn't have" );
+		$this->assertFalse( $p->remove_attribute( 'invalid-id' ), "Allowed removing an attribute on a tag closer when it shouldn't have" );
+		$this->assertFalse( $p->add_class( 'sneaky' ), "Allowed adding a class on a tag closer when it shouldn't have" );
+		$this->assertFalse( $p->remove_class( 'not-appearing-in-this-test' ), "Allowed removing a class on a tag closer when it shouldn't have" );
+		$this->assertSame(
+			'<div id=3></div invalid-id=4>',
+			$p->get_updated_html(),
+			'Calling get_updated_html after updating a non-existing tag returned an HTML that was different from the original HTML'
+		);
+	}
+
+	/**
+	 * Passing a double quote inside of an attribute value could lead to an XSS attack as follows:
+	 *
+	 * ```php
+	 *     $p = new WP_HTML_Tag_Processor( '<div class="header"></div>' );
+	 *     $p->next_tag();
+	 *     $p->set_attribute('class', '" onclick="alert');
+	 *     echo $p;
+	 *     // <div class="" onclick="alert"></div>
+	 * ```
+	 *
+	 * To prevent it, `set_attribute` calls `esc_attr()` on its given values.
+	 *
+	 * ```php
+	 *    <div class="&quot; onclick=&quot;alert"></div>
+	 * ```
+	 *
+	 * @ticket 56299
+	 *
+	 * @dataProvider data_set_attribute_prevents_xss
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 *
+	 * @param string $attribute_value A value with potential XSS exploit.
+	 */
+	public function test_set_attribute_prevents_xss( $attribute_value ) {
+		$p = new WP_HTML_Tag_Processor( '<div></div>' );
+		$p->next_tag();
+		$p->set_attribute( 'test', $attribute_value );
+
+		/*
+		 * Testing the escaping is hard using tools that properly parse
+		 * HTML because they might interpret the escaped values. It's hard
+		 * with tools that don't understand HTML because they might get
+		 * confused by improperly-escaped values.
+		 *
+		 * Since the input HTML is known, the test will do what looks like
+		 * the opposite of what is expected to be done with this library.
+		 * But by doing so, the test (a) has full control over the
+		 * content and (b) looks at the raw values.
+		 */
+		$match = null;
+		preg_match( '~^<div test=(.*)></div>$~', $p->get_updated_html(), $match );
+		list( , $actual_value ) = $match;
+
+		$this->assertSame( '"' . esc_attr( $attribute_value ) . '"', $actual_value, 'Entities were not properly escaped in the attribute value' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return string[][].
+	 */
+	public function data_set_attribute_prevents_xss() {
+		return array(
+			array( '"' ),
+			array( '&quot;' ),
+			array( '&' ),
+			array( '&amp;' ),
+			array( '&euro;' ),
+			array( "'" ),
+			array( '<>' ),
+			array( '&quot";' ),
+			array( '" onclick="alert(\'1\');"><span onclick=""></span><script>alert("1")</script>' ),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_with_a_non_existing_attribute_adds_a_new_attribute_to_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'test-attribute', 'test-value' );
+
+		$this->assertSame(
+			'<div test-attribute="test-value" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include attribute added via set_attribute()'
+		);
+		$this->assertSame(
+			'test-value',
+			$p->get_attribute( 'test-attribute' ),
+			'get_attribute() (called after get_updated_html()) did not return attribute added via set_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_updated_values_before_they_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'test-attribute', 'test-value' );
+
+		$this->assertSame(
+			'test-value',
+			$p->get_attribute( 'test-attribute' ),
+			'get_attribute() (called before get_updated_html()) did not return attribute added via set_attribute()'
+		);
+		$this->assertSame(
+			'<div test-attribute="test-value" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include attribute added via set_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_returns_updated_values_before_they_are_applied_with_different_name_casing() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'test-ATTribute', 'test-value' );
+
+		$this->assertSame(
+			'test-value',
+			$p->get_attribute( 'test-attribute' ),
+			'get_attribute() (called before get_updated_html()) did not return attribute added via set_attribute()'
+		);
+		$this->assertSame(
+			'<div test-ATTribute="test-value" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include attribute added via set_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_added_class_names_before_they_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->add_class( 'my-class' );
+
+		$this->assertSame(
+			'my-class',
+			$p->get_attribute( 'class' ),
+			'get_attribute() (called before get_updated_html()) did not return class name added via add_class()'
+		);
+		$this->assertSame(
+			'<div class="my-class" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include class name added via add_class()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_added_class_names_before_they_are_applied_and_retains_classes_from_previous_add_class_calls() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->add_class( 'my-class' );
+
+		$this->assertSame(
+			'my-class',
+			$p->get_attribute( 'class' ),
+			'get_attribute() (called before get_updated_html()) did not return class name added via add_class()'
+		);
+
+		$p->add_class( 'my-other-class' );
+
+		$this->assertSame(
+			'my-class my-other-class',
+			$p->get_attribute( 'class' ),
+			'get_attribute() (called before get_updated_html()) did not return class names added via subsequent add_class() calls'
+		);
+		$this->assertSame(
+			'<div class="my-class my-other-class" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include class names added via subsequent add_class() calls'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_removed_attribute_before_it_is_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$this->assertNull(
+			$p->get_attribute( 'id' ),
+			'get_attribute() (called before get_updated_html()) returned attribute that was removed by remove_attribute()'
+		);
+		$this->assertSame(
+			'<div ><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML includes attribute that was removed by remove_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_adding_and_then_removing_an_attribute_before_those_updates_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'test-attribute', 'test-value' );
+		$p->remove_attribute( 'test-attribute' );
+
+		$this->assertNull(
+			$p->get_attribute( 'test-attribute' ),
+			'get_attribute() (called before get_updated_html()) returned attribute that was added via set_attribute() and then removed by remove_attribute()'
+		);
+		$this->assertSame(
+			self::HTML_SIMPLE,
+			$p->get_updated_html(),
+			'Updated HTML includes attribute that was added via set_attribute() and then removed by remove_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_setting_and_then_removing_an_existing_attribute_before_those_updates_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'id', 'test-value' );
+		$p->remove_attribute( 'id' );
+
+		$this->assertNull(
+			$p->get_attribute( 'id' ),
+			'get_attribute() (called before get_updated_html()) returned attribute that was overwritten by set_attribute() and then removed by remove_attribute()'
+		);
+		$this->assertSame(
+			'<div ><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML includes attribute that was overwritten by set_attribute() and then removed by remove_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_removed_class_names_before_they_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->remove_class( 'with-border' );
+
+		$this->assertSame(
+			'main',
+			$p->get_attribute( 'class' ),
+			'get_attribute() (called before get_updated_html()) returned the wrong attribute after calling remove_attribute()'
+		);
+		$this->assertSame(
+			'<div class="main" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML includes wrong attribute after calling remove_attribute()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_setting_and_then_removing_a_class_name_before_those_updates_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'foo-class' );
+		$p->remove_class( 'foo-class' );
+
+		$this->assertSame(
+			'main with-border',
+			$p->get_attribute( 'class' ),
+			'get_attribute() (called before get_updated_html()) returned class name that was added via add_class() and then removed by remove_class()'
+		);
+		$this->assertSame(
+			self::HTML_WITH_CLASSES,
+			$p->get_updated_html(),
+			'Updated HTML includes class that was added via add_class() and then removed by remove_class()'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::get_attribute
+	 */
+	public function test_get_attribute_reflects_duplicating_and_then_removing_an_existing_class_name_before_those_updates_are_applied() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'with-border' );
+		$p->remove_class( 'with-border' );
+
+		$this->assertSame(
+			'main',
+			$p->get_attribute( 'class' ),
+			'get_attribute() (called before get_updated_html()) returned class name that was duplicated via add_class() and then removed by remove_class()'
+		);
+		$this->assertSame(
+			'<div class="main" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML includes class that was duplicated via add_class() and then removed by remove_class()'
+		);
+	}
+
+	/**
+	 * According to HTML spec, only the first instance of an attribute counts.
+	 * The other ones are ignored.
+	 *
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_update_first_attribute_when_duplicated_attributes_exist() {
+		$p = new WP_HTML_Tag_Processor( '<div id="update-me" id="ignored-id"><span id="second">Text</span></div>' );
+		$p->next_tag();
+		$p->set_attribute( 'id', 'updated-id' );
+
+		$this->assertSame(
+			'<div id="updated-id" id="ignored-id"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Proper (first) appearance of attribute was not updated when duplicates exist'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_with_an_existing_attribute_name_updates_its_value_in_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'id', 'new-id' );
+		$this->assertSame(
+			'<div id="new-id"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Existing attribute was not updated'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_next_tag_and_set_attribute_in_a_loop_update_all_tags_in_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		while ( $p->next_tag() ) {
+			$p->set_attribute( 'data-foo', 'bar' );
+		}
+
+		$this->assertSame(
+			'<div data-foo="bar" id="first"><span data-foo="bar" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Not all tags were updated when looping with next_tag() and set_attribute()'
+		);
+	}
+
+	/**
+	 * Removing an attribute that's listed many times, e.g. `<div id="a" id="b" />` should remove
+	 * all its instances and output just `<div />`.
+	 *
+	 * Today, however, WP_HTML_Tag_Processor only removes the first such attribute. It seems like a corner case
+	 * and introducing additional complexity to correctly handle this scenario doesn't seem to be worth it.
+	 * Let's revisit if and when this becomes a problem.
+	 *
+	 * This test is in place to confirm this behavior, which while incorrect, is well-defined.
+	 * A later fix introduced to the Tag Processor should update this test to reflect the
+	 * wanted and correct behavior.
+	 *
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 */
+	public function test_remove_first_when_duplicated_attribute() {
+		$p = new WP_HTML_Tag_Processor( '<div id="update-me" id="ignored-id"><span id="second">Text</span></div>' );
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$this->assertSame(
+			'<div  id="ignored-id"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'First attribute (when duplicates exist) was not removed'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 */
+	public function test_remove_attribute_with_an_existing_attribute_name_removes_it_from_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->remove_attribute( 'id' );
+
+		$this->assertSame(
+			'<div ><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Attribute was not removed'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 */
+	public function test_remove_attribute_with_a_non_existing_attribute_name_does_not_change_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->remove_attribute( 'no-such-attribute' );
+
+		$this->assertSame(
+			self::HTML_SIMPLE,
+			$p->get_updated_html(),
+			'Content was changed when attempting to remove an attribute that did not exist'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_creates_a_class_attribute_when_there_is_none() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->add_class( 'foo-class' );
+
+		$this->assertSame(
+			'<div class="foo-class" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include class name added via add_class()'
+		);
+		$this->assertSame(
+			'foo-class',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) did not return class name added via add_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_calling_add_class_twice_creates_a_class_attribute_with_both_class_names_when_there_is_no_class_attribute() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->add_class( 'foo-class' );
+		$p->add_class( 'bar-class' );
+
+		$this->assertSame(
+			'<div class="foo-class bar-class" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not include class names added via subsequent add_class() calls'
+		);
+		$this->assertSame(
+			'foo-class bar-class',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) did not return class names added via subsequent add_class() calls"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 */
+	public function test_remove_class_does_not_change_the_markup_when_there_is_no_class_attribute() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->remove_class( 'foo-class' );
+
+		$this->assertSame(
+			self::HTML_SIMPLE,
+			$p->get_updated_html(),
+			'Updated HTML includes class name that was removed by remove_class()'
+		);
+		$this->assertNull(
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) did not return null for class name that was removed by remove_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_appends_class_names_to_the_existing_class_attribute_when_one_already_exists() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'foo-class' );
+		$p->add_class( 'bar-class' );
+
+		$this->assertSame(
+			'<div class="main with-border foo-class bar-class" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect class names added to existing class attribute via subsequent add_class() calls'
+		);
+		$this->assertSame(
+			'main with-border foo-class bar-class',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) does not reflect class names added to existing class attribute via subsequent add_class() calls"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 */
+	public function test_remove_class_removes_a_single_class_from_the_class_attribute_when_one_exists() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->remove_class( 'main' );
+
+		$this->assertSame(
+			'<div class=" with-border" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect class name removed from existing class attribute via remove_class()'
+		);
+		$this->assertSame(
+			' with-border',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) does not reflect class name removed from existing class attribute via remove_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 */
+	public function test_calling_remove_class_with_all_listed_class_names_removes_the_existing_class_attribute_from_the_markup() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->remove_class( 'main' );
+		$p->remove_class( 'with-border' );
+
+		$this->assertSame(
+			'<div  id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect class attribute removed via subesequent remove_class() calls'
+		);
+		$this->assertNull(
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) did not return null for class attribute removed via subesequent remove_class() calls"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_does_not_add_duplicate_class_names() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'with-border' );
+
+		$this->assertSame(
+			'<div class="main with-border" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect deduplicated class name added via add_class()'
+		);
+		$this->assertSame(
+			'main with-border',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) does not reflect deduplicated class name added via add_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_preserves_class_name_order_when_a_duplicate_class_name_is_added() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'main' );
+
+		$this->assertSame(
+			'<div class="main with-border" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect class name order after adding duplicated class name via add_class()'
+		);
+		$this->assertSame(
+			'main with-border',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) does not reflect class name order after adding duplicated class name added via add_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_when_there_is_a_class_attribute_with_excessive_whitespaces() {
+		$p = new WP_HTML_Tag_Processor(
+			'<div class="   main   with-border   " id="first"><span class="not-main bold with-border" id="second">Text</span></div>'
+		);
+		$p->next_tag();
+		$p->add_class( 'foo-class' );
+
+		$this->assertSame(
+			'<div class="   main   with-border foo-class" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect existing excessive whitespace after adding class name via add_class()'
+		);
+		$this->assertSame(
+			'   main   with-border foo-class',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) does not reflect existing excessive whitespace after adding class name via add_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 */
+	public function test_remove_class_preserves_whitespaces_when_there_is_a_class_attribute_with_excessive_whitespaces() {
+		$p = new WP_HTML_Tag_Processor(
+			'<div class="   main   with-border   " id="first"><span class="not-main bold with-border" id="second">Text</span></div>'
+		);
+		$p->next_tag();
+		$p->remove_class( 'with-border' );
+
+		$this->assertSame(
+			'<div class="   main" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect existing excessive whitespace after removing class name via remove_class()'
+		);
+		$this->assertSame(
+			'   main',
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) does not reflect existing excessive whitespace after removing class name via removing_class()"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 */
+	public function test_removing_all_classes_removes_the_existing_class_attribute_from_the_markup_even_when_excessive_whitespaces_are_present() {
+		$p = new WP_HTML_Tag_Processor(
+			'<div class="   main   with-border   " id="first"><span class="not-main bold with-border" id="second">Text</span></div>'
+		);
+		$p->next_tag();
+		$p->remove_class( 'main' );
+		$p->remove_class( 'with-border' );
+		$this->assertSame(
+			'<div  id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			'Updated HTML does not reflect removed class attribute after removing all class names via remove_class()'
+		);
+		$this->assertNull(
+			$p->get_attribute( 'class' ),
+			"get_attribute( 'class' ) did not return null after removing all class names via remove_class()"
+		);
+	}
+
+	/**
+	 * When add_class( $different_value ) is called _after_ set_attribute( 'class', $value ), the
+	 * final class name should be "$value $different_value". In other words, the `add_class` call
+	 * should append its class to the one(s) set by `set_attribute`. When `add_class( $different_value )`
+	 * is called _before_ `set_attribute( 'class', $value )`, however, the final class name should be
+	 * "$value" instead, as any direct updates to the `class` attribute supersede any changes enqueued
+	 * via the class builder methods.
+	 *
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_takes_priority_over_add_class() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'add_class' );
+		$p->set_attribute( 'class', 'set_attribute' );
+		$this->assertSame(
+			'<div class="set_attribute" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			"Calling get_updated_html after updating first tag's attributes did not return the expected HTML"
+		);
+		$this->assertSame(
+			'set_attribute',
+			$p->get_attribute( 'class' ),
+			"Calling get_attribute after updating first tag's attributes did not return the expected class name"
+		);
+
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->set_attribute( 'class', 'set_attribute' );
+		$p->add_class( 'add_class' );
+		$this->assertSame(
+			'<div class="set_attribute add_class" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			"Calling get_updated_html after updating first tag's attributes did not return the expected HTML"
+		);
+		$this->assertSame(
+			'set_attribute add_class',
+			$p->get_attribute( 'class' ),
+			"Calling get_attribute after updating first tag's attributes did not return the expected class name"
+		);
+	}
+
+	/**
+	 * When add_class( $different_value ) is called _after_ set_attribute( 'class', $value ), the
+	 * final class name should be "$value $different_value". In other words, the `add_class` call
+	 * should append its class to the one(s) set by `set_attribute`. When `add_class( $different_value )`
+	 * is called _before_ `set_attribute( 'class', $value )`, however, the final class name should be
+	 * "$value" instead, as any direct updates to the `class` attribute supersede any changes enqueued
+	 * via the class builder methods.
+	 *
+	 * This is still true when reading enqueued updates before calling `get_updated_html()`.
+	 *
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_takes_priority_over_add_class_even_before_updating() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->add_class( 'add_class' );
+		$p->set_attribute( 'class', 'set_attribute' );
+		$this->assertSame(
+			'set_attribute',
+			$p->get_attribute( 'class' ),
+			"Calling get_attribute after updating first tag's attributes did not return the expected class name"
+		);
+		$this->assertSame(
+			'<div class="set_attribute" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			"Calling get_updated_html after updating first tag's attributes did not return the expected HTML"
+		);
+
+		$p = new WP_HTML_Tag_Processor( self::HTML_WITH_CLASSES );
+		$p->next_tag();
+		$p->set_attribute( 'class', 'set_attribute' );
+		$p->add_class( 'add_class' );
+		$this->assertSame(
+			'set_attribute add_class',
+			$p->get_attribute( 'class' ),
+			"Calling get_attribute after updating first tag's attributes did not return the expected class name"
+		);
+		$this->assertSame(
+			'<div class="set_attribute add_class" id="first"><span class="not-main bold with-border" id="second">Text</span></div>',
+			$p->get_updated_html(),
+			"Calling get_updated_html after updating first tag's attributes did not return the expected HTML"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_overrides_boolean_class_attribute() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'class', true );
+		$p->add_class( 'add_class' );
+		$this->assertSame(
+			'<div class="add_class" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			"Updated HTML doesn't reflect class added via add_class that was originally set as boolean attribute"
+		);
+		$this->assertSame(
+			'add_class',
+			$p->get_attribute( 'class' ),
+			"get_attribute (called after get_updated_html()) doesn't reflect class added via add_class that was originally set as boolean attribute"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 */
+	public function test_add_class_overrides_boolean_class_attribute_even_before_updating() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_SIMPLE );
+		$p->next_tag();
+		$p->set_attribute( 'class', true );
+		$p->add_class( 'add_class' );
+		$this->assertSame(
+			'add_class',
+			$p->get_attribute( 'class' ),
+			"get_attribute (called before get_updated_html()) doesn't reflect class added via add_class that was originally set as boolean attribute"
+		);
+		$this->assertSame(
+			'<div class="add_class" id="first"><span id="second">Text</span></div>',
+			$p->get_updated_html(),
+			"Updated HTML doesn't reflect class added via add_class that was originally set as boolean attribute"
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 * @covers WP_HTML_Tag_Processor::remove_class
+	 * @covers WP_HTML_Tag_Processor::get_updated_html
+	 */
+	public function test_advanced_use_case() {
+		$input = <<<HTML
+<div selected class="merge-message" checked>
+	<div class="select-menu d-inline-block">
+		<div checked class="BtnGroup MixedCaseHTML position-relative" />
+		<div checked class="BtnGroup MixedCaseHTML position-relative">
+			<button type="button" class="merge-box-button btn-group-merge rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Merge pull request
+			</button>
+
+			<button type="button" class="merge-box-button btn-group-squash rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Squash and merge
+			</button>
+
+			<button type="button" class="merge-box-button btn-group-rebase rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Rebase and merge
+			</button>
+
+			<button aria-label="Select merge method" disabled="disabled" type="button" data-view-component="true" class="select-menu-button btn BtnGroup-item"></button>
+		</div>
+	</div>
+</div>
+HTML;
+
+		$expected_output = <<<HTML
+<div data-details="{ &quot;key&quot;: &quot;value&quot; }" selected class="merge-message is-processed" checked>
+	<div class="select-menu d-inline-block">
+		<div checked class=" MixedCaseHTML position-relative button-group Another-Mixed-Case" />
+		<div checked class=" MixedCaseHTML position-relative button-group Another-Mixed-Case">
+			<button type="button" class="merge-box-button btn-group-merge rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Merge pull request
+			</button>
+
+			<button type="button" class="merge-box-button btn-group-squash rounded-left-2 btn  BtnGroup-item js-details-target hx_create-pr-button" aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Squash and merge
+			</button>
+
+			<button type="button"  aria-expanded="false" data-details-container=".js-merge-pr" disabled="">
+			  Rebase and merge
+			</button>
+
+			<button aria-label="Select merge method" disabled="disabled" type="button" data-view-component="true" class="select-menu-button btn BtnGroup-item"></button>
+		</div>
+	</div>
+</div>
+HTML;
+
+		$p = new WP_HTML_Tag_Processor( $input );
+		$this->assertTrue( $p->next_tag( 'div' ), 'Querying an existing tag did not return true' );
+		$p->set_attribute( 'data-details', '{ "key": "value" }' );
+		$p->add_class( 'is-processed' );
+		$this->assertTrue(
+			$p->next_tag(
+				array(
+					'tag_name'   => 'div',
+					'class_name' => 'BtnGroup',
+				)
+			),
+			'Querying an existing tag did not return true'
+		);
+		$p->remove_class( 'BtnGroup' );
+		$p->add_class( 'button-group' );
+		$p->add_class( 'Another-Mixed-Case' );
+		$this->assertTrue(
+			$p->next_tag(
+				array(
+					'tag_name'   => 'div',
+					'class_name' => 'BtnGroup',
+				)
+			),
+			'Querying an existing tag did not return true'
+		);
+		$p->remove_class( 'BtnGroup' );
+		$p->add_class( 'button-group' );
+		$p->add_class( 'Another-Mixed-Case' );
+		$this->assertTrue(
+			$p->next_tag(
+				array(
+					'tag_name'     => 'button',
+					'class_name'   => 'btn',
+					'match_offset' => 3,
+				)
+			),
+			'Querying an existing tag did not return true'
+		);
+		$p->remove_attribute( 'class' );
+		$this->assertFalse( $p->next_tag( 'non-existent' ), 'Querying a non-existing tag did not return false' );
+		$p->set_attribute( 'class', 'test' );
+		$this->assertSame( $expected_output, $p->get_updated_html(), 'Calling get_updated_html after updating the attributes did not return the expected HTML' );
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 */
+	public function test_correctly_parses_html_attributes_wrapped_in_single_quotation_marks() {
+		$p = new WP_HTML_Tag_Processor(
+			'<div id=\'first\'><span id=\'second\'>Text</span></div>'
+		);
+		$p->next_tag(
+			array(
+				'tag_name' => 'div',
+				'id'       => 'first',
+			)
+		);
+		$p->remove_attribute( 'id' );
+		$p->next_tag(
+			array(
+				'tag_name' => 'span',
+				'id'       => 'second',
+			)
+		);
+		$p->set_attribute( 'id', 'single-quote' );
+		$this->assertSame(
+			'<div ><span id="single-quote">Text</span></div>',
+			$p->get_updated_html(),
+			'Did not remove single-quoted attribute'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_set_attribute_with_value_equal_to_true_adds_a_boolean_html_attribute_with_implicit_value() {
+		$p = new WP_HTML_Tag_Processor(
+			'<form action="/action_page.php"><input type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>'
+		);
+		$p->next_tag( 'input' );
+		$p->set_attribute( 'checked', true );
+		$this->assertSame(
+			'<form action="/action_page.php"><input checked type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>',
+			$p->get_updated_html(),
+			'Did not add "checked" as an expected boolean attribute'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_setting_a_boolean_attribute_to_false_removes_it_from_the_markup() {
+		$p = new WP_HTML_Tag_Processor(
+			'<form action="/action_page.php"><input checked type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>'
+		);
+		$p->next_tag( 'input' );
+		$p->set_attribute( 'checked', false );
+		$this->assertSame(
+			'<form action="/action_page.php"><input  type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>',
+			$p->get_updated_html(),
+			'Did not remove boolean attribute when set to false'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_setting_a_missing_attribute_to_false_does_not_change_the_markup() {
+		$html_input = '<form action="/action_page.php"><input type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>';
+		$p          = new WP_HTML_Tag_Processor( $html_input );
+		$p->next_tag( 'input' );
+		$p->set_attribute( 'checked', false );
+		$this->assertSame(
+			$html_input,
+			$p->get_updated_html(),
+			'Changed the markup unexpectedly when setting a non-existing attribute to false'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_setting_a_boolean_attribute_to_a_string_value_adds_explicit_value_to_the_markup() {
+		$p = new WP_HTML_Tag_Processor(
+			'<form action="/action_page.php"><input checked type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>'
+		);
+		$p->next_tag( 'input' );
+		$p->set_attribute( 'checked', 'checked' );
+		$this->assertSame(
+			'<form action="/action_page.php"><input checked="checked" type="checkbox" name="vehicle" value="Bike"><label for="vehicle">I have a bike</label></form>',
+			$p->get_updated_html(),
+			'Did not add string value to existing boolean attribute'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 */
+	public function test_unclosed_script_tag_should_not_cause_an_infinite_loop() {
+		$p = new WP_HTML_Tag_Processor( '<script>' );
+		$p->next_tag();
+		$this->assertSame( 'SCRIPT', $p->get_tag(), 'Did not find script tag' );
+		$p->next_tag();
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_next_tag_ignores_script_tag_contents
+	 *
+	 * @param string $script_then_div HTML to test.
+	 */
+	public function test_next_tag_ignores_script_tag_contents( $script_then_div ) {
+		$p = new WP_HTML_Tag_Processor( $script_then_div );
+		$p->next_tag();
+		$this->assertSame( 'SCRIPT', $p->get_tag(), 'The first found tag was not "script"' );
+		$p->next_tag();
+		$this->assertSame( 'DIV', $p->get_tag(), 'The second found tag was not "div"' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[].
+	 */
+	public function data_next_tag_ignores_script_tag_contents() {
+		return array(
+			'Simple script tag'                          => array(
+				'<script><span class="d-none d-md-inline">Back to notifications</span></script><div></div>',
+			),
+
+			'Simple uppercase script tag'                => array(
+				'<script><span class="d-none d-md-inline">Back to notifications</span></SCRIPT><div></div>',
+			),
+
+			'Script with a comment opener inside should end at the next script tag closer (dash dash escaped state)' => array(
+				'<script class="d-md-none"><!--</script><div></div>-->',
+			),
+
+			'Script with a comment opener and a script tag opener inside should end two script tag closer later (double escaped state)' => array(
+				'<script class="d-md-none"><!--<script><span1></script><span2></span2></script><div></div>-->',
+			),
+
+			'Double escaped script with a tricky opener' => array(
+				'<script class="d-md-none"><!--<script attr="</script>"></script>"><div></div>',
+			),
+
+			'Double escaped script with a tricky closer' => array(
+				'<script class="d-md-none"><!--<script><span></script attr="</script>"><div></div>',
+			),
+
+			'Double escaped, then escaped, then double escaped' => array(
+				'<script class="d-md-none"><!--<script></script><script></script><span></span></script><div></div>',
+			),
+
+			'Script with a commented a script tag opener inside should at the next tag closer (dash dash escaped state)' => array(
+				'<script class="d-md-none"><!--<script>--><span></script><div></div>-->',
+			),
+
+			'Script closer with another script tag in closer attributes' => array(
+				'<script><span class="d-none d-md-inline">Back to notifications</title</span></script <script><div></div>',
+			),
+
+			'Script closer with attributes'              => array(
+				'<script class="d-md-none"><span class="d-none d-md-inline">Back to notifications</span></script id="test"><div></div>',
+			),
+
+			'Script opener with title closer inside'     => array(
+				'<script class="d-md-none"></title></script><div></div>',
+			),
+
+			'Complex script with many parsing states'    => array(
+				'<script class="d-md-none"><!--<script>--><scRipt><span><!--<span><Script</script>--></scripT><div></div>-->',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_next_tag_ignores_contents_of_rcdata_tag
+	 *
+	 * @param string $rcdata_then_div HTML with RCDATA before a DIV.
+	 * @param string $rcdata_tag      RCDATA tag.
+	 */
+	public function test_next_tag_ignores_contents_of_rcdata_tag( $rcdata_then_div, $rcdata_tag ) {
+		$p = new WP_HTML_Tag_Processor( $rcdata_then_div );
+		$p->next_tag();
+		$this->assertSame( $rcdata_tag, $p->get_tag(), "The first found tag was not '$rcdata_tag'" );
+		$p->next_tag();
+		$this->assertSame( 'DIV', $p->get_tag(), "The second found tag was not 'div'" );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_next_tag_ignores_contents_of_rcdata_tag() {
+		return array(
+			'simple textarea'                          => array(
+				'rcdata_then_div' => '<textarea><span class="d-none d-md-inline">Back to notifications</span></textarea><div></div>',
+				'rcdata_tag'      => 'TEXTAREA',
+			),
+			'simple title'                             => array(
+				'rcdata_then_div' => '<title><span class="d-none d-md-inline">Back to notifications</title</span></title><div></div>',
+				'rcdata_tag'      => 'TITLE',
+			),
+			'comment opener inside a textarea tag should be ignored' => array(
+				'rcdata_then_div' => '<textarea class="d-md-none"><!--</textarea><div></div>-->',
+				'rcdata_tag'      => 'TEXTAREA',
+			),
+			'textarea closer with another textarea tag in closer attributes' => array(
+				'rcdata_then_div' => '<textarea><span class="d-none d-md-inline">Back to notifications</title</span></textarea <textarea><div></div>',
+				'rcdata_tag'      => 'TEXTAREA',
+			),
+			'textarea closer with attributes'          => array(
+				'rcdata_then_div' => '<textarea class="d-md-none"><span class="d-none d-md-inline">Back to notifications</span></textarea id="test"><div></div>',
+				'rcdata_tag'      => 'TEXTAREA',
+			),
+			'textarea opener with title closer inside' => array(
+				'rcdata_then_div' => '<textarea class="d-md-none"></title></textarea><div></div>',
+				'rcdata_tag'      => 'TEXTAREA',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 *
+	 * @dataProvider data_skips_contents_of_script_and_rcdata_regions
+	 *
+	 * @param $input_html HTML with multiple divs, one of which carries the "target" attribute.
+	 */
+	public function test_skips_contents_of_script_and_rcdata_regions( $input_html ) {
+		$p = new WP_HTML_Tag_Processor( $input_html );
+		$p->next_tag( 'div' );
+
+		$this->assertTrue(
+			$p->get_attribute( 'target' ),
+			'Did not properly skip over script and rcdata regions; incorrectly found tags inside'
+		);
+	}
+
+	/**
+	 * Data provider
+	 *
+	 * @return array[]
+	 */
+	public function data_skips_contents_of_script_and_rcdata_regions() {
+		return array(
+			'Balanced SCRIPT tags'                => array( '<script>console.log("<div>");</script><div target><div>' ),
+			'Unexpected SCRIPT closer after DIV'  => array( 'console.log("<div target>")</script><div><div>' ),
+			'Unexpected SCRIPT closer before DIV' => array( 'console.log("<span>")</script><div target><div>' ),
+			'Missing SCRIPT closer'               => array( '<script>console.log("<div>");<div><div></script><div target>' ),
+			'TITLE before DIV'                    => array( '<title><div></title><div target><div>' ),
+			'SCRIPT inside TITLE'                 => array( '<title><script><div></title><div target><div></script><div>' ),
+			'TITLE in TEXTAREA'                   => array( '<textarea><div><title><div></textarea><div target></title><div>' ),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_can_query_and_update_wrongly_nested_tags() {
+		$p = new WP_HTML_Tag_Processor(
+			'<span>123<p>456</span>789</p>'
+		);
+		$p->next_tag( 'span' );
+		$p->set_attribute( 'class', 'span-class' );
+		$p->next_tag( 'p' );
+		$p->set_attribute( 'class', 'p-class' );
+		$this->assertSame(
+			'<span class="span-class">123<p class="p-class">456</span>789</p>',
+			$p->get_updated_html(),
+			'Did not find overlapping p tag'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::next_tag
+	 * @covers WP_HTML_Tag_Processor::remove_attribute
+	 */
+	public function test_removing_specific_attributes_in_malformed_html() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_MALFORMED );
+		$p->next_tag( 'span' );
+		$p->remove_attribute( 'Notifications<' );
+		$this->assertSame(
+			'<div><span class="d-md-none" /span><span class="d-none d-md-inline">Back to notifications</span></div>',
+			$p->get_updated_html(),
+			'Did not remove "Notifications<" attribute in malformed input'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 */
+	public function test_updating_specific_attributes_in_malformed_html() {
+		$p = new WP_HTML_Tag_Processor( self::HTML_MALFORMED );
+		$p->next_tag( 'span' );
+		$p->set_attribute( 'id', 'first' );
+		$p->next_tag( 'span' );
+		$p->set_attribute( 'id', 'second' );
+		$this->assertSame(
+			'<div><span id="first" class="d-md-none" Notifications</span><span id="second" class="d-none d-md-inline">Back to notifications</span></div>',
+			$p->get_updated_html(),
+			'Did not add id attributes properly to malformed input'
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 *
+	 * @dataProvider data_updating_attributes
+	 *
+	 * @param string $html     HTML to process.
+	 * @param string $expected Expected updated HTML.
+	 */
+	public function test_updating_attributes( $html, $expected ) {
+		$p = new WP_HTML_Tag_Processor( $html );
+		$p->next_tag();
+		$p->set_attribute( 'foo', 'bar' );
+		$p->add_class( 'firstTag' );
+		$p->next_tag();
+		$p->add_class( 'secondTag' );
+
+		$this->assertSame(
+			$expected,
+			$p->get_updated_html(),
+			'Did not properly add attributes and class names'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_updating_attributes() {
+		return array(
+			'tags inside of a comment' => array(
+				'input'    => '<!-- this is a comment. no <strong>tags</strong> allowed --><span>test</span>',
+				'expected' => '<!-- this is a comment. no <strong>tags</strong> allowed --><span class="firstTag" foo="bar">test</span>',
+			),
+			'does not parse <3'        => array(
+				'input'    => '<3 is a heart but <t3> is a tag.<span>test</span>',
+				'expected' => '<3 is a heart but <t3 class="firstTag" foo="bar"> is a tag.<span class="secondTag">test</span>',
+			),
+			'does not parse <*'        => array(
+				'input'    => 'The applicative operator <* works well in Haskell; is what?<span>test</span>',
+				'expected' => 'The applicative operator <* works well in Haskell; is what?<span class="firstTag" foo="bar">test</span>',
+			),
+			'</> in content'           => array(
+				'input'    => '</><span>test</span>',
+				'expected' => '</><span class="firstTag" foo="bar">test</span>',
+			),
+			'custom asdf attribute'    => array(
+				'input'    => '<hr asdf="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" asdf="test"><span class="secondTag">test</span>',
+			),
+			'custom data-* attribute'  => array(
+				'input'    => '<div data-foo="bar"><p>Some content for a <span>test</span></p></div>',
+				'expected' => '<div class="firstTag" foo="bar" data-foo="bar"><p class="secondTag">Some content for a <span>test</span></p></div>',
+			),
+			'tag inside of CDATA'      => array(
+				'input'    => '<![CDATA[This <is> a <strong id="yes">HTML Tag</strong>]]><span>test</span>',
+				'expected' => '<![CDATA[This <is> a <strong id="yes">HTML Tag</strong>]]><span class="firstTag" foo="bar">test</span>',
+			),
+		);
+	}
+
+	/**
+	 * @ticket 56299
+	 *
+	 * @covers WP_HTML_Tag_Processor::add_class
+	 * @covers WP_HTML_Tag_Processor::set_attribute
+	 *
+	 * @dataProvider data_updating_attributes_in_malformed_html
+	 *
+	 * @param string $html     HTML to process.
+	 * @param string $expected Expected updated HTML.
+	 */
+	public function test_updating_attributes_in_malformed_html( $html, $expected ) {
+		$p = new WP_HTML_Tag_Processor( $html );
+		$p->next_tag();
+		$p->set_attribute( 'foo', 'bar' );
+		$p->add_class( 'firstTag' );
+		$p->next_tag();
+		$p->add_class( 'secondTag' );
+
+		$this->assertSame(
+			$expected,
+			$p->get_updated_html(),
+			'Did not properly update attributes and classnames given malformed input'
+		);
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_updating_attributes_in_malformed_html() {
+		$null_byte = chr( 0 );
+
+		return array(
+			'Invalid entity inside attribute value'        => array(
+				'input'    => '<img src="https://s0.wp.com/i/atat.png" title="&; First &lt;title&gt; is &notit;" TITLE="second title" title="An Imperial &imperial; AT-AT"><span>test</span>',
+				'expected' => '<img class="firstTag" foo="bar" src="https://s0.wp.com/i/atat.png" title="&; First &lt;title&gt; is &notit;" TITLE="second title" title="An Imperial &imperial; AT-AT"><span class="secondTag">test</span>',
+			),
+			'HTML tag opening inside attribute value'      => array(
+				'input'    => '<pre id="<code" class="wp-block-code <code is poetry&gt;"><code>This &lt;is> a &lt;strong is="true">thing.</code></pre><span>test</span>',
+				'expected' => '<pre foo="bar" id="<code" class="wp-block-code &lt;code is poetry&gt; firstTag"><code class="secondTag">This &lt;is> a &lt;strong is="true">thing.</code></pre><span>test</span>',
+			),
+			'HTML tag brackets in attribute values and data markup' => array(
+				'input'    => '<pre id="<code-&gt;-block-&gt;" class="wp-block-code <code is poetry&gt;"><code>This &lt;is> a &lt;strong is="true">thing.</code></pre><span>test</span>',
+				'expected' => '<pre foo="bar" id="<code-&gt;-block-&gt;" class="wp-block-code &lt;code is poetry&gt; firstTag"><code class="secondTag">This &lt;is> a &lt;strong is="true">thing.</code></pre><span>test</span>',
+			),
+			'Single and double quotes in attribute value'  => array(
+				'input'    => '<p title="Demonstrating how to use single quote (\') and double quote (&quot;)"><span>test</span>',
+				'expected' => '<p class="firstTag" foo="bar" title="Demonstrating how to use single quote (\') and double quote (&quot;)"><span class="secondTag">test</span>',
+			),
+			'Unquoted attribute values'                    => array(
+				'input'    => '<hr a=1 a=2 a=3 a=5 /><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" a=1 a=2 a=3 a=5 /><span class="secondTag">test</span>',
+			),
+			'Double-quotes escaped in double-quote attribute value' => array(
+				'input'    => '<hr title="This is a &quot;double-quote&quot;"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" title="This is a &quot;double-quote&quot;"><span class="secondTag">test</span>',
+			),
+			'Unquoted attribute value'                     => array(
+				'input'    => '<hr id=code><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id=code><span class="secondTag">test</span>',
+			),
+			'Unquoted attribute value with tag-like value' => array(
+				'input'    => '<hr id= 	<code> ><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id= 	<code> ><span class="secondTag">test</span>',
+			),
+			'Unquoted attribute value with tag-like value followed by tag-like data' => array(
+				'input'    => '<hr id=code>><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id=code>><span class="secondTag">test</span>',
+			),
+			'id=&quo;code'                                 => array(
+				'input'    => '<hr id=&quo;code><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id=&quo;code><span class="secondTag">test</span>',
+			),
+			'id/test=5'                                    => array(
+				'input'    => '<hr id/test=5><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id/test=5><span class="secondTag">test</span>',
+			),
+			'<hr> as the id value'                         => array(
+				'input'    => '<hr title="<hr>"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" title="<hr>"><span class="secondTag">test</span>',
+			),
+			'id=>code'                                     => array(
+				'input'    => '<hr id=>code><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id=>code><span class="secondTag">test</span>',
+			),
+			'id"quo="test"'                                => array(
+				'input'    => '<hr id"quo="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id"quo="test"><span class="secondTag">test</span>',
+			),
+			'id without double quotation marks around null byte' => array(
+				'input'    => '<hr id' . $null_byte . 'zero="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id' . $null_byte . 'zero="test"><span class="secondTag">test</span>',
+			),
+			'Unexpected > before an attribute'             => array(
+				'input'    => '<hr >id="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" >id="test"><span class="secondTag">test</span>',
+			),
+			'Unexpected = before an attribute'             => array(
+				'input'    => '<hr =id="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" =id="test"><span class="secondTag">test</span>',
+			),
+			'Unexpected === before an attribute'           => array(
+				'input'    => '<hr ===name="value"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" ===name="value"><span class="secondTag">test</span>',
+			),
+			'Missing closing data-tag tag'                 => array(
+				'input'    => 'The applicative operator <* works well in Haskell; <data-tag> is what?<span>test</span>',
+				'expected' => 'The applicative operator <* works well in Haskell; <data-tag class="firstTag" foo="bar"> is what?<span class="secondTag">test</span>',
+			),
+			'Missing closing t3 tag'                       => array(
+				'input'    => '<3 is a heart but <t3> is a tag.<span>test</span>',
+				'expected' => '<3 is a heart but <t3 class="firstTag" foo="bar"> is a tag.<span class="secondTag">test</span>',
+			),
+			'invalid comment opening tag'                  => array(
+				'input'    => '<?comment --><span>test</span>',
+				'expected' => '<?comment --><span class="firstTag" foo="bar">test</span>',
+			),
+			'=asdf as attribute name'                      => array(
+				'input'    => '<hr =asdf="tes"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" =asdf="tes"><span class="secondTag">test</span>',
+			),
+			'== as attribute name with value'              => array(
+				'input'    => '<hr ==="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" ==="test"><span class="secondTag">test</span>',
+			),
+			'=5 as attribute'                              => array(
+				'input'    => '<hr =5><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" =5><span class="secondTag">test</span>',
+			),
+			'= as attribute'                               => array(
+				'input'    => '<hr =><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" =><span class="secondTag">test</span>',
+			),
+			'== as attribute'                              => array(
+				'input'    => '<hr ==><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" ==><span class="secondTag">test</span>',
+			),
+			'=== as attribute'                             => array(
+				'input'    => '<hr ===><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" ===><span class="secondTag">test</span>',
+			),
+			'unsupported disabled attribute'               => array(
+				'input'    => '<hr disabled><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" disabled><span class="secondTag">test</span>',
+			),
+			'malformed custom attributes'                  => array(
+				'input'    => '<hr a"sdf="test"><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" a"sdf="test"><span class="secondTag">test</span>',
+			),
+			'Multiple unclosed tags treated as a single tag' => array(
+				'input'    => <<<HTML
+					<hr id=">"code
+					<hr id="value>"code
+					<hr id="/>"code
+					<hr id="value/>"code
+					/>
+					<span>test</span>
+HTML
+				,
+				'expected' => <<<HTML
+					<hr class="firstTag" foo="bar" id=">"code
+					<hr id="value>"code
+					<hr id="/>"code
+					<hr id="value/>"code
+					/>
+					<span class="secondTag">test</span>
+HTML
+			,
+			),
+			'<hr id   =5>'                                 => array(
+				'input'    => '<hr id   =5><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id   =5><span class="secondTag">test</span>',
+			),
+			'<hr id a  =5>'                                => array(
+				'input'    => '<hr id a  =5><span>test</span>',
+				'expected' => '<hr class="firstTag" foo="bar" id a  =5><span class="secondTag">test</span>',
+			),
+		);
+	}
+}
diff --git a/tests/http/base.php b/tests/http/base.php
index ad104afe52..ad487e3f19 100644
--- a/tests/http/base.php
+++ b/tests/http/base.php
@@ -283,7 +283,7 @@ abstract class WP_HTTP_UnitTestCase extends WP_UnitTestCase {
 		$this->skipTestOnTimeout( $res );
 		$this->assertNotWPError( $res );
 		$this->assertSame( '', $res['body'] ); // The body should be empty.
-		$this->assertEquals( $size, $res['headers']['content-length'] );   // Check the headers are returned (and the size is the same).
+		$this->assertEquals( $size, $res['headers']['Content-Length'] );   // Check the headers are returned (and the size is the same).
 		$this->assertSame( $size, $filesize ); // Check that the file is written to disk correctly without any extra characters.
 		$this->assertStringStartsWith( get_temp_dir(), $res['filename'] ); // Check it's saving within the temp directory.
 	}
diff --git a/tests/http/functions.php b/tests/http/functions.php
index 5aa92fdf50..cb0045fd50 100644
--- a/tests/http/functions.php
+++ b/tests/http/functions.php
@@ -20,8 +20,8 @@ class Tests_HTTP_Functions extends WP_UnitTestCase {
 
 		$this->assertIsArray( $response );
 
-		$this->assertSame( 'image/jpeg', $headers['content-type'] );
-		$this->assertSame( '40148', $headers['content-length'] );
+		$this->assertSame( 'image/jpeg', $headers['Content-Type'] );
+		$this->assertSame( '40148', $headers['Content-Length'] );
 		$this->assertSame( 200, wp_remote_retrieve_response_code( $response ) );
 	}
 
@@ -65,8 +65,8 @@ class Tests_HTTP_Functions extends WP_UnitTestCase {
 		$this->assertIsArray( $response );
 
 		// Should return the same headers as a HEAD request.
-		$this->assertSame( 'image/jpeg', $headers['content-type'] );
-		$this->assertSame( '40148', $headers['content-length'] );
+		$this->assertSame( 'image/jpeg', $headers['Content-Type'] );
+		$this->assertSame( '40148', $headers['Content-Length'] );
 		$this->assertSame( 200, wp_remote_retrieve_response_code( $response ) );
 	}
 
@@ -86,8 +86,8 @@ class Tests_HTTP_Functions extends WP_UnitTestCase {
 		$headers = wp_remote_retrieve_headers( $response );
 
 		// Should return the same headers as a HEAD request.
-		$this->assertSame( 'image/jpeg', $headers['content-type'] );
-		$this->assertSame( '40148', $headers['content-length'] );
+		$this->assertSame( 'image/jpeg', $headers['Content-Type'] );
+		$this->assertSame( '40148', $headers['Content-Length'] );
 		$this->assertSame( 200, wp_remote_retrieve_response_code( $response ) );
 	}
 
diff --git a/tests/http/http.php b/tests/http/http.php
index ea27d7b0d7..de9dd73320 100644
--- a/tests/http/http.php
+++ b/tests/http/http.php
@@ -9,7 +9,10 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 	const FULL_TEST_URL = 'http://username:password@host.name:9090/path?arg1=value1&arg2=value2#anchor';
 
 	/**
-	 * @dataProvider make_absolute_url_testcases
+	 * @ticket 20434
+	 * @ticket 56231
+	 *
+	 * @dataProvider data_make_absolute_url
 	 *
 	 * @covers WP_Http::make_absolute_url
 	 */
@@ -18,7 +21,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
-	public function make_absolute_url_testcases() {
+	public function data_make_absolute_url() {
 		// 0: The Location header, 1: The current URL, 3: The expected URL.
 		return array(
 			// Absolute URL provided.
@@ -66,11 +69,18 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 
 			// Schemeless URL's (not valid in HTTP Headers, but may be used elsewhere).
 			array( '//example.com/sub/', 'https://example.net', 'https://example.com/sub/' ),
+
+			// URLs with fragments.
+			array( '/path#frag', 'http://example.org/', 'http://example.org/path#frag' ),
+			array( '/path/#frag', 'http://example.org/', 'http://example.org/path/#frag' ),
+			array( '/path#frag&ment=1', 'http://example.org/', 'http://example.org/path#frag&ment=1' ),
+			array( '/path?query=string#frag', 'http://example.org/', 'http://example.org/path?query=string#frag' ),
+			array( '/path?query=string%23frag', 'http://example.org/', 'http://example.org/path?query=string%23frag' ),
 		);
 	}
 
 	/**
-	 * @dataProvider parse_url_testcases
+	 * @dataProvider data_wp_parse_url
 	 *
 	 * @covers ::wp_parse_url
 	 */
@@ -79,7 +89,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
-	public function parse_url_testcases() {
+	public function data_wp_parse_url() {
 		// 0: The URL, 1: The expected resulting structure.
 		return array(
 			array(
@@ -207,7 +217,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 	/**
 	 * @ticket 36356
 	 *
-	 * @dataProvider parse_url_component_testcases
+	 * @dataProvider data_wp_parse_url_with_component
 	 *
 	 * @covers ::wp_parse_url
 	 */
@@ -216,7 +226,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
-	public function parse_url_component_testcases() {
+	public function data_wp_parse_url_with_component() {
 		// 0: The URL, 1: The requested component, 2: The expected resulting structure.
 		return array(
 			array( self::FULL_TEST_URL, PHP_URL_SCHEME, 'http' ),
@@ -323,7 +333,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 	/**
 	 * @ticket 36356
 	 *
-	 * @dataProvider get_component_from_parsed_url_array_testcases
+	 * @dataProvider data_get_component_from_parsed_url_array
 	 *
 	 * @covers ::wp_parse_url
 	 * @covers ::_get_component_from_parsed_url_array
@@ -334,7 +344,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
-	public function get_component_from_parsed_url_array_testcases() {
+	public function data_get_component_from_parsed_url_array() {
 		// 0: A URL, 1: PHP URL constant, 2: The expected result.
 		return array(
 			array(
@@ -365,7 +375,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 	/**
 	 * @ticket 36356
 	 *
-	 * @dataProvider wp_translate_php_url_constant_to_key_testcases
+	 * @dataProvider data_wp_translate_php_url_constant_to_key
 	 *
 	 * @covers ::_wp_translate_php_url_constant_to_key
 	 */
@@ -374,7 +384,7 @@ class Tests_HTTP_HTTP extends WP_UnitTestCase {
 		$this->assertSame( $expected, $actual );
 	}
 
-	public function wp_translate_php_url_constant_to_key_testcases() {
+	public function data_wp_translate_php_url_constant_to_key() {
 		// 0: PHP URL constant, 1: The expected result.
 		return array(
 			array( PHP_URL_SCHEME, 'scheme' ),
diff --git a/tests/http/includeOldRequestsClass.php b/tests/http/includeOldRequestsClass.php
index ec06c72271..3be2173b6c 100644
--- a/tests/http/includeOldRequestsClass.php
+++ b/tests/http/includeOldRequestsClass.php
@@ -15,7 +15,7 @@ class Tests_HTTP_IncludeOldRequestsClass extends WP_UnitTestCase {
 	 */
 	public function test_should_include_old_requests_class() {
 		$this->expectDeprecation();
-		$this->expectDeprecationMessage( 'The PSR-0 `Requests_...` class names in the Request library are deprecated.' );
+		$this->expectDeprecationMessage( 'The PSR-0 `Requests_...` class names in the Requests library are deprecated.' );
 
 		new Requests();
 	}
diff --git a/tests/https-detection.php b/tests/https-detection.php
index a30ceb146e..820f39fc6e 100644
--- a/tests/https-detection.php
+++ b/tests/https-detection.php
@@ -196,39 +196,11 @@ class Tests_HTTPS_Detection extends WP_UnitTestCase {
 		$this->assertFalse( wp_is_local_html_output( $html ) );
 	}
 
-	/**
-	 * @ticket 47577
-	 */
-	public function test_wp_is_local_html_output_via_wlwmanifest_link() {
-		remove_action( 'wp_head', 'rsd_link' );
-
-		// HTML includes WLW manifest link.
-		$head_tag = get_echo( 'wlwmanifest_link' );
-		$html     = $this->get_sample_html_string( $head_tag );
-		$this->assertTrue( wp_is_local_html_output( $html ) );
-
-		// HTML includes modified WLW manifest link but same URL.
-		$head_tag = str_replace( ' />', '>', get_echo( 'wlwmanifest_link' ) );
-		$html     = $this->get_sample_html_string( $head_tag );
-		$this->assertTrue( wp_is_local_html_output( $html ) );
-
-		// HTML includes WLW manifest link with alternative URL scheme.
-		$head_tag = get_echo( 'wlwmanifest_link' );
-		$head_tag = false !== strpos( $head_tag, 'https://' ) ? str_replace( 'https://', 'http://', $head_tag ) : str_replace( 'http://', 'https://', $head_tag );
-		$html     = $this->get_sample_html_string( $head_tag );
-		$this->assertTrue( wp_is_local_html_output( $html ) );
-
-		// HTML does not include WLW manifest link.
-		$html = $this->get_sample_html_string();
-		$this->assertFalse( wp_is_local_html_output( $html ) );
-	}
-
 	/**
 	 * @ticket 47577
 	 */
 	public function test_wp_is_local_html_output_via_rest_link() {
 		remove_action( 'wp_head', 'rsd_link' );
-		remove_action( 'wp_head', 'wlwmanifest_link' );
 
 		// HTML includes REST API link.
 		$head_tag = get_echo( 'rest_output_link_wp_head' );
@@ -256,7 +228,6 @@ class Tests_HTTPS_Detection extends WP_UnitTestCase {
 	 */
 	public function test_wp_is_local_html_output_cannot_determine() {
 		remove_action( 'wp_head', 'rsd_link' );
-		remove_action( 'wp_head', 'wlwmanifest_link' );
 		remove_action( 'wp_head', 'rest_output_link_wp_head' );
 
 		// The HTML here doesn't matter because all hooks are removed.
diff --git a/tests/image/editor.php b/tests/image/editor.php
index be4591451d..6e800deb7a 100644
--- a/tests/image/editor.php
+++ b/tests/image/editor.php
@@ -288,7 +288,7 @@ class Tests_Image_Editor extends WP_Image_UnitTestCase {
 	 * Test wp_get_webp_info.
 	 *
 	 * @ticket 35725
-	 * @dataProvider _test_wp_get_webp_info
+	 * @dataProvider data_wp_get_webp_info
 	 *
 	 */
 	public function test_wp_get_webp_info( $file, $expected ) {
@@ -305,7 +305,7 @@ class Tests_Image_Editor extends WP_Image_UnitTestCase {
 	/**
 	 * Data provider for test_wp_get_webp_info().
 	 */
-	public function _test_wp_get_webp_info() {
+	public function data_wp_get_webp_info() {
 		return array(
 			// Standard JPEG.
 			array(
diff --git a/tests/kses.php b/tests/kses.php
index b31f477661..db5e26ec0b 100644
--- a/tests/kses.php
+++ b/tests/kses.php
@@ -937,7 +937,7 @@ EOF;
 	 * @ticket 48376
 	 * @ticket 55966
 	 * @ticket 56122
-	 * @dataProvider data_test_safecss_filter_attr
+	 * @dataProvider data_safecss_filter_attr
 	 *
 	 * @param string $css      A string of CSS rules.
 	 * @param string $expected Expected string of CSS rules.
@@ -947,7 +947,7 @@ EOF;
 	}
 
 	/**
-	 * Data Provider for test_safecss_filter_attr().
+	 * Data provider for test_safecss_filter_attr().
 	 *
 	 * @return array {
 	 *     @type array {
@@ -956,7 +956,7 @@ EOF;
 	 *     }
 	 * }
 	 */
-	public function data_test_safecss_filter_attr() {
+	public function data_safecss_filter_attr() {
 		return array(
 			// Empty input, empty output.
 			array(
@@ -1278,6 +1278,49 @@ EOF;
 				'css'      => '--?><.%-not-allowed: red;',
 				'expected' => '',
 			),
+			// Position properties introduced in 6.2.
+			array(
+				'css'      => 'position: sticky;top: 0;left: 0;right: 0;bottom: 0;z-index: 10;',
+				'expected' => 'position: sticky;top: 0;left: 0;right: 0;bottom: 0;z-index: 10',
+			),
+			// `aspect-ratio` introduced in 6.2.
+			array(
+				'css'      => 'aspect-ratio: auto;',
+				'expected' => 'aspect-ratio: auto',
+			),
+			array(
+				'css'      => 'aspect-ratio: 0.5;',
+				'expected' => 'aspect-ratio: 0.5',
+			),
+			array(
+				'css'      => 'aspect-ratio: 1;',
+				'expected' => 'aspect-ratio: 1',
+			),
+			array(
+				'css'      => 'aspect-ratio: 16 / 9;',
+				'expected' => 'aspect-ratio: 16 / 9',
+			),
+			array(
+				'css'      => 'aspect-ratio: expression( 16 / 9 );',
+				'expected' => '',
+			),
+			array(
+				'css'      => 'aspect-ratio: calc( 16 / 9;',
+				'expected' => '',
+			),
+			array(
+				'css'      => 'aspect-ratio: calc( 16 / 9 );',
+				'expected' => 'aspect-ratio: calc( 16 / 9 )',
+			),
+			array(
+				'css'      => 'aspect-ratio: url( https://wordpress.org/wp-content/uploads/aspect-ratio.jpg );',
+				'expected' => '',
+			),
+			// URL support for `filter` introduced in 6.3.
+			array(
+				'css'      => 'filter: url( my-file.svg#svg-blur );',
+				'expected' => 'filter: url( my-file.svg#svg-blur )',
+			),
 		);
 	}
 
@@ -1530,7 +1573,7 @@ EOF;
 	 *
 	 * @ticket 37134
 	 *
-	 * @dataProvider data_test_safecss_filter_attr_filtered
+	 * @dataProvider data_safecss_filter_attr_filtered
 	 *
 	 * @param string $css      A string of CSS rules.
 	 * @param string $expected Expected string of CSS rules.
@@ -1542,7 +1585,7 @@ EOF;
 	}
 
 	/**
-	 * Data Provider for test_safecss_filter_attr_filtered().
+	 * Data provider for test_safecss_filter_attr_filtered().
 	 *
 	 * @return array {
 	 *     @type array {
@@ -1551,7 +1594,7 @@ EOF;
 	 *     }
 	 * }
 	 */
-	public function data_test_safecss_filter_attr_filtered() {
+	public function data_safecss_filter_attr_filtered() {
 		return array(
 
 			// A single attribute name, with a single value.
@@ -2092,10 +2135,10 @@ HTML;
 	 *
 	 * @ticket 54060
 	 *
-	 * @param string $global The name of the global variable.
+	 * @param string $global_name The name of the global variable.
 	 */
-	public function test_kses_globals_are_defined( $global ) {
-		$this->assertArrayHasKey( $global, $GLOBALS );
+	public function test_kses_globals_are_defined( $global_name ) {
+		$this->assertArrayHasKey( $global_name, $GLOBALS );
 	}
 
 	/**
@@ -2104,13 +2147,13 @@ HTML;
 	 * @return array
 	 */
 	public function data_kses_globals_are_defined() {
-		$globals = array(
+		$required_kses_globals = array(
 			'allowedposttags',
 			'allowedtags',
 			'allowedentitynames',
 			'allowedxmlentitynames',
 		);
 
-		return $this->text_array_to_dataprovider( $globals );
+		return $this->text_array_to_dataprovider( $required_kses_globals );
 	}
 }
diff --git a/tests/l10n/loadScriptTextdomain.php b/tests/l10n/loadScriptTextdomain.php
index fab8aa8b5a..80313f5f37 100644
--- a/tests/l10n/loadScriptTextdomain.php
+++ b/tests/l10n/loadScriptTextdomain.php
@@ -14,7 +14,7 @@ class Tests_L10n_LoadScriptTextdomain extends WP_UnitTestCase {
 	 * @ticket 46387
 	 * @ticket 49145
 	 *
-	 * @dataProvider data_test_resolve_relative_path
+	 * @dataProvider data_resolve_relative_path
 	 */
 	public function test_resolve_relative_path( $translation_path, $handle, $src, $textdomain, $filter = array() ) {
 		if ( ! empty( $filter ) ) {
@@ -26,7 +26,7 @@ class Tests_L10n_LoadScriptTextdomain extends WP_UnitTestCase {
 		$this->assertSame( $expected, load_script_textdomain( $handle, $textdomain, DIR_TESTDATA . '/languages' ) );
 	}
 
-	public function data_test_resolve_relative_path() {
+	public function data_resolve_relative_path() {
 		return array(
 			// @ticket 45528
 			array(
diff --git a/tests/l10n/wpGetListItemSeparator.php b/tests/l10n/wpGetListItemSeparator.php
new file mode 100644
index 0000000000..5fc3d9e6f3
--- /dev/null
+++ b/tests/l10n/wpGetListItemSeparator.php
@@ -0,0 +1,28 @@
+<?php
+
+/**
+ * @group l10n
+ * @group i18n
+ *
+ * @covers ::wp_get_list_item_separator
+ */
+class Tests_L10n_wpGetListItemSeparator extends WP_UnitTestCase {
+
+	/**
+	 * Tests that the function returns a value when the $wp_locale global is not set.
+	 *
+	 * @ticket 56698
+	 */
+	public function test_should_return_default_value_if_wp_locale_is_not_set() {
+		global $wp_locale;
+
+		$original_locale = $wp_locale;
+		$wp_locale       = null;
+
+		$actual = wp_get_list_item_separator();
+
+		$wp_locale = $original_locale;
+
+		$this->assertSame( __( ', ' ), $actual );
+	}
+}
diff --git a/tests/l10n/wpGetWordCountType.php b/tests/l10n/wpGetWordCountType.php
new file mode 100644
index 0000000000..3a4b032205
--- /dev/null
+++ b/tests/l10n/wpGetWordCountType.php
@@ -0,0 +1,28 @@
+<?php
+
+/**
+ * @group l10n
+ * @group i18n
+ *
+ * @covers ::wp_get_word_count_type
+ */
+class Tests_L10n_wpGetWordCountType extends WP_UnitTestCase {
+
+	/**
+	 * Tests that the function returns a value when the $wp_locale global is not set.
+	 *
+	 * @ticket 56698
+	 */
+	public function test_should_return_default_value_if_wp_locale_is_not_set() {
+		global $wp_locale;
+
+		$original_locale = $wp_locale;
+		$wp_locale       = null;
+
+		$actual = wp_get_word_count_type();
+
+		$wp_locale = $original_locale;
+
+		$this->assertSame( 'words', $actual );
+	}
+}
diff --git a/tests/l10n/wpLocaleSwitcher.php b/tests/l10n/wpLocaleSwitcher.php
index b160f24833..7d61f54d55 100644
--- a/tests/l10n/wpLocaleSwitcher.php
+++ b/tests/l10n/wpLocaleSwitcher.php
@@ -16,6 +16,20 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 	 */
 	protected $previous_locale = '';
 
+	/**
+	 * @var int
+	 */
+	protected static $user_id;
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$user_id = $factory->user->create(
+			array(
+				'role'   => 'administrator',
+				'locale' => 'de_DE',
+			)
+		);
+	}
+
 	public function set_up() {
 		parent::set_up();
 
@@ -40,6 +54,10 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 
 		$wp_textdomain_registry = new WP_Textdomain_Registry();
 
+		// Clean up after any tests that don't restore the locale afterwards,
+		// before resetting $wp_locale_switcher.
+		restore_current_locale();
+
 		remove_filter( 'locale', array( $wp_locale_switcher, 'filter_locale' ) );
 		$wp_locale_switcher = new WP_Locale_Switcher();
 		$wp_locale_switcher->init();
@@ -89,6 +107,22 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'en_GB', $locale );
 	}
 
+	/**
+	 * @ticket 57123
+	 *
+	 * @covers ::switch_to_locale
+	 */
+	public function test_switch_to_locale_changes_determined_locale() {
+		switch_to_locale( 'en_GB' );
+
+		$locale = determine_locale();
+
+		// Cleanup.
+		restore_previous_locale();
+
+		$this->assertSame( 'en_GB', $locale );
+	}
+
 	/**
 	 * @covers ::switch_to_locale
 	 * @covers ::translate
@@ -332,14 +366,7 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 
 		$site_locale = get_locale();
 
-		$user_id = self::factory()->user->create(
-			array(
-				'role'   => 'administrator',
-				'locale' => 'de_DE',
-			)
-		);
-
-		wp_set_current_user( $user_id );
+		wp_set_current_user( self::$user_id );
 		set_current_screen( 'dashboard' );
 
 		// Reset $wp_locale_switcher so it thinks es_ES is the original locale.
@@ -382,14 +409,7 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 
 		$site_locale = get_locale();
 
-		$user_id = self::factory()->user->create(
-			array(
-				'role'   => 'administrator',
-				'locale' => 'de_DE',
-			)
-		);
-
-		wp_set_current_user( $user_id );
+		wp_set_current_user( self::$user_id );
 		set_current_screen( 'dashboard' );
 
 		// Reset $wp_locale_switcher so it thinks es_ES is the original locale.
@@ -430,14 +450,8 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 	public function test_multiple_switches_to_site_locale_and_user_locale() {
 		$site_locale = get_locale();
 
-		$user_id = self::factory()->user->create(
-			array(
-				'role'   => 'administrator',
-				'locale' => 'en_GB',
-			)
-		);
-
-		wp_set_current_user( $user_id );
+		wp_set_current_user( self::$user_id );
+		update_user_meta( self::$user_id, 'locale', 'en_GB' );
 		set_current_screen( 'dashboard' );
 
 		$user_locale = get_user_locale();
@@ -583,6 +597,105 @@ class Tests_L10n_wpLocaleSwitcher extends WP_UnitTestCase {
 		$this->assertSame( 'Este es un plugin dummy', $actual_es_es );
 	}
 
+	/**
+	 * @ticket 57123
+	 *
+	 * @covers ::switch_to_locale
+	 * @covers ::switch_to_user_locale
+	 * @covers WP_Locale_Switcher::get_switched_locale
+	 * @covers WP_Locale_Switcher::get_switched_user_id
+	 */
+	public function test_returns_current_locale_and_user_after_switching() {
+		global $wp_locale_switcher;
+
+		$user_2 = self::factory()->user->create(
+			array(
+				'role'   => 'administrator',
+				'locale' => 'es_ES',
+			)
+		);
+
+		$locale_1  = $wp_locale_switcher->get_switched_locale();
+		$user_id_1 = $wp_locale_switcher->get_switched_user_id();
+
+		switch_to_user_locale( self::$user_id );
+
+		$locale_2  = $wp_locale_switcher->get_switched_locale();
+		$user_id_2 = $wp_locale_switcher->get_switched_user_id();
+
+		switch_to_locale( 'en_GB' );
+
+		$locale_3  = $wp_locale_switcher->get_switched_locale();
+		$user_id_3 = $wp_locale_switcher->get_switched_user_id();
+
+		switch_to_user_locale( $user_2 );
+
+		$locale_4  = $wp_locale_switcher->get_switched_locale();
+		$user_id_4 = $wp_locale_switcher->get_switched_user_id();
+
+		restore_current_locale();
+
+		$locale_5  = $wp_locale_switcher->get_switched_locale();
+		$user_id_5 = $wp_locale_switcher->get_switched_user_id();
+
+		$this->assertFalse( $locale_1, 'Locale should be false before switching' );
+		$this->assertFalse( $user_id_1, 'User ID should be false before switching' );
+
+		$this->assertSame( 'de_DE', $locale_2, 'The locale was not changed to de_DE' );
+		$this->assertSame( self::$user_id, $user_id_2, 'User ID should match the main admin ID' );
+
+		$this->assertSame( 'en_GB', $locale_3, 'The locale was not changed to en_GB' );
+		$this->assertFalse( $user_id_3, 'User ID should be false after normal locale switching' );
+
+		$this->assertSame( 'es_ES', $locale_4, 'The locale was not changed to es_ES' );
+		$this->assertSame( $user_2, $user_id_4, 'User ID should match the second admin ID' );
+
+		$this->assertFalse( $locale_5, 'Locale should be false after restoring' );
+		$this->assertFalse( $user_id_5, 'User ID should be false after restoring' );
+	}
+
+	/**
+	 * @ticket 57123
+	 *
+	 * @covers ::switch_to_locale
+	 * @covers ::switch_to_user_locale
+	 * @covers WP_Locale_Switcher::get_switched_locale
+	 * @covers WP_Locale_Switcher::get_switched_user_id
+	 */
+	public function test_returns_previous_locale_and_user_after_switching() {
+		global $wp_locale_switcher;
+
+		$locale_1  = $wp_locale_switcher->get_switched_locale();
+		$user_id_1 = $wp_locale_switcher->get_switched_user_id();
+
+		switch_to_user_locale( self::$user_id );
+
+		$locale_2  = $wp_locale_switcher->get_switched_locale();
+		$user_id_2 = $wp_locale_switcher->get_switched_user_id();
+
+		switch_to_locale( 'en_GB' );
+
+		$locale_3  = $wp_locale_switcher->get_switched_locale();
+		$user_id_3 = $wp_locale_switcher->get_switched_user_id();
+
+		restore_previous_locale();
+
+		$locale_4  = $wp_locale_switcher->get_switched_locale();
+		$user_id_4 = $wp_locale_switcher->get_switched_user_id();
+
+		$this->assertFalse( $locale_1, 'Locale should be false before switching' );
+		$this->assertFalse( $user_id_1, 'User ID should be false before switching' );
+
+		$this->assertSame( 'de_DE', $locale_2, 'The locale was not changed to de_DE' );
+		$this->assertSame( self::$user_id, $user_id_2, 'User ID should match the main admin ID' );
+
+		$this->assertSame( 'en_GB', $locale_3, 'The locale was not changed to en_GB' );
+		$this->assertFalse( $user_id_3, 'User ID should be false after normal locale switching' );
+
+		$this->assertSame( 'de_DE', $locale_4, 'The locale was not changed back to de_DE' );
+		$this->assertSame( self::$user_id, $user_id_4, 'User ID should match the main admin ID again' );
+	}
+
 	public function filter_locale() {
 		return 'es_ES';
 	}
diff --git a/tests/link/getNextPostsLink.php b/tests/link/getNextPostsLink.php
new file mode 100644
index 0000000000..8df7d10ff0
--- /dev/null
+++ b/tests/link/getNextPostsLink.php
@@ -0,0 +1,46 @@
+<?php
+
+/**
+ * Tests the `get_next_posts_link()` function.
+ *
+ * @since 6.2.0
+ *
+ * @group link
+ *
+ * @covers ::get_next_posts_link
+ */
+class Tests_Link_GetNextPostsLink extends WP_UnitTestCase {
+
+	/**
+	 * Creates posts before any tests run.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		global $wp_query, $paged;
+
+		$factory->post->create_many( 3 );
+		$paged    = 2;
+		$wp_query = new WP_Query(
+			array(
+				'post_type'      => 'post',
+				'posts_per_page' => 1,
+				'paged'          => $paged,
+			)
+		);
+	}
+
+	/**
+	 * Tests that the 'next_posts_link_attributes' filter is applied correctly.
+	 *
+	 * @ticket 55751
+	 */
+	public function test_get_next_posts_link_should_apply_next_posts_link_attributes_filter() {
+		$filter = new MockAction();
+		add_filter( 'next_posts_link_attributes', array( &$filter, 'filter' ) );
+
+		get_next_posts_link();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+}
diff --git a/tests/link/getPreviousPostsLink.php b/tests/link/getPreviousPostsLink.php
new file mode 100644
index 0000000000..ea7220b2dc
--- /dev/null
+++ b/tests/link/getPreviousPostsLink.php
@@ -0,0 +1,46 @@
+<?php
+
+/**
+ * Tests the `get_previous_posts_link()` function.
+ *
+ * @since 6.2.0
+ *
+ * @group link
+ *
+ * @covers ::get_previous_posts_link
+ */
+class Tests_Link_GetPreviousPostsLink extends WP_UnitTestCase {
+
+	/**
+	 * Creates posts before any tests run.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		global $wp_query, $paged;
+
+		$factory->post->create_many( 3 );
+		$paged    = 2;
+		$wp_query = new WP_Query(
+			array(
+				'post_type'      => 'post',
+				'posts_per_page' => 1,
+				'paged'          => $paged,
+			)
+		);
+	}
+
+	/**
+	 * Tests that the 'previous_posts_link_attributes' filter is applied correctly.
+	 *
+	 * @ticket 55751
+	 */
+	public function test_get_previous_posts_link_should_apply_previous_posts_link_attributes_filter() {
+		$filter = new MockAction();
+		add_filter( 'previous_posts_link_attributes', array( &$filter, 'filter' ) );
+
+		get_previous_posts_link();
+
+		$this->assertSame( 1, $filter->get_call_count() );
+	}
+}
diff --git a/tests/link/getThePostsNavigation.php b/tests/link/getThePostsNavigation.php
new file mode 100644
index 0000000000..83c262d911
--- /dev/null
+++ b/tests/link/getThePostsNavigation.php
@@ -0,0 +1,108 @@
+<?php
+
+/**
+ * Tests the `get_the_posts_navigation()` function.
+ *
+ * @since 6.2.0
+ *
+ * @group link
+ *
+ * @covers ::get_the_posts_navigation
+ */
+class Tests_Link_GetThePostsNavigation extends WP_UnitTestCase {
+
+	/**
+	 * Creates posts before any tests run.
+	 *
+	 * @param WP_UnitTest_Factory $factory
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		$factory->post->create_many( 3 );
+	}
+
+	/**
+	 * Tests that get_the_posts_navigation() only includes the "Older posts" and "Newer" posts
+	 * links when appropriate.
+	 *
+	 * @ticket 55751
+	 *
+	 * @dataProvider data_get_the_posts_navigation
+	 *
+	 * @param int  $per_page  Posts per page to be queried.
+	 * @param int  $paged_num Pagination page number.
+	 * @param bool $older     Whether an "Older posts" link should be included.
+	 * @param bool $newer     Whether a "Newer posts" link should be included.
+	 */
+	public function test_get_the_posts_navigation( $per_page, $paged_num, $older, $newer ) {
+		global $wp_query, $paged;
+
+		$paged    = $paged_num;
+		$wp_query = new WP_Query(
+			array(
+				'post_type'      => 'post',
+				'posts_per_page' => $per_page,
+				'paged'          => $paged,
+			)
+		);
+
+		$actual = get_the_posts_navigation();
+
+		if ( $older ) {
+			$this->assertStringContainsString(
+				'Older posts',
+				$actual,
+				'Posts navigation must contain an "Older posts" link.'
+			);
+		}
+
+		if ( $newer ) {
+			$this->assertStringContainsString(
+				'Newer posts',
+				$actual,
+				'Posts navigation must contain a "Newer posts" link.'
+			);
+		}
+
+		if ( ! $older && ! $newer ) {
+			$this->assertEmpty(
+				$actual,
+				'Posts navigation must be an empty string.'
+			);
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_the_posts_navigation() {
+		return array(
+			'older posts'                 => array(
+				'post_per_page' => 1,
+				'paged_num'     => 1,
+				'older'         => true,
+				'newer'         => false,
+			),
+			'newer posts'                 => array(
+				'post_per_page' => 1,
+				'paged_num'     => 3,
+				'older'         => false,
+				'newer'         => true,
+			),
+			'newer posts and older posts' => array(
+				'post_per_page' => 1,
+				'paged_num'     => 2,
+				'older'         => true,
+				'newer'         => true,
+			),
+			'empty posts'                 => array(
+				'post_per_page' => 3,
+				'paged_num'     => 1,
+				'older'         => false,
+				'newer'         => false,
+			),
+		);
+	}
+
+}
diff --git a/tests/link/getThePrivacyPolicyLink.php b/tests/link/getThePrivacyPolicyLink.php
index 942ae20c41..ca489bf177 100644
--- a/tests/link/getThePrivacyPolicyLink.php
+++ b/tests/link/getThePrivacyPolicyLink.php
@@ -1,20 +1,14 @@
 <?php
 /**
- * Define a class to test the `get_the_privacy_policy_link()` function.
+ * Test cases for the `get_the_privacy_policy_link()` function.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.9.6
- */
-
-/**
- * Test cases for the `get_the_privacy_policy_link()` function.
  *
  * @group link
  * @group privacy
  * @covers ::get_the_privacy_policy_link
- *
- * @since 4.9.6
  */
 class Tests_Link_GetThePrivacyPolicyLink extends WP_UnitTestCase {
 	/**
@@ -160,4 +154,15 @@ class Tests_Link_GetThePrivacyPolicyLink extends WP_UnitTestCase {
 	public static function modify_link_markup( $link, $privacy_policy_url ) {
 		return 'Policy: ' . $privacy_policy_url;
 	}
+
+	/**
+	 * Tests that `get_the_privacy_policy_link()` adds `rel="privacy-policy"`.
+	 *
+	 * @ticket 56345
+	 */
+	public function test_get_the_privacy_policy_link_should_add_rel_privacy_policy() {
+		update_option( 'wp_page_for_privacy_policy', self::$privacy_policy_page_id );
+
+		$this->assertStringContainsString( 'rel="privacy-policy"', get_the_privacy_policy_link() );
+	}
 }
diff --git a/tests/load/wpDebugMode.php b/tests/load/wpDebugMode.php
index d527235e55..f873ad9069 100644
--- a/tests/load/wpDebugMode.php
+++ b/tests/load/wpDebugMode.php
@@ -6,16 +6,10 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.9.0
- */
-
-/**
- * Class Test_WP_Debug_Mode.
  *
  * @group load.php
  * @group wp-debug-mode
  * @covers ::wp_debug_mode
- *
- * @since 5.9.0
  */
 class Test_WP_Debug_Mode extends WP_UnitTestCase {
 	/**
diff --git a/tests/locale.php b/tests/locale.php
index a3a100547e..b672d08121 100644
--- a/tests/locale.php
+++ b/tests/locale.php
@@ -173,6 +173,62 @@ class Tests_Locale extends WP_UnitTestCase {
 		$this->locale->text_direction = 'ltr';
 		$this->assertFalse( $this->locale->is_rtl() );
 	}
+
+	/**
+	 * Tests that `WP_Locale::get_word_count_type()` returns
+	 * the appropriate value.
+	 *
+	 * @ticket 56698
+	 *
+	 * @covers WP_Locale::get_word_count_type
+	 *
+	 * @dataProvider data_get_word_count_type
+	 *
+	 * @param string $word_count_type The word count type.
+	 * @param string $expected        The expected return value.
+	 */
+	public function test_get_word_count_type( $word_count_type, $expected ) {
+		if ( is_string( $word_count_type ) ) {
+			$this->locale->word_count_type = $word_count_type;
+
+		}
+
+		$this->assertSame( $expected, $this->locale->get_word_count_type() );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_word_count_type() {
+		return array(
+			'default'                   => array(
+				'word_count_type' => null,
+				'expected'        => 'words',
+			),
+			'empty string'              => array(
+				'word_count_type' => '',
+				'expected'        => 'words',
+			),
+			'an invalid option - "foo"' => array(
+				'word_count_type' => 'foo',
+				'expected'        => 'words',
+			),
+			'a valid option - "words"'  => array(
+				'word_count_type' => 'words',
+				'expected'        => 'words',
+			),
+			'a valid option - "characters_excluding_spaces"' => array(
+				'word_count_type' => 'characters_excluding_spaces',
+				'expected'        => 'characters_excluding_spaces',
+			),
+			'a valid option - "characters_including_spaces"' => array(
+				'word_count_type' => 'characters_including_spaces',
+				'expected'        => 'characters_including_spaces',
+			),
+		);
+	}
 }
 
 class Custom_WP_Locale extends WP_Locale {
diff --git a/tests/media.php b/tests/media.php
index 5165e32b85..1817af955b 100644
--- a/tests/media.php
+++ b/tests/media.php
@@ -3278,6 +3278,81 @@ EOF;
 		$this->assertStringNotContainsString( ' loading=', $img );
 	}
 
+	/**
+	 * @ticket 57086
+	 *
+	 * @dataProvider data_wp_get_attachment_image_decoding_attr
+	 *
+	 * @covers ::wp_get_attachment_image
+	 */
+	public function test_wp_get_attachment_image_decoding_attr( $decoding, $expected ) {
+		if ( 'no value' === $decoding ) {
+			$image = wp_get_attachment_image( self::$large_id, 'thumbnail', false, array() );
+		} else {
+			$image = wp_get_attachment_image( self::$large_id, 'thumbnail', false, array( 'decoding' => $decoding ) );
+		}
+
+		if ( 'no value' === $expected ) {
+			$this->assertStringNotContainsString( ' decoding=', $image );
+		} else {
+			$this->assertStringContainsString( ' decoding="' . esc_attr( $expected ) . '"', $image );
+		}
+	}
+
+	/**
+	 * Data provider for test_wp_get_attachment_image_decoding_attr().
+	 *
+	 * @return array[]
+	 */
+	public function data_wp_get_attachment_image_decoding_attr() {
+		return array(
+			'default'     => array(
+				'decoding' => 'no value',
+				'expected' => 'async',
+			),
+			'async'       => array(
+				'decoding' => 'async',
+				'expected' => 'async',
+			),
+			'sync'        => array(
+				'decoding' => 'sync',
+				'expected' => 'sync',
+			),
+			'auto'        => array(
+				'decoding' => 'auto',
+				'expected' => 'auto',
+			),
+			'empty'       => array(
+				'decoding' => '',
+				'expected' => 'no value',
+			),
+			'false'       => array(
+				'decoding' => false,
+				'expected' => 'no value',
+			),
+			'null'        => array(
+				'decoding' => null,
+				'expected' => 'no value',
+			),
+			'zero'        => array(
+				'decoding' => 0,
+				'expected' => 'no value',
+			),
+			'zero string' => array(
+				'decoding' => '0',
+				'expected' => 'no value',
+			),
+			'zero float'  => array(
+				'decoding' => 0.0,
+				'expected' => 'no value',
+			),
+			'invalid'     => array(
+				'decoding' => 'invalid',
+				'expected' => 'no value',
+			),
+		);
+	}
+
 	/**
 	 * @ticket 44427
 	 * @ticket 50425
@@ -3472,7 +3547,13 @@ EOF;
 	}
 
 	/**
+	 * Tests that wp_get_loading_attr_default() returns the expected loading attribute value.
+	 *
 	 * @ticket 53675
+	 * @ticket 56930
+	 *
+	 * @covers ::wp_get_loading_attr_default
+	 *
 	 * @dataProvider data_wp_get_loading_attr_default
 	 *
 	 * @param string $context
@@ -3513,6 +3594,10 @@ EOF;
 			// Yes, for all subsequent elements.
 			$this->assertSame( 'lazy', wp_get_loading_attr_default( $context ) );
 		}
+
+		// Exceptions: In the following contexts, images shouldn't be lazy-loaded by default.
+		$this->assertFalse( wp_get_loading_attr_default( 'template' ), 'Images run through the overall block template filter should not be lazy-loaded.' );
+		$this->assertFalse( wp_get_loading_attr_default( 'template_part_' . WP_TEMPLATE_PART_AREA_HEADER ), 'Images in the footer block template part should not be lazy-loaded.' );
 	}
 
 	public function data_wp_get_loading_attr_default() {
@@ -3625,6 +3710,159 @@ EOF;
 		$this->assertSame( 3, $omit_threshold );
 	}
 
+	/**
+	 * Tests that wp_filter_content_tags() does not add loading="lazy" to the first
+	 * image in the loop when using a block theme.
+	 *
+	 * @ticket 56930
+	 *
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_get_loading_attr_default
+	 */
+	public function test_wp_filter_content_tags_does_not_lazy_load_first_image_in_block_theme() {
+		global $_wp_current_template_content, $wp_query, $wp_the_query, $post;
+
+		// Do not add srcset, sizes, or decoding attributes as they are irrelevant for this test.
+		add_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
+
+		$img1      = get_image_tag( self::$large_id, '', '', '', 'large' );
+		$img2      = get_image_tag( self::$large_id, '', '', '', 'medium' );
+		$lazy_img2 = wp_img_tag_add_loading_attr( $img2, 'the_content' );
+
+		// Only the second image should be lazy-loaded.
+		$post_content     = $img1 . $img2;
+		$expected_content = wpautop( $img1 . $lazy_img2 );
+
+		// Update the post to test with so that it has the above post content.
+		wp_update_post(
+			array(
+				'ID'                    => self::$post_ids['publish'],
+				'post_content'          => $post_content,
+				'post_content_filtered' => $post_content,
+			)
+		);
+
+		$wp_query     = new WP_Query( array( 'p' => self::$post_ids['publish'] ) );
+		$wp_the_query = $wp_query;
+		$post         = get_post( self::$post_ids['publish'] );
+		$this->reset_content_media_count();
+		$this->reset_omit_loading_attr_filter();
+
+		$_wp_current_template_content = '<!-- wp:post-content /-->';
+
+		$html = get_the_block_template_html();
+		$this->assertSame( '<div class="wp-site-blocks"><div class="entry-content wp-block-post-content is-layout-flow">' . $expected_content . '</div></div>', $html );
+	}
+
+	/**
+	 * Tests that wp_filter_content_tags() does not add loading="lazy"
+	 * to the featured image when using a block theme.
+	 *
+	 * @ticket 56930
+	 *
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_get_loading_attr_default
+	 */
+	public function test_wp_filter_content_tags_does_not_lazy_load_first_featured_image_in_block_theme() {
+		global $_wp_current_template_content, $wp_query, $wp_the_query, $post;
+
+		// Do not add srcset, sizes, or decoding attributes as they are irrelevant for this test.
+		add_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
+		add_filter(
+			'wp_get_attachment_image_attributes',
+			function( $attr ) {
+				unset( $attr['srcset'], $attr['sizes'], $attr['decoding'] );
+				return $attr;
+			}
+		);
+
+		$content_img      = get_image_tag( self::$large_id, '', '', '', 'large' );
+		$lazy_content_img = wp_img_tag_add_loading_attr( $content_img, 'the_content' );
+
+		// The featured image should not be lazy-loaded as it is the first image.
+		$featured_image_id = self::$large_id;
+		update_post_meta( self::$post_ids['publish'], '_thumbnail_id', $featured_image_id );
+		$expected_featured_image = '<figure class="wp-block-post-featured-image">' . get_the_post_thumbnail( self::$post_ids['publish'], 'post-thumbnail', array( 'loading' => false ) ) . '</figure>';
+
+		// The post content image should be lazy-loaded since the featured image appears above.
+		$post_content     = $content_img;
+		$expected_content = wpautop( $lazy_content_img );
+
+		// Update the post to test with so that it has the above post content.
+		wp_update_post(
+			array(
+				'ID'                    => self::$post_ids['publish'],
+				'post_content'          => $post_content,
+				'post_content_filtered' => $post_content,
+			)
+		);
+
+		$wp_query     = new WP_Query( array( 'p' => self::$post_ids['publish'] ) );
+		$wp_the_query = $wp_query;
+		$post         = get_post( self::$post_ids['publish'] );
+		$this->reset_content_media_count();
+		$this->reset_omit_loading_attr_filter();
+
+		$_wp_current_template_content = '<!-- wp:post-featured-image /--> <!-- wp:post-content /-->';
+
+		$html = get_the_block_template_html();
+		$this->assertSame( '<div class="wp-site-blocks">' . $expected_featured_image . ' <div class="entry-content wp-block-post-content is-layout-flow">' . $expected_content . '</div></div>', $html );
+	}
+
+	/**
+	 * Tests that wp_filter_content_tags() does not add loading="lazy" to images
+	 * in a "Header" template part.
+	 *
+	 * @ticket 56930
+	 *
+	 * @covers ::wp_filter_content_tags
+	 * @covers ::wp_get_loading_attr_default
+	 */
+	public function test_wp_filter_content_tags_does_not_lazy_load_images_in_header() {
+		global $_wp_current_template_content;
+
+		// Do not add srcset, sizes, or decoding attributes as they are irrelevant for this test.
+		add_filter( 'wp_img_tag_add_srcset_and_sizes_attr', '__return_false' );
+		add_filter( 'wp_img_tag_add_decoding_attr', '__return_false' );
+
+		// Use a single image for each header and footer template parts.
+		$header_img = get_image_tag( self::$large_id, '', '', '', 'large' );
+		$footer_img = get_image_tag( self::$large_id, '', '', '', 'medium' );
+
+		// Create header and footer template parts.
+		$header_post_id = self::factory()->post->create(
+			array(
+				'post_type'    => 'wp_template_part',
+				'post_status'  => 'publish',
+				'post_name'    => 'header',
+				'post_content' => $header_img,
+			)
+		);
+		wp_set_post_terms( $header_post_id, WP_TEMPLATE_PART_AREA_HEADER, 'wp_template_part_area' );
+		wp_set_post_terms( $header_post_id, get_stylesheet(), 'wp_theme' );
+		$footer_post_id = self::factory()->post->create(
+			array(
+				'post_type'    => 'wp_template_part',
+				'post_status'  => 'publish',
+				'post_name'    => 'footer',
+				'post_content' => $footer_img,
+			)
+		);
+		wp_set_post_terms( $footer_post_id, WP_TEMPLATE_PART_AREA_FOOTER, 'wp_template_part_area' );
+		wp_set_post_terms( $footer_post_id, get_stylesheet(), 'wp_theme' );
+
+		$_wp_current_template_content = '<!-- wp:template-part {"slug":"header","theme":"' . get_stylesheet() . '","tagName":"header"} /--><!-- wp:template-part {"slug":"footer","theme":"' . get_stylesheet() . '","tagName":"footer"} /-->';
+
+		// Header image should not be lazy-loaded, footer image should be lazy-loaded.
+		$expected_template_content  = '<header class="wp-block-template-part">' . $header_img . '</header>';
+		$expected_template_content .= '<footer class="wp-block-template-part">' . wp_img_tag_add_loading_attr( $footer_img, 'force-lazy' ) . '</footer>';
+
+		$html = get_the_block_template_html();
+		$this->assertSame( '<div class="wp-site-blocks">' . $expected_template_content . '</div>', $html );
+	}
+
 	private function reset_content_media_count() {
 		// Get current value without increasing.
 		$content_media_count = wp_increase_content_media_count( 0 );
@@ -3695,6 +3933,46 @@ EOF;
 		}
 	}
 
+	/**
+	 * Test that an image size isn't generated if it matches the original image size.
+	 *
+	 * @ticket 57370
+	 */
+	public function test_wp_generate_attachment_metadata_doesnt_generate_sizes_for_150_square_image() {
+		$temp_dir = get_temp_dir();
+		$file     = $temp_dir . '/test-square-150.jpg';
+		copy( DIR_TESTDATA . '/images/test-square-150.jpg', $file );
+
+		$attachment_id = self::factory()->attachment->create_object(
+			array(
+				'post_mime_type' => 'image/jpeg',
+				'file'           => $file,
+			)
+		);
+
+		$metadata = wp_generate_attachment_metadata( $attachment_id, $file );
+		$this->assertSame(
+			array(),
+			$metadata['sizes'],
+			'The sizes should be an empty array'
+		);
+		$this->assertSame(
+			'test-square-150.jpg',
+			basename( $metadata['file'] ),
+			'The file basename should match the given filename'
+		);
+		$this->assertSame(
+			150,
+			$metadata['width'],
+			'The width should be 150 (integer)'
+		);
+		$this->assertSame(
+			150,
+			$metadata['height'],
+			'The height should be 150 (integer)'
+		);
+	}
+
 	/**
 	 * Add threshold to create a `-scaled` output image for testing.
 	 */
diff --git a/tests/menu/walker-nav-menu.php b/tests/menu/walker-nav-menu.php
index 1dda827c1e..0c38502f9e 100644
--- a/tests/menu/walker-nav-menu.php
+++ b/tests/menu/walker-nav-menu.php
@@ -152,4 +152,217 @@ class Tests_Menu_Walker_Nav_Menu extends WP_UnitTestCase {
 			),
 		);
 	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::start_el()` adds `rel="privacy-policy"`.
+	 *
+	 * @ticket 56345
+	 *
+	 * @covers Walker_Nav_Menu::start_el
+	 *
+	 * @dataProvider data_walker_nav_menu_start_el_should_add_rel_privacy_policy_to_privacy_policy_url
+	 *
+	 * @param string $expected The expected substring containing the "rel" attribute and value.
+	 * @param string $xfn      Optional. The XFN value. Default empty string.
+	 * @param string $target   Optional. The target value. Default empty string.
+	 */
+	public function test_walker_nav_menu_start_el_should_add_rel_privacy_policy_to_privacy_policy_url( $expected, $xfn = '', $target = '' ) {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_title'  => 'Test Privacy Policy',
+				'post_status' => 'publish',
+			)
+		);
+
+		// Set the privacy policy page.
+		update_option( 'wp_page_for_privacy_policy', $post_id );
+		$privacy_policy_id = (int) get_option( 'wp_page_for_privacy_policy' );
+
+		$output = '';
+
+		$item = array(
+			'ID'        => $privacy_policy_id,
+			'object_id' => $privacy_policy_id,
+			'title'     => 'Privacy Policy',
+			'target'    => $target,
+			'xfn'       => $xfn,
+			'current'   => false,
+			'url'       => get_privacy_policy_url(),
+		);
+
+		$args = array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$this->walker->start_el( $output, (object) $item, 0, (object) $args );
+
+		$this->assertStringContainsString( $expected, $output );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_walker_nav_menu_start_el_should_add_rel_privacy_policy_to_privacy_policy_url() {
+		return array(
+			'no xfn value'                          => array(
+				'expected' => 'rel="privacy-policy"',
+			),
+			'an xfn value'                          => array(
+				'expected' => 'rel="nofollow privacy-policy"',
+				'xfn'      => 'nofollow',
+			),
+			'no xfn value and a target of "_blank"' => array(
+				'expected' => 'rel="noopener privacy-policy"',
+				'xfn'      => '',
+				'target'   => '_blank',
+			),
+			'an xfn value and a target of "_blank"' => array(
+				'expected' => 'rel="nofollow privacy-policy"',
+				'xfn'      => 'nofollow',
+				'target'   => '_blank',
+			),
+		);
+	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::start_el()` does not add `rel="privacy-policy"` when no
+	 * privacy policy page exists.
+	 *
+	 * @ticket 56345
+	 *
+	 * @covers Walker_Nav_Menu::start_el
+	 */
+	public function test_walker_nav_menu_start_el_should_not_add_rel_privacy_policy_when_no_privacy_policy_exists() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_title'  => 'Test Privacy Policy',
+				'post_status' => 'publish',
+			)
+		);
+
+		// Do not set the privacy policy page.
+
+		$output = '';
+
+		$item = array(
+			'ID'        => $post_id,
+			'object_id' => $post_id,
+			'title'     => 'Privacy Policy',
+			'target'    => '',
+			'xfn'       => '',
+			'current'   => false,
+			'url'       => get_the_permalink( $post_id ),
+		);
+
+		$args = array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$this->walker->start_el( $output, (object) $item, 0, (object) $args );
+
+		$this->assertStringNotContainsString( 'rel="privacy-policy"', $output );
+	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::start_el()` does not add `rel="privacy-policy"` when no URL
+	 * is passed in the menu item object.
+	 *
+	 * @ticket 56345
+	 *
+	 * @covers Walker_Nav_Menu::start_el
+	 */
+	public function test_walker_nav_menu_start_el_should_not_add_rel_privacy_policy_when_no_url_is_passed() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_title'  => 'Test Privacy Policy',
+				'post_status' => 'publish',
+			)
+		);
+
+		// Set the privacy policy page.
+		update_option( 'wp_page_for_privacy_policy', $post_id );
+		$privacy_policy_id = (int) get_option( 'wp_page_for_privacy_policy' );
+
+		$output = '';
+
+		$item = array(
+			'ID'        => $privacy_policy_id,
+			'object_id' => $privacy_policy_id,
+			'title'     => 'Privacy Policy',
+			'target'    => '',
+			'xfn'       => '',
+			'current'   => false,
+			// Do not pass URL.
+		);
+
+		$args = array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$this->walker->start_el( $output, (object) $item, 0, (object) $args );
+
+		$this->assertStringNotContainsString( 'rel="privacy-policy"', $output );
+	}
+
+	/**
+	 * Tests that `Walker_Nav_Menu::start_el()` does not add `rel="privacy-policy"` when the
+	 * menu item's ID does not match the privacy policy page, but the URL does.
+	 *
+	 * @ticket 56345
+	 *
+	 * @covers Walker_Nav_Menu::start_el
+	 */
+	public function test_walker_nav_menu_start_el_should_add_rel_privacy_policy_when_id_does_not_match_but_url_does() {
+		$post_id = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_title'  => 'Test Privacy Policy',
+				'post_status' => 'publish',
+			)
+		);
+
+		// Set the privacy policy page.
+		update_option( 'wp_page_for_privacy_policy', $post_id );
+		$privacy_policy_id = (int) get_option( 'wp_page_for_privacy_policy' );
+
+		$output = '';
+
+		// Ensure the ID does not match the privacy policy.
+		$not_privacy_policy_id = $privacy_policy_id - 1;
+
+		$item = array(
+			'ID'        => $not_privacy_policy_id,
+			'object_id' => $not_privacy_policy_id,
+			'title'     => 'Privacy Policy',
+			'target'    => '',
+			'xfn'       => '',
+			'current'   => false,
+			'url'       => get_privacy_policy_url(),
+		);
+
+		$args = array(
+			'before'      => '',
+			'after'       => '',
+			'link_before' => '',
+			'link_after'  => '',
+		);
+
+		$this->walker->start_el( $output, (object) $item, 0, (object) $args );
+
+		$this->assertStringContainsString( 'rel="privacy-policy"', $output );
+	}
 }
diff --git a/tests/menu/wp-nav-menu.php b/tests/menu/wp-nav-menu.php
index 08f105be9a..298b222e01 100644
--- a/tests/menu/wp-nav-menu.php
+++ b/tests/menu/wp-nav-menu.php
@@ -197,4 +197,52 @@ class Tests_Menu_wpNavMenu extends WP_UnitTestCase {
 			'Level 3 should not be present in the HTML output.'
 		);
 	}
+
+	/**
+	 * The order in which parent/child menu items are created should not matter.
+	 *
+	 * @ticket 57122
+	 */
+	public function test_parent_with_higher_id_should_not_error() {
+		// Create a new level zero menu item.
+		$new_lvl0_menu_item = wp_update_nav_menu_item(
+			self::$menu_id,
+			0,
+			array(
+				'menu-item-title'  => 'Root menu item with high ID',
+				'menu-item-url'    => '#',
+				'menu-item-status' => 'publish',
+			)
+		);
+
+		// Reparent level 1 menu item to the new level zero menu item.
+		self::$lvl1_menu_item = wp_update_nav_menu_item(
+			self::$menu_id,
+			self::$lvl1_menu_item,
+			array(
+				'menu-item-parent-id' => $new_lvl0_menu_item,
+			)
+		);
+
+		// Delete the old level zero menu item.
+		wp_delete_post( self::$lvl0_menu_item, true );
+
+		// Render the menu.
+		$menu_html = wp_nav_menu(
+			array(
+				'menu' => self::$menu_id,
+				'echo' => false,
+			)
+		);
+
+		$this->assertStringContainsString(
+			sprintf(
+				'<li id="menu-item-%1$d" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-%1$d">',
+				$new_lvl0_menu_item
+			),
+			$menu_html,
+			'The level zero menu item should appear in the menu.'
+		);
+
+	}
 }
diff --git a/tests/meta/isProtectedMeta.php b/tests/meta/isProtectedMeta.php
index 46f20e72fa..ba3eeed9a2 100644
--- a/tests/meta/isProtectedMeta.php
+++ b/tests/meta/isProtectedMeta.php
@@ -7,13 +7,13 @@
 class Tests_Meta_isProtectedMeta extends WP_UnitTestCase {
 
 	/**
-	 * @dataProvider protected_data
+	 * @dataProvider data_is_protected_meta_true
 	 */
-	public function test_protected( $key ) {
+	public function test_is_protected_meta_true( $key ) {
 		$this->assertTrue( is_protected_meta( $key ) );
 	}
 
-	public function protected_data() {
+	public function data_is_protected_meta_true() {
 		$protected_keys = array(
 			array( '_wp_attachment' ),
 		);
@@ -29,13 +29,13 @@ class Tests_Meta_isProtectedMeta extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider unprotected_data
+	 * @dataProvider data_is_protected_meta_false
 	 */
-	public function test_unprotected( $key ) {
+	public function test_is_protected_meta_false( $key ) {
 		$this->assertFalse( is_protected_meta( $key ) );
 	}
 
-	public function unprotected_data() {
+	public function data_is_protected_meta_false() {
 		$unprotected_keys = array(
 			array( 'singleword' ),
 			array( 'two_words' ),
diff --git a/tests/multisite/updatePostsCount.php b/tests/multisite/updatePostsCount.php
index 270ac60c49..bf3fcb879f 100644
--- a/tests/multisite/updatePostsCount.php
+++ b/tests/multisite/updatePostsCount.php
@@ -30,7 +30,7 @@ if ( is_multisite() ) :
 
 			$post_count_after_creating = get_site()->post_count;
 
-			wp_delete_post( $post_id );
+			wp_delete_post( $post_id, true );
 
 			$post_count_after_deleting = get_site()->post_count;
 
@@ -47,7 +47,7 @@ if ( is_multisite() ) :
 
 			/*
 			 * Check that posts count is updated when a post is deleted:
-			 * add_action( 'deleted_post', '_update_posts_count_on_delete' );
+			 * add_action( 'after_delete_post', '_update_posts_count_on_delete', 10, 2 );
 			 *
 			 * Check that _update_posts_count_on_delete() is called on that filter,
 			 * which then calls update_posts_count() to update the count.
diff --git a/tests/oembed/filterResult.php b/tests/oembed/filterResult.php
index 0267bded34..543d336cb9 100644
--- a/tests/oembed/filterResult.php
+++ b/tests/oembed/filterResult.php
@@ -93,7 +93,7 @@ EOD;
 		$this->assertSame( '<blockquote class="wp-embedded-content"><a href=""></a></blockquote><iframe class="wp-embedded-content" sandbox="allow-scripts" security="restricted" style="position: absolute; clip: rect(1px, 1px, 1px, 1px);"></iframe>', $actual );
 	}
 
-	public function _data_oembed_test_strings() {
+	public function data_wp_filter_pre_oembed_custom_result() {
 		return array(
 			array(
 				'<blockquote></blockquote><iframe title=""></iframe>',
@@ -115,7 +115,7 @@ EOD;
 	}
 
 	/**
-	 * @dataProvider _data_oembed_test_strings
+	 * @dataProvider data_wp_filter_pre_oembed_custom_result
 	 */
 	public function test_wp_filter_pre_oembed_custom_result( $html, $expected ) {
 		$data   = (object) array(
diff --git a/tests/option/sanitizeOption.php b/tests/option/sanitizeOption.php
index dec3cf7ced..e50cec0c62 100644
--- a/tests/option/sanitizeOption.php
+++ b/tests/option/sanitizeOption.php
@@ -5,6 +5,14 @@
  */
 class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 
+	/**
+	 * @dataProvider data_sanitize_option
+	 *
+	 * @covers ::sanitize_option
+	 */
+	public function test_sanitize_option( $option_name, $sanitized, $original ) {
+		$this->assertSame( $sanitized, sanitize_option( $option_name, $original ) );
+	}
 	/**
 	 * Data provider to test all of the sanitize_option() case
 	 *
@@ -12,7 +20,7 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function sanitize_option_provider() {
+	public function data_sanitize_option() {
 		return array(
 			array( 'admin_email', 'mail@example.com', 'mail@example.com' ),
 			array( 'admin_email', get_option( 'admin_email' ), 'invalid' ),
@@ -86,15 +94,15 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider sanitize_option_provider
+	 * @dataProvider data_sanitize_option_upload_path
 	 *
 	 * @covers ::sanitize_option
 	 */
-	public function test_sanitize_option( $option_name, $sanitized, $original ) {
-		$this->assertSame( $sanitized, sanitize_option( $option_name, $original ) );
+	public function test_sanitize_option_upload_path( $provided, $expected ) {
+		$this->assertSame( $expected, sanitize_option( 'upload_path', $provided ) );
 	}
 
-	public function upload_path_provider() {
+	public function data_sanitize_option_upload_path() {
 		return array(
 			array( '<a href="http://www.example.com">Link</a>', 'Link' ),
 			array( '<scr' . 'ipt>url</scr' . 'ipt>', 'url' ),
@@ -103,15 +111,6 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 		);
 	}
 
-	/**
-	 * @dataProvider upload_path_provider
-	 *
-	 * @covers ::sanitize_option
-	 */
-	public function test_sanitize_option_upload_path( $provided, $expected ) {
-		$this->assertSame( $expected, sanitize_option( 'upload_path', $provided ) );
-	}
-
 	/**
 	 * @ticket 36122
 	 *
@@ -133,12 +132,12 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider permalink_structure_provider
+	 * @dataProvider data_sanitize_option_permalink_structure
 	 *
 	 * @covers ::sanitize_option
 	 * @covers ::get_settings_errors
 	 */
-	public function test_sanitize_permalink_structure( $provided, $expected, $valid ) {
+	public function test_sanitize_option_permalink_structure( $provided, $expected, $valid ) {
 		global $wp_settings_errors;
 
 		$old_wp_settings_errors = (array) $wp_settings_errors;
@@ -159,7 +158,7 @@ class Tests_Option_SanitizeOption extends WP_UnitTestCase {
 		$this->assertEquals( $expected, $actual );
 	}
 
-	public function permalink_structure_provider() {
+	public function data_sanitize_option_permalink_structure() {
 		return array(
 			array( '', '', true ),
 			array( '%postname', false, false ),
diff --git a/tests/option/wpLoadAlloptions.php b/tests/option/wpLoadAlloptions.php
index b012e72435..56533255fb 100644
--- a/tests/option/wpLoadAlloptions.php
+++ b/tests/option/wpLoadAlloptions.php
@@ -120,4 +120,31 @@ class Tests_Option_wpLoadAlloptions extends WP_UnitTestCase {
 		$this->alloptions = $alloptions;
 		return $this->alloptions;
 	}
+
+	/**
+	 * Tests that `$alloptions` can be filtered with a custom value, short circuiting `wp_load_alloptions()`.
+	 *
+	 * @ticket 56045
+	 *
+	 * @covers ::wp_load_alloptions
+	 */
+	public function test_filter_pre_wp_load_alloptions_filter_is_called() {
+		$filter = new MockAction();
+
+		add_filter( 'pre_wp_load_alloptions', array( &$filter, 'filter' ) );
+
+		wp_load_alloptions();
+
+		$this->assertSame(
+			1,
+			$filter->get_call_count(),
+			'The filter was not called 1 time.'
+		);
+
+		$this->assertSame(
+			array( 'pre_wp_load_alloptions' ),
+			$filter->get_hook_names(),
+			'The hook name was incorrect.'
+		);
+	}
 }
diff --git a/tests/pluggable/signatures.php b/tests/pluggable/signatures.php
index 46523b1d1b..c63de073d9 100644
--- a/tests/pluggable/signatures.php
+++ b/tests/pluggable/signatures.php
@@ -15,21 +15,21 @@ class Tests_Pluggable_Signatures extends WP_UnitTestCase {
 	 *
 	 * @dataProvider get_defined_pluggable_functions
 	 */
-	public function test_pluggable_function_signatures_match( $function ) {
+	public function test_pluggable_function_signatures_match( $function_name ) {
 
 		$signatures = $this->get_pluggable_function_signatures();
 
-		$this->assertTrue( function_exists( $function ) );
-		$this->assertArrayHasKey( $function, $signatures );
+		$this->assertTrue( function_exists( $function_name ) );
+		$this->assertArrayHasKey( $function_name, $signatures );
 
-		$function_ref = new ReflectionFunction( $function );
+		$function_ref = new ReflectionFunction( $function_name );
 		$param_refs   = $function_ref->getParameters();
 
-		$this->assertSame( count( $signatures[ $function ] ), count( $param_refs ) );
+		$this->assertSame( count( $signatures[ $function_name ] ), count( $param_refs ) );
 
 		$i = 0;
 
-		foreach ( $signatures[ $function ] as $name => $value ) {
+		foreach ( $signatures[ $function_name ] as $name => $value ) {
 
 			$param_ref = $param_refs[ $i ];
 			$msg       = 'Parameter: ' . $param_ref->getName();
diff --git a/tests/pluggable/wpRand.php b/tests/pluggable/wpRand.php
index 9fcfa8bde1..a6bcf347f8 100644
--- a/tests/pluggable/wpRand.php
+++ b/tests/pluggable/wpRand.php
@@ -20,7 +20,7 @@ class Tests_Pluggable_wpRand extends WP_UnitTestCase {
 		$this->assertGreaterThanOrEqual(
 			0,
 			wp_rand( $min, $max ),
-			'The value was not greater than or equal 0'
+			'The value was not greater than or equal to 0'
 		);
 
 		$this->assertLessThan(
diff --git a/tests/pomo/pluralForms.php b/tests/pomo/pluralForms.php
index 0d5cc192a5..0343302c68 100644
--- a/tests/pomo/pluralForms.php
+++ b/tests/pomo/pluralForms.php
@@ -39,15 +39,38 @@ class PluralFormsTest extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 41562
+	 * @dataProvider data_locales
 	 * @group external-http
 	 */
-	public function test_locales_provider() {
-		$locales = self::locales_provider();
+	public function test_regression( $lang, $nplurals, $expression ) {
+		require_once dirname( dirname( __DIR__ ) ) . '/includes/plural-form-function.php';
+
+		$parenthesized = self::parenthesize_plural_expression( $expression );
+		$old_style     = tests_make_plural_form_function( $nplurals, $parenthesized );
+		$plural_forms  = new Plural_Forms( $expression );
+
+		$generated_old = array();
+		$generated_new = array();
+
+		foreach ( range( 0, 200 ) as $i ) {
+			$generated_old[] = $old_style( $i );
+			$generated_new[] = $plural_forms->get( $i );
+		}
+
+		$this->assertSame( $generated_old, $generated_new );
+	}
+
+	/**
+	 * @ticket 41562
+	 * @group external-http
+	 */
+	public function test_locales_file_not_empty() {
+		$locales = self::data_locales();
 
 		$this->assertNotEmpty( $locales, 'Unable to retrieve GP_Locales file' );
 	}
 
-	public static function locales_provider() {
+	public static function data_locales() {
 		if ( ! class_exists( 'GP_Locales' ) ) {
 			$filename = download_url( 'https://raw.githubusercontent.com/GlotPress/GlotPress-WP/develop/locales/locales.php' );
 			if ( is_wp_error( $filename ) ) {
@@ -70,28 +93,19 @@ class PluralFormsTest extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 41562
-	 * @dataProvider locales_provider
-	 * @group external-http
+	 * @dataProvider data_simple
 	 */
-	public function test_regression( $lang, $nplurals, $expression ) {
-		require_once dirname( dirname( __DIR__ ) ) . '/includes/plural-form-function.php';
-
-		$parenthesized = self::parenthesize_plural_expression( $expression );
-		$old_style     = tests_make_plural_form_function( $nplurals, $parenthesized );
-		$plural_forms  = new Plural_Forms( $expression );
-
-		$generated_old = array();
-		$generated_new = array();
-
-		foreach ( range( 0, 200 ) as $i ) {
-			$generated_old[] = $old_style( $i );
-			$generated_new[] = $plural_forms->get( $i );
+	public function test_simple( $expression, $expected ) {
+		$plural_forms = new Plural_Forms( $expression );
+		$actual       = array();
+		foreach ( array_keys( $expected ) as $num ) {
+			$actual[ $num ] = $plural_forms->get( $num );
 		}
 
-		$this->assertSame( $generated_old, $generated_new );
+		$this->assertSame( $expected, $actual );
 	}
 
-	public static function simple_provider() {
+	public static function data_simple() {
 		return array(
 			array(
 				// Simple equivalence.
@@ -143,17 +157,19 @@ class PluralFormsTest extends WP_UnitTestCase {
 	}
 
 	/**
+	 * Ensures that an exception is thrown when an invalid plural form is encountered.
+	 *
 	 * @ticket 41562
-	 * @dataProvider simple_provider
+	 * @dataProvider data_exceptions
 	 */
-	public function test_simple( $expression, $expected ) {
+	public function test_exceptions( $expression, $expected_message, $call_get ) {
+		$this->expectException( 'Exception' );
+		$this->expectExceptionMessage( $expected_message );
+
 		$plural_forms = new Plural_Forms( $expression );
-		$actual       = array();
-		foreach ( array_keys( $expected ) as $num ) {
-			$actual[ $num ] = $plural_forms->get( $num );
+		if ( $call_get ) {
+			$plural_forms->get( 1 );
 		}
-
-		$this->assertSame( $expected, $actual );
 	}
 
 	public function data_exceptions() {
@@ -196,22 +212,6 @@ class PluralFormsTest extends WP_UnitTestCase {
 		);
 	}
 
-	/**
-	 * Ensures that an exception is thrown when an invalid plural form is encountered.
-	 *
-	 * @ticket 41562
-	 * @dataProvider data_exceptions
-	 */
-	public function test_exceptions( $expression, $expected_message, $call_get ) {
-		$this->expectException( 'Exception' );
-		$this->expectExceptionMessage( $expected_message );
-
-		$plural_forms = new Plural_Forms( $expression );
-		if ( $call_get ) {
-			$plural_forms->get( 1 );
-		}
-	}
-
 	/**
 	 * @ticket 41562
 	 */
diff --git a/tests/post.php b/tests/post.php
index 484b890af4..e895dd9e76 100644
--- a/tests/post.php
+++ b/tests/post.php
@@ -467,7 +467,7 @@ class Tests_Post extends WP_UnitTestCase {
 		remove_filter( 'pre_wp_unique_post_slug', array( $this, 'filter_pre_wp_unique_post_slug' ), 10, 6 );
 	}
 
-	public function filter_pre_wp_unique_post_slug( $default, $slug, $post_ID, $post_status, $post_type, $post_parent ) {
+	public function filter_pre_wp_unique_post_slug( $override_slug, $slug, $post_id, $post_status, $post_type, $post_parent ) {
 		return 'override-slug-' . $post_type;
 	}
 
diff --git a/tests/post/getPageByPath.php b/tests/post/getPageByPath.php
index 13e6a3cfe2..7e89a3ffc0 100644
--- a/tests/post/getPageByPath.php
+++ b/tests/post/getPageByPath.php
@@ -103,6 +103,101 @@ class Tests_Post_GetPageByPath extends WP_UnitTestCase {
 		$this->assertSame( $p3, $found->ID );
 	}
 
+	/**
+	 * @ticket 56689
+	 *
+	 * @covers ::get_page_by_path
+	 */
+	public function test_should_match_nested_page_query_count() {
+		$p1 = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+				'post_name' => 'foo',
+			)
+		);
+
+		$p2 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_name'   => 'bar',
+				'post_parent' => $p1,
+			)
+		);
+
+		$p3 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_name'   => 'baz',
+				'post_parent' => $p2,
+			)
+		);
+
+		$queries_before = get_num_queries();
+		$found          = get_page_by_path( 'foo/bar/baz' );
+		$queries_after  = get_num_queries();
+		$cached_post    = wp_cache_get( $p1, 'posts' );
+
+		$this->assertSame( 1, $queries_after - $queries_before, 'Only one query should run' );
+		$this->assertSame( $p3, $found->ID, 'Check to see if the result is correct' );
+		$this->assertIsObject( $cached_post, 'The cached post is not an object' );
+	}
+
+	/**
+	 * @ticket 56689
+	 *
+	 * @covers ::get_page_by_path
+	 */
+	public function test_should_match_nested_page_query_count_status() {
+		$p1 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_name'   => 'foo',
+				'post_status' => 'draft',
+			)
+		);
+
+		$p2 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_name'   => 'bar',
+				'post_parent' => $p1,
+			)
+		);
+
+		$p3 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_name'   => 'baz',
+				'post_parent' => $p2,
+			)
+		);
+
+		$queries_before = get_num_queries();
+		$found          = get_page_by_path( 'foo/bar/baz' );
+		$queries_after  = get_num_queries();
+		$cached_post    = wp_cache_get( $p1, 'posts' );
+
+		$this->assertSame( 1, $queries_after - $queries_before, 'Only one query should run' );
+		$this->assertSame( $p3, $found->ID, 'Check to see if the result is correct' );
+		$this->assertIsObject( $cached_post, 'The cached post is not an object' );
+	}
+
+	/**
+	 * @ticket 56689
+	 *
+	 * @covers ::get_page_by_path
+	 */
+	public function test_should_return_null_for_invalid_path() {
+		$queries_before = get_num_queries();
+		$get_1          = get_page_by_path( 'should/return/null/for/an/invalid/path' );
+		$get_2          = get_page_by_path( 'should/return/null/for/an/invalid/path' );
+		$queries_after  = get_num_queries();
+
+		$this->assertNull( $get_1, 'Invalid path should return null.' );
+		$this->assertSame( 1, $queries_after - $queries_before, 'Only one query should run.' );
+		$this->assertSame( $get_1, $get_2, 'The cached result should be the same as the uncached result.' );
+	}
+
 	public function test_should_not_make_partial_match() {
 		$p1 = self::factory()->post->create(
 			array(
diff --git a/tests/post/getPageByTitle.php b/tests/post/getPageByTitle.php
new file mode 100644
index 0000000000..a85d8f42c5
--- /dev/null
+++ b/tests/post/getPageByTitle.php
@@ -0,0 +1,21 @@
+<?php
+
+/**
+ * @group post
+ *
+ * @covers ::get_page_by_title
+ */
+class Tests_Post_GetPageByTitle extends WP_UnitTestCase {
+
+	/**
+	 * Tests that `get_page_by_title()` has been deprecated.
+	 *
+	 * @ticket 57041
+	 *
+	 * @expectedDeprecated get_page_by_title
+	 */
+	public function test_get_page_by_title_should_be_deprecated() {
+		$this->assertNull( get_page_by_title( '#57041 Page' ) );
+	}
+
+}
diff --git a/tests/post/getPageTemplateSlug.php b/tests/post/getPageTemplateSlug.php
new file mode 100644
index 0000000000..5a735350f5
--- /dev/null
+++ b/tests/post/getPageTemplateSlug.php
@@ -0,0 +1,75 @@
+<?php
+
+/**
+ * @group post
+ * @group template
+ *
+ * @covers ::get_page_template_slug
+ */
+class Tests_Post_GetPageTemplateSlug extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 31389
+	 */
+	public function test_get_page_template_slug_by_id() {
+		$page_id = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		$this->assertSame( '', get_page_template_slug( $page_id ) );
+
+		update_post_meta( $page_id, '_wp_page_template', 'default' );
+		$this->assertSame( '', get_page_template_slug( $page_id ) );
+
+		update_post_meta( $page_id, '_wp_page_template', 'example.php' );
+		$this->assertSame( 'example.php', get_page_template_slug( $page_id ) );
+	}
+
+	/**
+	 * @ticket 31389
+	 */
+	public function test_get_page_template_slug_from_loop() {
+		$page_id = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		update_post_meta( $page_id, '_wp_page_template', 'example.php' );
+		$this->go_to( get_permalink( $page_id ) );
+
+		$this->assertSame( 'example.php', get_page_template_slug() );
+	}
+
+	/**
+	 * @ticket 31389
+	 * @ticket 18375
+	 */
+	public function test_get_page_template_slug_non_page() {
+		$post_id = self::factory()->post->create();
+
+		$this->assertSame( '', get_page_template_slug( $post_id ) );
+
+		update_post_meta( $post_id, '_wp_page_template', 'default' );
+
+		$this->assertSame( '', get_page_template_slug( $post_id ) );
+
+		update_post_meta( $post_id, '_wp_page_template', 'example.php' );
+		$this->assertSame( 'example.php', get_page_template_slug( $post_id ) );
+	}
+
+	/**
+	 * @ticket 18375
+	 */
+	public function test_get_page_template_slug_non_page_from_loop() {
+		$post_id = self::factory()->post->create();
+
+		update_post_meta( $post_id, '_wp_page_template', 'example.php' );
+
+		$this->go_to( get_permalink( $post_id ) );
+
+		$this->assertSame( 'example.php', get_page_template_slug() );
+	}
+}
diff --git a/tests/post/getPages.php b/tests/post/getPages.php
index 804f4b431b..3de294aa22 100644
--- a/tests/post/getPages.php
+++ b/tests/post/getPages.php
@@ -2,8 +2,9 @@
 
 /**
  * @group post
+ *
+ * @covers ::get_pages
  */
-
 class Tests_Post_GetPages extends WP_UnitTestCase {
 	/**
 	 * @ticket 23167
@@ -66,7 +67,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		// Force last_changed to increment.
 		clean_post_cache( $pages[0]->ID );
 		$this->assertNotEquals( $time1, $time2 = wp_cache_get( 'last_changed', 'posts' ) );
-
+		get_post( $pages[0]->ID );
 		$num_queries = $wpdb->num_queries;
 
 		// last_changed bumped so num_queries should increment.
@@ -99,10 +100,32 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * @ticket 43514
+	 */
+	public function test_get_pages_cache_empty() {
+		global $wpdb;
+
+		wp_cache_delete( 'last_changed', 'posts' );
+		$this->assertFalse( wp_cache_get( 'last_changed', 'posts' ) );
+
+		$num_queries = $wpdb->num_queries;
+
+		$pages = get_pages(); // Database gets queried.
+
+		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+
+		$num_queries = $wpdb->num_queries;
+
+		$pages = get_pages(); // Database should not get queried.
+
+		$this->assertSame( $num_queries, $wpdb->num_queries );
+	}
+
 	/**
 	 * @ticket 40669
 	 */
-	public function test_cache_should_be_invalidated_by_add_post_meta() {
+	public function test_get_pages_cache_should_be_invalidated_by_add_post_meta() {
 		$posts = self::factory()->post->create_many(
 			2,
 			array(
@@ -138,7 +161,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 	/**
 	 * @ticket 40669
 	 */
-	public function test_cache_should_be_invalidated_by_update_post_meta() {
+	public function test_get_pages_cache_should_be_invalidated_by_update_post_meta() {
 		$posts = self::factory()->post->create_many(
 			2,
 			array(
@@ -175,7 +198,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 	/**
 	 * @ticket 40669
 	 */
-	public function test_cache_should_be_invalidated_by_delete_post_meta() {
+	public function test_get_pages_cache_should_be_invalidated_by_delete_post_meta() {
 		$posts = self::factory()->post->create_many(
 			2,
 			array(
@@ -212,7 +235,7 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 	/**
 	 * @ticket 40669
 	 */
-	public function test_cache_should_be_invalidated_by_delete_post_meta_by_key() {
+	public function test_get_pages_cache_should_be_invalidated_by_delete_post_meta_by_key() {
 		$posts = self::factory()->post->create_many(
 			2,
 			array(
@@ -306,6 +329,105 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$this->assertSame( $inc, $exc_result );
 	}
 
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_include_ignores_meta_key() {
+		$posts = self::factory()->post->create_many(
+			2,
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		$pages = get_pages(
+			array(
+				'include'    => $posts,
+				'meta_key'   => 'foo',
+				'meta_value' => 'bar',
+			)
+		);
+
+		$page_ids = wp_list_pluck( $pages, 'ID' );
+		$this->assertSameSets( $posts, $page_ids );
+	}
+
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_include_ignores_exclude() {
+		$includes = self::factory()->post->create_many(
+			2,
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		$excludes = self::factory()->post->create_many(
+			2,
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		$pages = get_pages(
+			array(
+				'include' => $includes,
+				'exclude' => $excludes,
+			)
+		);
+
+		$page_ids = wp_list_pluck( $pages, 'ID' );
+		$this->assertSameSets( $includes, $page_ids );
+	}
+
+	public function test_get_pages_exclude_tree() {
+		$post_id1 = self::factory()->post->create( array( 'post_type' => 'page' ) );
+		$post_id2 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_parent' => $post_id1,
+			)
+		);
+		$post_id3 = self::factory()->post->create( array( 'post_type' => 'page' ) );
+		$post_id4 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_parent' => $post_id3,
+			)
+		);
+
+		$all = get_pages();
+
+		$this->assertCount( 4, $all );
+
+		$exclude1 = get_pages( "exclude_tree=$post_id1" );
+		$this->assertCount( 2, $exclude1 );
+
+		$exclude2 = get_pages( array( 'exclude_tree' => $post_id1 ) );
+		$this->assertCount( 2, $exclude2 );
+
+		$exclude3 = get_pages( array( 'exclude_tree' => array( $post_id1 ) ) );
+		$this->assertCount( 2, $exclude3 );
+
+		$exclude4 = get_pages( array( 'exclude_tree' => array( $post_id1, $post_id2 ) ) );
+		$this->assertCount( 2, $exclude4 );
+
+		$exclude5 = get_pages( array( 'exclude_tree' => array( $post_id1, $post_id3 ) ) );
+		$this->assertCount( 0, $exclude5 );
+
+		$post_id5 = self::factory()->post->create( array( 'post_type' => 'page' ) );
+		$post_id6 = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_parent' => $post_id5,
+			)
+		);
+
+		$exclude6 = get_pages( array( 'exclude_tree' => array( $post_id1, $post_id3 ) ) );
+		$this->assertCount( 2, $exclude6 );
+	}
+
 	/**
 	 * @ticket 9470
 	 */
@@ -364,21 +486,10 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 		$this->assertSameSets( array( $page_id2, $page_id3, $page_id4 ), wp_list_pluck( $pages, 'ID' ) );
 	}
 
-	/**
-	 * @ticket 22389
-	 */
-	public function test_wp_dropdown_pages() {
-		self::factory()->post->create_many( 5, array( 'post_type' => 'page' ) );
-
-		preg_match_all( '#<option#', wp_dropdown_pages( 'echo=0' ), $matches );
-
-		$this->assertCount( 5, $matches[0] );
-	}
-
 	/**
 	 * @ticket 22208
 	 */
-	public function test_get_chidren_fields_ids() {
+	public function test_get_children_fields_ids() {
 		$post_id   = self::factory()->post->create();
 		$child_ids = self::factory()->post->create_many( 5, array( 'post_parent' => $post_id ) );
 
@@ -618,105 +729,277 @@ class Tests_Post_GetPages extends WP_UnitTestCase {
 
 	}
 
-	public function test_wp_list_pages_classes() {
-		$type = 'taco';
-		register_post_type(
-			$type,
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_post_type() {
+		register_post_type( 'wptests_pt', array( 'hierarchical' => true ) );
+		$posts = self::factory()->post->create_many( 2, array( 'post_type' => 'wptests_pt' ) );
+		$pages = get_pages(
 			array(
-				'hierarchical' => true,
-				'public'       => true,
+				'post_type' => 'wptests_pt',
 			)
 		);
+		$this->assertSameSets( $posts, wp_list_pluck( $pages, 'ID' ) );
+	}
 
-		$posts   = self::factory()->post->create_many( 2, array( 'post_type' => $type ) );
-		$post_id = reset( $posts );
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_post_status() {
+		register_post_status(
+			'foo',
+			array(
+				'public' => true,
+			)
+		);
 
-		$this->go_to( "/?p=$post_id&post_type=$type" );
+		$posts = self::factory()->post->create_many(
+			2,
+			array(
+				'post_type'   => 'page',
+				'post_status' => 'foo',
+			)
+		);
+		$pages = get_pages(
+			array(
+				'post_status' => 'foo',
+			)
+		);
 
-		$this->assertSame( $post_id, get_queried_object_id() );
+		$this->assertSameSets( $posts, wp_list_pluck( $pages, 'ID' ) );
+	}
 
-		$output = wp_list_pages(
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_offset() {
+		$posts = self::factory()->post->create_many( 4, array( 'post_type' => 'page' ) );
+		$pages = get_pages(
 			array(
-				'echo'      => false,
-				'title_li'  => '',
-				'post_type' => $type,
+				'offset' => 2,
+				'number' => 2,
 			)
 		);
 
-		$this->assertNotEmpty( $output );
-		$this->assertSame( 2, substr_count( $output, 'class="page_item ' ) );
-		$this->assertStringContainsString( 'current_page_item', $output );
-		$this->assertSame( 1, substr_count( $output, 'current_page_item' ) );
-
-		_unregister_post_type( $type );
+		$this->assertSameSets( array( $posts[2], $posts[3] ), wp_list_pluck( $pages, 'ID' ) );
 	}
 
-	public function test_exclude_tree() {
-		$post_id1 = self::factory()->post->create( array( 'post_type' => 'page' ) );
-		$post_id2 = self::factory()->post->create(
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_author() {
+		$author_1 = self::factory()->user->create(
 			array(
-				'post_type'   => 'page',
-				'post_parent' => $post_id1,
+				'user_login' => 'author1',
+				'role'       => 'author',
 			)
 		);
-		$post_id3 = self::factory()->post->create( array( 'post_type' => 'page' ) );
-		$post_id4 = self::factory()->post->create(
+		$posts    = self::factory()->post->create_many(
+			2,
 			array(
 				'post_type'   => 'page',
-				'post_parent' => $post_id3,
+				'post_author' => $author_1,
+			)
+		);
+		$pages    = get_pages(
+			array(
+				'authors' => $author_1,
 			)
 		);
 
-		$all = get_pages();
-
-		$this->assertCount( 4, $all );
-
-		$exclude1 = get_pages( "exclude_tree=$post_id1" );
-		$this->assertCount( 2, $exclude1 );
+		$this->assertSameSets( $posts, wp_list_pluck( $pages, 'ID' ) );
+	}
 
-		$exclude2 = get_pages( array( 'exclude_tree' => $post_id1 ) );
-		$this->assertCount( 2, $exclude2 );
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_multiple_authors() {
+		$author_1 = self::factory()->user->create(
+			array(
+				'user_login' => 'author1',
+				'role'       => 'author',
+			)
+		);
+		$post_1   = self::factory()->post->create(
+			array(
+				'post_title'  => 'Page 1',
+				'post_type'   => 'page',
+				'post_author' => $author_1,
+				'post_date'   => '2007-01-01 00:00:00',
+			)
+		);
 
-		$exclude3 = get_pages( array( 'exclude_tree' => array( $post_id1 ) ) );
-		$this->assertCount( 2, $exclude3 );
+		$author_2 = self::factory()->user->create(
+			array(
+				'user_login' => 'author2',
+				'role'       => 'author',
+			)
+		);
+		$post_2   = self::factory()->post->create(
+			array(
+				'post_title'  => 'Page 2',
+				'post_type'   => 'page',
+				'post_author' => $author_2,
+				'post_date'   => '2007-01-01 00:00:00',
+			)
+		);
+		$pages    = get_pages(
+			array(
+				'authors' => "{$author_1}, {$author_2}",
+			)
+		);
 
-		$exclude4 = get_pages( array( 'exclude_tree' => array( $post_id1, $post_id2 ) ) );
-		$this->assertCount( 2, $exclude4 );
+		$this->assertSameSets( array( $post_1, $post_2 ), wp_list_pluck( $pages, 'ID' ) );
+	}
 
-		$exclude5 = get_pages( array( 'exclude_tree' => array( $post_id1, $post_id3 ) ) );
-		$this->assertCount( 0, $exclude5 );
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_multiple_authors_by_user_login() {
+		$author_1 = self::factory()->user->create(
+			array(
+				'user_login' => 'author1',
+				'role'       => 'author',
+			)
+		);
+		$post_1   = self::factory()->post->create(
+			array(
+				'post_title'  => 'Page 1',
+				'post_type'   => 'page',
+				'post_author' => $author_1,
+				'post_date'   => '2007-01-01 00:00:00',
+			)
+		);
 
-		$post_id5 = self::factory()->post->create( array( 'post_type' => 'page' ) );
-		$post_id6 = self::factory()->post->create(
+		$author_2 = self::factory()->user->create(
+			array(
+				'user_login' => 'author2',
+				'role'       => 'author',
+			)
+		);
+		$post_2   = self::factory()->post->create(
 			array(
+				'post_title'  => 'Page 2',
 				'post_type'   => 'page',
-				'post_parent' => $post_id5,
+				'post_author' => $author_2,
+				'post_date'   => '2007-01-01 00:00:00',
+			)
+		);
+		$pages    = get_pages(
+			array(
+				'authors' => 'author1, author2',
 			)
 		);
 
-		$exclude6 = get_pages( array( 'exclude_tree' => array( $post_id1, $post_id3 ) ) );
-		$this->assertCount( 2, $exclude6 );
+		$this->assertSameSets( array( $post_1, $post_2 ), wp_list_pluck( $pages, 'ID' ) );
 	}
 
 	/**
-	 * @ticket 43514
+	 * @ticket 12821
 	 */
-	public function test_get_pages_cache_empty() {
+	public function test_get_pages_orderby() {
 		global $wpdb;
+		// 'rand' is a valid value.
+		get_pages( array( 'sort_column' => 'rand' ) );
+		$this->assertStringContainsString(
+			'ORDER BY RAND()',
+			$wpdb->last_query,
+			'Check that ORDER is random.'
+		);
+
+		// This isn't allowed.
+		get_pages( array( 'sort_order' => 'rand' ) );
+		$this->assertStringContainsString(
+			'ORDER BY',
+			$wpdb->last_query,
+			'Check that ORDER BY is present.'
+		);
+		$this->assertStringNotContainsString(
+			'RAND()',
+			$wpdb->last_query,
+			'Check that ORDER is not random.'
+		);
+		$this->assertStringContainsString(
+			'DESC',
+			$wpdb->last_query,
+			'Check that DESC is not present.'
+		);
+
+		// 'none' is a valid value.
+		get_pages( array( 'sort_column' => 'none' ) );
+		$this->assertStringNotContainsString(
+			'ORDER BY',
+			$wpdb->last_query,
+			'Check that ORDER BY is not present.'
+		);
+		$this->assertStringNotContainsString(
+			'DESC',
+			$wpdb->last_query,
+			'Check that DESC is not present.'
+		);
+		$this->assertStringNotContainsString(
+			'ASC',
+			$wpdb->last_query,
+			'Check that ASC is not present.'
+		);
+
+		// False is a valid value.
+		get_pages( array( 'sort_column' => false ) );
+		$this->assertStringContainsString(
+			'ORDER BY',
+			$wpdb->last_query,
+			'Check that ORDER BY is present if sort_column is false.'
+		);
+
+		// Empty array() is a valid value.
+		get_pages( array( 'sort_column' => array() ) );
+		$this->assertStringContainsString(
+			'ORDER BY',
+			$wpdb->last_query,
+			'Check that ORDER BY is present if sort_column is an empty array.'
+		);
+	}
 
-		wp_cache_delete( 'last_changed', 'posts' );
-		$this->assertFalse( wp_cache_get( 'last_changed', 'posts' ) );
-
-		$num_queries = $wpdb->num_queries;
-
-		$pages = get_pages(); // Database gets queried.
-
-		$this->assertSame( $num_queries + 1, $wpdb->num_queries );
+	/**
+	 * @ticket 12821
+	 */
+	public function test_get_pages_order() {
+		global $wpdb;
 
-		$num_queries = $wpdb->num_queries;
+		get_pages(
+			array(
+				'sort_column' => 'post_type',
+			)
+		);
+		$this->assertStringContainsString(
+			"ORDER BY $wpdb->posts.post_type ASC",
+			$wpdb->last_query,
+			'Check that ORDER is post type.'
+		);
 
-		$pages = get_pages(); // Database should not get queried.
+		get_pages(
+			array(
+				'sort_column' => 'title',
+				'sort_order'  => 'foo',
+			)
+		);
+		$this->assertStringContainsString(
+			"ORDER BY $wpdb->posts.post_title DESC",
+			$wpdb->last_query,
+			'Check that ORDER is default.'
+		);
 
-		$this->assertSame( $num_queries, $wpdb->num_queries );
+		get_pages(
+			array(
+				'sort_order'  => 'asc',
+				'sort_column' => 'date',
+			)
+		);
+		$this->assertStringContainsString(
+			"ORDER BY $wpdb->posts.post_date ASC",
+			$wpdb->last_query,
+			'Check that ORDER is post date.'
+		);
 	}
 }
diff --git a/tests/post/getPostParent.php b/tests/post/getPostParent.php
new file mode 100644
index 0000000000..e66b458513
--- /dev/null
+++ b/tests/post/getPostParent.php
@@ -0,0 +1,72 @@
+<?php
+
+/**
+ * @group post
+ * @group template
+ *
+ * @covers ::get_post_parent
+ * @covers ::has_post_parent
+ */
+class Tests_Post_GetPostParent extends WP_UnitTestCase {
+
+	/**
+	 * @ticket 33045
+	 */
+	public function test_get_post_parent() {
+		$post = array(
+			'post_status' => 'publish',
+			'post_type'   => 'page',
+		);
+
+		// Insert two initial posts.
+		$parent_id = self::factory()->post->create( $post );
+		$child_id  = self::factory()->post->create( $post );
+
+		// Test if the function returns null by default.
+		$parent = get_post_parent( $child_id );
+		$this->assertNull( $parent );
+
+		// Update child post with a parent.
+		wp_update_post(
+			array(
+				'ID'          => $child_id,
+				'post_parent' => $parent_id,
+			)
+		);
+
+		// Test if the function returns the parent object.
+		$parent = get_post_parent( $child_id );
+		$this->assertNotNull( $parent );
+		$this->assertSame( $parent_id, $parent->ID );
+	}
+
+	/**
+	 * @ticket 33045
+	 */
+	public function test_has_post_parent() {
+		$post = array(
+			'post_status' => 'publish',
+			'post_type'   => 'page',
+		);
+
+		// Insert two initial posts.
+		$parent_id = self::factory()->post->create( $post );
+		$child_id  = self::factory()->post->create( $post );
+
+		// Test if the function returns false by default.
+		$parent = has_post_parent( $child_id );
+		$this->assertFalse( $parent );
+
+		// Update child post with a parent.
+		wp_update_post(
+			array(
+				'ID'          => $child_id,
+				'post_parent' => $parent_id,
+			)
+		);
+
+		// Test if the function returns true for a child post.
+		$parent = has_post_parent( $child_id );
+		$this->assertTrue( $parent );
+	}
+}
diff --git a/tests/post/nav-menu.php b/tests/post/nav-menu.php
index dc7cc74e2d..918b76e8e1 100644
--- a/tests/post/nav-menu.php
+++ b/tests/post/nav-menu.php
@@ -15,6 +15,51 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		$this->menu_id = wp_create_nav_menu( 'foo' );
 	}
 
+	/**
+	 * @ticket 11095
+	 * @ticket 33974
+	 */
+	public function test_wp_page_menu_wp_nav_menu_fallback() {
+		$pages = self::factory()->post->create_many( 3, array( 'post_type' => 'page' ) );
+
+		// No menus + wp_nav_menu() falls back to wp_page_menu().
+		$menu = wp_nav_menu( array( 'echo' => false ) );
+
+		// After falling back, the 'before' argument should be set and output as '<ul>'.
+		$this->assertMatchesRegularExpression( '/<div class="menu"><ul>/', $menu );
+
+		// After falling back, the 'after' argument should be set and output as '</ul>'.
+		$this->assertMatchesRegularExpression( '/<\/ul><\/div>/', $menu );
+
+		// After falling back, the markup should include whitespace around <li>'s.
+		$this->assertMatchesRegularExpression( '/\s<li.*>|<\/li>\s/U', $menu );
+		$this->assertDoesNotMatchRegularExpression( '/><li.*>|<\/li></U', $menu );
+
+		// No menus + wp_nav_menu() falls back to wp_page_menu(), this time without a container.
+		$menu = wp_nav_menu(
+			array(
+				'echo'      => false,
+				'container' => false,
+			)
+		);
+
+		// After falling back, the empty 'container' argument should still return a container element.
+		$this->assertMatchesRegularExpression( '/<div class="menu">/', $menu );
+
+		// No menus + wp_nav_menu() falls back to wp_page_menu(), this time without white-space.
+		$menu = wp_nav_menu(
+			array(
+				'echo'         => false,
+				'item_spacing' => 'discard',
+			)
+		);
+
+		// After falling back, the markup should not include whitespace around <li>'s.
+		$this->assertDoesNotMatchRegularExpression( '/\s<li.*>|<\/li>\s/U', $menu );
+		$this->assertMatchesRegularExpression( '/><li.*>|<\/li></U', $menu );
+
+	}
+
 	/**
 	 * @ticket 32464
 	 */
@@ -717,7 +762,6 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		return $ignored_1;
 	}
 
-
 	/**
 	 * @ticket 35272
 	 */
@@ -965,23 +1009,9 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		$this->assertNotContains( 'current-menu-ancestor', $post_archive_menu_item->classes );
 	}
 
-	/**
-	 * Provides IRI matching data for _wp_menu_item_classes_by_context() test.
-	 */
-	public function get_iri_current_menu_items() {
-		return array(
-			array( site_url( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82/' ) ),
-			array( site_url( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82' ) ),
-			array( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82/' ),
-			array( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82' ),
-			array( '/привет/' ),
-			array( '/привет' ),
-		);
-	}
-
 	/**
 	 * @ticket 43401
-	 * @dataProvider get_iri_current_menu_items
+	 * @dataProvider data_iri_current_menu_item
 	 */
 	public function test_iri_current_menu_item( $custom_link, $current = true ) {
 		wp_update_nav_menu_item(
@@ -1008,6 +1038,20 @@ class Tests_Post_Nav_Menu extends WP_UnitTestCase {
 		}
 	}
 
+	/**
+	 * Provides IRI matching data for _wp_menu_item_classes_by_context() test.
+	 */
+	public function data_iri_current_menu_item() {
+		return array(
+			array( site_url( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82/' ) ),
+			array( site_url( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82' ) ),
+			array( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82/' ),
+			array( '/%D0%BF%D1%80%D0%B8%D0%B2%D0%B5%D1%82' ),
+			array( '/привет/' ),
+			array( '/привет' ),
+		);
+	}
+
 	/**
 	 * @ticket 44005
 	 * @group privacy
diff --git a/tests/post/query.php b/tests/post/query.php
index 66bcdc2691..f67078117c 100644
--- a/tests/post/query.php
+++ b/tests/post/query.php
@@ -712,20 +712,10 @@ class Tests_Post_Query extends WP_UnitTestCase {
 		$this->assertEquals( 2, $q->max_num_pages );
 	}
 
-	public function set_found_posts_provider() {
-		// Count return 0 for null, but 1 for other data you may not expect.
-		return array(
-			array( null, 0 ),
-			array( '', 1 ),
-			array( "To life, to life, l'chaim", 1 ),
-			array( false, 1 ),
-		);
-	}
-
 	/**
 	 * @ticket 42860
 	 *
-	 * @dataProvider set_found_posts_provider
+	 * @dataProvider data_set_found_posts_not_posts_as_an_array
 	 */
 	public function test_set_found_posts_not_posts_as_an_array( $posts, $expected ) {
 		$q = new WP_Query(
@@ -744,6 +734,16 @@ class Tests_Post_Query extends WP_UnitTestCase {
 		$this->assertSame( $expected, $q->found_posts );
 	}
 
+	public function data_set_found_posts_not_posts_as_an_array() {
+		// Count return 0 for null, but 1 for other data you may not expect.
+		return array(
+			array( null, 0 ),
+			array( '', 1 ),
+			array( "To life, to life, l'chaim", 1 ),
+			array( false, 1 ),
+		);
+	}
+
 	/**
 	 * @ticket 42469
 	 */
diff --git a/tests/post/revisions.php b/tests/post/revisions.php
index c8effbccc2..cc17ccd60d 100644
--- a/tests/post/revisions.php
+++ b/tests/post/revisions.php
@@ -866,4 +866,66 @@ class Tests_Post_Revisions extends WP_UnitTestCase {
 
 		add_post_type_support( 'post', 'revisions' );
 	}
+
+	/**
+	 * Tests that wp_save_post_revision() respects the 'wp_save_post_revision_revisions_before_deletion' filter
+	 * when deleting revisions.
+	 *
+	 * This test should protect the original revision, send the rest to be checked against wp_revisions_to_keep(),
+	 * and result in two revisions: The latest revision, and the original.
+	 *
+	 * @ticket 57320
+	 *
+	 * @covers ::wp_save_post_revision
+	 */
+	public function test_wp_save_post_revision_should_respect_revisions_before_deletion_filter() {
+		$post_id = self::factory()->post->create( array( 'post_title' => 'Test 57320' ) );
+
+		add_filter(
+			'wp_revisions_to_keep',
+			static function() {
+				return 1;
+			}
+		);
+
+		add_filter(
+			'wp_save_post_revision_revisions_before_deletion',
+			static function ( $revisions ) {
+				// Ignore the first revision and return the rest for deletion.
+				return array_slice( $revisions, 1 );
+			}
+		);
+
+		for ( $update = 1; $update < 4; ++$update ) {
+			wp_update_post(
+				array(
+					'ID'         => $post_id,
+					'post_title' => 'Test 57320 Update ' . $update,
+				)
+			);
+		}
+
+		$actual = wp_get_post_revisions( $post_id );
+
+		$this->assertCount(
+			2,
+			$actual,
+			'There should be two revisions.'
+		);
+
+		$first  = reset( $actual );
+		$second = next( $actual );
+
+		$this->assertSame(
+			'Test 57320 Update 3',
+			$first->post_title,
+			'The title of the first revision was incorrect.'
+		);
+
+		$this->assertSame(
+			'Test 57320 Update 1',
+			$second->post_title,
+			'The title of the second revision was incorrect.'
+		);
+	}
 }
diff --git a/tests/post/template.php b/tests/post/template.php
deleted file mode 100644
index c30f31fba2..0000000000
--- a/tests/post/template.php
+++ /dev/null
@@ -1,516 +0,0 @@
-<?php
-
-/**
- * @group template
- */
-class Tests_Post_Template extends WP_UnitTestCase {
-
-	public function test_wp_link_pages() {
-		$contents = array( 'One', 'Two', 'Three' );
-		$content  = implode( '<!--nextpage-->', $contents );
-		$post_id  = self::factory()->post->create( array( 'post_content' => $content ) );
-
-		$this->go_to( '?p=' . $post_id );
-
-		setup_postdata( get_post( $post_id ) );
-
-		$permalink = sprintf( '<a href="%s" class="post-page-numbers">', get_permalink() );
-		$page2     = _wp_link_page( 2 );
-		$page3     = _wp_link_page( 3 );
-
-		$expected = '<p class="post-nav-links">Pages: <span class="post-page-numbers current" aria-current="page">1</span> ' . $page2 . '2</a> ' . $page3 . '3</a></p>';
-		$output   = wp_link_pages( array( 'echo' => 0 ) );
-
-		$this->assertSame( $expected, $output );
-
-		$before_after = " <span class=\"post-page-numbers current\" aria-current=\"page\">1</span> {$page2}2</a> {$page3}3</a>";
-		$output       = wp_link_pages(
-			array(
-				'echo'   => 0,
-				'before' => '',
-				'after'  => '',
-			)
-		);
-
-		$this->assertSame( $before_after, $output );
-
-		$separator = " <span class=\"post-page-numbers current\" aria-current=\"page\">1</span>{$page2}2</a>{$page3}3</a>";
-		$output    = wp_link_pages(
-			array(
-				'echo'      => 0,
-				'before'    => '',
-				'after'     => '',
-				'separator' => '',
-			)
-		);
-
-		$this->assertSame( $separator, $output );
-
-		$link   = " <span class=\"post-page-numbers current\" aria-current=\"page\"><em>1</em></span>{$page2}<em>2</em></a>{$page3}<em>3</em></a>";
-		$output = wp_link_pages(
-			array(
-				'echo'        => 0,
-				'before'      => '',
-				'after'       => '',
-				'separator'   => '',
-				'link_before' => '<em>',
-				'link_after'  => '</em>',
-			)
-		);
-
-		$this->assertSame( $link, $output );
-
-		$next   = "{$page2}<em>Next page</em></a>";
-		$output = wp_link_pages(
-			array(
-				'echo'           => 0,
-				'before'         => '',
-				'after'          => '',
-				'separator'      => '',
-				'link_before'    => '<em>',
-				'link_after'     => '</em>',
-				'next_or_number' => 'next',
-			)
-		);
-
-		$this->assertSame( $next, $output );
-
-		$GLOBALS['page'] = 2;
-		$next_prev       = "{$permalink}<em>Previous page</em></a>{$page3}<em>Next page</em></a>";
-		$output          = wp_link_pages(
-			array(
-				'echo'           => 0,
-				'before'         => '',
-				'after'          => '',
-				'separator'      => '',
-				'link_before'    => '<em>',
-				'link_after'     => '</em>',
-				'next_or_number' => 'next',
-			)
-		);
-
-		$this->assertSame( $next_prev, $output );
-
-		$next_prev_link = "{$permalink}Woo page</a>{$page3}Hoo page</a>";
-		$output         = wp_link_pages(
-			array(
-				'echo'             => 0,
-				'before'           => '',
-				'after'            => '',
-				'separator'        => '',
-				'next_or_number'   => 'next',
-				'nextpagelink'     => 'Hoo page',
-				'previouspagelink' => 'Woo page',
-			)
-		);
-
-		$this->assertSame( $next_prev_link, $output );
-
-		$GLOBALS['page'] = 1;
-		$separator       = "<p class=\"post-nav-links\">Pages: <span class=\"post-page-numbers current\" aria-current=\"page\">1</span> | {$page2}2</a> | {$page3}3</a></p>";
-		$output          = wp_link_pages(
-			array(
-				'echo'      => 0,
-				'separator' => ' | ',
-			)
-		);
-
-		$this->assertSame( $separator, $output );
-
-		$pagelink = " <span class=\"post-page-numbers current\" aria-current=\"page\">Page 1</span> | {$page2}Page 2</a> | {$page3}Page 3</a>";
-		$output   = wp_link_pages(
-			array(
-				'echo'      => 0,
-				'separator' => ' | ',
-				'before'    => '',
-				'after'     => '',
-				'pagelink'  => 'Page %',
-			)
-		);
-
-		$this->assertSame( $pagelink, $output );
-	}
-
-	public function test_wp_dropdown_pages() {
-		$none = wp_dropdown_pages( array( 'echo' => 0 ) );
-		$this->assertEmpty( $none );
-
-		$bump          = '&nbsp;&nbsp;&nbsp;';
-		$page_id       = self::factory()->post->create( array( 'post_type' => 'page' ) );
-		$child_id      = self::factory()->post->create(
-			array(
-				'post_type'   => 'page',
-				'post_parent' => $page_id,
-			)
-		);
-		$grandchild_id = self::factory()->post->create(
-			array(
-				'post_type'   => 'page',
-				'post_parent' => $child_id,
-			)
-		);
-
-		$title1 = get_post( $page_id )->post_title;
-		$title2 = get_post( $child_id )->post_title;
-		$title3 = get_post( $grandchild_id )->post_title;
-
-		$lineage = <<<LINEAGE
-<select name='page_id' id='page_id'>
-	<option class="level-0" value="$page_id">$title1</option>
-	<option class="level-1" value="$child_id">{$bump}$title2</option>
-	<option class="level-2" value="$grandchild_id">{$bump}{$bump}$title3</option>
-</select>
-
-LINEAGE;
-
-		$output = wp_dropdown_pages( array( 'echo' => 0 ) );
-		$this->assertSameIgnoreEOL( $lineage, $output );
-
-		$depth = <<<DEPTH
-<select name='page_id' id='page_id'>
-	<option class="level-0" value="$page_id">$title1</option>
-</select>
-
-DEPTH;
-
-		$output = wp_dropdown_pages(
-			array(
-				'echo'  => 0,
-				'depth' => 1,
-			)
-		);
-		$this->assertSameIgnoreEOL( $depth, $output );
-
-		$option_none = <<<NONE
-<select name='page_id' id='page_id'>
-	<option value="Woo">Hoo</option>
-	<option class="level-0" value="$page_id">$title1</option>
-</select>
-
-NONE;
-
-		$output = wp_dropdown_pages(
-			array(
-				'echo'              => 0,
-				'depth'             => 1,
-				'show_option_none'  => 'Hoo',
-				'option_none_value' => 'Woo',
-			)
-		);
-		$this->assertSameIgnoreEOL( $option_none, $output );
-
-		$option_no_change = <<<NO
-<select name='page_id' id='page_id'>
-	<option value="-1">Burrito</option>
-	<option value="Woo">Hoo</option>
-	<option class="level-0" value="$page_id">$title1</option>
-</select>
-
-NO;
-
-		$output = wp_dropdown_pages(
-			array(
-				'echo'                  => 0,
-				'depth'                 => 1,
-				'show_option_none'      => 'Hoo',
-				'option_none_value'     => 'Woo',
-				'show_option_no_change' => 'Burrito',
-			)
-		);
-		$this->assertSameIgnoreEOL( $option_no_change, $output );
-	}
-
-	/**
-	 * @ticket 12494
-	 */
-	public function test_wp_dropdown_pages_value_field_should_default_to_ID() {
-		$p = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-			)
-		);
-
-		$found = wp_dropdown_pages(
-			array(
-				'echo' => 0,
-			)
-		);
-
-		// Should contain page ID by default.
-		$this->assertStringContainsString( 'value="' . $p . '"', $found );
-	}
-
-	/**
-	 * @ticket 12494
-	 */
-	public function test_wp_dropdown_pages_value_field_ID() {
-		$p = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-			)
-		);
-
-		$found = wp_dropdown_pages(
-			array(
-				'echo'        => 0,
-				'value_field' => 'ID',
-			)
-		);
-
-		$this->assertStringContainsString( 'value="' . $p . '"', $found );
-	}
-
-	/**
-	 * @ticket 12494
-	 */
-	public function test_wp_dropdown_pages_value_field_post_name() {
-		$p = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-				'post_name' => 'foo',
-			)
-		);
-
-		$found = wp_dropdown_pages(
-			array(
-				'echo'        => 0,
-				'value_field' => 'post_name',
-			)
-		);
-
-		$this->assertStringContainsString( 'value="foo"', $found );
-	}
-
-	/**
-	 * @ticket 12494
-	 */
-	public function test_wp_dropdown_pages_value_field_should_fall_back_on_ID_when_an_invalid_value_is_provided() {
-		$p = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-				'post_name' => 'foo',
-			)
-		);
-
-		$found = wp_dropdown_pages(
-			array(
-				'echo'        => 0,
-				'value_field' => 'foo',
-			)
-		);
-
-		$this->assertStringContainsString( 'value="' . $p . '"', $found );
-	}
-
-	/**
-	 * @ticket 30082
-	 */
-	public function test_wp_dropdown_pages_should_not_contain_class_attribute_when_no_class_is_passed() {
-		$p = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-				'post_name' => 'foo',
-			)
-		);
-
-		$found = wp_dropdown_pages(
-			array(
-				'echo' => 0,
-			)
-		);
-
-		$this->assertDoesNotMatchRegularExpression( '/<select[^>]+class=\'/', $found );
-	}
-
-	/**
-	 * @ticket 30082
-	 */
-	public function test_wp_dropdown_pages_should_obey_class_parameter() {
-		$p = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-				'post_name' => 'foo',
-			)
-		);
-
-		$found = wp_dropdown_pages(
-			array(
-				'echo'  => 0,
-				'class' => 'bar',
-			)
-		);
-
-		$this->assertMatchesRegularExpression( '/<select[^>]+class=\'bar\'/', $found );
-	}
-
-	/**
-	 * @ticket 31389
-	 */
-	public function test_get_page_template_slug_by_id() {
-		$page_id = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-			)
-		);
-
-		$this->assertSame( '', get_page_template_slug( $page_id ) );
-
-		update_post_meta( $page_id, '_wp_page_template', 'default' );
-		$this->assertSame( '', get_page_template_slug( $page_id ) );
-
-		update_post_meta( $page_id, '_wp_page_template', 'example.php' );
-		$this->assertSame( 'example.php', get_page_template_slug( $page_id ) );
-	}
-
-	/**
-	 * @ticket 31389
-	 */
-	public function test_get_page_template_slug_from_loop() {
-		$page_id = self::factory()->post->create(
-			array(
-				'post_type' => 'page',
-			)
-		);
-
-		update_post_meta( $page_id, '_wp_page_template', 'example.php' );
-		$this->go_to( get_permalink( $page_id ) );
-
-		$this->assertSame( 'example.php', get_page_template_slug() );
-	}
-
-	/**
-	 * @ticket 31389
-	 * @ticket 18375
-	 */
-	public function test_get_page_template_slug_non_page() {
-		$post_id = self::factory()->post->create();
-
-		$this->assertSame( '', get_page_template_slug( $post_id ) );
-
-		update_post_meta( $post_id, '_wp_page_template', 'default' );
-
-		$this->assertSame( '', get_page_template_slug( $post_id ) );
-
-		update_post_meta( $post_id, '_wp_page_template', 'example.php' );
-		$this->assertSame( 'example.php', get_page_template_slug( $post_id ) );
-	}
-
-	/**
-	 * @ticket 18375
-	 */
-	public function test_get_page_template_slug_non_page_from_loop() {
-		$post_id = self::factory()->post->create();
-
-		update_post_meta( $post_id, '_wp_page_template', 'example.php' );
-
-		$this->go_to( get_permalink( $post_id ) );
-
-		$this->assertSame( 'example.php', get_page_template_slug() );
-	}
-
-	/**
-	 * @ticket 11095
-	 * @ticket 33974
-	 */
-	public function test_wp_page_menu_wp_nav_menu_fallback() {
-		$pages = self::factory()->post->create_many( 3, array( 'post_type' => 'page' ) );
-
-		// No menus + wp_nav_menu() falls back to wp_page_menu().
-		$menu = wp_nav_menu( array( 'echo' => false ) );
-
-		// After falling back, the 'before' argument should be set and output as '<ul>'.
-		$this->assertMatchesRegularExpression( '/<div class="menu"><ul>/', $menu );
-
-		// After falling back, the 'after' argument should be set and output as '</ul>'.
-		$this->assertMatchesRegularExpression( '/<\/ul><\/div>/', $menu );
-
-		// After falling back, the markup should include whitespace around <li>'s.
-		$this->assertMatchesRegularExpression( '/\s<li.*>|<\/li>\s/U', $menu );
-		$this->assertDoesNotMatchRegularExpression( '/><li.*>|<\/li></U', $menu );
-
-		// No menus + wp_nav_menu() falls back to wp_page_menu(), this time without a container.
-		$menu = wp_nav_menu(
-			array(
-				'echo'      => false,
-				'container' => false,
-			)
-		);
-
-		// After falling back, the empty 'container' argument should still return a container element.
-		$this->assertMatchesRegularExpression( '/<div class="menu">/', $menu );
-
-		// No menus + wp_nav_menu() falls back to wp_page_menu(), this time without white-space.
-		$menu = wp_nav_menu(
-			array(
-				'echo'         => false,
-				'item_spacing' => 'discard',
-			)
-		);
-
-		// After falling back, the markup should not include whitespace around <li>'s.
-		$this->assertDoesNotMatchRegularExpression( '/\s<li.*>|<\/li>\s/U', $menu );
-		$this->assertMatchesRegularExpression( '/><li.*>|<\/li></U', $menu );
-
-	}
-
-	/**
-	 * @ticket 33045
-	 */
-	public function test_get_parent_post() {
-		$post = array(
-			'post_status' => 'publish',
-			'post_type'   => 'page',
-		);
-
-		// Insert two initial posts.
-		$parent_id = self::factory()->post->create( $post );
-		$child_id  = self::factory()->post->create( $post );
-
-		// Test if child get_parent_post() post returns Null by default.
-		$parent = get_post_parent( $child_id );
-		$this->assertNull( $parent );
-
-		// Update child post with a parent.
-		wp_update_post(
-			array(
-				'ID'          => $child_id,
-				'post_parent' => $parent_id,
-			)
-		);
-
-		// Test if child get_parent_post() post returns the parent object.
-		$parent = get_post_parent( $child_id );
-		$this->assertNotNull( $parent );
-		$this->assertSame( $parent_id, $parent->ID );
-	}
-
-	/**
-	 * @ticket 33045
-	 */
-	public function test_has_parent_post() {
-		$post = array(
-			'post_status' => 'publish',
-			'post_type'   => 'page',
-		);
-
-		// Insert two initial posts.
-		$parent_id = self::factory()->post->create( $post );
-		$child_id  = self::factory()->post->create( $post );
-
-		// Test if child has_parent_post() post returns False by default.
-		$parent = has_post_parent( $child_id );
-		$this->assertFalse( $parent );
-
-		// Update child post with a parent.
-		wp_update_post(
-			array(
-				'ID'          => $child_id,
-				'post_parent' => $parent_id,
-			)
-		);
-
-		// Test if child has_parent_post() returns True.
-		$parent = has_post_parent( $child_id );
-		$this->assertTrue( $parent );
-	}
-}
diff --git a/tests/post/truncatePostSlug.php b/tests/post/truncatePostSlug.php
new file mode 100644
index 0000000000..88ea9481dd
--- /dev/null
+++ b/tests/post/truncatePostSlug.php
@@ -0,0 +1,105 @@
+<?php
+
+/**
+ * @group post
+ *
+ * @covers ::_truncate_post_slug
+ */
+class Tests_Post_TruncatePostSlug extends WP_UnitTestCase {
+
+	/**
+	 * Tests that _truncate_post_slug() correctly truncates slugs.
+	 *
+	 * @ticket 56868
+	 *
+	 * @dataProvider data_truncate_post_slug_should_truncate
+	 *
+	 * @param string $slug     The slug to truncate.
+	 * @param int    $length   Max length of the slug.
+	 * @param string $expected The expected truncated slug.
+	 * @param string $message  Test feedback message.
+	 */
+	public function test_truncate_post_slug_should_truncate( $slug, $length, $expected, $message ) {
+		$this->assertSame( $expected, _truncate_post_slug( $slug, $length ), $message );
+	}
+
+	/**
+	 * Data provider for test_truncate_post_slug_should_truncate().
+	 *
+	 * @return array[]
+	 */
+	public function data_truncate_post_slug_should_truncate() {
+		return array(
+			'a slug that is too long'                      => array(
+				'slug'     => 'truncated slug',
+				'length'   => 9,
+				'expected' => 'truncated',
+				'message'  => '"truncated slug" should have been truncated to "truncated".',
+			),
+			'a slug that is too long and ends with a dash' => array(
+				'slug'     => 'truncated-slug',
+				'length'   => 10,
+				'expected' => 'truncated',
+				'message'  => '"truncated-slug" should have been truncated to "truncated".',
+			),
+
+			// URL-encoded characters.
+			'URL-encoded characters and "length" includes the first URL-encoded character' => array(
+				'slug'     => 'myslug%2F',
+				'length'   => 7,
+				'expected' => 'myslug',
+				'message'  => '"myslug%2F" should have been truncated to "myslug".',
+			),
+			'URL-encoded characters and "length" includes the second URL-encoded character' => array(
+				'slug'     => 'myslug%2F',
+				'length'   => 8,
+				'expected' => 'myslug',
+				'message'  => '"myslug%2F" should have been truncated to "myslug".',
+			),
+			'URL-encoded characters and "length" includes the third URL-encoded character' => array(
+				'slug'     => 'myslug%2F',
+				'length'   => 9,
+				'expected' => 'myslug%2F',
+				'message'  => '"myslug%2F" should have been truncated to "myslug%2F".',
+			),
+
+			// URL-encoded accent characters.
+			'URL-encoded accent characters and "length" includes the first URL-encoded character' => array(
+				'slug'     => 'myslug%C4%85',
+				'length'   => 7,
+				'expected' => 'myslug',
+				'message'  => '"myslug%C4%85" should have been truncated to "myslug".',
+			),
+			'URL-encoded accent characters and "length" includes the second URL-encoded character' => array(
+				'slug'     => 'myslug%C4%85',
+				'length'   => 8,
+				'expected' => 'myslug',
+				'message'  => '"myslug%C4%85" should have been truncated to "myslug".',
+			),
+			'URL-encoded accent characters and "length" includes the third URL-encoded character' => array(
+				'slug'     => 'myslug%C4%85',
+				'length'   => 9,
+				'expected' => 'myslug',
+				'message'  => '"myslug%C4%85" should have been truncated to "myslug".',
+			),
+			'URL-encoded accent characters and "length" includes the fourth URL-encoded character' => array(
+				'slug'     => 'myslug%C4%85',
+				'length'   => 10,
+				'expected' => 'myslug',
+				'message'  => '"myslug%C4%85" should have been truncated to "myslug".',
+			),
+			'URL-encoded accent characters and "length" includes the fifth URL-encoded character' => array(
+				'slug'     => 'myslug%C4%85',
+				'length'   => 11,
+				'expected' => 'myslug',
+				'message'  => '"myslug%C4%85" should have been truncated to "myslug".',
+			),
+			'URL-encoded accent characters and "length" includes the fifth URL-encoded character' => array(
+				'slug'     => 'myslug%C4%85',
+				'length'   => 12,
+				'expected' => 'myslug%C4%85',
+				'message'  => '"myslug%C4%85" should have been truncated to "myslug%C4%85".',
+			),
+		);
+	}
+}
diff --git a/tests/post/wpAfterInsertPost.php b/tests/post/wpAfterInsertPost.php
index c81ad21387..f184c66e01 100644
--- a/tests/post/wpAfterInsertPost.php
+++ b/tests/post/wpAfterInsertPost.php
@@ -171,7 +171,7 @@ class Tests_Post_wpAfterInsertPost extends WP_UnitTestCase {
 		$post_id = self::$post_id;
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/posts/%d', $post_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( array( 'title' => 'new title' ) );
 		rest_get_server()->dispatch( $request );
 
@@ -188,7 +188,7 @@ class Tests_Post_wpAfterInsertPost extends WP_UnitTestCase {
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', sprintf( '/wp/v2/posts' ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params(
 			array(
 				'title'  => 'new title',
@@ -211,7 +211,7 @@ class Tests_Post_wpAfterInsertPost extends WP_UnitTestCase {
 		$attachment_id = self::$attachment_id;
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/media/%d', $attachment_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( array( 'title' => 'new attachment title' ) );
 		rest_get_server()->dispatch( $request );
 
diff --git a/tests/post/wpDropdownPages.php b/tests/post/wpDropdownPages.php
new file mode 100644
index 0000000000..d838875f1d
--- /dev/null
+++ b/tests/post/wpDropdownPages.php
@@ -0,0 +1,222 @@
+<?php
+
+/**
+ * @group post
+ * @group template
+ *
+ * @covers ::wp_dropdown_pages
+ */
+class Tests_Post_wpDropdownPages extends WP_UnitTestCase {
+
+	public function test_wp_dropdown_pages() {
+		$none = wp_dropdown_pages( array( 'echo' => 0 ) );
+		$this->assertEmpty( $none );
+
+		$bump          = '&nbsp;&nbsp;&nbsp;';
+		$page_id       = self::factory()->post->create( array( 'post_type' => 'page' ) );
+		$child_id      = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_parent' => $page_id,
+			)
+		);
+		$grandchild_id = self::factory()->post->create(
+			array(
+				'post_type'   => 'page',
+				'post_parent' => $child_id,
+			)
+		);
+
+		$title1 = get_post( $page_id )->post_title;
+		$title2 = get_post( $child_id )->post_title;
+		$title3 = get_post( $grandchild_id )->post_title;
+
+		$lineage = <<<LINEAGE
+<select name='page_id' id='page_id'>
+	<option class="level-0" value="$page_id">$title1</option>
+	<option class="level-1" value="$child_id">{$bump}$title2</option>
+	<option class="level-2" value="$grandchild_id">{$bump}{$bump}$title3</option>
+</select>
+
+LINEAGE;
+
+		$output = wp_dropdown_pages( array( 'echo' => 0 ) );
+		$this->assertSameIgnoreEOL( $lineage, $output );
+
+		$depth = <<<DEPTH
+<select name='page_id' id='page_id'>
+	<option class="level-0" value="$page_id">$title1</option>
+</select>
+
+DEPTH;
+
+		$output = wp_dropdown_pages(
+			array(
+				'echo'  => 0,
+				'depth' => 1,
+			)
+		);
+		$this->assertSameIgnoreEOL( $depth, $output );
+
+		$option_none = <<<NONE
+<select name='page_id' id='page_id'>
+	<option value="Woo">Hoo</option>
+	<option class="level-0" value="$page_id">$title1</option>
+</select>
+
+NONE;
+
+		$output = wp_dropdown_pages(
+			array(
+				'echo'              => 0,
+				'depth'             => 1,
+				'show_option_none'  => 'Hoo',
+				'option_none_value' => 'Woo',
+			)
+		);
+		$this->assertSameIgnoreEOL( $option_none, $output );
+
+		$option_no_change = <<<NO
+<select name='page_id' id='page_id'>
+	<option value="-1">Burrito</option>
+	<option value="Woo">Hoo</option>
+	<option class="level-0" value="$page_id">$title1</option>
+</select>
+
+NO;
+
+		$output = wp_dropdown_pages(
+			array(
+				'echo'                  => 0,
+				'depth'                 => 1,
+				'show_option_none'      => 'Hoo',
+				'option_none_value'     => 'Woo',
+				'show_option_no_change' => 'Burrito',
+			)
+		);
+		$this->assertSameIgnoreEOL( $option_no_change, $output );
+	}
+
+	/**
+	 * @ticket 12494
+	 */
+	public function test_wp_dropdown_pages_value_field_should_default_to_ID() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		$found = wp_dropdown_pages(
+			array(
+				'echo' => 0,
+			)
+		);
+
+		// Should contain page ID by default.
+		$this->assertStringContainsString( 'value="' . $p . '"', $found );
+	}
+
+	/**
+	 * @ticket 12494
+	 */
+	public function test_wp_dropdown_pages_value_field_ID() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+			)
+		);
+
+		$found = wp_dropdown_pages(
+			array(
+				'echo'        => 0,
+				'value_field' => 'ID',
+			)
+		);
+
+		$this->assertStringContainsString( 'value="' . $p . '"', $found );
+	}
+
+	/**
+	 * @ticket 12494
+	 */
+	public function test_wp_dropdown_pages_value_field_post_name() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+				'post_name' => 'foo',
+			)
+		);
+
+		$found = wp_dropdown_pages(
+			array(
+				'echo'        => 0,
+				'value_field' => 'post_name',
+			)
+		);
+
+		$this->assertStringContainsString( 'value="foo"', $found );
+	}
+
+	/**
+	 * @ticket 12494
+	 */
+	public function test_wp_dropdown_pages_value_field_should_fall_back_on_ID_when_an_invalid_value_is_provided() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+				'post_name' => 'foo',
+			)
+		);
+
+		$found = wp_dropdown_pages(
+			array(
+				'echo'        => 0,
+				'value_field' => 'foo',
+			)
+		);
+
+		$this->assertStringContainsString( 'value="' . $p . '"', $found );
+	}
+
+	/**
+	 * @ticket 30082
+	 */
+	public function test_wp_dropdown_pages_should_not_contain_class_attribute_when_no_class_is_passed() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+				'post_name' => 'foo',
+			)
+		);
+
+		$found = wp_dropdown_pages(
+			array(
+				'echo' => 0,
+			)
+		);
+
+		$this->assertDoesNotMatchRegularExpression( '/<select[^>]+class=\'/', $found );
+	}
+
+	/**
+	 * @ticket 30082
+	 */
+	public function test_wp_dropdown_pages_should_obey_class_parameter() {
+		$p = self::factory()->post->create(
+			array(
+				'post_type' => 'page',
+				'post_name' => 'foo',
+			)
+		);
+
+		$found = wp_dropdown_pages(
+			array(
+				'echo'  => 0,
+				'class' => 'bar',
+			)
+		);
+
+		$this->assertMatchesRegularExpression( '/<select[^>]+class=\'bar\'/', $found );
+	}
+}
diff --git a/tests/post/wpGetAttachmentLink.php b/tests/post/wpGetAttachmentLink.php
new file mode 100644
index 0000000000..2d658e002e
--- /dev/null
+++ b/tests/post/wpGetAttachmentLink.php
@@ -0,0 +1,106 @@
+<?php
+
+/**
+ * @group post
+ * @group media
+ * @group upload
+ *
+ * @covers ::wp_get_attachment_link
+ */
+class Tests_Post_WpGetAttachmentLink extends WP_UnitTestCase {
+
+	/**
+	 * The ID of an attachment for testing.
+	 *
+	 * @var int $attachment
+	 */
+	private static $attachment;
+
+	/**
+	 * Creates an attachment for testing before any tests run.
+	 */
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		self::$attachment = self::factory()->attachment->create();
+	}
+
+	/**
+	 * Tests that wp_get_attachment_link() applies the
+	 * wp_get_attachment_link_attributes filter.
+	 *
+	 * @ticket 41574
+	 *
+	 * @dataProvider data_should_apply_attributes_filter
+	 *
+	 * @param array  $attributes Attributes to return from the callback.
+	 * @param string $expected   The substring expected to be in the attachment link.
+	 */
+	public function test_should_apply_attributes_filter( $attributes, $expected ) {
+		$expected = str_replace( 'ATTACHMENT_ID', self::$attachment, $expected );
+
+		add_filter(
+			'wp_get_attachment_link_attributes',
+			static function( $attr ) use ( $attributes ) {
+				return array_merge( $attr, $attributes );
+			}
+		);
+
+		$this->assertStringContainsString(
+			$expected,
+			wp_get_attachment_link( self::$attachment )
+		);
+	}
+
+	/**
+	 * Data provider for test_should_apply_attributes_filter().
+	 *
+	 * @return array[]
+	 */
+	public function data_should_apply_attributes_filter() {
+		return array(
+			'no new attributes'                         => array(
+				'attributes' => array(),
+				'expected'   => "<a href='http://example.org/?attachment_id=ATTACHMENT_ID'>",
+			),
+			'one new attribute'                         => array(
+				'attributes' => array(
+					'class' => 'test-attribute-filter',
+				),
+				'expected'   => " class='test-attribute-filter'",
+			),
+			'two new attributes'                        => array(
+				'attributes' => array(
+					'class' => 'test-attribute-filter',
+					'id'    => 'test-attribute-filter-1',
+				),
+				'expected'   => " class='test-attribute-filter' id='test-attribute-filter-1'",
+			),
+			'an existing attribute'                     => array(
+				'attributes' => array(
+					'href' => 'http://test-attribute-filter.org',
+				),
+				'expected'   => " href='http://test-attribute-filter.org'",
+			),
+			'an existing attribute and a new attribute' => array(
+				'attributes' => array(
+					'href'  => 'http://test-attribute-filter.org',
+					'class' => 'test-attribute-filter',
+				),
+				'expected'   => " href='http://test-attribute-filter.org' class='test-attribute-filter'",
+			),
+			'an attribute name with unsafe characters'  => array(
+				'attributes' => array(
+					"> <script>alert('Howdy, admin!')</script> <a href=''></a" => '',
+				),
+				'expected'   => " &gt; &lt;script&gt;alert(&#039;Howdy, admin!&#039;)&lt;/script&gt; &lt;a href=&#039;&#039;&gt;&lt;/a=''",
+			),
+			'an attribute value with unsafe characters' => array(
+				'attributes' => array(
+					'class' => "'> <script>alert('Howdy, admin!')</script> <a href=''></a",
+				),
+				'expected'   => '&#039;&gt; &lt;script&gt;alert(&#039;Howdy, admin!&#039;)&lt;/script&gt; &lt;a href=&#039;&#039;&gt;&lt;/a',
+			),
+		);
+	}
+}
diff --git a/tests/post/wpLinkPages.php b/tests/post/wpLinkPages.php
new file mode 100644
index 0000000000..861ffb9fa8
--- /dev/null
+++ b/tests/post/wpLinkPages.php
@@ -0,0 +1,136 @@
+<?php
+
+/**
+ * @group post
+ * @group template
+ *
+ * @covers ::wp_link_pages
+ */
+class Tests_Post_wpLinkPages extends WP_UnitTestCase {
+
+	public function test_wp_link_pages() {
+		$contents = array( 'One', 'Two', 'Three' );
+		$content  = implode( '<!--nextpage-->', $contents );
+		$post_id  = self::factory()->post->create( array( 'post_content' => $content ) );
+
+		$this->go_to( '?p=' . $post_id );
+
+		setup_postdata( get_post( $post_id ) );
+
+		$permalink = sprintf( '<a href="%s" class="post-page-numbers">', get_permalink() );
+		$page2     = _wp_link_page( 2 );
+		$page3     = _wp_link_page( 3 );
+
+		$expected = '<p class="post-nav-links">Pages: <span class="post-page-numbers current" aria-current="page">1</span> ' . $page2 . '2</a> ' . $page3 . '3</a></p>';
+		$output   = wp_link_pages( array( 'echo' => 0 ) );
+
+		$this->assertSame( $expected, $output );
+
+		$before_after = " <span class=\"post-page-numbers current\" aria-current=\"page\">1</span> {$page2}2</a> {$page3}3</a>";
+		$output       = wp_link_pages(
+			array(
+				'echo'   => 0,
+				'before' => '',
+				'after'  => '',
+			)
+		);
+
+		$this->assertSame( $before_after, $output );
+
+		$separator = " <span class=\"post-page-numbers current\" aria-current=\"page\">1</span>{$page2}2</a>{$page3}3</a>";
+		$output    = wp_link_pages(
+			array(
+				'echo'      => 0,
+				'before'    => '',
+				'after'     => '',
+				'separator' => '',
+			)
+		);
+
+		$this->assertSame( $separator, $output );
+
+		$link   = " <span class=\"post-page-numbers current\" aria-current=\"page\"><em>1</em></span>{$page2}<em>2</em></a>{$page3}<em>3</em></a>";
+		$output = wp_link_pages(
+			array(
+				'echo'        => 0,
+				'before'      => '',
+				'after'       => '',
+				'separator'   => '',
+				'link_before' => '<em>',
+				'link_after'  => '</em>',
+			)
+		);
+
+		$this->assertSame( $link, $output );
+
+		$next   = "{$page2}<em>Next page</em></a>";
+		$output = wp_link_pages(
+			array(
+				'echo'           => 0,
+				'before'         => '',
+				'after'          => '',
+				'separator'      => '',
+				'link_before'    => '<em>',
+				'link_after'     => '</em>',
+				'next_or_number' => 'next',
+			)
+		);
+
+		$this->assertSame( $next, $output );
+
+		$GLOBALS['page'] = 2;
+		$next_prev       = "{$permalink}<em>Previous page</em></a>{$page3}<em>Next page</em></a>";
+		$output          = wp_link_pages(
+			array(
+				'echo'           => 0,
+				'before'         => '',
+				'after'          => '',
+				'separator'      => '',
+				'link_before'    => '<em>',
+				'link_after'     => '</em>',
+				'next_or_number' => 'next',
+			)
+		);
+
+		$this->assertSame( $next_prev, $output );
+
+		$next_prev_link = "{$permalink}Woo page</a>{$page3}Hoo page</a>";
+		$output         = wp_link_pages(
+			array(
+				'echo'             => 0,
+				'before'           => '',
+				'after'            => '',
+				'separator'        => '',
+				'next_or_number'   => 'next',
+				'nextpagelink'     => 'Hoo page',
+				'previouspagelink' => 'Woo page',
+			)
+		);
+
+		$this->assertSame( $next_prev_link, $output );
+
+		$GLOBALS['page'] = 1;
+		$separator       = "<p class=\"post-nav-links\">Pages: <span class=\"post-page-numbers current\" aria-current=\"page\">1</span> | {$page2}2</a> | {$page3}3</a></p>";
+		$output          = wp_link_pages(
+			array(
+				'echo'      => 0,
+				'separator' => ' | ',
+			)
+		);
+
+		$this->assertSame( $separator, $output );
+
+		$pagelink = " <span class=\"post-page-numbers current\" aria-current=\"page\">Page 1</span> | {$page2}Page 2</a> | {$page3}Page 3</a>";
+		$output   = wp_link_pages(
+			array(
+				'echo'      => 0,
+				'separator' => ' | ',
+				'before'    => '',
+				'after'     => '',
+				'pagelink'  => 'Page %',
+			)
+		);
+
+		$this->assertSame( $pagelink, $output );
+	}
+}
diff --git a/tests/post/wpListPages.php b/tests/post/wpListPages.php
index f59585a71c..38ba729cee 100644
--- a/tests/post/wpListPages.php
+++ b/tests/post/wpListPages.php
@@ -448,4 +448,60 @@ class Tests_Post_wpListPages extends WP_UnitTestCase {
 
 		$this->assertSame( $expected, wp_list_pages( $args ) );
 	}
+
+	/**
+	 * @ticket 17590
+	 */
+	public function test_wp_list_pages_classes_with_hierarchical_cpt() {
+		$args = array(
+			'echo'      => false,
+			'post_type' => 'taco',
+		);
+
+		register_post_type(
+			$args['post_type'],
+			array(
+				'hierarchical' => true,
+				'public'       => true,
+			)
+		);
+
+		$posts   = self::factory()->post->create_many( 2, array( 'post_type' => $args['post_type'] ) );
+		$post_id = reset( $posts );
+
+		$this->go_to( "/?p={$post_id}&post_type={$args['post_type']}" );
+
+		$this->assertSame(
+			$post_id,
+			get_queried_object_id(),
+			'The queried object ID should match the ID of the requested CPT item.'
+		);
+
+		$output = wp_list_pages( $args );
+
+		_unregister_post_type( $args['post_type'] );
+
+		$this->assertNotEmpty(
+			$output,
+			'The output should not be empty.'
+		);
+
+		$this->assertSame(
+			2,
+			substr_count( $output, 'class="page_item ' ),
+			'The number of "page_item" classes should be equal to the total CPT items count.'
+		);
+
+		$this->assertStringContainsString(
+			'current_page_item',
+			$output,
+			'The output should contain the "current_page_item" class.'
+		);
+
+		$this->assertSame(
+			1,
+			substr_count( $output, 'current_page_item' ),
+			'The output should contain exactly one "current_page_item" class.'
+		);
+	}
 }
diff --git a/tests/post/wpUniquePostSlug.php b/tests/post/wpUniquePostSlug.php
index 6d279bbbd5..f242159987 100644
--- a/tests/post/wpUniquePostSlug.php
+++ b/tests/post/wpUniquePostSlug.php
@@ -128,7 +128,7 @@ class Tests_Post_wpUniquePostSlug extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider allowed_post_statuses
+	 * @dataProvider data_allowed_post_statuses_should_not_be_forced_to_be_unique
 	 */
 	public function test_allowed_post_statuses_should_not_be_forced_to_be_unique( $status ) {
 		$p1 = self::factory()->post->create(
@@ -149,7 +149,7 @@ class Tests_Post_wpUniquePostSlug extends WP_UnitTestCase {
 		$this->assertSame( 'foo', $actual );
 	}
 
-	public function allowed_post_statuses() {
+	public function data_allowed_post_statuses_should_not_be_forced_to_be_unique() {
 		return array(
 			array( 'draft' ),
 			array( 'pending' ),
diff --git a/tests/privacy/wpCreateUserRequest.php b/tests/privacy/wpCreateUserRequest.php
index 9c6d9f3516..55eb866722 100644
--- a/tests/privacy/wpCreateUserRequest.php
+++ b/tests/privacy/wpCreateUserRequest.php
@@ -1,19 +1,13 @@
 <?php
 /**
- * Test the `wp_create_user_request()` function.
+ * Test cases for the `wp_create_user_request()` function.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.2.0
- */
-
-/**
- * Tests_Privacy_wpCreateUserRequest class.
  *
  * @group privacy
  * @covers ::wp_create_user_request
- *
- * @since 5.2.0
  */
 class Tests_Privacy_wpCreateUserRequest extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacyCompletedRequest.php b/tests/privacy/wpPrivacyCompletedRequest.php
index eb3ae8a2df..0efa6eee45 100644
--- a/tests/privacy/wpPrivacyCompletedRequest.php
+++ b/tests/privacy/wpPrivacyCompletedRequest.php
@@ -1,19 +1,13 @@
 <?php
 /**
- * Test the `_wp_privacy_completed_request()` function.
+ * Test cases for the `_wp_privacy_completed_request()` function.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.9.6
- */
-
-/**
- * Tests_Privacy_wpPrivacyCompletedRequest class.
  *
  * @group privacy
  * @covers ::_wp_privacy_completed_request
- *
- * @since 4.9.6
  */
 class Tests_Privacy_wpPrivacyCompletedRequest extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacyDeleteOldExportFiles.php b/tests/privacy/wpPrivacyDeleteOldExportFiles.php
index 8694468268..fb2caab9a4 100644
--- a/tests/privacy/wpPrivacyDeleteOldExportFiles.php
+++ b/tests/privacy/wpPrivacyDeleteOldExportFiles.php
@@ -1,19 +1,13 @@
 <?php
 /**
- * Define a class to test `wp_privacy_delete_old_export_files()`.
+ * Test cases for the `wp_privacy_delete_old_export_files()` function.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.9.6
- */
-
-/**
- * Test cases for `wp_privacy_delete_old_export_files()`.
  *
  * @group privacy
  * @covers ::wp_privacy_delete_old_export_files
- *
- * @since 4.9.6
  */
 class Tests_Privacy_wpPrivacyDeleteOldExportFiles extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php b/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
index 784845821e..840f756344 100644
--- a/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
+++ b/tests/privacy/wpPrivacyGeneratePersonalDataExportFile.php
@@ -1,20 +1,14 @@
 <?php
 /**
- * Define a class to test `wp_privacy_generate_personal_data_export_file()`.
+ * Test cases for the `wp_privacy_generate_personal_data_export_file()` function.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.2.0
- */
-
-/**
- * Test cases for `wp_privacy_generate_personal_data_export_file()`.
  *
  * @group privacy
  * @covers ::wp_privacy_generate_personal_data_export_file
  * @requires extension zip
- *
- * @since 5.2.0
  */
 class Tests_Privacy_wpPrivacyGeneratePersonalDataExportFile extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php b/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php
index f85186d0c5..5cff95382c 100644
--- a/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php
+++ b/tests/privacy/wpPrivacyGeneratePersonalDataExportGroupHtml.php
@@ -5,15 +5,9 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.2.0
- */
-
-/**
- * Tests_Privacy_wpPrivacyGeneratePersonalDataExportGroupHtml class.
  *
  * @group privacy
  * @covers ::wp_privacy_generate_personal_data_export_group_html
- *
- * @since 5.2.0
  */
 class Tests_Privacy_wpPrivacyGeneratePersonalDataExportGroupHtml extends WP_UnitTestCase {
 
diff --git a/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php b/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
index e8d94d4a77..3f7f7074e6 100644
--- a/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
+++ b/tests/privacy/wpPrivacyProcessPersonalDataExportPage.php
@@ -5,15 +5,9 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.2.0
- */
-
-/**
- * Tests_Privacy_wpPrivacyProcessPersonalDataExportPage class.
  *
  * @group privacy
  * @covers ::wp_privacy_process_personal_data_export_page
- *
- * @since 5.2.0
  */
 class Tests_Privacy_wpPrivacyProcessPersonalDataExportPage extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php b/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
index ef71a5f85d..401528a158 100644
--- a/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
+++ b/tests/privacy/wpPrivacySendErasureFulfillmentNotification.php
@@ -5,15 +5,9 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 5.1.0
- */
-
-/**
- * Tests_Privacy_wpPrivacySendErasureFulfillmentNotification class.
  *
  * @group privacy
  * @covers ::_wp_privacy_send_erasure_fulfillment_notification
- *
- * @since 5.1.0
  */
 class Tests_Privacy_wpPrivacySendErasureFulfillmentNotification extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacySendPersonalDataExportEmail.php b/tests/privacy/wpPrivacySendPersonalDataExportEmail.php
index 5c9336ad97..a0f4c96d29 100644
--- a/tests/privacy/wpPrivacySendPersonalDataExportEmail.php
+++ b/tests/privacy/wpPrivacySendPersonalDataExportEmail.php
@@ -5,15 +5,9 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.9.6
- */
-
-/**
- * Tests_Privacy_wpPrivacySendPersonalDataExportEmail class.
  *
  * @group privacy
  * @covers ::wp_privacy_send_personal_data_export_email
- *
- * @since 4.9.6
  */
 class Tests_Privacy_wpPrivacySendPersonalDataExportEmail extends WP_UnitTestCase {
 	/**
diff --git a/tests/privacy/wpPrivacySendRequestConfirmationNotification.php b/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
index ee083b30c6..5374cd5701 100644
--- a/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
+++ b/tests/privacy/wpPrivacySendRequestConfirmationNotification.php
@@ -5,16 +5,10 @@
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.9.8
- */
-
-/**
- * Tests_Privacy_wpPrivacySendRequestConfirmationNotification class.
  *
  * @group privacy
  * @group user
  * @covers ::_wp_privacy_send_request_confirmation_notification
- *
- * @since 4.9.8
  */
 class Tests_Privacy_wpPrivacySendRequestConfirmationNotification extends WP_UnitTestCase {
 	/**
diff --git a/tests/query/cacheResults.php b/tests/query/cacheResults.php
index 4ac68ceb4e..6ddaffd273 100644
--- a/tests/query/cacheResults.php
+++ b/tests/query/cacheResults.php
@@ -1282,7 +1282,8 @@ class Test_Query_CacheResults extends WP_UnitTestCase {
 	/**
 	 * Ensure lazy loading term meta queries all term meta in a single query.
 	 *
-	 * @since 6.1.2
+	 * @since 6.2.0
+	 *
 	 * @ticket 57163
 	 * @ticket 22176
 	 */
diff --git a/tests/query/lazyLoadCommentMeta.php b/tests/query/lazyLoadCommentMeta.php
new file mode 100644
index 0000000000..93a8d3630f
--- /dev/null
+++ b/tests/query/lazyLoadCommentMeta.php
@@ -0,0 +1,66 @@
+<?php
+
+/**
+ * @group comments
+ * @group meta
+ */
+class Tests_Lazy_Load_Comment_Meta extends WP_UnitTestCase {
+
+	/**
+	 * @var int
+	 */
+	protected static $post_id;
+
+	/**
+	 * @var array
+	 */
+	protected static $comment_ids = array();
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+
+		self::$post_id     = $factory->post->create();
+		self::$comment_ids = $factory->comment->create_post_comments( self::$post_id, 11 );
+	}
+
+	/**
+	 * @ticket 57901
+	 *
+	 * @covers ::wp_queue_comments_for_comment_meta_lazyload
+	 */
+	public function test_wp_queue_comments_for_comment_meta_lazyload() {
+		$filter = new MockAction();
+		add_filter( 'update_comment_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		$comments   = array_map( 'get_comment', self::$comment_ids );
+		$comment_id = reset( self::$comment_ids );
+		wp_queue_comments_for_comment_meta_lazyload( $comments );
+		get_comment_meta( $comment_id );
+
+		$args             = $filter->get_args();
+		$first            = reset( $args );
+		$comment_meta_ids = end( $first );
+		$this->assertSameSets( self::$comment_ids, $comment_meta_ids );
+	}
+
+	/**
+	 * @ticket 57901
+	 *
+	 * @covers ::wp_queue_comments_for_comment_meta_lazyload
+	 */
+	public function test_wp_queue_comments_for_comment_meta_lazyload_new_comment() {
+		$filter = new MockAction();
+		add_filter( 'update_comment_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		$comments   = array_map( 'get_comment', self::$comment_ids );
+		$comment_id = self::factory()->comment->create(
+			array(
+				'comment_post_ID' => self::$post_id,
+			)
+		);
+		wp_queue_comments_for_comment_meta_lazyload( $comments );
+		get_comment_meta( $comment_id );
+
+		$args             = $filter->get_args();
+		$first            = reset( $args );
+		$comment_meta_ids = end( $first );
+		$this->assertContains( $comment_id, $comment_meta_ids );
+	}
+}
diff --git a/tests/query/lazyLoadTermMeta.php b/tests/query/lazyLoadTermMeta.php
new file mode 100644
index 0000000000..85ef586dc6
--- /dev/null
+++ b/tests/query/lazyLoadTermMeta.php
@@ -0,0 +1,168 @@
+<?php
+
+/**
+ * @group query
+ * @group taxonomy
+ * @group meta
+ */
+class Test_Lazy_Load_Term_Meta extends WP_UnitTestCase {
+	/**
+	 * @var array
+	 */
+	protected static $post_ids = array();
+	/**
+	 * @var array
+	 */
+	protected static $term_ids = array();
+
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		$post_type      = 'post';
+		self::$post_ids = $factory->post->create_many(
+			3,
+			array(
+				'post_type'   => $post_type,
+				'post_status' => 'publish',
+			)
+		);
+		$taxonomies     = get_object_taxonomies( $post_type, 'object' );
+		foreach ( self::$post_ids  as $post_id ) {
+			foreach ( $taxonomies as $taxonomy ) {
+				if ( ! $taxonomy->_builtin ) {
+					continue;
+				}
+				$terms          = $factory->term->create_many( 3, array( 'taxonomy' => $taxonomy->name ) );
+				self::$term_ids = array_merge( self::$term_ids, $terms );
+				foreach ( $terms as $term ) {
+					add_term_meta( $term, wp_rand(), 'test' );
+				}
+				wp_set_object_terms( $post_id, $terms, $taxonomy->name );
+			}
+		}
+	}
+
+	/**
+	 * @ticket 57150
+	 * @covers ::wp_queue_posts_for_term_meta_lazyload
+	 */
+	public function test_wp_queue_posts_for_term_meta_lazyload() {
+		$filter = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		new WP_Query(
+			array(
+				'post__in'            => self::$post_ids,
+				'lazy_load_term_meta' => true,
+			)
+		);
+
+		get_term_meta( end( self::$term_ids ) );
+
+		$args     = $filter->get_args();
+		$first    = reset( $args );
+		$term_ids = end( $first );
+		$this->assertSameSets( $term_ids, self::$term_ids );
+	}
+
+	/**
+	 * @ticket 57150
+	 * @covers ::wp_queue_posts_for_term_meta_lazyload
+	 */
+	public function test_wp_queue_posts_for_term_meta_lazyload_update_post_term_cache() {
+		$filter = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		new WP_Query(
+			array(
+				'post__in'               => self::$post_ids,
+				'lazy_load_term_meta'    => true,
+				'update_post_term_cache' => false,
+			)
+		);
+
+		get_term_meta( end( self::$term_ids ) );
+
+		$args     = $filter->get_args();
+		$first    = reset( $args );
+		$term_ids = end( $first );
+		$this->assertSameSets( $term_ids, self::$term_ids );
+	}
+
+	/**
+	 * @ticket 57150
+	 * @covers ::wp_queue_posts_for_term_meta_lazyload
+	 */
+	public function test_wp_queue_posts_for_term_meta_lazyload_false() {
+		$filter = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+		new WP_Query(
+			array(
+				'post__in'            => self::$post_ids,
+				'lazy_load_term_meta' => false,
+			)
+		);
+
+		$term_id = end( self::$term_ids );
+		get_term_meta( $term_id );
+
+		$args     = $filter->get_args();
+		$first    = reset( $args );
+		$term_ids = end( $first );
+		$this->assertSameSets( $term_ids, array( $term_id ) );
+	}
+
+
+	/**
+	 * @ticket 57901
+	 *
+	 * @covers ::wp_queue_posts_for_term_meta_lazyload
+	 */
+	public function test_wp_queue_posts_for_term_meta_lazyload_insert_term() {
+		$filter = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+		register_taxonomy( 'wptests_tax', 'post' );
+
+		$t1      = wp_insert_term( 'Foo', 'wptests_tax' );
+		$term_id = $t1['term_id'];
+
+		new WP_Query(
+			array(
+				'post__in'            => self::$post_ids,
+				'lazy_load_term_meta' => true,
+			)
+		);
+
+		get_term_meta( $term_id );
+
+		$args     = $filter->get_args();
+		$first    = reset( $args );
+		$term_ids = end( $first );
+		$this->assertContains( $term_id, $term_ids );
+	}
+
+	/**
+	 * @ticket 57150
+	 * @covers ::wp_queue_posts_for_term_meta_lazyload
+	 */
+	public function test_wp_queue_posts_for_term_meta_lazyload_delete_term() {
+		$filter = new MockAction();
+		add_filter( 'update_term_metadata_cache', array( $filter, 'filter' ), 10, 2 );
+
+		$remove_term_id = end( self::$term_ids );
+		$term           = get_term( $remove_term_id );
+		wp_delete_term( $remove_term_id, $term->taxonomy );
+
+		new WP_Query(
+			array(
+				'post__in'            => self::$post_ids,
+				'lazy_load_term_meta' => true,
+			)
+		);
+
+		$term_id = end( self::$term_ids );
+		get_term_meta( $term_id );
+
+		$args     = $filter->get_args();
+		$first    = reset( $args );
+		$term_ids = end( $first );
+		$this->assertContains( $remove_term_id, $term_ids );
+	}
+}
diff --git a/tests/query/searchColumns.php b/tests/query/searchColumns.php
new file mode 100644
index 0000000000..463bef8107
--- /dev/null
+++ b/tests/query/searchColumns.php
@@ -0,0 +1,414 @@
+<?php
+/**
+ * Testing the search columns support in `WP_Query`.
+ *
+ * @package WordPress\UnitTests
+ * @since 6.2.0
+ */
+
+/**
+ * Test cases for the search columns feature.
+ *
+ * @group query
+ * @group search
+ *
+ * @covers WP_Query::parse_search
+ *
+ * @since 6.2.0
+ */
+class Tests_Query_SearchColumns extends WP_UnitTestCase {
+	/**
+	 * The post ID of the first fixture post.
+	 *
+	 * @since 6.2.0
+	 * @var int $pid1
+	 */
+	protected static $pid1;
+
+	/**
+	 * The post ID of the second fixture post.
+	 *
+	 * @since 6.2.0
+	 * @var int $pid2
+	 */
+	protected static $pid2;
+
+	/**
+	 * The post ID of the third fixture post.
+	 *
+	 * @since 6.2.0
+	 * @var int $pid3
+	 */
+	protected static $pid3;
+
+	/**
+	 * Create posts fixtures.
+	 *
+	 * @param WP_UnitTest_Factory $factory The factory instance.
+	 */
+	public static function wpSetUpBeforeClass( WP_UnitTest_Factory $factory ) {
+		self::$pid1 = $factory->post->create(
+			array(
+				'post_status'  => 'publish',
+				'post_title'   => 'foo title',
+				'post_excerpt' => 'foo excerpt',
+				'post_content' => 'foo content',
+			)
+		);
+		self::$pid2 = $factory->post->create(
+			array(
+				'post_status'  => 'publish',
+				'post_title'   => 'bar title',
+				'post_excerpt' => 'foo bar excerpt',
+				'post_content' => 'foo bar content',
+			)
+		);
+
+		self::$pid3 = $factory->post->create(
+			array(
+				'post_status'  => 'publish',
+				'post_title'   => 'baz title',
+				'post_excerpt' => 'baz bar excerpt',
+				'post_content' => 'baz bar foo content',
+			)
+		);
+	}
+
+	/**
+	 * Tests that search uses default search columns when search columns are empty.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_use_default_search_columns_when_empty_search_columns() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array(),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertStringContainsString( 'post_title', $q->request, 'SQL request should contain post_title string.' );
+		$this->assertStringContainsString( 'post_excerpt', $q->request, 'SQL request should contain post_excerpt string.' );
+		$this->assertStringContainsString( 'post_content', $q->request, 'SQL request should contain post_content string.' );
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts, 'Query results should be equal to the set.' );
+	}
+
+	/**
+	 * Tests that search supports the `post_title` search column.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_title_search_column() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_title' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports the `post_excerpt` search column.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_excerpt_search_column() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_excerpt' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1, self::$pid2 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports the `post_content` search column.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_content_search_column() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_content' ),
+				'fields'         => 'ids',
+			)
+		);
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports the `post_title` and `post_excerpt` search columns together.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_title_and_post_excerpt_search_columns() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_title', 'post_excerpt' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1, self::$pid2 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports the `post_title` and `post_content` search columns together.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_title_and_post_content_search_columns() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_title', 'post_content' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports the `post_excerpt` and `post_content` search columns together.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_excerpt_and_post_content_search_columns() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_excerpt', 'post_content' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports the `post_title`, `post_excerpt` and `post_content` search columns together.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_post_title_and_post_excerpt_and_post_content_search_columns() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_title', 'post_excerpt', 'post_content' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search uses default search columns when using a non-existing search column.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_use_default_search_columns_when_using_non_existing_search_column() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_non_existing_column' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertStringContainsString( 'post_title', $q->request, 'SQL request should contain post_title string.' );
+		$this->assertStringContainsString( 'post_excerpt', $q->request, 'SQL request should contain post_excerpt string.' );
+		$this->assertStringContainsString( 'post_content', $q->request, 'SQL request should contain post_content string.' );
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts, 'Query results should be equal to the set.' );
+	}
+
+	/**
+	 * Tests that search ignores a non-existing search column when used together with a supported one.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_ignore_non_existing_search_column_when_used_with_supported_one() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo',
+				'search_columns' => array( 'post_title', 'post_non_existing_column' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports search columns when searching multiple terms.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_search_columns_when_searching_multiple_terms() {
+		$q = new WP_Query(
+			array(
+				's'              => 'foo bar',
+				'search_columns' => array( 'post_content' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid2, self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports search columns when searching for a sentence.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_search_columns_when_sentence_true() {
+		$q = new WP_Query(
+			array(
+				's'              => 'bar foo',
+				'search_columns' => array( 'post_content' ),
+				'sentence'       => true,
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports search columns when searching for a sentence.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_search_columns_when_sentence_false() {
+		$q = new WP_Query(
+			array(
+				's'              => 'bar foo',
+				'search_columns' => array( 'post_content' ),
+				'sentence'       => false,
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid2, self::$pid3 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search supports search columns when using term exclusion.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_s_should_support_search_columns_when_searching_with_term_exclusion() {
+		$q = new WP_Query(
+			array(
+				's'              => 'bar -baz',
+				'search_columns' => array( 'post_excerpt', 'post_content' ),
+				'fields'         => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid2 ), $q->posts );
+	}
+
+	/**
+	 * Tests that search columns is filterable with the `post_search_columns` filter.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_search_columns_should_be_filterable() {
+		add_filter( 'post_search_columns', array( $this, 'post_supported_search_column' ), 10, 3 );
+		$q = new WP_Query(
+			array(
+				's'      => 'foo',
+				'fields' => 'ids',
+			)
+		);
+
+		$this->assertSameSets( array( self::$pid1 ), $q->posts );
+	}
+
+	/**
+	 * Filter callback that sets a supported search column.
+	 *
+	 * @param  string[] $search_columns Array of column names to be searched.
+	 * @param  string   $search         Text being searched.
+	 * @param  WP_Query $wp_query       The current WP_Query instance.
+	 * @return string[] $search_columns Array of column names to be searched.
+	 */
+	public function post_supported_search_column( $search_columns, $search, $wp_query ) {
+		$search_columns = array( 'post_title' );
+		return $search_columns;
+	}
+
+	/**
+	 * Tests that search columns ignores non-supported search columns from the `post_search_columns` filter.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_search_columns_should_not_be_filterable_with_non_supported_search_columns() {
+		add_filter( 'post_search_columns', array( $this, 'post_non_supported_search_column' ), 10, 3 );
+		$q = new WP_Query(
+			array(
+				's'      => 'foo',
+				'fields' => 'ids',
+			)
+		);
+
+		$this->assertStringNotContainsString( 'post_name', $q->request, "SQL request shouldn't contain post_name string." );
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts, 'Query results should be equal to the set.' );
+	}
+
+	/**
+	 * Filter callback that sets an existing but non-supported search column.
+	 *
+	 * @param  string[] $search_columns Array of column names to be searched.
+	 * @param  string   $search         Text being searched.
+	 * @param  WP_Query $wp_query       The current WP_Query instance.
+	 * @return string[] $search_columns Array of column names to be searched.
+	 */
+	public function post_non_supported_search_column( $search_columns, $search, $wp_query ) {
+		$search_columns = array( 'post_name' );
+		return $search_columns;
+	}
+
+	/**
+	 * Tests that search columns ignores non-existing search columns from the `post_search_columns` filter.
+	 *
+	 * @ticket 43867
+	 */
+	public function test_search_columns_should_not_be_filterable_with_non_existing_search_column() {
+		add_filter( 'post_search_columns', array( $this, 'post_non_existing_search_column' ), 10, 3 );
+		$q = new WP_Query(
+			array(
+				's'      => 'foo',
+				'fields' => 'ids',
+			)
+		);
+
+		$this->assertStringNotContainsString( 'post_non_existing_column', $q->request, "SQL request shouldn't contain post_non_existing_column string." );
+		$this->assertSameSets( array( self::$pid1, self::$pid2, self::$pid3 ), $q->posts, 'Query results should be equal to the set.' );
+	}
+
+	/**
+	 * Filter callback that sets a non-existing search column.
+	 *
+	 * @param  string[] $search_columns Array of column names to be searched.
+	 * @param  string   $search         Text being searched.
+	 * @param  WP_Query $wp_query       The current WP_Query instance.
+	 * @return string[] $search_columns Array of column names to be searched.
+	 */
+	public function post_non_existing_search_column( $search_columns, $search, $wp_query ) {
+		$search_columns = array( 'post_non_existing_column' );
+		return $search_columns;
+	}
+
+}
diff --git a/tests/query/taxQuery.php b/tests/query/taxQuery.php
index e67ca6f36e..f517e4bb84 100644
--- a/tests/query/taxQuery.php
+++ b/tests/query/taxQuery.php
@@ -1628,8 +1628,6 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 	 * @covers WP_Tax_Query::transform_query
 	 */
 	public function test_tax_terms_should_limit_query() {
-		$filter = new MockAction();
-		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
 		register_taxonomy( 'wptests_tax', 'post' );
 		$name = 'foobar';
 		$t    = self::factory()->term->create(
@@ -1642,6 +1640,9 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 		$p = self::factory()->post->create();
 		wp_set_object_terms( $p, array( $t ), 'wptests_tax' );
 
+		$filter = new MockAction();
+		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
+
 		$q = new WP_Query(
 			array(
 				'fields'    => 'ids',
@@ -1656,7 +1657,7 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 		);
 
 		$filter_args = $filter->get_args();
-		$query       = $filter_args[1][1]->request;
+		$query       = $filter_args[0][1]->request;
 
 		$this->assertSameSets( array( $p ), $q->posts );
 		$this->assertStringContainsString( 'LIMIT 1', $query );
@@ -1668,8 +1669,6 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 	 * @covers WP_Tax_Query::transform_query
 	 */
 	public function test_tax_terms_should_limit_query_to_one() {
-		$filter = new MockAction();
-		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
 		register_taxonomy( 'wptests_tax', 'post' );
 		$name = 'foobar';
 		$t    = self::factory()->term->create(
@@ -1682,6 +1681,9 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 		$p = self::factory()->post->create();
 		wp_set_object_terms( $p, array( $t ), 'wptests_tax' );
 
+		$filter = new MockAction();
+		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
+
 		$q = new WP_Query(
 			array(
 				'fields'    => 'ids',
@@ -1696,7 +1698,7 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 		);
 
 		$filter_args = $filter->get_args();
-		$query       = $filter_args[1][1]->request;
+		$query       = $filter_args[0][1]->request;
 
 		$this->assertSameSets( array( $p ), $q->posts );
 		$this->assertStringContainsString( 'LIMIT 1', $query );
@@ -1708,8 +1710,6 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 	 * @covers WP_Tax_Query::transform_query
 	 */
 	public function test_hierarchical_taxonomies_do_not_limit_query() {
-		$filter = new MockAction();
-		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
 		register_taxonomy( 'wptests_tax', 'post', array( 'hierarchical' => true ) );
 		$name = 'foobar';
 		$t    = self::factory()->term->create(
@@ -1722,6 +1722,9 @@ class Tests_Query_TaxQuery extends WP_UnitTestCase {
 		$p = self::factory()->post->create();
 		wp_set_object_terms( $p, array( $t ), 'wptests_tax' );
 
+		$filter = new MockAction();
+		add_filter( 'terms_pre_query', array( $filter, 'filter' ), 10, 2 );
+
 		$q = new WP_Query(
 			array(
 				'fields'    => 'ids',
diff --git a/tests/rest-api.php b/tests/rest-api.php
index 854e9b8338..20b23fc0fb 100644
--- a/tests/rest-api.php
+++ b/tests/rest-api.php
@@ -27,6 +27,10 @@ class Tests_REST_API extends WP_UnitTestCase {
 		parent::tear_down();
 	}
 
+	public function filter_wp_rest_server_class( $class_name ) {
+		return 'Spy_REST_Server';
+	}
+
 	/**
 	 * Checks that the main classes are loaded.
 	 */
@@ -822,7 +826,14 @@ class Tests_REST_API extends WP_UnitTestCase {
 		unset( $filter );
 	}
 
-	public function jsonp_callback_provider() {
+	/**
+	 * @dataProvider data_jsonp_callback_check
+	 */
+	public function test_jsonp_callback_check( $callback, $expected ) {
+		$this->assertSame( $expected, wp_check_jsonp_callback( $callback ) );
+	}
+
+	public function data_jsonp_callback_check() {
 		return array(
 			// Standard names.
 			array( 'Springfield', true ),
@@ -841,13 +852,13 @@ class Tests_REST_API extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider jsonp_callback_provider
+	 * @dataProvider data_rest_parse_date
 	 */
-	public function test_jsonp_callback_check( $callback, $valid ) {
-		$this->assertSame( $valid, wp_check_jsonp_callback( $callback ) );
+	public function test_rest_parse_date( $date, $expected ) {
+		$this->assertEquals( $expected, rest_parse_date( $date ) );
 	}
 
-	public function rest_date_provider() {
+	public function data_rest_parse_date() {
 		return array(
 			// Valid dates with timezones.
 			array( '2017-01-16T11:30:00-05:00', gmmktime( 11, 30, 0, 1, 16, 2017 ) + 5 * HOUR_IN_SECONDS ),
@@ -873,13 +884,13 @@ class Tests_REST_API extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider rest_date_provider
+	 * @dataProvider data_rest_parse_date_force_utc
 	 */
-	public function test_rest_parse_date( $string, $value ) {
-		$this->assertEquals( $value, rest_parse_date( $string ) );
+	public function test_rest_parse_date_force_utc( $date, $expected ) {
+		$this->assertSame( $expected, rest_parse_date( $date, true ) );
 	}
 
-	public function rest_date_force_utc_provider() {
+	public function data_rest_parse_date_force_utc() {
 		return array(
 			// Valid dates with timezones.
 			array( '2017-01-16T11:30:00-05:00', gmmktime( 11, 30, 0, 1, 16, 2017 ) ),
@@ -904,17 +915,6 @@ class Tests_REST_API extends WP_UnitTestCase {
 		);
 	}
 
-	/**
-	 * @dataProvider rest_date_force_utc_provider
-	 */
-	public function test_rest_parse_date_force_utc( $string, $value ) {
-		$this->assertSame( $value, rest_parse_date( $string, true ) );
-	}
-
-	public function filter_wp_rest_server_class( $class_name ) {
-		return 'Spy_REST_Server';
-	}
-
 	public function test_register_rest_route_without_server() {
 		$GLOBALS['wp_rest_server'] = null;
 		add_filter( 'wp_rest_server_class', array( $this, 'filter_wp_rest_server_class' ) );
@@ -1783,7 +1783,7 @@ class Tests_REST_API extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider rest_ensure_response_data_provider
+	 * @dataProvider data_rest_ensure_response_returns_instance_of_wp_rest_response
 	 *
 	 * @param mixed $response      The response passed to rest_ensure_response().
 	 * @param mixed $expected_data The expected data a response should include.
@@ -1799,7 +1799,7 @@ class Tests_REST_API extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function rest_ensure_response_data_provider() {
+	public function data_rest_ensure_response_returns_instance_of_wp_rest_response() {
 		return array(
 			array( null, null ),
 			array( array( 'chocolate' => 'cookies' ), array( 'chocolate' => 'cookies' ) ),
diff --git a/tests/rest-api/application-passwords.php b/tests/rest-api/application-passwords.php
index b3edab0d72..a630719ee8 100644
--- a/tests/rest-api/application-passwords.php
+++ b/tests/rest-api/application-passwords.php
@@ -4,9 +4,7 @@
  *
  * @package    WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group  restapi
  * @group  app_password
  */
diff --git a/tests/rest-api/rest-application-passwords-controller.php b/tests/rest-api/rest-application-passwords-controller.php
index 1162c1f733..0515c31512 100644
--- a/tests/rest-api/rest-application-passwords-controller.php
+++ b/tests/rest-api/rest-application-passwords-controller.php
@@ -4,9 +4,7 @@
  *
  * @package    WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Application_Passwords_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-attachments-controller.php b/tests/rest-api/rest-attachments-controller.php
index 0a37e44a95..55cf74f3d7 100644
--- a/tests/rest-api/rest-attachments-controller.php
+++ b/tests/rest-api/rest-attachments-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Controller_Testcase {
@@ -137,7 +135,16 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertCount( 3, $routes['/wp/v2/media/(?P<id>[\d]+)'] );
 	}
 
-	public static function disposition_provider() {
+	/**
+	 * @dataProvider data_parse_disposition
+	 */
+	public function test_parse_disposition( $header, $expected ) {
+		$header_list = array( $header );
+		$parsed      = WP_REST_Attachments_Controller::get_filename_from_disposition( $header_list );
+		$this->assertSame( $expected, $parsed );
+	}
+
+	public static function data_parse_disposition() {
 		return array(
 			// Types.
 			array( 'attachment; filename="foo.jpg"', 'foo.jpg' ),
@@ -169,15 +176,6 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		);
 	}
 
-	/**
-	 * @dataProvider disposition_provider
-	 */
-	public function test_parse_disposition( $header, $expected ) {
-		$header_list = array( $header );
-		$parsed      = WP_REST_Attachments_Controller::get_filename_from_disposition( $header_list );
-		$this->assertSame( $expected, $parsed );
-	}
-
 	public function test_context_param() {
 		// Collection.
 		$request  = new WP_REST_Request( 'OPTIONS', '/wp/v2/media' );
@@ -230,6 +228,7 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 				'parent_exclude',
 				'per_page',
 				'search',
+				'search_columns',
 				'slug',
 				'status',
 			),
@@ -1258,7 +1257,17 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		$this->assertSame( $expected_output['caption']['raw'], $post->post_excerpt );
 	}
 
-	public static function attachment_roundtrip_provider() {
+	/**
+	 * @dataProvider data_attachment_roundtrip_as_author
+	 * @requires function imagejpeg
+	 */
+	public function test_attachment_roundtrip_as_author( $raw, $expected ) {
+		wp_set_current_user( self::$author_id );
+		$this->assertFalse( current_user_can( 'unfiltered_html' ) );
+		$this->verify_attachment_roundtrip( $raw, $expected );
+	}
+
+	public static function data_attachment_roundtrip_as_author() {
 		return array(
 			array(
 				// Raw values.
@@ -1355,16 +1364,6 @@ class WP_Test_REST_Attachments_Controller extends WP_Test_REST_Post_Type_Control
 		);
 	}
 
-	/**
-	 * @dataProvider attachment_roundtrip_provider
-	 * @requires function imagejpeg
-	 */
-	public function test_post_roundtrip_as_author( $raw, $expected ) {
-		wp_set_current_user( self::$author_id );
-		$this->assertFalse( current_user_can( 'unfiltered_html' ) );
-		$this->verify_attachment_roundtrip( $raw, $expected );
-	}
-
 	/**
 	 * @requires function imagejpeg
 	 */
diff --git a/tests/rest-api/rest-autosaves-controller.php b/tests/rest-api/rest-autosaves-controller.php
index 088f02b67d..b043b5e073 100644
--- a/tests/rest-api/rest-autosaves-controller.php
+++ b/tests/rest-api/rest-autosaves-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi-autosave
  * @group restapi
  */
@@ -311,7 +309,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		wp_set_current_user( self::$editor_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 
 		$params = $this->set_post_data(
 			array(
@@ -327,7 +325,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 	public function test_update_item() {
 		wp_set_current_user( self::$editor_id );
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 
 		$params = $this->set_post_data(
 			array(
@@ -346,7 +344,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		wp_set_current_user( self::$contributor_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 
 		$params = $this->set_post_data(
 			array(
@@ -365,7 +363,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		wp_set_current_user( self::$editor_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 
 		$current_post = get_post( self::$post_id );
 
@@ -412,7 +410,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $autosave_data ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -451,7 +449,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $autosave_data ) );
 
 		$response     = rest_get_server()->dispatch( $request );
@@ -572,7 +570,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 	public function test_update_item_draft_page_with_parent() {
 		wp_set_current_user( self::$editor_id );
 		$request = new WP_REST_Request( 'POST', '/wp/v2/pages/' . self::$child_draft_page_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 
 		$params = $this->set_post_data(
 			array(
@@ -593,7 +591,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 		wp_set_current_user( self::$editor_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/pages/' . self::$draft_page_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 
 		$params = $this->set_post_data(
 			array(
@@ -648,7 +646,7 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 
 		// Initiate an autosave via the REST API as Gutenberg does.
 		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . self::$post_id . '/autosaves' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $autosave_data ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -674,4 +672,38 @@ class WP_Test_REST_Autosaves_Controller extends WP_Test_REST_Post_Type_Controlle
 
 		wp_delete_post( $post_id );
 	}
+
+	/**
+	 * @ticket 49532
+	 *
+	 * @covers WP_REST_Autosaves_Controller::create_post_autosave
+	 */
+	public function test_rest_autosave_do_not_create_autosave_when_post_is_unchanged() {
+		// Create a post by the editor.
+		$post_data = array(
+			'post_content' => 'Test post content',
+			'post_title'   => 'Test post title',
+			'post_excerpt' => 'Test post excerpt',
+			'post_author'  => self::$editor_id,
+			'post_status'  => 'publish',
+		);
+		$post_id   = wp_insert_post( $post_data );
+
+		wp_set_current_user( self::$editor_id );
+
+		$autosave_data = array(
+			'post_content' => $post_data['post_content'],
+		);
+
+		// Create autosaves response.
+		$request = new WP_REST_Request( 'POST', '/wp/v2/posts/' . $post_id . '/autosaves' );
+		$request->add_header( 'Content-Type', 'application/json' );
+		$request->set_body( wp_json_encode( $autosave_data ) );
+
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+
+		$this->assertSame( 400, $response->get_status(), 'Response status is not 400.' );
+		$this->assertSame( 'rest_autosave_no_changes', $data['code'], 'Response "code" is not "rest_autosave_no_changes"' );
+	}
 }
diff --git a/tests/rest-api/rest-block-directory-controller.php b/tests/rest-api/rest-block-directory-controller.php
index fd679dbb7b..c3cac6011e 100644
--- a/tests/rest-api/rest-block-directory-controller.php
+++ b/tests/rest-api/rest-block-directory-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_REST_Block_Directory_Controller_Test extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-block-renderer-controller.php b/tests/rest-api/rest-block-renderer-controller.php
index 71d02d4832..3c79da5651 100644
--- a/tests/rest-api/rest-block-renderer-controller.php
+++ b/tests/rest-api/rest-block-renderer-controller.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_REST_Block_Renderer_Controller tests.
+ * Unit tests covering WP_REST_Block_Renderer_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.0.0
- */
-
-/**
- * Tests for WP_REST_Block_Renderer_Controller.
- *
- * @since 5.0.0
  *
  * @covers WP_REST_Block_Renderer_Controller
  *
@@ -501,7 +495,7 @@ class REST_Block_Renderer_Controller_Test extends WP_Test_REST_Controller_Testca
 		$attributes       = array( 'some_string' => $string_attribute );
 		$request          = new WP_REST_Request( 'POST', self::$rest_api_route . self::$block_name );
 		$request->set_param( 'context', 'edit' );
-		$request->set_header( 'content-type', 'application/json' );
+		$request->set_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( compact( 'attributes' ) ) );
 		$response = rest_get_server()->dispatch( $request );
 
diff --git a/tests/rest-api/rest-block-type-controller.php b/tests/rest-api/rest-block-type-controller.php
index b7342a0a43..4dc177722e 100644
--- a/tests/rest-api/rest-block-type-controller.php
+++ b/tests/rest-api/rest-block-type-controller.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_REST_Block_Types_Controller tests.
+ * Unit tests covering WP_REST_Block_Types_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.5.0
- */
-
-/**
- * Tests for WP_REST_Block_Types_Controller.
- *
- * @since 5.5.0
  *
  * @covers WP_REST_Block_Types_Controller
  *
@@ -223,7 +217,7 @@ class REST_Block_Type_Controller_Test extends WP_Test_REST_Controller_Testcase {
 			'parent'           => 'invalid_parent',
 			'ancestor'         => 'invalid_ancestor',
 			'supports'         => 'invalid_supports',
-			'styles'           => 'invalid_styles',
+			'styles'           => array(),
 			'render_callback'  => 'invalid_callback',
 			'textdomain'       => true,
 			'variations'       => 'invalid_variations',
diff --git a/tests/rest-api/rest-blocks-controller.php b/tests/rest-api/rest-blocks-controller.php
index c3e0a9fb75..48208d2175 100644
--- a/tests/rest-api/rest-blocks-controller.php
+++ b/tests/rest-api/rest-blocks-controller.php
@@ -1,18 +1,12 @@
 <?php
 /**
- * WP_REST_Blocks_Controller tests
+ * Unit tests covering WP_REST_Blocks_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.0.0
- */
-
-/**
- * Tests for WP_REST_Blocks_Controller.
- *
- * @since 5.0.0
  *
- * @see WP_Test_REST_Controller_Testcase
+ * @covers WP_REST_Blocks_Controller
  *
  * @group restapi-blocks
  * @group restapi
diff --git a/tests/rest-api/rest-categories-controller.php b/tests/rest-api/rest-categories-controller.php
index 6e594afe31..a6ad0cf700 100644
--- a/tests/rest-api/rest-categories-controller.php
+++ b/tests/rest-api/rest-categories-controller.php
@@ -5,9 +5,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Categories_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-comments-controller.php b/tests/rest-api/rest-comments-controller.php
index 2726ce68c9..9b4444f559 100644
--- a/tests/rest-api/rest-comments-controller.php
+++ b/tests/rest-api/rest-comments-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase {
@@ -1133,7 +1131,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1146,7 +1144,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		$this->assertSame( self::$post_id, $data['post'] );
 	}
 
-	public function comment_dates_provider() {
+	public function data_comment_dates() {
 		return array(
 			'set date without timezone'     => array(
 				'params'  => array(
@@ -1192,7 +1190,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	/**
-	 * @dataProvider comment_dates_provider
+	 * @dataProvider data_comment_dates
 	 */
 	public function test_create_comment_date( $params, $results ) {
 		wp_set_current_user( self::$admin_id );
@@ -1239,7 +1237,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1264,7 +1262,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1287,7 +1285,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1307,7 +1305,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1327,7 +1325,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1347,7 +1345,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1365,7 +1363,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1386,7 +1384,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1413,7 +1411,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1435,7 +1433,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1460,7 +1458,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1481,7 +1479,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1510,7 +1508,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertSame( 201, $response->get_status() );
@@ -1536,7 +1534,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1575,7 +1573,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1598,7 +1596,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1625,7 +1623,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1654,7 +1652,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1679,7 +1677,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1699,7 +1697,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1720,7 +1718,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1744,7 +1742,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1768,8 +1766,8 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
-		$request->add_header( 'user_agent', 'Mozilla/4.0 (compatible; MSIE 5.5; AOL 4.0; Windows 95)' );
+		$request->add_header( 'Content-Type', 'application/json' );
+		$request->add_header( 'User_Agent', 'Mozilla/4.0 (compatible; MSIE 5.5; AOL 4.0; Windows 95)' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1794,7 +1792,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'status'       => 'approved',
 		);
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response    = rest_get_server()->dispatch( $request );
 		$data        = $response->get_data();
@@ -1815,7 +1813,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 			'status'       => 'approved',
 		);
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1835,7 +1833,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_comment_invalid_author_ip', $response, 403 );
@@ -1855,7 +1853,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response    = rest_get_server()->dispatch( $request );
 		$data        = $response->get_data();
@@ -1875,7 +1873,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1895,7 +1893,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1915,7 +1913,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1935,7 +1933,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1955,7 +1953,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1976,7 +1974,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -1996,7 +1994,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2023,7 +2021,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2044,7 +2042,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2075,7 +2073,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2093,7 +2091,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2117,7 +2115,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2132,7 +2130,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2156,7 +2154,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2183,7 +2181,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2207,7 +2205,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2231,7 +2229,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2255,7 +2253,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2275,7 +2273,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2296,7 +2294,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/comments' );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertSame( 201, $response->get_status() );
@@ -2319,7 +2317,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2340,7 +2338,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 	}
 
 	/**
-	 * @dataProvider comment_dates_provider
+	 * @dataProvider data_comment_dates
 	 */
 	public function test_update_comment_date( $params, $results ) {
 		wp_set_current_user( self::$editor_id );
@@ -2424,7 +2422,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', $comment_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2452,7 +2450,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', $comment_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2474,7 +2472,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2498,7 +2496,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2518,7 +2516,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2537,7 +2535,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2557,7 +2555,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2575,7 +2573,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2592,7 +2590,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2609,7 +2607,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2630,7 +2628,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2646,7 +2644,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2661,7 +2659,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', '/wp/v2/comments/' . REST_TESTS_IMPOSSIBLY_HIGH_NUMBER );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2686,7 +2684,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$hold_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2705,7 +2703,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2735,7 +2733,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', $private_comment_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2794,7 +2792,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2814,7 +2812,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2834,7 +2832,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2853,7 +2851,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2874,7 +2872,7 @@ class WP_Test_REST_Comments_Controller extends WP_Test_REST_Controller_Testcase
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/comments/%d', self::$approved_id ) );
 
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
diff --git a/tests/rest-api/rest-controller.php b/tests/rest-api/rest-controller.php
index 77b1596d3d..f7da75327a 100644
--- a/tests/rest-api/rest-controller.php
+++ b/tests/rest-api/rest-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Controller extends WP_Test_REST_TestCase {
diff --git a/tests/rest-api/rest-global-styles-controller.php b/tests/rest-api/rest-global-styles-controller.php
index b7a5617a11..07050a0515 100644
--- a/tests/rest-api/rest-global-styles-controller.php
+++ b/tests/rest-api/rest-global-styles-controller.php
@@ -4,10 +4,9 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @covers WP_REST_Global_Styles_Controller
+ *
  * @group restapi-global-styles
  * @group restapi
  */
@@ -484,6 +483,27 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
 		$expected = array(
+			array(
+				'version'  => 2,
+				'title'    => 'variation-b',
+				'settings' => array(
+					'blocks' => array(
+						'core/post-title' => array(
+							'color' => array(
+								'palette' => array(
+									'theme' => array(
+										array(
+											'slug'  => 'light',
+											'name'  => 'Light',
+											'color' => '#f1f1f1',
+										),
+									),
+								),
+							),
+						),
+					),
+				),
+			),
 			array(
 				'version'  => 2,
 				'title'    => 'Block theme variation',
@@ -511,6 +531,68 @@ class WP_REST_Global_Styles_Controller_Test extends WP_Test_REST_Controller_Test
 				),
 			),
 		);
-		$this->assertSameSetsWithIndex( $data, $expected );
+
+		wp_recursive_ksort( $data );
+		wp_recursive_ksort( $expected );
+
+		$this->assertSameSets( $data, $expected );
+	}
+
+	/**
+	 * @covers WP_REST_Global_Styles_Controller::get_available_actions
+	 */
+	public function test_assign_edit_css_action_admin() {
+		wp_set_current_user( self::$admin_id );
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/global-styles/' . self::$global_styles_id );
+		$request->set_param( 'context', 'edit' );
+		$response = rest_do_request( $request );
+		$links    = $response->get_links();
+
+		// Admins can only edit css on single site.
+		if ( is_multisite() ) {
+			$this->assertArrayNotHasKey( 'https://api.w.org/action-edit-css', $links );
+		} else {
+			$this->assertArrayHasKey( 'https://api.w.org/action-edit-css', $links );
+		}
+	}
+
+	/**
+	 * @covers WP_REST_Global_Styles_Controller::update_item
+	 * @ticket 57536
+	 */
+	public function test_update_item_valid_styles_css() {
+		wp_set_current_user( self::$admin_id );
+		if ( is_multisite() ) {
+			grant_super_admin( self::$admin_id );
+		}
+		$request = new WP_REST_Request( 'PUT', '/wp/v2/global-styles/' . self::$global_styles_id );
+		$request->set_body_params(
+			array(
+				'styles' => array( 'css' => 'body { color: red; }' ),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+		$this->assertSame( 'body { color: red; }', $data['styles']['css'] );
+	}
+
+	/**
+	 * @covers WP_REST_Global_Styles_Controller::update_item
+	 * @ticket 57536
+	 */
+	public function test_update_item_invalid_styles_css() {
+		wp_set_current_user( self::$admin_id );
+		if ( is_multisite() ) {
+			grant_super_admin( self::$admin_id );
+		}
+		$request = new WP_REST_Request( 'PUT', '/wp/v2/global-styles/' . self::$global_styles_id );
+		$request->set_body_params(
+			array(
+				'styles' => array( 'css' => '<p>test</p> body { color: red; }' ),
+			)
+		);
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertErrorResponse( 'rest_custom_css_illegal_markup', $response, 400 );
 	}
 }
diff --git a/tests/rest-api/rest-pages-controller.php b/tests/rest-api/rest-pages-controller.php
index a6a9cfa3f4..9900c5a003 100644
--- a/tests/rest-api/rest-pages-controller.php
+++ b/tests/rest-api/rest-pages-controller.php
@@ -5,9 +5,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Testcase {
@@ -86,6 +84,7 @@ class WP_Test_REST_Pages_Controller extends WP_Test_REST_Post_Type_Controller_Te
 				'parent_exclude',
 				'per_page',
 				'search',
+				'search_columns',
 				'slug',
 				'status',
 			),
diff --git a/tests/rest-api/rest-pattern-directory-controller.php b/tests/rest-api/rest-pattern-directory-controller.php
index a59c8fd5e0..77b99af76b 100644
--- a/tests/rest-api/rest-pattern-directory-controller.php
+++ b/tests/rest-api/rest-pattern-directory-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  * @group pattern-directory
  */
@@ -30,6 +28,15 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 	 */
 	private static $controller;
 
+	/**
+	 * List of URLs captured.
+	 *
+	 * @since 6.2.0
+	 *
+	 * @var string[]
+	 */
+	protected static $http_request_urls;
+
 	/**
 	 * Set up class test fixtures.
 	 *
@@ -44,9 +51,30 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 			)
 		);
 
+		self::$http_request_urls = array();
+
 		static::$controller = new WP_REST_Pattern_Directory_Controller();
 	}
 
+	/**
+	 * Tear down after class.
+	 *
+	 * @since 6.2.0
+	 */
+	public static function wpTearDownAfterClass() {
+		self::delete_user( self::$contributor_id );
+	}
+
+	/**
+	 * Clear the captured request URLs after each test.
+	 *
+	 * @since 6.2.0
+	 */
+	public function tear_down() {
+		self::$http_request_urls = array();
+		parent::tear_down();
+	}
+
 	/**
 	 * Asserts that the pattern matches the expected response schema.
 	 *
@@ -310,6 +338,176 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 		$this->assertSame( 'modified the cache', $patterns[0] );
 	}
 
+	/**
+	 * Tests if the provided query args are passed through to the wp.org API.
+	 *
+	 * @since 6.2.0
+	 *
+	 * @ticket 57501
+	 *
+	 * @covers WP_REST_Pattern_Directory_Controller::get_items
+	 *
+	 * @dataProvider data_get_items_query_args
+	 *
+	 * @param string $param    Query parameter name (ex, page).
+	 * @param mixed  $value    Query value to test.
+	 * @param bool   $is_error Whether this value should error or not.
+	 * @param mixed  $expected Expected value (or expected error code).
+	 */
+	public function test_get_items_query_args( $param, $value, $is_error, $expected ) {
+		wp_set_current_user( self::$contributor_id );
+		add_filter( 'pre_http_request', array( $this, 'mock_request_to_apiwporg_url' ), 10, 3 );
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/pattern-directory/patterns' );
+		if ( $value ) {
+			$request->set_query_params( array( $param => $value ) );
+		}
+
+		$response = rest_do_request( $request );
+		$data     = $response->get_data();
+		if ( $is_error ) {
+			$this->assertSame( $expected, $data['code'], 'Response error code does not match' );
+			$this->assertStringContainsString( $param, $data['message'], 'Response error message does not match' );
+		} else {
+			$this->assertCount( 1, self::$http_request_urls, 'The number of HTTP Request URLs is not 1' );
+			$this->assertStringContainsString( $param . '=' . $expected, self::$http_request_urls[0], 'The param and/or value do not match' );
+		}
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * return array[]
+	 */
+	public function data_get_items_query_args() {
+		return array(
+			'per_page default'   => array(
+				'param'    => 'per_page',
+				'value'    => false,
+				'is_error' => false,
+				'expected' => 100,
+			),
+			'per_page custom-1'  => array(
+				'param'    => 'per_page',
+				'value'    => 5,
+				'is_error' => false,
+				'expected' => 5,
+			),
+			'per_page custom-2'  => array(
+				'param'    => 'per_page',
+				'value'    => 50,
+				'is_error' => false,
+				'expected' => 50,
+			),
+			'per_page invalid-1' => array(
+				'param'    => 'per_page',
+				'value'    => 200,
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+			'per_page invalid-2' => array(
+				'param'    => 'per_page',
+				'value'    => 'abc',
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+
+			'page default'       => array(
+				'param'    => 'page',
+				'value'    => false,
+				'is_error' => false,
+				'expected' => 1,
+			),
+			'page custom'        => array(
+				'param'    => 'page',
+				'value'    => 5,
+				'is_error' => false,
+				'expected' => 5,
+			),
+			'page invalid'       => array(
+				'param'    => 'page',
+				'value'    => 'abc',
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+
+			'offset custom'      => array(
+				'param'    => 'offset',
+				'value'    => 5,
+				'is_error' => false,
+				'expected' => 5,
+			),
+			'offset invalid-1'   => array(
+				'param'    => 'offset',
+				'value'    => 'abc',
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+
+			'order default'      => array(
+				'param'    => 'order',
+				'value'    => false,
+				'is_error' => false,
+				'expected' => 'desc',
+			),
+			'order custom'       => array(
+				'param'    => 'order',
+				'value'    => 'asc',
+				'is_error' => false,
+				'expected' => 'asc',
+			),
+			'order invalid-1'    => array(
+				'param'    => 'order',
+				'value'    => 10,
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+			'order invalid-2'    => array(
+				'param'    => 'order',
+				'value'    => 'fake',
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+
+			'orderby default'    => array(
+				'param'    => 'orderby',
+				'value'    => false,
+				'is_error' => false,
+				'expected' => 'date',
+			),
+			'orderby custom-1'   => array(
+				'param'    => 'orderby',
+				'value'    => 'title',
+				'is_error' => false,
+				'expected' => 'title',
+			),
+			'orderby custom-2'   => array(
+				'param'    => 'orderby',
+				'value'    => 'date',
+				'is_error' => false,
+				'expected' => 'date',
+			),
+			'orderby custom-3'   => array(
+				'param'    => 'orderby',
+				'value'    => 'favorite_count',
+				'is_error' => false,
+				'expected' => 'favorite_count',
+			),
+			'orderby invalid-1'  => array(
+				'param'    => 'orderby',
+				'value'    => 10,
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+			'orderby invalid-2'  => array(
+				'param'    => 'orderby',
+				'value'    => 'fake',
+				'is_error' => true,
+				'expected' => 'rest_invalid_param',
+			),
+		);
+	}
+
 	/**
 	 * @doesNotPerformAssertions
 	 */
@@ -573,4 +771,33 @@ class WP_REST_Pattern_Directory_Controller_Test extends WP_Test_REST_Controller_
 			3
 		);
 	}
+
+	/**
+	 * Mock the request to wp.org URL to capture the URLs.
+	 *
+	 * @since 6.2.0
+	 *
+	 * @return array faux/mocked response.
+	 */
+	public function mock_request_to_apiwporg_url( $response, $args, $url ) {
+		if ( 'api.wordpress.org' !== wp_parse_url( $url, PHP_URL_HOST ) ) {
+			return $response;
+		}
+
+		self::$http_request_urls[] = $url;
+
+		// Return a response to prevent external API request.
+		$response = array(
+			'headers'  => array(),
+			'response' => array(
+				'code'    => 200,
+				'message' => 'OK',
+			),
+			'body'     => '[]',
+			'cookies'  => array(),
+			'filename' => null,
+		);
+
+		return $response;
+	}
 }
diff --git a/tests/rest-api/rest-plugins-controller.php b/tests/rest-api/rest-plugins-controller.php
index d9fcdd2609..1375c81061 100644
--- a/tests/rest-api/rest-plugins-controller.php
+++ b/tests/rest-api/rest-plugins-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_REST_Plugins_Controller_Test extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-post-meta-fields.php b/tests/rest-api/rest-post-meta-fields.php
index 7101a38c7c..3c627dfd59 100644
--- a/tests/rest-api/rest-post-meta-fields.php
+++ b/tests/rest-api/rest-post-meta-fields.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
@@ -2055,7 +2053,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 	/**
 	 * @ticket 43392
 	 * @ticket 48363
-	 * @dataProvider _dp_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable
+	 * @dataProvider data_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable
 	 */
 	public function test_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable( $type, $stored, $expected ) {
 		register_post_meta(
@@ -2076,7 +2074,7 @@ class WP_Test_REST_Post_Meta_Fields extends WP_Test_REST_TestCase {
 		$this->assertSame( $expected, $response->get_data()['meta']['safe'] );
 	}
 
-	public function _dp_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable() {
+	public function data_meta_values_are_not_set_to_null_in_response_if_type_safely_serializable() {
 		return array(
 			array( 'boolean', 'true', true ),
 			array( 'boolean', 'false', false ),
diff --git a/tests/rest-api/rest-post-statuses-controller.php b/tests/rest-api/rest-post-statuses-controller.php
index 303a94bb6e..366e596459 100644
--- a/tests/rest-api/rest-post-statuses-controller.php
+++ b/tests/rest-api/rest-post-statuses-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Post_Statuses_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-post-types-controller.php b/tests/rest-api/rest-post-types-controller.php
index 18ee7224c1..1c2a0b53b4 100644
--- a/tests/rest-api/rest-post-types-controller.php
+++ b/tests/rest-api/rest-post-types-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Post_Types_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-posts-controller.php b/tests/rest-api/rest-posts-controller.php
index 2a378c84c0..353325fc81 100644
--- a/tests/rest-api/rest-posts-controller.php
+++ b/tests/rest-api/rest-posts-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Testcase {
@@ -204,6 +202,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 				'page',
 				'per_page',
 				'search',
+				'search_columns',
 				'slug',
 				'status',
 				'sticky',
@@ -1527,6 +1526,38 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertPostsWhere( " AND {posts}.ID NOT IN ($id3) AND {posts}.post_type = 'post' AND (({posts}.post_status = 'publish'))" );
 	}
 
+	/**
+	 * Tests that Rest Post controller supports search columns.
+	 *
+	 * @ticket 43867
+	 * @covers WP_REST_Posts_Controller::get_items
+	 */
+	public function test_get_items_with_custom_search_columns() {
+		$id1 = self::factory()->post->create(
+			array(
+				'post_title'   => 'Title contain foo and bar',
+				'post_content' => 'Content contain bar',
+				'post_excerpt' => 'Excerpt contain baz',
+			)
+		);
+		$id2 = self::factory()->post->create(
+			array(
+				'post_title'   => 'Title contain baz',
+				'post_content' => 'Content contain foo and bar',
+				'post_excerpt' => 'Excerpt contain foo, bar and baz',
+			)
+		);
+
+		$request = new WP_REST_Request( 'GET', '/wp/v2/posts' );
+		$request->set_param( 'search', 'foo bar' );
+		$request->set_param( 'search_columns', array( 'post_title' ) );
+		$response = rest_get_server()->dispatch( $request );
+		$this->assertSame( 200, $response->get_status(), 'Response should have a status code 200.' );
+		$data = $response->get_data();
+		$this->assertCount( 1, $data, 'Response should contain one result.' );
+		$this->assertSame( $id1, $data[0]['id'], 'Result should match expected value.' );
+	}
+
 	/**
 	 * @ticket 55592
 	 *
@@ -2326,7 +2357,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->check_create_post_response( $response );
 	}
 
-	public function post_dates_provider() {
+	public function data_post_dates() {
 		$all_statuses = array(
 			'draft',
 			'publish',
@@ -2397,7 +2428,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	/**
-	 * @dataProvider post_dates_provider
+	 * @dataProvider data_post_dates
 	 */
 	public function test_create_post_date( $status, $params, $results ) {
 		wp_set_current_user( self::$editor_id );
@@ -3446,7 +3477,7 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 	}
 
 	/**
-	 * @dataProvider post_dates_provider
+	 * @dataProvider data_post_dates
 	 */
 	public function test_update_post_date( $status, $params, $results ) {
 		wp_set_current_user( self::$editor_id );
@@ -4001,7 +4032,17 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		$this->assertSame( $expected_output['excerpt']['raw'], $post->post_excerpt );
 	}
 
-	public static function post_roundtrip_provider() {
+	/**
+	 * @dataProvider data_post_roundtrip_as_author
+	 */
+	public function test_post_roundtrip_as_author( $raw, $expected ) {
+		wp_set_current_user( self::$author_id );
+
+		$this->assertFalse( current_user_can( 'unfiltered_html' ) );
+		$this->verify_post_roundtrip( $raw, $expected );
+	}
+
+	public static function data_post_roundtrip_as_author() {
 		return array(
 			array(
 				// Raw values.
@@ -4098,16 +4139,6 @@ class WP_Test_REST_Posts_Controller extends WP_Test_REST_Post_Type_Controller_Te
 		);
 	}
 
-	/**
-	 * @dataProvider post_roundtrip_provider
-	 */
-	public function test_post_roundtrip_as_author( $raw, $expected ) {
-		wp_set_current_user( self::$author_id );
-
-		$this->assertFalse( current_user_can( 'unfiltered_html' ) );
-		$this->verify_post_roundtrip( $raw, $expected );
-	}
-
 	public function test_post_roundtrip_as_editor_unfiltered_html() {
 		wp_set_current_user( self::$editor_id );
 
diff --git a/tests/rest-api/rest-request-validation.php b/tests/rest-api/rest-request-validation.php
index aab01f2902..4444fb6065 100644
--- a/tests/rest-api/rest-request-validation.php
+++ b/tests/rest-api/rest-request-validation.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Request_Validation extends WP_Test_REST_TestCase {
diff --git a/tests/rest-api/rest-request.php b/tests/rest-api/rest-request.php
index 509c754f65..aac7145287 100644
--- a/tests/rest-api/rest-request.php
+++ b/tests/rest-api/rest-request.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class Tests_REST_Request extends WP_UnitTestCase {
@@ -59,19 +57,8 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		$this->assertSame( array( $value1, $value2 ), $this->request->get_header_as_array( 'Accept' ) );
 	}
 
-	public static function header_provider() {
-		return array(
-			array( 'Test', 'test' ),
-			array( 'TEST', 'test' ),
-			array( 'Test-Header', 'test_header' ),
-			array( 'test-header', 'test_header' ),
-			array( 'Test_Header', 'test_header' ),
-			array( 'test_header', 'test_header' ),
-		);
-	}
-
 	/**
-	 * @dataProvider header_provider
+	 * @dataProvider data_header_canonicalization
 	 * @param string $original Original header key.
 	 * @param string $expected Expected canonicalized version.
 	 */
@@ -79,19 +66,19 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		$this->assertSame( $expected, $this->request->canonicalize_header_name( $original ) );
 	}
 
-	public static function content_type_provider() {
+	public static function data_header_canonicalization() {
 		return array(
-			// Check basic parsing.
-			array( 'application/x-wp-example', 'application/x-wp-example', 'application', 'x-wp-example', '' ),
-			array( 'application/x-wp-example; charset=utf-8', 'application/x-wp-example', 'application', 'x-wp-example', 'charset=utf-8' ),
-
-			// Check case insensitivity.
-			array( 'APPLICATION/x-WP-Example', 'application/x-wp-example', 'application', 'x-wp-example', '' ),
+			array( 'Test', 'test' ),
+			array( 'TEST', 'test' ),
+			array( 'Test-Header', 'test_header' ),
+			array( 'test-header', 'test_header' ),
+			array( 'Test_Header', 'test_header' ),
+			array( 'test_header', 'test_header' ),
 		);
 	}
 
 	/**
-	 * @dataProvider content_type_provider
+	 * @dataProvider data_content_type_parsing
 	 *
 	 * @param string $header     Header value.
 	 * @param string $value      Full type value.
@@ -112,6 +99,17 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		$this->assertSame( $parameters, $parsed['parameters'] );
 	}
 
+	public static function data_content_type_parsing() {
+		return array(
+			// Check basic parsing.
+			array( 'application/x-wp-example', 'application/x-wp-example', 'application', 'x-wp-example', '' ),
+			array( 'application/x-wp-example; charset=utf-8', 'application/x-wp-example', 'application', 'x-wp-example', 'charset=utf-8' ),
+
+			// Check case insensitivity.
+			array( 'APPLICATION/x-WP-Example', 'application/x-wp-example', 'application', 'x-wp-example', '' ),
+		);
+	}
+
 	protected function request_with_parameters() {
 		$this->request->set_url_params(
 			array(
@@ -188,22 +186,11 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		$this->assertEmpty( $this->request->get_param( 'has_json_params' ) );
 	}
 
-	public static function alternate_json_content_type_provider() {
-		return array(
-			array( 'application/ld+json', 'json', true ),
-			array( 'application/ld+json; profile="https://www.w3.org/ns/activitystreams"', 'json', true ),
-			array( 'application/activity+json', 'json', true ),
-			array( 'application/json+oembed', 'json', true ),
-			array( 'application/nojson', 'body', false ),
-			array( 'application/no.json', 'body', false ),
-		);
-	}
-
 	/**
 	 * @ticket 49404
-	 * @dataProvider alternate_json_content_type_provider
+	 * @dataProvider data_alternate_json_content_type
 	 *
-	 * @param string $content_type The content-type header.
+	 * @param string $content_type The Content-Type header.
 	 * @param string $source       The source value.
 	 * @param bool   $accept_json  The accept_json value.
 	 */
@@ -219,22 +206,22 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		$this->assertEquals( $accept_json, $this->request->get_param( 'has_json_params' ) );
 	}
 
-	public static function is_json_content_type_provider() {
+	public static function data_alternate_json_content_type() {
 		return array(
-			array( 'application/ld+json', true ),
-			array( 'application/ld+json; profile="https://www.w3.org/ns/activitystreams"', true ),
-			array( 'application/activity+json', true ),
-			array( 'application/json+oembed', true ),
-			array( 'application/nojson', false ),
-			array( 'application/no.json', false ),
+			array( 'application/ld+json', 'json', true ),
+			array( 'application/ld+json; profile="https://www.w3.org/ns/activitystreams"', 'json', true ),
+			array( 'application/activity+json', 'json', true ),
+			array( 'application/json+oembed', 'json', true ),
+			array( 'application/nojson', 'body', false ),
+			array( 'application/no.json', 'body', false ),
 		);
 	}
 
 	/**
 	 * @ticket 49404
-	 * @dataProvider is_json_content_type_provider
+	 * @dataProvider data_is_json_content_type
 	 *
-	 * @param string $content_type The content-type header.
+	 * @param string $content_type The Content-Type header.
 	 * @param bool   $is_json      The is_json value.
 	 */
 	public function test_is_json_content_type( $content_type, $is_json ) {
@@ -242,10 +229,21 @@ class Tests_REST_Request extends WP_UnitTestCase {
 
 		$this->request->set_header( 'Content-Type', $content_type );
 
-		// Check for JSON content-type.
+		// Check for JSON Content-Type.
 		$this->assertSame( $is_json, $this->request->is_json_content_type() );
 	}
 
+	public static function data_is_json_content_type() {
+		return array(
+			array( 'application/ld+json', true ),
+			array( 'application/ld+json; profile="https://www.w3.org/ns/activitystreams"', true ),
+			array( 'application/activity+json', true ),
+			array( 'application/json+oembed', true ),
+			array( 'application/nojson', false ),
+			array( 'application/no.json', false ),
+		);
+	}
+
 	/**
 	 * @ticket 49404
 	 */
@@ -312,20 +310,12 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		$this->assertEmpty( $this->request->get_param( 'has_json_params' ) );
 	}
 
-	public function non_post_http_methods_with_request_body_provider() {
-		return array(
-			array( 'PUT' ),
-			array( 'PATCH' ),
-			array( 'DELETE' ),
-		);
-	}
-
 	/**
 	 * Tests that methods supporting request bodies have access to the
 	 * request's body.  For POST this is straightforward via `$_POST`; for
 	 * other methods `WP_REST_Request` needs to parse the body for us.
 	 *
-	 * @dataProvider non_post_http_methods_with_request_body_provider
+	 * @dataProvider data_non_post_body_parameters
 	 */
 	public function test_non_post_body_parameters( $request_method ) {
 		$data = array(
@@ -347,6 +337,14 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		}
 	}
 
+	public function data_non_post_body_parameters() {
+		return array(
+			array( 'PUT' ),
+			array( 'PATCH' ),
+			array( 'DELETE' ),
+		);
+	}
+
 	public function test_parameters_for_json_put() {
 		$data = array(
 			'foo'  => 'bar',
@@ -361,7 +359,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		);
 
 		$this->request->set_method( 'PUT' );
-		$this->request->add_header( 'content-type', 'application/json' );
+		$this->request->add_header( 'Content-Type', 'application/json' );
 		$this->request->set_body( wp_json_encode( $data ) );
 
 		foreach ( $data as $key => $expected_value ) {
@@ -383,7 +381,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 		);
 
 		$this->request->set_method( 'POST' );
-		$this->request->add_header( 'content-type', 'application/json' );
+		$this->request->add_header( 'Content-Type', 'application/json' );
 		$this->request->set_body( wp_json_encode( $data ) );
 
 		foreach ( $data as $key => $expected_value ) {
@@ -864,7 +862,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 
 	public function test_set_param_follows_parameter_order() {
 		$request = new WP_REST_Request();
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_method( 'POST' );
 		$request->set_body(
 			wp_json_encode(
@@ -892,7 +890,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 	 */
 	public function test_set_param_updates_param_in_json_and_query() {
 		$request = new WP_REST_Request();
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_method( 'POST' );
 		$request->set_body(
 			wp_json_encode(
@@ -919,7 +917,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 	 */
 	public function test_set_param_updates_param_if_already_exists_in_query() {
 		$request = new WP_REST_Request();
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_method( 'POST' );
 		$request->set_body(
 			wp_json_encode(
@@ -953,7 +951,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 	 */
 	public function test_set_param_to_null_updates_param_in_json_and_query() {
 		$request = new WP_REST_Request();
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_method( 'POST' );
 		$request->set_body(
 			wp_json_encode(
@@ -980,7 +978,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 	 */
 	public function test_set_param_from_null_updates_param_in_json_and_query_with_null() {
 		$request = new WP_REST_Request();
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_method( 'POST' );
 		$request->set_body(
 			wp_json_encode(
@@ -1007,7 +1005,7 @@ class Tests_REST_Request extends WP_UnitTestCase {
 	 */
 	public function test_set_param_with_invalid_json() {
 		$request = new WP_REST_Request();
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_method( 'POST' );
 		$request->set_body( '' );
 		$request->set_param( 'param', 'value' );
diff --git a/tests/rest-api/rest-revisions-controller.php b/tests/rest-api/rest-revisions-controller.php
index 4af746fe65..e0b713c882 100644
--- a/tests/rest-api/rest-revisions-controller.php
+++ b/tests/rest-api/rest-revisions-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Revisions_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-schema-sanitization.php b/tests/rest-api/rest-schema-sanitization.php
index 7b3c076c6e..7cf88f243c 100644
--- a/tests/rest-api/rest-schema-sanitization.php
+++ b/tests/rest-api/rest-schema-sanitization.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Schema_Sanitization extends WP_UnitTestCase {
diff --git a/tests/rest-api/rest-schema-setup.php b/tests/rest-api/rest-schema-setup.php
index 9347f33256..f3efbb5305 100644
--- a/tests/rest-api/rest-schema-setup.php
+++ b/tests/rest-api/rest-schema-setup.php
@@ -6,9 +6,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  * @group restapi-jsclient
  */
@@ -146,14 +144,14 @@ class WP_Test_REST_Schema_Initialization extends WP_Test_REST_TestCase {
 			'/wp/v2/settings',
 			'/wp/v2/template-parts',
 			'/wp/v2/template-parts/(?P<id>[\d]+)/autosaves',
-			'/wp/v2/template-parts/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w-]+)',
+			'/wp/v2/template-parts/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w%-]+)',
 			'/wp/v2/template-parts/(?P<parent>[\d]+)/autosaves/(?P<id>[\d]+)',
 			'/wp/v2/template-parts/(?P<parent>[\d]+)/revisions',
 			'/wp/v2/template-parts/(?P<parent>[\d]+)/revisions/(?P<id>[\d]+)',
 			'/wp/v2/template-parts/lookup',
 			'/wp/v2/templates',
 			'/wp/v2/templates/(?P<id>[\d]+)/autosaves',
-			'/wp/v2/templates/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w-]+)',
+			'/wp/v2/templates/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w%-]+)',
 			'/wp/v2/templates/(?P<parent>[\d]+)/autosaves/(?P<id>[\d]+)',
 			'/wp/v2/templates/(?P<parent>[\d]+)/revisions',
 			'/wp/v2/templates/(?P<parent>[\d]+)/revisions/(?P<id>[\d]+)',
diff --git a/tests/rest-api/rest-schema-validation.php b/tests/rest-api/rest-schema-validation.php
index 58c5452de9..67f01356d9 100644
--- a/tests/rest-api/rest-schema-validation.php
+++ b/tests/rest-api/rest-schema-validation.php
@@ -4,9 +4,7 @@
  *
  * @package    WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Schema_Validation extends WP_UnitTestCase {
diff --git a/tests/rest-api/rest-search-controller.php b/tests/rest-api/rest-search-controller.php
index 2b2e87adeb..2e39d385d9 100644
--- a/tests/rest-api/rest-search-controller.php
+++ b/tests/rest-api/rest-search-controller.php
@@ -1,13 +1,9 @@
 <?php
 /**
- * WP_REST_Search_Controller tests
+ * Unit tests covering WP_REST_Search_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
- */
-
-/**
- * Tests for WP_REST_Search_Controller.
  *
  * @group restapi
  */
diff --git a/tests/rest-api/rest-server.php b/tests/rest-api/rest-server.php
index 8788a72445..3a7bf78353 100644
--- a/tests/rest-api/rest-server.php
+++ b/tests/rest-api/rest-server.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class Tests_REST_Server extends WP_Test_REST_TestCase {
@@ -51,6 +49,10 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		parent::tear_down();
 	}
 
+	public function filter_wp_rest_server_class() {
+		return 'Spy_REST_Server';
+	}
+
 	public function test_envelope() {
 		$data    = array(
 			'amount of arbitrary data' => 'alot',
@@ -922,11 +924,35 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$data   = array(
 			'untouched' => 'data',
 		);
-		$result = rest_get_server()->embed_links( $data );
+		$result = rest_get_server()->embed_links( $data, true );
 
-		$this->assertArrayNotHasKey( '_links', $data );
-		$this->assertArrayNotHasKey( '_embedded', $data );
-		$this->assertSame( 'data', $data['untouched'] );
+		$this->assertArrayNotHasKey( '_links', $result );
+		$this->assertArrayNotHasKey( '_embedded', $result );
+		$this->assertSame( 'data', $result['untouched'] );
+	}
+
+	/**
+	 * Ensure embed_links handles WP_Error objects returned by dispatch
+	 *
+	 * @ticket 56566
+	 */
+	public function test_link_embedding_returning_wp_error() {
+		$return_wp_error = function() {
+			return new WP_Error( 'some-error', 'This is not valid!' );
+		};
+		add_filter( 'rest_pre_dispatch', $return_wp_error );
+
+		$mock = new MockAction();
+		add_filter( 'rest_post_dispatch', array( $mock, 'filter' ) );
+
+		$response = new WP_REST_Response();
+		$response->add_link( 'author', rest_url( 'test' ), array( 'embeddable' => true ) );
+
+		$data = rest_get_server()->response_to_data( $response, true );
+
+		$this->assertArrayHasKey( '_links', $data );
+		$this->assertCount( 1, $mock->get_events() );
+		$this->assertSame( 'some-error', $data['_embedded']['author'][0]['code'] );
 	}
 
 	public function embedded_response_callback( $request ) {
@@ -982,7 +1008,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 	}
 
 	/**
-	 * @dataProvider _dp_response_to_data_embedding
+	 * @dataProvider data_response_to_data_embedding
 	 */
 	public function test_response_to_data_embedding( $expected, $embed ) {
 		$response = new WP_REST_Response();
@@ -1000,7 +1026,7 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		}
 	}
 
-	public function _dp_response_to_data_embedding() {
+	public function data_response_to_data_embedding() {
 		return array(
 			array(
 				array( 'author', 'wp:term', 'https://wordpress.org' ),
@@ -1439,10 +1465,6 @@ class Tests_REST_Server extends WP_Test_REST_TestCase {
 		$this->assertSame( 'data\\with\\slashes', rest_get_server()->last_request->get_header( 'x_my_header' ) );
 	}
 
-	public function filter_wp_rest_server_class() {
-		return 'Spy_REST_Server';
-	}
-
 	/**
 	 * Refreshed nonce should not be present in header when an invalid nonce is passed for logged in user.
 	 *
diff --git a/tests/rest-api/rest-settings-controller.php b/tests/rest-api/rest-settings-controller.php
index 60a5f28c8d..d9181e1af8 100644
--- a/tests/rest-api/rest-settings-controller.php
+++ b/tests/rest-api/rest-settings-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase {
@@ -773,7 +771,7 @@ class WP_Test_REST_Settings_Controller extends WP_Test_REST_Controller_Testcase
 			),
 		);
 		$request = new WP_REST_Request( 'PUT', '/wp/v2/settings' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $data ) );
 
 		$response = rest_do_request( $request );
diff --git a/tests/rest-api/rest-sidebars-controller.php b/tests/rest-api/rest-sidebars-controller.php
index e2745f519f..8210d916f3 100644
--- a/tests/rest-api/rest-sidebars-controller.php
+++ b/tests/rest-api/rest-sidebars-controller.php
@@ -5,15 +5,12 @@
  * @package WordPress
  * @subpackage REST_API
  * @since 5.8.0
- */
-
-/**
- * Tests for REST API for Widgets.
+ *
+ * @covers WP_REST_Sidebars_Controller
  *
  * @see WP_Test_REST_Controller_Testcase
  * @group restapi
  * @group widgets
- * @covers WP_REST_Sidebars_Controller
  */
 class WP_Test_REST_Sidebars_Controller extends WP_Test_REST_Controller_Testcase {
 
@@ -860,6 +857,73 @@ class WP_Test_REST_Sidebars_Controller extends WP_Test_REST_Controller_Testcase
 		);
 	}
 
+	/**
+	 * @ticket 57531
+	 * @covers WP_Test_REST_Sidebars_Controller::prepare_item_for_response
+	 */
+	public function test_prepare_item_for_response_to_set_inactive_on_theme_switch() {
+		$request = new WP_REST_Request( 'GET', '/wp/v2/sidebars/sidebar-1' );
+
+		// Set up the test.
+		wp_widgets_init();
+		$this->setup_widget(
+			'widget_rss',
+			1,
+			array(
+				'title' => 'RSS test',
+			)
+		);
+		$this->setup_widget(
+			'widget_text',
+			1,
+			array(
+				'text' => 'Custom text test',
+			)
+		);
+		$this->setup_sidebar(
+			'sidebar-1',
+			array(
+				'name' => 'Sidebar 1',
+			),
+			array( 'text-1', 'rss-1' )
+		);
+
+		// Validate the state before a theme switch.
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+		$data     = $this->remove_links( $data );
+
+		$this->assertSame( 'active', $data['status'] );
+		$this->assertFalse(
+			get_theme_mod( 'wp_classic_sidebars' ),
+			'wp_classic_sidebars theme mod should not exist before switching to block theme'
+		);
+
+		switch_theme( 'block-theme' );
+		wp_widgets_init();
+
+		// Validate the state after a theme switch.
+		$response = rest_get_server()->dispatch( $request );
+		$data     = $response->get_data();
+		$data     = $this->remove_links( $data );
+
+		$this->assertSame(
+			'inactive',
+			$data['status'],
+			'Sidebar status should have changed to inactive'
+		);
+		$this->assertSame(
+			array( 'text-1', 'rss-1' ),
+			$data['widgets'],
+			'The text and rss widgets should still in sidebar-1'
+		);
+		$this->assertArrayHasKey(
+			'sidebar-1',
+			get_theme_mod( 'wp_classic_sidebars' ),
+			'sidebar-1 should be in "wp_classic_sidebars" theme mod'
+		);
+	}
+
 	/**
 	 * @ticket 41683
 	 */
diff --git a/tests/rest-api/rest-site-health-controller.php b/tests/rest-api/rest-site-health-controller.php
index 899308d745..b4929914a6 100644
--- a/tests/rest-api/rest-site-health-controller.php
+++ b/tests/rest-api/rest-site-health-controller.php
@@ -4,12 +4,10 @@
  *
  * Also generates the fixture data used by the wp-api.js QUnit tests.
  *
- * @package    WordPress
+ * @package WordPress
  * @subpackage REST API
- * @since      5.6.0
- */
-
-/**
+ * @since 5.6.0
+ *
  * @group restapi
  */
 class WP_Test_REST_Site_Health_Controller extends WP_Test_REST_TestCase {
diff --git a/tests/rest-api/rest-tags-controller.php b/tests/rest-api/rest-tags-controller.php
index da8f6c5878..6c96987627 100644
--- a/tests/rest-api/rest-tags-controller.php
+++ b/tests/rest-api/rest-tags-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Tags_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-taxonomies-controller.php b/tests/rest-api/rest-taxonomies-controller.php
index e2901c6307..6da465be25 100644
--- a/tests/rest-api/rest-taxonomies-controller.php
+++ b/tests/rest-api/rest-taxonomies-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Taxonomies_Controller extends WP_Test_REST_Controller_Testcase {
diff --git a/tests/rest-api/rest-term-meta-fields.php b/tests/rest-api/rest-term-meta-fields.php
index 21d4ca86cd..8d4ba295f8 100644
--- a/tests/rest-api/rest-term-meta-fields.php
+++ b/tests/rest-api/rest-term-meta-fields.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Term_Meta_Fields extends WP_Test_REST_TestCase {
diff --git a/tests/rest-api/rest-test-controller.php b/tests/rest-api/rest-test-controller.php
index f75de9e458..042f37cf8b 100644
--- a/tests/rest-api/rest-test-controller.php
+++ b/tests/rest-api/rest-test-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_REST_Test_Controller extends WP_REST_Controller {
diff --git a/tests/rest-api/rest-themes-controller.php b/tests/rest-api/rest-themes-controller.php
index eb2b379c66..995b11f51d 100644
--- a/tests/rest-api/rest-themes-controller.php
+++ b/tests/rest-api/rest-themes-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi-themes
  * @group restapi
  */
diff --git a/tests/rest-api/rest-users-controller.php b/tests/rest-api/rest-users-controller.php
index 1187120343..8373f8d200 100644
--- a/tests/rest-api/rest-users-controller.php
+++ b/tests/rest-api/rest-users-controller.php
@@ -4,9 +4,7 @@
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
+ *
  * @group restapi
  */
 class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
@@ -1230,7 +1228,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1263,7 +1261,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		}
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
@@ -1308,7 +1306,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1338,7 +1336,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
@@ -1369,7 +1367,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		add_filter( 'can_add_user_to_blog', '__return_false' );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'user_cannot_be_added', $response );
@@ -1392,7 +1390,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		switch_to_blog( self::$site );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
@@ -1422,7 +1420,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 		$data     = $response->get_data();
@@ -1431,7 +1429,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		switch_to_blog( self::$site );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$switched_response = rest_get_server()->dispatch( $request );
 
@@ -1470,7 +1468,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1487,7 +1485,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1507,7 +1505,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1526,7 +1524,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1546,7 +1544,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/users' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1579,7 +1577,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$_POST['locale']     = 'de_DE';
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/users/%d', $user_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $_POST );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -1826,7 +1824,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		$pw_before = $userdata->user_pass;
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/users/%d', $user_id ) );
-		$request->add_header( 'content-type', 'application/json' );
+		$request->add_header( 'Content-Type', 'application/json' );
 		$request->set_body( wp_json_encode( $params ) );
 
 		$response = rest_get_server()->dispatch( $request );
@@ -2008,14 +2006,14 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/users/%d', self::$user ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
 		$this->assertErrorResponse( 'rest_cannot_edit', $response, 403 );
 
 		$request = new WP_REST_Request( 'PUT', '/wp/v2/users/me' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2035,7 +2033,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		);
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/users/%d', self::$editor ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
 
@@ -2892,7 +2890,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		wp_set_current_user( self::$user );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/users/%d', $user_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( array( 'first_name' => 'New Name' ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_user_invalid_id', $response, 404 );
@@ -2914,7 +2912,7 @@ class WP_Test_REST_Users_Controller extends WP_Test_REST_Controller_Testcase {
 		wp_set_current_user( self::$superadmin );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/users/%d', $user_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$request->set_body_params( array( 'first_name' => 'New Name' ) );
 		$response = rest_get_server()->dispatch( $request );
 		$this->assertErrorResponse( 'rest_user_invalid_id', $response, 404 );
diff --git a/tests/rest-api/rest-widget-types-controller.php b/tests/rest-api/rest-widget-types-controller.php
index 5074205fb7..e9b46d444f 100644
--- a/tests/rest-api/rest-widget-types-controller.php
+++ b/tests/rest-api/rest-widget-types-controller.php
@@ -5,16 +5,12 @@
  * @package WordPress
  * @subpackage REST_API
  * @since 5.8.0
- */
-
-/**
- * Tests for WP_REST_Widget_Types_Controller.
  *
- * @since 5.8.0
+ * @covers WP_REST_Widget_Types_Controller
  *
  * @see WP_TEST_REST_Controller_Testcase
  * @group restapi
- * @covers WP_REST_Widget_Types_Controller
+ * @group widgets
  */
 class WP_Test_REST_Widget_Types_Controller extends WP_Test_REST_Controller_Testcase {
 
diff --git a/tests/rest-api/rest-widgets-controller.php b/tests/rest-api/rest-widgets-controller.php
index be9fdbdcf5..22516737c3 100644
--- a/tests/rest-api/rest-widgets-controller.php
+++ b/tests/rest-api/rest-widgets-controller.php
@@ -1,20 +1,16 @@
 <?php
 /**
- * Unit tests covering WP_REST_Widgets_Controller_Test functionality.
+ * Unit tests covering WP_REST_Widgets_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.8.0
- */
-
-/**
- * Tests for REST API for Widgets.
  *
- * @since 5.8.0
+ * @covers WP_REST_Widgets_Controller
  *
  * @see WP_Test_REST_Controller_Testcase
  * @group restapi
- * @covers WP_REST_Widgets_Controller
+ * @group widgets
  */
 class WP_Test_REST_Widgets_Controller extends WP_Test_REST_Controller_Testcase {
 	/**
@@ -412,7 +408,7 @@ class WP_Test_REST_Widgets_Controller extends WP_Test_REST_Controller_Testcase {
 
 	public function mocked_rss_response() {
 		$single_value_headers = array(
-			'content-type' => 'application/rss+xml; charset=UTF-8',
+			'Content-Type' => 'application/rss+xml; charset=UTF-8',
 			'link'         => '<https://wordpress.org/news/wp-json/>; rel="https://api.w.org/"',
 		);
 
diff --git a/tests/rest-api/wpRestBlockPatternCategoriesController.php b/tests/rest-api/wpRestBlockPatternCategoriesController.php
index 256eabdb82..77481112a0 100644
--- a/tests/rest-api/wpRestBlockPatternCategoriesController.php
+++ b/tests/rest-api/wpRestBlockPatternCategoriesController.php
@@ -2,14 +2,8 @@
 /**
  * Unit tests covering WP_Block_Pattern_Categories_Registry functionality.
  *
- * @package    WordPress
+ * @package WordPress
  * @subpackage REST_API
- * @since      6.0.0
- */
-
-/**
- * Tests for REST API for Block Pattern Categories Registry.
- *
  * @since 6.0.0
  *
  * @ticket 55505
diff --git a/tests/rest-api/wpRestBlockPatternsController.php b/tests/rest-api/wpRestBlockPatternsController.php
index f49c658ae5..319eb20bab 100644
--- a/tests/rest-api/wpRestBlockPatternsController.php
+++ b/tests/rest-api/wpRestBlockPatternsController.php
@@ -2,14 +2,8 @@
 /**
  * Unit tests covering WP_REST_Block_Patterns_Controller functionality.
  *
- * @package    WordPress
+ * @package WordPress
  * @subpackage REST_API
- * @since      6.0.0
- */
-
-/**
- * Tests for REST API for Block Patterns.
- *
  * @since 6.0.0
  *
  * @ticket 55505
@@ -78,18 +72,29 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 			'test/one',
 			array(
 				'title'         => 'Pattern One',
-				'categories'    => array( 'test' ),
-				'viewportWidth' => 1440,
 				'content'       => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+				'viewportWidth' => 1440,
+				'categories'    => array( 'test' ),
+				'templateTypes' => array( 'page' ),
 			)
 		);
 
 		$test_registry->register(
 			'test/two',
 			array(
-				'title'      => 'Pattern Two',
-				'categories' => array( 'test' ),
-				'content'    => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+				'title'         => 'Pattern Two',
+				'content'       => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+				'categories'    => array( 'test' ),
+				'templateTypes' => array( 'single' ),
+			)
+		);
+
+		$test_registry->register(
+			'test/three',
+			array(
+				'title'      => 'Pattern Three',
+				'content'    => '<!-- wp:paragraph --><p>Three</p><!-- /wp:paragraph -->',
+				'categories' => array( 'test', 'buttons', 'query' ),
 			)
 		);
 	}
@@ -119,7 +124,7 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 		wp_set_current_user( self::$admin_id );
 
 		$request            = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
-		$request['_fields'] = 'name,content';
+		$request['_fields'] = 'name,content,template_types';
 		$response           = rest_get_server()->dispatch( $request );
 		$data               = $response->get_data();
 
@@ -127,16 +132,18 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 		$this->assertGreaterThanOrEqual( 2, count( $data ), 'WP_REST_Block_Patterns_Controller::get_items() should return at least 2 items' );
 		$this->assertSame(
 			array(
-				'name'    => 'test/one',
-				'content' => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+				'name'           => 'test/one',
+				'content'        => '<!-- wp:heading {"level":1} --><h1>One</h1><!-- /wp:heading -->',
+				'template_types' => array( 'page' ),
 			),
 			$data[0],
 			'WP_REST_Block_Patterns_Controller::get_items() should return test/one'
 		);
 		$this->assertSame(
 			array(
-				'name'    => 'test/two',
-				'content' => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+				'name'           => 'test/two',
+				'content'        => '<!-- wp:paragraph --><p>Two</p><!-- /wp:paragraph -->',
+				'template_types' => array( 'single' ),
 			),
 			$data[1],
 			'WP_REST_Block_Patterns_Controller::get_items() should return test/two'
@@ -171,6 +178,51 @@ class Tests_REST_WpRestBlockPatternsController extends WP_Test_REST_Controller_T
 		$this->assertSame( 403, $response->get_status() );
 	}
 
+	/**
+	 * Tests the proper migration of old core pattern categories to new ones.
+	 *
+	 * @since 6.2.0
+	 *
+	 * @ticket 57532
+	 *
+	 * @covers WP_REST_Block_Patterns_Controller::get_items
+	 */
+	public function test_get_items_migrate_pattern_categories() {
+		wp_set_current_user( self::$admin_id );
+
+		$request            = new WP_REST_Request( 'GET', static::REQUEST_ROUTE );
+		$request['_fields'] = 'name,categories';
+		$response           = rest_get_server()->dispatch( $request );
+		$data               = $response->get_data();
+
+		$this->assertIsArray( $data, 'WP_REST_Block_Patterns_Controller::get_items() should return an array' );
+		$this->assertGreaterThanOrEqual( 3, count( $data ), 'WP_REST_Block_Patterns_Controller::get_items() should return at least 3 items' );
+		$this->assertSame(
+			array(
+				'name'       => 'test/one',
+				'categories' => array( 'test' ),
+			),
+			$data[0],
+			'WP_REST_Block_Patterns_Controller::get_items() should return test/one'
+		);
+		$this->assertSame(
+			array(
+				'name'       => 'test/two',
+				'categories' => array( 'test' ),
+			),
+			$data[1],
+			'WP_REST_Block_Patterns_Controller::get_items() should return test/two'
+		);
+		$this->assertSame(
+			array(
+				'name'       => 'test/three',
+				'categories' => array( 'test', 'call-to-action', 'posts' ),
+			),
+			$data[2],
+			'WP_REST_Block_Patterns_Controller::get_items() should return test/three'
+		);
+	}
+
 	/**
 	 * @doesNotPerformAssertions
 	 */
diff --git a/tests/rest-api/wpRestEditSiteExportController.php b/tests/rest-api/wpRestEditSiteExportController.php
index c32ea170b8..5ed45fe2ca 100644
--- a/tests/rest-api/wpRestEditSiteExportController.php
+++ b/tests/rest-api/wpRestEditSiteExportController.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_REST_Edit_Site_Export_Controller tests.
+ * Unit tests covering WP_REST_Edit_Site_Export_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.9.0
- */
-
-/**
- * Tests for WP_REST_Edit_Site_Export_Controller.
- *
- * @since 5.9.0
  *
  * @covers WP_REST_Edit_Site_Export_Controller
  *
diff --git a/tests/rest-api/wpRestMenuItemsController.php b/tests/rest-api/wpRestMenuItemsController.php
index 5eecd99d43..4687700cc7 100644
--- a/tests/rest-api/wpRestMenuItemsController.php
+++ b/tests/rest-api/wpRestMenuItemsController.php
@@ -1,14 +1,10 @@
 <?php
 /**
- * WP_REST_Menu_Items_Controller tests
+ * Unit tests covering WP_REST_Menu_Items_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.9.0
- */
-
-/**
- * Tests for REST API for Menu items.
  *
  * @group restapi
  *
@@ -147,6 +143,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$this->assertArrayHasKey( 'page', $properties );
 		$this->assertArrayHasKey( 'per_page', $properties );
 		$this->assertArrayHasKey( 'search', $properties );
+		$this->assertArrayHasKey( 'search_columns', $properties );
 		$this->assertArrayHasKey( 'slug', $properties );
 		$this->assertArrayHasKey( 'status', $properties );
 	}
@@ -318,7 +315,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data();
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
@@ -334,7 +331,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'menus' => array( 123, 456 ),
@@ -354,7 +351,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'type'  => 'taxonomy',
@@ -377,7 +374,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$actual      = array();
 		for ( $i = 1; $i < 5; $i++ ) {
 			$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-			$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+			$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 			$params = $this->set_menu_item_data(
 				array(
 					'menu_order' => $i,
@@ -404,7 +401,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$new_menu_id = wp_create_nav_menu( rand_str() );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'menu_order' => 0,
@@ -416,7 +413,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$this->assertErrorResponse( 'rest_invalid_param', $response, 400 );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'menu_order' => 1,
@@ -436,7 +433,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 		$new_menu_id = wp_create_nav_menu( rand_str() );
 		$request     = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'menu_order' => 'ddddd',
@@ -456,7 +453,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 		$new_menu_id = wp_create_nav_menu( rand_str() );
 		$request     = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'menu_order' => -9,
@@ -476,7 +473,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 		wp_create_nav_menu( rand_str() );
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'parent' => -9,
@@ -494,7 +491,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 	public function test_create_item_invalid_menu() {
 		wp_set_current_user( self::$admin_id );
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'menus' => -9,
@@ -513,7 +510,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'type'  => 'post_type',
@@ -533,7 +530,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'type'             => 'post_type_archive',
@@ -553,7 +550,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'type'  => 'custom',
@@ -573,7 +570,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'type' => 'custom',
@@ -593,7 +590,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'type' => 'custom',
@@ -615,7 +612,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/menu-items/%d', $this->menu_item_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'xfn' => array( 'test1', 'test2', 'test3' ),
@@ -648,7 +645,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$good_data = array( 'test1', 'test2', 'test3', 'test4' );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/menu-items/%d', $this->menu_item_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data(
 			array(
 				'xfn' => $bad_data,
@@ -680,7 +677,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		$post_id = self::factory()->post->create();
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/menu-items/%d', $post_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$params = $this->set_menu_item_data();
 		$request->set_body_params( $params );
 		$response = rest_get_server()->dispatch( $request );
@@ -1021,7 +1018,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'POST', '/wp/v2/menu-items' );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$parameters = $this->set_menu_item_data(
 			array(
 				'title' => 'Some \\\'title',
@@ -1043,7 +1040,7 @@ class Tests_REST_WpRestMenuItemsController extends WP_Test_REST_Post_Type_Contro
 		wp_set_current_user( self::$admin_id );
 
 		$request = new WP_REST_Request( 'PUT', sprintf( '/wp/v2/menu-items/%d', $this->menu_item_id ) );
-		$request->add_header( 'content-type', 'application/x-www-form-urlencoded' );
+		$request->add_header( 'Content-Type', 'application/x-www-form-urlencoded' );
 		$title  = 'Some \\\'title';
 		$params = $this->set_menu_item_data(
 			array(
diff --git a/tests/rest-api/wpRestMenuLocationsController.php b/tests/rest-api/wpRestMenuLocationsController.php
index c24714ea93..a2f7df075d 100644
--- a/tests/rest-api/wpRestMenuLocationsController.php
+++ b/tests/rest-api/wpRestMenuLocationsController.php
@@ -1,14 +1,10 @@
 <?php
 /**
- * WP_REST_Menu_Locations_Controller tests.
+ * Unit tests covering WP_REST_Menu_Locations_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.9.0
- */
-
-/**
- * Tests for REST API for Menu locations.
  *
  * @group restapi
  *
diff --git a/tests/rest-api/wpRestMenusController.php b/tests/rest-api/wpRestMenusController.php
index 3db23f2d45..09de72bb87 100644
--- a/tests/rest-api/wpRestMenusController.php
+++ b/tests/rest-api/wpRestMenusController.php
@@ -1,14 +1,10 @@
 <?php
 /**
- * WP_REST_Menus_Controller tests
+ * Unit tests covering WP_REST_Menus_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.9.0
- */
-
-/**
- * Tests for REST API for Menus.
  *
  * @group restapi
  *
diff --git a/tests/rest-api/wpRestTemplatesController.php b/tests/rest-api/wpRestTemplatesController.php
index fa790b66d1..811767444d 100644
--- a/tests/rest-api/wpRestTemplatesController.php
+++ b/tests/rest-api/wpRestTemplatesController.php
@@ -1,13 +1,9 @@
 <?php
 /**
- * Unit tests covering the templates endpoint..
+ * Unit tests covering WP_REST_Templates_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST API
- */
-
-/**
- * Tests for REST API for templates.
  *
  * @covers WP_REST_Templates_Controller
  *
@@ -66,7 +62,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 			'Templates route does not exist'
 		);
 		$this->assertArrayHasKey(
-			'/wp/v2/templates/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w-]+)',
+			'/wp/v2/templates/(?P<id>([^\/:<>\*\?"\|]+(?:\/[^\/:<>\*\?"\|]+)?)[\/\w%-]+)',
 			$routes,
 			'Single template based on the given ID route does not exist'
 		);
@@ -173,7 +169,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 
 	/**
 	 * @ticket 54507
-	 * @dataProvider get_template_endpoint_urls
+	 * @dataProvider data_get_item_works_with_a_single_slash
 	 */
 	public function test_get_item_works_with_a_single_slash( $endpoint_url ) {
 		wp_set_current_user( self::$admin_id );
@@ -207,7 +203,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 	}
 
-	public function get_template_endpoint_urls() {
+	public function data_get_item_works_with_a_single_slash() {
 		return array(
 			array( '/wp/v2/templates/default/my_template' ),
 			array( '/wp/v2/templates/default//my_template' ),
@@ -294,6 +290,46 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 					'post_excerpt' => 'Description of page home template.',
 				),
 			),
+			'template parts: parent theme with non latin characters' => array(
+				'theme_dir' => 'themedir1/block-theme-non-latin',
+				'template'  => 'small-header-%cf%84%ce%b5%cf%83%cf%84',
+				'args'      => array(
+					'post_name'    => 'small-header-τεστ',
+					'post_title'   => 'Small Header τεστ Template',
+					'post_content' => file_get_contents( $theme_root_dir . '/block-theme-non-latin/parts/small-header-test.html' ),
+					'post_excerpt' => 'Description of small header τεστ template.',
+				),
+			),
+			'template: parent theme with non latin name'  => array(
+				'theme_dir' => 'themedir1/block-theme-non-latin',
+				'template'  => 'page-%cf%84%ce%b5%cf%83%cf%84',
+				'args'      => array(
+					'post_name'    => 'page-τεστ',
+					'post_title'   => 'τεστ Page Template',
+					'post_content' => file_get_contents( $theme_root_dir . 'block-theme-non-latin/templates/page-test.html' ),
+					'post_excerpt' => 'Description of page τεστ template.',
+				),
+			),
+			'template parts: parent theme with chinese characters' => array(
+				'theme_dir' => 'themedir1/block-theme-non-latin',
+				'template'  => 'small-header-%e6%b5%8b%e8%af%95',
+				'args'      => array(
+					'post_name'    => 'small-header-测试',
+					'post_title'   => 'Small Header 测试 Template',
+					'post_content' => file_get_contents( $theme_root_dir . '/block-theme-non-latin/parts/small-header-test.html' ),
+					'post_excerpt' => 'Description of small header 测试 template.',
+				),
+			),
+			'template: parent theme with non latin name using chinese characters' => array(
+				'theme_dir' => 'themedir1/block-theme-non-latin',
+				'template'  => 'page-%e6%b5%8b%e8%af%95',
+				'args'      => array(
+					'post_name'    => 'page-测试',
+					'post_title'   => '测试 Page Template',
+					'post_content' => file_get_contents( $theme_root_dir . 'block-theme-non-latin/templates/page-test.html' ),
+					'post_excerpt' => 'Description of page 测试 template.',
+				),
+			),
 			'template: parent theme deprecated path'      => array(
 				'theme_dir' => 'themedir1/block-theme-deprecated-path',
 				'template'  => 'page-home',
@@ -339,7 +375,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 
 	/**
 	 * @ticket 54507
-	 * @dataProvider get_template_ids_to_sanitize
+	 * @dataProvider data_sanitize_template_id
 	 */
 	public function test_sanitize_template_id( $input_id, $sanitized_id ) {
 		$endpoint = new WP_REST_Templates_Controller( 'wp_template' );
@@ -349,7 +385,7 @@ class Tests_REST_WpRestTemplatesController extends WP_Test_REST_Controller_Testc
 		);
 	}
 
-	public function get_template_ids_to_sanitize() {
+	public function data_sanitize_template_id() {
 		return array(
 			array( 'tt1-blocks/index', 'tt1-blocks//index' ),
 			array( 'tt1-blocks//index', 'tt1-blocks//index' ),
diff --git a/tests/rest-api/wpRestUrlDetailsController.php b/tests/rest-api/wpRestUrlDetailsController.php
index 41d0438a57..24cc517365 100644
--- a/tests/rest-api/wpRestUrlDetailsController.php
+++ b/tests/rest-api/wpRestUrlDetailsController.php
@@ -1,16 +1,10 @@
 <?php
 /**
- * WP_REST_URL_Details_Controller tests.
+ * Unit tests covering WP_REST_URL_Details_Controller functionality.
  *
  * @package WordPress
  * @subpackage REST_API
  * @since 5.9.0
- */
-
-/**
- * Tests for WP_REST_URL_Details_Controller.
- *
- * @since 5.9.0
  *
  * @covers WP_REST_URL_Details_Controller
  *
diff --git a/tests/rewrite/rewriteTags.php b/tests/rewrite/rewriteTags.php
index 8eeef7f7d9..31c28df15e 100644
--- a/tests/rewrite/rewriteTags.php
+++ b/tests/rewrite/rewriteTags.php
@@ -20,19 +20,8 @@ class Tests_Rewrite_Tags extends WP_UnitTestCase {
 		$this->queryreplace   = $wp_rewrite->queryreplace;
 	}
 
-	public function _invalid_rewrite_tags() {
-		return array(
-			array( 'foo', 'bar' ),
-			array( '%', 'bar' ),
-			array( '%a', 'bar' ),
-			array( 'a%', 'bar' ),
-			array( '%%', 'bar' ),
-			array( '', 'bar' ),
-		);
-	}
-
 	/**
-	 * @dataProvider _invalid_rewrite_tags
+	 * @dataProvider data_add_rewrite_tag_invalid
 	 *
 	 * @param string $tag   Rewrite tag.
 	 * @param string $regex Regex.
@@ -46,6 +35,17 @@ class Tests_Rewrite_Tags extends WP_UnitTestCase {
 		$this->assertSameSets( $this->queryreplace, $wp_rewrite->queryreplace );
 	}
 
+	public function data_add_rewrite_tag_invalid() {
+		return array(
+			array( 'foo', 'bar' ),
+			array( '%', 'bar' ),
+			array( '%a', 'bar' ),
+			array( 'a%', 'bar' ),
+			array( '%%', 'bar' ),
+			array( '', 'bar' ),
+		);
+	}
+
 	public function test_add_rewrite_tag_empty_query() {
 		global $wp_rewrite;
 
diff --git a/tests/robots.php b/tests/robots.php
index 60da725e75..87b0e6fb90 100644
--- a/tests/robots.php
+++ b/tests/robots.php
@@ -1,12 +1,8 @@
 <?php
 /**
- * Robots functions tests.
+ * Tests for robots template functions and filters.
  *
  * @package WordPress
- */
-
-/**
- * Tests for robots template functions and filters.
  *
  * @group robots
  */
diff --git a/tests/shortcode.php b/tests/shortcode.php
index 7ee36d7cbc..1c19cfb42d 100644
--- a/tests/shortcode.php
+++ b/tests/shortcode.php
@@ -404,7 +404,19 @@ EOF;
 		$this->assertSame( $test_string, shortcode_unautop( wpautop( $test_string ) ) );
 	}
 
-	public function data_test_strip_shortcodes() {
+	/**
+	 * @ticket 10326
+	 *
+	 * @dataProvider data_strip_shortcodes
+	 *
+	 * @param string $expected  Expected output.
+	 * @param string $content   Content to run strip_shortcodes() on.
+	 */
+	public function test_strip_shortcodes( $expected, $content ) {
+		$this->assertSame( $expected, strip_shortcodes( $content ) );
+	}
+
+	public function data_strip_shortcodes() {
 		return array(
 			array( 'before', 'before[gallery]' ),
 			array( 'after', '[gallery]after' ),
@@ -419,18 +431,6 @@ EOF;
 		);
 	}
 
-	/**
-	 * @ticket 10326
-	 *
-	 * @dataProvider data_test_strip_shortcodes
-	 *
-	 * @param string $expected  Expected output.
-	 * @param string $content   Content to run strip_shortcodes() on.
-	 */
-	public function test_strip_shortcodes( $expected, $content ) {
-		$this->assertSame( $expected, strip_shortcodes( $content ) );
-	}
-
 	/**
 	 * @ticket 37767
 	 */
@@ -826,7 +826,7 @@ EOF;
 
 		// Pass arguments.
 		$arr = array(
-			'return' => 'p11',
+			'output' => 'p11',
 			'key'    => $str,
 			'atts'   => array(
 				'a' => 'b',
@@ -864,9 +864,9 @@ EOF;
 		return 'p11';
 	}
 
-	public function filter_pre_do_shortcode_tag_attr( $return, $key, $atts, $m ) {
+	public function filter_pre_do_shortcode_tag_attr( $output, $key, $atts, $m ) {
 		$arr = array(
-			'return' => $return,
+			'output' => $output,
 			'key'    => $key,
 			'atts'   => $atts,
 			'm'      => $m,
@@ -896,7 +896,7 @@ EOF;
 
 		// Pass arguments.
 		$arr = array(
-			'return' => 'foobar',
+			'output' => 'foobar',
 			'key'    => $str,
 			'atts'   => array(
 				'a' => 'b',
@@ -926,17 +926,17 @@ EOF;
 		return 'foo';
 	}
 
-	public function filter_do_shortcode_tag_replace( $return ) {
-		return str_replace( 'oo', 'ee', $return );
+	public function filter_do_shortcode_tag_replace( $output ) {
+		return str_replace( 'oo', 'ee', $output );
 	}
 
-	public function filter_do_shortcode_tag_generate( $return ) {
+	public function filter_do_shortcode_tag_generate( $output ) {
 		return 'foobar';
 	}
 
-	public function filter_do_shortcode_tag_attr( $return, $key, $atts, $m ) {
+	public function filter_do_shortcode_tag_attr( $output, $key, $atts, $m ) {
 		$arr = array(
-			'return' => $return,
+			'output' => $output,
 			'key'    => $key,
 			'atts'   => $atts,
 			'm'      => $m,
diff --git a/tests/sitemaps/functions.php b/tests/sitemaps/functions.php
index f67335733b..0620d465d4 100644
--- a/tests/sitemaps/functions.php
+++ b/tests/sitemaps/functions.php
@@ -63,7 +63,7 @@ class Tests_Sitemaps_Functions extends WP_UnitTestCase {
 	/**
 	 * Test get_sitemap_url() with plain permalinks.
 	 *
-	 * @dataProvider plain_permalinks_provider
+	 * @dataProvider data_get_sitemap_url_plain_permalinks
 	 */
 	public function test_get_sitemap_url_plain_permalinks( $name, $subtype_name, $page, $expected ) {
 		$actual = get_sitemap_url( $name, $subtype_name, $page );
@@ -74,7 +74,7 @@ class Tests_Sitemaps_Functions extends WP_UnitTestCase {
 	/**
 	 * Test get_sitemap_url() with pretty permalinks.
 	 *
-	 * @dataProvider pretty_permalinks_provider
+	 * @dataProvider data_get_sitemap_url_pretty_permalinks
 	 */
 	public function test_get_sitemap_url_pretty_permalinks( $name, $subtype_name, $page, $expected ) {
 		$this->set_permalink_structure( '/%postname%/' );
@@ -96,7 +96,7 @@ class Tests_Sitemaps_Functions extends WP_UnitTestCase {
 	 *     @type string|false $4 Sitemap URL.
 	 * }
 	 */
-	public function plain_permalinks_provider() {
+	public function data_get_sitemap_url_plain_permalinks() {
 		return array(
 			array( 'posts', 'post', 1, home_url( '/?sitemap=posts&sitemap-subtype=post&paged=1' ) ),
 			array( 'posts', 'post', 0, home_url( '/?sitemap=posts&sitemap-subtype=post&paged=1' ) ),
@@ -128,7 +128,7 @@ class Tests_Sitemaps_Functions extends WP_UnitTestCase {
 	 *     @type string|false $4 Sitemap URL.
 	 * }
 	 */
-	public function pretty_permalinks_provider() {
+	public function data_get_sitemap_url_pretty_permalinks() {
 		return array(
 			array( 'posts', 'post', 1, home_url( '/wp-sitemap-posts-post-1.xml' ) ),
 			array( 'posts', 'post', 0, home_url( '/wp-sitemap-posts-post-1.xml' ) ),
diff --git a/tests/style-engine/styleEngine.php b/tests/style-engine/styleEngine.php
index 7095140a43..616c332095 100644
--- a/tests/style-engine/styleEngine.php
+++ b/tests/style-engine/styleEngine.php
@@ -166,6 +166,21 @@ class Tests_wpStyleEngine extends WP_UnitTestCase {
 				),
 			),
 
+			'inline_valid_dimensions_style'                => array(
+				'block_styles'    => array(
+					'dimensions' => array(
+						'minHeight' => '50vh',
+					),
+				),
+				'options'         => null,
+				'expected_output' => array(
+					'css'          => 'min-height:50vh;',
+					'declarations' => array(
+						'min-height' => '50vh',
+					),
+				),
+			),
+
 			'inline_valid_typography_style'                => array(
 				'block_styles'    => array(
 					'typography' => array(
diff --git a/tests/term/isObjectInTerm.php b/tests/term/isObjectInTerm.php
index 457b0e528c..f0984ef49b 100644
--- a/tests/term/isObjectInTerm.php
+++ b/tests/term/isObjectInTerm.php
@@ -119,16 +119,16 @@ class Tests_IsObjectInTerm extends WP_UnitTestCase {
 		register_taxonomy( 'wptests_tax', 'post' );
 		$t = self::factory()->term->create( array( 'taxonomy' => 'wptests_tax' ) );
 
-		$post_ID = self::factory()->post->create();
-		wp_set_object_terms( $post_ID, $t, 'wptests_tax' );
+		$post_id = self::factory()->post->create();
+		wp_set_object_terms( $post_id, $t, 'wptests_tax' );
 
 		$int_tax_name = $t . '_term_name';
 
-		$this->assertFalse( is_object_in_term( $post_ID, 'wptests_tax', $int_tax_name ) );
+		$this->assertFalse( is_object_in_term( $post_id, 'wptests_tax', $int_tax_name ) );
 
 		// Verify it works properly when the post is actually in the term.
-		wp_set_object_terms( $post_ID, array( $int_tax_name ), 'wptests_tax' );
-		$this->assertTrue( is_object_in_term( $post_ID, 'wptests_tax', $int_tax_name ) );
+		wp_set_object_terms( $post_id, array( $int_tax_name ), 'wptests_tax' );
+		$this->assertTrue( is_object_in_term( $post_id, 'wptests_tax', $int_tax_name ) );
 	}
 
 	/**
diff --git a/tests/term/wpGenerateTagCloud.php b/tests/term/wpGenerateTagCloud.php
index d1b02bb04d..62de4a0c26 100644
--- a/tests/term/wpGenerateTagCloud.php
+++ b/tests/term/wpGenerateTagCloud.php
@@ -8,7 +8,7 @@ class Tests_WP_Generate_Tag_Cloud extends WP_UnitTestCase {
 	/**
 	 * Testing when passed $tags array is empty
 	 *
-	 * @dataProvider empty_tags_data_provider
+	 * @dataProvider data_empty_tags
 	 *
 	 * @param $expected Expected output from `wp_generate_tag_cloud()`.
 	 * @param $args     Options for `wp_generate_tag_cloud()`.
@@ -21,7 +21,7 @@ class Tests_WP_Generate_Tag_Cloud extends WP_UnitTestCase {
 	/**
 	 * Testing when no tags are found
 	 *
-	 * @dataProvider empty_tags_data_provider
+	 * @dataProvider data_empty_tags
 	 *
 	 * @param $expected Expected output from `wp_generate_tag_cloud()`.
 	 * @param $args     Options for `wp_generate_tag_cloud()`.
@@ -41,7 +41,7 @@ class Tests_WP_Generate_Tag_Cloud extends WP_UnitTestCase {
 	 *
 	 * @return array
 	 */
-	public function empty_tags_data_provider() {
+	public function data_empty_tags() {
 		return array(
 			// When 'format' => 'array', we should be getting an empty array back.
 			array(
diff --git a/tests/theme/themeDir.php b/tests/theme/themeDir.php
index 270895c442..ea721e5a44 100644
--- a/tests/theme/themeDir.php
+++ b/tests/theme/themeDir.php
@@ -180,6 +180,8 @@ class Tests_Theme_ThemeDir extends WP_UnitTestCase {
 			'Block Theme Child Theme',
 			'Block Theme Child with no theme.json',
 			'Block Theme Child Theme With Fluid Typography',
+			'Block Theme Child Theme With Fluid Typography Config',
+			'Block Theme Non Latin',
 			'Block Theme [0.4.0]',
 			'Block Theme [1.0.0] in subdirectory',
 			'Block Theme Deprecated Path',
diff --git a/tests/theme/wpEnqueueStoredStyles.php b/tests/theme/wpEnqueueStoredStyles.php
new file mode 100644
index 0000000000..37e1a920a7
--- /dev/null
+++ b/tests/theme/wpEnqueueStoredStyles.php
@@ -0,0 +1,72 @@
+<?php
+
+require_once __DIR__ . '/base.php';
+
+/**
+ * Tests wp_enqueue_stored_styles().
+ *
+ * @group themes
+ *
+ * @covers ::wp_enqueue_stored_styles
+ */
+class Tests_Themes_WpEnqueueStoredStyles extends WP_Theme_UnitTestCase {
+
+	/**
+	 * Tests that stored CSS is enqueued.
+	 *
+	 * @ticket 56467
+	 */
+	public function test_should_enqueue_stored_styles() {
+		$core_styles_to_enqueue = array(
+			array(
+				'selector'     => '.saruman',
+				'declarations' => array(
+					'color'        => 'white',
+					'height'       => '100px',
+					'border-style' => 'solid',
+				),
+			),
+		);
+
+		// Enqueues a block supports (core styles).
+		wp_style_engine_get_stylesheet_from_css_rules(
+			$core_styles_to_enqueue,
+			array(
+				'context' => 'block-supports',
+			)
+		);
+
+		$my_styles_to_enqueue = array(
+			array(
+				'selector'     => '.gandalf',
+				'declarations' => array(
+					'color'        => 'grey',
+					'height'       => '90px',
+					'border-style' => 'dotted',
+				),
+			),
+		);
+
+		// Enqueues some other styles.
+		wp_style_engine_get_stylesheet_from_css_rules(
+			$my_styles_to_enqueue,
+			array(
+				'context' => 'my-styles',
+			)
+		);
+
+		wp_enqueue_stored_styles( array( 'prettify' => false ) );
+
+		$this->assertSame(
+			array( '.saruman{color:white;height:100px;border-style:solid;}' ),
+			wp_styles()->registered['core-block-supports']->extra['after'],
+			'Registered styles with handle of "core-block-supports" do not match expected value from Style Engine store.'
+		);
+
+		$this->assertSame(
+			array( '.gandalf{color:grey;height:90px;border-style:dotted;}' ),
+			wp_styles()->registered['wp-style-engine-my-styles']->extra['after'],
+			'Registered styles with handle of "wp-style-engine-my-styles" do not match expected value from the Style Engine store.'
+		);
+	}
+}
diff --git a/tests/theme/wpGetGlobalStylesSvgFilters.php b/tests/theme/wpGetGlobalStylesSvgFilters.php
new file mode 100644
index 0000000000..b1d23efb4d
--- /dev/null
+++ b/tests/theme/wpGetGlobalStylesSvgFilters.php
@@ -0,0 +1,37 @@
+<?php
+/**
+ * Tests wp_get_global_styles_svg_filters().
+ *
+ * @group themes
+ */
+class Tests_Theme_wpGetGlobalStylesSvgFilters extends WP_UnitTestCase {
+	public function set_up() {
+		parent::set_up();
+		// Clear caches.
+		wp_clean_themes_cache();
+	}
+
+	public function tear_down() {
+		wp_clean_themes_cache();
+
+		parent::tear_down();
+	}
+
+	/**
+	 * Tests that switching themes recalculates the svgs.
+	 *
+	 * @covers ::wp_get_global_styles_svg_filters
+	 *
+	 * @ticket 57568
+	 */
+	public function test_switching_themes_should_recalculate_svg() {
+		$svg_for_default_theme = wp_get_global_styles_svg_filters();
+		switch_theme( 'block-theme' );
+		$svg_for_block_theme = wp_get_global_styles_svg_filters();
+		switch_theme( WP_DEFAULT_THEME );
+
+		$this->assertStringContainsString( '<svg', $svg_for_default_theme, 'Default theme should contain SVG' );
+		$this->assertStringContainsString( '<svg', $svg_for_default_theme, 'Block theme should contain SVG' );
+		$this->assertNotSame( $svg_for_default_theme, $svg_for_block_theme, 'Cache value should have changed' );
+	}
+}
diff --git a/tests/theme/wpGetGlobalStylesheet.php b/tests/theme/wpGetGlobalStylesheet.php
index 710f77d0ca..6213a383e3 100644
--- a/tests/theme/wpGetGlobalStylesheet.php
+++ b/tests/theme/wpGetGlobalStylesheet.php
@@ -1,273 +1,264 @@
 <?php
 
+require_once __DIR__ . '/base.php';
+
 /**
  * Tests wp_get_global_stylesheet().
  *
  * @group themes
+ *
+ * @covers ::wp_get_global_stylesheet
  */
-class Tests_Theme_wpGetGlobalStylesheet extends WP_UnitTestCase {
+class Tests_Theme_WpGetGlobalStylesheet extends WP_Theme_UnitTestCase {
 
 	/**
-	 * Theme root directory.
+	 * Flag to indicate whether to remove 'editor-font-sizes' theme support at tear_down().
 	 *
-	 * @var string
+	 * @var bool
 	 */
-	private $theme_root;
+	private $remove_theme_support_at_teardown = false;
 
 	/**
-	 * Original theme directory.
+	 * Flag to indicate whether to switch back to the default theme at tear down.
 	 *
-	 * @var string
+	 * @var bool
 	 */
-	private $orig_theme_dir;
-
-	public function set_up() {
-		parent::set_up();
-
-		$this->orig_theme_dir = $GLOBALS['wp_theme_directories'];
-		$this->theme_root     = realpath( DIR_TESTDATA . '/themedir1' );
-
-		// /themes is necessary as theme.php functions assume /themes is the root if there is only one root.
-		$GLOBALS['wp_theme_directories'] = array( WP_CONTENT_DIR . '/themes', $this->theme_root );
-
-		// Set up the new root.
-		add_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
-		add_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
-		add_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
-
-		// Clear caches.
-		wp_clean_themes_cache();
-		unset( $GLOBALS['wp_themes'] );
-	}
+	private $switch_to_default_theme_at_teardown = false;
 
 	public function tear_down() {
-		$GLOBALS['wp_theme_directories'] = $this->orig_theme_dir;
-
-		// Clear up the filters to modify the theme root.
-		remove_filter( 'theme_root', array( $this, 'filter_set_theme_root' ) );
-		remove_filter( 'stylesheet_root', array( $this, 'filter_set_theme_root' ) );
-		remove_filter( 'template_root', array( $this, 'filter_set_theme_root' ) );
+		// Reset the theme support.
+		if ( $this->remove_theme_support_at_teardown ) {
+			$this->remove_theme_support_at_teardown = false;
+			remove_theme_support( 'editor-font-sizes' );
+		}
 
-		wp_clean_themes_cache();
-		unset( $GLOBALS['wp_themes'] );
+		if ( $this->switch_to_default_theme_at_teardown ) {
+			$this->switch_to_default_theme_at_teardown = false;
+			switch_theme( WP_DEFAULT_THEME );
+		}
 
 		parent::tear_down();
 	}
 
 	/**
-	 * Cleans up global scope.
+	 * @ticket 54782
 	 *
-	 * @global WP_Styles $wp_styles
+	 * @dataProvider data_should_conditionally_include_font_sizes
+	 *
+	 * @param array  $expected            Expected CSS for each font size.
+	 * @param string $theme               The theme to switch to / use.
+	 * @param array  $types               Optional. Types of styles to load. Default empty array.
+	 * @param bool   $classic_has_presets Optional. Whether to apply presets for classic theme tests. Default false.
 	 */
-	public function clean_up_global_scope() {
-		global $wp_styles;
-		parent::clean_up_global_scope();
-		$wp_styles = null;
-	}
+	public function test_should_conditionally_include_font_sizes( array $expected, $theme, array $types = array(), $classic_has_presets = false ) {
+		$this->maybe_switch_theme( $theme );
+		$this->add_custom_font_sizes( $classic_has_presets );
 
-	public function filter_set_theme_root() {
-		return $this->theme_root;
-	}
-
-	public function test_block_theme_using_variables() {
-		switch_theme( 'block-theme' );
+		$styles = wp_get_global_stylesheet( $types );
 
-		$styles = wp_get_global_stylesheet( array( 'variables' ) );
-		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--custom: 100px;', $styles, 'custom font size is 100px' );
+		$this->assertStringContainsString( $expected['small'], $styles, 'The small font size should be included.' );
+		$this->assertStringContainsString( $expected['medium'], $styles, 'The medium font size should be included.' );
+		$this->assertStringContainsString( $expected['large'], $styles, 'The large font size should be included.' );
+		$this->assertStringContainsString( $expected['x-large'], $styles, 'The x-large font size should be included.' );
 
-		switch_theme( WP_DEFAULT_THEME );
+		if ( 'default' !== $theme ) {
+			$this->assertStringContainsString( $expected['custom'], $styles, 'The custom font size should be included.' );
+		}
 	}
 
-	public function test_block_theme_using_presets() {
-		switch_theme( 'block-theme' );
-
-		$styles = wp_get_global_stylesheet( array( 'presets' ) );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--custom: 100px;', $styles, 'custom font size is not present' );
-
-		switch_theme( WP_DEFAULT_THEME );
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_conditionally_include_font_sizes() {
+		return array(
+			'block theme using defaults'                   => array(
+				'expected' => array(
+					'small'   => '--wp--preset--font-size--small: 13px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 36px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+					'custom'  => '--wp--preset--font-size--custom: 100px;',
+				),
+				'theme'    => 'block-theme',
+			),
+			'block theme using variables'                  => array(
+				'expected' => array(
+					'small'   => '--wp--preset--font-size--small: 13px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 36px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+					'custom'  => '--wp--preset--font-size--custom: 100px;',
+				),
+				'theme'    => 'block-theme',
+				'types'    => array( 'variables' ),
+			),
+			'classic theme without presets using defaults' => array(
+				'expected' => array(
+					'small'   => '--wp--preset--font-size--small: 13px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 36px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+				),
+				'theme'    => 'default',
+			),
+			'classic theme without presets using variables' => array(
+				'expected' => array(
+					'small'   => '--wp--preset--font-size--small: 13px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 36px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+				),
+				'theme'    => 'default',
+				'types'    => array( 'variables' ),
+			),
+			'classic theme with presets using defaults'    => array(
+				'expected'            => array(
+					'small'   => '--wp--preset--font-size--small: 18px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 26.25px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+				),
+				'theme'               => 'default',
+				'types'               => array(),
+				'classic_has_presets' => true,
+			),
+			'classic theme with presets using variables'   => array(
+				'expected'            => array(
+					'small'   => '--wp--preset--font-size--small: 18px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 26.25px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+				),
+				'theme'               => 'default',
+				'types'               => array( 'variables' ),
+				'classic_has_presets' => true,
+			),
+		);
 	}
 
-	public function test_block_theme_using_defaults() {
-		switch_theme( 'block-theme' );
-
-		$styles = wp_get_global_stylesheet();
-		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--custom: 100px;', $styles, 'custom font size is 100px' );
-
-		switch_theme( WP_DEFAULT_THEME );
-	}
+	/**
+	 * @ticket 54782
+	 *
+	 * @dataProvider data_should_not_conditionally_include_font_sizes
+	 *
+	 * @param array  $expected            Expected CSS for each font size.
+	 * @param string $theme               The theme to switch to / use.
+	 * @param array  $types               Optional. Types of styles to load. Default empty array.
+	 * @param bool   $classic_has_presets Optional. Whether to apply presets for classic theme tests. Default false.
+	 */
+	public function test_should_not_conditionally_include_font_sizes( array $expected, $theme, array $types = array(), $classic_has_presets = false ) {
+		$this->maybe_switch_theme( $theme );
+		$this->add_custom_font_sizes( $classic_has_presets );
 
-	public function test_variables_in_classic_theme_with_no_presets_using_variables() {
-		$styles = wp_get_global_stylesheet( array( 'variables' ) );
-		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
-	}
+		$styles = wp_get_global_stylesheet( $types );
 
-	public function test_variables_in_classic_theme_with_no_presets_using_presets() {
-		$styles = wp_get_global_stylesheet( array( 'presets' ) );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is not present' );
-	}
+		$this->assertStringNotContainsString( $expected['small'], $styles, 'The small font size should not be included.' );
+		$this->assertStringNotContainsString( $expected['medium'], $styles, 'The medium font size should not be included.' );
+		$this->assertStringNotContainsString( $expected['large'], $styles, 'The large font size should not be included.' );
+		$this->assertStringNotContainsString( $expected['x-large'], $styles, 'The x-large font size should not be included.' );
 
-	public function test_variables_in_classic_theme_with_no_presets_using_defaults() {
-		$styles = wp_get_global_stylesheet();
-		$this->assertStringContainsString( '--wp--preset--font-size--small: 13px', $styles, 'small font size is 13px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--large: 36px', $styles, 'large font size is 36px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
+		if ( 'default' !== $theme ) {
+			$this->assertStringNotContainsString( $expected['custom'], $styles, 'The custom font size should not be included.' );
+		}
 	}
 
-	public function test_variables_in_classic_theme_with_presets_using_variables() {
-		add_theme_support(
-			'editor-font-sizes',
-			array(
-				array(
-					'name' => 'Small',
-					'size' => 18,
-					'slug' => 'small',
-				),
-				array(
-					'name' => 'Large',
-					'size' => 26.25,
-					'slug' => 'large',
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_should_not_conditionally_include_font_sizes() {
+		return array(
+			'block theme using presets'                   => array(
+				'expected' => array(
+					'small'   => '--wp--preset--font-size--small: 13px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 36px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
+					'custom'  => '--wp--preset--font-size--custom: 100px;',
 				),
-			)
-		);
-
-		$styles = wp_get_global_stylesheet( array( 'variables' ) );
-		$this->assertStringContainsString( '--wp--preset--font-size--small: 18px', $styles, 'small font size is 18px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--large: 26.25px', $styles, 'large font size is 26.25px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is 42px' );
-
-		remove_theme_support( 'editor-font-sizes' );
-	}
-
-	public function test_variables_in_classic_theme_with_presets_using_presets() {
-		add_theme_support(
-			'editor-font-sizes',
-			array(
-				array(
-					'name' => 'Small',
-					'size' => 18,
-					'slug' => 'small',
+				'theme'    => 'block-theme',
+				'types'    => array( 'presets' ),
+			),
+			'classic theme without presets using presets' => array(
+				'expected' => array(
+					'small'   => '--wp--preset--font-size--small: 13px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 36px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
 				),
-				array(
-					'name' => 'Large',
-					'size' => 26.25,
-					'slug' => 'large',
+				'theme'    => 'default',
+				'types'    => array( 'presets' ),
+			),
+			'classic theme with presets using presets'    => array(
+				'expected'            => array(
+					'small'   => '--wp--preset--font-size--small: 18px',
+					'medium'  => '--wp--preset--font-size--medium: 20px',
+					'large'   => '--wp--preset--font-size--large: 26.25px',
+					'x-large' => '--wp--preset--font-size--x-large: 42px',
 				),
-			)
+				'theme'               => 'default',
+				'types'               => array( 'presets' ),
+				'classic_has_presets' => true,
+			),
 		);
-
-		$styles = wp_get_global_stylesheet( array( 'presets' ) );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--small: 18px', $styles, 'small font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--large: 26.25px', $styles, 'large font size is not present' );
-		$this->assertStringNotContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'x-large font size is not present' );
-
-		remove_theme_support( 'editor-font-sizes' );
 	}
 
-	public function test_variables_in_classic_theme_with_presets_using_defaults() {
-		add_theme_support(
-			'editor-font-sizes',
-			array(
-				array(
-					'name' => 'Small',
-					'size' => 18,
-					'slug' => 'small',
-				),
-				array(
-					'name' => 'Large',
-					'size' => 26.25,
-					'slug' => 'large',
-				),
-			)
-		);
+	/**
+	 * @ticket 56970
+	 */
+	public function test_switching_themes_should_recalculate_stylesheet() {
+		$expected = '--wp--preset--font-size--custom: 100px;';
 
-		$styles = wp_get_global_stylesheet();
-		$this->assertStringContainsString( '--wp--preset--font-size--small: 18px', $styles, 'small font size is 18px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--medium: 20px', $styles, 'medium font size is 20px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--large: 26.25px', $styles, 'large font size is 26.25px' );
-		$this->assertStringContainsString( '--wp--preset--font-size--x-large: 42px', $styles, 'small font size is 42px' );
+		$stylesheet_for_default_theme = wp_get_global_stylesheet();
+		$this->assertStringNotContainsString( $expected, $stylesheet_for_default_theme, 'Custom font size (100px) should not present for default theme' );
 
-		remove_theme_support( 'editor-font-sizes' );
+		$this->maybe_switch_theme( 'block-theme' );
+		$stylesheet_for_block_theme = wp_get_global_stylesheet();
+		$this->assertStringContainsString( $expected, $stylesheet_for_block_theme, 'Custom font size (100px) should be present for block theme' );
 	}
 
 	/**
-	 * Tests that stored CSS is enqueued.
-	 *
-	 * @ticket 56467
+	 * Adds the 'editor-font-sizes' theme support with custom font sizes.
 	 *
-	 * @covers ::wp_enqueue_stored_styles
+	 * @param bool $add_theme_support Whether to add the theme support.
+	 * @param int  $small             Optional. Small font size in pixels. Default 18.
+	 * @param int  $large             Optional. Large font size in pixels. Default 26.25.
 	 */
-	public function test_should_enqueue_stored_styles() {
-		$core_styles_to_enqueue = array(
-			array(
-				'selector'     => '.saruman',
-				'declarations' => array(
-					'color'        => 'white',
-					'height'       => '100px',
-					'border-style' => 'solid',
-				),
-			),
-		);
+	private function add_custom_font_sizes( $add_theme_support, $small = 18, $large = 26.25 ) {
+		if ( ! $add_theme_support ) {
+			return;
+		}
 
-		// Enqueues a block supports (core styles).
-		wp_style_engine_get_stylesheet_from_css_rules(
-			$core_styles_to_enqueue,
+		$args = array(
 			array(
-				'context' => 'block-supports',
-			)
-		);
-
-		$my_styles_to_enqueue = array(
-			array(
-				'selector'     => '.gandalf',
-				'declarations' => array(
-					'color'        => 'grey',
-					'height'       => '90px',
-					'border-style' => 'dotted',
-				),
+				'name' => 'Small',
+				'size' => $small,
+				'slug' => 'small',
 			),
-		);
-
-		// Enqueues some other styles.
-		wp_style_engine_get_stylesheet_from_css_rules(
-			$my_styles_to_enqueue,
 			array(
-				'context' => 'my-styles',
-			)
+				'name' => 'Large',
+				'size' => $large,
+				'slug' => 'large',
+			),
 		);
+		add_theme_support( 'editor-font-sizes', $args );
+		$this->remove_theme_support_at_teardown = true;
+	}
 
-		wp_enqueue_stored_styles( array( 'prettify' => false ) );
-
-		$this->assertSame(
-			array( '.saruman{color:white;height:100px;border-style:solid;}' ),
-			wp_styles()->registered['core-block-supports']->extra['after'],
-			'Registered styles with handle of "core-block-supports" do not match expected value from Style Engine store.'
-		);
+	/**
+	 * Switches the theme when not the 'default' theme.
+	 *
+	 * @param string $theme Theme name to switch to.
+	 */
+	private function maybe_switch_theme( $theme ) {
+		if ( 'default' === $theme ) {
+			return;
+		}
 
-		$this->assertSame(
-			array( '.gandalf{color:grey;height:90px;border-style:dotted;}' ),
-			wp_styles()->registered['wp-style-engine-my-styles']->extra['after'],
-			'Registered styles with handle of "wp-style-engine-my-styles" do not match expected value from the Style Engine store.'
-		);
+		switch_theme( $theme );
+		$this->switch_to_default_theme_at_teardown = true;
 	}
 }
diff --git a/tests/theme/wpTheme.php b/tests/theme/wpTheme.php
index 0ded32d77b..bd04148721 100644
--- a/tests/theme/wpTheme.php
+++ b/tests/theme/wpTheme.php
@@ -1,5 +1,5 @@
 <?php
-/**
+
 /**
  * Test WP_Theme class.
  *
@@ -112,6 +112,20 @@ class Tests_Theme_wpTheme extends WP_UnitTestCase {
 		$this->assertSame( 'subdir/theme2', $theme->get_template() );
 	}
 
+	/**
+	 * Tests that WP_Theme::__construct() handles a numeric theme directory as a string.
+	 *
+	 * @ticket 54645
+	 *
+	 * @covers WP_Theme::__construct
+	 */
+	public function test_new_WP_Theme_numeric_theme_directory() {
+		$theme = new WP_Theme( 1234, $this->theme_root );
+
+		$this->assertSame( '1234', $theme->get_stylesheet(), 'The stylesheet property should be a string.' );
+		$this->assertSame( '1234', $theme->get_template(), 'The template property should be a string.' );
+	}
+
 	/**
 	 * @ticket 21749
 	 */
@@ -275,6 +289,63 @@ class Tests_Theme_wpTheme extends WP_UnitTestCase {
 		$this->assertSame( $expected, $theme->is_block_theme() );
 	}
 
+	/**
+	 * @ticket 57114
+	 *
+	 * @covers WP_Theme::is_block_theme
+	 *
+	 * @dataProvider data_is_block_theme
+	 */
+	public function test_is_block_theme_property( $theme_dir, $expected ) {
+		$theme = new WP_Theme( $theme_dir, $this->theme_root );
+		$theme->is_block_theme();
+		$reflection          = new ReflectionClass( $theme );
+		$reflection_property = $reflection->getProperty( 'block_theme' );
+		$reflection_property->setAccessible( true );
+
+		$this->assertSame( $expected, $reflection_property->getValue( $theme ) );
+	}
+
+	/**
+	 * @ticket 57114
+	 *
+	 * @covers WP_Theme::is_block_theme
+	 * @covers WP_Theme::cache_get
+	 */
+	public function test_is_block_theme_check_cache() {
+		$filter = new MockAction();
+		add_filter( 'theme_file_path', array( $filter, 'filter' ) );
+
+		$theme1 = new WP_Theme( 'block-theme', $this->theme_root );
+		// First run.
+		$this->assertTrue( $theme1->is_block_theme(), 'is_block_theme should return true on first run' );
+
+		$theme2 = new WP_Theme( 'block-theme', $this->theme_root );
+		// Second run.
+		$this->assertTrue( $theme2->is_block_theme(), 'is_block_theme should return true on second run' );
+		$this->assertCount( 0, $filter->get_events(), 'Should only be 0, as second run should be cached' );
+	}
+
+	/**
+	 * @ticket 57114
+	 *
+	 * @covers WP_Theme::is_block_theme
+	 * @covers WP_Theme::cache_delete
+	 */
+	public function test_is_block_theme_delete_cache() {
+		$filter = new MockAction();
+		add_filter( 'theme_file_path', array( $filter, 'filter' ) );
+
+		$theme = new WP_Theme( 'block-theme', $this->theme_root );
+		// First run.
+		$this->assertTrue( $theme->is_block_theme(), 'is_block_theme should return true on first run' );
+		// Clear cache.
+		$theme->cache_delete();
+		// Second run.
+		$this->assertTrue( $theme->is_block_theme(), 'is_block_theme should return true on second run' );
+		$this->assertCount( 2, $filter->get_events(), 'Should only be 4, as second run should not be cached' );
+	}
+
 	/**
 	 * Test get_files for an existing theme.
 	 *
diff --git a/tests/theme/wpThemeJson.php b/tests/theme/wpThemeJson.php
index 9495104357..ddbceeadd1 100644
--- a/tests/theme/wpThemeJson.php
+++ b/tests/theme/wpThemeJson.php
@@ -14,6 +14,36 @@
  */
 class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 
+	/**
+	 * Administrator ID.
+	 *
+	 * @var int
+	 */
+	private static $administrator_id;
+
+	/**
+	 * User ID.
+	 *
+	 * @var int
+	 */
+	private static $user_id;
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		static::$administrator_id = self::factory()->user->create(
+			array(
+				'role' => 'administrator',
+			)
+		);
+
+		if ( is_multisite() ) {
+			grant_super_admin( self::$administrator_id );
+		}
+
+		static::$user_id = self::factory()->user->create();
+	}
+
 	/**
 	 * @ticket 52991
 	 * @ticket 54336
@@ -241,6 +271,12 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 			'color'      => array(
 				'link' => true,
 			),
+			'dimensions' => array(
+				'minHeight' => true,
+			),
+			'position'   => array(
+				'sticky' => true,
+			),
 			'spacing'    => array(
 				'blockGap' => false,
 				'margin'   => true,
@@ -265,6 +301,12 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 					'color'      => array(
 						'link' => true,
 					),
+					'dimensions' => array(
+						'minHeight' => true,
+					),
+					'position'   => array(
+						'sticky' => true,
+					),
 					'spacing'    => array(
 						'blockGap' => false,
 						'margin'   => true,
@@ -578,7 +620,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		);
 
 		$variables = "body{--wp--preset--color--grey: grey;--wp--preset--gradient--custom-gradient: linear-gradient(135deg,rgba(0,0,0) 0%,rgb(0,0,0) 100%);--wp--preset--duotone--custom-duotone: url('#wp-duotone-custom-duotone');--wp--preset--font-family--small: 14px;--wp--preset--font-family--big: 41px;}.wp-block-group{--wp--custom--base-font: 16;--wp--custom--line-height--small: 1.2;--wp--custom--line-height--medium: 1.4;--wp--custom--line-height--large: 1.8;}";
-		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{color: var(--wp--preset--color--grey);}a:where(:not(.wp-element-button)){background-color: #333;color: #111;}.wp-element-button, .wp-block-button__link{box-shadow: 10px 10px 5px 0px rgba(0,0,0,0.66);}.wp-block-group{background: var(--wp--preset--gradient--custom-gradient);border-radius: 10px;padding: 24px;}.wp-block-group a:where(:not(.wp-element-button)){color: #111;}h1,h2,h3,h4,h5,h6{color: #123456;}h1 a:where(:not(.wp-element-button)),h2 a:where(:not(.wp-element-button)),h3 a:where(:not(.wp-element-button)),h4 a:where(:not(.wp-element-button)),h5 a:where(:not(.wp-element-button)),h6 a:where(:not(.wp-element-button)){background-color: #333;color: #111;font-size: 60px;}.wp-block-post-date{color: #123456;}.wp-block-post-date a:where(:not(.wp-element-button)){background-color: #777;color: #555;}.wp-block-image{margin-bottom: 30px;}.wp-block-image img, .wp-block-image .components-placeholder{filter: var(--wp--preset--duotone--custom-duotone);}.wp-block-image img, .wp-block-image .wp-block-image__crop-area{border-top-left-radius: 10px;border-bottom-right-radius: 1em;}';
+		$styles    = 'body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }body{color: var(--wp--preset--color--grey);}a:where(:not(.wp-element-button)){background-color: #333;color: #111;}.wp-element-button, .wp-block-button__link{box-shadow: 10px 10px 5px 0px rgba(0,0,0,0.66);}.wp-block-group{background: var(--wp--preset--gradient--custom-gradient);border-radius: 10px;padding: 24px;}.wp-block-group a:where(:not(.wp-element-button)){color: #111;}.wp-block-heading{color: #123456;}.wp-block-heading a:where(:not(.wp-element-button)){background-color: #333;color: #111;font-size: 60px;}.wp-block-post-date{color: #123456;}.wp-block-post-date a:where(:not(.wp-element-button)){background-color: #777;color: #555;}.wp-block-image{margin-bottom: 30px;}.wp-block-image img, .wp-block-image .components-placeholder{filter: var(--wp--preset--duotone--custom-duotone);}.wp-block-image img, .wp-block-image .wp-block-image__crop-area{border-top-left-radius: 10px;border-bottom-right-radius: 1em;}';
 		$presets   = '.has-grey-color{color: var(--wp--preset--color--grey) !important;}.has-grey-background-color{background-color: var(--wp--preset--color--grey) !important;}.has-grey-border-color{border-color: var(--wp--preset--color--grey) !important;}.has-custom-gradient-gradient-background{background: var(--wp--preset--gradient--custom-gradient) !important;}.has-small-font-family{font-family: var(--wp--preset--font-family--small) !important;}.has-big-font-family{font-family: var(--wp--preset--font-family--big) !important;}';
 		$all       = $variables . $styles . $presets;
 		$this->assertSame( $all, $theme_json->get_stylesheet() );
@@ -613,7 +655,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		);
 
 		$this->assertSame(
-			'h1.has-white-color,h2.has-white-color,h3.has-white-color,h4.has-white-color,h5.has-white-color,h6.has-white-color{color: var(--wp--preset--color--white) !important;}h1.has-white-background-color,h2.has-white-background-color,h3.has-white-background-color,h4.has-white-background-color,h5.has-white-background-color,h6.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}h1.has-white-border-color,h2.has-white-border-color,h3.has-white-border-color,h4.has-white-border-color,h5.has-white-border-color,h6.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}',
+			'.wp-block-heading.has-white-color{color: var(--wp--preset--color--white) !important;}.wp-block-heading.has-white-background-color{background-color: var(--wp--preset--color--white) !important;}.wp-block-heading.has-white-border-color{border-color: var(--wp--preset--color--white) !important;}',
 			$theme_json->get_stylesheet( array( 'presets' ) )
 		);
 	}
@@ -2384,6 +2426,67 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertEqualSetsWithIndex( $expected, $actual );
 	}
 
+	/**
+	 * @ticket 57321
+	 *
+	 * @covers WP_Theme_JSON::remove_insecure_properties
+	 */
+	public function test_remove_insecure_properties_should_allow_indirect_properties() {
+		$actual = WP_Theme_JSON::remove_insecure_properties(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'   => array(
+					'spacing' => array(
+						'blockGap' => '3em',
+					),
+					'blocks'  => array(
+						'core/social-links' => array(
+							'spacing' => array(
+								'blockGap' => array(
+									'left' => '2em',
+									'top'  => '1em',
+								),
+							),
+						),
+					),
+				),
+				'settings' => array(
+					'layout' => array(
+						'contentSize' => '800px',
+						'wideSize'    => '1000px',
+					),
+				),
+			)
+		);
+
+		$expected = array(
+			'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+			'styles'   => array(
+				'spacing' => array(
+					'blockGap' => '3em',
+				),
+				'blocks'  => array(
+					'core/social-links' => array(
+						'spacing' => array(
+							'blockGap' => array(
+								'left' => '2em',
+								'top'  => '1em',
+							),
+						),
+					),
+				),
+			),
+			'settings' => array(
+				'layout' => array(
+					'contentSize' => '800px',
+					'wideSize'    => '1000px',
+				),
+			),
+		);
+
+		$this->assertSameSetsWithIndex( $expected, $actual );
+	}
+
 	/**
 	 * @ticket 56467
 	 */
@@ -2645,7 +2748,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 */
 	public function test_get_editor_settings_custom_units_can_be_disabled() {
 		add_theme_support( 'custom-units', array() );
-		$actual = WP_Theme_JSON::get_from_editor_settings( get_default_block_editor_settings() );
+		$actual = WP_Theme_JSON::get_from_editor_settings( get_classic_theme_supports_block_editor_settings() );
 		remove_theme_support( 'custom-units' );
 
 		$expected = array(
@@ -2662,7 +2765,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 */
 	public function test_get_editor_settings_custom_units_can_be_enabled() {
 		add_theme_support( 'custom-units' );
-		$actual = WP_Theme_JSON::get_from_editor_settings( get_default_block_editor_settings() );
+		$actual = WP_Theme_JSON::get_from_editor_settings( get_classic_theme_supports_block_editor_settings() );
 		remove_theme_support( 'custom-units' );
 
 		$expected = array(
@@ -2679,7 +2782,7 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 	 */
 	public function test_get_editor_settings_custom_units_can_be_filtered() {
 		add_theme_support( 'custom-units', 'rem', 'em' );
-		$actual = WP_Theme_JSON::get_from_editor_settings( get_default_block_editor_settings() );
+		$actual = WP_Theme_JSON::get_from_editor_settings( get_classic_theme_supports_block_editor_settings() );
 		remove_theme_support( 'custom-units' );
 
 		$expected = array(
@@ -3595,6 +3698,306 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$this->assertSame( $expected, $root_rules . $style_rules );
 	}
 
+	/**
+	 * @ticket 57583
+	 *
+	 * @dataProvider data_sanitize_for_block_with_style_variations
+	 *
+	 * @param array $theme_json_variations Theme.json variations to test.
+	 * @param array $expected_sanitized    Expected results after sanitizing.
+	 */
+	public function test_sanitize_for_block_with_style_variations( $theme_json_variations, $expected_sanitized ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'blocks' => array(
+						'core/quote' => $theme_json_variations,
+					),
+				),
+			)
+		);
+
+		// Validate structure is sanitized.
+		$sanitized_theme_json = $theme_json->get_raw_data();
+		$this->assertIsArray( $sanitized_theme_json, 'Sanitized theme.json is not an array data type' );
+		$this->assertArrayHasKey( 'styles', $sanitized_theme_json, 'Sanitized theme.json does not have an "styles" key' );
+		$this->assertSameSetsWithIndex( $expected_sanitized, $sanitized_theme_json['styles'], 'Sanitized theme.json styles does not match' );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_sanitize_for_block_with_style_variations() {
+		return array(
+			'1 variation with 1 invalid property'   => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color' => array(
+								'background' => 'hotpink',
+							),
+						),
+					),
+				),
+				'expected_sanitized'    => array(
+					'blocks' => array(
+						'core/quote' => array(
+							'variations' => array(
+								'plain' => array(
+									'color' => array(
+										'background' => 'hotpink',
+									),
+								),
+							),
+						),
+					),
+				),
+			),
+			'1 variation with 2 invalid properties' => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color'            => array(
+								'background' => 'hotpink',
+							),
+							'invalidProperty1' => 'value1',
+							'invalidProperty2' => 'value2',
+						),
+					),
+				),
+				'expected_sanitized'    => array(
+					'blocks' => array(
+						'core/quote' => array(
+							'variations' => array(
+								'plain' => array(
+									'color' => array(
+										'background' => 'hotpink',
+									),
+								),
+							),
+						),
+					),
+				),
+			),
+			'2 variations with 1 invalid property'  => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color'            => array(
+								'background' => 'hotpink',
+							),
+							'invalidProperty1' => 'value1',
+						),
+						'basic' => array(
+							'color' => array(
+								'background' => '#ffffff',
+								'text'       => '#000000',
+							),
+							'foo'   => 'bar',
+						),
+					),
+				),
+				'expected_sanitized'    => array(
+					'blocks' => array(
+						'core/quote' => array(
+							'variations' => array(
+								'plain' => array(
+									'color' => array(
+										'background' => 'hotpink',
+									),
+								),
+								'basic' => array(
+									'color' => array(
+										'background' => '#ffffff',
+										'text'       => '#000000',
+									),
+								),
+							),
+						),
+					),
+				),
+			),
+		);
+	}
+
+	/**
+	 * @ticket 57583
+	 *
+	 * @dataProvider data_sanitize_with_invalid_style_variation
+	 *
+	 * @param array $theme_json_variations The theme.json variations to test.
+	 */
+	public function test_sanitize_with_invalid_style_variation( $theme_json_variations ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'blocks' => array(
+						'core/quote' => $theme_json_variations,
+					),
+				),
+			)
+		);
+
+		// Validate structure is sanitized.
+		$sanitized_theme_json = $theme_json->get_raw_data();
+		$this->assertIsArray( $sanitized_theme_json, 'Sanitized theme.json is not an array data type' );
+		$this->assertArrayNotHasKey( 'styles', $sanitized_theme_json, 'Sanitized theme.json should not have a "styles" key' );
+
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_sanitize_with_invalid_style_variation() {
+		return array(
+			'empty string variation' => array(
+				array(
+					'variations' => '',
+				),
+			),
+			'boolean variation'      => array(
+				array(
+					'variations' => false,
+				),
+			),
+		);
+	}
+
+	/**
+	 * @ticket 57583
+	 *
+	 * @dataProvider data_get_styles_for_block_with_style_variations
+	 *
+	 * @param array  $theme_json_variations Theme.json variations to test.
+	 * @param string $metadata_variations   Style variations to test.
+	 * @param string $expected              Expected results for styling.
+	 */
+	public function test_get_styles_for_block_with_style_variations( $theme_json_variations, $metadata_variations, $expected ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => 2,
+				'styles'  => array(
+					'blocks' => array(
+						'core/quote' => $theme_json_variations,
+					),
+				),
+			)
+		);
+
+		// Validate styles are generated properly.
+		$metadata      = array(
+			'path'       => array( 'styles', 'blocks', 'core/quote' ),
+			'selector'   => '.wp-block-quote',
+			'variations' => $metadata_variations,
+		);
+		$actual_styles = $theme_json->get_styles_for_block( $metadata );
+		$this->assertSame( $expected, $actual_styles );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array
+	 */
+	public function data_get_styles_for_block_with_style_variations() {
+		$plain = array(
+			'metadata' => array(
+				'path'     => array( 'styles', 'blocks', 'core/quote', 'variations', 'plain' ),
+				'selector' => '.is-style-plain.is-style-plain.wp-block-quote',
+			),
+			'styles'   => '.is-style-plain.is-style-plain.wp-block-quote{background-color: hotpink;}',
+		);
+		$basic = array(
+			'metadata' => array(
+				'path'     => array( 'styles', 'blocks', 'core/quote', 'variations', 'basic' ),
+				'selector' => '.is-style-basic.is-style-basic.wp-block-quote',
+			),
+			'styles'   => '.is-style-basic.is-style-basic.wp-block-quote{background-color: #ffffff;color: #000000;}',
+		);
+
+		return array(
+			'1 variation with 1 invalid property'   => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color' => array(
+								'background' => 'hotpink',
+							),
+						),
+					),
+				),
+				'metadata_variation'    => array( $plain['metadata'] ),
+				'expected'              => $plain['styles'],
+			),
+			'1 variation with 2 invalid properties' => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color'            => array(
+								'background' => 'hotpink',
+							),
+							'invalidProperty1' => 'value1',
+							'invalidProperty2' => 'value2',
+						),
+					),
+				),
+				'metadata_variation'    => array( $plain['metadata'] ),
+				'expected'              => $plain['styles'],
+			),
+			'2 variations with 1 invalid property'  => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color'            => array(
+								'background' => 'hotpink',
+							),
+							'invalidProperty1' => 'value1',
+						),
+						'basic' => array(
+							'color' => array(
+								'background' => '#ffffff',
+								'text'       => '#000000',
+							),
+							'foo'   => 'bar',
+						),
+					),
+				),
+				'metadata_variation'    => array( $plain['metadata'], $basic['metadata'] ),
+				'expected_styles'       => $plain['styles'] . $basic['styles'],
+			),
+			'2 variations with multiple invalid properties' => array(
+				'theme_json_variations' => array(
+					'variations' => array(
+						'plain' => array(
+							'color'            => array(
+								'background' => 'hotpink',
+							),
+							'invalidProperty1' => 'value1',
+							'invalidProperty2' => 'value2',
+						),
+						'basic' => array(
+							'foo'   => 'foo',
+							'color' => array(
+								'background' => '#ffffff',
+								'text'       => '#000000',
+							),
+							'bar'   => 'bar',
+							'baz'   => 'baz',
+						),
+					),
+				),
+				'metadata_variation'    => array( $plain['metadata'], $basic['metadata'] ),
+				'expected_styles'       => $plain['styles'] . $basic['styles'],
+			),
+		);
+	}
+
 	/**
 	 * @ticket 56611
 	 */
@@ -4128,4 +4531,217 @@ class Tests_Theme_wpThemeJson extends WP_UnitTestCase {
 		$expected = $base_styles . $element_styles;
 		$this->assertSame( $expected, $theme_json->get_stylesheet() );
 	}
+
+	/**
+	 * @ticket 57559
+	 */
+	public function test_shadow_preset_styles() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'shadow' => array(
+						'presets' => array(
+							array(
+								'slug'   => 'natural',
+								'shadow' => '5px 5px 5px 0 black',
+							),
+							array(
+								'slug'   => 'sharp',
+								'shadow' => '5px 5px black',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$expected_styles = 'body{--wp--preset--shadow--natural: 5px 5px 5px 0 black;--wp--preset--shadow--sharp: 5px 5px black;}';
+		$this->assertSame( $expected_styles, $theme_json->get_stylesheet(), 'Styles returned from "::get_stylesheet()" does not match expectations' );
+		$this->assertSame( $expected_styles, $theme_json->get_stylesheet( array( 'variables' ) ), 'Styles returned from "::get_stylesheet()" when requiring "variables" type does not match expectations' );
+	}
+
+	/**
+	 * @ticket 57559
+	 */
+	public function test_get_shadow_styles_for_blocks() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version'  => WP_Theme_JSON::LATEST_SCHEMA,
+				'settings' => array(
+					'shadow' => array(
+						'presets' => array(
+							array(
+								'slug'   => 'natural',
+								'shadow' => '5px 5px 0 0 black',
+							),
+						),
+					),
+				),
+				'styles'   => array(
+					'blocks'   => array(
+						'core/paragraph' => array(
+							'shadow' => 'var(--wp--preset--shadow--natural)',
+						),
+					),
+					'elements' => array(
+						'button' => array(
+							'shadow' => 'var:preset|shadow|natural',
+						),
+						'link'   => array(
+							'shadow' => array( 'ref' => 'styles.elements.button.shadow' ),
+						),
+					),
+				),
+			)
+		);
+
+		$global_styles   = 'body{--wp--preset--shadow--natural: 5px 5px 0 0 black;}body { margin: 0; }.wp-site-blocks > .alignleft { float: left; margin-right: 2em; }.wp-site-blocks > .alignright { float: right; margin-left: 2em; }.wp-site-blocks > .aligncenter { justify-content: center; margin-left: auto; margin-right: auto; }';
+		$element_styles  = 'a:where(:not(.wp-element-button)){box-shadow: var(--wp--preset--shadow--natural);}.wp-element-button, .wp-block-button__link{box-shadow: var(--wp--preset--shadow--natural);}p{box-shadow: var(--wp--preset--shadow--natural);}';
+		$expected_styles = $global_styles . $element_styles;
+
+		$this->assertSame( $expected_styles, $theme_json->get_stylesheet() );
+	}
+
+	/**
+	 * @ticket 57536
+	 */
+	public function test_get_custom_css_handles_global_custom_css() {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'css' => 'body { color:purple; }',
+				),
+			)
+		);
+		$custom_css = 'body { color:purple; }';
+		$this->assertSame( $custom_css, $theme_json->get_custom_css() );
+	}
+
+	/**
+	 * Tests that custom CSS is kept for users with correct capabilities and removed for others.
+	 *
+	 * @ticket 57536
+	 *
+	 * @dataProvider data_custom_css_for_user_caps
+	 *
+	 * @param string $user_property The property name for current user.
+	 * @param array  $expected      Expected results.
+	 */
+	public function test_custom_css_for_user_caps( $user_property, array $expected ) {
+		wp_set_current_user( static::${$user_property} );
+
+		$actual = WP_Theme_JSON::remove_insecure_properties(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(
+					'css'    => 'body { color:purple; }',
+					'blocks' => array(
+						'core/separator' => array(
+							'color' => array(
+								'background' => 'blue',
+							),
+						),
+					),
+				),
+			)
+		);
+
+		$this->assertSameSetsWithIndex( $expected, $actual );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_custom_css_for_user_caps() {
+		return array(
+			'allows custom css for users with caps'     => array(
+				'user_property' => 'administrator_id',
+				'expected'      => array(
+					'version' => WP_Theme_JSON::LATEST_SCHEMA,
+					'styles'  => array(
+						'css'    => 'body { color:purple; }',
+						'blocks' => array(
+							'core/separator' => array(
+								'color' => array(
+									'background' => 'blue',
+								),
+							),
+						),
+					),
+				),
+			),
+			'removes custom css for users without caps' => array(
+				'user_property' => 'user_id',
+				'expected'      => array(
+					'version' => WP_Theme_JSON::LATEST_SCHEMA,
+					'styles'  => array(
+						'blocks' => array(
+							'core/separator' => array(
+								'color' => array(
+									'background' => 'blue',
+								),
+							),
+						),
+					),
+				),
+			),
+		);
+	}
+
+	/**
+	 * @dataProvider data_process_blocks_custom_css
+	 *
+	 * @param array  $input    An array containing the selector and css to test.
+	 * @param string $expected Expected results.
+	 */
+	public function test_process_blocks_custom_css( $input, $expected ) {
+		$theme_json = new WP_Theme_JSON(
+			array(
+				'version' => WP_Theme_JSON::LATEST_SCHEMA,
+				'styles'  => array(),
+			)
+		);
+		$reflection = new ReflectionMethod( $theme_json, 'process_blocks_custom_css' );
+		$reflection->setAccessible( true );
+
+		$this->assertSame( $expected, $reflection->invoke( $theme_json, $input['css'], $input['selector'] ) );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_process_blocks_custom_css() {
+		return array(
+			// Simple CSS without any child selectors.
+			'no child selectors'                => array(
+				'input'    => array(
+					'selector' => '.foo',
+					'css'      => 'color: red; margin: auto;',
+				),
+				'expected' => '.foo{color: red; margin: auto;}',
+			),
+			// CSS with child selectors.
+			'with children'                     => array(
+				'input'    => array(
+					'selector' => '.foo',
+					'css'      => 'color: red; margin: auto; & .bar{color: blue;}',
+				),
+				'expected' => '.foo{color: red; margin: auto;}.foo .bar{color: blue;}',
+			),
+			// CSS with child selectors and pseudo elements.
+			'with children and pseudo elements' => array(
+				'input'    => array(
+					'selector' => '.foo',
+					'css'      => 'color: red; margin: auto; & .bar{color: blue;} &::before{color: green;}',
+				),
+				'expected' => '.foo{color: red; margin: auto;}.foo .bar{color: blue;}.foo::before{color: green;}',
+			),
+		);
+	}
 }
diff --git a/tests/theme/wpThemeJsonResolver.php b/tests/theme/wpThemeJsonResolver.php
index 7db984e941..f013542e2e 100644
--- a/tests/theme/wpThemeJsonResolver.php
+++ b/tests/theme/wpThemeJsonResolver.php
@@ -235,7 +235,7 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		);
 		$this->assertSame(
 			'Wariant motywu blokowego',
-			$style_variations[0]['title']
+			$style_variations[1]['title']
 		);
 	}
 
@@ -433,9 +433,6 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 
 	/**
 	 * @ticket 54336
-	 * @ticket 56467
-	 *
-	 * @covers ::add_theme_support
 	 */
 	public function test_add_theme_supports_are_loaded_for_themes_without_theme_json() {
 		switch_theme( 'default' );
@@ -458,30 +455,15 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		);
 		add_theme_support( 'editor-color-palette', $color_palette );
 		add_theme_support( 'custom-line-height' );
-		add_theme_support( 'appearance-tools' );
 
 		$settings = WP_Theme_JSON_Resolver::get_theme_data()->get_settings();
 
 		remove_theme_support( 'custom-line-height' );
 		remove_theme_support( 'editor-color-palette' );
-		remove_theme_support( 'appearance-tools' );
 
 		$this->assertFalse( wp_theme_has_theme_json() );
 		$this->assertTrue( $settings['typography']['lineHeight'] );
 		$this->assertSame( $color_palette, $settings['color']['palette']['theme'] );
-		$this->assertTrue( $settings['border']['color'], 'Support for appearance-tools was not added.' );
-	}
-
-	/**
-	 * Recursively applies ksort to an array.
-	 */
-	private static function recursive_ksort( &$array ) {
-		foreach ( $array as &$value ) {
-			if ( is_array( $value ) ) {
-				self::recursive_ksort( $value );
-			}
-		}
-		ksort( $array );
 	}
 
 	/**
@@ -582,8 +564,8 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 				),
 			),
 		);
-		self::recursive_ksort( $actual_settings );
-		self::recursive_ksort( $expected_settings );
+		wp_recursive_ksort( $actual_settings );
+		wp_recursive_ksort( $expected_settings );
 
 		// Should merge settings.
 		$this->assertSame(
@@ -747,7 +729,8 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 	public function test_get_theme_data_theme_supports_overrides_theme_json() {
 		// Test that get_theme_data() returns a WP_Theme_JSON object.
 		$theme_json_resolver = new WP_Theme_JSON_Resolver();
-		$theme_data          = $theme_json_resolver->get_theme_data();
+		$theme_json_resolver->get_merged_data();
+		$theme_data = $theme_json_resolver->get_theme_data();
 		$this->assertInstanceOf( 'WP_Theme_JSON', $theme_data, 'Theme data should be an instance of WP_Theme_JSON.' );
 
 		// Test that wp_theme_json_data_theme filter has been called.
@@ -787,4 +770,252 @@ class Tests_Theme_wpThemeJsonResolver extends WP_UnitTestCase {
 		$this->assertSame( $empty_theme_json, $theme_data->get_raw_data(), 'Theme data should be empty without theme support.' );
 		$this->assertNull( $property->getValue(), 'Theme i18n schema should not have been loaded without theme support.' );
 	}
+
+	/**
+	 * Tests that get_merged_data returns the data merged up to the proper origin.
+	 *
+	 * @ticket 57545
+	 *
+	 * @covers WP_Theme_JSON_Resolver::get_merged_data
+	 *
+	 * @dataProvider data_get_merged_data_returns_origin
+	 *
+	 * @param string $origin             What origin to get data from.
+	 * @param bool   $core_palette       Whether the core palette is present.
+	 * @param string $core_palette_text  Message.
+	 * @param string $block_styles       Whether the block styles are present.
+	 * @param string $block_styles_text  Message.
+	 * @param bool   $theme_palette      Whether the theme palette is present.
+	 * @param string $theme_palette_text Message.
+	 * @param bool   $user_palette        Whether the user palette is present.
+	 * @param string $user_palette_text   Message.
+	 */
+	public function test_get_merged_data_returns_origin( $origin, $core_palette, $core_palette_text, $block_styles, $block_styles_text, $theme_palette, $theme_palette_text, $user_palette, $user_palette_text ) {
+		// Make sure there is data from the blocks origin.
+		register_block_type(
+			'my/block-with-styles',
+			array(
+				'api_version' => 2,
+				'attributes'  => array(
+					'borderColor' => array(
+						'type' => 'string',
+					),
+					'style'       => array(
+						'type' => 'object',
+					),
+				),
+				'supports'    => array(
+					'__experimentalStyle' => array(
+						'typography' => array(
+							'fontSize' => '42rem',
+						),
+					),
+				),
+			)
+		);
+
+		// Make sure there is data from the theme origin.
+		switch_theme( 'block-theme' );
+
+		// Make sure there is data from the user origin.
+		wp_set_current_user( self::$administrator_id );
+		$user_cpt = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( wp_get_theme(), true );
+		$config   = json_decode( $user_cpt['post_content'], true );
+		$config['settings']['color']['palette']['custom'] = array(
+			array(
+				'color' => 'hotpink',
+				'name'  => 'My color',
+				'slug'  => 'my-color',
+			),
+		);
+		$user_cpt['post_content']                         = wp_json_encode( $config );
+		wp_update_post( $user_cpt, true, false );
+
+		$theme_json = WP_Theme_JSON_Resolver::get_merged_data( $origin );
+		$settings   = $theme_json->get_settings();
+		$styles     = $theme_json->get_styles_block_nodes();
+		$styles     = array_filter(
+			$styles,
+			static function( $element ) {
+				return isset( $element['name'] ) && 'my/block-with-styles' === $element['name'];
+			}
+		);
+		unregister_block_type( 'my/block-with-styles' );
+
+		$this->assertSame( $core_palette, isset( $settings['color']['palette']['default'] ), $core_palette_text );
+		$this->assertSame( $block_styles, count( $styles ) === 1, $block_styles_text );
+		$this->assertSame( $theme_palette, isset( $settings['color']['palette']['theme'] ), $theme_palette_text );
+		$this->assertSame( $user_palette, isset( $settings['color']['palette']['custom'] ), $user_palette_text );
+
+	}
+
+	/**
+	 * Tests that get_merged_data returns the data merged up to the proper origin
+	 * and that the core values have the proper data.
+	 *
+	 * @ticket 57824
+	 *
+	 * @covers WP_Theme_JSON_Resolver::get_merged_data
+	 *
+	 */
+	public function test_get_merged_data_returns_origin_proper() {
+		// Make sure the theme has a theme.json
+		// though it doesn't have any data for styles.spacing.padding.
+		switch_theme( 'block-theme' );
+
+		// Make sure the user defined some data for styles.spacing.padding.
+		wp_set_current_user( self::$administrator_id );
+		$user_cpt                               = WP_Theme_JSON_Resolver::get_user_data_from_wp_global_styles( wp_get_theme(), true );
+		$config                                 = json_decode( $user_cpt['post_content'], true );
+		$config['styles']['spacing']['padding'] = array(
+			'top'    => '23px',
+			'left'   => '23px',
+			'bottom' => '23px',
+			'right'  => '23px',
+		);
+		$user_cpt['post_content']               = wp_json_encode( $config );
+		wp_update_post( $user_cpt, true, false );
+
+		// Query data from the user origin and then for the theme origin.
+		$theme_json_user  = WP_Theme_JSON_Resolver::get_merged_data( 'custom' );
+		$padding_user     = $theme_json_user->get_raw_data()['styles']['spacing']['padding'];
+		$theme_json_theme = WP_Theme_JSON_Resolver::get_merged_data( 'theme' );
+		$padding_theme    = $theme_json_theme->get_raw_data()['styles']['spacing']['padding'];
+
+		$this->assertSame( '23px', $padding_user['top'] );
+		$this->assertSame( '23px', $padding_user['right'] );
+		$this->assertSame( '23px', $padding_user['bottom'] );
+		$this->assertSame( '23px', $padding_user['left'] );
+		$this->assertSame( '0px', $padding_theme['top'] );
+		$this->assertSame( '0px', $padding_theme['right'] );
+		$this->assertSame( '0px', $padding_theme['bottom'] );
+		$this->assertSame( '0px', $padding_theme['left'] );
+	}
+
+	/**
+	 * Data provider.
+	 *
+	 * @return array[]
+	 */
+	public function data_get_merged_data_returns_origin() {
+		return array(
+			'origin_default' => array(
+				'origin'             => 'default',
+				'core_palette'       => true,
+				'core_palette_text'  => 'Core palette must be present',
+				'block_styles'       => false,
+				'block_styles_text'  => 'Block styles should not be present',
+				'theme_palette'      => false,
+				'theme_palette_text' => 'Theme palette should not be present',
+				'user_palette'       => false,
+				'user_palette_text'  => 'User palette should not be present',
+			),
+			'origin_blocks'  => array(
+				'origin'             => 'blocks',
+				'core_palette'       => true,
+				'core_palette_text'  => 'Core palette must be present',
+				'block_styles'       => true,
+				'block_styles_text'  => 'Block styles must be present',
+				'theme_palette'      => false,
+				'theme_palette_text' => 'Theme palette should not be present',
+				'user_palette'       => false,
+				'user_palette_text'  => 'User palette should not be present',
+			),
+			'origin_theme'   => array(
+				'origin'             => 'theme',
+				'core_palette'       => true,
+				'core_palette_text'  => 'Core palette must be present',
+				'block_styles'       => true,
+				'block_styles_text'  => 'Block styles must be present',
+				'theme_palette'      => true,
+				'theme_palette_text' => 'Theme palette must be present',
+				'user_palette'       => false,
+				'user_palette_text'  => 'User palette should not be present',
+			),
+			'origin_custom'  => array(
+				'origin'             => 'custom',
+				'core_palette'       => true,
+				'core_palette_text'  => 'Core palette must be present',
+				'block_styles'       => true,
+				'block_styles_text'  => 'Block styles must be present',
+				'theme_palette'      => true,
+				'theme_palette_text' => 'Theme palette must be present',
+				'user_palette'       => true,
+				'user_palette_text'  => 'User palette must be present',
+			),
+		);
+	}
+
+	/**
+	 * Tests that get_style_variations returns all variations, including parent theme variations if the theme is a child,
+	 * and that the child variation overwrites the parent variation of the same name.
+	 *
+	 * @ticket 57545
+	 *
+	 * @covers WP_Theme_JSON_Resolver::get_style_variations
+	 **/
+	public function test_get_style_variations_returns_all_variations() {
+		// Switch to a child theme.
+		switch_theme( 'block-theme-child' );
+		wp_set_current_user( self::$administrator_id );
+
+		$actual_settings   = WP_Theme_JSON_Resolver::get_style_variations();
+		$expected_settings = array(
+			array(
+				'version'  => 2,
+				'title'    => 'variation-b',
+				'settings' => array(
+					'blocks' => array(
+						'core/post-title' => array(
+							'color' => array(
+								'palette' => array(
+									'theme' => array(
+										array(
+											'slug'  => 'dark',
+											'name'  => 'Dark',
+											'color' => '#010101',
+										),
+									),
+								),
+							),
+						),
+					),
+				),
+			),
+			array(
+				'version'  => 2,
+				'title'    => 'Block theme variation',
+				'settings' => array(
+					'color' => array(
+						'palette' => array(
+							'theme' => array(
+								array(
+									'slug'  => 'foreground',
+									'name'  => 'Foreground',
+									'color' => '#3F67C6',
+								),
+							),
+						),
+					),
+				),
+				'styles'   => array(
+					'blocks' => array(
+						'core/post-title' => array(
+							'typography' => array(
+								'fontWeight' => '700',
+							),
+						),
+					),
+				),
+			),
+		);
+
+		wp_recursive_ksort( $actual_settings );
+		wp_recursive_ksort( $expected_settings );
+
+		$this->assertSame(
+			$expected_settings,
+			$actual_settings
+		);
+	}
 }
diff --git a/tests/url/getPrivacyPolicyUrl.php b/tests/url/getPrivacyPolicyUrl.php
index ad0c9c1f00..0aab744a2c 100644
--- a/tests/url/getPrivacyPolicyUrl.php
+++ b/tests/url/getPrivacyPolicyUrl.php
@@ -1,20 +1,14 @@
 <?php
 /**
- * Define a class to test `get_privacy_policy_url()`.
+ * Test cases for the `get_privacy_policy_url()` function.
  *
  * @package WordPress
  * @subpackage UnitTests
  * @since 4.9.6
- */
-
-/**
- * Test cases for `get_privacy_policy_url()`.
  *
  * @group url
  * @group privacy
  *
- * @since 4.9.6
- *
  * @covers ::get_privacy_policy_url
  */
 class Tests_Url_GetPrivacyPolicyUrl extends WP_UnitTestCase {
diff --git a/tests/user/capabilities.php b/tests/user/capabilities.php
index 4583e0155b..beecfd3b85 100644
--- a/tests/user/capabilities.php
+++ b/tests/user/capabilities.php
@@ -1314,13 +1314,9 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		}
 	}
 
-	public function authorless_post_statuses() {
-		return array( array( 'draft' ), array( 'private' ), array( 'publish' ) );
-	}
-
 	/**
 	 * @ticket 27020
-	 * @dataProvider authorless_post_statuses
+	 * @dataProvider data_authorless_post
 	 */
 	public function test_authorless_post( $status ) {
 		// Make a post without an author.
@@ -1349,6 +1345,10 @@ class Tests_User_Capabilities extends WP_UnitTestCase {
 		$this->assertSame( 'publish' === $status, $contributor->has_cap( 'read_post', $post ) );
 	}
 
+	public function data_authorless_post() {
+		return array( array( 'draft' ), array( 'private' ), array( 'publish' ) );
+	}
+
 	/**
 	 * @ticket 16714
 	 */
diff --git a/tests/user/passwordHash.php b/tests/user/passwordHash.php
new file mode 100644
index 0000000000..1179ba25b2
--- /dev/null
+++ b/tests/user/passwordHash.php
@@ -0,0 +1,34 @@
+<?php
+
+/**
+ * Tests for the PasswordHash external library.
+ *
+ * @covers PasswordHash
+ */
+class Tests_User_PasswordHash extends WP_UnitTestCase {
+
+	public static function set_up_before_class() {
+		parent::set_up_before_class();
+
+		require_once ABSPATH . WPINC . '/class-phpass.php';
+	}
+
+	/**
+	 * Tests that PasswordHash::gensalt_blowfish() does not throw a deprecation notice on PHP 8.1.
+	 *
+	 * The notice that we should not see:
+	 * `Deprecated: Implicit conversion from float to int loses precision`.
+	 *
+	 * @ticket 56340
+	 *
+	 * @covers PasswordHash::gensalt_blowfish
+	 *
+	 * @requires PHP 8.1
+	 * @doesNotPerformAssertions
+	 */
+	public function test_gensalt_blowfish_should_not_throw_deprecation_notice_on_php81() {
+		$hasher = new PasswordHash( 8, true );
+		$hasher->gensalt_blowfish( 'a password string' );
+	}
+
+}
diff --git a/tests/user/query.php b/tests/user/query.php
index 722a3fbeaf..85170997d3 100644
--- a/tests/user/query.php
+++ b/tests/user/query.php
@@ -186,7 +186,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 	}
 
 	/**
-	 * @dataProvider orderby_should_convert_non_prefixed_keys_data
+	 * @dataProvider data_orderby_should_convert_non_prefixed_keys
 	 */
 	public function test_orderby_should_convert_non_prefixed_keys( $short_key, $full_key ) {
 		$q = new WP_User_Query(
@@ -198,7 +198,7 @@ class Tests_User_Query extends WP_UnitTestCase {
 		$this->assertStringContainsString( "ORDER BY $full_key", $q->query_orderby );
 	}
 
-	public function orderby_should_convert_non_prefixed_keys_data() {
+	public function data_orderby_should_convert_non_prefixed_keys() {
 		return array(
 			array( 'nicename', 'user_nicename' ),
 			array( 'email', 'user_email' ),
diff --git a/tests/user/retrievePassword.php b/tests/user/retrievePassword.php
index 96a14c408f..861a2d9e96 100644
--- a/tests/user/retrievePassword.php
+++ b/tests/user/retrievePassword.php
@@ -4,12 +4,6 @@
  *
  * @package WordPress
  * @since 6.0.0
- */
-
-/**
- * Test retrieve_password(), in wp-includes/user.php.
- *
- * @since 6.0.0
  *
  * @group user
  * @covers ::retrieve_password
diff --git a/tests/user/wpListAuthors.php b/tests/user/wpListAuthors.php
index ebf557157a..90a22e39d9 100644
--- a/tests/user/wpListAuthors.php
+++ b/tests/user/wpListAuthors.php
@@ -146,6 +146,31 @@ class Tests_User_wpListAuthors extends WP_UnitTestCase {
 		);
 	}
 
+	/**
+	 * Ensures the 'optioncount' parameter does not throw an error when there are authors without posts.
+	 *
+	 * @ticket 57011
+	 */
+	public function test_wp_list_authors_optioncount_should_not_error_for_empty_authors() {
+		/*
+		 * The main purpose of this test is to ensure that the error below is not thrown:
+		 *
+		 * Error: Object of class stdClass could not be converted to string
+		 *
+		 * In place of direct testing we ensure `wp_list_authors()` returns a list of authors
+		 * at least one of which is empty.
+		 */
+		$actual = wp_list_authors(
+			array(
+				'optioncount'   => true,
+				'hide_empty'    => false,
+				'exclude_admin' => false,
+				'echo'          => false,
+			)
+		);
+		$this->assertStringContainsString( '(0)', $actual );
+	}
+
 	public function test_wp_list_authors_exclude_admin() {
 		self::factory()->post->create(
 			array(
diff --git a/tests/user/wpSendUserRequest.php b/tests/user/wpSendUserRequest.php
index f36304bad4..11e3130f22 100644
--- a/tests/user/wpSendUserRequest.php
+++ b/tests/user/wpSendUserRequest.php
@@ -4,12 +4,6 @@
  *
  * @package WordPress
  * @since 4.9.9
- */
-
-/**
- * Tests_User_WpSendUserRequest class.
- *
- * @since 4.9.9
  *
  * @group privacy
  * @group user
diff --git a/tests/webfonts/wpThemeJsonWebfontsHandler.php b/tests/webfonts/wpThemeJsonWebfontsHandler.php
index ae7deacc01..7202417dde 100644
--- a/tests/webfonts/wpThemeJsonWebfontsHandler.php
+++ b/tests/webfonts/wpThemeJsonWebfontsHandler.php
@@ -76,13 +76,14 @@ class Tests_Webfonts_wpThemeJsonWebfontsHandler extends WP_UnitTestCase {
 	/**
 	 * @ticket 55567
 	 * @ticket 46370
+	 * @ticket 57430
 	 */
 	public function test_font_face_generated_from_themejson() {
 		$this->setup_theme_and_test( 'webfonts-theme' );
 
 		$expected = <<<EOF
 <style id='wp-webfonts-inline-css' type='text/css'>
-@font-face{font-family:"Source Serif Pro";font-style:normal;font-weight:200 900;font-display:fallback;src:local("Source Serif Pro"), url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Roman.ttf.woff2') format('woff2');font-stretch:normal;}@font-face{font-family:"Source Serif Pro";font-style:italic;font-weight:200 900;font-display:fallback;src:local("Source Serif Pro"), url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Italic.ttf.woff2') format('woff2');font-stretch:normal;}
+@font-face{font-family:"Source Serif Pro";font-style:normal;font-weight:200 900;font-display:fallback;src:url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Roman.ttf.woff2') format('woff2');font-stretch:normal;}@font-face{font-family:"Source Serif Pro";font-style:italic;font-weight:200 900;font-display:fallback;src:url('THEME_ROOT_URL/assets/fonts/SourceSerif4Variable-Italic.ttf.woff2') format('woff2');font-stretch:normal;}
 </style>
 EOF;
 		$expected = str_replace( 'THEME_ROOT_URL', get_stylesheet_directory_uri(), $expected );
@@ -130,6 +131,7 @@ EOF;
 		switch_theme( $theme_name );
 		do_action( 'after_setup_theme' );
 		wp_clean_theme_json_cache();
+		do_action( 'plugins_loaded' );
 		do_action( 'wp_loaded' );
 		do_action( 'wp_enqueue_scripts' );
 	}
diff --git a/tests/widgets/wpBlockThemeRegisterClassicSidebar.php b/tests/widgets/wpBlockThemeRegisterClassicSidebar.php
new file mode 100644
index 0000000000..f8f8c519ae
--- /dev/null
+++ b/tests/widgets/wpBlockThemeRegisterClassicSidebar.php
@@ -0,0 +1,89 @@
+<?php
+/**
+ * Tests for _wp_block_theme_register_classic_sidebars().
+ *
+ * @group widgets
+ * @covers ::_wp_block_theme_register_classic_sidebars
+ */
+class Tests_Widgets_WpBlockThemeRegisterClassicSidebars extends WP_UnitTestCase {
+	/**
+	 * Original global $wp_registered_sidebars.
+	 *
+	 * @var array
+	 */
+	private static $wp_registered_sidebars;
+
+	public static function set_up_before_class() {
+		global $wp_registered_sidebars;
+		parent::set_up_before_class();
+
+		// Store the original global before running tests.
+		static::$wp_registered_sidebars = $wp_registered_sidebars;
+	}
+
+	public function tear_down() {
+		// Restore the global after each test.
+		global $wp_registered_sidebars;
+		$wp_registered_sidebars = static::$wp_registered_sidebars;
+
+		parent::tear_down();
+	}
+
+	public function test_a_sidebar_should_be_registered() {
+		global $wp_registered_sidebars;
+
+		$sidebar_id = array_key_first( $wp_registered_sidebars );
+		$this->assertNotEmpty( $sidebar_id );
+	}
+
+	/**
+	 * @ticket 57531
+	 */
+	public function test_should_reregister_previous_theme_sidebar() {
+		global $wp_registered_sidebars;
+
+		$sidebar_id = array_key_first( $wp_registered_sidebars );
+
+		switch_theme( 'block-theme' );
+		unregister_sidebar( $sidebar_id );
+
+		// Test before.
+		$this->assertArrayNotHasKey(
+			$sidebar_id,
+			$wp_registered_sidebars,
+			'Sidebar should not be in registered sidebars after unregister'
+		);
+
+		_wp_block_theme_register_classic_sidebars();
+
+		// Test after.
+		$this->assertArrayHasKey(
+			$sidebar_id,
+			$wp_registered_sidebars,
+			'Sidebar should be in registered sidebars after invoking _wp_block_theme_register_classic_sidebars()'
+		);
+	}
+
+	/**
+	 * @ticket 57531
+	 */
+	public function test_should_bail_out_when_theme_mod_is_empty() {
+		global $wp_registered_sidebars;
+
+		// Test state before invoking.
+		$this->assertFalse(
+			get_theme_mod( 'wp_classic_sidebars' ),
+			'Theme mod should not be set before invoking _wp_block_theme_register_classic_sidebars()'
+		);
+
+		$before = $wp_registered_sidebars;
+		_wp_block_theme_register_classic_sidebars();
+
+		// Test state after invoking.
+		$this->assertSameSetsWithIndex(
+			$before,
+			$wp_registered_sidebars,
+			'No change should happen after invoking _wp_block_theme_register_classic_sidebars()'
+		);
+	}
+}
diff --git a/tests/widgets/wpWidgetCustomHtml.php b/tests/widgets/wpWidgetCustomHtml.php
index 8b48b2cb9c..c7dc3c3c7d 100644
--- a/tests/widgets/wpWidgetCustomHtml.php
+++ b/tests/widgets/wpWidgetCustomHtml.php
@@ -67,7 +67,6 @@ class Tests_Widgets_wpWidgetCustomHtml extends WP_UnitTestCase {
 		$this->assertSame( 10, has_action( 'admin_print_scripts-widgets.php', array( $widget, 'enqueue_admin_scripts' ) ) );
 		$this->assertSame( 10, has_action( 'admin_footer-widgets.php', array( 'WP_Widget_Custom_HTML', 'render_control_template_scripts' ) ) );
 		$this->assertSame( 10, has_action( 'admin_head-widgets.php', array( 'WP_Widget_Custom_HTML', 'add_help_text' ) ) );
-		$this->assertContains( 'wp.customHtmlWidgets.idBases.push( "custom_html" );', wp_scripts()->registered['custom-html-widgets']->extra['after'] );
 	}
 
 	/**
diff --git a/tests/widgets/wpWidgetMedia.php b/tests/widgets/wpWidgetMedia.php
index b52b5fd413..d138c41583 100644
--- a/tests/widgets/wpWidgetMedia.php
+++ b/tests/widgets/wpWidgetMedia.php
@@ -383,10 +383,10 @@ class Tests_Widgets_wpWidgetMedia extends WP_UnitTestCase {
 	 *
 	 * @param array           $instance Instance data.
 	 * @param array           $args     Widget args.
-	 * @param WP_Widget_Media $object   Widget object.
+	 * @param WP_Widget_Media $widget   Widget object.
 	 * @return array Instance.
 	 */
-	public function filter_widget_mocked_instance( $instance, $args, $object ) {
+	public function filter_widget_mocked_instance( $instance, $args, $widget ) {
 		$this->widget_instance_filter_args = func_get_args();
 		return $instance;
 	}
diff --git a/tests/widgets/wpWidgetRss.php b/tests/widgets/wpWidgetRss.php
index 424969c126..7135e4b702 100644
--- a/tests/widgets/wpWidgetRss.php
+++ b/tests/widgets/wpWidgetRss.php
@@ -101,7 +101,7 @@ class Tests_Widgets_wpWidgetRss extends WP_UnitTestCase {
 
 	public function mocked_rss_response() {
 		$single_value_headers = array(
-			'content-type' => 'application/rss+xml; charset=UTF-8',
+			'Content-Type' => 'application/rss+xml; charset=UTF-8',
 			'link'         => '<https://wordpress.org/news/wp-json/>; rel="https://api.w.org/"',
 		);
 
diff --git a/tests/widgets/wpWidgetText.php b/tests/widgets/wpWidgetText.php
index b35fa02e0e..cccdcbe957 100644
--- a/tests/widgets/wpWidgetText.php
+++ b/tests/widgets/wpWidgetText.php
@@ -67,7 +67,6 @@ class Tests_Widgets_wpWidgetText extends WP_UnitTestCase {
 
 		$this->assertSame( 10, has_action( 'admin_print_scripts-widgets.php', array( $widget, 'enqueue_admin_scripts' ) ) );
 		$this->assertSame( 10, has_action( 'admin_footer-widgets.php', array( 'WP_Widget_Text', 'render_control_template_scripts' ) ) );
-		$this->assertContains( 'wp.textWidgets.idBases.push( "text" );', wp_scripts()->registered['text-widgets']->extra['after'] );
 		$this->assertFalse( has_action( 'wp_enqueue_scripts', array( $widget, 'enqueue_preview_scripts' ) ) );
 	}
 
